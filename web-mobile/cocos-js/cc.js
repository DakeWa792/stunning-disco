System.register([],(function(t,e){"use strict";return{execute:function(){function n(t){var e,n;return e=(t>65535)<<4,e|=n=((t>>>=e)>255)<<3,e|=n=((t>>>=n)>15)<<2,(e|=n=((t>>>=n)>3)<<1)|(t>>>=n)>>1}function i(t){var e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function r(t){return--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}t({BitMask:ie,CCClass:Ze,CacheMode:void 0,DebugMode:void 0,ECollider2DType:void 0,EJoint2DType:void 0,EPhysics2DDrawFlags:void 0,ERaycast2DType:void 0,ERigidBody2DType:void 0,Enum:oe,Eventify:Zl,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,Physics2DManifoldType:void 0,PhysicsGroup:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:CE,WorldNode3DToWorldNodeUI:bE,absMax:Cn,absMaxComponent:An,approx:an,assert:S,assertID:O,bezier:Df,bezierByTime:Kf,ccenum:ce,clamp:sn,clamp01:cn,color:wn,computeRatioByType:Hk,createDefaultPipeline:SB,debug:A,deserialize:Oh,earcut:r0,enumerableProps:bn,equals:on,error:x,errorID:D,find:vD,fragmentText:Rq,getBaselineOffset:function(){return 0},getError:N,getPathFromRoot:function(t,e){for(var n=t,i="";null!==n&&n!==e;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(t){return t[gc]},getWorldTransformUntilRoot:function(t,e,n){for(Hn.identity(n);t!==e;)Hn.fromRTS(bW,t.rotation,t.position,t.scale),Hn.multiply(n,bW,n),t=t.parent;return n},instantiate:Qh,inverseLerp:Sn,isCustomTargetModifier:DW,isDisplayStats:L,isElementModifier:RW,isPropertyModifier:IW,isUnicodeCJK:Eq,isUnicodeSpace:wq,isValid:dl,lerp:ln,log:g,logID:w,markAsWarning:void 0,mat4:qn,murmurhash2_32_gc:vo,nextPow2:gn,pingPong:xn,pseudoRandom:pn,pseudoRandomRange:mn,pseudoRandomRangeInt:vn,quat:Gn,randomRange:fn,randomRangeInt:dn,rect:ii,removeProperty:void 0,repeat:yn,replaceProperty:void 0,safeMeasureText:Pq,sampleAnimationCurve:Uk,setDefaultLogTimes:function(t){t>0&&(W=t)},setDisplayStats:F,size:ei,toDegree:hn,toRadian:un,tween:oat,tweenUtil:aat,v2:Jn,v3:Dn,v4:Zn,warn:y,warnID:I});var o=new Array(256);!function(t){for(var e=0;e<256;++e){var n=e,i=e,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;t[e]=i<<r&255}}(o);var a=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(t){return(t>0)-(t<0)},abs:function(t){var e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:n,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},countTrailingZeros:i,nextPow2:r,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return o[255&t]<<24|o[t>>>8&255]<<16|o[t>>>16&255]<<8|o[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,n){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){var e=t|t-1;return e+1|(~e&-~e)-1>>>i(t)+1}});t("bits",a);var s="undefined"==typeof window?global:window,c=t("cclegacy",{_global:s});c.internal={},s.CC_BUILD=!0,s.CC_TEST=!1,s.CC_EDITOR=false,s.CC_PREVIEW=!1,s.CC_DEV=!1,s.CC_DEBUG=!1,s.CC_JSB=!1,s.CC_BYTEDANCE=!1,s.CC_WECHAT=!1,s.CC_ALIPAY=!1,s.CC_XIAOMI=!1,s.CC_BAIDU=!1,s.CC_COCOSPLAY=!1,s.CC_HUAWEI=!1,s.CC_OPPO=!1,s.CC_VIVO=!1,s.CC_MINIGAME=!1,s.CC_RUNTIME_BASED=!1,s.CC_SUPPORT_JIT=!0;var l=t("VERSION","3.4.2");s.CocosEngine=c.ENGINE_VERSION=l,s.cc=c;var u="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",h=null,_=console.log.bind(console),f=_,d=_,p=function(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+v.apply(void 0,[e].concat(i)))}},m=_;function v(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return c.js.formatStr.apply(null,[t].concat(n))}function g(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return _.apply(void 0,[t].concat(n))}function y(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return f.apply(void 0,[t].concat(n))}function x(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return d.apply(void 0,[t].concat(n))}function S(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return p.apply(void 0,[t,e].concat(i))}function A(){return m.apply(void 0,arguments)}function C(t){if(_=f=d=p=m=function(){},t!==M.NONE){if(t>M.ERROR){var e=function(t){if(c.game.canvas){if(!h){var e=document.createElement("Div");e.setAttribute("id","logInfoDiv"),e.setAttribute("width","200"),e.setAttribute("height",c.game.canvas.height);var n=e.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(h=document.createElement("textarea")).setAttribute("rows","20"),h.setAttribute("cols","30"),h.setAttribute("disabled","true");var i=h.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",e.appendChild(h),c.game.canvas.parentNode.appendChild(e)}h.value=h.value+t+"\r\n",h.scrollTop=h.scrollHeight}};d=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e("ERROR :  "+v.apply(void 0,[t].concat(i)))},p=function(t,n){if(!t){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];e("ASSERT: "+v.apply(void 0,[n].concat(r)))}},t!==M.ERROR_FOR_WEB_PAGE&&(f=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e("WARN :  "+v.apply(void 0,[t].concat(i)))}),t===M.INFO_FOR_WEB_PAGE&&(_=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e(v.apply(void 0,[t].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),d=console.error.bind?console.error.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.error.apply(console,[t].concat(n))},p=function(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=v.apply(void 0,[e].concat(i));throw new Error(o)}});if(t!==M.ERROR&&(f=console.warn.bind?console.warn.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.warn.apply(console,[t].concat(n))}),t<=M.INFO&&(_=console.log.bind?console.log.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.log.apply(console,[t].concat(n))}),t<=M.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);m=function(){return n.apply(void 0,arguments)}}}}function b(t){x(t.stack||t)}function T(t){return function(e){for(var n=t+" "+e+", please go to "+u+"#"+e+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var E=T("Log");function w(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];g(E.apply(void 0,[t].concat(n)))}var P=T("Warning");function I(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];y(P.apply(void 0,[t].concat(n)))}var R=T("Error");function D(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];x(R.apply(void 0,[t].concat(n)))}var M,B=T("Assert");function O(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];S(!1,B.apply(void 0,[e].concat(i)))}}function N(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return R.apply(void 0,[t].concat(n))}function L(){return!!c.profiler&&c.profiler.isShowingStats()}function F(t){c.profiler&&(t?c.profiler.showStats():c.profiler.hideStats(),c.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(M||(M=t("DebugMode",{})));var z,V,k,G,U,H,j=Object.freeze({__proto__:null,log:g,warn:y,error:x,assert:S,debug:A,_resetDebugSetting:C,_throw:b,logID:w,warnID:I,errorID:D,assertID:O,get DebugMode(){return M},getError:N,isDisplayStats:L,setDisplayStats:F}),W=10,q=0,X=new Map;function Y(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function K(t,e,n){return e&&Y(t.prototype,e),n&&Y(t,n),t}function J(){return(J=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t}).apply(this,arguments)}function Q(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,$(t,e)}function Z(t){return(Z=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function $(t,e){return($=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function tt(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function et(t,e,n){return(et=tt()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&$(r,n.prototype),r}).apply(null,arguments)}function nt(t){var e="function"==typeof Map?new Map:void 0;return(nt=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return et(t,arguments,Z(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),$(i,t)})(t)}function it(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function rt(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function ot(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return rt(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?rt(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0;return function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=t[Symbol.iterator]()).next.bind(n)}function at(t,e,n,i){n&&Object.defineProperty(t,e,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function st(t,e,n,i,r){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(t,e,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}G=function(t,e,n,i,r,o,a){var s=X.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,t+"."+e,n+"."+i),s.count++)},z=t("replaceProperty",(function(t,e,n){null!=t&&n.forEach((function(n){var i=q++;X.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:W});var r=null!=n.target?n.target:t,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:e,s=r===t,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)t[n.name]=function(){var t;return G(e,n.name,a,o,y,i,c),(t=n.customFunction).call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(t,n.name,{get:function(){return G(e,n.name,a,o,y,i,c),n.customGetter.call(this)},set:function(t){G(e,n.name,a,o,y,i,c),n.customSetter.call(this,t)},enumerable:!1}):l?Object.defineProperty(t,n.name,{set:function(t){G(e,n.name,a,o,y,i,c),n.customSetter.call(this,t)},enumerable:!1}):u&&Object.defineProperty(t,n.name,{get:function(){return G(e,n.name,a,o,y,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,n.name,{get:function(){return G(e,n.name,a,o,y,i,c),s?this[o]:r[o]},set:function(t){G(e,n.name,a,o,y,i,c),s?this[o]=t:r[o]=t},enumerable:!1})}))})),H=function(t,e,n,i,r){var o=X.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,t+"."+e),o.count++)},V=t("removeProperty",(function(t,e,n){null!=t&&n.forEach((function(n){var i=q++;X.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:W});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(t,n.name,{get:function(){return H(e,n.name,x,i,r)},set:function(){H(e,n.name,x,i,r)},enumerable:!1})}))})),U=function(t,e,n,i,r){var o=X.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,t+"."+e),o.count++)},k=t("markAsWarning",(function(t,e,n){null!=t&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(t,i);if(r&&r.configurable){var o=q++;X.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:W});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;t[i]=function(){return U(e,i,y,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(t,i,{configurable:!0,get:function(){return U(e,i,y,o,a),c}}),r.writable&&Object.defineProperty(t,i,{set:function(t){U(e,i,y,o,a),c=t}})}else!function(e,n,i,r,o,a){if(e.get){var s=e.get;e.get=function(){return U(n,i,r,o,a),s.call(this)}}if(e.set){var c=e.set;e.set=function(t){U(n,i,r,o,a),c.call(this,t)}}Object.defineProperty(t,i,e)}(r,e,i,y,o,a);Object.defineProperty(t,i,{enumerable:!1})}}))}));var ct=function(){function t(t){this.i=0,this.array=t}var e=t.prototype;return e.remove=function(t){var e=this.array.indexOf(t);e>=0&&this.removeAt(e)},e.removeAt=function(t){this.array.splice(t,1),t<=this.i&&--this.i},e.fastRemove=function(t){var e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)},e.fastRemoveAt=function(t){var e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i},e.push=function(t){this.array.push(t)},K(t,[{key:"length",get:function(){return this.array.length},set:function(t){this.array.length=t,this.i>=t&&(this.i=t-1)}}]),t}();function lt(t,e){t.splice(e,1)}function ut(t,e){var n=t.length;e<0||e>=n||(t[e]=t[n-1],t.length=n-1)}function ht(t,e){var n=t.indexOf(e);return n>=0&&(lt(t,n),!0)}function _t(t,e){var n=t.findIndex(e);if(n>=0){var i=t[n];return lt(t,n),i}}function ft(t,e){return t.indexOf(e)>=0}var dt=Object.freeze({__proto__:null,removeAt:lt,fastRemoveAt:ut,remove:ht,fastRemove:function(t,e){var n=t.indexOf(e);n>=0&&(t[n]=t[t.length-1],--t.length)},removeIf:_t,verifyType:function(t,e){if(t&&t.length>0)for(var n,i=ot(t);!(n=i()).done;)if(!(n.value instanceof e))return w(1300),!1;return!0},removeArray:function(t,e){for(var n=0,i=e.length;n<i;n++)ht(t,e[n])},appendObjectsAt:function(t,e,n){return t.splice.apply(t,[n,0].concat(e)),t},contains:ft,copy:function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i+=1)n[i]=t[i];return n},MutableForwardIterator:ct}),pt=function(){function t(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return t.prototype.getNewId=function(){return this.prefix+ ++this.id},t}();pt.global=new pt("global");var mt=new pt("TmpCId."),vt="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),gt="__cid__";function yt(t){return"number"==typeof t||t instanceof Number}function xt(t){return"string"==typeof t||t instanceof String}function St(t){for(var e in t)return!1;return!0}var At,Ct=(At={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(t,e,n,i,r){At.value=n,At.writable=i,At.enumerable=r,Object.defineProperty(t,e,At),At.value=void 0}),bt=function(){var t={get:void 0,set:void 0,enumerable:!1};return function(e,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),t.get=i,t.set=r,t.enumerable=o,t.configurable=a,Object.defineProperty(e,n,t),t.get=void 0,t.set=void 0}}(),Tt=function(){var t={get:void 0,enumerable:!1,configurable:!1};return function(e,n,i,r,o){t.get=i,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.get=void 0}}(),Et=function(){var t={set:void 0,enumerable:!1,configurable:!1};return function(e,n,i,r,o){t.set=i,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.set=void 0}}();function wt(t){var e=Object.create(null);return t&&(e["."]=1,e["/"]=1,delete e["."],delete e["/"]),e}function Pt(t){if("function"==typeof t){var e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;var n="";if(t.name&&(n=t.name),t.toString){var i,r=t.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return t&&t.constructor?Pt(t.constructor):""}function It(t,e,n,i){var r=/([^.]+)$/,o=r.exec(e)[0],a=r.exec(n)[0];function s(){return this[a]}i?bt(t,o,s,(function(t){this[a]=t})):Tt(t,o,s)}function Rt(t,e,n,i){for(var r in n)It(t,e+"."+r,n[r],i)}var Dt=/(%d)|(%s)/,Mt=/%s/;function Bt(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+t;var r="string"==typeof t&&Dt.test(t);if(r)for(var o,a=ot(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?Dt:Mt;if(c.test(t)){var l=""+s;t=t.replace(c,l)}else t+=" "+s}else for(var u,h=ot(n);!(u=h()).done;){var _=u.value;t+=" "+_}return t}function Ot(){for(var t=arguments.length-1,e=new Array(t),n=0;n<t;++n)e[n]=arguments[n+1];return e}function Nt(t,e){for(;t;){var n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=Object.getPrototypeOf(t)}return null}function Lt(t,e,n){var i=Nt(e,t);i&&Object.defineProperty(n,t,i)}function Ft(t){t=t||{};for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){D(5402,a);continue}for(var s in a)s in t||Lt(s,a,t)}}return t}function zt(t){t=t||{};for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){D(5403,a);continue}for(var s in a)Lt(s,a,t)}}return t}function Vt(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function kt(t){var e=t.prototype,n=e&&Object.getPrototypeOf(e);return n&&n.constructor}function Gt(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=kt(t)))return!1;if(t===e)return!0}}return!1}function Ut(t){for(var e=0,n=Object.keys(t);e<n.length;e++)delete t[n[e]]}var Ht=wt(!0),jt=wt(!0);function Wt(t,e){return function(n,i){if(i.prototype.hasOwnProperty(t)&&delete e[i.prototype[t]],Ct(i.prototype,t,n),n){var r=e[n];r&&r!==i?x("A Class already exists with the same "+t+' : "'+n+'".'):e[n]=i}}}var qt=Wt("__cid__",Ht),Xt=Wt("__classname__",jt);function Yt(t,e){if(Xt(t,e),!e.prototype.hasOwnProperty(gt)){var n=t||mt.getNewId();n&&qt(n,e)}}function Kt(t,e){var n=jt[e],i=Ht[e],r=!0;if(n&&n!==t&&(x('"'+e+'" has already been set as name or alias of another class.'),r=!1),i&&i!==t&&(x('"'+e+'" has already been set as id or alias of another class.'),r=!1),r){var o=t[vt];o||(o=[],t[vt]=o),o.push(e),jt[e]=t,Ht[e]=t}}function Jt(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var i=0,r=e;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete Ht[s];var c=a.__classname__;c&&delete jt[c];var l=a[vt];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete jt[h],delete Ht[h]}}}function Qt(t){return Ht[t]}function Zt(t){return jt[t]}function $t(t,e){if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(gt))return t.prototype.__cid__;if(t&&t.constructor){var n=t.constructor.prototype;if(n&&n.hasOwnProperty(gt))return t.__cid__}return""}var te=function(){var t=e.prototype;function e(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===e?t:e,i=void 0===e?null:t;this.count=0,this._pool=new Array(n),this._cleanup=i}return t.get=function(){return this._get()},t._get=function(){if(this.count>0){--this.count;var t=this._pool[this.count];return this._pool[this.count]=null,t}return null},t.put=function(t){var e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}},t.resize=function(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))},e}(),ee=dt,ne={IDGenerator:pt,Pool:te,array:dt,isNumber:yt,isString:xt,isEmptyObject:St,getPropertyDescriptor:Nt,addon:Ft,mixin:zt,extend:Vt,getSuper:kt,isChildClassOf:Gt,clear:Ut,value:Ct,getset:bt,get:Tt,set:Et,unregisterClass:Jt,getClassName:Pt,setClassName:Yt,setClassAlias:Kt,getClassByName:Zt,get _registeredClassNames(){return J({},jt)},set _registeredClassNames(t){Ut(jt),Object.assign(jt,t)},get _registeredClassIds(){return J({},Ht)},set _registeredClassIds(t){Ut(Ht),Object.assign(Ht,t)},_getClassId:$t,_setClassId:qt,_getClassById:Qt,obsolete:It,obsoletes:Rt,formatStr:Bt,shiftArguments:Ot,createMap:wt};function ie(t){if("__bitmask__"in t)return t;Ct(t,"__bitmask__",null,!0);for(var e=-1,n=Object.keys(t),i=0;i<n.length;i++){var r=n[i],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&Ct(t,a,r)}return t}function re(t,e){e>=0&&t.length,t.length}function oe(t){return"__enums__"in t?t:(Ct(t,"__enums__",null,!0),oe.update(t))}function ae(t){t.hasOwnProperty("__enums__")}function se(t){ae(t);var e=t.__enums__||[];for(var n in e.length=0,t){var i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((function(t,e){return t.value-e.value})),t.__enums__=e,e}function ce(t){"__enums__"in t||Ct(t,"__enums__",null,!0)}c.js=ne,t("js",Object.freeze({__proto__:null,array:ee,js:ne,IDGenerator:pt,Pool:te,isNumber:yt,isString:xt,isEmptyObject:St,value:Ct,getset:bt,get:Tt,set:Et,createMap:wt,getClassName:Pt,obsolete:It,obsoletes:Rt,formatStr:Bt,shiftArguments:Ot,getPropertyDescriptor:Nt,addon:Ft,mixin:zt,extend:Vt,getSuper:kt,isChildClassOf:Gt,clear:Ut,_idToClass:Ht,_nameToClass:jt,_setClassId:qt,setClassName:Yt,setClassAlias:Kt,unregisterClass:Jt,_getClassById:Qt,getClassByName:Zt,_getClassId:$t})),ie.isBitMask=function(t){return t&&t.hasOwnProperty("__bitmask__")},ie.getList=function(t){if(t.__bitmask__)return t.__bitmask__;var e=t.__bitmask__=[];for(var n in t){var i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((function(t,e){return t.value-e.value})),e},c.BitMask=ie,oe.update=function(t){for(var e=-1,n=Object.keys(t),i=0;i<n.length;i++){var r=n[i],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&Ct(t,a,r)}return Array.isArray(t.__enums__)&&se(t),t},oe||(oe=t("Enum",{})),oe.isEnum=function(t){return t&&t.hasOwnProperty("__enums__")},oe.getList=function(t){return ae(t),t.__enums__?t.__enums__:se(t)},c.Enum=oe;var le=t("ValueType",function(){function t(){}var e=t.prototype;return e.clone=function(){return D(100,Pt(this)+".clone"),this},e.equals=function(){return!1},e.set=function(){D(100,Pt(this)+".set")},e.toString=function(){return""+{}},t}());Yt("cc.ValueType",le),c.ValueType=le;var ue=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});c.macro=ue;for(var he=/^(?:cc|dragonBones|sp|ccsg)\..+/,_e=new Array(123),fe=0;fe<123;++fe)_e[fe]=64;for(var de=0;de<64;++de)_e["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(de)]=de;var pe=_e;function me(t,e,n){function i(t,e,n,i){var r=Object.getOwnPropertyDescriptor(t,e);if(r)r.get&&(t[n]=r.get),r.set&&i&&(t[i]=r.set);else{var o=t[n];bt(t,e,o,t[i])}}for(var r,o=t.prototype,a=0;a<e.length;a++){var s=(r=e[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function ve(t,e,n,i){var r=t[e];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):t[e]=i?[n,r]:[r,n]:t[e]=n}function ge(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));var n=e.parentNode;if(n)do{if(n===t)return!0;n=n.parentNode}while(null!==n);return!1}function ye(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function xe(t,e,n){t&&setTimeout((function(){t(e,n)}),0)}function Se(t){return!(!t||t.constructor!==Object)&&St(t)}function Ae(t,e,n){if(e>n){var i=e;e=n,n=i}return t<e?e:t<n?t:n}function Ce(t){return t*ue.RAD}function be(t){return t*ue.DEG}c.misc={BUILTIN_CLASSID_RE:he,BASE64_VALUES:pe,propertyDefine:me,pushToMap:ve,contains:ge,isDomNode:ye,callInNextTick:xe,isPlainEmptyObj_DEV:Se,clampf:Ae,degreesToRadians:Ce,radiansToDegrees:be},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:he,BASE64_VALUES:pe,propertyDefine:me,pushToMap:ve,contains:ge,isDomNode:ye,callInNextTick:xe,tryCatchFunctor_EDITOR:function(t){return Function("target","try {\n  target."+t+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:Se,clampf:Ae,degreesToRadians:Ce,radiansToDegrees:be}));var Te="$_$";function Ee(t,e){var n=e?Object.create(e):{};return Ct(t,"__attrs__",n),n}function we(t){if("function"!=typeof t)return Ee(t,Ie(t.constructor));for(var e,n=c.Class.getInheritanceChain(t),i=n.length-1;i>=0;i--){var r=n[i];r.hasOwnProperty("__attrs__")&&r.__attrs__||Ee(r,(e=n[i+1])&&e.__attrs__)}return Ee(t,(e=n[0])&&e.__attrs__),t.__attrs__}function Pe(t,e){var n=Ie(t),i=e+Te,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function Ie(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||we(t)}function Re(t,e,n,i){Ie(t)[e+Te+n]=i}var De=function(){function t(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}return t.prototype.toString=function(){return this.name},t}(),Me=t("CCInteger",new De("Integer",0));c.Integer=Me,c.CCInteger=Me;var Be=t("CCFloat",new De("Float",0));c.Float=Be,c.CCFloat=Be;var Oe=t("CCBoolean",new De("Boolean",!1));c.Boolean=Oe,c.CCBoolean=Oe;var Ne=t("CCString",new De("String",""));function Le(t,e){return function(n,i){var r='"'+Pt(n)+"."+i+'"',o=Pe(n,i),a=o.type;if(a===Me||a===Be?a="Number":a!==Ne&&a!==Oe||(a=""+a),a===t){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!Se(s)){var c=typeof s,l=t.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;I(3605,r,Pt(o.ctor))}else"Number"!==t&&I(3606,e,r,t);else{if("function"===c)return;t===Ne.default&&null==s?I(3607,r):I(3611,e,r,c)}delete o.type}}}else I(3604,r)}}c.String=Ne,c.CCString=Ne;var Fe=Object.freeze({__proto__:null,DELIMETER:Te,createAttrsSingle:Ee,createAttrs:we,attr:Pe,getClassAttrs:Ie,setClassAttr:Re,PrimitiveType:De,CCInteger:Me,CCFloat:Be,CCBoolean:Oe,CCString:Ne,getTypeChecker_ET:Le,getObjTypeChecker_ET:function(t){return function(e,n){Le("Object","type")(e,n);var i=Ie(e)[n+Te+"default"],r=c.Class.getDefault(i);if(!Array.isArray(r)&&Gt(t,c.ValueType)){var o=Pt(t),a=Bt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Pt(e),n,o);i?g(a):I(3612,a,o,Pt(e),n,o)}}}}),ze={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Ve(t,e,n,i){if(!t.get&&!t.set&&t.hasOwnProperty("default")){var r="_N$"+e;t.get=function(){return this[r]},t.set=function(t){var e=this[r];this[r]=t,n.call(this,e)};var o={};for(var a in i[r]=o,ze){var s=ze[a];t.hasOwnProperty(a)&&(o[a]=t[a],s.canUsedInGet||delete t[a])}}}function ke(t,e,n,i){if(Array.isArray(e)){if(!(e.length>0))return D(5508,n,i);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=c.String:e===Boolean?t.type=c.Boolean:e===Number&&(t.type=c.Float))}function Ge(t,e,n){var i=t?{_short:!0}:{_short:!0,default:e};return n&&(i.type=n),i}function Ue(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return Ge(e,[],t);if("function"==typeof t){var n=t;return Ge(e,Gt(n,c.ValueType)?new n:null,n)}return Ge(e,t instanceof De?t.default:t)}return null}var He=[];function je(){return He[He.length-1]}c._RF={push:function(t,e,n,i){void 0===n&&(n=e,e=""),He.push({uuid:e,script:n,module:t,exports:t.exports,beh:null,importMeta:i})},pop:function(){var t=He.pop(),e=t.module,n=e.exports;if(n===t.exports){for(var i in n)return;e.exports=n=t.cls}},peek:je};var We=Te,qe={datas:null,push:function(t){if(this.datas)this.datas.push(t);else{this.datas=[t];var e=this;setTimeout((function(){e.init()}),0)}},init:function(){var t=this.datas;if(t){for(var e=0;e<t.length;++e){var n=t[e],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=Pt(i);r?Qe(i,o,r,i.$super,n.mixins):D(3633,o)}this.datas=null}}};function Xe(t,e,n,i){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,n),tn(t,i,e,n)}function Ye(t,e,n,i){var r=i.get;i.set,r&&(tn(t,i,e,n),Re(t,n,"serializable",!1))}function Ke(t){return"function"==typeof t?t():t}function Je(t,e,n){for(var i in e)t.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(t,i,Nt(e,i))}function Qe(t,e,n,i,r){if(t.__props__=[],i&&i.__props__&&(t.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(t.__props__=t.__props__.concat(a.__props__.filter((function(e){return t.__props__.indexOf(e)<0}))))}if(n)for(var s in function(t,e){for(var n in t){var i=t[n],r=Ue(i,!1);if(r&&(i=t[n]=r),i){var o=i.notify;o&&Ve(i,n,o,t),"type"in i&&ke(i,i.type,e,n)}}}(n,e),n){var c=n[s];c.get||c.set?Ye(t,e,s,c):Xe(t,e,s,c)}var l=Ie(t);t.__values__=t.__props__.filter((function(t){return!1!==l[t+We+"serializable"]}))}function Ze(t){var e=t.name,n=t.extends,i=t.mixins,r=function(t,e,n,i){var r=c.Component,o=je();if(o&&Gt(e,r)){if(Gt(o.cls,r))return D(3615),null;t=t||o.script}var a=function(t,e,n,i){var r=i.ctor,o=[r],a=r;Ct(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(e&&(a.$super=e),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Je(s,l.prototype),Ze._isCCClass(l)&&Je(Ie(a),Ie(l))}s.constructor=a}return Yt(t,a),a}(t,e,n,i);if(o)if(Gt(e,r)){var s=o.uuid;s&&qt(s,a),o.cls=a}else Gt(o.cls,r)||(o.cls=a);return a}(e,n,i,t);e||(e=c.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);var o=t.properties;"function"==typeof o||n&&null===n.__props__||i&&i.some((function(t){return null===t.__props__}))?(qe.push({cls:r,props:o,mixins:i}),r.__props__=r.__values__=null):Qe(r,e,o,n,t.mixins);var a=t.editor;return a&&Gt(n,c.Component)&&c.Component._registerEditorProps(r,a),r}Ze._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},Ze.fastDefine=function(t,e,n){Yt(t,e);for(var i=e.__props__=e.__values__=Object.keys(n),r=Ie(e),o=0;o<i.length;o++){var a=i[o];r[a+We+"visible"]=!1,r[a+We+"default"]=n[a]}},Ze.Attr=Fe,Ze.attr=Pe,Ze.getInheritanceChain=function(t){for(var e=[];t=kt(t);)t!==Object&&e.push(t);return e};var $e={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function tn(t,e,n,i){var r=null,o="";function a(){return o=i+We,r=Ie(t)}"type"in e&&void 0===e.type&&I(3660,i,n);var s=e.type;s&&($e[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?oe.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=oe.getList(s)):ie.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=ie.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in e&&((r||a())[o+"default"]=e.default);var c,l=function(t,n){if(t in e){var i=e[t];typeof i===n&&((r||a())[o+t]=i)}};e.editorOnly&&((r||a())[o+"editorOnly"]=!0),e.__noImplicit?(r||a())[o+"serializable"]=null!==(c=e.serializable)&&void 0!==c&&c:!1===e.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=e.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Ze.isArray=function(t){return t=Ke(t),Array.isArray(t)},Ze.getDefault=Ke,Ze.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Ze.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Ze.getNewValueTypeCode=function(t){for(var e=Pt(t),n=t.constructor,i="new "+e+"(",r=0;r<n.__props__.length;r++)i+=t[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},c.Class=Ze;var en=Math.PI/180,nn=180/Math.PI,rn=t("EPSILON",1e-6);function on(t,e){return Math.abs(t-e)<=rn*Math.max(1,Math.abs(t),Math.abs(e))}function an(t,e,n){return n=n||rn,Math.abs(t-e)<=n}function sn(t,e,n){if(e>n){var i=e;e=n,n=i}return t<e?e:t>n?n:t}function cn(t){return t<0?0:t>1?1:t}function ln(t,e,n){return t+(e-t)*n}function un(t){return t*en}function hn(t){return t*nn}var _n=t("random",Math.random);function fn(t,e){return Math.random()*(e-t)+t}function dn(t,e){return Math.floor(fn(t,e))}function pn(t){return(t=(9301*t+49297)%233280)/233280}function mn(t,e,n){return pn(t)*(n-e)+e}function vn(t,e,n){return Math.floor(mn(t,e,n))}function gn(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function yn(t,e){return t-Math.floor(t/e)*e}function xn(t,e){return t=yn(t,2*e),e-Math.abs(t-e)}function Sn(t,e,n){return(n-t)/(e-t)}function An(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function Cn(t,e){return Math.abs(t)>Math.abs(e)?t:e}function bn(t,e){e.forEach((function(e){Object.defineProperty(t,e,{enumerable:!0})}))}var Tn=1/255,En=t("Color",function(t){function e(e,n,i,r){var o;return(o=t.call(this)||this)._val=0,"string"==typeof e?o.fromHEX(e):void 0!==n?o.set(e,n,i,r):o.set(e),o}Q(e,t),e.clone=function(t){var n=new e;return t._val?n._val=t._val:n._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,n},e.copy=function(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t},e.set=function(t,e,n,i,r){return t.r=e,t.g=n,t.b=i,t.a=r,t},e.fromHEX=function(t,e){e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0;var n=parseInt(e.substr(6,2),16);return t.a=Number.isNaN(n)?255:n,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t},e.add=function(t,e,n){return t.r=e.r+n.r,t.g=e.g+n.g,t.b=e.b+n.b,t.a=e.a+n.a,t},e.subtract=function(t,e,n){return t.r=e.r-n.r,t.g=e.g-n.g,t.b=e.b-n.b,t.a=e.a-n.a,t},e.multiply=function(t,e,n){return t.r=e.r*n.r,t.g=e.g*n.g,t.b=e.b*n.b,t.a=e.a*n.a,t},e.divide=function(t,e,n){return t.r=e.r/n.r,t.g=e.g/n.g,t.b=e.b/n.b,t.a=e.a/n.a,t},e.scale=function(t,e,n){return t.r=e.r*n,t.g=e.g*n,t.b=e.b*n,t.a=e.a*n,t},e.lerp=function(t,e,n,i){var r=e.r,o=e.g,a=e.b,s=e.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,t._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),t},e.toArray=function(t,n,i){void 0===i&&(i=0);var r=n instanceof e||n.a>1?1/255:1;return t[i+0]=n.r*r,t[i+1]=n.g*r,t[i+2]=n.b*r,t[i+3]=n.a*r,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),e.r=255*t[n+0],e.g=255*t[n+1],e.b=255*t[n+2],e.a=255*t[n+3],e},e.strictEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.r-e.r)<=n*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=n*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=n*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=n*Math.max(1,Math.abs(t.a),Math.abs(e.a))},e.hex=function(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0};var n=e.prototype;return n.clone=function(){var t=new e;return t._val=this._val,t},n.equals=function(t){return t&&this._val===t._val},n.lerp=function(t,e){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(t.r-n)*e,i+=(t.g-i)*e,r+=(t.b-r)*e,o+=(t.a-o)*e,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(t){return void 0===t&&(t="rgba"),"rgba"===t?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*Tn).toFixed(2)+")":"rgb"===t?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(t)},n.fromHEX=function(t){t=0===t.indexOf("#")?t.substring(1):t;var e=parseInt(t.substr(0,2),16)||0,n=parseInt(t.substr(2,2),16)||0,i=parseInt(t.substr(4,2),16)||0,r=parseInt(t.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|e),this},n.toHEX=function(t){void 0===t&&(t="#rrggbb");var e="0",n=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===t&&n.push((this.a<16?e:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(t,e,n){var i=0,r=0,o=0;if(0===e)i=r=o=n;else if(0===n)i=r=o=0;else{1===t&&(t=0),t*=6;var a=Math.floor(t),s=t-a,c=n*(1-e),l=n*(1-e*s),u=n*(1-e*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var t=this.r*Tn,e=this.g*Tn,n=this.b*Tn,i={h:0,s:0,v:0},r=Math.max(t,e,n),o=Math.min(t,e,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=t===r?(e-n)/a:e===r?2+(n-t)/a:4+(t-e)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(t,e,n,i){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,n=t.b||0,i="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)),this},n.multiply=function(t){var e=(255&this._val)*t.r>>8,n=(65280&this._val)*t.g>>8,i=(16711680&this._val)*t.b>>8,r=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&r|16711680&i|65280&n|255&e,this},n._set_r_unsafe=function(t){return this._val=(4294967040&this._val|t)>>>0,this},n._set_g_unsafe=function(t){return this._val=(4294902015&this._val|t<<8)>>>0,this},n._set_b_unsafe=function(t){return this._val=(4278255615&this._val|t<<16)>>>0,this},n._set_a_unsafe=function(t){return this._val=(16777215&this._val|t<<24)>>>0,this},K(e,[{key:"r",get:function(){return 255&this._val},set:function(t){t=~~sn(t,0,255),this._val=(4294967040&this._val|t)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(t){t=~~sn(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(t){t=~~sn(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(t){t=~~sn(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}},{key:"x",get:function(){return this.r*Tn},set:function(t){this.r=255*t}},{key:"y",get:function(){return this.g*Tn},set:function(t){this.g=255*t}},{key:"z",get:function(){return this.b*Tn},set:function(t){this.b=255*t}},{key:"w",get:function(){return this.a*Tn},set:function(t){this.a=255*t}}]),e}(le));function wn(t,e,n,i){return new En(t,e,n,i)}En.WHITE=Object.freeze(new En(255,255,255,255)),En.GRAY=Object.freeze(new En(127,127,127,255)),En.BLACK=Object.freeze(new En(0,0,0,255)),En.TRANSPARENT=Object.freeze(new En(0,0,0,0)),En.RED=Object.freeze(new En(255,0,0,255)),En.GREEN=Object.freeze(new En(0,255,0,255)),En.BLUE=Object.freeze(new En(0,0,255,255)),En.CYAN=Object.freeze(new En(0,255,255,255)),En.MAGENTA=Object.freeze(new En(255,0,255,255)),En.YELLOW=Object.freeze(new En(255,255,0,255)),Ze.fastDefine("cc.Color",En,{r:0,g:0,b:0,a:255}),c.Color=En,c.color=wn;var Pn=t("Vec3",function(t){function e(e,n,i){var r;return r=t.call(this)||this,e&&"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z):(r.x=e||0,r.y=n||0,r.z=i||0),r}Q(e,t),e.zero=function(t){return t.x=0,t.y=0,t.z=0,t},e.clone=function(t){return new e(t.x,t.y,t.z)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t},e.set=function(t,e,n,i){return t.x=e,t.y=n,t.z=i,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return Math.sqrt(n*n+i*i+r*r)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return n*n+i*i+r*r},e.len=function(t){var e=t.x,n=t.y,i=t.z;return Math.sqrt(e*e+n*n+i*i)},e.lengthSqr=function(t){var e=t.x,n=t.y,i=t.z;return e*e+n*n+i*i},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t},e.invert=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t},e.invertSafe=function(t,e){var n=e.x,i=e.y,r=e.z;return Math.abs(n)<rn?t.x=0:t.x=1/n,Math.abs(i)<rn?t.y=0:t.y=1/i,Math.abs(r)<rn?t.z=0:t.z=1/r,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=e.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),t.x=n*o,t.y=i*o,t.z=r*o),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},e.cross=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.x,s=n.y,c=n.z;return t.x=r*c-o*s,t.y=o*a-i*c,t.z=i*s-r*a,t},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t},e.random=function(t,e){e=e||1;var n=2*_n()*Math.PI,i=2*_n()-1,r=Math.sqrt(1-i*i);return t.x=r*Math.cos(n)*e,t.y=r*Math.sin(n)*e,t.z=i*e,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,t.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,t.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,t.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,t},e.transformMat4Normal=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,t.x=(n.m00*i+n.m04*r+n.m08*o)*a,t.y=(n.m01*i+n.m05*r+n.m09*o)*a,t.z=(n.m02*i+n.m06*r+n.m10*o)*a,t},e.transformMat3=function(t,e,n){var i=e.x,r=e.y,o=e.z;return t.x=i*n.m00+r*n.m03+o*n.m06,t.y=i*n.m01+r*n.m04+o*n.m07,t.z=i*n.m02+r*n.m05+o*n.m08,t},e.transformAffine=function(t,e,n){var i=e.x,r=e.y,o=e.z;return t.x=n.m00*i+n.m04*r+n.m08*o+n.m12,t.y=n.m01*i+n.m05*r+n.m09*o+n.m13,t.x=n.m02*i+n.m06*r+n.m10*o+n.m14,t},e.transformQuat=function(t,e,n){var i=n.w*e.x+n.y*e.z-n.z*e.y,r=n.w*e.y+n.z*e.x-n.x*e.z,o=n.w*e.z+n.x*e.y-n.y*e.x,a=-n.x*e.x-n.y*e.y-n.z*e.z;return t.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,t.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,t.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,t},e.transformRTS=function(t,e,n,i,r){var o=e.x*r.x,a=e.y*r.y,s=e.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return t.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,t.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,t.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,t},e.transformInverseRTS=function(t,e,n,i,r){var o=e.x-i.x,a=e.y-i.y,s=e.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return t.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,t.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,t.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,t},e.rotateX=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.rotateY=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.rotateZ=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z},e.equals=function(t,e,n){void 0===n&&(n=rn);var i=t.x,r=t.y,o=t.z,a=e.x,s=e.y,c=e.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},e.angle=function(t,n){e.normalize(In,t),e.normalize(Rn,n);var i=e.dot(In,Rn);return i>1?0:i<-1?Math.PI:Math.acos(i)},e.projectOnPlane=function(t,n,i){return e.subtract(t,n,e.project(t,n,i))},e.project=function(t,n,i){var r=e.lengthSqr(i);return r<1e-6?e.set(t,0,0,0):e.multiplyScalar(t,i,e.dot(n,i)/r)};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z)},n.set=function(t,e,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=n||0),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))},n.equals3f=function(t,e,n,i){return void 0===i&&(i=rn),Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},n.strictEquals3f=function(t,e,n){return this.x===t&&this.y===e&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},n.add3f=function(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},n.subtract3f=function(t,e,n){return this.x-=t,this.y-=e,this.z-=n,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this},n.multiply3f=function(t,e,n){return this.x*=t,this.y*=e,this.z*=n,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},n.divide3f=function(t,e,n){return this.x/=t,this.y/=e,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(t,e){return this.x=sn(this.x,t.x,e.x),this.y=sn(this.y,t.y,e.y),this.z=sn(this.z,t.z,e.z),this},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},n.cross=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*r-e*a,this.z=e*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var t=this.x,e=this.y,n=this.z,i=t*t+e*e+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=t*i,this.y=e*i,this.z=n*i),this},n.transformMat4=function(t){var e=this.x,n=this.y,i=this.z,r=t.m03*e+t.m07*n+t.m11*i+t.m15;return r=r?1/r:1,this.x=(t.m00*e+t.m04*n+t.m08*i+t.m12)*r,this.y=(t.m01*e+t.m05*n+t.m09*i+t.m13)*r,this.z=(t.m02*e+t.m06*n+t.m10*i+t.m14)*r,this},e}(le));Pn.UNIT_X=Object.freeze(new Pn(1,0,0)),Pn.UNIT_Y=Object.freeze(new Pn(0,1,0)),Pn.UNIT_Z=Object.freeze(new Pn(0,0,1)),Pn.RIGHT=Object.freeze(new Pn(1,0,0)),Pn.UP=Object.freeze(new Pn(0,1,0)),Pn.FORWARD=Object.freeze(new Pn(0,0,-1)),Pn.ZERO=Object.freeze(new Pn(0,0,0)),Pn.ONE=Object.freeze(new Pn(1,1,1)),Pn.NEG_ONE=Object.freeze(new Pn(-1,-1,-1));var In=new Pn,Rn=new Pn;function Dn(t,e,n){return new Pn(t,e,n)}Ze.fastDefine("cc.Vec3",Pn,{x:0,y:0,z:0}),c.Vec3=Pn,c.v3=Dn;var Mn=t("Mat3",function(t){function e(e,n,i,r,o,a,s,c,l){var u;return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=t.call(this)||this,"object"==typeof e?(u.m00=e.m00,u.m01=e.m01,u.m02=e.m02,u.m03=e.m03,u.m04=e.m04,u.m05=e.m05,u.m06=e.m06,u.m07=e.m07,u.m08=e.m08):(u.m00=e,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}Q(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.set=function(t,e,n,i,r,o,a,s,c,l){return t.m00=e,t.m01=n,t.m02=i,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.transpose=function(t,e){if(t===e){var n=e.m01,i=e.m02,r=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=n,t.m05=e.m07,t.m06=i,t.m07=r}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t},e.invert=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=u*a-s*l,_=-u*o+s*c,f=l*o-a*c,d=n*h+i*_+r*f;return 0===d?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(d=1/d,t.m00=h*d,t.m01=(-u*i+r*l)*d,t.m02=(s*i-r*a)*d,t.m03=_*d,t.m04=(u*n-r*c)*d,t.m05=(-s*n+r*o)*d,t.m06=f*d,t.m07=(-l*n+i*c)*d,t.m08=(a*n-i*o)*d,t)},e.determinant=function(t){var e=t.m00,n=t.m01,i=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08;return e*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},e.multiply=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return t.m00=_*i+f*a+d*l,t.m01=_*r+f*s+d*u,t.m02=_*o+f*c+d*h,t.m03=p*i+m*a+v*l,t.m04=p*r+m*s+v*u,t.m05=p*o+m*c+v*h,t.m06=g*i+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.multiplyMat4=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return t.m00=_*i+f*a+d*l,t.m01=_*r+f*s+d*u,t.m02=_*o+f*c+d*h,t.m03=p*i+m*a+v*l,t.m04=p*r+m*s+v*u,t.m05=p*o+m*c+v*h,t.m06=g*i+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.transform=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=n.x,f=n.y;return t.m00=i,t.m01=r,t.m02=o,t.m03=a,t.m04=s,t.m05=c,t.m06=_*i+f*a+l,t.m07=_*r+f*s+u,t.m08=_*o+f*c+h,t},e.scale=function(t,e,n){var i=n.x,r=n.y;return t.m00=i*e.m00,t.m01=i*e.m01,t.m02=i*e.m02,t.m03=r*e.m03,t.m04=r*e.m04,t.m05=r*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.rotate=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=Math.sin(n),f=Math.cos(n);return t.m00=f*i+_*a,t.m01=f*r+_*s,t.m02=f*o+_*c,t.m03=f*a-_*i,t.m04=f*s-_*r,t.m05=f*c-_*o,t.m06=l,t.m07=u,t.m08=h,t},e.fromMat4=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t},e.fromViewUp=function(t,n,i){return Pn.lengthSqr(n)<rn*rn?(e.identity(t),t):(i=i||Pn.UNIT_Y,Pn.normalize(Bn,Pn.cross(Bn,i,n)),Pn.lengthSqr(Bn)<rn*rn?(e.identity(t),t):(Pn.cross(On,n,Bn),e.set(t,Bn.x,Bn.y,Bn.z,On.x,On.y,On.z,n.x,n.y,n.z),t))},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=-n,t.m04=i,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromQuat=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,d=r*c,p=o*a,m=o*s,v=o*c;return t.m00=1-h-d,t.m03=u-v,t.m06=_+m,t.m01=u+v,t.m04=1-l-d,t.m07=f-p,t.m02=_-m,t.m05=f+p,t.m08=1-l-h,t},e.inverseTransposeMat4=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,d=e.m12,p=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,A=i*l-o*s,C=r*l-o*c,b=u*p-h*d,T=u*m-_*d,E=u*v-f*d,w=h*m-_*p,P=h*v-f*p,I=_*v-f*m,R=g*I-y*P+x*w+S*E-A*T+C*b;return R?(R=1/R,t.m00=(s*I-c*P+l*w)*R,t.m01=(c*E-a*I-l*T)*R,t.m02=(a*P-s*E+l*b)*R,t.m03=(r*P-i*I-o*w)*R,t.m04=(n*I-r*E+o*T)*R,t.m05=(i*E-n*P-o*b)*R,t.m06=(p*C-m*A+v*S)*R,t.m07=(m*x-d*C-v*y)*R,t.m08=(d*A-p*x+v*g)*R,t):null},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t},e.add=function(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t},e.subtract=function(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t},e.multiplyScalar=function(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t},e.multiplyScalarAndAdd=function(t,e,n,i){return t.m00=n.m00*i+e.m00,t.m01=n.m01*i+e.m01,t.m02=n.m02*i+e.m02,t.m03=n.m03*i+e.m03,t.m04=n.m04*i+e.m04,t.m05=n.m05*i+e.m05,t.m06=n.m06*i+e.m06,t.m07=n.m07*i+e.m07,t.m08=n.m08*i+e.m08,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))};var n=e.prototype;return n.clone=function(){var t=this;return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},n.set=function(t,e,n,i,r,o,a,s,c){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))},n.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08},n.toString=function(){var t=this;return"[\n"+t.m00+", "+t.m01+", "+t.m02+",\n"+t.m03+",\n"+t.m04+", "+t.m05+",\n"+t.m06+", "+t.m07+",\n"+t.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var t=this.m01,e=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=t,this.m05=this.m07,this.m06=e,this.m07=n,this},n.invert=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,_=t*l+e*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*e+n*s)*_,this.m02=(o*e-n*r)*_,this.m03=u*_,this.m04=(c*t-n*a)*_,this.m05=(-o*t+n*i)*_,this.m06=h*_,this.m07=(-s*t+e*a)*_,this.m08=(r*t-e*i)*_,this)},n.determinant=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return t*(c*r-o*s)+e*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this},n.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this},n.multiply=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=t.m00,h=t.m01,_=t.m02,f=t.m03,d=t.m04,p=t.m05,m=t.m06,v=t.m07,g=t.m08;return this.m00=u*e+h*r+_*s,this.m01=u*n+h*o+_*c,this.m02=u*i+h*a+_*l,this.m03=f*e+d*r+p*s,this.m04=f*n+d*o+p*c,this.m05=f*i+d*a+p*l,this.m06=m*e+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this},n.scale=function(t){var e=t.x,n=t.y;return this.m00=e*this.m00,this.m01=e*this.m01,this.m02=e*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(t),h=Math.cos(t);return this.m00=h*e+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*e,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,d=r*o,p=r*a,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+p,this.m01=l+m,this.m04=1-c-f,this.m07=_-d,this.m02=h-p,this.m05=_+d,this.m08=1-c-u,this},e}(le));Mn.IDENTITY=Object.freeze(new Mn);var Bn=new Pn,On=new Pn;Ze.fastDefine("cc.Mat3",Mn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),c.Mat3=Mn;var Nn=t("Quat",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}Q(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,n,i,r){return t.x=e,t.y=n,t.z=i,t.w=r,t},e.identity=function(t){return t.x=0,t.y=0,t.z=0,t.w=1,t},e.rotationTo=function(t,n,i){var r=Pn.dot(n,i);return r<-.999999?(Pn.cross(zn,Pn.UNIT_X,n),zn.length()<1e-6&&Pn.cross(zn,Pn.UNIT_Y,n),Pn.normalize(zn,zn),e.fromAxisAngle(t,zn,Math.PI),t):r>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(Pn.cross(zn,n,i),t.x=zn.x,t.y=zn.y,t.z=zn.z,t.w=1+r,e.normalize(t,t))},e.getAxisAngle=function(t,e){var n=2*Math.acos(e.w),i=Math.sin(n/2);return 0!==i?(t.x=e.x/i,t.y=e.y/i,t.z=e.z/i):(t.x=1,t.y=0,t.z=0),n},e.multiply=function(t,e,n){var i=e.x*n.w+e.w*n.x+e.y*n.z-e.z*n.y,r=e.y*n.w+e.w*n.y+e.z*n.x-e.x*n.z,o=e.z*n.w+e.w*n.z+e.x*n.y-e.y*n.x,a=e.w*n.w-e.x*n.x-e.y*n.y-e.z*n.z;return t.x=i,t.y=r,t.z=o,t.w=a,t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t},e.rotateX=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+c*i,t.y=a*r+s*i,t.z=s*r-a*i,t.w=c*r-o*i,t},e.rotateY=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r-s*i,t.y=a*r+c*i,t.z=s*r+o*i,t.w=c*r-a*i,t},e.rotateZ=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+a*i,t.y=a*r-o*i,t.z=s*r+c*i,t.w=c*r-s*i,t},e.rotateAround=function(t,n,i,r){return e.invert(Ln,n),Pn.transformQuat(zn,i,Ln),e.fromAxisAngle(Ln,zn,r),e.multiply(t,n,Ln),t},e.rotateAroundLocal=function(t,n,i,r){return e.fromAxisAngle(Ln,i,r),e.multiply(t,n,Ln),t},e.calculateW=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t},e.slerp=function(t,e,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=e.x*n.x+e.y*n.y+e.z*n.z+e.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,o=Math.sin(i*h)/_}else r=1-i,o=i;return t.x=r*e.x+o*a,t.y=r*e.y+o*s,t.z=r*e.z+o*c,t.w=r*e.w+o*l,t},e.sqlerp=function(t,n,i,r,o,a){return e.slerp(Ln,n,o,a),e.slerp(Fn,i,r,a),e.slerp(t,Ln,Fn,2*a*(1-a)),t},e.invert=function(t,e){var n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,i=n?1/n:0;return t.x=-e.x*i,t.y=-e.y*i,t.z=-e.z*i,t.w=e.w*i,t},e.conjugate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t},e.len=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)},e.lengthSqr=function(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w},e.normalize=function(t,e){var n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return n>0&&(n=1/Math.sqrt(n),t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n),t},e.fromAxes=function(t,n,i,r){return Mn.set(Vn,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),e.normalize(t,e.fromMat3(t,Vn))},e.fromViewUp=function(t,n,i){return Mn.fromViewUp(Vn,n,i),e.normalize(t,e.fromMat3(t,Vn))},e.fromAxisAngle=function(t,e,n){n*=.5;var i=Math.sin(n);return t.x=i*e.x,t.y=i*e.y,t.z=i*e.z,t.w=Math.cos(n),t},e.fromMat3=function(t,e){var n=e.m00,i=e.m03,r=e.m06,o=e.m01,a=e.m04,s=e.m07,c=e.m02,l=e.m05,u=e.m08,h=n+a+u;if(h>0){var _=.5/Math.sqrt(h+1);t.w=.25/_,t.x=(l-s)*_,t.y=(r-c)*_,t.z=(o-i)*_}else if(n>a&&n>u){var f=2*Math.sqrt(1+n-a-u);t.w=(l-s)/f,t.x=.25*f,t.y=(i+o)/f,t.z=(r+c)/f}else if(a>u){var d=2*Math.sqrt(1+a-n-u);t.w=(r-c)/d,t.x=(i+o)/d,t.y=.25*d,t.z=(s+l)/d}else{var p=2*Math.sqrt(1+u-n-a);t.w=(o-i)/p,t.x=(r+c)/p,t.y=(s+l)/p,t.z=.25*p}return t},e.fromEuler=function(t,e,n,i){e*=kn,n*=kn,i*=kn;var r=Math.sin(e),o=Math.cos(e),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return t.x=r*s*l+o*a*c,t.y=o*a*l+r*s*c,t.z=o*s*c-r*a*l,t.w=o*s*l-r*a*c,t},e.fromAngleZ=function(t,e){return e*=kn,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t},e.toAxisX=function(t,e){var n=2*e.y,i=2*e.z;return t.x=1-n*e.y-i*e.z,t.y=n*e.x+i*e.w,t.z=i*e.x+n*e.w,t},e.toAxisY=function(t,e){var n=2*e.x,i=2*e.y,r=2*e.z;return t.x=i*e.x-r*e.w,t.y=1-n*e.x-r*e.z,t.z=r*e.y+n*e.w,t},e.toAxisZ=function(t,e){var n=2*e.x,i=2*e.y,r=2*e.z;return t.x=r*e.x-i*e.w,t.y=r*e.y-n*e.w,t.z=1-n*e.x-i*e.y,t},e.toEuler=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=hn(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-hn(2*Math.atan2(i,a)),l=-90;else{var h=i*i,_=r*r,f=o*o;s=hn(Math.atan2(2*i*a-2*r*o,1-2*h-2*f)),c=hn(Math.atan2(2*r*a-2*i*o,1-2*_-2*f)),l=hn(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return t.x=s,t.y=c,t.z=l,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z,this.w)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},n.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.getEulerAngles=function(t){return e.toEuler(t,this)},n.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this},n.slerp=function(t,n){return e.slerp(this,this,t,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},e}(le));Nn.IDENTITY=Object.freeze(new Nn);var Ln=new Nn,Fn=new Nn,zn=new Pn,Vn=new Mn,kn=.5*Math.PI/180;function Gn(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),new Nn(t,e,n,i)}Ze.fastDefine("cc.Quat",Nn,{x:0,y:0,z:0,w:1}),c.Quat=Nn,c.quat=Gn;var Un=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Hn=t("Mat4",function(t){function e(e,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m){var v;return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=1),(v=t.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof e?(v.m00=e.m00,v.m01=e.m01,v.m02=e.m02,v.m03=e.m03,v.m04=e.m04,v.m05=e.m05,v.m06=e.m06,v.m07=e.m07,v.m08=e.m08,v.m09=e.m09,v.m10=e.m10,v.m11=e.m11,v.m12=e.m12,v.m13=e.m13,v.m14=e.m14,v.m15=e.m15):(v.m00=e,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=d,v.m14=p,v.m15=m),v}Q(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.set=function(t,e,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m){return t.m00=e,t.m01=n,t.m02=i,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t.m09=u,t.m10=h,t.m11=_,t.m12=f,t.m13=d,t.m14=p,t.m15=m,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.transpose=function(t,e){if(t===e){var n=e.m01,i=e.m02,r=e.m03,o=e.m06,a=e.m07,s=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=n,t.m06=e.m09,t.m07=e.m13,t.m08=i,t.m09=o,t.m11=e.m14,t.m12=r,t.m13=a,t.m14=s}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t},e.invert=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,d=e.m12,p=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,A=i*l-o*s,C=r*l-o*c,b=u*p-h*d,T=u*m-_*d,E=u*v-f*d,w=h*m-_*p,P=h*v-f*p,I=_*v-f*m,R=g*I-y*P+x*w+S*E-A*T+C*b;return 0===R?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(R=1/R,t.m00=(s*I-c*P+l*w)*R,t.m01=(r*P-i*I-o*w)*R,t.m02=(p*C-m*A+v*S)*R,t.m03=(_*A-h*C-f*S)*R,t.m04=(c*E-a*I-l*T)*R,t.m05=(n*I-r*E+o*T)*R,t.m06=(m*x-d*C-v*y)*R,t.m07=(u*C-_*x+f*y)*R,t.m08=(a*P-s*E+l*b)*R,t.m09=(i*E-n*P-o*b)*R,t.m10=(d*A-p*x+v*g)*R,t.m11=(h*x-u*A-f*g)*R,t.m12=(s*T-a*w-c*b)*R,t.m13=(n*w-i*T+r*b)*R,t.m14=(p*y-d*S-m*g)*R,t.m15=(u*S-h*y+_*g)*R,t)},e.determinant=function(t){var e=t.m00,n=t.m01,i=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11,f=t.m12,d=t.m13,p=t.m14,m=t.m15;return(e*a-n*o)*(h*m-_*p)-(e*s-i*o)*(u*m-_*d)+(e*c-r*o)*(u*p-h*d)+(n*s-i*a)*(l*m-_*f)-(n*c-r*a)*(l*p-h*f)+(i*c-r*s)*(l*d-u*f)},e.multiply=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=e.m09,f=e.m10,d=e.m11,p=e.m12,m=e.m13,v=e.m14,g=e.m15,y=n.m00,x=n.m01,S=n.m02,A=n.m03;return t.m00=y*i+x*s+S*h+A*p,t.m01=y*r+x*c+S*_+A*m,t.m02=y*o+x*l+S*f+A*v,t.m03=y*a+x*u+S*d+A*g,y=n.m04,x=n.m05,S=n.m06,A=n.m07,t.m04=y*i+x*s+S*h+A*p,t.m05=y*r+x*c+S*_+A*m,t.m06=y*o+x*l+S*f+A*v,t.m07=y*a+x*u+S*d+A*g,y=n.m08,x=n.m09,S=n.m10,A=n.m11,t.m08=y*i+x*s+S*h+A*p,t.m09=y*r+x*c+S*_+A*m,t.m10=y*o+x*l+S*f+A*v,t.m11=y*a+x*u+S*d+A*g,y=n.m12,x=n.m13,S=n.m14,A=n.m15,t.m12=y*i+x*s+S*h+A*p,t.m13=y*r+x*c+S*_+A*m,t.m14=y*o+x*l+S*f+A*v,t.m15=y*a+x*u+S*d+A*g,t},e.transform=function(t,e,n){var i=n.x,r=n.y,o=n.z;if(e===t)t.m12=e.m00*i+e.m04*r+e.m08*o+e.m12,t.m13=e.m01*i+e.m05*r+e.m09*o+e.m13,t.m14=e.m02*i+e.m06*r+e.m10*o+e.m14,t.m15=e.m03*i+e.m07*r+e.m11*o+e.m15;else{var a=e.m00,s=e.m01,c=e.m02,l=e.m03,u=e.m04,h=e.m05,_=e.m06,f=e.m07,d=e.m08,p=e.m09,m=e.m10,v=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=a,t.m01=s,t.m02=c,t.m03=l,t.m04=u,t.m05=h,t.m06=_,t.m07=f,t.m08=d,t.m09=p,t.m10=m,t.m11=v,t.m12=a*i+u*r+d*o+e.m12,t.m13=s*i+h*r+p*o+e.m13,t.m14=c*i+_*r+m*o+e.m14,t.m15=l*i+f*r+v*o+e.m15}return t},e.translate=function(t,e,n){return console.warn("function changed"),e===t?(t.m12+=n.x,t.m13+=n.y,t.m14+=n.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=n.x,t.m13+=n.y,t.m14+=n.z,t.m15=e.m15),t},e.scale=function(t,e,n){var i=n.x,r=n.y,o=n.z;return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*r,t.m05=e.m05*r,t.m06=e.m06*r,t.m07=e.m07*r,t.m08=e.m08*o,t.m09=e.m09*o,t.m10=e.m10*o,t.m11=e.m11*o,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.rotate=function(t,e,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<rn)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=e.m00,_=e.m01,f=e.m02,d=e.m03,p=e.m04,m=e.m05,v=e.m06,g=e.m07,y=e.m08,x=e.m09,S=e.m10,A=e.m11,C=r*r*u+l,b=o*r*u+a*c,T=a*r*u-o*c,E=r*o*u-a*c,w=o*o*u+l,P=a*o*u+r*c,I=r*a*u+o*c,R=o*a*u-r*c,D=a*a*u+l;return t.m00=h*C+p*b+y*T,t.m01=_*C+m*b+x*T,t.m02=f*C+v*b+S*T,t.m03=d*C+g*b+A*T,t.m04=h*E+p*w+y*P,t.m05=_*E+m*w+x*P,t.m06=f*E+v*w+S*P,t.m07=d*E+g*w+A*P,t.m08=h*I+p*R+y*D,t.m09=_*I+m*R+x*D,t.m10=f*I+v*R+S*D,t.m11=d*I+g*R+A*D,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t},e.rotateX=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=o*r+l*i,t.m05=a*r+u*i,t.m06=s*r+h*i,t.m07=c*r+_*i,t.m08=l*r-o*i,t.m09=u*r-a*i,t.m10=h*r-s*i,t.m11=_*r-c*i,t},e.rotateY=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m08,u=e.m09,h=e.m10,_=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r-l*i,t.m01=a*r-u*i,t.m02=s*r-h*i,t.m03=c*r-_*i,t.m08=o*i+l*r,t.m09=a*i+u*r,t.m10=s*i+h*r,t.m11=c*i+_*r,t},e.rotateZ=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m04,u=e.m05,h=e.m06,_=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r+l*i,t.m01=a*r+u*i,t.m02=s*r+h*i,t.m03=c*r+_*i,t.m04=l*r-o*i,t.m05=u*r-a*i,t.m06=h*r-s*i,t.m07=_*r-c*i,t},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRotation=function(t,e,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<rn)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(e),c=Math.cos(e),l=1-c;return t.m00=i*i*l+c,t.m01=r*i*l+o*s,t.m02=o*i*l-r*s,t.m03=0,t.m04=i*r*l-o*s,t.m05=r*r*l+c,t.m06=o*r*l+i*s,t.m07=0,t.m08=i*o*l+r*s,t.m09=r*o*l-i*s,t.m10=o*o*l+c,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromXRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=i,t.m06=n,t.m07=0,t.m08=0,t.m09=-n,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromYRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=0,t.m02=-n,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=n,t.m09=0,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromZRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=0,t.m04=-n,t.m05=i,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRT=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=o*l,m=a*s,v=a*c,g=a*l;return t.m00=1-(f+p),t.m01=h+g,t.m02=_-v,t.m03=0,t.m04=h-g,t.m05=1-(u+p),t.m06=d+m,t.m07=0,t.m08=_+v,t.m09=d-m,t.m10=1-(u+f),t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t},e.getTranslation=function(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t},e.getScaling=function(t,e){var n=Wn.m00=e.m00,i=Wn.m01=e.m01,r=Wn.m02=e.m02,o=Wn.m03=e.m04,a=Wn.m04=e.m05,s=Wn.m05=e.m06,c=Wn.m06=e.m08,l=Wn.m07=e.m09,u=Wn.m08=e.m10;return t.x=Math.sqrt(n*n+i*i+r*r),t.y=Math.sqrt(o*o+a*a+s*s),t.z=Math.sqrt(c*c+l*l+u*u),Mn.determinant(Wn)<0&&(t.x*=-1),t},e.getRotation=function(t,e){var n=e.m00+e.m05+e.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),t.w=.25*i,t.x=(e.m06-e.m09)/i,t.y=(e.m08-e.m02)/i,t.z=(e.m01-e.m04)/i):e.m00>e.m05&&e.m00>e.m10?(i=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/i,t.x=.25*i,t.y=(e.m01+e.m04)/i,t.z=(e.m08+e.m02)/i):e.m05>e.m10?(i=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/i,t.x=(e.m01+e.m04)/i,t.y=.25*i,t.z=(e.m06+e.m09)/i):(i=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/i,t.x=(e.m08+e.m02)/i,t.y=(e.m06+e.m09)/i,t.z=.25*i),t},e.toRTS=function(t,e,n,i){i.x=Pn.set(jn,t.m00,t.m01,t.m02).length(),Wn.m00=t.m00/i.x,Wn.m01=t.m01/i.x,Wn.m02=t.m02/i.x,i.y=Pn.set(jn,t.m04,t.m05,t.m06).length(),Wn.m03=t.m04/i.y,Wn.m04=t.m05/i.y,Wn.m05=t.m06/i.y,i.z=Pn.set(jn,t.m08,t.m09,t.m10).length(),Wn.m06=t.m08/i.z,Wn.m07=t.m09/i.z,Wn.m08=t.m10/i.z,Mn.determinant(Wn)<0&&(i.x*=-1,Wn.m00*=-1,Wn.m01*=-1,Wn.m02*=-1),Nn.fromMat3(e,Wn),Pn.set(n,t.m12,t.m13,t.m14)},e.fromRTS=function(t,e,n,i){var r=e.x,o=e.y,a=e.z,s=e.w,c=r+r,l=o+o,u=a+a,h=r*c,_=r*l,f=r*u,d=o*l,p=o*u,m=a*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,A=i.z;return t.m00=(1-(d+m))*x,t.m01=(_+y)*x,t.m02=(f-g)*x,t.m03=0,t.m04=(_-y)*S,t.m05=(1-(h+m))*S,t.m06=(p+v)*S,t.m07=0,t.m08=(f+g)*A,t.m09=(p-v)*A,t.m10=(1-(h+d))*A,t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t},e.fromRTSOrigin=function(t,e,n,i,r){var o=e.x,a=e.y,s=e.z,c=e.w,l=o+o,u=a+a,h=s+s,_=o*l,f=o*u,d=o*h,p=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,A=i.y,C=i.z,b=r.x,T=r.y,E=r.z;return t.m00=(1-(p+v))*S,t.m01=(f+x)*S,t.m02=(d-y)*S,t.m03=0,t.m04=(f-x)*A,t.m05=(1-(_+v))*A,t.m06=(m+g)*A,t.m07=0,t.m08=(d+y)*C,t.m09=(m-g)*C,t.m10=(1-(_+p))*C,t.m11=0,t.m12=n.x+b-(t.m00*b+t.m04*T+t.m08*E),t.m13=n.y+T-(t.m01*b+t.m05*T+t.m09*E),t.m14=n.z+E-(t.m02*b+t.m06*T+t.m10*E),t.m15=1,t},e.fromQuat=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,d=r*c,p=o*a,m=o*s,v=o*c;return t.m00=1-h-d,t.m01=u+v,t.m02=_-m,t.m03=0,t.m04=u-v,t.m05=1-l-d,t.m06=f+p,t.m07=0,t.m08=_+m,t.m09=f-p,t.m10=1-l-h,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.frustum=function(t,e,n,i,r,o,a){var s=1/(n-e),c=1/(r-i),l=1/(o-a);return t.m00=2*o*s,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*o*c,t.m06=0,t.m07=0,t.m08=(n+e)*s,t.m09=(r+i)*c,t.m10=(a+o)*l,t.m11=-1,t.m12=0,t.m13=0,t.m14=a*o*2*l,t.m15=0,t},e.perspective=function(t,e,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(e/2),u=1/(i-r),h=o?l/n:l,_=(o?l:l*n)*s,f=Un[c];return t.m00=h*f[0],t.m01=h*f[1],t.m02=0,t.m03=0,t.m04=_*f[2],t.m05=_*f[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(r-a*i)*u,t.m11=-1,t.m12=0,t.m13=0,t.m14=r*i*u*(1-a),t.m15=0,t},e.ortho=function(t,e,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(e-n),h=1/(i-r)*c,_=1/(o-a),f=-2*u,d=-2*h,p=(e+n)*u,m=(r+i)*h,v=Un[l];return t.m00=f*v[0],t.m01=f*v[1],t.m02=0,t.m03=0,t.m04=d*v[2],t.m05=d*v[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=_*(1-s),t.m11=0,t.m12=p*v[0]+m*v[2],t.m13=p*v[1]+m*v[3],t.m14=(o-s*a)*_,t.m15=1,t},e.lookAt=function(t,e,n,i){var r=e.x,o=e.y,a=e.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,_=a-n.z,f=1/Math.sqrt(u*u+h*h+_*_),d=c*(_*=f)-l*(h*=f),p=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(d*d+p*p+m*m))-_*(p*=f),g=_*(d*=f)-u*m,y=u*p-h*d;return t.m00=d,t.m01=v,t.m02=u,t.m03=0,t.m04=p,t.m05=g,t.m06=h,t.m07=0,t.m08=m,t.m09=y,t.m10=_,t.m11=0,t.m12=-(d*r+p*o+m*a),t.m13=-(v*r+g*o+y*a),t.m14=-(u*r+h*o+_*a),t.m15=1,t},e.inverseTranspose=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,d=e.m12,p=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,A=i*l-o*s,C=r*l-o*c,b=u*p-h*d,T=u*m-_*d,E=u*v-f*d,w=h*m-_*p,P=h*v-f*p,I=_*v-f*m,R=g*I-y*P+x*w+S*E-A*T+C*b;return R?(R=1/R,t.m00=(s*I-c*P+l*w)*R,t.m01=(c*E-a*I-l*T)*R,t.m02=(a*P-s*E+l*b)*R,t.m03=0,t.m04=(r*P-i*I-o*w)*R,t.m05=(n*I-r*E+o*T)*R,t.m06=(i*E-n*P-o*b)*R,t.m07=0,t.m08=(p*C-m*A+v*S)*R,t.m09=(m*x-d*C-v*y)*R,t.m10=(d*A-p*x+v*g)*R,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t[n+9]=e.m09,t[n+10]=e.m10,t[n+11]=e.m11,t[n+12]=e.m12,t[n+13]=e.m13,t[n+14]=e.m14,t[n+15]=e.m15,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t.m09=e[n+9],t.m10=e[n+10],t.m11=e[n+11],t.m12=e[n+12],t.m13=e[n+13],t.m14=e[n+14],t.m15=e[n+15],t},e.add=function(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t.m09=e.m09+n.m09,t.m10=e.m10+n.m10,t.m11=e.m11+n.m11,t.m12=e.m12+n.m12,t.m13=e.m13+n.m13,t.m14=e.m14+n.m14,t.m15=e.m15+n.m15,t},e.subtract=function(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t.m09=e.m09-n.m09,t.m10=e.m10-n.m10,t.m11=e.m11-n.m11,t.m12=e.m12-n.m12,t.m13=e.m13-n.m13,t.m14=e.m14-n.m14,t.m15=e.m15-n.m15,t},e.multiplyScalar=function(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t.m09=e.m09*n,t.m10=e.m10*n,t.m11=e.m11*n,t.m12=e.m12*n,t.m13=e.m13*n,t.m14=e.m14*n,t.m15=e.m15*n,t},e.multiplyScalarAndAdd=function(t,e,n,i){return t.m00=e.m00+n.m00*i,t.m01=e.m01+n.m01*i,t.m02=e.m02+n.m02*i,t.m03=e.m03+n.m03*i,t.m04=e.m04+n.m04*i,t.m05=e.m05+n.m05*i,t.m06=e.m06+n.m06*i,t.m07=e.m07+n.m07*i,t.m08=e.m08+n.m08*i,t.m09=e.m09+n.m09*i,t.m10=e.m10+n.m10*i,t.m11=e.m11+n.m11*i,t.m12=e.m12+n.m12*i,t.m13=e.m13+n.m13*i,t.m14=e.m14+n.m14*i,t.m15=e.m15+n.m15*i,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=n*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=n*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=n*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=n*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=n*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=n*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=n*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))};var n=e.prototype;return n.clone=function(){return new e(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(t,e,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=1),"object"==typeof t?(this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15,this.m00=t.m00):(this.m01=e,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=d,this.m15=p,this.m00=t),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))&&Math.abs(this.m09-t.m09)<=e*Math.max(1,Math.abs(this.m09),Math.abs(t.m09))&&Math.abs(this.m10-t.m10)<=e*Math.max(1,Math.abs(this.m10),Math.abs(t.m10))&&Math.abs(this.m11-t.m11)<=e*Math.max(1,Math.abs(this.m11),Math.abs(t.m11))&&Math.abs(this.m12-t.m12)<=e*Math.max(1,Math.abs(this.m12),Math.abs(t.m12))&&Math.abs(this.m13-t.m13)<=e*Math.max(1,Math.abs(this.m13),Math.abs(t.m13))&&Math.abs(this.m14-t.m14)<=e*Math.max(1,Math.abs(this.m14),Math.abs(t.m14))&&Math.abs(this.m15-t.m15)<=e*Math.max(1,Math.abs(this.m15),Math.abs(t.m15))},n.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08&&this.m09===t.m09&&this.m10===t.m10&&this.m11===t.m11&&this.m12===t.m12&&this.m13===t.m13&&this.m14===t.m14&&this.m15===t.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var t=this.m01,e=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=t,this.m06=this.m09,this.m07=this.m13,this.m08=e,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15,m=t*o-e*r,v=t*a-n*r,g=t*s-i*r,y=e*a-n*o,x=e*s-i*o,S=n*s-i*a,A=c*f-l*_,C=c*d-u*_,b=c*p-h*_,T=l*d-u*f,E=l*p-h*f,w=u*p-h*d,P=m*w-v*E+g*T+y*b-x*C+S*A;return 0===P?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(P=1/P,this.m00=(o*w-a*E+s*T)*P,this.m01=(n*E-e*w-i*T)*P,this.m02=(f*S-d*x+p*y)*P,this.m03=(u*x-l*S-h*y)*P,this.m04=(a*b-r*w-s*C)*P,this.m05=(t*w-n*b+i*C)*P,this.m06=(d*g-_*S-p*v)*P,this.m07=(c*S-u*g+h*v)*P,this.m08=(r*E-o*b+s*A)*P,this.m09=(e*b-t*E-i*A)*P,this.m10=(_*x-f*g+p*m)*P,this.m11=(l*g-c*x-h*m)*P,this.m12=(o*C-r*T-a*A)*P,this.m13=(t*T-e*C+n*A)*P,this.m14=(f*v-_*y-d*m)*P,this.m15=(c*y-l*v+u*m)*P,this)},n.determinant=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15;return(t*o-e*r)*(u*p-h*d)-(t*a-n*r)*(l*p-h*f)+(t*s-i*r)*(l*d-u*f)+(e*a-n*o)*(c*p-h*_)-(e*s-i*o)*(c*d-u*_)+(n*s-i*a)*(c*f-l*_)},n.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this.m09+=t.m09,this.m10+=t.m10,this.m11+=t.m11,this.m12+=t.m12,this.m13+=t.m13,this.m14+=t.m14,this.m15+=t.m15,this},n.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this.m09-=t.m09,this.m10-=t.m10,this.m11-=t.m11,this.m12-=t.m12,this.m13-=t.m13,this.m14-=t.m14,this.m15-=t.m15,this},n.multiply=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,d=this.m13,p=this.m14,m=this.m15,v=t.m00,g=t.m01,y=t.m02,x=t.m03;return this.m00=v*e+g*o+y*l+x*f,this.m01=v*n+g*a+y*u+x*d,this.m02=v*i+g*s+y*h+x*p,this.m03=v*r+g*c+y*_+x*m,v=t.m04,g=t.m05,y=t.m06,x=t.m07,this.m04=v*e+g*o+y*l+x*f,this.m05=v*n+g*a+y*u+x*d,this.m06=v*i+g*s+y*h+x*p,this.m07=v*r+g*c+y*_+x*m,v=t.m08,g=t.m09,y=t.m10,x=t.m11,this.m08=v*e+g*o+y*l+x*f,this.m09=v*n+g*a+y*u+x*d,this.m10=v*i+g*s+y*h+x*p,this.m11=v*r+g*c+y*_+x*m,v=t.m12,g=t.m13,y=t.m14,x=t.m15,this.m12=v*e+g*o+y*l+x*f,this.m13=v*n+g*a+y*u+x*d,this.m14=v*i+g*s+y*h+x*p,this.m15=v*r+g*c+y*_+x*m,this},n.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this.m09*=t,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m14*=t,this.m15*=t,this},n.translate=function(t){return console.warn("function changed"),this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this},n.scale=function(t){var e=t.x,n=t.y,i=t.z;return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(t,e){var n=e.x,i=e.y,r=e.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<rn)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(t),s=Math.cos(t),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,d=this.m05,p=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,A=i*n*c+r*a,C=r*n*c-i*a,b=n*i*c-r*a,T=i*i*c+s,E=r*i*c+n*a,w=n*r*c+i*a,P=i*r*c-n*a,I=r*r*c+s;return this.m00=l*S+f*A+v*C,this.m01=u*S+d*A+g*C,this.m02=h*S+p*A+y*C,this.m03=_*S+m*A+x*C,this.m04=l*b+f*T+v*E,this.m05=u*b+d*T+g*E,this.m06=h*b+p*T+y*E,this.m07=_*b+m*T+x*E,this.m08=l*w+f*P+v*I,this.m09=u*w+d*P+g*I,this.m10=h*w+p*P+y*I,this.m11=_*w+m*P+x*I,this},n.getTranslation=function(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t},n.getScale=function(t){var e=Wn.m00=this.m00,n=Wn.m01=this.m01,i=Wn.m02=this.m02,r=Wn.m03=this.m04,o=Wn.m04=this.m05,a=Wn.m05=this.m06,s=Wn.m06=this.m08,c=Wn.m07=this.m09,l=Wn.m08=this.m10;return t.x=Math.sqrt(e*e+n*n+i*i),t.y=Math.sqrt(r*r+o*o+a*a),t.z=Math.sqrt(s*s+c*c+l*l),Mn.determinant(Wn)<0&&(t.x*=-1),t},n.getRotation=function(t){var e=this.m00+this.m05+this.m10,n=0;return e>0?(n=2*Math.sqrt(e+1),t.w=.25*n,t.x=(this.m06-this.m09)/n,t.y=(this.m08-this.m02)/n,t.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),t.w=(this.m06-this.m09)/n,t.x=.25*n,t.y=(this.m01+this.m04)/n,t.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),t.w=(this.m08-this.m02)/n,t.x=(this.m01+this.m04)/n,t.y=.25*n,t.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),t.w=(this.m01-this.m04)/n,t.x=(this.m08+this.m02)/n,t.y=(this.m06+this.m09)/n,t.z=.25*n),t},n.fromRTS=function(t,e,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=o*l,m=a*s,v=a*c,g=a*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(f+p))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+p))*x,this.m06=(d+m)*x,this.m07=0,this.m08=(_+v)*S,this.m09=(d-m)*S,this.m10=(1-(u+f))*S,this.m11=0,this.m12=e.x,this.m13=e.y,this.m14=e.z,this.m15=1,this},n.fromQuat=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,d=r*o,p=r*a,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-p,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+d,this.m07=0,this.m08=h+p,this.m09=_-d,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},e}(le));Hn.IDENTITY=Object.freeze(new Hn);var jn=new Pn,Wn=new Mn;function qn(t,e,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return new Hn(t,e,n,i,r,o,a,s,c,l,u,h,_,f,d,p)}Ze.fastDefine("cc.Mat4",Hn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),c.Mat4=Hn,c.mat4=qn;var Xn=t("Vec2",function(t){function e(e,n){var i;return i=t.call(this)||this,e&&"object"==typeof e?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=n||0),i}Q(e,t),e.clone=function(t){return new e(t.x,t.y)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t},e.set=function(t,e,n){return t.x=e,t.y=n,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y;return n*n+i*i},e.len=function(t){var e=t.x,n=t.y;return Math.sqrt(e*e+n*n)},e.lengthSqr=function(t){var e=t.x,n=t.y;return e*e+n*n},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t},e.inverseSafe=function(t,e){var n=e.x,i=e.y;return Math.abs(n)<rn?t.x=0:t.x=1/n,Math.abs(i)<rn?t.y=0:t.y=1/i,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),t.x=n*r,t.y=i*r),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y},e.cross=function(t,e,n){return t instanceof Pn?(t.x=t.y=0,t.z=e.x*n.y-e.y*n.x,t):t.x*e.y-t.y*e.x},e.lerp=function(t,e,n,i){var r=e.x,o=e.y;return t.x=r+i*(n.x-r),t.y=o+i*(n.y-o),t},e.random=function(t,e){e=e||1;var n=2*_n()*Math.PI;return t.x=Math.cos(n)*e,t.y=Math.sin(n)*e,t},e.transformMat3=function(t,e,n){var i=e.x,r=e.y;return t.x=n.m00*i+n.m03*r+n.m06,t.y=n.m01*i+n.m04*r+n.m07,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y;return t.x=n.m00*i+n.m04*r+n.m12,t.y=n.m01*i+n.m05*r+n.m13,t},e.str=function(t){return"Vec2("+t.x+", "+t.y+")"},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))},e.angle=function(t,n){e.normalize(Yn,t),e.normalize(Kn,n);var i=e.dot(Yn,Kn);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y)},n.set=function(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))},n.equals2f=function(t,e,n){return void 0===n&&(n=rn),Math.abs(this.x-t)<=n*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=n*Math.max(1,Math.abs(this.y),Math.abs(e))},n.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y},n.strictEquals2f=function(t,e){return this.x===t&&this.y===e},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(t,e){var n=this.x,i=this.y;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this},n.clampf=function(t,e){return this.x=sn(this.x,t.x,e.x),this.y=sn(this.y,t.y,e.y),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this},n.add2f=function(t,e){return this.x+=t,this.y+=e,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},n.subtract2f=function(t,e){return this.x-=t,this.y-=e,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this},n.multiply2f=function(t,e){return this.x*=t,this.y*=e,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this},n.divide2f=function(t,e){return this.x/=t,this.y/=e,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(t){return this.x*t.x+this.y*t.y},n.cross=function(t){return this.x*t.y-this.y*t.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var t=this.x,e=this.y,n=t*t+e*e;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(t){var e=this.lengthSqr(),n=t.lengthSqr();if(0===e||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(t)/Math.sqrt(e*n);return i=sn(i,-1,1),Math.acos(i)},n.signAngle=function(t){var e=this.angle(t);return this.cross(t)<0?-e:e},n.rotate=function(t){var e=this.x,n=this.y,i=Math.sin(t),r=Math.cos(t);return this.x=r*e-i*n,this.y=i*e+r*n,this},n.project=function(t){var e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this},n.transformMat4=function(t){var e=this.x,n=this.y;return this.x=t.m00*e+t.m04*n+t.m12,this.y=t.m01*e+t.m05*n+t.m13,this},e}(le));Xn.ZERO=Object.freeze(new Xn(0,0)),Xn.ONE=Object.freeze(new Xn(1,1)),Xn.NEG_ONE=Object.freeze(new Xn(-1,-1)),Xn.UNIT_X=Object.freeze(new Xn(1,0)),Xn.UNIT_Y=Object.freeze(new Xn(0,1));var Yn=new Xn,Kn=new Xn;function Jn(t,e){return new Xn(t,e)}Ze.fastDefine("cc.Vec2",Xn,{x:0,y:0}),c.Vec2=Xn,c.v2=Jn;var Qn=t("Vec4",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=n||0,o.z=i||0,o.w=r||0),o}Q(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,n,i,r){return t.x=e,t.y=n,t.z=i,t.w=r,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t.w=e.w+n.w,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t.w=e.w-n.w,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t.w=e.w*n.w,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t.w=e.w/n.w,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t.w=Math.min(e.w,n.w),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t.w=Math.max(e.w,n.w),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return Math.sqrt(n*n+i*i+r*r+o*o)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return n*n+i*i+r*r+o*o},e.len=function(t){var e=t.x,n=t.y,i=t.z,r=t.w;return Math.sqrt(e*e+n*n+i*i+r*r)},e.lengthSqr=function(t){var e=t.x,n=t.y,i=t.z,r=t.w;return e*e+n*n+i*i+r*r},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t},e.inverseSafe=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w;return Math.abs(n)<rn?t.x=0:t.x=1/n,Math.abs(i)<rn?t.y=0:t.y=1/i,Math.abs(r)<rn?t.z=0:t.z=1/r,Math.abs(o)<rn?t.w=0:t.w=1/o,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),t.x=n*a,t.y=i*a,t.z=r*a,t.w=o*a),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t},e.random=function(t,e){e=e||1;var n=2*_n()*Math.PI,i=2*_n()-1,r=Math.sqrt(1-i*i);return t.x=r*Math.cos(n)*e,t.y=r*Math.sin(n)*e,t.z=i*e,t.w=0,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w;return t.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,t.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,t.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,t.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,t},e.transformAffine=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w;return t.x=n.m00*i+n.m01*r+n.m02*o+n.m03*a,t.y=n.m04*i+n.m05*r+n.m06*o+n.m07*a,t.x=n.m08*i+n.m09*r+n.m10*o+n.m11*a,t.w=e.w,t},e.transformQuat=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,_=l*o+a*r-s*i,f=-a*i-s*r-c*o;return t.x=u*l+f*-a+h*-c-_*-s,t.y=h*l+f*-s+_*-a-u*-c,t.z=_*l+f*-c+u*-s-h*-a,t.w=e.w,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,n){return void 0===n&&(n=rn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z,this.w)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=i||0),this},n.equals=function(t,e){return void 0===e&&(e=rn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},n.equals4f=function(t,e,n,i,r){return void 0===r&&(r=rn),Math.abs(this.x-t)<=r*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=r*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.strictEquals4f=function(t,e,n,i){return this.x===t&&this.y===e&&this.z===n&&this.w===i},n.lerp=function(t,e){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this.z=r+e*(t.z-r),this.w=o+e*(t.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(t,e){return this.x=sn(this.x,t.x,e.x),this.y=sn(this.y,t.y,e.y),this.z=sn(this.z,t.z,e.z),this.w=sn(this.w,t.w,e.w),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},n.add4f=function(t,e,n,i){return this.x+=t,this.y+=e,this.z+=n,this.w+=i,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},n.subtract4f=function(t,e,n,i){return this.x-=t,this.y-=e,this.z-=n,this.w-=i,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},n.multiply4f=function(t,e,n,i){return this.x*=t,this.y*=e,this.z*=n,this.w*=i,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this},n.divide4f=function(t,e,n,i){return this.x/=t,this.y/=e,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},n.cross=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*r-e*a,this.z=e*o-n*r,this},n.length=function(){var t=this.x,e=this.y,n=this.z,i=this.w;return Math.sqrt(t*t+e*e+n*n+i*i)},n.lengthSqr=function(){var t=this.x,e=this.y,n=this.z,i=this.w;return t*t+e*e+n*n+i*i},n.normalize=function(){var t=this.x,e=this.y,n=this.z,i=this.w,r=t*t+e*e+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=t*r,this.y=e*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(t){var e=this.x,n=this.y,i=this.z,r=this.w;return this.x=t.m00*e+t.m04*n+t.m08*i+t.m12*r,this.y=t.m01*e+t.m05*n+t.m09*i+t.m13*r,this.z=t.m02*e+t.m06*n+t.m10*i+t.m14*r,this.w=t.m03*e+t.m07*n+t.m11*i+t.m15*r,this},e}(le));function Zn(t,e,n,i){return new Qn(t,e,n,i)}Qn.ZERO=Object.freeze(new Qn(0,0,0,0)),Qn.ONE=Object.freeze(new Qn(1,1,1,1)),Qn.NEG_ONE=Object.freeze(new Qn(-1,-1,-1,-1)),Ze.fastDefine("cc.Vec4",Qn,{x:0,y:0,z:0,w:0}),c.Vec4=Qn,c.v4=Zn,z(Xn,"Vec2",[{name:"sub",newName:"subtract",target:Xn,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Xn,targetName:"Vec2"},{name:"div",newName:"divide",target:Xn,targetName:"Vec2"},{name:"dist",newName:"distance",target:Xn,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Xn,targetName:"Vec2"},{name:"mag",newName:"len",target:Xn,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Xn,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Xn,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Xn,targetName:"Vec2"}]),z(Xn.prototype,"Vec2",[{name:"mag",newName:"length",target:Xn.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Xn.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Xn.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Xn.prototype,targetName:"Vec2"}]),z(Pn,"Vec3",[{name:"sub",newName:"subtract",target:Pn,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Pn,targetName:"Vec3"},{name:"div",newName:"divide",target:Pn,targetName:"Vec3"},{name:"dist",newName:"distance",target:Pn,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Pn,targetName:"Vec3"},{name:"mag",newName:"len",target:Pn,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Pn,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Pn,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Pn,targetName:"Vec3"}]),z(Pn.prototype,"Vec3",[{name:"mag",newName:"length",target:Pn.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Pn.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Pn.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Pn.prototype,targetName:"Vec3"}]),z(Qn,"Vec4",[{name:"sub",newName:"subtract",target:Qn,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Qn,targetName:"Vec4"},{name:"div",newName:"divide",target:Qn,targetName:"Vec4"},{name:"dist",newName:"distance",target:Qn,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Qn,targetName:"Vec4"},{name:"mag",newName:"len",target:Qn,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Qn,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Qn,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Qn,targetName:"Vec4"}]),z(Qn.prototype,"Vec4",[{name:"mag",newName:"length",target:Qn.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Qn.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Qn.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Qn.prototype,targetName:"Vec4"}]),z(Nn,"Quat",[{name:"mag",newName:"len",target:Nn,targetName:"Quat"},{name:"mul",newName:"multiply",target:Nn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Nn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Nn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Nn,targetName:"Quat"}]),z(Nn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Nn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Nn.prototype,targetName:"Quat"}]),z(En,"Color",[{name:"sub",newName:"subtract",target:En,targetName:"Color"},{name:"mul",newName:"multiply",target:En,targetName:"Color"},{name:"div",newName:"divide",target:En,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:En,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=e[1].toString(16);return c.Color.fromHEX(e[0],i)}}]),z(Mn,"Mat3",[{name:"sub",newName:"subtract",target:Mn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Mn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Mn,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Mn,targetName:"Mat3"}]),z(Mn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Mn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Mn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Mn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Mn.prototype,targetName:"Mat3"}]),z(Hn,"Mat4",[{name:"sub",newName:"subtract",target:Hn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Hn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Hn,targetName:"Mat4"}]),z(Hn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Hn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Hn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Hn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Hn.prototype,targetName:"Mat4"}]);var $n=t("AffineTransform",function(){function t(t,e,n,i,r,o){void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=t,this.b=e,this.c=n,this.d=i,this.tx=r,this.ty=o}return t.identity=function(){return new t},t.clone=function(e){return new t(e.a,e.b,e.c,e.d,e.tx,e.ty)},t.concat=function(t,e,n){var i=e.a,r=e.b,o=e.c,a=e.d,s=e.tx,c=e.ty;t.a=i*n.a+r*n.c,t.b=i*n.b+r*n.d,t.c=o*n.a+a*n.c,t.d=o*n.b+a*n.d,t.tx=s*n.a+c*n.c+n.tx,t.ty=s*n.b+c*n.d+n.ty},t.invert=function(t,e){var n=1/(e.a*e.d-e.b*e.c);t.a=n*e.d,t.b=-n*e.b,t.c=-n*e.c,t.d=n*e.a,t.tx=n*(e.c*e.ty-e.d*e.tx),t.ty=n*(e.b*e.tx-e.a*e.ty)},t.fromMat4=function(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13},t.transformVec2=function(t,e,n,i){var r,o;void 0===i?(i=n,r=e.x,o=e.y):(r=e,o=n),t.x=i.a*r+i.c*o+i.tx,t.y=i.b*r+i.d*o+i.ty},t.transformSize=function(t,e,n){t.width=n.a*e.width+n.c*e.height,t.height=n.b*e.width+n.d*e.height},t.transformRect=function(t,e,n){var i=e.x+e.width,r=e.y+e.height,o=n.a*e.x+n.c*e.y+n.tx,a=n.b*e.x+n.d*e.y+n.ty,s=n.a*i+n.c*e.y+n.tx,c=n.b*i+n.d*e.y+n.ty,l=n.a*e.x+n.c*r+n.tx,u=n.b*e.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(o,s,l,h),d=Math.max(o,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);t.x=f,t.y=p,t.width=d-f,t.height=m-p},t.transformObb=function(t,e,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;e.x=a,e.y=s,n.x=c+a,n.y=l+s,t.x=u+a,t.y=h+s,i.x=c+u+a,i.y=l+h+s},t}());c.AffineTransform=$n;var ti=t("Size",function(t){function e(e,n){var i;return i=t.call(this)||this,e&&"object"==typeof e?(i.width=e.width,i.height=e.height):(i.width=e||0,i.height=n||0),i}Q(e,t),e.lerp=function(t,e,n,i){return t.width=e.width+(n.width-e.width)*i,t.height=e.height+(n.height-e.height)*i,t};var n=e.prototype;return n.clone=function(){return new e(this.width,this.height)},n.set=function(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this},n.equals=function(t){return this.width===t.width&&this.height===t.height},n.lerp=function(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},K(e,[{key:"x",get:function(){return this.width},set:function(t){this.width=t}},{key:"y",get:function(){return this.height},set:function(t){this.height=t}}]),e}(le));function ei(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new ti(t,e)}ti.ZERO=Object.freeze(new ti(0,0)),ti.ONE=Object.freeze(new ti(1,1)),Ze.fastDefine("cc.Size",ti,{width:0,height:0}),c.size=ei,c.Size=ti;var ni=t("Rect",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.y=e.y,o.width=e.width,o.height=e.height,o.x=e.x):(o.x=e||0,o.y=n||0,o.width=i||0,o.height=r||0),o}Q(e,t),e.fromMinMax=function(t,e,n){var i=Math.min(e.x,n.x),r=Math.min(e.y,n.y),o=Math.max(e.x,n.x),a=Math.max(e.y,n.y);return t.x=i,t.y=r,t.width=o-i,t.height=a-r,t},e.lerp=function(t,e,n,i){var r=e.x,o=e.y,a=e.width,s=e.height;return t.x=r+(n.x-r)*i,t.y=o+(n.y-o)*i,t.width=a+(n.width-a)*i,t.height=s+(n.height-s)*i,t},e.intersection=function(t,e,n){var i=e.x,r=e.y,o=e.x+e.width,a=e.y+e.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return t.x=Math.max(i,s),t.y=Math.max(r,c),t.width=Math.min(o,l)-t.x,t.height=Math.min(a,u)-t.y,t},e.union=function(t,e,n){var i=e.x,r=e.y,o=e.width,a=e.height,s=n.x,c=n.y,l=n.width,u=n.height;return t.x=Math.min(i,s),t.y=Math.min(r,c),t.width=Math.max(i+o,s+l)-t.x,t.height=Math.max(r+a,c+u)-t.y,t};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.width,this.height)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=n||0,this.height=i||0),this},n.equals=function(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height},n.lerp=function(t,e){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(t.x-n)*e,this.y=i+(t.y-i)*e,this.width=r+(t.width-r)*e,this.height=o+(t.height-o)*e,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(t){var e=this.x+this.width,n=this.y+this.height,i=t.x+t.width,r=t.y+t.height;return!(e<t.x||i<this.x||n<t.y||r<this.y)},n.contains=function(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y},n.containsRect=function(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height},n.transformMat4=function(t){var e=this.x,n=this.y,i=e+this.width,r=n+this.height,o=t.m00*e+t.m04*n+t.m12,a=t.m01*e+t.m05*n+t.m13,s=t.m00*i+t.m04*n+t.m12,c=t.m01*i+t.m05*n+t.m13,l=t.m00*e+t.m04*r+t.m12,u=t.m01*e+t.m05*r+t.m13,h=t.m00*i+t.m04*r+t.m12,_=t.m01*i+t.m05*r+t.m13,f=Math.min(o,s,l,h),d=Math.max(o,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=p,this.width=d-f,this.height=m-p,this},n.transformMat4ToPoints=function(t,e,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;e.x=t.m00*o+t.m04*a+t.m12,e.y=t.m01*o+t.m05*a+t.m13,r.x=t.m00*s+t.m04*a+t.m12,r.y=t.m01*s+t.m05*a+t.m13,n.x=t.m00*o+t.m04*c+t.m12,n.y=t.m01*o+t.m05*c+t.m13,i.x=t.m00*s+t.m04*c+t.m12,i.y=t.m01*s+t.m05*c+t.m13},K(e,[{key:"xMin",get:function(){return this.x},set:function(t){this.width+=this.x-t,this.x=t}},{key:"yMin",get:function(){return this.y},set:function(t){this.height+=this.y-t,this.y=t}},{key:"xMax",get:function(){return this.x+this.width},set:function(t){this.width=t-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(t){this.height=t-this.y}},{key:"center",get:function(){return new Xn(this.x+.5*this.width,this.y+.5*this.height)},set:function(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}},{key:"origin",get:function(){return new Xn(this.x,this.y)},set:function(t){this.x=t.x,this.y=t.y}},{key:"size",get:function(){return new ti(this.width,this.height)},set:function(t){this.width=t.width,this.height=t.height}},{key:"z",get:function(){return this.width},set:function(t){this.width=t}},{key:"w",get:function(){return this.height},set:function(t){this.height=t}}]),e}(le));function ii(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),new ni(t,e,n,i)}Ze.fastDefine("cc.Rect",ni,{x:0,y:0,width:0,height:0}),c.Rect=ni,c.rect=ii;var ri=t("MATH_FLOAT_ARRAY",Float64Array),oi=t("MathBase",function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.createFloatArray=function(t){return new ri(t)},K(e,[{key:"array",get:function(){return this._array}}]),e}(le)),ai=Object.freeze({__proto__:null,bits:a,Vec2:Xn,v2:Jn,Vec3:Pn,v3:Dn,Vec4:Qn,v4:Zn,Quat:Nn,quat:Gn,Mat3:Mn,Mat4:Hn,mat4:qn,AffineTransform:$n,Size:ti,size:ei,Rect:ni,rect:ii,Color:En,color:wn,EPSILON:rn,equals:on,approx:an,clamp:sn,clamp01:cn,lerp:ln,toRadian:un,toDegree:hn,random:_n,randomRange:fn,randomRangeInt:dn,pseudoRandom:pn,pseudoRandomRange:mn,pseudoRandomRangeInt:vn,nextPow2:gn,repeat:yn,pingPong:xn,inverseLerp:Sn,absMaxComponent:An,absMax:Cn,enumerableProps:bn,MATH_FLOAT_ARRAY:ri,MathBase:oi});t("math",ai);var si,ci,li,ui,hi,_i,fi,di,pi,mi,vi,gi,yi,xi,Si,Ai,Ci,bi,Ti,Ei,wi,Pi,Ii,Ri,Di,Mi,Bi,Oi,Ni,Li,Fi,zi,Vi,ki,Gi,Ui,Hi,ji,Wi,qi,Xi,Yi=function(t,e,n){for(var i=0;i<e.length;++i)t.length<=i&&t.push(new n),t[i].copy(e[i]);t.length=e.length};!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SWAPCHAIN=1]="SWAPCHAIN",t[t.BUFFER=2]="BUFFER",t[t.TEXTURE=3]="TEXTURE",t[t.RENDER_PASS=4]="RENDER_PASS",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.SAMPLER=6]="SAMPLER",t[t.SHADER=7]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=10]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=13]="COMMAND_BUFFER",t[t.QUEUE=14]="QUEUE",t[t.QUERY_POOL=15]="QUERY_POOL",t[t.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=18]="BUFFER_BARRIER",t[t.COUNT=19]="COUNT"}(si||(si={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(ci||(ci={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.WEBGL=5]="WEBGL",t[t.WEBGL2=6]="WEBGL2",t[t.WEBGPU=7]="WEBGPU"}(li||(li={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(ui||(ui={})),function(t){t[t.COLOR_FLOAT=0]="COLOR_FLOAT",t[t.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",t[t.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",t[t.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",t[t.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",t[t.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",t[t.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",t[t.FORMAT_SRGB=7]="FORMAT_SRGB",t[t.FORMAT_ETC1=8]="FORMAT_ETC1",t[t.FORMAT_ETC2=9]="FORMAT_ETC2",t[t.FORMAT_DXT=10]="FORMAT_DXT",t[t.FORMAT_PVRTC=11]="FORMAT_PVRTC",t[t.FORMAT_ASTC=12]="FORMAT_ASTC",t[t.FORMAT_RGB8=13]="FORMAT_RGB8",t[t.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=17]="BLEND_MINMAX",t[t.COMPUTE_SHADER=18]="COMPUTE_SHADER",t[t.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",t[t.COUNT=20]="COUNT"}(hi||(hi={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.DEPTH=54]="DEPTH",t[t.DEPTH_STENCIL=55]="DEPTH_STENCIL",t[t.BC1=56]="BC1",t[t.BC1_ALPHA=57]="BC1_ALPHA",t[t.BC1_SRGB=58]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",t[t.BC2=60]="BC2",t[t.BC2_SRGB=61]="BC2_SRGB",t[t.BC3=62]="BC3",t[t.BC3_SRGB=63]="BC3_SRGB",t[t.BC4=64]="BC4",t[t.BC4_SNORM=65]="BC4_SNORM",t[t.BC5=66]="BC5",t[t.BC5_SNORM=67]="BC5_SNORM",t[t.BC6H_UF16=68]="BC6H_UF16",t[t.BC6H_SF16=69]="BC6H_SF16",t[t.BC7=70]="BC7",t[t.BC7_SRGB=71]="BC7_SRGB",t[t.ETC_RGB8=72]="ETC_RGB8",t[t.ETC2_RGB8=73]="ETC2_RGB8",t[t.ETC2_SRGB8=74]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=77]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",t[t.EAC_R11=79]="EAC_R11",t[t.EAC_R11SN=80]="EAC_R11SN",t[t.EAC_RG11=81]="EAC_RG11",t[t.EAC_RG11SN=82]="EAC_RG11SN",t[t.PVRTC_RGB2=83]="PVRTC_RGB2",t[t.PVRTC_RGBA2=84]="PVRTC_RGBA2",t[t.PVRTC_RGB4=85]="PVRTC_RGB4",t[t.PVRTC_RGBA4=86]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=87]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=88]="PVRTC2_4BPP",t[t.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",t[t.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",t[t.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",t[t.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",t[t.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",t[t.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",t[t.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",t[t.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",t[t.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",t[t.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",t[t.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",t[t.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",t[t.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",t[t.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",t[t.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",t[t.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",t[t.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",t[t.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",t[t.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",t[t.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",t[t.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",t[t.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",t[t.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",t[t.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",t[t.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",t[t.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",t[t.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",t[t.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",t[t.COUNT=117]="COUNT"}(_i||(_i={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(fi||(fi={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(di||(di={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(pi||(pi={})),function(t){t[t.NONE=0]="NONE"}(mi||(mi={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(vi||(vi={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(gi||(gi={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(yi||(yi={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(xi||(xi={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Si||(Si={})),function(t){t[t.ONE=0]="ONE",t[t.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",t[t.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",t[t.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Ai||(Ai={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON",t[t.RELAXED=2]="RELAXED",t[t.MAILBOX=3]="MAILBOX",t[t.HALF=4]="HALF"}(Ci||(Ci={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(bi||(bi={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(Ti||(Ti={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(Ei||(Ei={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(wi||(wi={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Pi||(Pi={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(Ii||(Ii={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(Ri||(Ri={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(Di||(Di={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(Mi||(Mi={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(Bi||(Bi={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=3]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=17]="TRANSFER_READ",t[t.HOST_READ=18]="HOST_READ",t[t.PRESENT=19]="PRESENT",t[t.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=25]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",t[t.HOST_WRITE=27]="HOST_WRITE"}(Oi||(Oi={})),function(t){t[t.NONE=0]="NONE",t[t.SAMPLE_ZERO=1]="SAMPLE_ZERO",t[t.AVERAGE=2]="AVERAGE",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(Ni||(Ni={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(Li||(Li={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Fi||(Fi={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(zi||(zi={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(Vi||(Vi={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(ki||(ki={})),function(t){t[t.NONE=0]="NONE",t[t.LINE_WIDTH=1]="LINE_WIDTH",t[t.DEPTH_BIAS=2]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Gi||(Gi={})),function(t){t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK",t[t.ALL=3]="ALL"}(Ui||(Ui={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Hi||(Hi={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(ji||(ji={})),function(t){t[t.OCCLUSION=0]="OCCLUSION",t[t.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",t[t.TIMESTAMP=2]="TIMESTAMP"}(Wi||(Wi={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(qi||(qi={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(Xi||(Xi={}));var Ki,Ji=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),Qi=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g,y,x,S){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=1),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=new Ji),void 0===v&&(v=new Ji),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=d,this.maxComputeWorkGroupInvocations=p,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return t.prototype.copy=function(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.supportQuery=t.supportQuery,this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this},t}(),Zi=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),$i=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.width=n,this.height=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},t}(),tr=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=1),this.width=t,this.height=e,this.depth=n}return t.prototype.copy=function(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this},t}(),er=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=1),this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=n}return t.prototype.copy=function(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),nr=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=n,this.layerCount=i}return t.prototype.copy=function(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),ir=function(){function t(t,e,n,i,r){void 0===t&&(t=new er),void 0===e&&(e=new Zi),void 0===n&&(n=new er),void 0===i&&(i=new Zi),void 0===r&&(r=new tr),this.srcSubres=t,this.srcOffset=e,this.dstSubres=n,this.dstOffset=i,this.extent=r}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this},t}(),rr=function(){function t(t,e,n,i,r,o){void 0===t&&(t=new er),void 0===e&&(e=new Zi),void 0===n&&(n=new tr),void 0===i&&(i=new er),void 0===r&&(r=new Zi),void 0===o&&(o=new tr),this.srcSubres=t,this.srcOffset=e,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this},t}(),or=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=new Zi),void 0===i&&(i=new tr),void 0===r&&(r=new er),this.buffStride=t,this.buffTexHeight=e,this.texOffset=n,this.texExtent=i,this.texSubres=r}return t.prototype.copy=function(t){return this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this},t}(),ar=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=t,this.top=e,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return t.prototype.copy=function(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this},t}(),sr=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=n,this.w=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t}(),cr=function(){function t(t,e,n){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=0),this.bufferOffsets=t,this.samplerOffsets=e,this.flexibleSet=n}return t.prototype.copy=function(t){return this.bufferOffsets=t.bufferOffsets.slice(),this.samplerOffsets=t.samplerOffsets.slice(),this.flexibleSet=t.flexibleSet,this},t}(),lr=function(){function t(t,e,n,i){void 0===t&&(t=null),void 0===e&&(e=Ci.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=t,this.vsyncMode=e,this.width=n,this.height=i}return t.prototype.copy=function(t){return this.windowHandle=t.windowHandle,this.vsyncMode=t.vsyncMode,this.width=t.width,this.height=t.height,this},t}(),ur=function(){function t(t){void 0===t&&(t=new cr),this.bindingMappingInfo=t}return t.prototype.copy=function(t){return this.bindingMappingInfo.copy(t.bindingMappingInfo),this},t}(),hr=function(){function t(t,e,n,i,r){void 0===t&&(t=pi.NONE),void 0===e&&(e=gi.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=mi.NONE),this.usage=t,this.memUsage=e,this.size=n,this.stride=i,this.flags=r}return t.prototype.copy=function(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this},t}(),_r=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=0),void 0===n&&(n=0),this.buffer=t,this.offset=e,this.range=n}return t.prototype.copy=function(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this},t}(),fr=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=t,this.firstVertex=e,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return t.prototype.copy=function(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this},t}(),dr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=t,this.groupCountY=e,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return t.prototype.copy=function(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this},t}(),pr=function(){function t(t){void 0===t&&(t=[]),this.drawInfos=t}return t.prototype.copy=function(t){return Yi(this.drawInfos,t.drawInfos,fr),this},t}(),mr=function(){function t(t,e,n,i,r,o,a,s,c,l,u){void 0===t&&(t=yi.TEX2D),void 0===e&&(e=xi.NONE),void 0===n&&(n=_i.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=Si.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=Ai.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=t,this.usage=e,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return t.prototype.copy=function(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this.externalRes=t.externalRes,this},t}(),vr=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=null),void 0===e&&(e=yi.TEX2D),void 0===n&&(n=_i.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=t,this.type=e,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return t.prototype.copy=function(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this},t}(),gr=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=bi.LINEAR),void 0===e&&(e=bi.LINEAR),void 0===n&&(n=bi.NONE),void 0===i&&(i=Ti.WRAP),void 0===r&&(r=Ti.WRAP),void 0===o&&(o=Ti.WRAP),void 0===a&&(a=0),void 0===s&&(s=Ei.ALWAYS),this.minFilter=t,this.magFilter=e,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return t.prototype.copy=function(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this},t}(),yr=function(){function t(t,e,n){void 0===t&&(t=""),void 0===e&&(e=di.UNKNOWN),void 0===n&&(n=0),this.name=t,this.type=e,this.count=n}return t.prototype.copy=function(t){return this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),xr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.members=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,Yi(this.members,t.members,yr),this.count=t.count,this},t}(),Sr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=di.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),Ar=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=t,this.binding=e,this.name=n,this.count=i}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),Cr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=di.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),br=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=di.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=vi.READ_WRITE),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Tr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=vi.READ_WRITE),this.set=t,this.binding=e,this.name=n,this.count=i,this.memoryAccess=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Er=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=t,this.binding=e,this.name=n,this.count=i}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),wr=function(){function t(t,e){void 0===t&&(t=Di.NONE),void 0===e&&(e=""),this.stage=t,this.source=e}return t.prototype.copy=function(t){return this.stage=t.stage,this.source=t.source,this},t}(),Pr=function(){function t(t,e,n,i,r,o){void 0===t&&(t=""),void 0===e&&(e=_i.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=t,this.format=e,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return t.prototype.copy=function(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this},t}(),Ir=function(){function t(t,e,n,i,r,o,a,s,c,l){void 0===t&&(t=""),void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=t,this.stages=e,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return t.prototype.copy=function(t){return this.name=t.name,Yi(this.stages,t.stages,wr),Yi(this.attributes,t.attributes,Pr),Yi(this.blocks,t.blocks,xr),Yi(this.buffers,t.buffers,Tr),Yi(this.samplerTextures,t.samplerTextures,Sr),Yi(this.samplers,t.samplers,Ar),Yi(this.textures,t.textures,Cr),Yi(this.images,t.images,br),Yi(this.subpassInputs,t.subpassInputs,Er),this},t}(),Rr=function(){function t(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=t,this.vertexBuffers=e,this.indexBuffer=n,this.indirectBuffer=i}return t.prototype.copy=function(t){return Yi(this.attributes,t.attributes,Pr),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this},t}(),Dr=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=_i.UNKNOWN),void 0===e&&(e=Ai.ONE),void 0===n&&(n=Mi.CLEAR),void 0===i&&(i=Bi.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Oi.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=t,this.sampleCount=e,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Mr=function(){function t(t,e,n,i,r,o,a,s,c){void 0===t&&(t=_i.UNKNOWN),void 0===e&&(e=Ai.ONE),void 0===n&&(n=Mi.CLEAR),void 0===i&&(i=Bi.STORE),void 0===r&&(r=Mi.CLEAR),void 0===o&&(o=Bi.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Oi.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=t,this.sampleCount=e,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Br=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Ni.NONE),void 0===s&&(s=Ni.NONE),this.inputs=t,this.colors=e,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return t.prototype.copy=function(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this.depthStencilResolve=t.depthStencilResolve,this.depthResolveMode=t.depthResolveMode,this.stencilResolveMode=t.stencilResolveMode,this},t}(),Or=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=t,this.dstSubpass=e,this.srcAccesses=n,this.dstAccesses=i}return t.prototype.copy=function(t){return this.srcSubpass=t.srcSubpass,this.dstSubpass=t.dstSubpass,this.srcAccesses=t.srcAccesses.slice(),this.dstAccesses=t.dstAccesses.slice(),this},t}(),Nr=function(){function t(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=new Mr),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=n,this.dependencies=i}return t.prototype.copy=function(t){return Yi(this.colorAttachments,t.colorAttachments,Dr),this.depthStencilAttachment.copy(t.depthStencilAttachment),Yi(this.subpasses,t.subpasses,Br),Yi(this.dependencies,t.dependencies,Or),this},t}(),Lr=function(){function t(t,e){void 0===t&&(t=[]),void 0===e&&(e=[]),this.prevAccesses=t,this.nextAccesses=e}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this},t}(),Fr=function(){function t(t,e,n,i,r){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=t,this.nextAccesses=e,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this},t}(),zr=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=[]),void 0===n&&(n=null),this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=n}return t.prototype.copy=function(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this},t}(),Vr=function(){function t(t,e,n,i,r){void 0===t&&(t=-1),void 0===e&&(e=Hi.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Di.NONE),void 0===r&&(r=[]),this.binding=t,this.descriptorType=e,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return t.prototype.copy=function(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this},t}(),kr=function(){function t(t){void 0===t&&(t=[]),this.bindings=t}return t.prototype.copy=function(t){return Yi(this.bindings,t.bindings,Vr),this},t}(),Gr=function(){function t(t){void 0===t&&(t=null),this.layout=t}return t.prototype.copy=function(t){return this.layout=t.layout,this},t}(),Ur=function(){function t(t){void 0===t&&(t=[]),this.setLayouts=t}return t.prototype.copy=function(t){return this.setLayouts=t.setLayouts.slice(),this},t}(),Hr=function(){function t(t){void 0===t&&(t=[]),this.attributes=t}return t.prototype.copy=function(t){return Yi(this.attributes,t.attributes,Pr),this},t}(),jr=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=qi.PRIMARY),this.queue=t,this.type=e}return t.prototype.copy=function(t){return this.queue=t.queue,this.type=t.type,this},t}(),Wr=function(){function t(t){void 0===t&&(t=ji.GRAPHICS),this.type=t}return t.prototype.copy=function(t){return this.type=t.type,this},t}(),qr=function(){function t(t,e,n){void 0===t&&(t=Wi.OCCLUSION),void 0===e&&(e=65536),void 0===n&&(n=!0),this.type=t,this.maxQueryObjects=e,this.forceWait=n}return t.prototype.copy=function(t){return this.type=t.type,this.maxQueryObjects=t.maxQueryObjects,this.forceWait=t.forceWait,this},t}(),Xr=function(t,e,n,i,r,o,a,s){void 0===t&&(t=""),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=fi.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=t,this.size=e,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},Yr=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.bufferSize=t,this.textureSize=e}return t.prototype.copy=function(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this},t}(),Kr=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.writeMask=t,this.compareMask=e,this.reference=n}return t.prototype.copy=function(t){return this.writeMask=t.writeMask,this.compareMask=t.compareMask,this.reference=t.reference,this},t}(),Jr=function(){function t(t,e,n,i,r,o,a,s,c,l,u){void 0===t&&(t=new ar),void 0===e&&(e=new $i),void 0===n&&(n=new sr),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new Kr),void 0===u&&(u=new Kr),this.viewport=t,this.scissor=e,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return t.prototype.copy=function(t){return this.viewport.copy(t.viewport),this.scissor.copy(t.scissor),this.blendConstant.copy(t.blendConstant),this.lineWidth=t.lineWidth,this.depthBiasConstant=t.depthBiasConstant,this.depthBiasClamp=t.depthBiasClamp,this.depthBiasSlope=t.depthBiasSlope,this.depthMinBounds=t.depthMinBounds,this.depthMaxBounds=t.depthMaxBounds,this.stencilStatesFront.copy(t.stencilStatesFront),this.stencilStatesBack.copy(t.stencilStatesBack),this},t}(),Qr=function(){function t(e){this._objectType=si.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=e,this._objectID=t._idTable[si.UNKNOWN]++,this._typedID=t._idTable[e]++}return K(t,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),t}();Qr._idTable=Array(si.COUNT).fill(65536),function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(Ki||(Ki={}));var Zr=Object.freeze([new Xr("UNKNOWN",0,0,fi.NONE,!1,!1,!1,!1),new Xr("A8",1,1,fi.UNORM,!0,!1,!1,!1),new Xr("L8",1,1,fi.UNORM,!1,!1,!1,!1),new Xr("LA8",1,2,fi.UNORM,!0,!1,!1,!1),new Xr("R8",1,1,fi.UNORM,!1,!1,!1,!1),new Xr("R8SN",1,1,fi.SNORM,!1,!1,!1,!1),new Xr("R8UI",1,1,fi.UINT,!1,!1,!1,!1),new Xr("R8I",1,1,fi.INT,!1,!1,!1,!1),new Xr("R16F",2,1,fi.FLOAT,!1,!1,!1,!1),new Xr("R16UI",2,1,fi.UINT,!1,!1,!1,!1),new Xr("R16I",2,1,fi.INT,!1,!1,!1,!1),new Xr("R32F",4,1,fi.FLOAT,!1,!1,!1,!1),new Xr("R32UI",4,1,fi.UINT,!1,!1,!1,!1),new Xr("R32I",4,1,fi.INT,!1,!1,!1,!1),new Xr("RG8",2,2,fi.UNORM,!1,!1,!1,!1),new Xr("RG8SN",2,2,fi.SNORM,!1,!1,!1,!1),new Xr("RG8UI",2,2,fi.UINT,!1,!1,!1,!1),new Xr("RG8I",2,2,fi.INT,!1,!1,!1,!1),new Xr("RG16F",4,2,fi.FLOAT,!1,!1,!1,!1),new Xr("RG16UI",4,2,fi.UINT,!1,!1,!1,!1),new Xr("RG16I",4,2,fi.INT,!1,!1,!1,!1),new Xr("RG32F",8,2,fi.FLOAT,!1,!1,!1,!1),new Xr("RG32UI",8,2,fi.UINT,!1,!1,!1,!1),new Xr("RG32I",8,2,fi.INT,!1,!1,!1,!1),new Xr("RGB8",3,3,fi.UNORM,!1,!1,!1,!1),new Xr("SRGB8",3,3,fi.UNORM,!1,!1,!1,!1),new Xr("RGB8SN",3,3,fi.SNORM,!1,!1,!1,!1),new Xr("RGB8UI",3,3,fi.UINT,!1,!1,!1,!1),new Xr("RGB8I",3,3,fi.INT,!1,!1,!1,!1),new Xr("RGB16F",6,3,fi.FLOAT,!1,!1,!1,!1),new Xr("RGB16UI",6,3,fi.UINT,!1,!1,!1,!1),new Xr("RGB16I",6,3,fi.INT,!1,!1,!1,!1),new Xr("RGB32F",12,3,fi.FLOAT,!1,!1,!1,!1),new Xr("RGB32UI",12,3,fi.UINT,!1,!1,!1,!1),new Xr("RGB32I",12,3,fi.INT,!1,!1,!1,!1),new Xr("RGBA8",4,4,fi.UNORM,!0,!1,!1,!1),new Xr("BGRA8",4,4,fi.UNORM,!0,!1,!1,!1),new Xr("SRGB8_A8",4,4,fi.UNORM,!0,!1,!1,!1),new Xr("RGBA8SN",4,4,fi.SNORM,!0,!1,!1,!1),new Xr("RGBA8UI",4,4,fi.UINT,!0,!1,!1,!1),new Xr("RGBA8I",4,4,fi.INT,!0,!1,!1,!1),new Xr("RGBA16F",8,4,fi.FLOAT,!0,!1,!1,!1),new Xr("RGBA16UI",8,4,fi.UINT,!0,!1,!1,!1),new Xr("RGBA16I",8,4,fi.INT,!0,!1,!1,!1),new Xr("RGBA32F",16,4,fi.FLOAT,!0,!1,!1,!1),new Xr("RGBA32UI",16,4,fi.UINT,!0,!1,!1,!1),new Xr("RGBA32I",16,4,fi.INT,!0,!1,!1,!1),new Xr("R5G6B5",2,3,fi.UNORM,!1,!1,!1,!1),new Xr("R11G11B10F",4,3,fi.FLOAT,!1,!1,!1,!1),new Xr("RGB5A1",2,4,fi.UNORM,!0,!1,!1,!1),new Xr("RGBA4",2,4,fi.UNORM,!0,!1,!1,!1),new Xr("RGB10A2",2,4,fi.UNORM,!0,!1,!1,!1),new Xr("RGB10A2UI",2,4,fi.UINT,!0,!1,!1,!1),new Xr("RGB9E5",2,4,fi.FLOAT,!0,!1,!1,!1),new Xr("DEPTH",4,1,fi.FLOAT,!1,!0,!1,!1),new Xr("DEPTH_STENCIL",5,2,fi.FLOAT,!1,!0,!0,!1),new Xr("BC1",1,3,fi.UNORM,!1,!1,!1,!0),new Xr("BC1_ALPHA",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("BC1_SRGB",1,3,fi.UNORM,!1,!1,!1,!0),new Xr("BC1_SRGB_ALPHA",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("BC2",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("BC2_SRGB",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("BC3",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("BC3_SRGB",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("BC4",1,1,fi.UNORM,!1,!1,!1,!0),new Xr("BC4_SNORM",1,1,fi.SNORM,!1,!1,!1,!0),new Xr("BC5",1,2,fi.UNORM,!1,!1,!1,!0),new Xr("BC5_SNORM",1,2,fi.SNORM,!1,!1,!1,!0),new Xr("BC6H_UF16",1,3,fi.UFLOAT,!1,!1,!1,!0),new Xr("BC6H_SF16",1,3,fi.FLOAT,!1,!1,!1,!0),new Xr("BC7",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("BC7_SRGB",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ETC_RGB8",1,3,fi.UNORM,!1,!1,!1,!0),new Xr("ETC2_RGB8",1,3,fi.UNORM,!1,!1,!1,!0),new Xr("ETC2_SRGB8",1,3,fi.UNORM,!1,!1,!1,!0),new Xr("ETC2_RGB8_A1",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ETC2_SRGB8_A1",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ETC2_RGBA8",2,4,fi.UNORM,!0,!1,!1,!0),new Xr("ETC2_SRGB8_A8",2,4,fi.UNORM,!0,!1,!1,!0),new Xr("EAC_R11",1,1,fi.UNORM,!1,!1,!1,!0),new Xr("EAC_R11SN",1,1,fi.SNORM,!1,!1,!1,!0),new Xr("EAC_RG11",2,2,fi.UNORM,!1,!1,!1,!0),new Xr("EAC_RG11SN",2,2,fi.SNORM,!1,!1,!1,!0),new Xr("PVRTC_RGB2",2,3,fi.UNORM,!1,!1,!1,!0),new Xr("PVRTC_RGBA2",2,4,fi.UNORM,!0,!1,!1,!0),new Xr("PVRTC_RGB4",2,3,fi.UNORM,!1,!1,!1,!0),new Xr("PVRTC_RGBA4",2,4,fi.UNORM,!0,!1,!1,!0),new Xr("PVRTC2_2BPP",2,4,fi.UNORM,!0,!1,!1,!0),new Xr("PVRTC2_4BPP",2,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_4x4",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_5x4",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_5x5",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_6x5",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_6x6",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_8x5",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_8x6",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_8x8",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x5",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x6",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x8",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x10",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_12x10",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_12x12",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_4x4",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_5x4",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_5x5",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_6x5",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_6x6",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_8x5",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_8x6",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_8x8",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x5",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x6",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x8",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x10",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_12x10",1,4,fi.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_12x12",1,4,fi.UNORM,!0,!1,!1,!0)]),$r=Hi.UNIFORM_BUFFER|Hi.DYNAMIC_UNIFORM_BUFFER|Hi.STORAGE_BUFFER|Hi.DYNAMIC_STORAGE_BUFFER,to=Hi.SAMPLER_TEXTURE|Hi.SAMPLER|Hi.TEXTURE|Hi.STORAGE_IMAGE|Hi.INPUT_ATTACHMENT,eo=Hi.DYNAMIC_STORAGE_BUFFER|Hi.DYNAMIC_UNIFORM_BUFFER;function no(t){return t>0&&0==(t&t-1)}function io(t,e,n,i){if(!Zr[t].isCompressed)return e*n*i*Zr[t].size;switch(t){case _i.BC1:case _i.BC1_ALPHA:case _i.BC1_SRGB:case _i.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case _i.BC2:case _i.BC2_SRGB:case _i.BC3:case _i.BC3_SRGB:case _i.BC4:case _i.BC4_SNORM:case _i.BC6H_SF16:case _i.BC6H_UF16:case _i.BC7:case _i.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case _i.BC5:case _i.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(n/4)*32*i;case _i.ETC_RGB8:case _i.ETC2_RGB8:case _i.ETC2_SRGB8:case _i.ETC2_RGB8_A1:case _i.EAC_R11:case _i.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case _i.ETC2_RGBA8:case _i.ETC2_SRGB8_A1:case _i.EAC_RG11:case _i.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case _i.PVRTC_RGB2:case _i.PVRTC_RGBA2:case _i.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(n,8)/4)*i;case _i.PVRTC_RGB4:case _i.PVRTC_RGBA4:case _i.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(n,8)/2)*i;case _i.ASTC_RGBA_4X4:case _i.ASTC_SRGBA_4X4:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case _i.ASTC_RGBA_5X4:case _i.ASTC_SRGBA_5X4:return Math.ceil(e/5)*Math.ceil(n/4)*16*i;case _i.ASTC_RGBA_5X5:case _i.ASTC_SRGBA_5X5:return Math.ceil(e/5)*Math.ceil(n/5)*16*i;case _i.ASTC_RGBA_6X5:case _i.ASTC_SRGBA_6X5:return Math.ceil(e/6)*Math.ceil(n/5)*16*i;case _i.ASTC_RGBA_6X6:case _i.ASTC_SRGBA_6X6:return Math.ceil(e/6)*Math.ceil(n/6)*16*i;case _i.ASTC_RGBA_8X5:case _i.ASTC_SRGBA_8X5:return Math.ceil(e/8)*Math.ceil(n/5)*16*i;case _i.ASTC_RGBA_8X6:case _i.ASTC_SRGBA_8X6:return Math.ceil(e/8)*Math.ceil(n/6)*16*i;case _i.ASTC_RGBA_8X8:case _i.ASTC_SRGBA_8X8:return Math.ceil(e/8)*Math.ceil(n/8)*16*i;case _i.ASTC_RGBA_10X5:case _i.ASTC_SRGBA_10X5:return Math.ceil(e/10)*Math.ceil(n/5)*16*i;case _i.ASTC_RGBA_10X6:case _i.ASTC_SRGBA_10X6:return Math.ceil(e/10)*Math.ceil(n/6)*16*i;case _i.ASTC_RGBA_10X8:case _i.ASTC_SRGBA_10X8:return Math.ceil(e/10)*Math.ceil(n/8)*16*i;case _i.ASTC_RGBA_10X10:case _i.ASTC_SRGBA_10X10:return Math.ceil(e/10)*Math.ceil(n/10)*16*i;case _i.ASTC_RGBA_12X10:case _i.ASTC_SRGBA_12X10:return Math.ceil(e/12)*Math.ceil(n/10)*16*i;case _i.ASTC_RGBA_12X12:case _i.ASTC_SRGBA_12X12:return Math.ceil(e/12)*Math.ceil(n/12)*16*i;default:return 0}}function ro(t,e,n,i,r){for(var o=0,a=0;a<r;++a)o+=io(t,e,n,i),e=Math.max(e>>1,1),n=Math.max(n>>1,1);return o}var oo=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function ao(t){return oo[t]||0}function so(t){var e=t.size/t.count;switch(t.type){case fi.UNORM:case fi.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case fi.SNORM:case fi.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case fi.FLOAT:return Float32Array}return Float32Array}var co=Object.freeze({__proto__:null,get ObjectType(){return si},get Status(){return ci},get API(){return li},get SurfaceTransform(){return ui},get Feature(){return hi},get Format(){return _i},get FormatType(){return fi},get Type(){return di},get BufferUsageBit(){return pi},get BufferFlagBit(){return mi},get MemoryAccessBit(){return vi},get MemoryUsageBit(){return gi},get TextureType(){return yi},get TextureUsageBit(){return xi},get TextureFlagBit(){return Si},get SampleCount(){return Ai},get VsyncMode(){return Ci},get Filter(){return bi},get Address(){return Ti},get ComparisonFunc(){return Ei},get StencilOp(){return wi},get BlendFactor(){return Pi},get BlendOp(){return Ii},get ColorMask(){return Ri},get ShaderStageFlagBit(){return Di},get LoadOp(){return Mi},get StoreOp(){return Bi},get AccessType(){return Oi},get ResolveMode(){return Ni},get PipelineBindPoint(){return Li},get PrimitiveMode(){return Fi},get PolygonMode(){return zi},get ShadeModel(){return Vi},get CullMode(){return ki},get DynamicStateFlagBit(){return Gi},get StencilFace(){return Ui},get DescriptorType(){return Hi},get QueueType(){return ji},get QueryType(){return Wi},get CommandBufferType(){return qi},get ClearFlagBit(){return Xi},Size:Ji,DeviceCaps:Qi,Offset:Zi,Rect:$i,Extent:tr,TextureSubresLayers:er,TextureSubresRange:nr,TextureCopy:ir,TextureBlit:rr,BufferTextureCopy:or,Viewport:ar,Color:sr,BindingMappingInfo:cr,SwapchainInfo:lr,DeviceInfo:ur,BufferInfo:hr,BufferViewInfo:_r,DrawInfo:fr,DispatchInfo:dr,IndirectBuffer:pr,TextureInfo:mr,TextureViewInfo:vr,SamplerInfo:gr,Uniform:yr,UniformBlock:xr,UniformSamplerTexture:Sr,UniformSampler:Ar,UniformTexture:Cr,UniformStorageImage:br,UniformStorageBuffer:Tr,UniformInputAttachment:Er,ShaderStage:wr,Attribute:Pr,ShaderInfo:Ir,InputAssemblerInfo:Rr,ColorAttachment:Dr,DepthStencilAttachment:Mr,SubpassInfo:Br,SubpassDependency:Or,RenderPassInfo:Nr,GlobalBarrierInfo:Lr,TextureBarrierInfo:Fr,FramebufferInfo:zr,DescriptorSetLayoutBinding:Vr,DescriptorSetLayoutInfo:kr,DescriptorSetInfo:Gr,PipelineLayoutInfo:Ur,InputState:Hr,CommandBufferInfo:jr,QueueInfo:Wr,QueryPoolInfo:qr,FormatInfo:Xr,MemoryStatus:Yr,DynamicStencilStates:Kr,DynamicStates:Jr,GFXObject:Qr,get AttributeName(){return Ki},FormatInfos:Zr,DESCRIPTOR_BUFFER_TYPE:$r,DESCRIPTOR_SAMPLER_TYPE:to,DESCRIPTOR_DYNAMIC_TYPE:eo,DRAW_INFO_SIZE:28,IsPowerOf2:no,FormatSize:io,FormatSurfaceSize:ro,GetTypeSize:ao,getTypedArrayConstructor:so}),lo=function(t){function e(){var e;return(e=t.call(this,si.BUFFER)||this)._usage=pi.NONE,e._memUsage=gi.NONE,e._size=0,e._stride=1,e._count=0,e._flags=mi.NONE,e._isBufferView=!1,e}return Q(e,t),K(e,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),e}(Qr),uo=function(t){function e(){var e;return(e=t.call(this,si.COMMAND_BUFFER)||this)._queue=null,e._type=qi.PRIMARY,e._numDrawCalls=0,e._numInstances=0,e._numTris=0,e}return Q(e,t),K(e,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),e}(Qr),ho=function(){function t(){this._gfxAPI=li.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(hi.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Yr,this._caps=new Qi,this._bindingMappingInfo=new cr,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return t.prototype.hasFeature=function(t){return this._features[t]},K(t,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),t}();ho.canvas=void 0;var _o=function(t){function e(){var e;return(e=t.call(this,si.SWAPCHAIN)||this)._transform=ui.IDENTITY,e._colorTexture=null,e._depthStencilTexture=null,e}return Q(e,t),K(e,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),e}(Qr),fo=function(t){function e(){var e;return(e=t.call(this,si.FRAMEBUFFER)||this)._renderPass=null,e._colorTextures=[],e._depthStencilTexture=null,e}return Q(e,t),K(e,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),e}(Qr),po=String.prototype.charCodeAt;function mo(t){return this[t]}function vo(t,e){for(var n=t.length,i=e^n,r=0,o="string"==typeof t?po:mo;n>=4;){var a=255&o.call(t,r)|(255&o.call(t,++r))<<8|(255&o.call(t,++r))<<16|(255&o.call(t,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(t,r+2))<<16;case 2:i^=(255&o.call(t,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(t,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var go=function(t){function e(){var e;return(e=t.call(this,si.INPUT_ASSEMBLER)||this)._attributes=[],e._attributesHash=0,e._vertexBuffers=[],e._indexBuffer=null,e._indirectBuffer=null,e._drawInfo=new fr,e}Q(e,t);var n=e.prototype;return n.getVertexBuffer=function(t){return void 0===t&&(t=0),t<this._vertexBuffers.length?this._vertexBuffers[t]:null},n.computeAttributesHash=function(){for(var t="attrs",e=0;e<this.attributes.length;++e){var n=this.attributes[e];t+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return vo(t,666)},K(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(t){this._drawInfo.vertexCount=t}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(t){this._drawInfo.firstVertex=t}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(t){this._drawInfo.indexCount=t}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(t){this._drawInfo.firstIndex=t}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(t){this._drawInfo.vertexOffset=t}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(t){this._drawInfo.instanceCount=t}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(t){this._drawInfo.firstInstance=t}},{key:"drawInfo",get:function(){return this._drawInfo}}]),e}(Qr),yo=function(t){function e(){var e;return(e=t.call(this,si.DESCRIPTOR_SET)||this)._layout=null,e._buffers=[],e._textures=[],e._samplers=[],e._isDirty=!1,e}Q(e,t);var n=e.prototype;return n.bindBuffer=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&$r){var o=this._layout.descriptorIndices[t];this._buffers[o+n]!==e&&(this._buffers[o+n]=e,this._isDirty=!0)}},n.bindSampler=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&to){var o=this._layout.descriptorIndices[t];this._samplers[o+n]!==e&&(this._samplers[o+n]=e,this._isDirty=!0)}},n.bindTexture=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&to){var o=this._layout.descriptorIndices[t];this._textures[o+n]!==e&&(this._textures[o+n]=e,this._isDirty=!0)}},n.getBuffer=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._buffers[n+e]},n.getSampler=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._samplers[n+e]},n.getTexture=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._textures[n+e]},K(e,[{key:"layout",get:function(){return this._layout}}]),e}(Qr),xo=function(t){function e(){var e;return(e=t.call(this,si.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],e._bindingIndices=[],e._descriptorIndices=[],e}return Q(e,t),K(e,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),e}(Qr),So=function(t){function e(){var e;return(e=t.call(this,si.PIPELINE_LAYOUT)||this)._setLayouts=[],e}return Q(e,t),K(e,[{key:"setLayouts",get:function(){return this._setLayouts}}]),e}(Qr),Ao=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h){void 0===t&&(t=!1),void 0===e&&(e=zi.FILL),void 0===n&&(n=Vi.GOURAND),void 0===i&&(i=ki.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=t,this.polygonMode=e,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var e=t.prototype;return e.reset=function(){this.isDiscard=!1,this.polygonMode=zi.FILL,this.shadeModel=Vi.GOURAND,this.cullMode=ki.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},K(t,[{key:"native",get:function(){return this}}]),t}(),Co=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g){void 0===t&&(t=!0),void 0===e&&(e=!0),void 0===n&&(n=Ei.LESS),void 0===i&&(i=!1),void 0===r&&(r=Ei.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=wi.KEEP),void 0===c&&(c=wi.KEEP),void 0===l&&(l=wi.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=Ei.ALWAYS),void 0===f&&(f=65535),void 0===d&&(d=65535),void 0===p&&(p=wi.KEEP),void 0===m&&(m=wi.KEEP),void 0===v&&(v=wi.KEEP),void 0===g&&(g=1),this.depthTest=t,this.depthWrite=e,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=d,this.stencilFailOpBack=p,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var e=t.prototype;return e.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Ei.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Ei.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=wi.KEEP,this.stencilZFailOpFront=wi.KEEP,this.stencilPassOpFront=wi.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Ei.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=wi.KEEP,this.stencilZFailOpBack=wi.KEEP,this.stencilPassOpBack=wi.KEEP,this.stencilRefBack=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},K(t,[{key:"native",get:function(){return this}}]),t}(),bo=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=!1),void 0===e&&(e=Pi.ONE),void 0===n&&(n=Pi.ZERO),void 0===i&&(i=Ii.ADD),void 0===r&&(r=Pi.ONE),void 0===o&&(o=Pi.ZERO),void 0===a&&(a=Ii.ADD),void 0===s&&(s=Ri.ALL),this.blend=t,this.blendSrc=e,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var e=t.prototype;return e.reset=function(){this.blend=!1,this.blendSrc=Pi.ONE,this.blendDst=Pi.ZERO,this.blendEq=Ii.ADD,this.blendSrcAlpha=Pi.ONE,this.blendDstAlpha=Pi.ZERO,this.blendAlphaEq=Ii.ADD,this.blendColorMask=Ri.ALL},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},t}(),To=function(){function t(t,e,n,i){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===n&&(n=new sr),void 0===i&&(i=[new bo]),this.isA2C=t,this.isIndepend=e,this.blendColor=n,this.targets=i}var e=t.prototype;return e.setTarget=function(t,e){var n=this.targets[t];n||(n=this.targets[t]=new bo),Object.assign(n,e)},e.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},e.destroy=function(){},K(t,[{key:"native",get:function(){return this}}]),t}(),Eo=function(t,e,n,i,r,o,a,s,c,l){void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null),void 0===i&&(i=new Hr),void 0===r&&(r=new Ao),void 0===o&&(o=new Co),void 0===a&&(a=new To),void 0===s&&(s=Fi.TRIANGLE_LIST),void 0===c&&(c=Gi.NONE),void 0===l&&(l=Li.GRAPHICS),this.shader=t,this.pipelineLayout=e,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},wo=function(t){function e(){var e;return(e=t.call(this,si.PIPELINE_STATE)||this)._shader=null,e._pipelineLayout=null,e._primitive=Fi.TRIANGLE_LIST,e._is=null,e._rs=new Ao,e._dss=new Co,e._bs=new To,e._dynamicStates=Gi.NONE,e._renderPass=null,e}return Q(e,t),K(e,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),e}(Qr),Po=function(t){function e(){var e;return(e=t.call(this,si.QUEUE)||this)._type=ji.GRAPHICS,e}return Q(e,t),K(e,[{key:"type",get:function(){return this._type}}]),e}(Qr),Io=function(t){function e(){var e;return(e=t.call(this,si.RENDER_PASS)||this)._colorInfos=[],e._depthStencilInfo=null,e._subpasses=[],e._hash=0,e}return Q(e,t),e.prototype.computeHash=function(){var t="";if(this._subpasses.length)for(var e=0;e<this._subpasses.length;++e){var n=this._subpasses[e];if(n.inputs.length){t+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];t+=","+r.format+","+r.sampleCount}}if(n.colors.length){t+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];t+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];t+="ds,"+s.format+","+s.sampleCount}}else{t+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];t+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(t+="ds,"+u.format+","+u.sampleCount)}return vo(t,666)},K(e,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),e}(Qr),Ro=function(t){function e(e,n){var i;return(i=t.call(this,si.SAMPLER)||this)._info=new gr,i._hash=0,i._info.copy(e),i._hash=n,i}return Q(e,t),e.computeHash=function(t){var e=t.minFilter;return e|=t.magFilter<<2,e|=t.mipFilter<<4,e|=t.addressU<<6,e|=t.addressV<<8,e|=t.addressW<<10,(e|=t.maxAnisotropy<<12)|t.cmpFunc<<16},e.unpackFromHash=function(t){var e=new gr;return e.minFilter=(3&t)>>0,e.magFilter=(3&t)>>2,e.mipFilter=(3&t)>>4,e.addressU=(3&t)>>6,e.addressV=(3&t)>>8,e.addressW=(3&t)>>10,e.maxAnisotropy=(15&t)>>12,e.cmpFunc=(7&t)>>16,e},K(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Qr),Do=function(t){function e(){var e;return(e=t.call(this,si.SHADER)||this)._name="",e._stages=[],e._attributes=[],e._blocks=[],e._samplers=[],e}return Q(e,t),K(e,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),e}(Qr),Mo=function(t){function e(){var e;return(e=t.call(this,si.TEXTURE)||this)._type=yi.TEX2D,e._usage=xi.NONE,e._format=_i.UNKNOWN,e._width=0,e._height=0,e._depth=1,e._layerCount=1,e._levelCount=1,e._samples=Ai.ONE,e._flags=Si.NONE,e._isPowerOf2=!1,e._size=0,e}return Q(e,t),K(e,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),e}(Qr),Bo=function(t){function e(e,n){var i;return(i=t.call(this,si.GLOBAL_BARRIER)||this)._info=new Lr,i._hash=0,i._info.copy(e),i._hash=n,i}return Q(e,t),e.computeHash=function(t){for(var e="prev:",n=0;n<t.prevAccesses.length;++n)e+=" "+t.prevAccesses[n];e+="next:";for(var i=0;i<t.nextAccesses.length;++i)e+=" "+t.nextAccesses[i];return vo(e,666)},K(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Qr),Oo=function(t){function e(e,n){var i;return(i=t.call(this,si.TEXTURE_BARRIER)||this)._info=new Fr,i._hash=0,i._info.copy(e),i._hash=n,i}return Q(e,t),e.computeHash=function(t){for(var e="prev:",n=0;n<t.prevAccesses.length;++n)e+=" "+t.prevAccesses[n];e+="next:";for(var i=0;i<t.nextAccesses.length;++i)e+=" "+t.nextAccesses[i];return e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,vo(e+=t.dstQueue?t.dstQueue.type:0,666)},K(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Qr),No={Device:ho,Swapchain:_o,Buffer:lo,Texture:Mo,Sampler:Ro,Shader:Do,InputAssembler:go,RenderPass:Io,Framebuffer:fo,DescriptorSet:yo,DescriptorSetLayout:xo,PipelineLayout:So,PipelineState:wo,CommandBuffer:uo,Queue:Po,GlobalBarrier:Bo,TextureBarrier:Oo,RasterizerState:Ao,BlendState:To,BlendTarget:bo,DepthStencilState:Co,PipelineStateInfo:Eo};Object.assign(No,co),c.gfx=No;var Lo={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var Fo in c.gfx)if("__esModule"!==Fo){var zo=Lo[Fo];""===zo?zo=Fo:void 0===zo&&(zo="GFX"+Fo),z(c,"cc",[{name:zo,newName:Fo,target:c.gfx,targetName:"cc.gfx"}])}t("gfx",Object.freeze({__proto__:null,DescriptorSet:yo,Buffer:lo,CommandBuffer:uo,get ObjectType(){return si},get Status(){return ci},get API(){return li},get SurfaceTransform(){return ui},get Feature(){return hi},get Format(){return _i},get FormatType(){return fi},get Type(){return di},get BufferUsageBit(){return pi},get BufferFlagBit(){return mi},get MemoryAccessBit(){return vi},get MemoryUsageBit(){return gi},get TextureType(){return yi},get TextureUsageBit(){return xi},get TextureFlagBit(){return Si},get SampleCount(){return Ai},get VsyncMode(){return Ci},get Filter(){return bi},get Address(){return Ti},get ComparisonFunc(){return Ei},get StencilOp(){return wi},get BlendFactor(){return Pi},get BlendOp(){return Ii},get ColorMask(){return Ri},get ShaderStageFlagBit(){return Di},get LoadOp(){return Mi},get StoreOp(){return Bi},get AccessType(){return Oi},get ResolveMode(){return Ni},get PipelineBindPoint(){return Li},get PrimitiveMode(){return Fi},get PolygonMode(){return zi},get ShadeModel(){return Vi},get CullMode(){return ki},get DynamicStateFlagBit(){return Gi},get StencilFace(){return Ui},get DescriptorType(){return Hi},get QueueType(){return ji},get QueryType(){return Wi},get CommandBufferType(){return qi},get ClearFlagBit(){return Xi},Size:Ji,DeviceCaps:Qi,Offset:Zi,Rect:$i,Extent:tr,TextureSubresLayers:er,TextureSubresRange:nr,TextureCopy:ir,TextureBlit:rr,BufferTextureCopy:or,Viewport:ar,Color:sr,BindingMappingInfo:cr,SwapchainInfo:lr,DeviceInfo:ur,BufferInfo:hr,BufferViewInfo:_r,DrawInfo:fr,DispatchInfo:dr,IndirectBuffer:pr,TextureInfo:mr,TextureViewInfo:vr,SamplerInfo:gr,Uniform:yr,UniformBlock:xr,UniformSamplerTexture:Sr,UniformSampler:Ar,UniformTexture:Cr,UniformStorageImage:br,UniformStorageBuffer:Tr,UniformInputAttachment:Er,ShaderStage:wr,Attribute:Pr,ShaderInfo:Ir,InputAssemblerInfo:Rr,ColorAttachment:Dr,DepthStencilAttachment:Mr,SubpassInfo:Br,SubpassDependency:Or,RenderPassInfo:Nr,GlobalBarrierInfo:Lr,TextureBarrierInfo:Fr,FramebufferInfo:zr,DescriptorSetLayoutBinding:Vr,DescriptorSetLayoutInfo:kr,DescriptorSetInfo:Gr,PipelineLayoutInfo:Ur,InputState:Hr,CommandBufferInfo:jr,QueueInfo:Wr,QueryPoolInfo:qr,FormatInfo:Xr,MemoryStatus:Yr,DynamicStencilStates:Kr,DynamicStates:Jr,GFXObject:Qr,get AttributeName(){return Ki},FormatInfos:Zr,DESCRIPTOR_BUFFER_TYPE:$r,DESCRIPTOR_SAMPLER_TYPE:to,DESCRIPTOR_DYNAMIC_TYPE:eo,DRAW_INFO_SIZE:28,IsPowerOf2:no,FormatSize:io,FormatSurfaceSize:ro,GetTypeSize:ao,getTypedArrayConstructor:so,Device:ho,Swapchain:_o,Framebuffer:fo,InputAssembler:go,DescriptorSetLayout:xo,PipelineLayout:So,RasterizerState:Ao,DepthStencilState:Co,BlendTarget:bo,BlendState:To,PipelineStateInfo:Eo,PipelineState:wo,Queue:Po,RenderPass:Io,Sampler:Ro,Shader:Do,Texture:Mo,GlobalBarrier:Bo,TextureBarrier:Oo}));var Vo=new Pn,ko=new Pn,Go=new Pn,Uo=new Pn,Ho=new Pn,jo=new Pn,Wo=new Array(3),qo=new Array(3);function Xo(t,e){return Pn.dot(e.n,t)-e.d}function Yo(t,e,n){return Pn.copy(t,e),Pn.subtract(Ho,n.center,n.halfExtents),Pn.add(jo,n.center,n.halfExtents),t.x=t.x<Ho.x?Ho.x:t.x,t.y=t.y<Ho.y?Ho.y:t.y,t.z=t.z<Ho.z?Ho.z:t.z,t.x=t.x>jo.x?jo.x:t.x,t.y=t.y>jo.y?jo.y:t.y,t.z=t.z>jo.z?jo.z:t.z,t}function Ko(t,e,n){Pn.set(Vo,n.orientation.m00,n.orientation.m01,n.orientation.m02),Pn.set(ko,n.orientation.m03,n.orientation.m04,n.orientation.m05),Pn.set(Go,n.orientation.m06,n.orientation.m07,n.orientation.m08),Wo[0]=Vo,Wo[1]=ko,Wo[2]=Go,qo[0]=n.halfExtents.x,qo[1]=n.halfExtents.y,qo[2]=n.halfExtents.z,Pn.subtract(Uo,e,n.center),Pn.set(t,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=Pn.dot(Uo,Wo[i]);r>qo[i]&&(r=qo[i]),r<-qo[i]&&(r=-qo[i]),t.x+=r*Wo[i].x,t.y+=r*Wo[i].y,t.z+=r*Wo[i].z}return t}var Jo=Object.freeze({__proto__:null,point_plane:Xo,pt_point_plane:function(t,e,n){var i=Xo(e,n);return Pn.subtract(t,e,Pn.multiplyScalar(t,n.n,i))},pt_point_aabb:Yo,pt_point_obb:Ko,pt_point_line:function(t,e,n,i){Pn.subtract(Vo,n,i);var r=Vo,o=Pn.lengthSqr(r);if(0==o)Pn.copy(t,n);else{Pn.subtract(Vo,e,n);var a=Pn.dot(Vo,r)/o;a<0?Pn.copy(t,n):a>1?Pn.copy(t,i):Pn.scaleAndAdd(t,n,r,a)}}}),Qo={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},Zo=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Qo.SHAPE_LINE,this.s=new Pn(t,e,n),this.e=new Pn(i,r,o)}return t.create=function(e,n,i,r,o,a){return new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)},t.copy=function(t,e){return Pn.copy(t.s,e.s),Pn.copy(t.e,e.e),t},t.fromPoints=function(t,e,n){return Pn.copy(t.s,e),Pn.copy(t.e,n),t},t.set=function(t,e,n,i,r,o,a){return t.s.x=e,t.s.y=n,t.s.z=i,t.e.x=r,t.e.y=o,t.e.z=a,t},t.len=function(t){return Pn.distance(t.s,t.e)},t.prototype.length=function(){return Pn.distance(this.s,this.e)},K(t,[{key:"type",get:function(){return this._type}}]),t}(),$o=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Qo.SHAPE_RAY,this.o=new Pn(t,e,n),this.d=new Pn(i,r,o)}return t.create=function(e,n,i,r,o,a){return void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)},t.copy=function(t,e){return Pn.copy(t.o,e.o),Pn.copy(t.d,e.d),t},t.fromPoints=function(t,e,n){return Pn.copy(t.o,e),Pn.normalize(t.d,Pn.subtract(t.d,n,e)),t},t.set=function(t,e,n,i,r,o,a){return t.o.x=e,t.o.y=n,t.o.z=i,t.d.x=r,t.d.y=o,t.d.z=a,t},t.prototype.computeHit=function(t,e){Pn.normalize(t,this.d),Pn.scaleAndAdd(t,this.o,t,e)},K(t,[{key:"type",get:function(){return this._type}}]),t}(),ta=new Pn,ea=new Pn,na=new Pn,ia=new Pn;function ra(t){return Math.max(Math.max(t.x,t.y),t.z)}var oa,aa=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new Pn(0,0,0),this._radius=0,this._type=void 0,this._type=Qo.SHAPE_SPHERE,this._center=new Pn(t,e,n),this._radius=i}t.create=function(e,n,i,r){return new t(e,n,i,r)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.radius)},t.copy=function(t,e){return Pn.copy(t.center,e.center),t.radius=e.radius,t},t.fromPoints=function(t,e,n){return Pn.multiplyScalar(t.center,Pn.add(ta,e,n),.5),t.radius=.5*Pn.subtract(ta,n,e).length(),t},t.set=function(t,e,n,i,r){return t.center.x=e,t.center.y=n,t.center.z=i,t.radius=r,t};var e=t.prototype;return e.destroy=function(){},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.getBoundary=function(t,e){Pn.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Pn.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},e.transform=function(t,e,n,i,r){Pn.transformMat4(r.center,this.center,t),r.radius=this.radius*ra(i)},e.translateAndRotate=function(t,e,n){Pn.transformMat4(n.center,this.center,t)},e.setScale=function(t,e){e.radius=this.radius*ra(t)},e.mergePoint=function(t){this.radius<0&&(this.center.set(t),this.radius=0),Pn.subtract(ea,t,this.center);var e=ea.length();if(e>this.radius){var n=.5*(e-this.radius);this.radius+=n,Pn.multiplyScalar(ea,ea,n/e),Pn.add(this.center,this.center,ea)}},e.mergePoints=function(t){var e=t.length;if(!(e<1)){this.radius=-1;for(var n=0;n<e;n++)this.mergePoint(t[n])}},e.mergeAABB=function(t){t.getBoundary(na,ia),this.mergePoint(na),this.mergePoint(ia)},K(t,[{key:"center",get:function(){return this._center},set:function(t){this._center=t}},{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t}},{key:"type",get:function(){return this._type}}]),t}(),sa=function(){function t(t,e,n,i,r,o,a,s,c){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Qo.SHAPE_TRIANGLE,this.a=new Pn(t,e,n),this.b=new Pn(i,r,o),this.c=new Pn(a,s,c)}return t.create=function(e,n,i,r,o,a,s,c,l){return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new t(e,n,i,r,o,a,s,c,l)},t.clone=function(e){return new t(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)},t.copy=function(t,e){return Pn.copy(t.a,e.a),Pn.copy(t.b,e.b),Pn.copy(t.c,e.c),t},t.fromPoints=function(t,e,n,i){return Pn.copy(t.a,e),Pn.copy(t.b,n),Pn.copy(t.c,i),t},t.set=function(t,e,n,i,r,o,a,s,c,l){return t.a.x=e,t.a.y=n,t.a.z=i,t.b.x=r,t.b.y=o,t.b.z=a,t.c.x=s,t.c.y=c,t.c.z=l,t},K(t,[{key:"type",get:function(){return this._type}}]),t}();!function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(oa||(oa={}));var ca,la,ua,ha,_a,fa,da,pa,ma=(ca=new Pn(0,0,0),function(t,e){var n=Pn.dot(t.d,e.n);if(Math.abs(n)<Number.EPSILON)return 0;Pn.multiplyScalar(ca,e.n,e.d);var i=Pn.dot(Pn.subtract(ca,ca,t.o),e.n)/n;return i<0?0:i}),va=(la=new Pn(0,0,0),ua=new Pn(0,0,0),ha=new Pn(0,0,0),_a=new Pn(0,0,0),fa=new Pn(0,0,0),function(t,e,n){Pn.subtract(la,e.b,e.a),Pn.subtract(ua,e.c,e.a),Pn.cross(ha,t.d,ua);var i=Pn.dot(la,ha);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;Pn.subtract(_a,t.o,e.a);var o=Pn.dot(_a,ha)*r;if(o<0||o>1)return 0;Pn.cross(fa,_a,la);var a=Pn.dot(t.d,fa)*r;if(a<0||o+a>1)return 0;var s=Pn.dot(ua,fa)*r;return s<0?0:s}),ga=function(){var t=new Pn(0,0,0);return function(e,n){var i=n.radius,r=n.center,o=e.o,a=e.d,s=i*i;Pn.subtract(t,r,o);var c=t.lengthSqr(),l=Pn.dot(t,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),ya=(da=new Pn,pa=new Pn,function(t,e){return Pn.subtract(da,e.center,e.halfExtents),Pn.add(pa,e.center,e.halfExtents),xa(t,da,pa)});function xa(t,e,n){var i=t.o,r=t.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(e.x-i.x)*o,l=(n.x-i.x)*o,u=(e.y-i.y)*a,h=(n.y-i.y)*a,_=(e.z-i.z)*s,f=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),p=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return p<0||d>p?0:d>0?d:p}var Sa,Aa,Ca,ba,Ta=function(){var t=new Pn,e=new Pn,n=new Pn,i=new Pn,r=new Pn,o=new Pn,a=new Pn,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,t=_.center,e=h.o,n=h.d,Pn.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),Pn.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),Pn.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),Pn.subtract(a,t,e),c[0]=Pn.dot(i,n),c[1]=Pn.dot(r,n),c[2]=Pn.dot(o,n),l[0]=Pn.dot(i,a),l[1]=Pn.dot(r,a),l[2]=Pn.dot(o,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var d=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),p=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return p<0||d>p?0:d>0?d:p}}(),Ea=function(){var t=new Pn,e=new Pn,n=new Pn,i=new Pn,r=new Pn,o=new Pn,a=new Pn,s=new aa;return function(c,l){var u=l.radius*l.radius,h=Pn.normalize(t,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,d=Pn.subtract(e,f,_);if(d.equals(Pn.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),us.raySphere(c,s);var p=c.o,m=Pn.subtract(n,p,_),v=Pn.cross(i,h,d),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=Pn.subtract(r,f,p);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),us.raySphere(c,s)}var x=Pn.cross(r,m,d),S=d.lengthSqr(),A=2*Pn.dot(v,x),C=A*A-4*g*(x.lengthSqr()-u*S);if(C<0)return 0;var b=(-A-Math.sqrt(C))/(2*g);if(b<0){s.radius=l.radius;var T=Pn.subtract(o,f,p);return m.lengthSqr()<T.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),us.raySphere(c,s)}var E=Pn.scaleAndAdd(o,c.o,h,b),w=Pn.subtract(a,E,_),P=Pn.dot(w,d)/S;return P>=0&&P<=1?b:P<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),us.raySphere(c,s)):P>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),us.raySphere(c,s)):0}}(),wa=(Sa=sa.create(),Aa={distance:1/0,doubleSided:!1,mode:oa.ANY},Ca=0,ba=function(t,e,n,i,r,o){t===oa.CLOSEST?(Ca>e||0===Ca)&&(Ca=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=e,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(Ca=e,o&&o.push({distance:e,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(t,e,n){if(Ca=0,0===e.geometricInfo.positions.length)return Ca;var i=void 0===n?Aa:n;if(xa(t,e.geometricInfo.boundingBox.min,e.geometricInfo.boundingBox.max)){var r=e.primitiveMode,o=e.geometricInfo;!function(t,e,n,i,r){if(n===Fi.TRIANGLE_LIST)for(var o=e.length,a=0;a<o;a+=3){var s=3*e[a],c=3*e[a+1],l=3*e[a+2];Pn.set(Sa.a,t[s],t[s+1],t[s+2]),Pn.set(Sa.b,t[c],t[c+1],t[c+2]),Pn.set(Sa.c,t[l],t[l+1],t[l+2]);var u=us.rayTriangle(i,Sa,r.doubleSided);if(!(0===u||u>r.distance)&&(ba(r.mode,u,s,c,l,r.result),r.mode===oa.ANY))return u}else if(n===Fi.TRIANGLE_STRIP)for(var h=e.length-2,_=0,f=0;f<h;f+=1){var d=3*e[f-_],p=3*e[f+_+1],m=3*e[f+2];Pn.set(Sa.a,t[d],t[d+1],t[d+2]),Pn.set(Sa.b,t[p],t[p+1],t[p+2]),Pn.set(Sa.c,t[m],t[m+1],t[m+2]),_=~_;var v=us.rayTriangle(i,Sa,r.doubleSided);if(!(0===v||v>r.distance)&&(ba(r.mode,v,d,p,m,r.result),r.mode===oa.ANY))return v}else if(n===Fi.TRIANGLE_FAN){var g=e.length-1,y=3*e[0];Pn.set(Sa.a,t[y],t[y+1],t[y+2]);for(var x=1;x<g;x+=1){var S=3*e[x],A=3*e[x+1];Pn.set(Sa.b,t[S],t[S+1],t[S+2]),Pn.set(Sa.c,t[A],t[A+1],t[A+2]);var C=us.rayTriangle(i,Sa,r.doubleSided);if(!(0===C||C>r.distance)&&(ba(r.mode,C,y,S,A,r.result),r.mode===oa.ANY))return C}}}(o.positions,o.indices,r,t,i)}return Ca}),Pa=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:oa.ANY};return function(n,i,r){t=0;var o=void 0===r?e:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!xa(n,s,c))return t;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=wa(n,u,o);if(h)if(o.mode===oa.CLOSEST)(0===t||t>h)&&(t=h,o.subIndices&&(o.subIndices[0]=l));else if(t=h,o.subIndices&&o.subIndices.push(l),o.mode===oa.ANY)return h}return t&&o.mode===oa.CLOSEST&&(o.result&&(o.result[0].distance=t,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),t}}(),Ia=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:oa.ANY},n=new $o,i=new Hn;return function(r,o,a){t=0;var s=void 0===a?e:a,c=o.worldBounds;if(c&&!ya(r,c))return t;$o.copy(n,r),o.node&&(Hn.invert(i,o.node.getWorldMatrix(i)),Pn.transformMat4(n.o,r.o,i),Pn.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=wa(n,h,s);if(_)if(s.mode===oa.CLOSEST)(0===t||t>_)&&(t=_,s.subIndices&&(s.subIndices[0]=u));else if(t=_,s.subIndices&&s.subIndices.push(u),s.mode===oa.ANY)return _}return t&&s.mode===oa.CLOSEST&&(s.result&&(s.result[0].distance=t,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),t}}(),Ra=function(){var t=new Pn(0,0,0);return function(e,n){Pn.subtract(t,e.e,e.s);var i=(n.d-Pn.dot(e.s,n.n))/Pn.dot(t,n.n);return i<0||i>1?0:i}}(),Da=function(){var t=new Pn(0,0,0),e=new Pn(0,0,0),n=new Pn(0,0,0),i=new Pn(0,0,0),r=new Pn(0,0,0),o=new Pn(0,0,0);return function(a,s,c){Pn.subtract(t,s.b,s.a),Pn.subtract(e,s.c,s.a),Pn.subtract(n,a.s,a.e),Pn.cross(r,t,e);var l=Pn.dot(n,r);if(l<=0)return 0;Pn.subtract(i,a.s,s.a);var u=Pn.dot(i,r);if(u<0||u>l)return 0;Pn.cross(o,n,i);var h=Pn.dot(e,o);if(h<0||h>l)return 0;var _=-Pn.dot(t,o);if(_<0||h+_>l)return 0;if(c){var f=1/l,d=1-(h*=f)-(_*=f);Pn.set(c,s.a.x*d+s.b.x*h+s.c.x*_,s.a.y*d+s.b.y*h+s.c.y*_,s.a.z*d+s.b.z*h+s.c.z*_)}return 1}}(),Ma=new $o;function Ba(t,e){Ma.o.set(t.s),Pn.subtract(Ma.d,t.e,t.s),Ma.d.normalize();var n=ya(Ma,e);return n<=t.length()?n:0}function Oa(t,e){Ma.o.set(t.s),Pn.subtract(Ma.d,t.e,t.s),Ma.d.normalize();var n=Ta(Ma,e);return n<=t.length()?n:0}function Na(t,e){Ma.o.set(t.s),Pn.subtract(Ma.d,t.e,t.s),Ma.d.normalize();var n=ga(Ma,e);return n<=t.length()?n:0}var La,Fa,za,Va,ka=(La=new Pn,Fa=new Pn,za=new Pn,Va=new Pn,function(t,e){return Pn.subtract(La,t.center,t.halfExtents),Pn.add(Fa,t.center,t.halfExtents),Pn.subtract(za,e.center,e.halfExtents),Pn.add(Va,e.center,e.halfExtents),La.x<=Va.x&&Fa.x>=za.x&&La.y<=Va.y&&Fa.y>=za.y&&La.z<=Va.z&&Fa.z>=za.z});function Ga(t,e,n,i,r,o){Pn.set(o[0],t.x+n.x*e.x+i.x*e.y+r.x*e.z,t.y+n.y*e.x+i.y*e.y+r.y*e.z,t.z+n.z*e.x+i.z*e.y+r.z*e.z),Pn.set(o[1],t.x-n.x*e.x+i.x*e.y+r.x*e.z,t.y-n.y*e.x+i.y*e.y+r.y*e.z,t.z-n.z*e.x+i.z*e.y+r.z*e.z),Pn.set(o[2],t.x+n.x*e.x-i.x*e.y+r.x*e.z,t.y+n.y*e.x-i.y*e.y+r.y*e.z,t.z+n.z*e.x-i.z*e.y+r.z*e.z),Pn.set(o[3],t.x+n.x*e.x+i.x*e.y-r.x*e.z,t.y+n.y*e.x+i.y*e.y-r.y*e.z,t.z+n.z*e.x+i.z*e.y-r.z*e.z),Pn.set(o[4],t.x-n.x*e.x-i.x*e.y-r.x*e.z,t.y-n.y*e.x-i.y*e.y-r.y*e.z,t.z-n.z*e.x-i.z*e.y-r.z*e.z),Pn.set(o[5],t.x+n.x*e.x-i.x*e.y-r.x*e.z,t.y+n.y*e.x-i.y*e.y-r.y*e.z,t.z+n.z*e.x-i.z*e.y-r.z*e.z),Pn.set(o[6],t.x-n.x*e.x+i.x*e.y-r.x*e.z,t.y-n.y*e.x+i.y*e.y-r.y*e.z,t.z-n.z*e.x+i.z*e.y-r.z*e.z),Pn.set(o[7],t.x-n.x*e.x-i.x*e.y+r.x*e.z,t.y-n.y*e.x-i.y*e.y+r.y*e.z,t.z-n.z*e.x-i.z*e.y+r.z*e.z)}function Ua(t,e){for(var n=Pn.dot(e,t[0]),i=n,r=1;r<8;++r){var o=Pn.dot(e,t[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Ha,ja,Wa,qa=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new Pn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Pn(0,0,0),i[r]=new Pn(0,0,0);var o=new Pn,a=new Pn;return function(e,r){Pn.set(t[0],1,0,0),Pn.set(t[1],0,1,0),Pn.set(t[2],0,0,1),Pn.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Pn.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Pn.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)Pn.cross(t[6+3*s],t[s],t[3]),Pn.cross(t[7+3*s],t[s],t[4]),Pn.cross(t[7+3*s],t[s],t[5]);Pn.subtract(o,e.center,e.halfExtents),Pn.add(a,e.center,e.halfExtents),function(t,e,n){Pn.set(n[0],t.x,e.y,e.z),Pn.set(n[1],t.x,e.y,t.z),Pn.set(n[2],t.x,t.y,e.z),Pn.set(n[3],t.x,t.y,t.z),Pn.set(n[4],e.x,e.y,e.z),Pn.set(n[5],e.x,e.y,t.z),Pn.set(n[6],e.x,t.y,e.z),Pn.set(n[7],e.x,t.y,t.z)}(o,a,n),Ga(r.center,r.halfExtents,t[3],t[4],t[5],i);for(var c=0;c<15;++c){var l=Ua(n,t[c]),u=Ua(i,t[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Xa=function(t,e){var n=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),i=Pn.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1},Ya=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Xa(t,e.planes[n]))return 0;return 1},Ka=function(){for(var t=new Array(8),e=0,n=0,i=0;i<t.length;i++)t[i]=new Pn(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Xa(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)Pn.subtract(t[c],r.vertices[c],i.center);e=0,n=0;for(var l=0;l<r.vertices.length;l++)t[l].x>i.halfExtents.x?e++:t[l].x<-i.halfExtents.x&&n++;if(e===r.vertices.length||n===r.vertices.length)return 0;e=0,n=0;for(var u=0;u<r.vertices.length;u++)t[u].y>i.halfExtents.y?e++:t[u].y<-i.halfExtents.y&&n++;if(e===r.vertices.length||n===r.vertices.length)return 0;e=0,n=0;for(var h=0;h<r.vertices.length;h++)t[h].z>i.halfExtents.z?e++:t[h].z<-i.halfExtents.z&&n++;return e===r.vertices.length||n===r.vertices.length?0:1}}(),Ja=(Ha=new Pn(0,0,0),ja=new Mn,function(t,e){return Pn.subtract(Ha,e,t.center),Pn.transformMat3(Ha,Ha,Mn.transpose(ja,t.orientation)),n=Ha,i=t.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),Qa=(Wa=function(t,e,n,i){return Math.abs(t.x*e+t.y*n+t.z*i)},function(t,e){var n=t.halfExtents.x*Wa(e.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.halfExtents.y*Wa(e.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.halfExtents.z*Wa(e.n,t.orientation.m06,t.orientation.m07,t.orientation.m08),i=Pn.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1}),Za=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Qa(t,e.planes[n]))return 0;return 1},$a=function(){for(var t=new Array(8),e=0,n=0,i=0,r=0;r<t.length;r++)t[r]=new Pn(0,0,0);var o=function(t,e,n,i){return t.x*e+t.y*n+t.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=Qa(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)Pn.subtract(t[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(e=o(t[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:e<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(e=o(t[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:e<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(e=o(t[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:e<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),ts=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new Pn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Pn(0,0,0),i[r]=new Pn(0,0,0);return function(e,r){Pn.set(t[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),Pn.set(t[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),Pn.set(t[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),Pn.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Pn.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Pn.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)Pn.cross(t[6+3*o],t[o],t[3]),Pn.cross(t[7+3*o],t[o],t[4]),Pn.cross(t[8+3*o],t[o],t[5]);Ga(e.center,e.halfExtents,t[0],t[1],t[2],n),Ga(r.center,r.halfExtents,t[3],t[4],t[5],i);for(var a=0;a<15;++a){var s=Ua(n,t[a]),c=Ua(i,t[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),es=function(){for(var t=new aa,e=new Pn,n=new Pn,i=new Pn,r=new Array(8),o=0;o<8;o++)r[o]=new Pn;for(var a=new Array(8),s=0;s<8;s++)a[s]=new Pn;return function(o,s){if(0===Pn.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return t.radius=s.radius,t.center.set(s.ellipseCenter0),us.sphereOBB(t,o);e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,Ga(o.center,o.halfExtents,e,n,i,r);var c=a,l=Pn.copy(c[0],e),u=Pn.copy(c[1],n),h=Pn.copy(c[2],i);Pn.subtract(c[3],s.center,o.center).normalize();var _=Pn.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),Pn.cross(c[5],l,_),Pn.cross(c[6],u,_),Pn.cross(c[7],h,_);for(var f=0;f<8;++f){var d=Ua(r,c[f]),p=Pn.dot(c[f],s.ellipseCenter0),m=Pn.dot(c[f],s.ellipseCenter1),v=Math.max(p,m),g=Math.min(p,m)-s.radius,y=v+s.radius;if(g>d[1]||d[0]>y)return 0}return 1}}(),ns=function(t,e){var n=Pn.dot(e.n,t.center),i=t.radius*e.n.length();return n+i<e.d?-1:n-i>e.d?0:1},is=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===ns(t,e.planes[n]))return 0;return 1},rs=function(){var t=new Pn(0,0,0),e=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=Pn.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){Pn.add(t,s,Pn.multiplyScalar(t,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+e[r]){var _=i.planes[h];if(Pn.dot(_.n,t)<_.d)return 0}}}return 1}}(),os=function(t,e){var n=t.radius+e.radius;return Pn.squaredDistance(t.center,e.center)<n*n},as=function(){var t=new Pn;return function(e,n){return Yo(t,e.center,n),Pn.squaredDistance(e.center,t)<e.radius*e.radius}}(),ss=function(){var t=new Pn;return function(e,n){return Ko(t,e.center,n),Pn.squaredDistance(e.center,t)<e.radius*e.radius}}(),cs=function(){var t=new Pn,e=new Pn;return function(n,i){var r=n.radius+i.radius,o=r*r,a=Pn.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return Pn.squaredDistance(n.center,i.center)<o;Pn.subtract(t,n.center,i.ellipseCenter0),Pn.subtract(e,i.ellipseCenter1,i.ellipseCenter0);var s=Pn.dot(t,e)/a;return s<0?Pn.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?Pn.squaredDistance(n.center,i.ellipseCenter1)<o:(Pn.scaleAndAdd(t,i.ellipseCenter0,e,s),Pn.squaredDistance(n.center,t)<o)}}(),ls=function(){var t=new Pn,e=new Pn,n=new Pn,i=new Pn,r=new Pn,o=new Pn;return function(a,s){var c,l,u=Pn.subtract(t,a.ellipseCenter1,a.ellipseCenter0),h=Pn.subtract(e,s.ellipseCenter1,s.ellipseCenter0),_=Pn.subtract(n,a.ellipseCenter0,s.ellipseCenter0),f=Pn.dot(u,u),d=Pn.dot(u,h),p=Pn.dot(h,h),m=Pn.dot(u,_),v=Pn.dot(h,_),g=f*p-d*d,y=g,x=g;g<rn?(c=0,y=1,l=v,x=p):(l=f*v-d*m,(c=d*v-p*m)<0?(c=0,l=v,x=p):c>y&&(c=y,l=v+d,x=p)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>x&&(l=x,-m+d<0?c=0:-m+d>f?c=y:(c=-m+d,y=f));var S=Math.abs(c)<rn?0:c/y,A=Math.abs(l)<rn?0:l/x,C=i;C.set(_),C.add(Pn.multiplyScalar(r,u,S)),C.subtract(Pn.multiplyScalar(o,h,A));var b=a.radius+s.radius;return C.lengthSqr()<b*b}}(),us={raySphere:ga,rayAABB:ya,rayOBB:Ta,rayPlane:ma,rayTriangle:va,rayCapsule:Ea,raySubMesh:wa,rayMesh:Pa,rayModel:Ia,lineSphere:Na,lineAABB:Ba,lineOBB:Oa,linePlane:Ra,lineTriangle:Da,sphereWithSphere:os,sphereAABB:as,sphereOBB:ss,spherePlane:ns,sphereFrustum:is,sphereFrustumAccurate:rs,sphereCapsule:cs,aabbWithAABB:ka,aabbWithOBB:qa,aabbPlane:Xa,aabbFrustum:Ya,aabbFrustumAccurate:Ka,obbWithOBB:ts,obbPlane:Qa,obbFrustum:Za,obbFrustumAccurate:$a,obbPoint:Ja,obbCapsule:es,capsuleWithCapsule:ls,resolve:function(t,e,n){void 0===n&&(n=null);var i=t._type,r=e._type,o=this[i|r];return i<r?o(t,e,n):o(e,t,n)}};us[Qo.SHAPE_RAY|Qo.SHAPE_SPHERE]=ga,us[Qo.SHAPE_RAY|Qo.SHAPE_AABB]=ya,us[Qo.SHAPE_RAY|Qo.SHAPE_OBB]=Ta,us[Qo.SHAPE_RAY|Qo.SHAPE_PLANE]=ma,us[Qo.SHAPE_RAY|Qo.SHAPE_TRIANGLE]=va,us[Qo.SHAPE_RAY|Qo.SHAPE_CAPSULE]=Ea,us[Qo.SHAPE_LINE|Qo.SHAPE_SPHERE]=Na,us[Qo.SHAPE_LINE|Qo.SHAPE_AABB]=Ba,us[Qo.SHAPE_LINE|Qo.SHAPE_OBB]=Oa,us[Qo.SHAPE_LINE|Qo.SHAPE_PLANE]=Ra,us[Qo.SHAPE_LINE|Qo.SHAPE_TRIANGLE]=Da,us[Qo.SHAPE_SPHERE]=os,us[Qo.SHAPE_SPHERE|Qo.SHAPE_AABB]=as,us[Qo.SHAPE_SPHERE|Qo.SHAPE_OBB]=ss,us[Qo.SHAPE_SPHERE|Qo.SHAPE_PLANE]=ns,us[Qo.SHAPE_SPHERE|Qo.SHAPE_FRUSTUM]=is,us[Qo.SHAPE_SPHERE|Qo.SHAPE_FRUSTUM_ACCURATE]=rs,us[Qo.SHAPE_SPHERE|Qo.SHAPE_CAPSULE]=cs,us[Qo.SHAPE_AABB]=ka,us[Qo.SHAPE_AABB|Qo.SHAPE_OBB]=qa,us[Qo.SHAPE_AABB|Qo.SHAPE_PLANE]=Xa,us[Qo.SHAPE_AABB|Qo.SHAPE_FRUSTUM]=Ya,us[Qo.SHAPE_AABB|Qo.SHAPE_FRUSTUM_ACCURATE]=Ka,us[Qo.SHAPE_OBB]=ts,us[Qo.SHAPE_OBB|Qo.SHAPE_PLANE]=Qa,us[Qo.SHAPE_OBB|Qo.SHAPE_FRUSTUM]=Za,us[Qo.SHAPE_OBB|Qo.SHAPE_FRUSTUM_ACCURATE]=$a,us[Qo.SHAPE_OBB|Qo.SHAPE_CAPSULE]=es,us[Qo.SHAPE_CAPSULE]=ls,z(Zo.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),V(us,"intersect",[{name:"line_quad"}]);var hs,_s,fs,ds,ps,ms,vs,gs=new Pn(0,0,0),ys=new Pn(0,0,0),xs=c.mat4(),Ss=c.v4(),As=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=Qo.SHAPE_PLANE,this.n=new Pn(t,e,n),this.d=i}return t.create=function(e,n,i,r){return new t(e,n,i,r)},t.clone=function(e){return new t(e.n.x,e.n.y,e.n.z,e.d)},t.copy=function(t,e){return Pn.copy(t.n,e.n),t.d=e.d,t},t.fromPoints=function(t,e,n,i){return Pn.subtract(gs,n,e),Pn.subtract(ys,i,e),Pn.normalize(t.n,Pn.cross(t.n,gs,ys)),t.d=Pn.dot(t.n,e),t},t.set=function(t,e,n,i,r){return t.n.x=e,t.n.y=n,t.n.z=i,t.d=r,t},t.fromNormalAndPoint=function(t,e,n){return Pn.copy(t.n,e),t.d=Pn.dot(e,n),t},t.normalize=function(t,e){var n=e.n.length();return Pn.normalize(t.n,e.n),n>0&&(t.d=e.d/n),t},t.prototype.transform=function(t){Hn.invert(xs,t),Hn.transpose(xs,xs),Qn.set(Ss,this.n.x,this.n.y,this.n.z,this.d),Qn.transformMat4(Ss,Ss,xs),Pn.set(this.n,Ss.x,Ss.y,Ss.z),this.d=Ss.w},K(t,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(t){this.n.x=t}},{key:"y",get:function(){return this.n.y},set:function(t){this.n.y=t}},{key:"z",get:function(){return this.n.z},set:function(t){this.n.z=t}},{key:"w",get:function(){return this.d},set:function(t){this.d=t}}]),t}(),Cs=function(){function t(t,e,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<e)}return t.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},t}();!function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(vs||(vs={}));var bs,Ts,Es=function(){function t(t,e,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=e,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Cs(t,r,this._stride);var o=vs.NEVER,a=!1,s=!1;for(var c in e){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=e[c],a||o!==vs.FLOAT32?s||o!==vs.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var e=t.prototype;return e.alloc=function(){for(var t=0;t<this._freeLists.length;t++){var e=this._freeLists[t];if(e.length){var n=e[e.length-1];return e.length--,(t<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(t<<this._entryBits)+this._poolFlag},e.getBuffer=function(t){var e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[e][n]},e.getTypedArray=function(t,e){var n=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t,r=e,o=(this._dataType[e]===vs.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[e];return o.subarray(r,r+a)},e.free=function(t){var e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][n].fill(0),this._freeLists[e].push(n)},t}();!function(t){t[t.NODE=0]="NODE",t[t.PASS=1]="PASS",t[t.AABB=2]="AABB"}(bs||(bs={})),function(t){t[t.DIRTY_FLAG=0]="DIRTY_FLAG",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.LOCAL_SCALE=28]="LOCAL_SCALE",t[t.LOCAL_POSITION=31]="LOCAL_POSITION",t[t.LOCAL_ROTATION=34]="LOCAL_ROTATION",t[t.COUNT=38]="COUNT"}(Ts||(Ts={}));var ws,Ps=((hs={})[Ts.DIRTY_FLAG]=vs.UINT32,hs[Ts.LAYER]=vs.UINT32,hs[Ts.WORLD_SCALE]=vs.FLOAT32,hs[Ts.WORLD_POSITION]=vs.FLOAT32,hs[Ts.WORLD_ROTATION]=vs.FLOAT32,hs[Ts.WORLD_MATRIX]=vs.FLOAT32,hs[Ts.LOCAL_SCALE]=vs.FLOAT32,hs[Ts.LOCAL_POSITION]=vs.FLOAT32,hs[Ts.LOCAL_ROTATION]=vs.FLOAT32,hs[Ts.COUNT]=vs.NEVER,hs),Is=((_s={})[Ts.DIRTY_FLAG]=Ts.LAYER-Ts.DIRTY_FLAG,_s[Ts.LAYER]=Ts.WORLD_SCALE-Ts.LAYER,_s[Ts.WORLD_SCALE]=Ts.WORLD_POSITION-Ts.WORLD_SCALE,_s[Ts.WORLD_POSITION]=Ts.WORLD_ROTATION-Ts.WORLD_POSITION,_s[Ts.WORLD_ROTATION]=Ts.WORLD_MATRIX-Ts.WORLD_ROTATION,_s[Ts.WORLD_MATRIX]=Ts.LOCAL_SCALE-Ts.WORLD_MATRIX,_s[Ts.LOCAL_SCALE]=Ts.LOCAL_POSITION-Ts.LOCAL_SCALE,_s[Ts.LOCAL_POSITION]=Ts.LOCAL_ROTATION-Ts.LOCAL_POSITION,_s[Ts.LOCAL_ROTATION]=Ts.COUNT-Ts.LOCAL_ROTATION,_s[Ts.COUNT]=1,_s),Rs=new Es(bs.NODE,Ps,Is,Ts);!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.PRIMITIVE=3]="PRIMITIVE",t[t.BATCHING_SCHEME=4]="BATCHING_SCHEME",t[t.DYNAMIC_STATE=5]="DYNAMIC_STATE",t[t.HASH=6]="HASH",t[t.COUNT=7]="COUNT"}(ws||(ws={}));var Ds,Ms=((fs={})[ws.PRIORITY]=vs.UINT32,fs[ws.STAGE]=vs.UINT32,fs[ws.PHASE]=vs.UINT32,fs[ws.PRIMITIVE]=vs.UINT32,fs[ws.BATCHING_SCHEME]=vs.UINT32,fs[ws.DYNAMIC_STATE]=vs.UINT32,fs[ws.HASH]=vs.UINT32,fs[ws.COUNT]=vs.NEVER,fs),Bs=((ds={})[ws.PRIORITY]=ws.STAGE-ws.PRIORITY,ds[ws.STAGE]=ws.PHASE-ws.STAGE,ds[ws.PHASE]=ws.PRIMITIVE-ws.PHASE,ds[ws.PRIMITIVE]=ws.BATCHING_SCHEME-ws.PRIMITIVE,ds[ws.BATCHING_SCHEME]=ws.DYNAMIC_STATE-ws.BATCHING_SCHEME,ds[ws.DYNAMIC_STATE]=ws.HASH-ws.DYNAMIC_STATE,ds[ws.HASH]=ws.COUNT-ws.HASH,ds[ws.COUNT]=1,ds),Os=new Es(bs.PASS,Ms,Bs,ws);!function(t){t[t.CENTER=0]="CENTER",t[t.HALFEXTENTS=3]="HALFEXTENTS",t[t.COUNT=6]="COUNT"}(Ds||(Ds={}));var Ns=((ps={})[Ds.CENTER]=vs.FLOAT32,ps[Ds.HALFEXTENTS]=vs.FLOAT32,ps[Ds.COUNT]=vs.NEVER,ps),Ls=((ms={})[Ds.CENTER]=Ds.HALFEXTENTS-Ds.CENTER,ms[Ds.HALFEXTENTS]=Ds.COUNT-Ds.HALFEXTENTS,ms[Ds.COUNT]=1,ms),Fs=new Es(bs.AABB,Ns,Ls,Ds),zs=new Pn,Vs=new Pn,ks=new Pn,Gs=new Pn,Us=new Mn,Hs=function(t,e,n){Us.m00=Math.abs(n.m00),Us.m01=Math.abs(n.m01),Us.m02=Math.abs(n.m02),Us.m03=Math.abs(n.m04),Us.m04=Math.abs(n.m05),Us.m05=Math.abs(n.m06),Us.m06=Math.abs(n.m08),Us.m07=Math.abs(n.m09),Us.m08=Math.abs(n.m10),Pn.transformMat3(t,e,Us)},js=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=Qo.SHAPE_AABB,this.center=new Pn(t,e,n),this.halfExtents=new Pn(i,r,o)}t.create=function(e,n,i,r,o,a){return new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)},t.copy=function(t,e){return Pn.copy(t.center,e.center),Pn.copy(t.halfExtents,e.halfExtents),t},t.fromPoints=function(t,e,n){return Pn.add(zs,n,e),Pn.subtract(Vs,n,e),Pn.multiplyScalar(t.center,zs,.5),Pn.multiplyScalar(t.halfExtents,Vs,.5),t},t.set=function(t,e,n,i,r,o,a){return t.center.set(e,n,i),t.halfExtents.set(r,o,a),t},t.merge=function(e,n,i){return Pn.subtract(zs,n.center,n.halfExtents),Pn.subtract(Vs,i.center,i.halfExtents),Pn.add(ks,n.center,n.halfExtents),Pn.add(Gs,i.center,i.halfExtents),Pn.max(Gs,ks,Gs),Pn.min(ks,zs,Vs),t.fromPoints(e,ks,Gs)},t.toBoundingSphere=function(t,e){return t.center.set(e.center),t.radius=e.halfExtents.length(),t},t.transform=function(t,e,n){return Pn.transformMat4(t.center,e.center,n),Hs(t.halfExtents,e.halfExtents,n),t};var e=t.prototype;return e.getBoundary=function(t,e){Pn.subtract(t,this.center,this.halfExtents),Pn.add(e,this.center,this.halfExtents)},e.transform=function(t,e,n,i,r){Pn.transformMat4(r.center,this.center,t),Hs(r.halfExtents,this.halfExtents,t)},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.mergePoint=function(t){this.getBoundary(zs,Vs),t.x<zs.x&&(zs.x=t.x),t.y<zs.y&&(zs.y=t.y),t.z<zs.z&&(zs.z=t.z),t.x>Vs.x&&(Vs.x=t.x),t.y>Vs.y&&(Vs.y=t.y),t.z>Vs.z&&(Vs.z=t.z),Pn.add(ks,zs,Vs),this.center.set(Pn.multiplyScalar(ks,ks,.5)),this.halfExtents.set(Vs.x-ks.x,Vs.y-ks.y,Vs.z-ks.z)},e.mergePoints=function(t){if(!(t.length<1))for(var e=0;e<t.length;e++)this.mergePoint(t[e])},e.mergeFrustum=function(t){return this.mergePoints(t.vertices)},K(t,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),t}(),Ws=new Pn,qs=new Pn,Xs=new Mn,Ys=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,_,f,d){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Qo.SHAPE_OBB,this.center=new Pn(t,e,n),this.halfExtents=new Pn(i,r,o),this.orientation=new Mn(a,s,c,l,u,h,_,f,d)}t.create=function(e,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return new t(e,n,i,r,o,a,s,c,l,u,h,_,f,d,p)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)},t.copy=function(t,e){return Pn.copy(t.center,e.center),Pn.copy(t.halfExtents,e.halfExtents),Mn.copy(t.orientation,e.orientation),t},t.fromPoints=function(t,e,n){return Pn.multiplyScalar(t.center,Pn.add(Ws,e,n),.5),Pn.multiplyScalar(t.halfExtents,Pn.subtract(qs,n,e),.5),Mn.identity(t.orientation),t},t.set=function(t,e,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return Pn.set(t.center,e,n,i),Pn.set(t.halfExtents,r,o,a),Mn.set(t.orientation,s,c,l,u,h,_,f,d,p),t};var e=t.prototype;return e.getBoundary=function(t,e){!function(t,e,n){Xs.m00=Math.abs(n.m00),Xs.m01=Math.abs(n.m01),Xs.m02=Math.abs(n.m02),Xs.m03=Math.abs(n.m03),Xs.m04=Math.abs(n.m04),Xs.m05=Math.abs(n.m05),Xs.m06=Math.abs(n.m06),Xs.m07=Math.abs(n.m07),Xs.m08=Math.abs(n.m08),Pn.transformMat3(t,e,Xs)}(Ws,this.halfExtents,this.orientation),Pn.subtract(t,this.center,Ws),Pn.add(e,this.center,Ws)},e.transform=function(t,e,n,i,r){Pn.transformMat4(r.center,this.center,t),Mn.fromQuat(r.orientation,n),Pn.multiply(r.halfExtents,this.halfExtents,i)},e.translateAndRotate=function(t,e,n){Pn.transformMat4(n.center,this.center,t),Mn.fromQuat(n.orientation,e)},e.setScale=function(t,e){Pn.multiply(e.halfExtents,this.halfExtents,t)},K(t,[{key:"type",get:function(){return this._type}}]),t}(),Ks=function(){function t(t,e,n){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Qo.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=n,this.center=new Pn,this.rotation=new Nn,this.ellipseCenter0=new Pn(0,e,0),this.ellipseCenter1=new Pn(0,-e,0),this.updateCache()}var e=t.prototype;return e.transform=function(t,e,n,i,r){var o=i,a=An(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,Pn.transformMat4(r.center,this.center,t),Nn.multiply(r.rotation,this.rotation,n),r.updateCache()},e.updateCache=function(){this.updateLocalCenter(),Pn.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),Pn.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},e.updateLocalCenter=function(){var t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}},K(t,[{key:"type",get:function(){return this._type}}]),t}(),Js=new Array(8);Js[0]=new Pn(1,1,1),Js[1]=new Pn(-1,1,1),Js[2]=new Pn(-1,-1,1),Js[3]=new Pn(1,-1,1),Js[4]=new Pn(1,1,-1),Js[5]=new Pn(-1,1,-1),Js[6]=new Pn(-1,-1,-1),Js[7]=new Pn(1,-1,-1);var Qs,Zs,$s=new Pn,tc=new Pn,ec=new Pn,nc=function(){function t(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=Qo.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=As.create(0,0,0,0);this.vertices=new Array(8);for(var e=0;e<8;++e)this.vertices[e]=new Pn}t.createFromAABB=function(t,e){var n=new Pn,i=new Pn;return Pn.subtract(n,e.center,e.halfExtents),Pn.add(i,e.center,e.halfExtents),t.vertices[0].set(n.x,i.y,n.z),t.vertices[1].set(i.x,i.y,n.z),t.vertices[2].set(i.x,n.y,n.z),t.vertices[3].set(n.x,n.y,n.z),t.vertices[4].set(n.x,i.y,i.z),t.vertices[5].set(i.x,i.y,i.z),t.vertices[6].set(i.x,n.y,i.z),t.vertices[7].set(n.x,n.y,i.z),t._type!==Qo.SHAPE_FRUSTUM_ACCURATE||t.updatePlanes(),t},t.split=function(t,e,n,i,r){var o=Math.tan(.5*e.fov),a=o*e.aspect;$s.set(i*a,i*o,i),tc.set(r*a,r*o,r);var s=t.vertices;return ec.set($s.x,$s.y,$s.z),Pn.transformMat4(s[0],ec,n),ec.set(-$s.x,$s.y,$s.z),Pn.transformMat4(s[1],ec,n),ec.set(-$s.x,-$s.y,$s.z),Pn.transformMat4(s[2],ec,n),ec.set($s.x,-$s.y,$s.z),Pn.transformMat4(s[3],ec,n),ec.set(tc.x,tc.y,tc.z),Pn.transformMat4(s[4],ec,n),ec.set(-tc.x,tc.y,tc.z),Pn.transformMat4(s[5],ec,n),ec.set(-tc.x,-tc.y,tc.z),Pn.transformMat4(s[6],ec,n),ec.set(tc.x,-tc.y,tc.z),Pn.transformMat4(s[7],ec,n),t.updatePlanes(),t},t.create=function(){return new t},t.clone=function(e){return t.copy(new t,e)},t.copy=function(t,e){t._type=e._type;for(var n=0;n<6;++n)As.copy(t.planes[n],e.planes[n]);for(var i=0;i<8;++i)Pn.copy(t.vertices[i],e.vertices[i]);return t};var e=t.prototype;return e.update=function(t,e){if(Pn.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),Pn.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),Pn.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),Pn.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),Pn.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),Pn.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===Qo.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();Pn.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)Pn.transformMat4(this.vertices[o],Js[o],e)}},e.transform=function(t){if(this._type===Qo.SHAPE_FRUSTUM_ACCURATE){for(var e=0;e<8;e++)Pn.transformMat4(this.vertices[e],this.vertices[e],t);As.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),As.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),As.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),As.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),As.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),As.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},e.updatePlanes=function(){As.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),As.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),As.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),As.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),As.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),As.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},K(t,[{key:"accurate",set:function(t){this._type=t?Qo.SHAPE_FRUSTUM_ACCURATE:Qo.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),t}();nc.createOrtho=function(t,e,n,i,r,o){var a=e/2,s=n/2;Pn.set(ec,a,s,-i),Pn.transformMat4(t.vertices[0],ec,o),Pn.set(ec,-a,s,-i),Pn.transformMat4(t.vertices[1],ec,o),Pn.set(ec,-a,-s,-i),Pn.transformMat4(t.vertices[2],ec,o),Pn.set(ec,a,-s,-i),Pn.transformMat4(t.vertices[3],ec,o),Pn.set(ec,a,s,-r),Pn.transformMat4(t.vertices[4],ec,o),Pn.set(ec,-a,s,-r),Pn.transformMat4(t.vertices[5],ec,o),Pn.set(ec,-a,-s,-r),Pn.transformMat4(t.vertices[6],ec,o),Pn.set(ec,a,-s,-r),Pn.transformMat4(t.vertices[7],ec,o),As.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),As.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),As.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),As.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),As.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),As.fromPoints(t.planes[5],t.vertices[7],t.vertices[5],t.vertices[6])},function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(Qs||(Qs={})),function(t){t[t.Default=Qs.Default]="Default",t[t.Normal=Qs.Normal]="Normal",t[t.Reverse=Qs.Reverse]="Reverse",t[t.Loop=Qs.Loop]="Loop",t[t.LoopReverse=Qs.Loop|Qs.Reverse]="LoopReverse",t[t.PingPong=Qs.PingPong]="PingPong",t[t.PingPongReverse=Qs.PingPong|Qs.Reverse]="PingPongReverse"}(Zs||(Zs={})),ce(Zs);var ic=function(){function t(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return t.prototype.set=function(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex},t}();function rc(t,e,n){void 0===n&&(n=1e-6);for(var i=0,r=t.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=t[o];if(a>e+n)r=o-1;else{if(!(a<e-n))return o;i=o+1}}return~i}var oc=function(){},ac=function(){return oc},sc=cc((function(){}));function cc(t){return function(e){return"function"==typeof e?t(e):function(n){return t(n,e)}}}function lc(t){return function(e){return function(n){!function(t,e,n){var i=hc(t);if(i){var r=_c(i,"proto");_c(r,"editor")[e]=n}}(n,t,e)}}}var uc="__ccclassCache__";function hc(t){return _c(t,uc)}function _c(t,e){return t[e]||(t[e]={})}var fc=cc((function(t,e){var n=ne.getSuper(t);n===Object&&(n=null);var i={name:e,extends:n,ctor:t},r=t[uc];if(r){var o=r.proto;o&&ne.mixin(i,o),t[uc]=void 0}return Ze(i)})),dc=lc("requireComponent"),pc=lc("executionOrder"),mc=sc;function vc(t,e,n){var i=null;function r(t,e,n){var r=hc(t.constructor);if(r){var o=_c(r,"proto"),a=_c(o,"properties");!function(t,e,n,i,r,o){var a,s=r&&(r.get||r.set);i&&(a=Ue(i,s));var c=e[n],l=ne.mixin(c||{},a||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(t){var e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(r.initializer));else{var u=o.default||(o.default=function(t){var e;try{e=new t}catch(t){return{}}return e}(t));u.hasOwnProperty(n)&&(l.default=u[n])}e[n]=l}(t.constructor,a,e,i,n,r)}}return void 0===t?vc({type:void 0}):void 0===e?(i=t,r):void r(t,e,n)}var gc=Symbol("cc:SerializationMetadata"),yc=function(t,e,n){return vc(Ac({}))(t,e,n)};function xc(t){return vc(Ac({formerlySerializedAs:t}))}var Sc=function(t,e,n){return vc({editorOnly:!0})(t,e,n)};function Ac(t){return t.__noImplicit=!0,"serializable"in t||(t.serializable=!0),t}var Cc=oc,bc=sc,Tc=ac,Ec=sc,wc=ac,Pc=ac,Ic=ac,Rc=oc,Dc=ac,Mc=oc,Bc=ac,Oc=ac,Nc=ac,Lc=ac,Fc=ac,zc=ac,Vc=oc,kc=ac,Gc=oc,Uc=oc,Hc=Xc(Me),jc=Xc(Be),Wc=Xc(Oe),qc=Xc(Ne);function Xc(t){return vc({type:t})}var Yc,Kc,Jc,Qc,Zc,$c,tl,el,nl,il=function(t,e,n){return vc({__noImplicit:!0,override:!0})(t,e,n)},rl=fc("cc.KeyframeCurve")((Yc=Symbol.iterator,$c=function(){function t(){at(this,"_times",Qc,this),at(this,"_values",Zc,this)}var e=t.prototype;return e[Yc]=function(){var t=this,e=0;return{next:function(){if(e>=t._times.length)return{done:!0,value:void 0};var n=[t._times[e],t._values[e]];return++e,{done:!1,value:n}}}},e.keyframes=function(){return this},e.times=function(){return this._times},e.values=function(){return this._values},e.getKeyframeTime=function(t){return this._times[t]},e.getKeyframeValue=function(t){return this._values[t]},e.addKeyFrame=function(t,e){return this._insertNewKeyframe(t,e)},e.removeKeyframe=function(t){this._times.splice(t,1),this._values.splice(t,1)},e.indexOfKeyframe=function(t){return rc(this._times,t)},e.updateTime=function(t,e){var n=this._values[t];this.removeKeyframe(t),this._insertNewKeyframe(e,n)},e.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.slice());else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return t[1]})))}},e.clear=function(){this._times.length=0,this._values.length=0},e.searchKeyframe=function(t){return rc(this._times,t)},e.setKeyframes=function(t,e){t.length,e.length,function(t){t.every((function(t,e,n){return 0===e||t>n[e-1]||an(t,n[e-1],1e-6)}))}(t),this._times=t,this._values=e},e._insertNewKeyframe=function(t,e){var n=this._times,i=this._values,r=n.length,o=rc(n,t);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(t),i.unshift(e)):a===r?(n.push(t),i.push(e)):(n.splice(a-1,0,t),i.splice(a-1,0,e)),a},K(t,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),t}(),Qc=st((Jc=$c).prototype,"_times",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zc=st(Jc.prototype,"_values",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kc=Jc))||Kc;function ol(t){return t>-1e-9&&t<1e-9}!function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.CUBIC=2]="CUBIC"}(tl||(tl=t("RealInterpolationMode",{}))),function(t){t[t.LINEAR=0]="LINEAR",t[t.CLAMP=1]="CLAMP",t[t.LOOP=2]="LOOP",t[t.PING_PONG=3]="PING_PONG"}(el||(el=t("ExtrapolationMode",{}))),function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTH=3]="BOTH"}(nl||(nl=t("TangentWeightMode",{})));var al,sl=t("editorExtrasTag","__editorExtras__"),cl=function(){},ll=Object.freeze({__proto__:null,uniquelyReferenced:Cc,ccclass:fc,property:vc,requireComponent:dc,executionOrder:pc,disallowMultiple:mc,allowReplicated:function(t){Ze.Attr.setClassAttr(t,"replicated","visible",!0)},executeInEditMode:bc,menu:Tc,playOnFocus:Ec,inspector:wc,icon:Pc,help:Ic,type:Xc,integer:Hc,float:jc,boolean:Wc,string:qc});t("_decorator",ll);var ul=1<<22,hl=[],_l=t("CCObject",function(){function t(t){void 0===t&&(t=""),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}t._deferredDestroy=function(){for(var t=hl.length,e=0;e<t;++e){var n=hl[e];1&n._objFlags||n._destroyImmediate()}t===hl.length?hl.length=0:hl.splice(0,t)};var e=t.prototype;return e.destroy=function(){return 1&this._objFlags?(I(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,hl.push(this),0))},e._destruct=function(){var t=this.constructor,e=t.__destruct__;e||(e=function(t,e){var n,i=t instanceof c._BaseNode||t instanceof c.Component,r=i?"_id":null,o={};for(n in t)if(t.hasOwnProperty(n)){if(n===r)continue;switch(typeof t[n]){case"string":o[n]="";break;case"object":case"function":o[n]=null}}if(Ze._isCCClass(e))for(var a=c.Class.Attr.getClassAttrs(e),s=e.__props__,l=0;l<s.length;l++){var u=(n=s[l])+c.Class.Attr.DELIMETER+"default";if(u in a){if(i&&"_id"===n)continue;switch(typeof a[u]){case"string":o[n]="";break;case"object":case"function":o[n]=null;break;case"undefined":o[n]=void 0}}}var h="";for(n in o){var _;_=Ze.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Ze.escapeForJS(n)+"]=";var f=o[n];""===f&&(f='""'),h+=_+f+";\n"}return Function("o",h)}(this,t),Ct(t,"__destruct__",e,!0)),e(this)},e._destroyImmediate=function(){1&this._objFlags?D(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},K(t,[{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"hideFlags",get:function(){return this._objFlags&t.Flags.AllHideMasks},set:function(e){var n=e&t.Flags.AllHideMasks;this._objFlags=this._objFlags&~t.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&ul)},set:function(t){t?this._objFlags|=ul:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}()),fl=_l.prototype;function dl(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}fl._deserialize=null,fl._onPreDestroy=null,Ze.fastDefine("cc.Object",_l,((al={_name:"",_objFlags:0})[sl]={},al)),Ze.Attr.setClassAttr(_l,sl,"editorOnly",!0),Ze.Attr.setClassAttr(_l,"replicated","visible",!1),Ct(_l,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),c.isValid=dl,c.Object=_l;var pl=function(){function t(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=ne.createMap(!0),this._count=0)}var e=t.prototype;return e.add=function(t,e){return t in this._map||this._count++,this._map[t]=e},e.get=function(t){return this._map[t]},e.has=function(t){return t in this._map},e.remove=function(t){var e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e},e.clear=function(){0!==this._count&&(this._map=ne.createMap(!0),this._count=0)},e.forEach=function(t){for(var e in this._map)t(this._map[e],e)},e.find=function(t){for(var e in this._map)if(t(this._map[e],e))return this._map[e];return null},e.destroy=function(){this._map=null},K(t,[{key:"count",get:function(){return this._count}}]),t}(),ml=function(){function t(e,n){this.id=t._pipelineId++,this.name="",this.pipes=[],this.name=e;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var e=t.prototype;return e.insert=function(t,e){return e>this.pipes.length?(I(4921),this):(this.pipes.splice(e,0,t),this)},e.append=function(t){return this.pipes.push(t),this},e.remove=function(t){return this.pipes.splice(t,1),this},e.sync=function(t){var e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(var n=0,i=e.length;n<i;){var r=(0,e[n])(t);if(r)return t.isFinish=!0,r;++n!==i&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output},e.async=function(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))},e._flow=function(t,e){var n=this;(0,this.pipes[t])(e,(function(i){i?(e.isFinish=!0,e.dispatch("complete",i)):++t<n.pipes.length?(e.input=e.output,e.output=null,n._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",i,e.output))}))},t}();ml._pipelineId=0,function(){function t(t){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(t)for(var e in t)this._weakMap[e]=new WeakRef(t[e])}var e=t.prototype;e.add=function(t,e){return this._weakMap[t]=new WeakRef(e),e},e.has=function(t){return t in this._weakMap&&!!this._weakMap[t].deref()},e.get=function(t){return this._weakMap[t]&&this._weakMap[t].deref()},e.remove=function(t){var e=this._weakMap[t];return delete this._weakMap[t],e&&e.deref()},e.clear=function(){this._weakMap=ne.createMap(!0)},e.forEach=function(t){for(var e in this._weakMap){var n=this.get(e);n&&t(n,e)}},e.find=function(t){for(var e in this._weakMap){var n=this.get(e);if(n&&t(n,e))return this._weakMap[e].deref()}return null},e.destroy=function(){this._weakMap={}},K(t,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(t){return t.deref()})).length}}])}();var vl,gl=new pl,yl=new pl,xl=new pl,Sl=new pl,Al=new ml("normal load",[]),Cl=new ml("fetch",[]),bl=new ml("transform url",[]);!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(vl||(vl={}));var Tl,El={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(Tl||(Tl={}));var wl=function(){function t(e){this.id=t._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(e)}t.create=function(e){var n;return 0!==t._deadPool.length?(n=t._deadPool.pop()).set(e):n=new t(e),n};var e=t.prototype;return e.set=function(t){void 0===t&&(t=Object.create(null)),this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)},e.dispatch=function(t,e,n,i,r){switch(t){case"complete":this.onComplete&&this.onComplete(e,n);break;case"progress":this.onProgress&&this.onProgress(e,n,i,r);break;case"error":this.onError&&this.onError(e,n,i,r);break;default:var o="on"+t[0].toUpperCase()+t.substr(1);"function"==typeof this[o]&&this[o](e,n,i,r)}},e.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,t._deadPool.push(this))},t}();wl.MAX_DEAD_NUM=500,wl._taskId=0,wl._deadPool=[];var Pl="0123456789abcdef".split(""),Il=["","","",""],Rl=Il.concat(Il,"-",Il,"-",Il,"-",Il,"-",Il,Il,Il),Dl=Rl.map((function(t,e){return"-"===t?NaN:e})).filter(isFinite);function Ml(t){var e=t.split("@")[0];if(22!==e.length)return t;Rl[0]=t[0],Rl[1]=t[1];for(var n=2,i=2;n<22;n+=2){var r=pe[t.charCodeAt(n)],o=pe[t.charCodeAt(n+1)];Rl[Dl[i++]]=Pl[r>>2],Rl[Dl[i++]]=Pl[(3&r)<<2|o>>4],Rl[Dl[i++]]=Pl[15&o]}return t.replace(e,Rl.join(""))}var Bl=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function Ol(t){var e=Bl.exec(t);return e?e[1]:""}function Nl(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;var n=Sl.find((function(e){return!!e.getAssetInfo(t)}));return n&&(e.bundle=n.name),zl(t,e)}function Ll(t){return!!t&&(t instanceof c.SceneAsset||t instanceof c.Scene)}function Fl(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function zl(t,e){var n=wl.create({input:t,options:e}),i=[];try{for(var r,o=ot(bl.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(t){for(var c,l=ot(n.output);!(c=l()).done;)c.value.recycle();x(t.message,t.stack)}return n.recycle(),i.length>1?i:i[0]}var Vl=Object.freeze({__proto__:null,getUuidFromURL:Ol,getUrlWithUuid:Nl,isScene:Ll,normalize:Fl,transform:zl,decodeUuid:Ml}),kl=new(function(){function t(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var e=t.prototype;return e.addContainer=function(t){-1===t._poolHandle&&(t._poolHandle=this._pools.length,this._pools.push(t))},e.removeContainer=function(t){-1!==t._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=t._poolHandle,ne.array.fastRemoveAt(this._pools,t._poolHandle),t._poolHandle=-1)},e.tryShrink=function(){for(var t=0;t<this._pools.length;t++)this._pools[t].tryShrink()},e.update=function(t){this._lastShrinkPassed+=t,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},t}()),Gl=function(){function t(){this._poolHandle=-1,kl.addContainer(this)}return t.prototype.destroy=function(){kl.removeContainer(this)},t}(),Ul=t("Pool",function(t){function e(e,n,i){var r;(r=t.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=e,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(e());return r}Q(e,t);var n=e.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var t=0;t<this._elementsPerBatch;t++)this._freepool[t]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(t){this._freepool[++this._nextAvail]=t},n.freeArray=function(t){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var t=this._nextAvail>>1;t<=this._nextAvail;t++)this._dtor(this._freepool[t]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var e=arguments.length>0?arguments[0]:null;e&&I(14100);var n=e||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,t.prototype.destroy.call(this)},e}(Gl)),Hl=t("RecyclePool",function(t){function e(e,n,i){var r;(r=t.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=e,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=e();return r}Q(e,t);var n=e.prototype;return n.reset=function(){this._count=0},n.resize=function(t){if(t>this._data.length)for(var e=this._data.length;e<t;++e)this._data[e]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var e=0;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=0,this._count=0,t.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var t=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var e=t;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=t}},n.removeAt=function(t){if(!(t>=this._count)){var e=this._count-1,n=this._data[t];this._data[t]=this._data[e],this._data[e]=n,this._count-=1}},K(e,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}(Gl)),jl=t("CachedArray",function(t){function e(e,n){var i;return(i=t.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(e),i._initSize=e,i.length=0,i._compareFn=void 0!==n?n:function(t,e){return t-e},i}Q(e,t);var n=e.prototype;return n.push=function(t){this.array[this.length++]=t},n.pop=function(){return this.array[--this.length]},n.get=function(t){return this.array[t]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,t.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(t){for(var e=0;e<t.length;++e)this.array[this.length++]=t[e]},n.fastRemove=function(t){if(!(t>=this.length||t<0)){var e=--this.length;this.array[t]=this.array[e]}},n.indexOf=function(t){for(var e=0,n=this.length;e<n;++e)if(this.array[e]===t)return e;return-1},e}(Gl));t("memop",Object.freeze({__proto__:null,Pool:Ul,RecyclePool:Hl,CachedArray:jl}));var Wl=ee.fastRemoveAt;function ql(){}var Xl=function(){function t(){this.callback=ql,this.target=void 0,this.once=!1}var e=t.prototype;return e.set=function(t,e,n){this.callback=t||ql,this.target=e,this.once=!!n},e.reset=function(){this.target=void 0,this.callback=ql,this.once=!1},e.check=function(){return!(this.target instanceof _l&&!dl(this.target,!0))},t}(),Yl=new Ul((function(){return new Xl}),32),Kl=function(){function t(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var e=t.prototype;return e.removeByCallback=function(t){for(var e=0;e<this.callbackInfos.length;++e){var n=this.callbackInfos[e];n&&n.callback===t&&(n.reset(),Yl.free(n),Wl(this.callbackInfos,e),--e)}},e.removeByTarget=function(t){for(var e=0;e<this.callbackInfos.length;++e){var n=this.callbackInfos[e];n&&n.target===t&&(n.reset(),Yl.free(n),Wl(this.callbackInfos,e),--e)}},e.cancel=function(t){var e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:Wl(this.callbackInfos,t),Yl.free(e)),this.containCanceled=!0},e.cancelAll=function(){for(var t=0;t<this.callbackInfos.length;t++){var e=this.callbackInfos[t];e&&(e.reset(),Yl.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0},e.purgeCanceled=function(){for(var t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||Wl(this.callbackInfos,t);this.containCanceled=!1},e.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},t}(),Jl=new Ul((function(){return new Kl}),16),Ql=function(){function t(){this._callbackTable=wt(!0),this._offCallback=void 0}var e=t.prototype;return e.on=function(t,e,n,i){if(!this.hasEventListener(t,e,n)){var r=this._callbackTable[t];r||(r=this._callbackTable[t]=Jl.alloc());var o=Yl.alloc();o.set(e,n,i),r.callbackInfos.push(o)}return e},e.hasEventListener=function(t,e,n){var i=this._callbackTable&&this._callbackTable[t];if(!i)return!1;var r=i.callbackInfos;if(!e){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===e&&s.target===n)return!0}return!1},e.removeAll=function(t){var e=typeof t;if("string"===e||"number"===e){var n=this._callbackTable&&this._callbackTable[t];n&&(n.isInvoking?n.cancelAll():(n.clear(),Jl.free(n),delete this._callbackTable[t]))}else if(t)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===t&&r.cancel(a)}else r.removeByTarget(t)}},e.off=function(t,e,n){var i,r=this._callbackTable&&this._callbackTable[t];if(r){var o=r.callbackInfos;if(e)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===e&&s.target===n){r.cancel(a);break}}else this.removeAll(t)}null===(i=this._offCallback)||void 0===i||i.call(this)},e.emit=function(t,e,n,i,r,o){var a=this._callbackTable&&this._callbackTable[t];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(t,_,f),h.check()?f?_.call(f,e,n,i,r,o):_(e,n,i,r,o):this.off(t,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},e.clear=function(){for(var t in this._callbackTable){var e=this._callbackTable[t];e&&(e.clear(),Jl.free(e),delete this._callbackTable[t])}},e._registerOffCallback=function(t){this._offCallback=t},t}();function Zl(t){for(var e=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._callbackTable=wt(!0),e}Q(e,t);var n=e.prototype;return n.once=function(t,e,n){return this.on(t,e,n,!0)},n.targetOff=function(t){this.removeAll(t)},e}(t),n=Ql.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in e.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(e.prototype,o,a)}}return e}var $l=t("EventTarget",Zl((function(){})));c.EventTarget=$l;var tu,eu,nu,iu,ru,ou,au,su=new(function(){function t(){this._finalizationRegistry=null}var e=t.prototype;return e.registerGCObject=function(t){return t},e.unregisterGCObject=function(){},e.init=function(){},e.finalizationRegistryCallback=function(t){t.isValid&&t.destroy()},e.destroy=function(){},t}()),cu=fc("cc.GCObject")(tu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return e=t.call.apply(t,[this].concat(i))||this,su.registerGCObject(it(e))||it(e)}Q(e,t);var n=e.prototype;return n.equals=function(t){return!!t&&t===this},n.destroy=function(){return su.unregisterGCObject(this),t.prototype.destroy.call(this)},e}(_l))||tu;!function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(eu||(eu={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(nu||(nu={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(iu||(iu={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS"}(ru||(ru={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(ou||(ou={})),function(t){t.WEBP="WEBP",t.IMAGE_BITMAP="IMAGE_BITMAP",t.WEB_VIEW="WEB_VIEW",t.VIDEO_PLAYER="VIDEO_PLAYER",t.SAFE_AREA="SAFE_AREA",t.INPUT_TOUCH="INPUT_TOUCH",t.EVENT_KEYBOARD="EVENT_KEYBOARD",t.EVENT_MOUSE="EVENT_MOUSE",t.EVENT_TOUCH="EVENT_TOUCH",t.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(au||(au={}));var lu,uu,hu,_u,fu=new(function(t){function e(){var e,n,i;(i=t.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(e=o.getBattery)||void 0===e||e.call(o).then((function(t){i._battery=t})),i.networkType=iu.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?ou.MOBILE_BROWSER:ou.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:nu.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,_=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);_&&(c=!0,u=_[1]||"",h=parseInt(u)||0),(_=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=_[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var f=ru.UNKNOWN;-1!==o.appVersion.indexOf("Win")?f=ru.WINDOWS:l?f=ru.IOS:-1!==o.appVersion.indexOf("Mac")?f=ru.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?f=ru.LINUX:c?f=ru.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(f=ru.LINUX),i.os=f,i.osVersion=u,i.osMainVersion=h,i.browserType=eu.UNKNOWN;var d=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),p=d?d[0].toLowerCase():ru.UNKNOWN;("safari"===p&&c||"qq"===p&&/android.*applewebkit/i.test(a))&&(p=eu.ANDROID);var m={micromessenger:eu.WECHAT,wechat:eu.WECHAT,weixin:eu.WECHAT,trident:eu.IE,edge:eu.EDGE,"360 aphone":eu.BROWSER_360,mxbrowser:eu.MAXTHON,"opr/":eu.OPERA,ubrowser:eu.UC,huaweibrowser:eu.HUAWEI};i.browserType=m[p]||p,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(t){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(t){x=!0,null==t||t.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,A=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[au.WEBP]=g,n[au.IMAGE_BITMAP]=x,n[au.WEB_VIEW]=!0,n[au.VIDEO_PLAYER]=!0,n[au.SAFE_AREA]=!1,n[au.INPUT_TOUCH]=S,n[au.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[au.EVENT_MOUSE]=A,n[au.EVENT_TOUCH]=S||A,n[au.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}Q(e,t);var n=e.prototype;return n._registerEvent=function(){var t,e=this;t=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,e.emit("hide"))},r=function(t,i,r,o,a){n&&(n=!1,e.emit("show",t,i,r,o,a))};if(t)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(e){var n=document[t];(n=n||e.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(t){return this._featureMap[t]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(t){window.open(t)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},e}($l)),du=/(\.[^\.\/\?\\]*)(\?.*)?$/,pu=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,mu=/[^\.\/]+\/\.\.\//;function vu(){for(var t="",e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];t=(t+(""===t?"":"/")+a).replace(/(\/|\\\\)$/,"")}return t}function gu(t){var e=du.exec(t);return e?e[1]:""}function yu(t){if(t){var e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function xu(t,e){var n=t.indexOf("?");n>0&&(t=t.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!i)return t;var r=i[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?r.substring(0,r.length-e.length):r}function Su(t){var e=pu.exec(t);return e?e[2]:""}function Au(t,e){e=e||"";var n=t.indexOf("?"),i="";return n>0&&(i=t.substring(n),t=t.substring(0,n)),(n=t.lastIndexOf("."))<0?t+e+i:t.substring(0,n)+e+i}function Cu(t,e,n){if(0===e.indexOf("."))return Au(t,e);var i=t.indexOf("?"),r="",o=n?gu(t):"";return i>0&&(r=t.substring(i),t=t.substring(0,i)),i=(i=t.lastIndexOf("/"))<=0?0:i+1,t.substring(0,i)+e+o+r}function bu(t){var e=t=String(t);do{e=t,t=t.replace(mu,"")}while(e.length!==t.length);return t}function Tu(t){return t.replace(/[\/\\]$/,"")}function Eu(){return fu.os===ru.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:vu,extname:gu,mainFileName:yu,basename:xu,dirname:Su,changeExtname:Au,changeBasename:Cu,_normalize:bu,stripSep:Tu,getSeperator:Eu}));var wu,Pu,Iu,Ru=t("Asset",fc("cc.Asset")((_u=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).loaded=!0,at(e,"_native",hu,it(e)),e._nativeUrl="",e._file=null,e._ref=0,Object.defineProperty(it(e),"_uuid",{value:"",writable:!0}),e}Q(e,t),e.deserialize=function(t){return c.deserialize(t)};var n=e.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(t,e){void 0===e&&(e=!0),this._native=!1!==e?t||"":"/"+t},n.addRef=function(){return this._ref++,this},n.decRef=function(t){return void 0===t&&(t=!0),this._ref>0&&this._ref--,t&&c.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(t){t&&(this._uuid=t),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return A(N(12101,this._uuid)),t.prototype.destroy.call(this)},K(e,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=Nl(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=Nl(this._uuid,{__nativeName__:t,nativeExt:gu(t),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(t){this._file=t}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),e}(Zl(cu)),hu=st((uu=_u).prototype,"_native",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),st(uu.prototype,"_nativeAsset",[vc],Object.getOwnPropertyDescriptor(uu.prototype,"_nativeAsset"),uu.prototype),lu=uu))||lu);Ru.prototype.createNode=null,c.Asset=Ru;var Du=t("Script",fc("cc.Script")(wu=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(Ru))||wu);c._Script=Du;var Mu=t("JavaScript",fc("cc.JavaScript")(Pu=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(Du))||Pu);c._JavaScript=Mu;var Bu,Ou,Nu,Lu,Fu,zu,Vu,ku,Gu,Uu,Hu,ju=t("TypeScript",fc("cc.TypeScript")(Iu=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(Du))||Iu);c._TypeScript=ju;var Wu,qu,Xu,Yu,Ku=new pt("Comp"),Ju=_l.Flags.IsOnLoadCalled,Qu=t("Component",(Bu=fc("cc.Component"),Ou=Bc(),Nu=Xc(Du),Lu=Oc(),Bu((Hu=Uu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"node",Vu,it(e)),at(e,"_enabled",ku,it(e)),at(e,"__prefab",Gu,it(e)),e._sceneGetter=null,e._id=Ku.getNewId(),e}Q(e,t);var n=e.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(t){return this.node.addComponent(t)},n.getComponent=function(t){return this.node.getComponent(t)},n.getComponents=function(t){return this.node.getComponents(t)},n.getComponentInChildren=function(t){return this.node.getComponentInChildren(t)},n.getComponentsInChildren=function(t){return this.node.getComponentsInChildren(t)},n.destroy=function(){return!!t.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&c.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),c.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(t){return t||(t=c.instantiate._clone(this,this)),t&&(t.node=null),t},n.schedule=function(t,e,n,i){void 0===e&&(e=0),void 0===n&&(n=c.macro.REPEAT_FOREVER),void 0===i&&(i=0),O(t,1619),O((e=e||0)>=0,1620),n=Number.isNaN(n)?c.macro.REPEAT_FOREVER:n,i=i||0;var r=c.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(t,this,e,n,i,o)},n.scheduleOnce=function(t,e){void 0===e&&(e=0),this.schedule(t,0,0,e)},n.unschedule=function(t){t&&c.director.getScheduler().unschedule(t,this)},n.unscheduleAllCallbacks=function(){c.director.getScheduler().unscheduleAllForTarget(this)},K(e,[{key:"name",get:function(){if(this._name)return this._name;var t=Pt(this),e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),this.node?this.node.name+"<"+t+">":t},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){var e=c.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Ju}}]),e}(_l),Uu.system=null,st((zu=Hu).prototype,"__scriptAsset",[Ou,Nu,Lu,Uc],Object.getOwnPropertyDescriptor(zu.prototype,"__scriptAsset"),zu.prototype),Vu=st(zu.prototype,"node",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ku=st(zu.prototype,"_enabled",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Gu=st(zu.prototype,"__prefab",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fu=zu))||Fu)),Zu=Qu.prototype;Zu.update=null,Zu.lateUpdate=null,Zu.__preload=null,Zu.onLoad=null,Zu.start=null,Zu.onEnable=null,Zu.onDisable=null,Zu.onDestroy=null,Zu.onFocusInEditor=null,Zu.onLostFocusInEditor=null,Zu.resetInEditor=null,Zu._getLocalBounds=null,Zu.onRestore=null,Qu._requireComponent=null,Qu._executionOrder=0,Ct(Qu,"_registerEditorProps",(function(t,e){var n=e.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),t._requireComponent=n);var i=e.executionOrder;i&&"number"==typeof i&&(t._executionOrder=i)})),c.Component=Qu;var $u,th=t("MissingScript",fc("cc.MissingScript")(Wu=wc()((Yu=function(t){function e(){var e;return at(e=t.call(this)||this,"_$erialized",Xu,it(e)),e}return Q(e,t),e.safeFindClass=function(t){var e=Qt(t);if(e)return e;c.deserialize.reportMissingClass(t)},e.prototype.onLoad=function(){I(4600,this.node.name)},e}(Qu),Xu=st((qu=Yu).prototype,"_$erialized",[yc,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wu=qu))||Wu)||Wu);c._MissingScript=th;try{var eh=th.__values__;0!==eh.length&&"_$erialized"===eh[eh.length-1]||(x("The '_$erialized' prop in MissingScript is missing. Please contact jare."),x("    Error props: ['"+eh+"']"))}catch(qo){x("Error when checking MissingScript 5, "+qo)}!function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE",t[t.AUTO=13]="AUTO"}($u||($u={}));var nh,ih={auto:$u.AUTO,landscape:$u.LANDSCAPE,portrait:$u.PORTRAIT};!function(t){t[t.Unknown=0]="Unknown",t[t.SubFrame=1]="SubFrame",t[t.BrowserWindow=2]="BrowserWindow",t[t.Fullscreen=3]="Fullscreen"}(nh||(nh={}));var rh=new(function(t){function e(){var e,n,i,r,o,a;(e=t.call(this)||this).isFrameRotated=!1,e.handleResizeEvent=!0,e._gameFrame=void 0,e._gameContainer=void 0,e._gameCanvas=void 0,e._isProportionalToFrame=!1,e._cachedFrameStyle={width:"0px",height:"0px"},e._cachedContainerStyle={width:"0px",height:"0px"},e._cbToUpdateFrameBuffer=void 0,e._supportFullScreen=!1,e._touchEventName=void 0,e._onFullscreenChange=void 0,e._onFullscreenError=void 0,e._orientationChangeTimeoutId=-1,e._cachedFrameSize=new ti(0,0),e._exactFitScreen=!1,e._fn={},e._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],e._resolutionScale=1,e._orientation=$u.AUTO,e._gameFrame=document.getElementById("GameDiv"),e._gameContainer=document.getElementById("Cocos3dGameContainer"),e._gameCanvas=document.getElementById("GameCanvas"),e._gameFrame||(e._gameFrame=document.createElement("div"),e._gameFrame.setAttribute("id","GameDiv"),null===(n=e._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(e._gameFrame,e._gameCanvas),e._gameFrame.appendChild(e._gameCanvas)),e._gameContainer||(e._gameContainer=document.createElement("div"),e._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=e._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(e._gameContainer,e._gameCanvas),e._gameContainer.appendChild(e._gameCanvas));for(var s=e._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)e._fn[s[0][l]]=a[l];break}return e._supportFullScreen=void 0!==e._fn.requestFullscreen,e._touchEventName="ontouchstart"in window?"touchend":"mousedown",e._registerEvent(),e}Q(e,t);var n=e.prototype;return n.init=function(t,e){this._cbToUpdateFrameBuffer=e,this.orientation=ih[t.configOrientation],this._exactFitScreen=t.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var t=this;return new Promise((function(e,n){t.isFullScreen?e():(t._cachedFrameSize=t.windowSize,t._doRequestFullScreen().then((function(){e()})).catch((function(){var i=t._getFullscreenTarget();i?i.addEventListener(t._touchEventName,(function(){t._doRequestFullScreen().then((function(){e()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var t=this;return new Promise((function(e,n){var i=document[t._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){t.windowSize=t._cachedFrameSize,e()})).catch(n):(t.windowSize=t._cachedFrameSize,e())}))},n._registerEvent=function(){var t=this;document.addEventListener(this._fn.fullscreenerror,(function(){var e;null===(e=t._onFullscreenError)||void 0===e||e.call(t)})),window.addEventListener("resize",(function(){t.handleResizeEvent&&t._resizeFrame()})),"function"==typeof window.matchMedia&&function e(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){t.emit("window-resize"),e()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==t._orientationChangeTimeoutId&&clearTimeout(t._orientationChangeTimeoutId),t._orientationChangeTimeoutId=setTimeout((function(){t.handleResizeEvent&&(t._updateFrameState(),t._resizeFrame(),t.emit("orientation-change"),t._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var e;null===(e=t._onFullscreenChange)||void 0===e||e.call(t),t.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(t){var e=t.clone(),n=this.devicePixelRatio;return e.width/=n,e.height/=n,e},n._resizeFrame=function(t){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===nh.SubFrame){if(!t)return void this._updateContainer();this._gameFrame.style.width=t.width+"px",this._gameFrame.style.height=t.height+"px"}else{var e=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+e+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=e+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=e+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var t=this._windowType;return t===nh.Fullscreen?document[this._fn.fullscreenElement]:t===nh.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var t=this;return new Promise((function(e,n){if(t._supportFullScreen){var i=t._getFullscreenTarget();if(i){t._onFullscreenChange=void 0,t._onFullscreenError=void 0;var r=i[t._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(e).catch(n):(t._onFullscreenChange=e,t._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var t=this.orientation,e=window.innerWidth>window.innerHeight;this.isFrameRotated=fu.isMobile&&(e&&t===$u.PORTRAIT||!e&&t===$u.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void I(9201);var t,e,n=c.view.getDesignResolutionSize(),i=this._gameFrame,r=i.clientWidth,o=i.clientHeight,a=n.width,s=n.height,l=r/a,u=o/s,h=this._gameContainer.style;l<u?(t=r,e=s*l):(t=a*u,e=o),h.width=t+"px",h.height=e+"px"}else{var _=this._gameContainer.style;_.width="100%",_.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else I(9201)},K(e,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var t;return Math.min(null!==(t=window.devicePixelRatio)&&void 0!==t?t:1,2)}},{key:"windowSize",get:function(){var t=this._windowSizeInCssPixels,e=this.devicePixelRatio;return t.width*=e,t.height*=e,t},set:function(t){this._windowType===nh.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(t)):I(9202)}},{key:"resolution",get:function(){var t=this.windowSize,e=this.resolutionScale;return new ti(t.width*e,t.height*e)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(t){var e;t!==this._resolutionScale&&(this._resolutionScale=t,null===(e=this._cbToUpdateFrameBuffer)||void 0===e||e.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(t){this._orientation!==t&&(this._orientation=t,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(t){this._isProportionalToFrame!==t&&(this._isProportionalToFrame=t,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new ti(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(I(9201),new ti(0,0));var t,e,n;switch(this._windowType){case nh.SubFrame:return this._gameFrame?new ti(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(I(9201),new ti(0,0));case nh.Fullscreen:return t=this._getFullscreenTarget(),e=this.isFrameRotated?t.clientHeight:t.clientWidth,n=this.isFrameRotated?t.clientWidth:t.clientHeight,new ti(e,n);case nh.BrowserWindow:return e=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new ti(e,n);case nh.Unknown:default:return new ti(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?nh.Fullscreen:this._gameFrame?this._exactFitScreen?nh.BrowserWindow:nh.SubFrame:(I(9201),nh.Unknown)}}]),e}($l)),oh=function(){function t(){}var e=t.prototype;return e._init=function(t){rh.init(t,(function(){var t,e=c.director;(null===(t=e.root)||void 0===t?void 0:t.pipeline)?e.root.pipeline.pipelineSceneData.shadingScale=rh.resolutionScale:I(1220)}))},e.fullScreen=function(){return rh.isFullScreen},e.requestFullScreen=function(t,e,n){return arguments.length>0&&I(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),rh.requestFullScreen().then((function(){null==e||e()})).catch((function(t){console.error(t),null==n||n()}))},e.exitFullScreen=function(){return rh.exitFullScreen()},e.autoFullScreen=function(t,e){var n;null===(n=this.requestFullScreen(t,e))||void 0===n||n.catch((function(){}))},e.disableAutoFullScreen=function(){},K(t,[{key:"devicePixelRatio",get:function(){return rh.devicePixelRatio}},{key:"windowSize",get:function(){return rh.windowSize},set:function(t){rh.windowSize=t}},{key:"resolution",get:function(){return rh.resolution}},{key:"supportsFullScreen",get:function(){return rh.supportFullScreen}}]),t}(),ah=t("screen",new oh);c.screen=ah;var sh=t("sys",{Feature:au,hasFeature:function(t){return fu.hasFeature(t)},NetworkType:iu,Language:nu,OS:ru,Platform:ou,BrowserType:eu,isNative:fu.isNative,isBrowser:fu.isBrowser,isMobile:fu.isMobile,isLittleEndian:fu.isLittleEndian,platform:fu.platform,language:fu.language,languageCode:fu.nativeLanguage,os:fu.os,osVersion:fu.osVersion,osMainVersion:fu.osMainVersion,browserType:fu.browserType,browserVersion:fu.browserVersion,windowPixelResolution:ah.windowSize,capabilities:{canvas:!0,opengl:!0,webp:fu.hasFeature(au.WEBP),imageBitmap:fu.hasFeature(au.IMAGE_BITMAP),touches:fu.hasFeature(au.INPUT_TOUCH),mouse:fu.hasFeature(au.EVENT_MOUSE),keyboard:fu.hasFeature(au.EVENT_KEYBOARD),accelerometer:fu.hasFeature(au.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return fu.networkType},getBatteryLevel:function(){return fu.getBatteryLevel()},garbageCollect:function(){fu.triggerGC()},isObjectValid:function(t){return null!=t},dump:function(){var t="";t+="isMobile : "+this.isMobile+"\r\n",t+="language : "+this.language+"\r\n",t+="browserType : "+this.browserType+"\r\n",t+="browserVersion : "+this.browserVersion+"\r\n",t+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",t+="os : "+this.os+"\r\n",t+="osVersion : "+this.osVersion+"\r\n",t+="platform : "+this.platform+"\r\n",g(t+="Using "+(c.game.renderType===c.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(t){fu.openURL(t)},now:function(){return fu.now()},restartVM:function(){fu.restartJSVM()},getSafeAreaRect:function(){var t=c.view,e=rh.safeAreaEdge,n=rh.windowSize,i=new Xn(e.left,e.bottom),r=new Xn(n.width-e.right,n.height-e.top);t._convertToUISpace(i),t._convertToUISpace(r);var o=i.x,a=i.y,s=r.x-i.x,l=r.y-i.y;return new ni(o,a,s,l)}});!function(){try{var t=sh.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){var e=function(){I(5200)};sh.localStorage={getItem:e,setItem:e,clear:e,removeItem:e}}sh.__isWebIOS14OrIPadOS14Env=(sh.os===ru.IOS||sh.os===ru.OSX)&&fu.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),c.sys=sh;var ch=t("serializeTag",Symbol("[[Serialize]]")),lh=t("deserializeTag",Symbol("[[Deserialize]]")),uh=function(){function t(t,e){this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=e}return K(t,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),t}();function hh(t){var e=t;return{chunks:e.chunks,document:e.document}}function _h(t){if(t.length<16)throw new fh(N(13102));var e=new DataView(t.buffer,t.byteOffset,t.byteLength);if(1313817411!==e.getUint32(0,!0))throw new fh(N(13100));var n=e.getUint32(4,!0);if(1!==n)throw new fh(N(13101,n));if(e.getUint32(8,!0)!==e.byteLength)throw new fh(N(13102));var i=12,r=e.getUint32(i,!0);i+=4;var o=new Uint8Array(e.buffer,i+e.byteOffset,r);i+=r;var a,s=function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);if("Buffer"in globalThis)return globalThis.Buffer.from(t.buffer,t.byteOffset,t.byteLength).toString();throw new Error(N(13104))}(o);try{a=JSON.parse(s)}catch(t){throw new fh(t)}for(var c=[];i<e.byteLength;){i%8!=0&&(i+=8-i%8);var l=e.getUint32(i,!0);i+=4,c.push(new Uint8Array(e.buffer,i+e.byteOffset,l)),i+=l}if(i!==e.byteLength)throw new fh(N(13102));return new uh(a,c)}var fh=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(nt(Error));function dh(t,e,n,i,r){if(e instanceof c.ValueType){r||t.push("if(prop){");var o=Pt(e);t.push("s._deserializeFastDefinedObject(o"+n+",prop,"+o+");"),r||t.push("}else o"+n+"=null;")}else t.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+i+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function t(){this._viewOrPaddings=[],this._length=0}var e=t.prototype;e.alignAs=function(t){if(0!==t){var e=this._length%t;if(0!==e){var n=t-e;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},e.append=function(t){var e=this._length;return this._viewOrPaddings.push(t),this._length+=t.byteLength,e},e.get=function(){var t=new Uint8Array(this._length),e=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?e+=n:(t.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),e),e+=n.byteLength)})),t},K(t,[{key:"byteLength",get:function(){return this._length}}])}(),c.internal.parseCCONJson=hh,c.internal.decodeCCONBinary=_h,c.internal.CCON=uh;var ph="$_$default",mh="$_$formerlySerializedAs",vh=function(t){function e(){return t.call(this,(function(t){t.clear()}),1)||this}return Q(e,t),e.prototype.get=function(t,e,n,i,r){var o=this._get();return o?(o.reset(t,e,n,i,r),o):new gh(t,e,n,i,r)},e}(te),gh=function(){function t(t,e,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=e,this._reportMissingClass=n,this._onDereferenced=null==e?void 0:e.onDereferenced}var e=t.prototype;return e.reset=function(t,e,n,i){this.result=t,this.customEnv=i,this._classFinder=e,this._reportMissingClass=n,this._onDereferenced=null==e?void 0:e.onDereferenced},e.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},e.deserialize=function(t){var e,n=!1;t instanceof uh?(n=!0,e=t.document,t.chunks.length>0&&(t.chunks.length,this._mainBinChunk=t.chunks[0])):e=t,this._serializedData=e,this._context={fromCCON:n};var i=Array.isArray(e)?e[0]:e;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},e._deserializeObject=function(t,e,n,i){switch(t.__type__){case"TypedArray":return this._deserializeTypedArrayView(t);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(t);default:return t.__type__?this._deserializeTypeTaggedObject(t,e,n,i):Array.isArray(t)?this._deserializeArray(t):this._deserializePlainObject(t)}},e._deserializeTypedArrayView=function(t){return globalThis[t.ctor].from(t.array)},e._deserializeTypedArrayViewRef=function(t){var e=t.offset,n=t.length,i=t.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+e,n)},e._deserializeArray=function(t){for(var e,n=new Array(t.length),i=0;i<t.length;i++)"object"==typeof(e=t[i])&&e?this._deserializeAndAssignField(n,e,""+i)&&(n[i]=null):n[i]=e;return n},e._deserializePlainObject=function(t){var e={};return this._fillPlainObject(e,t),e},e._deserializeTypeTaggedObject=function(t,e,n,i){var r=this,o=t.__type__,a=this._classFinder(o,t,n,i);if(!a)return this._classFinder===Qt&&this._reportMissingClass(o),null;var s=function(t){var n=new t;return e>=0&&(r.deserializedList[e]=n),n}(a);return this._deserializeInto(t,s,a),s},e._deserializeInto=function(t,e,n,i){void 0===i&&(i=!1),i||!e[lh]?e._deserialize?e._deserialize(t.content,this):c.Class._isCCClass(n)?this._deserializeFireClass(e,t,n):this._deserializeFastDefinedObject(e,t,n):this._runCustomizedDeserialize(t,e,n)},e._runCustomizedDeserialize=function(t,e,n){var i=this,r={readProperty:function(e){var n=t[e];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(t,e,n,!0)},readSuper:function(){var r=kt(n);r&&i._deserializeInto(t,e,r)}};e[lh](r,this._context)},e._deserializeFireClass=function(t,e,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(t,e){for(var n=Ie(e),i=e.__values__,r=["var prop;"],o=he.test($t(e)),a=0;a<i.length;a++){var s=i[a],l=void 0,u=void 0;Ze.IDENTIFIER_RE.test(s)?(u='"'+s+'"',l="."+s):l="["+(u=Ze.escapeForJS(s))+"]";var h=l;if(n[s+mh]){var _=n[s+mh];h=Ze.IDENTIFIER_RE.test(_)?"."+_:"["+Ze.escapeForJS(_)+"]"}r.push("prop=d"+h+";"),r.push('if(typeof prop!=="undefined"){');var f=Ze.getDefault(n[s+ph]);if(o){var d=void 0,p=n[s+"$_$type"];if(void 0===f&&p)d=p instanceof De;else{var m=typeof f;d="string"===m||"number"===m||"boolean"===m}d?r.push("o"+l+"=prop;"):dh(r,f,l,u,!0)}else r.push('if(typeof prop!=="object"){o'+l+"=prop;}else{"),dh(r,f,l,u,!1),r.push("}");r.push("}")}return(c.js.isChildClassOf(e,c._BaseNode)||c.js.isChildClassOf(e,c.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,n);try{if(n===th){var r=n.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(x("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),x("    Error props: ['"+r+"']. Please contact jare."));var o=i;i=function(t,e,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||x("Unable to load previously serialized data. "+JSON.stringify(n))}catch(t){x("Error when checking MissingScript 7, "+t)}o(t,e,n,i)}}}catch(t){x("Error when checking MissingScript 6, "+t)}Ct(n,"__deserialize__",i,!0)}i(this,t,e,n)},e._deserializeAndAssignField=function(t,e,n){var i=e.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)t[n]=r;else{var o,a=this._serializedData[i];t[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,t,n)}}else{var s=e.__uuid__;if(s){var c=e.__expectedType__;this.result.push(t,n,s,c)}else t[n]=this._deserializeObject(e,-1)}return!1},e._deserializeObjectField=function(t){var e=t.__id__;if("number"==typeof e){var n=this.deserializedList[e];if(n)return n;var i=this._serializedData[e];return this._deserializeObject(i,e,void 0,void 0)}if(t.__uuid__)throw t.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(t,-1)},e._fillPlainObject=function(t,e){for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];"object"!=typeof i?"__type__"!==n&&(t[n]=i):i?this._deserializeAndAssignField(t,i,n)&&(t[n]=null):t[n]=null}},e._deserializeFastDefinedObject=function(t,e,n){if(n===c.Vec2)return t.x=e.x||0,void(t.y=e.y||0);if(n===c.Vec3)return t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if(n!==c.Color){if(n===c.Size)return t.width=e.width||0,void(t.height=e.height||0);for(var i=Ie(n),r=n.__values__,o=0;o<r.length;o++){var a=r[o],s=e[a];void 0!==s||e.hasOwnProperty(a)||(s=Ze.getDefault(i[a+ph])),"object"!=typeof s?t[a]=s:s?this._deserializeAndAssignField(t,s,a):t[a]=null}}else{t.r=e.r||0,t.g=e.g||0,t.b=e.b||0;var l=e.a;t.a=void 0===l?255:l}},t}();gh.pool=new vh;var yh=[Xn,Pn,Qn,Nn,En,ti,ni,Hn];function xh(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}var Sh=[function(t,e){t.x=e[1],t.y=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.z=e[3]},xh,xh,function(t,e){t._val=e[1]},function(t,e){t.width=e[1],t.height=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},function(t,e){Hn.fromArray(t,e,1)}],Ah=t("Details",function(){function t(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var e=t.prototype;return e.init=function(t){t?(this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},e.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},e.push=function(t,e,n,i){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(n),this.uuidTypeList.push(i||"")},t}());function Ch(t,e){for(var n=t[4][e[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=e[c];for(;c<e.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,Ih[u])(t,r,l,e[c])}return r}function bh(t,e,n){var i=new e;return i._deserialize?i._deserialize(n,t[0]):D(5303,Pt(e)),i}function Th(t,e,n,i){i>=0?e[n]=t[5][i]:t[7][3*~i]=e}function Eh(t){return function(e,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)t(e,r,o,r[o])}}function wh(t,e,n,i){e[n]=null,t[8][i]=e}function Ph(t,e,n,i){e[n]=Ch(t,i)}Ah.pool=new te((function(t){t.reset()}),5),Ah.pool.get=function(){return this._get()||new Ah};var Ih=new Array(13);function Rh(t,e,n){return t||n(e),Object}function Dh(t,e,n,i,r,o,a){var s=t(e);if(!s){if(r)return void(n[i]=function(e,n,i){return function(){var r=t(i)||Rh(o,i,a);return e[n]=r,new r}}(n,i,e));s=Rh(o,e,a)}n[i]=s}function Mh(t,e,n,i){for(var r=n||Qt,o=t[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Dh(r,s[0],s,0,e,n,i):Dh(r,s,o,a,e,n,i)}}function Bh(t){var e=t[4];if(e)for(var n=t[3],i=0;i<e.length;++i){var r=e[i];r[0]=n[r[0]]}}function Oh(t,e,n){"string"==typeof t&&(t=JSON.parse(t));var i,r=!e;if(e=e||Ah.pool.get(),function(t){if(Array.isArray(t)){var e=t[0];return"number"==typeof e||e instanceof Nh}return!1}(t)){e.init(t),n=n||{};var o,a=t[0],s=!1;if("object"==typeof a&&(s=a.preprocessed,a=a.version),a<1)throw new Error(N(5304,a));n._version=a,n.result=e,t[0]=n,s||(Mh(t,!1,n.classFinder,null!==(o=n.reportMissingClass)&&void 0!==o?o:Oh.reportMissingClass),Bh(t)),c.game._isCloning=!0;var l=t[5],u=function(t){var e=t[5],n=t[6],i=0===n?0:n.length,r=e[e.length-1],o=e.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)e[a]=Ch(t,e[a]);for(var s=t[3],c=0;c<i;++c,++a){var l=n[c],u=e[a];if(l>=0){var h=s[l];e[a]=bh(t,h,u)}else(0,Ih[l=~l])(t,e,a,u)}return r}(t);c.game._isCloning=!1,t[7]&&function(t,e,n){for(var i=t.length-1,r=0,o=3*t[i];r<o;r+=3){var a=t[r],s=e[t[r+2]],c=t[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=e[t[r]],u=e[t[r+2]],h=t[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(t[7],l,t[2]),function(t){for(var e=t[5],n=t[2],i=t[1],r=t[8],o=t[9],a=t[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=e[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(t),i=l[u]}else i=function(t,e,n){var i,r=(n=n||{}).classFinder||Qt,o=n.createAssetRefs||sh.platform===ou.EDITOR_CORE,a=n.customEnv,s=n.ignoreEditorOnly,l=null!==(i=n.reportMissingClass)&&void 0!==i?i:c.deserialize.reportMissingClass;e.init();var u=gh.pool.get(e,r,l,a,s);c.game._isCloning=!0;var h=u.deserialize(t);return c.game._isCloning=!1,gh.pool.put(u),o&&e.assignAssetsBy(EditorExtends.serialize.asAsset),h}(t,e,n);return r&&Ah.pool.put(e),i}Ih[0]=function(t,e,n,i){e[n]=i},Ih[1]=Th,Ih[2]=Eh(Th),Ih[3]=Eh(wh),Ih[4]=Ph,Ih[5]=function(t,e,n,i){Sh[i[0]](e[n],i)},Ih[6]=wh,Ih[7]=function(t,e,n,i){e[n].set(i)},Ih[8]=function(t,e,n,i){var r=new yh[i[0]];Sh[i[0]](r,i),e[n]=r},Ih[9]=Eh(Ph),Ih[10]=function(t,e,n,i){var r=t[3][i[0]];e[n]=bh(t,r,i[1])},Ih[11]=function(t,e,n,i){var r=i[0];e[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,Ih[s])(t,r,a,c)}},Ih[12]=function(t,e,n,i){var r=i[0];e[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,Ih[s])(t,r,o,a)}},Oh.Details=Ah,Oh.reportMissingClass=function(t){D(5302,t)};var Nh=function(t){this.preprocessed=!0,this.version=t};function Lh(t,e,n){return[1,0,0,[t],0,n?[e,-1]:[e],[0],0,[],[],[]]}c.deserialize=Oh;var Fh,zh,Vh,kh,Gh,Uh,Hh,jh,Wh,qh,Xh,Yh=_l.Flags.Destroyed,Kh=_l.Flags.PersistentMask,Jh=[];function Qh(t){var e;if(t instanceof _l){if(t._instantiate)return c.game._isCloning=!0,e=t._instantiate(null,!0),c.game._isCloning=!1,e;if(t instanceof c.Asset)throw new TypeError(N(6903))}return c.game._isCloning=!0,e=Zh(t),c.game._isCloning=!1,e}function Zh(t,e){var n;$h(t,n=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),e);for(var i=0,r=Jh.length;i<r;++i)Jh[i]._iN$t=null;return Jh.length=0,n}function $h(t,e,n){ne.value(t,"_iN$t",e,!0),Jh.push(t);var i=t.constructor;if(c.Class._isCCClass(i))!function(t,e,n,i){for(var r=t.__values__,o=0;o<r.length;o++){var a=r[o],s=e[a];if("object"==typeof s&&s){var c=n[a];c instanceof le&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||t_(s,i)}else n[a]=s}}(i,t,e,n);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var o=t[r];if("object"==typeof o&&o){if(o===e)continue;e[r]=o._iN$t||t_(o,n)}else e[r]=o}t instanceof _l&&(e._objFlags&=Kh)}function t_(t,e){if(t instanceof le)return t.clone();if(t instanceof c.Asset)return t;var n;if(ArrayBuffer.isView(t)){var i=t.length;n=new t.constructor(i),t._iN$t=n,Jh.push(t);for(var r=0;r<i;++r)n[r]=t[r];return n}if(Array.isArray(t)){var o=t.length;n=new Array(o),t._iN$t=n,Jh.push(t);for(var a=0;a<o;++a){var s=t[a];n[a]="object"==typeof s&&s?s._iN$t||t_(s,e):s}return n}if(t._objFlags&Yh)return null;var l=t.constructor;if(c.Class._isCCClass(l)){if(e)if(e instanceof c.Component){if(t instanceof c._BaseNode||t instanceof c.Component)return t}else if(e instanceof c._BaseNode)if(t instanceof c._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof c.Component&&t.node&&!t.node.isChildOf(e))return t;n=new l}else if(l===Object)n={};else{if(l)return t;n=Object.create(null)}return $h(t,n,e),n}function e_(t,e){return(e<<3)+t}function n_(t){return r_[t]}function i_(t){switch(t){case qh.Uint8:return Uint8Array;case qh.Uint16:return Uint16Array;case qh.Uint32:return Uint32Array;case qh.Int8:return Int8Array;case qh.Int16:return Int16Array;case qh.Int32:return Int32Array;case qh.Float32:return Float32Array;case qh.Float64:return Float64Array}}Qh._clone=Zh,c.instantiate=Qh,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(qh||(qh={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(Xh||(Xh={})),t("CompactValueTypeArray",fc("cc.CompactValueTypeArray")((jh=Hh=function(){function t(){at(this,"_byteOffset",Vh,this),at(this,"_unitCount",kh,this),at(this,"_unitElement",Gh,this),at(this,"_length",Uh,this)}return t.lengthFor=function(t,e,n){return n_(e).requiredUnits*t.length*i_(n).BYTES_PER_ELEMENT},t.compress=function(e,n,i,r,o,a){for(var s=n_(n),c=i_(i),l=s.requiredUnits*e.length,u=new c(r,o,l),h=0;h<e.length;++h)s.compress(u,h,e[h]);var _=new t;return _._unitElement=e_(i,n),_._byteOffset=a,_._unitCount=l,_._length=e.length,_},t.prototype.decompress=function(t){for(var e,n={storageUnit:7&(e=this._unitElement),elementType:e>>3},i=n.storageUnit,r=n_(n.elementType),o=new(i_(i))(t,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},t}(),Hh.StorageUnit=qh,Hh.ElementType=Xh,Vh=st((zh=jh).prototype,"_byteOffset",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kh=st(zh.prototype,"_unitCount",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gh=st(zh.prototype,"_unitElement",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e_(qh.Uint8,Xh.Scalar)}}),Uh=st(zh.prototype,"_length",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fh=zh))||Fh);var r_=((Wh={})[Xh.Scalar]={requiredUnits:1,compress:function(t,e,n){t[e]=n},decompress:function(t,e){return t[e]}},Wh[Xh.Vec2]={requiredUnits:2,compress:function(t,e,n){t[2*e]=n.x,t[2*e+1]=n.y},decompress:function(t,e){return new Pn(t[2*e],t[2*e+1])}},Wh[Xh.Vec3]={requiredUnits:3,compress:function(t,e,n){t[3*e]=n.x,t[3*e+1]=n.y,t[3*e+2]=n.z},decompress:function(t,e){return new Pn(t[3*e],t[3*e+1],t[3*e+2])}},Wh[Xh.Vec4]={requiredUnits:4,compress:function(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:function(t,e){return new Qn(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Wh[Xh.Quat]={requiredUnits:4,compress:function(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:function(t,e){return new Nn(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Wh[Xh.Mat4]={requiredUnits:16,compress:function(t,e,n){Hn.toArray(t,n,16*e)},decompress:function(t,e){return Hn.fromArray(new Hn,t,16*e)}},Wh);function o_(){return 0}function a_(t){return t}function s_(t){return t*t}function c_(t){return t*(2-t)}function l_(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}function u_(t){return t*t*t}function h_(t){return--t*t*t+1}function __(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}function f_(t){return t*t*t*t}function d_(t){return 1- --t*t*t*t}function p_(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}function m_(t){return t*t*t*t*t}function v_(t){return--t*t*t*t*t+1}function g_(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}function y_(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function x_(t){return Math.sin(t*Math.PI/2)}function S_(t){return.5*(1-Math.cos(Math.PI*t))}function A_(t){return 0===t?0:Math.pow(1024,t-1)}function C_(t){return 1===t?1:1-Math.pow(2,-10*t)}function b_(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}function T_(t){return 1-Math.sqrt(1-t*t)}function E_(t){return Math.sqrt(1- --t*t)}function w_(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}function P_(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function I_(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function R_(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),(t*=2)<1?n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)}function D_(t){if(1===t)return 1;var e=1.70158;return t*t*((e+1)*t-e)}function M_(t){if(0===t)return 0;var e=1.70158;return--t*t*((e+1)*t+e)+1}function B_(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}function O_(t){return 1-N_(1-t)}function N_(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}function L_(t){return t<.5?.5*O_(2*t):.5*N_(2*t-1)+.5}function F_(t){return t<=0?0:t>=1?1:t*t*(3-2*t)}function z_(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)}c._decorator=ll;var V_=K_(s_,c_),k_=K_(u_,h_),G_=K_(f_,d_),U_=K_(m_,v_),H_=K_(y_,x_),j_=K_(A_,C_),W_=K_(T_,E_),q_=K_(P_,I_),X_=K_(D_,M_),Y_=K_(O_,N_);function K_(t,e){return function(n){return n<.5?e(2*n)/2:t(2*n-1)/2+.5}}var J_,Q_,Z_=Object.freeze({__proto__:null,constant:o_,linear:a_,quadIn:s_,quadOut:c_,quadInOut:l_,cubicIn:u_,cubicOut:h_,cubicInOut:__,quartIn:f_,quartOut:d_,quartInOut:p_,quintIn:m_,quintOut:v_,quintInOut:g_,sineIn:y_,sineOut:x_,sineInOut:S_,expoIn:A_,expoOut:C_,expoInOut:b_,circIn:T_,circOut:E_,circInOut:w_,elasticIn:P_,elasticOut:I_,elasticInOut:R_,backIn:D_,backOut:M_,backInOut:B_,bounceIn:O_,bounceOut:N_,bounceInOut:L_,smooth:F_,fade:z_,quadOutIn:V_,cubicOutIn:k_,quartOutIn:G_,quintOutIn:U_,sineOutIn:H_,expoOutIn:j_,circOutIn:W_,elasticOutIn:q_,backOutIn:X_,bounceOutIn:Y_});t("easing",Z_),function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.QUAD_IN=2]="QUAD_IN",t[t.QUAD_OUT=3]="QUAD_OUT",t[t.QUAD_IN_OUT=4]="QUAD_IN_OUT",t[t.QUAD_OUT_IN=5]="QUAD_OUT_IN",t[t.CUBIC_IN=6]="CUBIC_IN",t[t.CUBIC_OUT=7]="CUBIC_OUT",t[t.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",t[t.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",t[t.QUART_IN=10]="QUART_IN",t[t.QUART_OUT=11]="QUART_OUT",t[t.QUART_IN_OUT=12]="QUART_IN_OUT",t[t.QUART_OUT_IN=13]="QUART_OUT_IN",t[t.QUINT_IN=14]="QUINT_IN",t[t.QUINT_OUT=15]="QUINT_OUT",t[t.QUINT_IN_OUT=16]="QUINT_IN_OUT",t[t.QUINT_OUT_IN=17]="QUINT_OUT_IN",t[t.SINE_IN=18]="SINE_IN",t[t.SINE_OUT=19]="SINE_OUT",t[t.SINE_IN_OUT=20]="SINE_IN_OUT",t[t.SINE_OUT_IN=21]="SINE_OUT_IN",t[t.EXPO_IN=22]="EXPO_IN",t[t.EXPO_OUT=23]="EXPO_OUT",t[t.EXPO_IN_OUT=24]="EXPO_IN_OUT",t[t.EXPO_OUT_IN=25]="EXPO_OUT_IN",t[t.CIRC_IN=26]="CIRC_IN",t[t.CIRC_OUT=27]="CIRC_OUT",t[t.CIRC_IN_OUT=28]="CIRC_IN_OUT",t[t.CIRC_OUT_IN=29]="CIRC_OUT_IN",t[t.ELASTIC_IN=30]="ELASTIC_IN",t[t.ELASTIC_OUT=31]="ELASTIC_OUT",t[t.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",t[t.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",t[t.BACK_IN=34]="BACK_IN",t[t.BACK_OUT=35]="BACK_OUT",t[t.BACK_IN_OUT=36]="BACK_IN_OUT",t[t.BACK_OUT_IN=37]="BACK_OUT_IN",t[t.BOUNCE_IN=38]="BOUNCE_IN",t[t.BOUNCE_OUT=39]="BOUNCE_OUT",t[t.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",t[t.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",t[t.SMOOTH=42]="SMOOTH",t[t.FADE=43]="FADE"}(Q_||(Q_={}));var $_,tf,ef,nf,rf,of=((J_={})[Q_.CONSTANT]=o_,J_[Q_.LINEAR]=a_,J_[Q_.QUAD_IN]=s_,J_[Q_.QUAD_OUT]=c_,J_[Q_.QUAD_IN_OUT]=l_,J_[Q_.QUAD_OUT_IN]=V_,J_[Q_.CUBIC_IN]=u_,J_[Q_.CUBIC_OUT]=h_,J_[Q_.CUBIC_IN_OUT]=__,J_[Q_.CUBIC_OUT_IN]=k_,J_[Q_.QUART_IN]=f_,J_[Q_.QUART_OUT]=d_,J_[Q_.QUART_IN_OUT]=p_,J_[Q_.QUART_OUT_IN]=G_,J_[Q_.QUINT_IN]=m_,J_[Q_.QUINT_OUT]=v_,J_[Q_.QUINT_IN_OUT]=g_,J_[Q_.QUINT_OUT_IN]=U_,J_[Q_.SINE_IN]=y_,J_[Q_.SINE_OUT]=x_,J_[Q_.SINE_IN_OUT]=S_,J_[Q_.SINE_OUT_IN]=H_,J_[Q_.EXPO_IN]=A_,J_[Q_.EXPO_OUT]=C_,J_[Q_.EXPO_IN_OUT]=b_,J_[Q_.EXPO_OUT_IN]=j_,J_[Q_.CIRC_IN]=T_,J_[Q_.CIRC_OUT]=E_,J_[Q_.CIRC_IN_OUT]=w_,J_[Q_.CIRC_OUT_IN]=W_,J_[Q_.ELASTIC_IN]=P_,J_[Q_.ELASTIC_OUT]=I_,J_[Q_.ELASTIC_IN_OUT]=R_,J_[Q_.ELASTIC_OUT_IN]=q_,J_[Q_.BACK_IN]=D_,J_[Q_.BACK_OUT]=M_,J_[Q_.BACK_IN_OUT]=B_,J_[Q_.BACK_OUT_IN]=X_,J_[Q_.BOUNCE_IN]=O_,J_[Q_.BOUNCE_OUT]=N_,J_[Q_.BOUNCE_IN_OUT]=L_,J_[Q_.BOUNCE_OUT_IN]=Y_,J_[Q_.SMOOTH]=F_,J_[Q_.FADE]=z_,J_);function af(t){return of[t]}var sf,cf,lf,uf=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).interpolationMode=tl.LINEAR,e.tangentWeightMode=nl.NONE,e.value=0,e.rightTangent=0,e.rightTangentWeight=0,e.leftTangent=0,e.leftTangentWeight=0,e.easingMethod=Q_.LINEAR,e}return Q(e,t),e}(cl);function hf(t){var e=new uf;if("number"==typeof t)e.value=t;else{var n=t.interpolationMode,i=t.tangentWeightMode,r=t.value,o=t.rightTangent,a=t.rightTangentWeight,s=t.leftTangent,c=t.leftTangentWeight,l=t.easingMethod,u=t[sl];e.value=null!=r?r:e.value,e.rightTangent=null!=o?o:e.rightTangent,e.rightTangentWeight=null!=a?a:e.rightTangentWeight,e.leftTangent=null!=s?s:e.leftTangent,e.leftTangentWeight=null!=c?c:e.leftTangentWeight,e.interpolationMode=null!=n?n:e.interpolationMode,e.tangentWeightMode=null!=i?i:e.tangentWeightMode,e.easingMethod=null!=l?l:e.easingMethod,u&&(e[sl]=u)}return e}Ze.fastDefine("cc.RealKeyframeValue",uf,{interpolationMode:tl.LINEAR,tangentWeightMode:nl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:Q_.LINEAR}),Ze.Attr.setClassAttr(uf,sl,"editorOnly",!0),(sf=uf,null!==(lf=(cf=sf)[gc])&&void 0!==lf?lf:cf[gc]={}).uniquelyReferenced=!0;var _f,ff=t("RealCurve",fc("cc.RealCurve")((rf=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"preExtrapolation",ef,it(e)),at(e,"postExtrapolation",nf,it(e)),e}Q(e,t);var n=e.prototype;return n.evaluate=function(t){var e=this._times,n=this._values,i=e.length;if(0===i)return 0;var r=e[0],o=e[i-1];if(t<r){var a=this.preExtrapolation,s=n[0];if(a===el.CLAMP||i<2)return s.value;switch(a){case el.LINEAR:return If(r,n[0].value,e[1],n[1].value,t);case el.LOOP:t=wf(t,r,o);break;case el.PING_PONG:t=Pf(t,r,o);break;default:return s.value}}else if(t>o){var c=this.postExtrapolation,l=n[i-1];if(c===el.CLAMP||i<2)return l.value;switch(c){case el.LINEAR:return If(o,l.value,e[i-2],n[i-2].value,t);case el.LOOP:t=wf(t,r,o);break;case el.PING_PONG:t=Pf(t,r,o);break;default:return l.value}}var u=rc(e,t);if(u>=0)return n[u].value;var h=~u,_=h-1,f=e[_],d=n[_],p=e[h];return function(t,e,n,i,r){var o=n-t;switch(e.interpolationMode){default:case tl.CONSTANT:return e.value;case tl.LINEAR:var a=e.easingMethod===Q_.LINEAR?r:af(e.easingMethod)(r);return ln(e.value,i.value,a);case tl.CUBIC:var s=1/3,c=e.rightTangent,l=e.rightTangentWeight,u=0!=(e.tangentWeightMode&nl.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&nl.LEFT);if(u||f){var d=0;if(u)d=l;else{var p=o,m=o*c;d=Math.sqrt(p*p+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*d+t,y=Math.sin(v)*d+e.value,x=0;if(f)x=_;else{var S=o,A=o*h;x=Math.sqrt(S*S+A*A)*s}var C=Math.atan(h),b=(g-t)/o,T=(-Math.cos(C)*x+n-t)/o,E=y,w=-Math.sin(C)*x+i.value,P=[0,0,0],I=function(t,e,n,i,r){var o=n/i,a=e/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+t/i),u=c*c*c,h=l*l+u,_=0;if(ol(h)){if(ol(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var d=1/3*Math.acos(-l/Math.sqrt(-u)),p=2*Math.sqrt(-c);r[0]=p*Math.cos(d),r[1]=-p*Math.cos(d+Math.PI/3),r[2]=-p*Math.cos(d-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*o,x=0;x<_;++x)r[x]-=y;return _}(0-r,3*b,3*T-6*b,3*(b-T)+1,P),R=function(t,e,n){var i=n;if(1===e)i=t[0];else{i=-1/0;for(var r=0;r<e;++r){var o=t[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(P,I,r);return Rf(e.value,E,w,i.value,R)}var D=e.value+s*c*o,M=i.value-s*h*o;return Rf(e.value,D,M,i.value,r)}}(f,d,p,n[h],(t-f)/(p-f))},n.addKeyFrame=function(e,n){return t.prototype.addKeyFrame.call(this,e,hf(n))},n.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return hf(t)})));else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return hf(t[1])})))}},n.isConstant=function(t){if(this._values.length<=1)return!0;var e=this._values[0].value;return this._values.every((function(n){return an(n.value,e,t)}))},n[ch]=function(t,e){if(e.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+df+df+pf+mf*r+bf*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=df,o.setUint8(a,this.postExtrapolation),a+=df,o.setUint32(a,r,!0),a+=pf,n.forEach((function(t,e){return o.setFloat32(a+mf*e,t,!0)})),a+=mf*r;for(var s,c=ot(i);!(s=c()).done;){var l=s.value;a=Tf(o,l,a)}var u=new Uint8Array(o.buffer,0,a);t.writeProperty("bytes",u);var h=i.map((function(t){return t[sl]}));h.some((function(t){return void 0!==t}))&&t.writeProperty("keyframeValueEditorExtras",h)}else t.writeThis()},n[lh]=function(t,e){if(e.fromCCON){var n=t.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=df,this.postExtrapolation=i.getUint8(r),r+=df;var o=i.getUint32(r,!0);r+=pf;var a=Array.from({length:o},(function(t,e){return i.getFloat32(r+mf*e,!0)}));r+=mf*o;for(var s=new Array(o),c=0;c<o;++c){var l=hf({});r=Ef(i,l,r),s[c]=l}n.byteLength;var u=t.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(t,e){return s[e][sl]=t}))),this._times=a,this._values=s}else t.readThis()},e}(rl),ef=st((tf=rf).prototype,"preExtrapolation",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return el.CLAMP}}),nf=st(tf.prototype,"postExtrapolation",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return el.CLAMP}}),$_=tf))||$_);!function(t){t[t.VALUE=1]="VALUE",t[t.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",t[t.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",t[t.LEFT_TANGENT=8]="LEFT_TANGENT",t[t.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",t[t.RIGHT_TANGENT=32]="RIGHT_TANGENT",t[t.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(_f||(_f={}));var df=1,pf=4,mf=4,vf=hf({}),gf=vf.interpolationMode,yf=vf.tangentWeightMode,xf=vf.leftTangent,Sf=vf.leftTangentWeight,Af=vf.rightTangent,Cf=vf.rightTangentWeight,bf=26;function Tf(t,e,n){var i=0,r=n,o=r;r+=4;var a=e.value,s=e.interpolationMode,c=e.tangentWeightMode,l=e.rightTangent,u=e.rightTangentWeight,h=e.leftTangent,_=e.leftTangentWeight,f=e.easingMethod;return t.setFloat32(r,a,!0),r+=4,s!==gf&&(i|=_f.INTERPOLATION_MODE,t.setUint8(r,s),r+=1),c!==yf&&(i|=_f.TANGENT_WEIGHT_MODE,t.setUint8(r,c),r+=1),h!==xf&&(i|=_f.LEFT_TANGENT,t.setFloat32(r,h,!0),r+=4),_!==Sf&&(i|=_f.LEFT_TANGENT_WEIGHT,t.setFloat32(r,_,!0),r+=4),l!==Af&&(i|=_f.RIGHT_TANGENT,t.setFloat32(r,l,!0),r+=4),u!==Cf&&(i|=_f.RIGHT_TANGENT_WEIGHT,t.setFloat32(r,u,!0),r+=4),i|=f<<8,t.setUint32(o,i,!0),r}function Ef(t,e,n){var i=n,r=t.getUint32(i,!0);i+=4,e.value=t.getFloat32(i,!0),i+=4,r&_f.INTERPOLATION_MODE&&(e.interpolationMode=t.getUint8(i),i+=1),r&_f.TANGENT_WEIGHT_MODE&&(e.tangentWeightMode=t.getUint8(i),i+=1),r&_f.LEFT_TANGENT&&(e.leftTangent=t.getFloat32(i,!0),i+=4),r&_f.LEFT_TANGENT_WEIGHT&&(e.leftTangentWeight=t.getFloat32(i,!0),i+=4),r&_f.RIGHT_TANGENT&&(e.rightTangent=t.getFloat32(i,!0),i+=4),r&_f.RIGHT_TANGENT_WEIGHT&&(e.rightTangentWeight=t.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return e.easingMethod=o,i}function wf(t,e,n){return e+yn(t-e,n-e)}function Pf(t,e,n){return e+xn(t-e,n-e)}function If(t,e,n,i,r){return e+(i-e)/(n-t)*(r-t)}function Rf(t,e,n,i,r){var o=1-r;return o*o*o*t+3*o*o*r*e+3*o*r*r*n+r*r*r*i}function Df(t,e,n,i,r){var o=1-r;return o*(o*(t+(3*e-t)*r)+3*n*r*r)+i*r*r*r}c.bezier=Df;var Mf,Bf,Of,Nf,Lf,Ff,zf,Vf,kf,Gf,Uf,Hf=Math.cos,jf=Math.acos,Wf=Math.max,qf=2*Math.PI,Xf=Math.sqrt;function Yf(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function Kf(t,e){var n=function(t,e){var n,i,r,o,a=e-0,s=e-t[0],c=3*a,l=3*s,u=3*(e-t[2]),h=1/(-a+l-u+(e-1)),_=1/3,f=(c-6*s+u)*h,d=f*_,p=(-c+l)*h,m=(3*p-f*f)*_,v=m*_,g=(2*f*f*f-9*f*p+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*_,A=Xf(S*S*S),C=-g/(2*A),b=jf(C<-1?-1:C>1?1:C),T=2*Yf(A);return i=T*Hf(b*_)-d,r=T*Hf((b+qf)*_)-d,o=T*Hf((b+2*qf)*_)-d,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?Wf(i,r,o):Wf(i,r):o>=0&&o<=1?Wf(i,o):i:r>=0&&r<=1?o>=0&&o<=1?Wf(r,o):r:o}if(0===x)return r=-(n=y<0?Yf(-y):-Yf(y))-d,(i=2*n-d)>=0&&i<=1?r>=0&&r<=1?Wf(i,r):i:r;var E=Xf(x);return(n=Yf(-y+E))-Yf(y+E)-d}(t,e),i=t[1];return((1-n)*(i+(t[3]-i)*n)*3+n*n)*n}c.bezierByTime=Kf,function(t){t[t.SLERP=0]="SLERP",t[t.CONSTANT=1]="CONSTANT"}(Uf||(Uf=t("QuatInterpolationMode",{})));var Jf=fc("cc.QuatKeyframeValue")(Mf=Cc((Of=st((Bf=function(t){var e=void 0===t?{}:t,n=e.value,i=e.interpolationMode,r=e.easingMethod;at(this,"interpolationMode",Of,this),at(this,"value",Nf,this),at(this,"easingMethod",Lf,this),this.value=n?Nn.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uf.SLERP}}),Nf=st(Bf.prototype,"value",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nn.clone(Nn.IDENTITY)}}),Lf=st(Bf.prototype,"easingMethod",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Q_.LINEAR}}),Mf=Bf))||Mf)||Mf;function Qf(t){return new Jf(t)}var Zf,$f=t("QuatCurve",fc("cc.QuatCurve")((Gf=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"preExtrapolation",Vf,it(e)),at(e,"postExtrapolation",kf,it(e)),e}Q(e,t);var n=e.prototype;return n.evaluate=function(t,e){var n;null!==(n=e)&&void 0!==n||(e=new Nn);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return e;var c=i[0],l=i[s-1];if(t<c){var u=r[0];switch(a){case el.LOOP:t=c+yn(t-c,l-c);break;case el.PING_PONG:t=c+xn(t-c,l-c);break;case el.CLAMP:default:return Nn.copy(e,u.value)}}else if(t>l){var h=r[s-1];switch(o){case el.LOOP:t=c+yn(t-c,l-c);break;case el.PING_PONG:t=c+xn(t-c,l-c);break;case el.CLAMP:default:return Nn.copy(e,h.value)}}var _=rc(i,t);if(_>=0)return Nn.copy(e,r[_].value);var f=~_,d=f-1,p=i[d],m=r[d],v=i[f],g=r[f],y=(t-p)/(v-p);switch(m.interpolationMode){default:case Uf.CONSTANT:return Nn.copy(e,m.value);case Uf.SLERP:var x=m.easingMethod,S=x===Q_.LINEAR?y:Array.isArray(x)?Kf(x,y):af(x)(y);return Nn.slerp(e,m.value,g.value,S)}},n.addKeyFrame=function(e,n){var i=new Jf(n);return t.prototype.addKeyFrame.call(this,e,i)},n.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return Qf(t)})));else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return Qf(t[1])})))}},n[ch]=function(t,e){if(e.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(t,e,n){var i=n[0];r&&t.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=ud*(r?1:o),s=i.reduce((function(t,e){var n=e.easingMethod;return t+(Array.isArray(n)?hd+4*fd:hd)}),0),c=0,l=new DataView(new ArrayBuffer(c+=ad+sd+cd*o+4*ld*o+s+a+0)),u=0,h=0;r&&(h|=Zf.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=ad,l.setUint32(u,o,!0),u+=sd,n.forEach((function(t,e){return l.setFloat32(u+cd*e,t,!0)})),u+=cd*o,i.forEach((function(t,e){var n=t.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*ld*e;l.setFloat32(s+0*ld,i,!0),l.setFloat32(s+1*ld,r,!0),l.setFloat32(s+2*ld,o,!0),l.setFloat32(s+3*ld,a,!0)})),u+=4*ld*o,i.forEach((function(t){var e=t.easingMethod;Array.isArray(e)?(l.setUint8(u,_d),++u,l.setFloat32(u+0*fd,e[0],!0),l.setFloat32(u+1*fd,e[1],!0),l.setFloat32(u+2*fd,e[2],!0),l.setFloat32(u+3*fd,e[3],!0),u+=4*fd):(l.setUint8(u,e),++u)}));var _=u;u+=a;var f=_;i.forEach((function(t){var e=t.interpolationMode;l.setUint8(f,e),r||(f+=ud)}));var d=new Uint8Array(l.buffer);t.writeProperty("bytes",d)}else t.writeThis()},n[lh]=function(t,e){if(e.fromCCON){var n=t.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=ad;var a=o&Zf.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=sd;var c=Array.from({length:s},(function(t,e){return i.getFloat32(r+cd*e,!0)})),l=r+=cd*s;r+=4*ld*s;var u=Array.from({length:s},(function(t,e){var n=l+4*ld*e,o=i.getFloat32(n+0*ld,!0),a=i.getFloat32(n+1*ld,!0),s=i.getFloat32(n+2*ld,!0),c=i.getFloat32(n+3*ld,!0),u=i.getUint8(r);++r;var h=Qf({value:{x:o,y:a,z:s,w:c}});return u!==_d?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*fd,!0),i.getFloat32(r+1*fd,!0),i.getFloat32(r+2*fd,!0),i.getFloat32(r+3*fd,!0)],r+=4*fd),h}));if(a){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var d=i.getUint8(r+f);u[f].interpolationMode=d}r+=s}this._times=c,this._values=u}else t.readThis()},e}(rl),Vf=st((zf=Gf).prototype,"preExtrapolation",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return el.CLAMP}}),kf=st(zf.prototype,"postExtrapolation",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return el.CLAMP}}),Ff=zf))||Ff);!function(t){t[t.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(Zf||(Zf={}));var td,ed,nd,id,rd,od,ad=1,sd=4,cd=4,ld=4,ud=1,hd=1,_d=255,fd=4,dd=t("ObjectCurve",fc("cc.ObjectCurve")(td=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.prototype.evaluate=function(t){var e=this.searchKeyframe(t);if(e>=0)return this._values[e];var n=sn(~e-1,0,this._values.length-1);return this._values[n]},e}(rl))||td),pd=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Ze.fastDefine("cc.Keyframe",pd,{time:0,value:0,inTangent:0,outTangent:0});var md=function(){function t(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return t.prototype.evaluate=function(t){return e=t-this.time,n=this.coefficient,e*(e*(e*n[0]+n[1])+n[2])+n[3];var e,n},t}(),vd=fc("cc.AnimationCurve")((od=rd=function(){function t(t){if(void 0===t&&(t=null),at(this,"_curve",id,this),this.cachedKey=void 0,t instanceof ff)this._curve=t;else{var e=new ff;this._curve=e,e.preExtrapolation=el.LOOP,e.postExtrapolation=el.CLAMP,t?e.assignSorted(t.map((function(t){return[t.time,{interpolationMode:tl.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]}))):e.assignSorted([[0,{interpolationMode:tl.CUBIC,value:1}],[1,{interpolationMode:tl.CUBIC,value:1}]])}this.cachedKey=new md}var e=t.prototype;return e.addKey=function(t){t?this._curve.addKeyFrame(t.time,{interpolationMode:tl.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}):this._curve.clear()},e.evaluate_slow=function(t){return this._curve.evaluate(t)},e.evaluate=function(t){var e=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=t,o=t<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case el.LOOP:r=yn(t-a,s-a)+a;break;case el.PING_PONG:r=xn(t-a,s-a)+a;break;case el.CLAMP:default:r=sn(t,a,s)}if(r>=e.time&&r<e.endTime)return e.evaluate(r);var c=this.findIndex(e,r),l=Math.min(c+1,i);return this.calcOptimizedKey(e,c,l),e.evaluate(r)},e.calcOptimizedKey=function(t,e,n){var i=this._curve.getKeyframeTime(e),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(e),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;t.index=e,t.time=i,t.endTime=r;var h=r-i,_=l-a,f=1/(h*h),d=s*h,p=u*h;t.coefficient[0]=(d+p-_-_)*f/h,t.coefficient[1]=(_+_+_-d-d-p)*f,t.coefficient[2]=s,t.coefficient[3]=a},e.findIndex=function(t,e){var n=this._curve,i=n.keyFramesCount,r=t.index;if(-1!==r)if(e>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>e)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=e)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=e?h=l:u=l;return u},K(t,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(t){var e=t[0],n=t[1],i=new pd;return i.time=e,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(t){this._curve.assignSorted(t.map((function(t){return[t.time,{interpolationMode:tl.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]})))}},{key:"preWrapMode",get:function(){return yd(this._curve.preExtrapolation)},set:function(t){this._curve.preExtrapolation=gd(t)}},{key:"postWrapMode",get:function(){return yd(this._curve.postExtrapolation)},set:function(t){this._curve.postExtrapolation=gd(t)}}]),t}(),rd.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],id=st((nd=od).prototype,"_curve",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ed=nd))||ed;function gd(t){switch(t){default:case Qs.Default:case Qs.Normal:case Qs.Clamp:return el.CLAMP;case Qs.PingPong:return el.PING_PONG;case Qs.Loop:return el.LOOP}}function yd(t){switch(t){default:case el.LINEAR:case el.CLAMP:return Qs.Clamp;case el.PING_PONG:return Qs.PingPong;case el.LOOP:return Qs.Loop}}function xd(t,e){console.warn(t+" is deprecated, please use "+e+" instead.")}z(us,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var Sd=function(t){function e(){var e;return e=t.call(this)||this,xd("line","Line"),e}return Q(e,t),e}(Zo),Ad=function(t){function e(){var e;return e=t.call(this)||this,xd("plane","Plane"),e}return Q(e,t),e}(As),Cd=function(t){function e(){var e;return e=t.call(this)||this,xd("ray","Ray"),e}return Q(e,t),e}($o),bd=function(t){function e(){var e;return e=t.call(this)||this,xd("triangle","Triangle"),e}return Q(e,t),e}(sa),Td=function(t){function e(){var e;return e=t.call(this)||this,xd("sphere","Sphere"),e}return Q(e,t),e}(aa),Ed=function(t){function e(){var e;return e=t.call(this)||this,xd("aabb","AABB"),e}return Q(e,t),e}(js),wd=function(t){function e(){var e;return e=t.call(this)||this,xd("obb","OBB"),e}return Q(e,t),e}(Ys),Pd=function(t){function e(){var e;return e=t.call(this)||this,xd("capsule","Capsule"),e}return Q(e,t),e}(Ks),Id=function(t){function e(){var e;return e=t.call(this)||this,xd("frustum","Frustum"),e}return Q(e,t),e}(nc),Rd=Object.freeze({__proto__:null,distance:Jo,enums:Qo,intersect:us,Line:Zo,Plane:As,Ray:$o,Triangle:sa,Sphere:aa,AABB:js,OBB:Ys,Capsule:Ks,Frustum:nc,Keyframe:pd,AnimationCurve:vd,get ERaycastMode(){return oa},line:Sd,plane:Ad,ray:Cd,triangle:bd,sphere:Td,aabb:Ed,obb:wd,capsule:Pd,frustum:Id});t("geometry",Rd);var Dd={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Md=t("Layers",function(){function t(){}return t.makeMaskInclude=function(t){for(var e,n=0,i=ot(t);!(e=i()).done;)n|=e.value;return n},t.makeMaskExclude=function(e){return~t.makeMaskInclude(e)},t.addLayer=function(e,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;t.Enum[e],N(2104,e),t.Enum[e]=i,ne.value(t.Enum,String(i),e),t.BitMask[e]=i,ne.value(t.BitMask,String(i),e)}else console.warn("bitNum can't be undefined")},t.deleteLayer=function(e){if(e>19||e<0)console.warn("do not change buildin layers.");else{var n=1<<e;delete t.Enum[t.Enum[n]],delete t.Enum[n],delete t.BitMask[t.BitMask[n]],delete t.BitMask[n]}},t.nameToLayer=function(e){return void 0===e?(console.warn("name can't be undefined"),-1):n(t.Enum[e])},t.layerToName=function(e){return e>31||e<0?(console.warn("Unable to access unknown layer."),""):t.Enum[1<<e]},t}());Md.Enum=oe(Dd),Md.BitMask=ie(J({},Dd)),c.Layers=Md;var Bd,Od,Nd="MainFlow",Ld="ForwardFlow",Fd="ShadowFlow";!function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(Bd||(Bd={})),c.RenderPassStage=Bd,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(Od||(Od={}));var zd,Vd={bindings:[],layouts:{}},kd={bindings:[],layouts:{}};!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",t[t.COUNT=7]="COUNT"}(zd||(zd={}));var Gd,Ud=zd.SAMPLER_SHADOWMAP,Hd=zd.COUNT-Ud;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",t[t.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",t[t.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",t[t.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",t[t.COUNT=14]="COUNT"}(Gd||(Gd={}));var jd,Wd=Gd.SAMPLER_JOINTS,qd=Gd.COUNT-Wd;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(jd||(jd={}));var Xd=new cr;Xd.bufferOffsets=[0,Ud+Wd,Ud],Xd.samplerOffsets=[-Ud,Hd+qd,Hd-Wd],Xd.flexibleSet=1;var Yd=function(){};Yd.SIZE=4*(Yd.COUNT=4+(Yd.SCREEN_SIZE_OFFSET=4+(Yd.NATIVE_SIZE_OFFSET=4+(Yd.TIME_OFFSET=0)))),Yd.NAME="CCGlobal",Yd.BINDING=zd.UBO_GLOBAL,Yd.DESCRIPTOR=new Vr(Yd.BINDING,Hi.UNIFORM_BUFFER,1,Di.ALL),Yd.LAYOUT=new xr(jd.GLOBAL,Yd.BINDING,Yd.NAME,[new yr("cc_time",di.FLOAT4,1),new yr("cc_screenSize",di.FLOAT4,1),new yr("cc_nativeSize",di.FLOAT4,1)],1),Vd.layouts[Yd.NAME]=Yd.LAYOUT,Vd.bindings[Yd.BINDING]=Yd.DESCRIPTOR;var Kd=function(){};Kd.SIZE=4*(Kd.COUNT=4+(Kd.VIEW_PORT_OFFSET=4+(Kd.NEAR_FAR_OFFSET=4+(Kd.GLOBAL_FOG_ADD_OFFSET=4+(Kd.GLOBAL_FOG_BASE_OFFSET=4+(Kd.GLOBAL_FOG_COLOR_OFFSET=4+(Kd.AMBIENT_GROUND_OFFSET=4+(Kd.AMBIENT_SKY_OFFSET=4+(Kd.MAIN_LIT_COLOR_OFFSET=4+(Kd.MAIN_LIT_DIR_OFFSET=4+(Kd.EXPOSURE_OFFSET=4+(Kd.SCREEN_SCALE_OFFSET=4+(Kd.CAMERA_POS_OFFSET=16+(Kd.MAT_VIEW_PROJ_INV_OFFSET=16+(Kd.MAT_VIEW_PROJ_OFFSET=16+(Kd.MAT_PROJ_INV_OFFSET=16+(Kd.MAT_PROJ_OFFSET=16+(Kd.MAT_VIEW_INV_OFFSET=16+(Kd.MAT_VIEW_OFFSET=0))))))))))))))))))),Kd.NAME="CCCamera",Kd.BINDING=zd.UBO_CAMERA,Kd.DESCRIPTOR=new Vr(Kd.BINDING,Hi.UNIFORM_BUFFER,1,Di.ALL),Kd.LAYOUT=new xr(jd.GLOBAL,Kd.BINDING,Kd.NAME,[new yr("cc_matView",di.MAT4,1),new yr("cc_matViewInv",di.MAT4,1),new yr("cc_matProj",di.MAT4,1),new yr("cc_matProjInv",di.MAT4,1),new yr("cc_matViewProj",di.MAT4,1),new yr("cc_matViewProjInv",di.MAT4,1),new yr("cc_cameraPos",di.FLOAT4,1),new yr("cc_screenScale",di.FLOAT4,1),new yr("cc_exposure",di.FLOAT4,1),new yr("cc_mainLitDir",di.FLOAT4,1),new yr("cc_mainLitColor",di.FLOAT4,1),new yr("cc_ambientSky",di.FLOAT4,1),new yr("cc_ambientGround",di.FLOAT4,1),new yr("cc_fogColor",di.FLOAT4,1),new yr("cc_fogBase",di.FLOAT4,1),new yr("cc_fogAdd",di.FLOAT4,1),new yr("cc_nearFar",di.FLOAT4,1),new yr("cc_viewPort",di.FLOAT4,1)],1),Vd.layouts[Kd.NAME]=Kd.LAYOUT,Vd.bindings[Kd.BINDING]=Kd.DESCRIPTOR;var Jd=function(){};Jd.SIZE=4*(Jd.COUNT=4+(Jd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(Jd.SHADOW_COLOR_OFFSET=4+(Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Jd.SHADOW_PROJ_INFO_OFFSET=4+(Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Jd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Jd.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Jd.MAT_LIGHT_VIEW_OFFSET=16+(Jd.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),Jd.NAME="CCShadow",Jd.BINDING=zd.UBO_SHADOW,Jd.DESCRIPTOR=new Vr(Jd.BINDING,Hi.UNIFORM_BUFFER,1,Di.ALL),Jd.LAYOUT=new xr(jd.GLOBAL,Jd.BINDING,Jd.NAME,[new yr("cc_matLightPlaneProj",di.MAT4,1),new yr("cc_matLightView",di.MAT4,1),new yr("cc_matLightViewProj",di.MAT4,1),new yr("cc_shadowInvProjDepthInfo",di.FLOAT4,1),new yr("cc_shadowProjDepthInfo",di.FLOAT4,1),new yr("cc_shadowProjInfo",di.FLOAT4,1),new yr("cc_shadowNFLSInfo",di.FLOAT4,1),new yr("cc_shadowWHPBInfo",di.FLOAT4,1),new yr("cc_shadowLPNNInfo",di.FLOAT4,1),new yr("cc_shadowColor",di.FLOAT4,1),new yr("cc_planarNDInfo",di.FLOAT4,1)],1),Vd.layouts[Jd.NAME]=Jd.LAYOUT,Vd.bindings[Jd.BINDING]=Jd.DESCRIPTOR;var Qd=zd.SAMPLER_SHADOWMAP,Zd=new Vr(Qd,Hi.SAMPLER_TEXTURE,1,Di.FRAGMENT),$d=new Sr(jd.GLOBAL,Qd,"cc_shadowMap",di.SAMPLER2D,1);Vd.layouts.cc_shadowMap=$d,Vd.bindings[Qd]=Zd;var tp=zd.SAMPLER_ENVIRONMENT,ep=new Vr(tp,Hi.SAMPLER_TEXTURE,1,Di.FRAGMENT),np=new Sr(jd.GLOBAL,tp,"cc_environment",di.SAMPLER_CUBE,1);Vd.layouts.cc_environment=np,Vd.bindings[tp]=ep;var ip=zd.SAMPLER_DIFFUSEMAP,rp=new Vr(ip,Hi.SAMPLER_TEXTURE,1,Di.FRAGMENT),op=new Sr(jd.GLOBAL,ip,"cc_diffuseMap",di.SAMPLER_CUBE,1);Vd.layouts.cc_diffuseMap=op,Vd.bindings[ip]=rp;var ap=zd.SAMPLER_SPOT_LIGHTING_MAP,sp=new Vr(ap,Hi.SAMPLER_TEXTURE,1,Di.FRAGMENT),cp=new Sr(jd.GLOBAL,ap,"cc_spotLightingMap",di.SAMPLER2D,1);Vd.layouts.cc_spotLightingMap=cp,Vd.bindings[ap]=sp;var lp=function(){};lp.SIZE=4*(lp.COUNT=4+(lp.LIGHTINGMAP_UVPARAM=16+(lp.MAT_WORLD_IT_OFFSET=16+(lp.MAT_WORLD_OFFSET=0)))),lp.NAME="CCLocal",lp.BINDING=Gd.UBO_LOCAL,lp.DESCRIPTOR=new Vr(lp.BINDING,Hi.UNIFORM_BUFFER,1,Di.VERTEX|Di.COMPUTE),lp.LAYOUT=new xr(jd.LOCAL,lp.BINDING,lp.NAME,[new yr("cc_matWorld",di.MAT4,1),new yr("cc_matWorldIT",di.MAT4,1),new yr("cc_lightingMapUVParam",di.FLOAT4,1)],1),kd.layouts[lp.NAME]=lp.LAYOUT,kd.bindings[lp.BINDING]=lp.DESCRIPTOR;var up=function(){};up.SIZE=4*(up.COUNT=4+(up.WORLD_BOUND_HALF_EXTENTS=4+(up.WORLD_BOUND_CENTER=0))),up.NAME="CCWorldBound",up.BINDING=Gd.UBO_LOCAL,up.DESCRIPTOR=new Vr(up.BINDING,Hi.UNIFORM_BUFFER,1,Di.VERTEX|Di.COMPUTE),up.LAYOUT=new xr(jd.LOCAL,up.BINDING,up.NAME,[new yr("cc_worldBoundCenter",di.FLOAT4,1),new yr("cc_worldBoundHalfExtents",di.FLOAT4,1)],1),kd.layouts[up.NAME]=up.LAYOUT,kd.bindings[up.BINDING]=up.DESCRIPTOR;var hp="a_matWorld0",_p=function(){};_p.BATCHING_COUNT=10,_p.MAT_WORLDS_OFFSET=0,_p.SIZE=4*(_p.COUNT=16*_p.BATCHING_COUNT),_p.NAME="CCLocalBatched",_p.BINDING=Gd.UBO_LOCAL,_p.DESCRIPTOR=new Vr(_p.BINDING,Hi.UNIFORM_BUFFER,1,Di.VERTEX|Di.COMPUTE),_p.LAYOUT=new xr(jd.LOCAL,_p.BINDING,_p.NAME,[new yr("cc_matWorlds",di.MAT4,_p.BATCHING_COUNT)],1),kd.layouts[_p.NAME]=_p.LAYOUT,kd.bindings[_p.BINDING]=_p.DESCRIPTOR;var fp=function(){};fp.LIGHTS_PER_PASS=1,fp.SIZE=4*(fp.COUNT=(fp.LIGHT_DIR_OFFSET=(fp.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(fp.LIGHT_COLOR_OFFSET=(fp.LIGHT_POS_OFFSET=0)+4*fp.LIGHTS_PER_PASS)+4*fp.LIGHTS_PER_PASS)+4*fp.LIGHTS_PER_PASS)+4*fp.LIGHTS_PER_PASS),fp.NAME="CCForwardLight",fp.BINDING=Gd.UBO_FORWARD_LIGHTS,fp.DESCRIPTOR=new Vr(fp.BINDING,Hi.DYNAMIC_UNIFORM_BUFFER,1,Di.FRAGMENT),fp.LAYOUT=new xr(jd.LOCAL,fp.BINDING,fp.NAME,[new yr("cc_lightPos",di.FLOAT4,fp.LIGHTS_PER_PASS),new yr("cc_lightColor",di.FLOAT4,fp.LIGHTS_PER_PASS),new yr("cc_lightSizeRangeAngle",di.FLOAT4,fp.LIGHTS_PER_PASS),new yr("cc_lightDir",di.FLOAT4,fp.LIGHTS_PER_PASS)],1),kd.layouts[fp.NAME]=fp.LAYOUT,kd.bindings[fp.BINDING]=fp.DESCRIPTOR;var dp=function(){};dp.LIGHTS_PER_PASS=10;var pp=function(){};pp.SIZE=4*(pp.COUNT=4+(pp.JOINTS_TEXTURE_INFO_OFFSET=0)),pp.NAME="CCSkinningTexture",pp.BINDING=Gd.UBO_SKINNING_TEXTURE,pp.DESCRIPTOR=new Vr(pp.BINDING,Hi.UNIFORM_BUFFER,1,Di.VERTEX),pp.LAYOUT=new xr(jd.LOCAL,pp.BINDING,pp.NAME,[new yr("cc_jointTextureInfo",di.FLOAT4,1)],1),kd.layouts[pp.NAME]=pp.LAYOUT,kd.bindings[pp.BINDING]=pp.DESCRIPTOR;var mp=function(){};mp.SIZE=4*(mp.COUNT=4+(mp.JOINTS_ANIM_INFO_OFFSET=0)),mp.NAME="CCSkinningAnimation",mp.BINDING=Gd.UBO_SKINNING_ANIMATION,mp.DESCRIPTOR=new Vr(mp.BINDING,Hi.UNIFORM_BUFFER,1,Di.VERTEX),mp.LAYOUT=new xr(jd.LOCAL,mp.BINDING,mp.NAME,[new yr("cc_jointAnimInfo",di.FLOAT4,1)],1),kd.layouts[mp.NAME]=mp.LAYOUT,kd.bindings[mp.BINDING]=mp.DESCRIPTOR;var vp=function(){};vp.SIZE=4*(vp.COUNT=360+(vp.JOINTS_OFFSET=0)),vp.NAME="CCSkinning",vp.BINDING=Gd.UBO_SKINNING_TEXTURE,vp.DESCRIPTOR=new Vr(vp.BINDING,Hi.UNIFORM_BUFFER,1,Di.VERTEX),vp.LAYOUT=new xr(jd.LOCAL,vp.BINDING,vp.NAME,[new yr("cc_joints",di.FLOAT4,90)],1),kd.layouts[vp.NAME]=vp.LAYOUT,kd.bindings[vp.BINDING]=vp.DESCRIPTOR;var gp=function(){};gp.MAX_MORPH_TARGET_COUNT=60,gp.OFFSET_OF_WEIGHTS=0,gp.OFFSET_OF_VERTICES_COUNT=4+(gp.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(gp.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*gp.MAX_MORPH_TARGET_COUNT)),gp.COUNT_BASE_4_BYTES=4*Math.ceil(gp.MAX_MORPH_TARGET_COUNT/4)+4,gp.SIZE=4*gp.COUNT_BASE_4_BYTES,gp.NAME="CCMorph",gp.BINDING=Gd.UBO_MORPH,gp.DESCRIPTOR=new Vr(gp.BINDING,Hi.UNIFORM_BUFFER,1,Di.VERTEX),gp.LAYOUT=new xr(jd.LOCAL,gp.BINDING,gp.NAME,[new yr("cc_displacementWeights",di.FLOAT4,gp.MAX_MORPH_TARGET_COUNT/4),new yr("cc_displacementTextureInfo",di.FLOAT4,1)],1),kd.layouts[gp.NAME]=gp.LAYOUT,kd.bindings[gp.BINDING]=gp.DESCRIPTOR;var yp=function(){};yp.NAME="CCUILocal",yp.BINDING=Gd.UBO_UI_LOCAL,yp.DESCRIPTOR=new Vr(yp.BINDING,Hi.DYNAMIC_UNIFORM_BUFFER,1,Di.VERTEX),yp.LAYOUT=new xr(jd.LOCAL,yp.BINDING,yp.NAME,[new yr("cc_local_data",di.FLOAT4,1)],1),kd.layouts[yp.NAME]=yp.LAYOUT,kd.bindings[yp.BINDING]=yp.DESCRIPTOR;var xp=Gd.SAMPLER_JOINTS,Sp=new Vr(xp,Hi.SAMPLER_TEXTURE,1,Di.VERTEX),Ap=new Sr(jd.LOCAL,xp,"cc_jointTexture",di.SAMPLER2D,1);kd.layouts.cc_jointTexture=Ap,kd.bindings[xp]=Sp;var Cp=Gd.SAMPLER_MORPH_POSITION,bp=new Vr(Cp,Hi.SAMPLER_TEXTURE,1,Di.VERTEX),Tp=new Sr(jd.LOCAL,Cp,"cc_PositionDisplacements",di.SAMPLER2D,1);kd.layouts.cc_PositionDisplacements=Tp,kd.bindings[Cp]=bp;var Ep=Gd.SAMPLER_MORPH_NORMAL,wp=new Vr(Ep,Hi.SAMPLER_TEXTURE,1,Di.VERTEX),Pp=new Sr(jd.LOCAL,Ep,"cc_NormalDisplacements",di.SAMPLER2D,1);kd.layouts.cc_NormalDisplacements=Pp,kd.bindings[Ep]=wp;var Ip=Gd.SAMPLER_MORPH_TANGENT,Rp=new Vr(Ip,Hi.SAMPLER_TEXTURE,1,Di.VERTEX),Dp=new Sr(jd.LOCAL,Ip,"cc_TangentDisplacements",di.SAMPLER2D,1);kd.layouts.cc_TangentDisplacements=Dp,kd.bindings[Ip]=Rp;var Mp=Gd.SAMPLER_LIGHTMAP,Bp=new Vr(Mp,Hi.SAMPLER_TEXTURE,1,Di.FRAGMENT),Op=new Sr(jd.LOCAL,Mp,"cc_lightingMap",di.SAMPLER2D,1);kd.layouts.cc_lightingMap=Op,kd.bindings[Mp]=Bp;var Np=Gd.SAMPLER_SPRITE,Lp=new Vr(Np,Hi.SAMPLER_TEXTURE,1,Di.FRAGMENT),Fp=new Sr(jd.LOCAL,Np,"cc_spriteTexture",di.SAMPLER2D,1);kd.layouts.cc_spriteTexture=Fp,kd.bindings[Np]=Lp;var zp=Gd.SAMPLER_REFLECTION,Vp=new Vr(zp,Hi.SAMPLER_TEXTURE,1,Di.FRAGMENT),kp=new Sr(jd.LOCAL,zp,"cc_reflectionTexture",di.SAMPLER2D,1);kd.layouts.cc_reflectionTexture=kp,kd.bindings[zp]=Vp;var Gp=Gd.STORAGE_REFLECTION,Up=new Vr(Gp,Hi.STORAGE_IMAGE,1,Di.COMPUTE),Hp=new br(jd.LOCAL,Gp,"cc_reflectionStorage",di.IMAGE2D,1);kd.layouts.cc_reflectionStorage=Hp,kd.bindings[Gp]=Up;var jp,Wp,qp=Md.makeMaskExclude([Md.BitMask.UI_2D,Md.BitMask.GIZMOS,Md.BitMask.EDITOR,Md.BitMask.SCENE_GIZMO,Md.BitMask.PROFILER]),Xp=Md.makeMaskExclude([Md.BitMask.UI_2D,Md.BitMask.PROFILER]),Yp=Md.Enum.ALL;function Kp(t){return t.hasFeature(hi.COLOR_FLOAT)&&t.hasFeature(hi.TEXTURE_FLOAT)&&!(t.gfxAPI===li.WEBGL)}t("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:Nd,PIPELINE_FLOW_FORWARD:Ld,PIPELINE_FLOW_SHADOW:Fd,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Bd},get RenderPriority(){return Od},globalDescriptorSetLayout:Vd,localDescriptorSetLayout:kd,get PipelineGlobalBindings(){return zd},get ModelLocalBindings(){return Gd},get SetIndex(){return jd},bindingMappingInfo:Xd,UBOGlobal:Yd,UBOCamera:Kd,UBOShadow:Jd,UNIFORM_SHADOWMAP_BINDING:Qd,UNIFORM_ENVIRONMENT_BINDING:tp,UNIFORM_DIFFUSEMAP_BINDING:ip,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:ap,UBOLocal:lp,UBOWorldBound:up,INST_MAT_WORLD:hp,UBOLocalBatched:_p,UBOForwardLight:fp,UBODeferredLight:dp,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:pp,UBOSkinningAnimation:mp,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:vp,UBOMorph:gp,UBOUILocal:yp,UNIFORM_JOINT_TEXTURE_BINDING:xp,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Cp,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Ep,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Ip,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Mp,UNIFORM_SPRITE_TEXTURE_BINDING:Np,UNIFORM_REFLECTION_TEXTURE_BINDING:zp,UNIFORM_REFLECTION_STORAGE_BINDING:Gp,CAMERA_DEFAULT_MASK:qp,CAMERA_EDITOR_MASK:Xp,MODEL_ALWAYS_MASK:Yp,supportsHalfFloatTexture:function(t){return t.hasFeature(hi.COLOR_HALF_FLOAT)&&t.hasFeature(hi.TEXTURE_HALF_FLOAT)&&!(t.gfxAPI===li.WEBGL)},supportsFloatTexture:Kp}));var Jp=4227858432,Qp=66060288,Zp=1044480,$p=function(t,e,n,i){return void 0===i&&(i=0),e<<26&Jp|t<<20&Qp|n<<12&Zp|4095&i},tm=function(t){return(t&Jp)>>>26},em=function(t){return(t&Qp)>>>20},nm=function(t){return(t&Zp)>>>12},im=function(t){return 4095&t},rm=function(t,e){return 67108863&t|e<<26&Jp},om=((jp={})[di.UNKNOWN]=function(){return console.warn("illegal uniform handle")},jp[di.INT]=function(t,e,n){return void 0===n&&(n=0),t[n]},jp[di.INT2]=function(t,e,n){return void 0===n&&(n=0),Xn.fromArray(e,t,n)},jp[di.INT3]=function(t,e,n){return void 0===n&&(n=0),Pn.fromArray(e,t,n)},jp[di.INT4]=function(t,e,n){return void 0===n&&(n=0),Qn.fromArray(e,t,n)},jp[di.FLOAT]=function(t,e,n){return void 0===n&&(n=0),t[n]},jp[di.FLOAT2]=function(t,e,n){return void 0===n&&(n=0),Xn.fromArray(e,t,n)},jp[di.FLOAT3]=function(t,e,n){return void 0===n&&(n=0),Pn.fromArray(e,t,n)},jp[di.FLOAT4]=function(t,e,n){return void 0===n&&(n=0),Qn.fromArray(e,t,n)},jp[di.MAT3]=function(t,e,n){return void 0===n&&(n=0),Mn.fromArray(e,t,n)},jp[di.MAT4]=function(t,e,n){return void 0===n&&(n=0),Hn.fromArray(e,t,n)},jp),am=((Wp={})[di.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Wp[di.INT]=function(t,e,n){return void 0===n&&(n=0),t[n]=e},Wp[di.INT2]=function(t,e,n){return void 0===n&&(n=0),Xn.toArray(t,e,n)},Wp[di.INT3]=function(t,e,n){return void 0===n&&(n=0),Pn.toArray(t,e,n)},Wp[di.INT4]=function(t,e,n){return void 0===n&&(n=0),Qn.toArray(t,e,n)},Wp[di.FLOAT]=function(t,e,n){return void 0===n&&(n=0),t[n]=e},Wp[di.FLOAT2]=function(t,e,n){return void 0===n&&(n=0),Xn.toArray(t,e,n)},Wp[di.FLOAT3]=function(t,e,n){return void 0===n&&(n=0),Pn.toArray(t,e,n)},Wp[di.FLOAT4]=function(t,e,n){return void 0===n&&(n=0),Qn.toArray(t,e,n)},Wp[di.MAT3]=function(t,e,n){return void 0===n&&(n=0),Mn.toArray(t,e,n)},Wp[di.MAT4]=function(t,e,n){return void 0===n&&(n=0),Hn.toArray(t,e,n)},Wp),sm=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function cm(t){switch(t){case di.BOOL:case di.INT:case di.UINT:case di.FLOAT:return sm[0];case di.BOOL2:case di.INT2:case di.UINT2:case di.FLOAT2:return sm[1];case di.BOOL4:case di.INT4:case di.UINT4:case di.FLOAT4:return sm[2];case di.MAT4:return sm[3];case di.SAMPLER2D:return"default-texture";case di.SAMPLER_CUBE:return"default-cube-texture"}return sm[0]}function lm(t,e){for(var n=Object.entries(e),i=!1,r=0;r<n.length;r++)t[n[r][0]]!==n[r][1]&&(t[n[r][0]]=n[r][1],i=!0);return i}var um=new kr;function hm(t){return Math.ceil(Math.log2(Math.max(t,2)))}function _m(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn("unknown define type '"+t.type+"'"),"-1"}}function fm(t,e,n,i,r){for(var o=t.builtins[i],a=[],s=function(t){var e=o.blocks[t],i=n.layouts[e.name],s=i&&n.bindings.find((function(t){return t.binding===i.binding}));if(!(i&&s&&s.descriptorType&$r))return console.warn("builtin UBO '"+e.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(e.shaderInfo.blocks,a);for(var l=[],u=function(t){var e=o.samplerTextures[t],i=n.layouts[e.name],a=i&&n.bindings.find((function(t){return t.binding===i.binding}));if(!(i&&a&&a.descriptorType&to))return console.warn("builtin samplerTexture '"+e.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(e.shaderInfo.samplerTextures,l),r&&r.sort((function(t,e){return t.binding-e.binding}))}function dm(t){return t.members.reduce((function(t,e){return t+ao(e.type)*e.count}),0)}function pm(t,e){for(var n=0;n<t.length;n++){var i=t[n];if("!"===i[0]){if(e[i.slice(1)])return!1}else if(!e[i])return!1}return!0}function mm(t){switch(t.gfxAPI){case li.GLES2:case li.WEBGL:return"glsl1";case li.GLES3:case li.WEBGL2:return"glsl3";default:return"glsl4"}}var vm,gm,ym,xm,Sm,Am,Cm,bm,Tm=new(function(){function t(){this._templates={},this._cache={},this._templateInfos={}}var e=t.prototype;return e.register=function(t){for(var e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name;for(var n=0;n<t.techniques.length;n++)for(var i=t.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},e.define=function(t){var e=this._templates[t.name];if(e&&e.hash===t.hash)return e;for(var n=J({},t),i=0,r=function(t){var e=n.defines[t],r=1;if("number"===e.type){var o=e.range;r=hm(o[1]-o[0]+1),e._map=function(t){return t-o[0]}}else"string"===e.type?(r=hm(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex((function(e){return e===t})))}):"boolean"===e.type&&(e._map=function(t){return t?1:0});e._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[t.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Ir,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(dm(l)),s.bindings.push(new Vr(l.binding,Hi.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new xr(jd.MATERIAL,l.binding,l.name,l.members.map((function(t){return new yr(t.name,t.type,t.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new Vr(h.binding,Hi.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Sr(jd.MATERIAL,h.binding,h.name,h.type,h.count))}for(var _=0;_<n.samplers.length;_++){var f=n.samplers[_];s.bindings.push(new Vr(f.binding,Hi.SAMPLER,f.count,f.stageFlags)),s.shaderInfo.samplers.push(new Ar(jd.MATERIAL,f.binding,f.name,f.count))}for(var d=0;d<n.textures.length;d++){var p=n.textures[d];s.bindings.push(new Vr(p.binding,Hi.TEXTURE,p.count,p.stageFlags)),s.shaderInfo.textures.push(new Cr(jd.MATERIAL,p.binding,p.name,p.type,p.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new Vr(v.binding,Hi.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Tr(jd.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new Vr(y.binding,Hi.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new br(jd.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var x=0;x<n.subpassInputs.length;x++){var S=n.subpassInputs[x];s.bindings.push(new Vr(S.binding,Hi.INPUT_ATTACHMENT,S.count,S.stageFlags)),s.shaderInfo.subpassInputs.push(new Er(jd.MATERIAL,S.binding,S.name,S.count))}s.gfxAttributes=[];for(var A=0;A<n.attributes.length;A++){var C=n.attributes[A];s.gfxAttributes.push(new Pr(C.name,C.format,C.isNormalized,0,C.isInstanced,C.location))}fm(n,s,kd,"locals"),s.shaderInfo.stages.push(new wr(Di.VERTEX,"")),s.shaderInfo.stages.push(new wr(Di.FRAGMENT,"")),s.handleMap=function(t){for(var e={},n=0;n<t.blocks.length;n++)for(var i=t.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];e[s.name]=$p(i.binding,s.type,s.count,o),o+=(ao(s.type)>>2)*s.count}for(var c=0;c<t.samplerTextures.length;c++){var l=t.samplerTextures[c];e[l.name]=$p(l.binding,l.type,l.count)}return e}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},e.getTemplate=function(t){return this._templates[t]},e.getTemplateInfo=function(t){var e=this._templates[t].hash;return this._templateInfos[e]},e.getDescriptorSetLayout=function(t,e,n){void 0===n&&(n=!1);var i=this._templates[e],r=this._templateInfos[i.hash];return r.setLayouts.length||(um.bindings=r.bindings,r.setLayouts[jd.MATERIAL]=t.createDescriptorSetLayout(um),um.bindings=kd.bindings,r.setLayouts[jd.LOCAL]=t.createDescriptorSetLayout(um)),r.setLayouts[n?jd.LOCAL:jd.MATERIAL]},e.hasProgram=function(t){return void 0!==this._templates[t]},e.getKey=function(t,e){var n=this._templates[t],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=e[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=e[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},e.destroyShaderByDefines=function(t){var e=this,n=Object.keys(t);if(n.length)for(var i=n.map((function(e){var n=t[e];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+e+n)})),r=Object.keys(this._cache).filter((function(t){return i.every((function(n){return n.test(e._cache[t].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];A("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},e.getGFXShader=function(t,e,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(e,n));var o=this._cache[r];if(o)return o;var a=this._templates[e],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(t,e),fm(a,s,Vd,"globals"),s.setLayouts[jd.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=t.createPipelineLayout(new Ur(s.setLayouts)));var c=function(t,e){for(var n=[],i=0;i<e.length;i++){var r=e[i],o=r.name,a=t[o],s=_m(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(t,e){return t+"#define "+e.name+" "+e.value+"\n"}),""),u=a.glsl3,h=mm(t);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(t,e,n){for(var i=[],r=t.attributes,o=e.gfxAttributes,a=0;a<r.length;a++)pm(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(t,e){return t+e.reduce((function(t,e){return e.isDefault?t:t+"|"+e.name+e.value}),"")}(e,c),this._cache[r]=t.createShader(s.shaderInfo)},t}());c.programLib=Tm;var Em=t("EffectAsset",fc("cc.EffectAsset")((bm=Cm=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"techniques",ym,it(e)),at(e,"shaders",xm,it(e)),at(e,"combinations",Sm,it(e)),at(e,"hideInEditor",Am,it(e)),e}Q(e,t),e.register=function(t){e._effects[t.name]=t},e.remove=function(t){if("string"!=typeof t)e._effects[t.name]&&e._effects[t.name].equals(t)&&delete e._effects[t.name];else{if(e._effects[t])return void delete e._effects[t];for(var n in e._effects)if(e._effects[n]._uuid===t)return void delete e._effects[n]}},e.get=function(t){if(e._effects[t])return e._effects[t];for(var n in e._effects)if(e._effects[n]._uuid===t)return e._effects[n];return null},e.getAll=function(){return e._effects};var n=e.prototype;return n.onLoaded=function(){Tm.register(this),e.register(this),c.game.once(c.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var t=this,e=c.director.root,n=function(n){var i=t.shaders[n],r=t.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(t,e){return t.reduce((function(t,n){for(var i=r[e],o=0;o<i.length;++o){var a=J({},n);a[e]=i[o],t.push(a)}return t}),[])}),[{}]).forEach((function(t){return Tm.getGFXShader(e.device,i.name,t,e.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return e.remove(this),t.prototype.destroy.call(this)},n.initDefault=function(n){t.prototype.initDefault.call(this,n);var i=e.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},e}(Ru),Cm._effects={},ym=st((gm=bm).prototype,"techniques",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xm=st(gm.prototype,"shaders",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sm=st(gm.prototype,"combinations",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Am=st(gm.prototype,"hideInEditor",[yc,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vm=gm))||vm);c.EffectAsset=Em;var wm,Pm,Im,Rm,Dm,Mm,Bm,Om,Nm,Lm,Fm,zm,Vm,km,Gm,Um=1024;!function(t){t[t.RGB565=_i.R5G6B5]="RGB565",t[t.RGB5A1=_i.RGB5A1]="RGB5A1",t[t.RGBA4444=_i.RGBA4]="RGBA4444",t[t.RGB888=_i.RGB8]="RGB888",t[t.RGB32F=_i.RGB32F]="RGB32F",t[t.RGBA8888=_i.RGBA8]="RGBA8888",t[t.RGBA32F=_i.RGBA32F]="RGBA32F",t[t.A8=_i.A8]="A8",t[t.I8=_i.L8]="I8",t[t.AI8=_i.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=_i.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=_i.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=Um++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=_i.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=_i.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=Um++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=_i.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=Um++]="RGBA_ETC1",t[t.RGB_ETC2=_i.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=_i.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=_i.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=_i.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=_i.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=_i.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=_i.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=_i.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=_i.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=_i.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=_i.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=_i.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=_i.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=_i.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=_i.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=_i.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(wm||(wm={})),function(t){t[t.REPEAT=Ti.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=Ti.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=Ti.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=Ti.BORDER]="CLAMP_TO_BORDER"}(Pm||(Pm={})),function(t){t[t.NONE=bi.NONE]="NONE",t[t.LINEAR=bi.LINEAR]="LINEAR",t[t.NEAREST=bi.POINT]="NEAREST"}(Im||(Im={})),ce(_i);var Hm,jm,Wm,qm,Xm=new pt("Tex"),Ym=fc("cc.TextureBase")((Gm=km=function(t){function e(){var e;return at(e=t.call(this)||this,"_format",Mm,it(e)),at(e,"_minFilter",Bm,it(e)),at(e,"_magFilter",Om,it(e)),at(e,"_mipFilter",Nm,it(e)),at(e,"_wrapS",Lm,it(e)),at(e,"_wrapT",Fm,it(e)),at(e,"_wrapR",zm,it(e)),at(e,"_anisotropy",Vm,it(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=new gr,e._gfxSampler=null,e._gfxDevice=null,e._textureHash=0,e._id=Xm.getNewId(),e._gfxDevice=e._getGFXDevice(),e._textureHash=vo(e._id,666),e}Q(e,t);var n=e.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(t,e,n){void 0===n&&(n=t),this._wrapS=t,this._samplerInfo.addressU=t,this._wrapT=e,this._samplerInfo.addressV=e,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(t,e){this._minFilter=t,this._samplerInfo.minFilter=t,this._magFilter=e,this._samplerInfo.magFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(t){this._mipFilter=t,this._samplerInfo.mipFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(t){this._anisotropy=t,this._samplerInfo.maxAnisotropy=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var e,n=t.prototype.destroy.call(this);return n&&(null===(e=c.director.root)||void 0===e?void 0:e.batcher2D)&&c.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):D(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(t){var e=t.split(",");e.unshift(""),e.length>=5&&(this.setFilters(parseInt(e[1]),parseInt(e[2])),this.setWrapMode(parseInt(e[3]),parseInt(e[4]))),e.length>=7&&(this.setMipFilter(parseInt(e[5])),this.setAnisotropy(parseInt(e[6])))},n._getGFXDevice=function(){return c.director.root?c.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(t){this._format=void 0===t?wm.RGBA8888:t},n._getGFXPixelFormat=function(t){return t===wm.RGBA_ETC1?t=wm.RGB_ETC1:t===wm.RGB_A_PVRTC_4BPPV1?t=wm.RGB_PVRTC_4BPPV1:t===wm.RGB_A_PVRTC_2BPPV1&&(t=wm.RGB_PVRTC_2BPPV1),t},K(e,[{key:"isCompressed",get:function(){return this._format>=wm.RGB_ETC1&&this._format<=wm.RGBA_ASTC_12x12||this._format>=wm.RGB_A_PVRTC_2BPPV1&&this._format<=wm.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(Ru),km.PixelFormat=wm,km.WrapMode=Pm,km.Filter=Im,Mm=st((Dm=Gm).prototype,"_format",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wm.RGBA8888}}),Bm=st(Dm.prototype,"_minFilter",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Im.LINEAR}}),Om=st(Dm.prototype,"_magFilter",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Im.LINEAR}}),Nm=st(Dm.prototype,"_mipFilter",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Im.NONE}}),Lm=st(Dm.prototype,"_wrapS",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pm.REPEAT}}),Fm=st(Dm.prototype,"_wrapT",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pm.REPEAT}}),zm=st(Dm.prototype,"_wrapR",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pm.REPEAT}}),Vm=st(Dm.prototype,"_anisotropy",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rm=Dm))||Rm;function Km(t){return!!(c.sys.hasFeature(c.sys.Feature.IMAGE_BITMAP)&&t instanceof ImageBitmap)}c.TextureBase=Ym;var Jm=t("ImageAsset",fc("cc.ImageAsset")((qm=Wm=function(t){function e(e){var n;return(n=t.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=wm.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&n.reset(e),n}Q(e,t);var n=e.prototype;return n.reset=function(t){Km(t)||t instanceof HTMLElement?this._nativeData=t:(this._nativeData=t,this._format=t.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Km(this.data)&&this.data.close&&this.data.close(),t.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(t){var n="";"string"==typeof t?n=t:(this._width=t.w,this._height=t.h,n=t.fmt);for(var i,r=c.director.root?c.director.root.device:null,o=n.split("_"),a=Number.MAX_VALUE,s=this._format,l="",u=c.macro.SUPPORT_TEXTURE_FORMATS,h=ot(o);!(i=h()).done;){var _=i.value.split("@"),f=parseInt(_[0],void 0),d=e.extnames[f]||_[0],p=u.indexOf(d);if(-1!==p&&p<a){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==d||r&&r.hasFeature(hi.FORMAT_ASTC)))continue;if(!(".pvr"!==d||r&&r.hasFeature(hi.FORMAT_PVRTC)))continue;if(!(m!==wm.RGB_ETC1&&m!==wm.RGBA_ETC1||r&&r.hasFeature(hi.FORMAT_ETC1)))continue;if(!(m!==wm.RGB_ETC2&&m!==wm.RGBA_ETC2||r&&r.hasFeature(hi.FORMAT_ETC2)))continue;if(".webp"===d&&!c.sys.hasFeature(c.sys.Feature.WEBP))continue;a=p,l=d,s=m}}l?(this._setRawAsset(l),this._format=s):I(3121)},n.initDefault=function(n){if(t.prototype.initDefault.call(this,n),e._sharedPlaceHolderCanvas)this.reset(e._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),e._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},K(e,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(t){t instanceof HTMLElement||Km(t)||(t.format=t.format||this._format),this.reset(t)}},{key:"data",get:function(){return this._nativeData&&((t=this._nativeData)instanceof HTMLImageElement||t instanceof HTMLCanvasElement||Km(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=wm.RGB_ETC1&&this._format<=wm.RGBA_ASTC_12x12||this._format>=wm.RGB_A_PVRTC_2BPPV1&&this._format<=wm.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),e}(Ru),Wm.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Wm._sharedPlaceHolderCanvas=null,st((jm=qm).prototype,"_nativeAsset",[il],Object.getOwnPropertyDescriptor(jm.prototype,"_nativeAsset"),jm.prototype),Hm=jm))||Hm);c.ImageAsset=Jm;var Qm=new WeakMap,Zm=new WeakSet,$m=new WeakSet;function tv(t,e){var n;n=th.safeFindClass;var i,r=Ah.pool.get();try{i=Oh(t,r,{classFinder:n,customEnv:e})}catch(t){throw x(t),Ah.pool.put(r),t}i._uuid=e.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:Ml(h),owner:a[u],prop:s[u],type:ne._getClassById(c[u])}}return Qm.set(i,l),i._native&&Zm.add(i),Ah.pool.put(r),i}var ev,nv=new(function(){function t(){this._depends=new pl}var e=t.prototype;return e.init=function(){this._depends.clear()},e.getNativeDep=function(t){var e=this._depends.get(t);return e&&e.nativeDep?J({},e.nativeDep):null},e.getDeps=function(t){return this._depends.has(t)?this._depends.get(t).deps:[]},e.getDepsRecursively=function(t){var e=Object.create(null),n=[];return this._descend(t,e,n),n},e.remove=function(t){this._depends.remove(t)},e.parse=function(t,e){var n,i,r=null;if(Array.isArray(e)||e.__type__||e instanceof uh){if(this._depends.has(t))return this._depends.get(t);if(!Array.isArray(e)||"number"==typeof(i=(n=e[5])[n.length-1])&&i<0)try{var o=tv(e,{__uuid__:t});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=t),xl.add(t+"@import",o)}catch(e){yl.remove(t+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(e)}}else{if(this._depends.has(t)&&(r=this._depends.get(t)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(e)}return this._depends.add(t,r),r},e._parseDepsFromAsset=function(t){for(var e={deps:[],parsedFromExistAsset:!0},n=Qm.get(t),i=0,r=n.length;i<r;i++)e.deps.push(n[i].uuid);return Zm.has(t)&&(e.nativeDep=t._nativeDep),e},e._parseDepsFromJson=function(t){var e=function(t){return n=(e=t)[1],e[10].map((function(t){return n[t]}));var e,n}(t);return e.forEach((function(t,n){return e[n]=Ml(t)})),e},e._descend=function(t,e,n){for(var i=this.getDeps(t),r=0;r<i.length;r++){var o=i[r];e[o]||(e[o]=!0,n.push(o),this._descend(o,e,n))}},t}()),iv=[new or];function rv(t){return t&&0==(t&t-1)}var ov,av,sv,cv,lv,uv,hv=fc("cc.SimpleTexture")(ev=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gfxTexture=null,e._mipmapLevel=1,e._textureWidth=0,e._textureHeight=0,e}Q(e,t);var n=e.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),t.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(t,e,n){if(void 0===e&&(e=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=e)){var i=this._getGFXDevice();if(i){var r=iv[0];r.texExtent.width=this._textureWidth>>e,r.texExtent.height=this._textureHeight>>e,r.texSubres.mipLevel=e,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(t)?i.copyBuffersToTexture([t],this._gfxTexture,iv):i.copyTexImagesToTexture([t],this._gfxTexture,iv)}}},n._assignImage=function(t,e,n){var i=t.data;if(i&&(this.uploadData(i,e,n),this._checkTextureLoaded(),ue.CLEANUP_IMAGE_CACHE)){var r=nv.getDeps(this._uuid),o=r.indexOf(t._uuid);-1!==o&&(ut(r,o),t.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(t){this._mipmapLevel=t<1?1:t},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var t=this._getGFXDevice();t&&this._createTexture(t)}},n._createTexture=function(t){if(0!==this._width&&0!==this._height){var e=Si.NONE;this._mipFilter!==Im.NONE&&function(t,e,n){return!(t.gfxAPI===li.WEBGL)||rv(e)&&rv(n)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){for(var n=Math.max(t,e),i=0;n;)n>>=1,i++;return i}(this._width,this._height),e=Si.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:xi.SAMPLED|xi.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e});if(n){var i=t.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},K(e,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),e}(Ym))||ev;c.SimpleTexture=hv;var _v,fv,dv,pv,mv,vv,gv,yv=t("Texture2D",(ov=fc("cc.Texture2D"),av=Xc([Jm]),ov((uv=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_mipmaps",lv,it(e)),e}Q(e,t);var n=e.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},n.create=function(t,e,n,i){void 0===n&&(n=wm.RGBA8888),void 0===i&&(i=1),this.reset({width:t,height:e,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(t,e){if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),i=0;i<n;++i){var r=t+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(e,n){var i=e;t.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new Jm,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,ne._getClassId(Jm))}},n._getGfxTextureCreateInfo=function(t){var e=new mr(yi.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t)},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new Jm;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},K(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,n){e._assignImage(t,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(hv),lv=st((cv=uv).prototype,"_mipmaps",[av],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sv=cv))||sv));c.Texture2D=yv,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(gv||(gv={}));var xv=t("TextureCube",fc("cc.TextureCube")((vv=mv=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"isRGBE",dv,it(e)),at(e,"_mipmaps",pv,it(e)),e}Q(e,t),e.fromTexture2DArray=function(t,n){for(var i=[],r=t.length/6,o=0;o<r;o++){var a=6*o;i.push({front:t[a+gv.front].image,back:t[a+gv.back].image,left:t[a+gv.left].image,right:t[a+gv.right].image,top:t[a+gv.top].image,bottom:t[a+gv.bottom].image})}return(n=n||new e).mipmaps=i,n};var n=e.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(t,e){var n=this;if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),r=function(e){var i=t+e;Sv(n._mipmaps[i],(function(t,e){n._assignImage(t,i,e)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(e,n){var i=e;t.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new Jm,back:new Jm,left:new Jm,right:new Jm,top:new Jm,bottom:new Jm};var o=i.mipmaps[r],a=ne._getClassId(Jm);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(t){var e=new mr(yi.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new Jm;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(t){return!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)}))},K(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,n){Sv(t,(function(t,i){e._assignImage(t,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(hv),mv.FaceIndex=gv,dv=st((fv=vv).prototype,"isRGBE",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pv=st(fv.prototype,"_mipmaps",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_v=fv))||_v);function Sv(t,e){e(t.front,gv.front),e(t.back,gv.back),e(t.left,gv.left),e(t.right,gv.right),e(t.top,gv.top),e(t.bottom,gv.bottom)}c.TextureCube=xv;var Av,Cv,bv,Tv=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2554907268,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:730673320,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:4277052359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),Ev={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},wv=function(){function t(){this._device=null,this._resources={}}var e=t.prototype;return e.initBuiltinRes=function(t){var e=this;this._device=t;for(var n=this._resources,i=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),l=0,u=0;u<4;u++)i[l]=0,i[l+1]=0,i[l+2]=0,i[l+3]=255,r[l]=0,r[l+1]=0,r[l+2]=0,r[l+3]=0,o[l]=119,o[l+1]=119,o[l+2]=119,o[l+3]=255,a[l]=255,a[l+1]=255,a[l+2]=255,a[l+3]=255,s[l]=127,s[l+1]=127,s[l+2]=255,s[l+3]=255,l+=4;var h=new Uint8Array(1024);l=0;for(var _=0;_<256;_++)h[l]=221,h[l+1]=221,h[l+2]=221,h[l+3]=255,l+=4;l=0;for(var f=0;f<8;f++){for(var d=0;d<8;d++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}l+=32;for(var p=0;p<8;p++){for(var m=0;m<8;m++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}var v={width:2,height:2,_data:i,_compressed:!1,format:yv.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:yv.PixelFormat.RGBA8888},y={width:2,height:2,_data:o,_compressed:!1,format:yv.PixelFormat.RGBA8888},x={width:2,height:2,_data:a,_compressed:!1,format:yv.PixelFormat.RGBA8888},S={width:2,height:2,_data:s,_compressed:!1,format:yv.PixelFormat.RGBA8888},A={width:16,height:16,_data:h,_compressed:!1,format:yv.PixelFormat.RGBA8888},C=new Jm(v),b=new yv;b._uuid="black-texture",b.image=C,n[b._uuid]=b;var T=new Jm(g),E=new yv;E._uuid="empty-texture",E.image=T,n[E._uuid]=E;var w=new xv;w._uuid="black-cube-texture",w.setMipFilter(xv.Filter.NEAREST),w.image={front:new Jm(v),back:new Jm(v),left:new Jm(v),right:new Jm(v),top:new Jm(v),bottom:new Jm(v)},n[w._uuid]=w;var P=new Jm(y),I=new yv;I._uuid="grey-texture",I.image=P,n[I._uuid]=I;var R=new Jm(x),D=new yv;D._uuid="white-texture",D.image=R,n[D._uuid]=D;var M=new xv;M._uuid="white-cube-texture",M.setMipFilter(xv.Filter.NEAREST),M.image={front:new Jm(x),back:new Jm(x),left:new Jm(x),right:new Jm(x),top:new Jm(x),bottom:new Jm(x)},n[M._uuid]=M;var B=new Jm(S),O=new yv;O._uuid="normal-texture",O.image=B,n[O._uuid]=O;var N=new Jm(A),L=new yv;L._uuid="default-texture",L.image=N,n[L._uuid]=L;var F=new xv;if(F.setMipFilter(xv.Filter.NEAREST),F._uuid="default-cube-texture",F.image={front:new Jm(A),back:new Jm(A),left:new Jm(A),right:new Jm(A),top:new Jm(A),bottom:new Jm(A)},n[F._uuid]=F,c.SpriteFrame){var z=new c.SpriteFrame,V=C,k=new yv;k.image=V,z.texture=k,z._uuid="default-spriteframe",n[z._uuid]=z}var G=mm(t);if(!G)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var U=Ev[G];return U?Promise.resolve().then((function(){Tv.forEach((function(t,e){var n=Object.assign(new c.EffectAsset,t);n.shaders.forEach((function(t,n){var i=U[e][n];i&&(t[G]=i)})),n.hideInEditor=!0,n.onLoaded()})),e._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+G+" but shaders of that version are not assembled in this build."))},e.get=function(t){return this._resources[t]},e._initMaterials=function(){var t=this._resources,e=[],n=new c.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),t[n._uuid]=n,e.push(n);var i=new c.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",c.color("#ffff00")),t[i._uuid]=i,e.push(i);var r=new c.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",c.color("#ff00ff")),t[r._uuid]=r,e.push(r);var o=new c.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[o._uuid]=o,e.push(o);var a=new c.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[a._uuid]=a,e.push(a);var s=new c.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[s._uuid]=s,e.push(s);var l=new c.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[l._uuid]=l,e.push(l);var u=new c.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[u._uuid]=u,e.push(u);var h=new c.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[h._uuid]=h,e.push(h);var _=new c.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[_._uuid]=_,e.push(_);var f=new c.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),t[f._uuid]=f,e.push(f);var d=new c.Material;d._uuid="default-particle-material",d.initialize({effectName:"particle"}),t[d._uuid]=d,e.push(d);var p=new c.Material;p._uuid="default-particle-gpu-material",p.initialize({effectName:"particle-gpu"}),t[p._uuid]=p,e.push(p);var m=new c.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),t[m._uuid]=m,e.push(m);var v=new c.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),t[v._uuid]=v,e.push(v);var g=new c.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[g._uuid]=g,e.push(g),c.game.on(c.Game.EVENT_GAME_INITED,(function(){for(var t=0;t<e.length;++t)for(var n=e[t],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},t}(),Pv=t("builtinResMgr",c.builtinResMgr=new wv),Iv=t("getPhaseID",(Av=new Map,Cv=0,function(t){return"number"==typeof t?t:(Av.has(t)||(Av.set(t,1<<Cv),Cv++),Av.get(t))})),Rv=t("InstancedBuffer",function(){function t(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.instances.length;++t){var e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0},e.merge=function(t,e,n,i){void 0===i&&(i=null);var r=e.buffer.length;if(r){var o=t.inputAssembler,a=t.descriptorSet.getTexture(Mp),s=i;s||(s=t.shaders[n]);for(var c=t.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(e.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,32*r,r)),d=new Uint8Array(32*r),p=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<e.attributes.length;g++){var y=e.attributes[g],x=new Pr(y.name,y.format,y.isNormalized,p.length,!0);m.push(x)}d.set(e.buffer),p.push(f);var S=new Rr(m,p,v),A=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:f,data:d,ia:A,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},e.uploadBuffers=function(t){for(var e=0;e<this.instances.length;++e){var n=this.instances[e];n.count&&(n.ia.instanceCount=n.count,t.updateBuffer(n.vb,n.data))}},e.clear=function(){for(var t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1},t}()),Dv=function(){function t(t){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.batches.length;++t){for(var e=this.batches[t],n=0;n<e.vbs.length;++n)e.vbs[n].destroy();e.vbIdx.destroy(),e.ia.destroy(),e.ubo.destroy()}this.batches.length=0},e.merge=function(t,e,n){var i=t.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=t.passes[e],c=t.shaders[e],l=t.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<_p.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var d=0;d<_.vbs.length;++d){var p=i[d],m=_.vbs[d],v=_.vbDatas[d];(r=(a+_.vbCount)*p.stride)>m.size&&(m.resize(r),_.vbDatas[d]=new Uint8Array(r),_.vbDatas[d].set(v)),_.vbDatas[d].set(p.buffer,_.vbCount*p.stride)}var g=_.vbIdxData;(o=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(o),_.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+a,S=_.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var A=y;A<x;A++)g[A]=S+.1;return Hn.toArray(_.uboData,n.transform.worldMatrix,_p.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(_p.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var C=[],b=[],T=[],E=0;E<i.length;++E){var w=i[E],P=this._device.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,w.count*w.stride,w.stride));P.update(w.buffer.buffer),C.push(P),b.push(new Uint8Array(P.size)),T.push(P)}var I=this._device.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,4*a,4)),R=new Float32Array(a);R.fill(0),I.update(R),T.push(I);for(var D=t.inputAssembler.attributes,M=new Array(D.length+1),B=0;B<D.length;++B)M[B]=D[B];M[D.length]=new Pr("a_dyn_batch_id",_i.R32F,!1,i.length);var O=new Rr(M,T),N=this._device.createInputAssembler(O),L=this._device.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,_p.SIZE,_p.SIZE));l.bindBuffer(_p.BINDING,L),l.update();var F=new Float32Array(_p.COUNT);Hn.toArray(F,n.transform.worldMatrix,_p.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:C,vbDatas:b,vbIdx:I,vbIdxData:R,vbCount:a,ia:N,ubo:L,uboData:F,pass:s,shader:c,descriptorSet:l})}},e.clear=function(){for(var t=0;t<this.batches.length;++t){var e=this.batches[t];e.vbCount=0,e.mergeCount=0,e.ia.vertexCount=0}},t}(),Mv=new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.DEVICE),Bv=new _r(null),Ov=new Gr(null);!function(t){t[t.NONE=0]="NONE",t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(bv||(bv={}));var Nv=function(){function t(t){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new To,this._dss=new Co,this._rs=new Ao,this._priority=Od.DEFAULT,this._stage=Bd.DEFAULT,this._phase=Iv("default"),this._primitive=Fi.TRIANGLE_LIST,this._batchingScheme=bv.NONE,this._dynamicStates=Gi.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=t,this._device=t.device}t.fillPipelineInfo=function(t,e){void 0!==e.priority&&t._setPriority(e.priority),void 0!==e.primitive&&t._setPrimitive(e.primitive),void 0!==e.stage&&t._setStage(e.stage),void 0!==e.dynamicStates&&t._setDynamicState(e.dynamicStates),void 0!==e.phase&&t._setPhase(Iv(e.phase));var n=t._bs;if(e.blendState){var i=e.blendState,r=i.targets;r&&r.forEach((function(t,e){n.setTarget(e,t)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)},t.getPassHash=function(t){var e,n=Tm.getKey(t.program,t.defines)+","+t._primitive+","+t._dynamicStates;return n+=function(t){for(var e,n=",bs,"+t.isA2C,i=ot(t.targets);!(e=i()).done;){var r=e.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(t._bs),n+=function(t){var e=",dss,"+t.depthTest+","+t.depthWrite+","+t.depthFunc;return e+=","+t.stencilTestFront+","+t.stencilFuncFront+","+t.stencilRefFront+","+t.stencilReadMaskFront,e+=","+t.stencilFailOpFront+","+t.stencilZFailOpFront+","+t.stencilPassOpFront+","+t.stencilWriteMaskFront,(e+=","+t.stencilTestBack+","+t.stencilFuncBack+","+t.stencilRefBack+","+t.stencilReadMaskBack)+","+t.stencilFailOpBack+","+t.stencilZFailOpBack+","+t.stencilPassOpBack+","+t.stencilWriteMaskBack}(t._dss),vo(n+=",rs,"+(e=t._rs).cullMode+","+e.depthBias+","+e.isFrontFaceCCW,666)};var e=t.prototype;return e.initialize=function(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()},e.getHandle=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=di.UNKNOWN);var i=this._propertyHandleMap[t];return i?(n?i=rm(i,n):e&&(i=rm(i,tm(i)-e)),i+e):0},e.getBinding=function(e){var n=this.getHandle(e);return n?t.getBindingFromHandle(n):-1},e.setUniform=function(e,n){var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,i);am[r](a,n,o),this._setRootBufferDirty(!0)},e.getUniform=function(e,n){var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,i);return om[r](a,n,o)},e.setUniformArray=function(e,n){for(var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=ao(r)>>2,a=this._getBlockView(r,i),s=t.getOffsetFromHandle(e),c=0;c<n.length;c++,s+=o)null!==n[c]&&am[r](a,n[c],s);this._setRootBufferDirty(!0)},e.bindTexture=function(t,e,n){this._descriptorSet.bindTexture(t,e,n||0)},e.bindSampler=function(t,e,n){this._descriptorSet.bindSampler(t,e,n||0)},e.setDynamicState=function(t,e){var n=this._dynamics[t];n&&n.value===e||(n.value=e,n.dirty=!0)},e.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},e._setRootBufferDirty=function(t){this._rootBufferDirty=t},e.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):D(12006)},e.getInstancedBuffer=function(t){return void 0===t&&(t=0),this._instancedBuffers[t]||(this._instancedBuffers[t]=new Rv(this))},e.getBatchedBuffer=function(t){return void 0===t&&(t=0),this._batchedBuffers[t]||(this._batchedBuffers[t]=new Dv(this))},e._initNative=function(){},e._destroy=function(){},e.destroy=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++){var e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},e.resetUniform=function(e){var n=this.getHandle(e);if(n){for(var i=t.getTypeFromHandle(n),r=t.getBindingFromHandle(n),o=t.getOffsetFromHandle(n),a=t.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[e],l=c&&c.value||cm(i),u=(ao(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},e.resetTexture=function(e,n){var i=this.getHandle(e);if(i){var r=t.getTypeFromHandle(i),o=t.getBindingFromHandle(i),a=this._properties[e],s=a&&a.value,c=s?s+"-texture":cm(r),l=Pv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?Ro.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(o,_,n),this._descriptorSet.bindTexture(o,u,n)}},e.resetUBOs=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++)for(var e=this._shaderInfo.blocks[t],n=0,i=0;i<e.members.length;i++){for(var r=e.members[i],o=this._getBlockView(r.type,e.binding),a=this._properties[r.name],s=a&&a.value||cm(r.type),c=(ao(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},e.resetTextures=function(){for(var t=0;t<this._shaderInfo.samplerTextures.length;t++)for(var e=this._shaderInfo.samplerTextures[t],n=0;n<e.count;n++)this.resetTexture(e.name,n)},e.tryCompile=function(){var e=this._root.pipeline;if(!e)return!1;this._syncBatchingScheme();var n=Tm.getGFXShader(this._device,this._programName,this._defines,e);return n?(this._shader=n,this._setPipelineLayout(Tm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},e.getShaderVariant=function(t){if(void 0===t&&(t=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!t)return this._shader;for(var e=this._root.pipeline,n=0;n<t.length;n++){var i=t[n];this._defines[i.name]=i.value}for(var r=Tm.getGFXShader(this._device,this._programName,this._defines,e),o=0;o<t.length;o++){var a=t[o];delete this._defines[a.name]}return r},e.beginChangeStatesSilently=function(){},e.endChangeStatesSilently=function(){},e._setPriority=function(t){this._priority=t},e._setStage=function(t){this._stage=t},e._setPhase=function(t){this._phase=t},e._setPrimitive=function(t){this._primitive=t},e._setState=function(t,e,n,i){this._bs=t,this._dss=e,this._rs=n,this._descriptorSet=i},e._doInit=function(e,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(Od.DEFAULT),this._setStage(Bd.DEFAULT),this._setPhase(Iv("default")),this._setPrimitive(Fi.TRIANGLE_LIST),this._passIndex=e.passIndex,this._propertyIndex=void 0!==e.propertyIndex?e.propertyIndex:e.passIndex,this._programName=e.program,this._defines=n?J({},e.defines):e.defines,this._shaderInfo=Tm.getTemplate(e.program),this._properties=e.properties||this._properties;var i=this._device;t.fillPipelineInfo(this,e),e.stateOverrides&&t.fillPipelineInfo(this,e.stateOverrides),Ov.layout=Tm.getDescriptorSetLayout(this._device,e.program),this._descriptorSet=this._device.createDescriptorSet(Ov),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=Tm.getTemplateInfo(e.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,_=0;_<r.length;_++){var f=a[_];l.push(h),h+=Math.ceil(f/c)*c,u=f}var d=l[l.length-1]+u;d&&(Mv.size=16*Math.ceil(d/16),this._rootBuffer=i.createBuffer(Mv),this._rootBlock=new ArrayBuffer(d));for(var p=0,m=0;p<r.length;p++){var v=r[p].binding,g=a[p];Bv.buffer=this._rootBuffer,Bv.offset=l[m++],Bv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Bv);this._blocks[v]=new Float32Array(this._rootBlock,Bv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var x=this._propertyHandleMap=s,S={};for(var A in this._properties){var C=this._properties[A];C.handleInfo&&(S[A]=this.getHandle.apply(this,C.handleInfo))}Object.assign(x,S)},e._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(hi.INSTANCED_ARRAYS)?this._setBatchingScheme(bv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(bv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(bv.VB_MERGING):this._setBatchingScheme(bv.NONE)},e._setBatchingScheme=function(t){this._batchingScheme=t},e._setDynamicState=function(t){this._dynamicStates=t},e._setHash=function(t){this._hash=t},e._getBlockView=function(t,e){return t<di.FLOAT?this._blocksInt[e]:this._blocks[e]},e._setPipelineLayout=function(t){this._pipelineLayout=t},e._initPassFromTarget=function(t,e,n,i){this._initNative(),this._setPriority(t.priority),this._setStage(t.stage),this._setPhase(t.phase),this._setBatchingScheme(t.batchingScheme),this._setPrimitive(t.primitive),this._setDynamicState(t.dynamicStates),this._setState(n,e,t.rasterizerState,t.descriptorSet),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._blocksInt=t._blocksInt,this._dynamics=t._dynamics,this._shader=t._shader,this._setPipelineLayout(Tm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t._hash^i)},K(t,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Tm.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),t}();Nv.getTypeFromHandle=tm,Nv.getBindingFromHandle=em,Nv.getCountFromHandle=nm,Nv.getOffsetFromHandle=im;var Lv=t("PipelineStateManager",function(){function t(){}return t.getOrCreatePipelineState=function(t,e,n,i,r){var o=e.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=e.pipelineLayout,c=new Hr(r.attributes),l=new Eo(n,s,i,c,e.rasterizerState,e.depthStencilState,e.blendState,e.primitive,e.dynamicStates);a=t.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},t}());Lv._PSOHashMap=new Map;var Fv=new ar,zv=new $i;function Vv(t,e){t.x=e.x*e.x,t.y=e.y*e.y,t.z=e.z*e.z}var kv,Gv,Uv,Hv,jv,Wv,qv,Xv,Yv,Kv,Jv=null;function Qv(t,e,n,i,r){if(i&&i.enabled&&r===Jv){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;Fv.width=zv.width=r.window.width,Fv.height=zv.height=r.window.height;var u=Lv.getOrCreatePipelineState(t,s[0],c[0],e,a);n.setViewport(Fv),n.setScissor(zv),n.bindPipelineState(u),n.bindDescriptorSet(jd.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(jd.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var Zv,$v,tg,eg,ng,ig=new Qn,rg=t("Material",(kv=fc("cc.Material"),Gv=Xc(Em),kv((Kv=function(t){function e(){var e;return at(e=t.call(this)||this,"_effectAsset",jv,it(e)),at(e,"_techIdx",Wv,it(e)),at(e,"_defines",qv,it(e)),at(e,"_states",Xv,it(e)),at(e,"_props",Yv,it(e)),e._passes=[],e._hash=0,e}Q(e,t),e.getHash=function(t){for(var e,n=0,i=ot(t.passes);!(e=i()).done;)n^=e.value.hash;return n};var n=e.prototype;return n.initialize=function(t){this._passes.length?I(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(t),this._update())},n.reset=function(t){this.initialize(t)},n.destroy=function(){return this._doDestroy(),t.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(t){void 0===t&&(t=!0),this._props.length=this._passes.length;for(var e=0;e<this._props.length;e++)this._props[e]={};if(t)for(var n,i=ot(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(t,e,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,t,e)&&(this._props[c.propertyIndex][t]=e,i=!0)}i||console.warn("illegal property name: "+t+".")},n.getProperty=function(t,e){if(void 0===e)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(t in o)return o[t]}else{if(e>=this._props.length)return console.warn("illegal pass index: "+e+"."),null;var a=this._props[this._passes[e].propertyIndex];if(t in a)return a[t]}return null},n.copy=function(t,e){this._techIdx=t._techIdx,this._props.length=t._props.length;for(var n=0;n<t._props.length;n++)this._props[n]=J({},t._props[n]);this._defines.length=t._defines.length;for(var i=0;i<t._defines.length;i++)this._defines[i]=J({},t._defines[i]);this._states.length=t._states.length;for(var r=0;r<t._states.length;r++)this._states[r]=J({},t._states[r]);this._effectAsset=t._effectAsset,e&&this._fillInfo(e),this._update()},n._fillInfo=function(t){void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=Em.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states)},n._prepareInfo=function(t,e){var n=t;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(e[r]||(e[r]={}),n[r])},n._createPasses=function(){var t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];for(var e=t.passes.length,n=[],i=0;i<e;++i){var r=t.passes[i],o=r.passIndex=i,a=r.defines=this._defines[o]||(this._defines[o]={});if(r.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var s=new Nv(c.director.root);s.initialize(r),n.push(s)}}return n},n._update=function(t){var n=this;if(void 0===t&&(t=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,t)this._passes.forEach((function(t,e){var i=n._props[e];for(var r in i||(i=n._props[e]={}),void 0!==t.propertyIndex&&Object.assign(i,n._props[t.propertyIndex]),i)n._uploadProperty(t,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=e.getHash(this)},n._uploadProperty=function(t,e,n){var i=t.getHandle(e);if(!i)return!1;if(Nv.getTypeFromHandle(i)<di.SAMPLER1D)if(Array.isArray(n))t.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=t.properties[e])||void 0===r?void 0:r.linear){var o=n;Vv(ig,o),ig.w=o.w,n=ig}t.setUniform(i,n)}else t.resetUniform(e);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(t,i,n[a],a);else n?this._bindTexture(t,i,n):t.resetTexture(e);return!0},n._bindTexture=function(t,e,n,i){var r=Nv.getBindingFromHandle(e);if(n instanceof Mo)t.bindTexture(r,n,i);else if(n instanceof Ym){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;t.bindTexture(r,o,i),t.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var t,e=ot(this._passes);!(t=e()).done;)t.value.destroy();this._passes.length=0},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new En("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},K(e,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),e}(Ru),jv=st((Hv=Kv).prototype,"_effectAsset",[Gv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wv=st(Hv.prototype,"_techIdx",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qv=st(Hv.prototype,"_defines",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xv=st(Hv.prototype,"_states",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yv=st(Hv.prototype,"_props",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uv=Hv))||Uv));c.Material=rg,function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(Zv||(Zv={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}($v||($v={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(tg||(tg={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(eg||(eg={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(ng||(ng={}));var og=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],ag=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],sg=[100,200,400,800],cg=new Pn,lg=new Pn,ug=new Hn,hg=Xi.STENCIL<<1,_g=[],fg=function(){function t(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Zv.VERTICAL,this._fov=un(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new sr(.2,.2,.2,1),this._viewport=new ni(0,0,1,1),this._orientedViewport=new ni(0,0,1,1),this._curTransform=ui.IDENTITY,this._isProjDirty=!0,this._matView=new Hn,this._matProj=new Hn,this._matProjInv=new Hn,this._matViewProj=new Hn,this._matViewProjInv=new Hn,this._frustum=new nc,this._forward=new Pn,this._position=new Pn,this._priority=0,this._aperture=tg.F16_0,this._apertureValue=void 0,this._shutter=ng.D125,this._shutterValue=0,this._iso=eg.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Xi.NONE,this._clearDepth=1,this._visibility=qp,this._exposure=0,this._clearStencil=0,this._device=t,this._apertureValue=og[this._aperture],this._shutterValue=ag[this._shutter],this._isoValue=sg[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!_g.length){var e=t.capabilities.clipSpaceSignY;_g[ui.IDENTITY]=new Hn(1,0,0,0,0,e),_g[ui.ROTATE_90]=new Hn(0,1,0,0,-e,0),_g[ui.ROTATE_180]=new Hn(-1,0,0,0,0,-e),_g[ui.ROTATE_270]=new Hn(0,-1,0,0,e,0)}}var e=t.prototype;return e._setWidth=function(t){this._width=t},e._setHeight=function(t){this._height=t},e._setScene=function(t){this._scene=t},e._updateAspect=function(t){if(void 0===t&&(t=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){var e=this.window.swapchain;(e&&e.surfaceTransform||ui.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},e._init=function(){},e.initialize=function(t){this._init(t),this.node=t.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Xi.NONE,this.clearDepth=1,this.visibility=qp,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)},e._destroy=function(){},e.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},e.attachToScene=function(t){this._enabled=!0,this._setScene(t)},e.detachFromScene=function(){this._enabled=!1,this._setScene(null)},e.resize=function(t,e){this._window&&(this._setWidth(t),this._setHeight(e),this._updateAspect())},e.setFixedSize=function(t,e){this._setWidth(t),this._setHeight(e),this._updateAspect(!1),this.isWindowSize=!1},e.syncCameraEditor=function(){},e.update=function(t){var e;if(void 0===t&&(t=!1),this._node){var n=!1;(this._node.hasChangedFlags||t)&&(Hn.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(e=this.window)||void 0===e?void 0:e.swapchain,r=i&&i.surfaceTransform||ui.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===$v.PERSPECTIVE)Hn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Zv.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;Hn.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}Hn.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(Hn.multiply(this._matViewProj,this._matProj,this._matView),Hn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},e.setViewportInOrientedSpace=function(t){var e,n=t.x,i=t.width,r=t.height,o=this._device.capabilities.screenSpaceSignY<0?1-t.y-r:t.y,a=null===(e=this.window)||void 0===e?void 0:e.swapchain;switch(a&&a.surfaceTransform||ui.IDENTITY){case ui.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case ui.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case ui.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case ui.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},e.changeTargetWindow=function(t){void 0===t&&(t=null),this._window&&this._window.detachCamera(this);var e=t||c.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;var n=e.swapchain;(n&&n.surfaceTransform||ui.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}},e.detachCamera=function(){this._window&&this._window.detachCamera(this)},e.screenPointToRay=function(t,e,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===$v.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Un[this._curTransform];Pn.set(cg,(e-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var _=cg.x,f=cg.y;return cg.x=_*h[0]+f*h[2]*u,cg.y=_*h[1]+f*h[3]*u,Pn.transformMat4(l?cg:t.o,cg,this._matViewProjInv),l?(this._node.getWorldPosition(lg),$o.fromPoints(t,lg,cg)):Pn.transformQuat(t.d,Pn.FORWARD,this._node.worldRotation),t},e.screenToWorld=function(t,e){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Un[this._curTransform];if(this._proj===$v.PERSPECTIVE){Pn.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,1);var u=t.x,h=t.y;t.x=u*l[0]+h*l[2]*c,t.y=u*l[1]+h*l[3]*c,Pn.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(cg),Pn.lerp(t,cg,t,ln(this._nearClip/this._farClip,1,e.z))}else{Pn.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,2*e.z-1);var _=t.x,f=t.y;t.x=_*l[0]+f*l[2]*c,t.y=_*l[1]+f*l[3]*c,Pn.transformMat4(t,t,this._matViewProjInv)}return t},e.worldToScreen=function(t,e){var n=this._device.capabilities.clipSpaceSignY,i=Un[this._curTransform];Pn.transformMat4(t,e,this._matViewProj);var r=t.x,o=t.y;t.x=r*i[0]+o*i[2]*n,t.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return t.x=c+.5*(t.x+1)*u,t.y=l+.5*(t.y+1)*h,t.z=.5*t.z+.5,t},e.worldMatrixToScreen=function(t,e,n,i){Hn.multiply(t,this._matViewProj,e),Hn.multiply(t,_g[this._curTransform],t);var r=n/2,o=i/2;return Hn.identity(ug),Hn.transform(ug,ug,Pn.set(cg,r,o,0)),Hn.scale(ug,ug,Pn.set(cg,r,o,1)),Hn.multiply(t,ug,t),t},e.setExposure=function(t){this._exposure=.833333/Math.pow(2,t)},e.updateExposure=function(){var t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)},K(t,[{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(t){this._proj=t,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){this._fovAxis=t,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(t){this._nearClip=t,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(t){this._farClip=t,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w}},{key:"viewport",get:function(){return this._viewport},set:function(t){I(8302),this.setViewportInOrientedSpace(t)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(t){this._frustum=t}},{key:"window",get:function(){return this._window},set:function(t){this._window=t}},{key:"forward",get:function(){return this._forward},set:function(t){this._forward=t}},{key:"position",get:function(){return this._position},set:function(t){this._position=t}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._apertureValue=og[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._shutterValue=ag[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._isoValue=sg[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(t){this._ec=t}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(t){this._clearFlag=t}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),t}(),dg=oe({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),pg=oe({Planar:0,ShadowMap:1}),mg=oe({HARD:0,SOFT:1,SOFT_2X:2}),vg=pg.ShadowMap+1,gg=function(){function t(){this.fixedSphere=new aa(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Hn,this.matShadowProj=new Hn,this.matShadowViewProj=new Hn,this._normal=new Pn(0,1,0),this._shadowColor=new En(0,0,0,76),this._matLight=new Hn,this._material=null,this._instancingMaterial=null,this._size=new Xn(512,512),this._enabled=!1,this._distance=0,this._type=vg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var e=t.prototype;return e.getPlanarShader=function(t){return this._material||(this._material=new rg,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(t)},e.getPlanarInstanceShader=function(t){return this._instancingMaterial||(this._instancingMaterial=new rg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(t)},e._setEnable=function(t){this._enabled=t},e._setType=function(t){this._type=this.enabled?t:vg},e.initialize=function(t){this.near=t.near,this.far=t.far,this.invisibleOcclusionRange=t.invisibleOcclusionRange,this.shadowDistance=t.shadowDistance,this.orthoSize=t.orthoSize,this.size=t.size,this.pcf=t.pcf,this.normal=t.normal,this.distance=t.distance,this.shadowColor=t.shadowColor,this.bias=t.bias,this.normalBias=t.normalBias,this.maxReceived=t.maxReceived,this.fixedArea=t.fixedArea,this._setEnable(t.enabled),this._setType(t.type),this.saturation=t.saturation},e.activate=function(){this.enabled&&this.type===pg.Planar&&this._updatePlanarInfo()},e._updatePlanarInfo=function(){this._material||(this._material=new rg,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new rg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},e._destroy=function(){},e.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(t){Pn.copy(this._normal,t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor=t}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=t}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=t}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.activate()}},{key:"near",get:function(){return this._near},set:function(t){this._near=t}},{key:"far",get:function(){return this._far},set:function(t){this._far=t}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t}},{key:"size",get:function(){return this._size},set:function(t){this._size.set(t)}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(t){this._shadowMapDirty=t}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t}},{key:"saturation",get:function(){return this._saturation},set:function(t){this._saturation=t}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),t}();gg.MAX_FAR=2e3,gg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),c.Shadows=gg;var yg=new Pn,xg=(new Pn,new Pn,new Pn),Sg=new Hn,Ag=new js,Cg=new js,bg=!1,Tg=aa.create(0,0,0,1),Eg=new aa,wg=new nc;wg.accurate=!0;var Pg=new nc;Pg.accurate=!0;var Ig=new nc,Rg=new Hn,Dg=new Hn,Mg=new Hn,Bg=new Hn,Og=new Hn,Ng=new Hn,Lg=new Hn,Fg=new Pn,zg=new Xn,Vg=new Pn,kg=new Pn,Gg=new Pn(0,0,0),Ug=(new js,new Ul((function(){return{model:null,depth:0}}),128)),Hg=new Ul((function(){return{model:null,depth:0}}),128),jg=new Ul((function(){return{model:null,depth:0}}),128);function Wg(t,e){var n=0;t.node&&(Pn.subtract(yg,t.node.worldPosition,e.position),n=Pn.dot(yg,e.forward));var i=Ug.alloc();return i.model=t,i.depth=n,i}function qg(t,e){var n=0;t.node&&(Pn.subtract(yg,t.node.worldPosition,e.position),n=Pn.dot(yg,e.forward));var i=Hg.alloc();return i.model=t,i.depth=n,i}function Xg(t,e){var n=0;t.node&&(Pn.subtract(yg,t.node.worldPosition,e.position),n=Pn.dot(yg,e.forward));var i=jg.alloc();return i.model=t,i.depth=n,i}function Yg(t,e,n){var i=e.direction,r=t.normal,o=t.distance+.001,a=1/Pn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=t.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,Hn.toArray(n,f,Jd.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Kg(t,e){Pn.normalize(yg,t.normal),e[Jd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=yg.x,e[Jd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=yg.y,e[Jd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=yg.z,e[Jd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=t.distance}function Jg(t,e){var n=t.pipelineSceneData.validPunctualLights;n.length=0;for(var i=e.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(aa.set(Tg,o.position.x,o.position.y,o.position.z,o.range),us.sphereFrustum(Tg,e.frustum)&&n.push(o))}for(var a=e.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(aa.set(Tg,c.position.x,c.position.y,c.position.z,c.range),us.sphereFrustum(Tg,e.frustum)&&n.push(c))}}function Qg(t,e){var n=e.scene,i=n.mainLight,r=t.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;Ug.freeArray(s),s.length=0;var c=r.castShadowObjects;jg.freeArray(c),c.length=0,bg=!1;var l=null;if(o.enabled&&(t.pipelineUBO.updateShadowUBORange(Jd.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===pg.ShadowMap))if(l=t.pipelineSceneData.dirShadowObjects,Hg.freeArray(l),l.length=0,i&&i.node)!function(t,e,n,i,r){var o=e.device;if(r.fixedArea){var a=r.orthoSize,s=r.orthoSize,c=r.near,l=r.far;Hn.fromRT(Rg,n.node.getWorldRotation(),n.node.getWorldPosition()),Hn.invert(Dg,Rg),Hn.ortho(Bg,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),Hn.multiply(Og,Bg,Dg),Hn.invert(Mg,Dg),r.matShadowView=Dg,r.matShadowProj=Bg,r.matShadowViewProj=Og,nc.createOrtho(t,2*a,2*s,c,l,Mg)}else{var u=r.invisibleOcclusionRange,h=r.size.x;!function(t,e){if(e.node){var n=e.node,i=n.getWorldPosition(),r=n.getWorldRotation();Hn.fromRT(t,r,i),t.m08*=-1,t.m09*=-1,t.m10*=-1}}(Sg,i),nc.split(wg,i,Sg,.1,r.shadowDistance),Pg=nc.clone(wg),Hn.fromRT(Rg,n.node.rotation,Gg),Hn.invert(Dg,Rg),Hn.invert(Mg,Dg);var _=Dg.clone();Pg.transform(Dg),js.fromPoints(Ag,new Pn(1e7,1e7,1e7),new Pn(-1e7,-1e7,-1e7)),Ag.mergeFrustum(Pg);var f=2*Ag.halfExtents.z;xg.set(Ag.center.x,Ag.center.y,Ag.center.z+Ag.halfExtents.z+u),Pn.transformMat4(xg,xg,Mg),Hn.fromRT(Rg,n.node.rotation,xg),Hn.invert(Dg,Rg),Hn.invert(Mg,Dg);var d=Pn.distance(wg.vertices[0],wg.vertices[6]);Eg.center.set(0,0,0),Eg.radius=-1,Eg.mergePoints(wg.vertices);var p=.8*d+.4*Eg.radius;r.shadowCameraFar=f+u;var m=.5*p;if(Hn.ortho(Bg,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){Hn.multiply(Ng,Bg,_),Pn.transformMat4(Fg,xg,Ng);var v=2/h;zg.set(v,v);var g=Fg.x%zg.x,y=Fg.y%zg.y;Vg.set(Fg.x-g,Fg.y-y,Fg.z),Hn.invert(Lg,Ng),Pn.transformMat4(kg,Vg,Lg),Hn.fromRT(Rg,n.node.rotation,kg),Hn.invert(Dg,Rg),Hn.invert(Mg,Dg),nc.createOrtho(t,p,p,.1,r.shadowCameraFar,Mg)}else{for(var x=0;x<8;x++)t.vertices[x].set(0,0,0);t.updatePlanes()}Hn.multiply(Og,Bg,Dg),r.matShadowView=Dg,r.matShadowProj=Bg,r.matShadowViewProj=Og}}(Ig,t,i,e,o);else{for(var u=0;u<8;u++)Ig.vertices[u].set(0,0,0);Ig.updatePlanes()}i&&o.type===pg.Planar&&function(t,e){var n=t.pipelineSceneData.shadows,i=e.direction,r=n.normal,o=n.distance+.001,a=1/Pn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,t.pipelineUBO.updateShadowUBORange(Jd.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(t,i),a.enabled&&a.model&&e.clearFlag&hg&&s.push(Wg(a.model,e));for(var h=n.models,_=e.visibility,f=0;f<h.length;f++){var d=h[f];if(d.enabled&&(d.castShadow&&c.push(Xg(d,e)),o.firstSetCSM&&d.worldBounds&&(bg||(Cg.copy(d.worldBounds),bg=!0),js.merge(Cg,Cg,d.worldBounds)),d.node&&(_&d.node.layer)===d.node.layer||_&d.visFlags)){if(null!=l&&d.castShadow&&d.worldBounds&&us.aabbFrustum(d.worldBounds,Ig)&&l.push(qg(d,e)),d.worldBounds&&!us.aabbFrustum(d.worldBounds,e.frustum))continue;s.push(Wg(d,e))}}o.firstSetCSM&&(o.shadowDistance=2*Cg.halfExtents.length(),o.firstSetCSM=!1)}var Zg,$g,ty,ey=new gr(bi.LINEAR,bi.LINEAR,bi.NONE,Ti.CLAMP,Ti.CLAMP,Ti.CLAMP),ny=new gr(bi.POINT,bi.POINT,bi.NONE,Ti.CLAMP,Ti.CLAMP,Ti.CLAMP),iy=function(){function t(t){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=t.device,this._linearSampler=this._device.getSampler(ey),this._pointSampler=this._device.getSampler(ny);var e=new kr(Vd.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new Gr(this._descriptorSetLayout))}var e=t.prototype;return e.bindBuffer=function(t,e){this._globalDescriptorSet.bindBuffer(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(t,e),i=n.next()},e.bindSampler=function(t,e){this._globalDescriptorSet.bindSampler(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(t,e),i=n.next()},e.bindTexture=function(t,e){this._globalDescriptorSet.bindTexture(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(t,e),i=n.next()},e.update=function(){this._globalDescriptorSet.update();for(var t=this._descriptorSetMap.values(),e=t.next();!e.done;)e.value.update(),e=t.next()},e.getOrCreateDescriptorSet=function(t){var e=this._device;if(!this._descriptorSetMap.has(t)){var n=this._globalDescriptorSet,i=e.createDescriptorSet(new Gr(this._descriptorSetLayout));this._descriptorSetMap.set(t,i);for(var r=zd.UBO_GLOBAL;r<zd.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=e.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,Jd.SIZE,Jd.SIZE));i.bindBuffer(Jd.BINDING,o),i.update()}return this._descriptorSetMap.get(t)},e.destroy=function(){this._descriptorSetLayout.destroy()},K(t,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),t}();function ry(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);var n=e*e,i=(.860117757+.000154118254*e+1.28641212e-7*n)/(1+.000842420235*e+7.08145163e-7*n),r=(.317398726+422806245e-13*e+4.20481691e-8*n)/(1-289741816e-13*e+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);t.x=3.2404542*c-1.5371385+-.4985314*l,t.y=-.969266*c+1.8760108+.041556*l,t.z=.0556434*c-.2040259+1.0572252*l}!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(Zg||(Zg={})),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}($g||($g={})),c.internal.TransformBit=$g,function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(ty||(ty={}));var oy,ay,sy,cy,ly,uy,hy,_y,fy,dy,py=function(t){return 4*Math.PI*Math.PI*t*t},my=function(){function t(){this._baked=!1,this._color=new Pn(1,1,1),this._colorTemp=6550,this._colorTempRGB=new Pn(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=ty.UNKNOWN}var e=t.prototype;return e._init=function(){},e._destroy=function(){},e.initialize=function(){this._init(),this.color=new Pn(1,1,1),this.colorTemperature=6550},e.attachToScene=function(t){this._scene=t},e.detachFromScene=function(){this._scene=null},e.destroy=function(){this._name=null,this._node=null,this._destroy()},e.update=function(){},K(t,[{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"color",get:function(){return this._color},set:function(t){this._color.set(t)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(t){this._colorTemp=t,ry(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,this._node&&(this._node.hasChangedFlags|=$g.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),t}(),vy=new Hn,gy=new Hn,yy=new Hn,xy=new Qn,Sy=new Qn(0,0,1,0),Ay=function(){function t(){this._globalUBO=new Float32Array(Yd.COUNT),this._cameraUBO=new Float32Array(Kd.COUNT),this._shadowUBO=new Float32Array(Jd.COUNT)}t.updateGlobalUBOView=function(t,e){var n=c.director.root,i=e,r=Math.floor(t.width),o=Math.floor(t.height);i[Yd.TIME_OFFSET]=n.cumulativeTime,i[Yd.TIME_OFFSET+1]=n.frameTime,i[Yd.TIME_OFFSET+2]=c.director.getTotalFrames(),i[Yd.SCREEN_SIZE_OFFSET]=r,i[Yd.SCREEN_SIZE_OFFSET+1]=o,i[Yd.SCREEN_SIZE_OFFSET+2]=1/r,i[Yd.SCREEN_SIZE_OFFSET+3]=1/o,i[Yd.NATIVE_SIZE_OFFSET]=r,i[Yd.NATIVE_SIZE_OFFSET+1]=o,i[Yd.NATIVE_SIZE_OFFSET+2]=1/i[Yd.NATIVE_SIZE_OFFSET],i[Yd.NATIVE_SIZE_OFFSET+3]=1/i[Yd.NATIVE_SIZE_OFFSET+1]},t.updateCameraUBOView=function(t,e,n){var i=(n.scene?n.scene:c.director.getScene().renderScene).mainLight,r=t.pipelineSceneData,o=r.ambient,a=r.fog,s=r.shadows,l=e,u=n.exposure,h=r.isHDR;if(l[Kd.SCREEN_SCALE_OFFSET]=r.shadingScale,l[Kd.SCREEN_SCALE_OFFSET+1]=r.shadingScale,l[Kd.SCREEN_SCALE_OFFSET+2]=1/l[Kd.SCREEN_SCALE_OFFSET],l[Kd.SCREEN_SCALE_OFFSET+3]=1/l[Kd.SCREEN_SCALE_OFFSET+1],l[Kd.EXPOSURE_OFFSET]=u,l[Kd.EXPOSURE_OFFSET+1]=1/u,l[Kd.EXPOSURE_OFFSET+2]=h?1:0,l[Kd.EXPOSURE_OFFSET+3]=0,i){var _=s.enabled&&s.type===pg.ShadowMap?1:0,f=i.direction;if(Sy.set(f.x,f.y,f.z,_),Qn.toArray(l,Sy,Kd.MAIN_LIT_DIR_OFFSET),Pn.toArray(l,i.color,Kd.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var d=i.colorTemperatureRGB;l[Kd.MAIN_LIT_COLOR_OFFSET]*=d.x,l[Kd.MAIN_LIT_COLOR_OFFSET+1]*=d.y,l[Kd.MAIN_LIT_COLOR_OFFSET+2]*=d.z}l[Kd.MAIN_LIT_COLOR_OFFSET+3]=h?i.illuminance*u:i.illuminance}else Sy.set(0,0,1,0),Qn.toArray(l,Sy,Kd.MAIN_LIT_DIR_OFFSET),Qn.toArray(l,Qn.ZERO,Kd.MAIN_LIT_COLOR_OFFSET);var p=o.skyColor;p.w=h?o.skyIllum*u:o.skyIllum,l[Kd.AMBIENT_SKY_OFFSET+0]=p.x,l[Kd.AMBIENT_SKY_OFFSET+1]=p.y,l[Kd.AMBIENT_SKY_OFFSET+2]=p.z,l[Kd.AMBIENT_SKY_OFFSET+3]=p.w,l[Kd.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,l[Kd.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,l[Kd.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,l[Kd.AMBIENT_GROUND_OFFSET+3]=o.mipmapCount,Hn.toArray(l,n.matView,Kd.MAT_VIEW_OFFSET),Hn.toArray(l,n.node.worldMatrix,Kd.MAT_VIEW_INV_OFFSET),Pn.toArray(l,n.position,Kd.CAMERA_POS_OFFSET),Hn.toArray(l,n.matProj,Kd.MAT_PROJ_OFFSET),Hn.toArray(l,n.matProjInv,Kd.MAT_PROJ_INV_OFFSET),Hn.toArray(l,n.matViewProj,Kd.MAT_VIEW_PROJ_OFFSET),Hn.toArray(l,n.matViewProjInv,Kd.MAT_VIEW_PROJ_INV_OFFSET),l[Kd.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var m=a.colorArray;l[Kd.GLOBAL_FOG_COLOR_OFFSET]=m.x,l[Kd.GLOBAL_FOG_COLOR_OFFSET+1]=m.y,l[Kd.GLOBAL_FOG_COLOR_OFFSET+2]=m.z,l[Kd.GLOBAL_FOG_COLOR_OFFSET+3]=m.z,l[Kd.GLOBAL_FOG_BASE_OFFSET]=a.fogStart,l[Kd.GLOBAL_FOG_BASE_OFFSET+1]=a.fogEnd,l[Kd.GLOBAL_FOG_BASE_OFFSET+2]=a.fogDensity,l[Kd.GLOBAL_FOG_ADD_OFFSET]=a.fogTop,l[Kd.GLOBAL_FOG_ADD_OFFSET+1]=a.fogRange,l[Kd.GLOBAL_FOG_ADD_OFFSET+2]=a.fogAtten,l[Kd.NEAR_FAR_OFFSET]=n.nearClip,l[Kd.NEAR_FAR_OFFSET+1]=n.farClip,l[Kd.VIEW_PORT_OFFSET]=r.shadingScale*n.window.width*n.viewport.x,l[Kd.VIEW_PORT_OFFSET+1]=r.shadingScale*n.window.height*n.viewport.y,l[Kd.VIEW_PORT_OFFSET+2]=r.shadingScale*n.window.width*n.viewport.z,l[Kd.VIEW_PORT_OFFSET+3]=r.shadingScale*n.window.height*n.viewport.w},t.updateShadowUBOView=function(t,e,n){var i=t.device,r=n.scene.mainLight,o=t.pipelineSceneData.shadows,a=e;if(o.enabled){if(r&&o.type===pg.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;o.fixedArea?(s=o.near,c=o.far):(s=.1,c=o.shadowCameraFar),Hn.toArray(e,l,Jd.MAT_LIGHT_VIEW_OFFSET),a[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[Jd.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[Jd.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[Jd.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[Jd.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Hn.toArray(e,h,Jd.MAT_LIGHT_VIEW_PROJ_OFFSET);var _=Kp(i)?0:1;a[Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,a[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===pg.Planar&&(Yg(o,r,a),Kg(o,a));En.toArray(a,o.shadowColor,Jd.SHADOW_COLOR_OFFSET)}},t.updateShadowUBOLightView=function(t,e,n){var i=t.device,r=t.pipelineSceneData.shadows,o=e,a=Kp(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case ty.DIRECTIONAL:r.fixedArea?(s=r.near,c=r.far):(s=.1,c=r.shadowCameraFar),Hn.toArray(e,l,Jd.MAT_LIGHT_VIEW_OFFSET),o[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[Jd.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[Jd.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[Jd.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[Jd.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Hn.toArray(e,h,Jd.MAT_LIGHT_VIEW_PROJ_OFFSET),xy.set(s,c,0,1-r.saturation),Qn.toArray(o,xy,Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),xy.set(0,a,r.normalBias,0),Qn.toArray(o,xy,Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case ty.SPOT:Hn.invert(vy,n.node.getWorldMatrix()),Hn.toArray(o,vy,Jd.MAT_LIGHT_VIEW_OFFSET),Hn.perspective(gy,n.angle,n.aspect,.001,n.range),Hn.multiply(yy,gy,vy),Hn.toArray(o,yy,Jd.MAT_LIGHT_VIEW_PROJ_OFFSET),xy.set(.01,n.range,0,1-r.saturation),Qn.toArray(o,xy,Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),xy.set(1,a,r.normalBias,0),Qn.toArray(o,xy,Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}xy.set(r.size.x,r.size.y,r.pcf,r.bias),Qn.toArray(o,xy,Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),En.toArray(o,r.shadowColor,Jd.SHADOW_COLOR_OFFSET)},t.getCombineSignY=function(){return t._combineSignY};var e=t.prototype;return e._initCombineSignY=function(){var e=this._device;t._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},e.activate=function(t,e){this._device=t,this._pipeline=e;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=t.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,Yd.SIZE,Yd.SIZE));n.bindBuffer(Yd.BINDING,i);var r=t.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,Kd.SIZE,Kd.SIZE));n.bindBuffer(Kd.BINDING,r);var o=t.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,Jd.SIZE,Jd.SIZE));n.bindBuffer(Jd.BINDING,o)},e.updateGlobalUBO=function(e){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),t.updateGlobalUBOView(e,this._globalUBO),r[0].updateBuffer(i.getBuffer(Yd.BINDING),this._globalUBO),n.bindBuffer(Yd.BINDING,i.getBuffer(Yd.BINDING)),n.update()},e.updateCameraUBO=function(e){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;t.updateCameraUBOView(this._pipeline,this._cameraUBO,e),r[0].updateBuffer(i.getBuffer(Kd.BINDING),this._cameraUBO),n.bindBuffer(Kd.BINDING,i.getBuffer(Kd.BINDING)),n.update()},e.updateShadowUBO=function(e){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=e.scene.mainLight;a&&o.has(a)&&i.bindTexture(Qd,o.get(a).colorTextures[0]),t.updateShadowUBOView(this._pipeline,this._shadowUBO,e),i.update(),r[0].updateBuffer(i.getBuffer(Jd.BINDING),this._shadowUBO)}},e.updateShadowUBOLight=function(e,n){t.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),e.bindTexture(Qd,Pv.get("default-texture").getGFXTexture()),e.bindTexture(ap,Pv.get("default-texture").getGFXTexture()),e.update(),e.getBuffer(Jd.BINDING).update(this._shadowUBO)},e.updateShadowUBORange=function(t,e){e instanceof Hn?Hn.toArray(this._shadowUBO,e,t):e instanceof En&&En.toArray(this._shadowUBO,e,t)},e.destroy=function(){},t}();Ay._combineSignY=0;var Cy,by,Ty,Ey,wy,Py,Iy,Ry,Dy,My,By,Oy,Ny,Ly=t("RenderStage",(oy=fc("RenderStage"),ay=kc(),sy=kc(),cy=kc(),oy((dy=function(){function t(){at(this,"_name",hy,this),at(this,"_priority",_y,this),this._enabled=!0,at(this,"_tag",fy,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,t.tag&&(this._tag=t.tag),!0},e.activate=function(t,e){this._pipeline=t,this._flow=e},K(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}}]),t}(),hy=st((uy=dy).prototype,"_name",[ay,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_y=st(uy.prototype,"_priority",[sy,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fy=st(uy.prototype,"_tag",[cy,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ly=uy))||ly));c.RenderStage=Ly;var Fy,zy=t("RenderFlow",(Cy=fc("RenderFlow"),by=kc(),Ty=kc(),Ey=kc(),wy=kc(),Py=Xc([Ly]),Cy((Ny=function(){function t(){at(this,"_name",Dy,this),at(this,"_priority",My,this),at(this,"_tag",By,this),at(this,"_stages",Oy,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,this._stages=t.stages,t.tag&&(this._tag=t.tag),!0},e.activate=function(t){this._pipeline=t,this._stages.sort((function(t,e){return t.priority-e.priority}));for(var e=0,n=this._stages.length;e<n;e++)this._stages[e].activate(t,this)},e.render=function(t){for(var e=0,n=this._stages.length;e<n;e++)this._stages[e].enabled&&this._stages[e].render(t)},e.destroy=function(){for(var t=0,e=this._stages.length;t<e;t++)this._stages[t].destroy();this._stages.length=0},K(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),t}(),Dy=st((Ry=Ny).prototype,"_name",[by,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),My=st(Ry.prototype,"_priority",[Ty,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),By=st(Ry.prototype,"_tag",[Ey,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oy=st(Ry.prototype,"_stages",[wy,Py,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Iy=Ry))||Iy));c.RenderFlow=zy,function(t){t.RENDER_FRAME_BEGIN="render-frame-begin",t.RENDER_FRAME_END="render-frame-end",t.RENDER_CAMERA_BEGIN="render-camera-begin",t.RENDER_CAMERA_END="render-camera-end",t.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(Fy||(Fy=t("PipelineEventType",{})));var Vy,ky,Gy,Uy,Hy,jy,Wy,qy,Xy,Yy,Ky,Jy,Qy,Zy,$y,tx=t("PipelineEventProcessor",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e}Q(e,t);var n=e.prototype;return n.on=function(t,e,n,i){return this.eventTargetOn(t,e,n,i)},n.once=function(t,e,n){return this.eventTargetOnce(t,e,n)},e}($l)),ex=new $i,nx=new ar,ix=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},rx=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},ox=t("RenderPipeline",(Vy=fc("cc.RenderPipeline"),ky=kc(),Gy=kc(),Uy=Xc([zy]),Vy((Xy=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_tag",Wy,it(e)),at(e,"_flows",qy,it(e)),e._quadIB=null,e._quadVBOnscreen=null,e._quadVBOffscreen=null,e._quadIAOnscreen=null,e._quadIAOffscreen=null,e._eventProcessor=new tx,e._commandBuffers=[],e._pipelineUBO=new Ay,e._macros={},e._constantMacros="",e._profiler=null,e._pipelineRenderData=null,e._renderPasses=new Map,e._width=0,e._height=0,e._lastUsedRenderArea=new $i,e._clusterEnabled=!1,e._bloomEnabled=!1,e}Q(e,t);var n=e.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(t){return this._flows=t.flows,t.tag&&(this._tag=t.tag),!0},n.createRenderPass=function(t,e,n){var i=this._device,r=new Dr,o=new Mr;r.format=e,o.format=n,o.stencilStoreOp=Bi.DISCARD,o.depthStoreOp=Bi.DISCARD,t&Xi.COLOR||(t&hg?r.loadOp=Mi.DISCARD:(r.loadOp=Mi.LOAD,r.beginAccesses=[Oi.COLOR_ATTACHMENT_WRITE])),(t&Xi.DEPTH_STENCIL)!==Xi.DEPTH_STENCIL&&(t&Xi.DEPTH||(o.depthLoadOp=Mi.LOAD),t&Xi.STENCIL||(o.stencilLoadOp=Mi.LOAD)),o.beginAccesses=[Oi.DEPTH_STENCIL_ATTACHMENT_WRITE];var a=new Nr([r],o);return i.createRenderPass(a)},n.getRenderPass=function(t,e){var n=this._renderPasses.get(t);return n||(n=this.createRenderPass(t,e.colorTextures[0].format,e.depthStencilTexture.format),this._renderPasses.set(t,n),n)},n.applyFramebufferRatio=function(t){for(var e=this.pipelineSceneData,n=this._width*e.shadingScale,i=this._height*e.shadingScale,r=t.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);t.depthStencilTexture&&t.depthStencilTexture.resize(n,i),t.destroy(),t.initialize(new zr(t.renderPass,r,t.depthStencilTexture))},n.generateRenderArea=function(t,e){var n=t.viewport,i=t.window.width,r=t.window.height;e.x=n.x*i,e.y=n.y*r,e.width=n.width*i,e.height=n.height*r},n.generateViewport=function(t,e){this.generateRenderArea(t,ex),e||(e=nx);var n=this.pipelineSceneData.shadingScale;return e.left=ex.x*n,e.top=ex.y*n,e.width=ex.width*n,e.height=ex.height*n,e},n.generateScissor=function(t,e){e||(e=ex),this.generateRenderArea(t,e);var n=this.pipelineSceneData.shadingScale;return e.x*=n,e.y*=n,e.width*=n,e.height*=n,e},n.activate=function(){var t=c.director.root;this._device=t.device,this._generateConstantMacros(),this._globalDSManager=new iy(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(t){if(0!==t.length){this._commandBuffers[0].begin(),this.emit(Fy.RENDER_FRAME_BEGIN,t),this._ensureEnoughSize(t),function(t){for(var e=t.length-1;e>=0;--e){var n=t[e];if(n.window.swapchain)return void(Jv=n)}Jv=null}(t);for(var e=0;e<t.length;e++){var n=t[e];if(n.scene){this.emit(Fy.RENDER_CAMERA_BEGIN,n),Jg(this,n),Qg(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(Fy.RENDER_CAMERA_END,n)}}this.emit(Fy.RENDER_FRAME_END,t),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var t,e=this._pipelineRenderData.bloom;if(null!==e){e.prefiterTex&&e.prefiterTex.destroy(),e.prefilterFramebuffer&&e.prefilterFramebuffer.destroy();for(var n=0;n<e.downsampleTexs.length;++n)e.downsampleTexs[n].destroy(),e.downsampleFramebuffers[n].destroy();e.downsampleTexs.length=0,e.downsampleFramebuffers.length=0;for(var i=0;i<e.upsampleTexs.length;++i)e.upsampleTexs[i].destroy(),e.upsampleFramebuffers[i].destroy();e.upsampleTexs.length=0,e.upsampleFramebuffers.length=0,e.combineTex&&e.combineTex.destroy(),e.combineFramebuffer&&e.combineFramebuffer.destroy(),null===(t=e.renderPass)||void 0===t||t.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(t,e){var n=new Float32Array(16),i=e.x/this._width,r=(e.x+e.width)/this._width,o=e.y/this._height,a=(e.y+e.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(t){case ui.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case ui.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case ui.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case ui.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var t=new rx,e=4*Float32Array.BYTES_PER_ELEMENT,n=4*e,i=this._device.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.DEVICE|gi.HOST,n,e));if(!i)return t;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new hr(pi.INDEX|pi.TRANSFER_DST,gi.DEVICE,o,r));if(!a)return t;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Pr("a_position",_i.RG32F),c[1]=new Pr("a_texCoord",_i.RG32F);var l=this._device.createInputAssembler(new Rr(c,[i],a));return t.quadIB=a,t.quadVB=i,t.quadIA=l,t},n.updateQuadVertexData=function(t,e){var n=this._lastUsedRenderArea;if(n.x!==t.x||n.y!==t.y||n.width!==t.width||n.height!==t.height){var i=this._genQuadVertexData(ui.IDENTITY,t);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(e.swapchain&&e.swapchain.surfaceTransform||ui.IDENTITY,t);this._quadVBOnscreen.update(r),n.copy(t)}},n.destroy=function(){for(var e,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(e=this._globalDSManager)||void 0===e||e.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),t.prototype.destroy.call(this)},n._generateConstantMacros=function(){var t="";t+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(hi.TEXTURE_FLOAT)?1:0)+"\n",t+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",t+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",t+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",t+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(hi.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",t+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(fu.os===ru.ANDROID&&fu.isBrowser?1:0)+"\n",t+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(ue.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=t},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var t=this._pipelineRenderData.bloom=new ix,e=this.device,n=new Dr;n.format=_i.RGBA8,n.loadOp=Mi.CLEAR,n.storeOp=Bi.STORE,n.endAccesses=[Oi.COLOR_ATTACHMENT_WRITE],t.renderPass=e.createRenderPass(new Nr([n]));var i=this._width,r=this._height;t.prefiterTex=e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA8,i>>1,r>>1)),t.prefilterFramebuffer=e.createFramebuffer(new zr(t.renderPass,[t.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)t.downsampleTexs.push(e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA8,i>>1,r>>1))),t.downsampleFramebuffers[o]=e.createFramebuffer(new zr(t.renderPass,[t.downsampleTexs[o]])),t.upsampleTexs.push(e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA8,i,r))),t.upsampleFramebuffers[o]=e.createFramebuffer(new zr(t.renderPass,[t.upsampleTexs[o]])),i>>=1,r>>=1;t.combineTex=e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA8,this._width,this._height)),t.combineFramebuffer=e.createFramebuffer(new zr(t.renderPass,[t.combineTex])),t.sampler=this.globalDSManager.linearSampler}},n.on=function(t,e,n,i){return this._eventProcessor.on(t,e,n,i)},n.once=function(t,e,n){return this._eventProcessor.once(t,e,n)},n.off=function(t,e,n){this._eventProcessor.off(t,e,n)},n.emit=function(t,e,n,i,r,o){this._eventProcessor.emit(t,e,n,i,r,o)},n.targetOff=function(t){this._eventProcessor.targetOff(t)},n.removeAll=function(t){this._eventProcessor.removeAll(t)},n.hasEventListener=function(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)},K(e,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(t){this._profiler=t}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(t){this._clusterEnabled=t}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(t){this._bloomEnabled=t}}]),e}(Ru),Wy=st((jy=Xy).prototype,"_tag",[ky,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qy=st(jy.prototype,"_flows",[Gy,Uy,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hy=jy))||Hy));c.RenderPipeline=ox,function(t){t[t.BLOOM=18]="BLOOM",t[t.POST_PROCESS=19]="POST_PROCESS",t[t.UI=20]="UI"}(Yy||(Yy={})),function(t){t[t.FORWARD=10]="FORWARD"}(Ky||(Ky={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.FORWARD=1]="FORWARD",t[t.UI=10]="UI"}(Jy||(Jy={})),function(t){t[t.GBUFFER=10]="GBUFFER",t[t.LIGHTING=15]="LIGHTING",t[t.TRANSPARENT=18]="TRANSPARENT"}(Qy||(Qy={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.MAIN=1]="MAIN",t[t.UI=10]="UI"}(Zy||(Zy={}));var ax=new Dr;ax.format=_i.RGBA8,ax.beginAccesses=[Oi.FRAGMENT_SHADER_READ_TEXTURE],ax.endAccesses=[Oi.FRAGMENT_SHADER_READ_TEXTURE];var sx=new Mr;sx.format=_i.DEPTH_STENCIL;var cx,lx,ux,hx,_x,fx,dx,px,mx,vx,gx,yx,xx,Sx,Ax,Cx,bx,Tx,Ex,wx,Px,Ix,Rx,Dx,Mx,Bx,Ox,Nx,Lx,Fx,zx,Vx,kx,Gx,Ux,Hx,jx,Wx,qx,Xx,Yx,Kx,Jx,Qx,Zx,$x,tS,eS,nS,iS,rS,oS,aS,sS,cS,lS,uS,hS,_S,fS,dS,pS,mS,vS,gS,yS,xS,SS,AS,CS,bS,TS,ES,wS,PS,IS,RS,DS,MS,BS=new Nr([ax],sx),OS={width:1,height:1,renderPassInfo:BS},NS=t("RenderTexture",fc("cc.RenderTexture")($y=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._window=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)},n.reset=function(t){this.initialize(t)},n.destroy=function(){if(this._window){var e=c.director.root;null==e||e.destroyWindow(this._window),this._window=null}return t.prototype.destroy.call(this)},n.resize=function(t,e){this._width=Math.floor(sn(t,1,2048)),this._height=Math.floor(sn(e,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(e,n){var i=e;this._width=i.w,this._height=i.h,this._name=i.n,t.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(t){var e=c.director.root;OS.title=this._name,OS.width=this._width,OS.height=this._height,OS.renderPassInfo=t&&t.passInfo?t.passInfo:BS,this._window?(this._window.destroy(),this._window.initialize(e.device,OS)):this._window=e.createWindow(OS)},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),n=n||this.width,i=i||this.height;var o=this.getGFXTexture();if(!o)return D(7606),null;var a=4*n*i;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return D(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new or;return u.texOffset.x=t,u.texOffset.y=e,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},K(e,[{key:"window",get:function(){return this._window}}]),e}(Ym))||$y);c.RenderTexture=NS,ce(yi),ce(xi),ce(Bi),ce(Mi),ce(Oi),function(t){t[t.SCENE=0]="SCENE",t[t.POSTPROCESS=1]="POSTPROCESS",t[t.UI=2]="UI"}(MS||(MS={})),ce(MS),cx=fc("RenderTextureDesc"),lx=Xc(yi),ux=Xc(xi),hx=Xc(_i),cx((fx=st((_x=function(){at(this,"name",fx,this),at(this,"type",dx,this),at(this,"usage",px,this),at(this,"format",mx,this),at(this,"width",vx,this),at(this,"height",gx,this)}).prototype,"name",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dx=st(_x.prototype,"type",[lx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yi.TEX2D}}),px=st(_x.prototype,"usage",[ux],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xi.COLOR_ATTACHMENT}}),mx=st(_x.prototype,"format",[hx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _i.UNKNOWN}}),vx=st(_x.prototype,"width",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),gx=st(_x.prototype,"height",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),_x));var LS,FS=(yx=fc("RenderTextureConfig"),xx=Xc(NS),yx((Cx=st((Ax=function(){at(this,"name",Cx,this),at(this,"texture",bx,this)}).prototype,"name",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bx=st(Ax.prototype,"texture",[xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sx=Ax))||Sx),zS=(Tx=fc("MaterialConfig"),Ex=Xc(rg),Tx((Px=st((wx=function(){at(this,"name",Px,this),at(this,"material",Ix,this)}).prototype,"name",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ix=st(wx.prototype,"material",[Ex],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wx)),Rx=fc("FrameBufferDesc"),Dx=Xc([Ne]),Mx=Xc(NS),Rx((Ox=st((Bx=function(){at(this,"name",Ox,this),at(this,"renderPass",Nx,this),at(this,"colorTextures",Lx,this),at(this,"depthStencilTexture",Fx,this),at(this,"texture",zx,this)}).prototype,"name",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Nx=st(Bx.prototype,"renderPass",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lx=st(Bx.prototype,"colorTextures",[Dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fx=st(Bx.prototype,"depthStencilTexture",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zx=st(Bx.prototype,"texture",[Mx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bx)),Vx=fc("ColorDesc"),kx=Xc(_i),Gx=Xc(Mi),Ux=Xc(Bi),Hx=Xc([Oi]),jx=Xc([Oi]),Vx((Xx=st((qx=function(){at(this,"format",Xx,this),at(this,"loadOp",Yx,this),at(this,"storeOp",Kx,this),at(this,"sampleCount",Jx,this),at(this,"beginAccesses",Qx,this),at(this,"endAccesses",Zx,this)}).prototype,"format",[kx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _i.UNKNOWN}}),Yx=st(qx.prototype,"loadOp",[Gx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.CLEAR}}),Kx=st(qx.prototype,"storeOp",[Ux],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.STORE}}),Jx=st(qx.prototype,"sampleCount",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Qx=st(qx.prototype,"beginAccesses",[Hx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zx=st(qx.prototype,"endAccesses",[jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Oi.COLOR_ATTACHMENT_WRITE]}}),Wx=qx))||Wx),VS=($x=fc("DepthStencilDesc"),tS=Xc(_i),eS=Xc(Mi),nS=Xc(Bi),iS=Xc(Mi),rS=Xc(Bi),oS=Xc([Oi]),aS=Xc([Oi]),$x((lS=st((cS=function(){at(this,"format",lS,this),at(this,"depthLoadOp",uS,this),at(this,"depthStoreOp",hS,this),at(this,"stencilLoadOp",_S,this),at(this,"stencilStoreOp",fS,this),at(this,"sampleCount",dS,this),at(this,"beginAccesses",pS,this),at(this,"endAccesses",mS,this)}).prototype,"format",[tS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _i.UNKNOWN}}),uS=st(cS.prototype,"depthLoadOp",[eS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.CLEAR}}),hS=st(cS.prototype,"depthStoreOp",[nS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.STORE}}),_S=st(cS.prototype,"stencilLoadOp",[iS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.CLEAR}}),fS=st(cS.prototype,"stencilStoreOp",[rS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.STORE}}),dS=st(cS.prototype,"sampleCount",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pS=st(cS.prototype,"beginAccesses",[oS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mS=st(cS.prototype,"endAccesses",[aS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Oi.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),sS=cS))||sS);vS=fc("RenderPassDesc"),gS=Xc([zS]),yS=Xc(VS),vS((SS=st((xS=function(){at(this,"index",SS,this),at(this,"colorAttachments",AS,this),at(this,"depthStencilAttachment",CS,this)}).prototype,"index",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),AS=st(xS.prototype,"colorAttachments",[gS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CS=st(xS.prototype,"depthStencilAttachment",[yS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new VS}}),xS)),function(t){t[t.FRONT_TO_BACK=0]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(LS||(LS={})),ce(LS);var kS=(bS=fc("RenderQueueDesc"),TS=Xc(LS),ES=Xc([Ne]),bS((IS=st((PS=function(){at(this,"isTransparent",IS,this),at(this,"sortMode",RS,this),at(this,"stages",DS,this)}).prototype,"isTransparent",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RS=st(PS.prototype,"sortMode",[TS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LS.FRONT_TO_BACK}}),DS=st(PS.prototype,"stages",[ES],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wS=PS))||wS);function GS(t,e){return t.hash-e.hash||t.depth-e.depth||t.shaderId-e.shaderId}function US(t,e){return t.hash-e.hash||e.depth-t.depth||t.shaderId-e.shaderId}var HS=function(){function t(t){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new Hl((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new jl(64,this._passDesc.sortFunc)}var e=t.prototype;return e.clear=function(){this.queue.clear(),this._passPool.reset()},e.insertRenderPass=function(t,e,n){var i=t.model.subModels[e],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=t.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},e.sort=function(){this.queue.sort()},e.recordCommandBuffer=function(t,e,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=Lv.getOrCreatePipelineState(t,c,l,e,s);n.bindPipelineState(u),n.bindDescriptorSet(jd.MATERIAL,c.descriptorSet),n.bindDescriptorSet(jd.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},t}();function jS(t){for(var e=0,n=0;n<t.stages.length;n++)e|=Iv(t.stages[n]);var i=GS;switch(t.sortMode){case LS.BACK_TO_FRONT:i=US;break;case LS.FRONT_TO_BACK:i=GS}return new HS({isTransparent:t.isTransparent,phases:e,sortFunc:i})}function WS(t){t.clear()}function qS(t){t.sort()}var XS=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),n=e.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);t.updateBuffer(r.vbIdx,r.vbIdxData.buffer),t.updateBuffer(r.ubo,r.uboData)}}n=e.next()}},e.recordCommandBuffer=function(t,e,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=Lv.getOrCreatePipelineState(t,s.pass,c,e,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(jd.MATERIAL,s.pass.descriptorSet),o=!0}n.bindDescriptorSet(jd.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},t}(),YS=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),n=e.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(t),n=e.next()},e.recordCommandBuffer=function(t,e,n){for(var i=this.queue.values(),r=i.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){n.bindDescriptorSet(jd.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,_=Lv.getOrCreatePipelineState(t,s,h,e,u.ia);c!==_&&(n.bindPipelineState(_),c=_),n.bindDescriptorSet(jd.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},t}(),KS=function(){function t(){this._groundAlbedoHDR=new Qn(.2,.2,.2,1),this._skyColorHDR=new Qn(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Qn(.2,.2,.2,1),this._skyColorLDR=new Qn(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}var e=t.prototype;return e.initialize=function(t){this._skyColorHDR=t.skyColorHDR,this._groundAlbedoHDR.set(t.groundAlbedoHDR),this._skyIllumHDR=t.skyIllumHDR,this._skyColorLDR=t.skyColorLDR,this._groundAlbedoLDR.set(t.groundAlbedoLDR),this._skyIllumLDR=t.skyIllumLDR},e._destroy=function(){},e.destroy=function(){this._destroy()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"skyColor",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t)}},{key:"skyIllum",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t}},{key:"groundAlbedo",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(t){this._mipmapCount=t}},{key:"native",get:function(){return this._nativeObj}}]),t}();KS.SUN_ILLUM=65e3,KS.SKY_ILLUM=2e4,c.Ambient=KS;var JS,QS=function(){function t(){this._enabled=!1,this._minPos=new Pn(0,0,0),this._maxPos=new Pn(0,0,0),this._depth=0}var e=t.prototype;return e.initialize=function(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth},e._destroy=function(){},e.destroy=function(){this._destroy()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),ZS=new Gr(null),$S=function(){function t(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Od.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var e=t.prototype;return e._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},e._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},e._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},e._createDescriptorSet=function(t){this._descriptorSet=this._device.createDescriptorSet(t)},e._createWorldBoundDescriptorSet=function(t){this._worldBoundDescriptorSet=this._device.createDescriptorSet(t)},e._setInputAssembler=function(t){this._inputAssembler=this._device.createInputAssembler(t)},e._setSubMesh=function(t){this._subMesh=t},e._init=function(){},e.initialize=function(t,e,n){void 0===n&&(n=null);var i=c.director.root;this._device=i.device,ZS.layout=e[0].localSetLayout,this._init(),this._setInputAssembler(t.iaInfo),this._createDescriptorSet(ZS);var r=c.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),o=new Gr(null);if(o.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(t),this._patches=n,this._passes=e,this._flushPassInfo(),e[0].batchingScheme===bv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Od.DEFAULT,e[0].phase===Iv("reflection")){var a=i.mainWindow.width,s=i.mainWindow.height,l=512;s<a?(a=l*a/s,s=l):s=l*s/(a=l),this._reflectionTex=this._device.createTexture(new mr(yi.TEX2D,xi.STORAGE|xi.TRANSFER_SRC|xi.SAMPLED,_i.RGBA8,a,s)),this.descriptorSet.bindTexture(zp,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new gr(bi.LINEAR,bi.LINEAR,bi.NONE,Ti.CLAMP,Ti.CLAMP,Ti.CLAMP)),this.descriptorSet.bindSampler(zp,this._reflectionSampler),this.descriptorSet.bindTexture(Gp,this._reflectionTex)}},e._initNativePlanarShadowShader=function(t){this._planarShader=t.getPlanarShader(this._patches)},e.initPlanarShadowShader=function(){var t=c.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(t)},e._initNativePlanarShadowInstanceShader=function(t){this._planarInstanceShader=t.getPlanarInstanceShader(this._patches)},e.initPlanarShadowInstanceShader=function(){var t=c.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(t)},e._destroy=function(){},e.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Od.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},e.update=function(){for(var t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},e.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var n=t[e];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},e.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var n=0;n<e.length;n++){var i=e[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},e._flushPassInfo=function(){var t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(var e=0,n=t.length;e<n;e++)this._shaders[e]=t[e].getShaderVariant(this.patches)}},K(t,[{key:"passes",get:function(){return this._passes},set:function(t){t.length>8?D(12004,8):(this._passes=t,this._flushPassInfo(),this._passes[0].batchingScheme===bv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),ZS.layout=t[0].localSetLayout,this._createDescriptorSet(ZS)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(t){this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===bv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(t)}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),t}(),tA=new Hn,eA=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(JS||(JS={}));var nA=new gr(bi.LINEAR,bi.LINEAR,bi.NONE,Ti.CLAMP,Ti.CLAMP,Ti.CLAMP),iA=new gr(bi.LINEAR,bi.LINEAR,bi.LINEAR,Ti.CLAMP,Ti.CLAMP,Ti.CLAMP),rA=function(){function t(){this.type=JS.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(lp.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Qn,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=Md.Enum.NONE,this._device=c.director.root.device}var e=t.prototype;return e._setReceiveShadow=function(t){this._receiveShadow=t},e._init=function(){},e.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Md.Enum.NONE,this._inited=!0)},e._destroySubmodel=function(t){t.destroy()},e._destroy=function(){},e.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++){var n=this._subModels[e];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},e.attachToScene=function(t){this.scene=t,this._localDataUpdated=!0},e.detachFromScene=function(){this.scene=null},e.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e._applyLocalData=function(){},e._applyLocalBuffer=function(){},e._applyWorldBoundBuffer=function(){},e.updateUBOs=function(t){for(var e=this._subModels,n=0;n<e.length;n++)e[n].update();if(this._updateStamp=t,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(t,e,n,i){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,n[0]=t.m04,n[1]=t.m05,n[2]=t.m06,n[3]=t.m13,i[0]=t.m08,i[1]=t.m09,i[2]=t.m10,i[3]=t.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){Hn.toArray(this._localData,i,lp.MAT_WORLD_OFFSET),Hn.inverseTranspose(tA,i);var a=Math.abs(Hn.determinant(tA)),s=1/Math.sqrt(a);Hn.multiplyScalar(tA,tA,s),Hn.toArray(this._localData,tA,lp.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},e._updateNativeBounds=function(){},e.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=js.fromPoints(js.create(),t,e),this._worldBounds=js.clone(this._modelBounds),this._updateNativeBounds())},e._createSubModel=function(){return new $S},e.initSubModel=function(t,e,n){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,n.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t)},e.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},e.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},e.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},e.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},e.updateLightingmap=function(t,e){Qn.toArray(this._localData,e,lp.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=Pv.get("empty-texture"));var n=t.getGFXTexture();if(n)for(var i=this._device.getSampler(t.mipmaps.length>1?iA:nA),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(Mp,n),a.bindSampler(Mp,i),a.update()}},e.getMacroPatches=function(){return this.receiveShadow?eA:null},e._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet),this._initWorldBoundDescriptors(t),this._updateWorldBoundDescriptors(t,e.worldBoundDescriptorSet);var n=e.passes[0].getShaderVariant(e.patches);this._updateInstancedAttributes(n.attributes,e.passes[0])}},e._getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributes.attributes,n=0;n<e.length;n++)if(e[n].name===t)return n;return-1},e._setInstMatWorldIdx=function(t){this._instMatWorldIdx=t},e._updateInstancedAttributes=function(t,e){if(e.device.hasFeature(hi.INSTANCED_ARRAYS)){for(var n=0,i=0;i<t.length;i++){var r=t[i];r.isInstanced&&(n+=Zr[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<t.length;s++){var c=t[s];if(c.isInstanced){var l=new Pr;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=Zr[c.format],h=new(so(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}e.batchingScheme===bv.INSTANCING&&e.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(hp)),this._localDataUpdated=!0}},e._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.DEVICE,lp.SIZE,lp.SIZE)),this._applyLocalBuffer())},e._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.DEVICE,up.SIZE,up.SIZE)),this._applyWorldBoundBuffer())},e._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(lp.BINDING,this._localBuffer)},e._updateWorldBoundDescriptors=function(t,e){this._worldBoundBuffer&&e.bindBuffer(up.BINDING,this._worldBoundBuffer)},K(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._setReceiveShadow(t),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),oA=function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._createNativeObject()}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t){return this._name=t.name,!0},e.activate=function(){},e.update=function(t){var e=this._mainLight;e&&e.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(t),c.updateUBOs(t))}},e._destroy=function(){},e.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},e.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},e.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},e.removeCameras=function(){for(var t,e=ot(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},e.setMainLight=function(t){this._mainLight=t},e.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;if(e.length)return this.setMainLight(e[e.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=$g.ROTATION));this.setMainLight(null)}},e.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},e.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},e.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t)},e.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),void this._sphereLights.splice(e,1)},e.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t)},e.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),void this._spotLights.splice(e,1)},e.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0},e.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[]},e.addModel=function(t){t.attachToScene(this),this._models.push(t)},e.removeModel=function(t){for(var e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),void this._models.splice(e,1)},e.removeModels=function(){for(var t,e=ot(this._models);!(t=e()).done;){var n=t.value;n.detachFromScene(),n.destroy()}this._models.length=0},e.addBatch=function(t){this._batches.push(t)},e.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return void this._batches.splice(e,1)},e.removeBatches=function(){this._batches.length=0},e.onGlobalPipelineStateChanged=function(){for(var t,e=ot(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},e.generateModelId=function(){return this._modelId++},e._createNativeObject=function(){},K(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),t}();V(oA.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),V(oA.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var aA={};V(aA,"CameraVisFlags",[{name:"GENERAL"}]),z(aA,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Md.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Md.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Md.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Md.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Md.BitMask,targetName:"UI_2D"}]),c.CameraVisFlags=aA;var sA={};V(sA,"VisibilityFlags",[{name:"GENERAL"}]),z(sA,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Md.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Md.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Md.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Md.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Md.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Md.Enum,targetName:"UI_2D"}]),c.VisibilityFlags=sA,z(Nv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),V(fg.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),V(gg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]);var cA=new Pn(0,0,-1),lA=new Pn,uA=function(t){function e(){var e;return(e=t.call(this)||this)._dir=new Pn(1,-1,-1),e._illuminanceHDR=KS.SUN_ILLUM,e._illuminanceLDR=1,e._type=ty.DIRECTIONAL,e}Q(e,t);var n=e.prototype;return n.initialize=function(){t.prototype.initialize.call(this),this.illuminance=KS.SUN_ILLUM,this.direction=new Pn(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=Pn.transformQuat(lA,cA,this._node.worldRotation))},K(e,[{key:"direction",get:function(){return this._dir},set:function(t){Pn.normalize(this._dir,t)}},{key:"illuminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(t){this._illuminanceHDR=t}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(t){this._illuminanceLDR=t}}]),e}(my),hA=function(t){function e(e,n){var i;(i=t.call(this,e.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=e,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return t.prototype.tryCompile.call(it(i)),i}Q(e,t);var n=e.prototype;return n.overridePipelineStates=function(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),Nv.fillPipelineInfo(this,t),Nv.fillPipelineInfo(this,e),this._onStateChange()},n.tryCompile=function(e){if(e&&!lm(this._defines,e))return!1;var n=t.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(bv.NONE)},n._onStateChange=function(){this._setHash(Nv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},K(e,[{key:"parent",get:function(){return this._parent}}]),e}(Nv),_A=function(t){function e(e){var n;return(n=t.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=e.parent,n._owner=e.owner||null,n._subModelIdx=e.subModelIdx||0,n.copy(n._parent),n}Q(e,t);var n=e.prototype;return n.recompileShaders=function(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(var n,i=ot(this._passes);!(n=i()).done;)n.value.tryCompile(t);else this._passes[e].tryCompile(t)},n.overridePipelineStates=function(t,e){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in t)o[a]=t[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[e]||(this._states[e]={});for(var c in t)s[c]=t[c];this._passes[e].overridePipelineStates(n[e],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(t){this._hash=rg.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var t=[],e=this._parent.passes;if(!e)return t;for(var n=0;n<e.length;++n)t.push(new hA(e[n],this));return t},K(e,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),e}(rg),fA=null,dA=null,pA=function(){function t(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var e=t.prototype;return e._setEnabled=function(t){this._enabled=t},e._setUseIBL=function(t){this._useIBL=t},e._setUseHDR=function(t){this._useHDR=t},e._setUseDiffuseMap=function(t){this._useDiffuseMap=t},e.initialize=function(t){this._setEnabled(t.enabled),this._setUseIBL(t.useIBL),this._setUseDiffuseMap(t.applyDiffuseMap),this._setUseHDR(t.useHDR)},e.setEnvMaps=function(t,e){this._envmapHDR=t,this._envmapLDR=e;var n=c.director.root;n.pipeline.pipelineSceneData.isHDR?t&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel):e&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},e.setDiffuseMaps=function(t,e){this._diffuseMapHDR=t,this._diffuseMapLDR=e,this._updateGlobalBinding(),this._updatePipeline()},e.activate=function(){var t=c.director.root.pipeline;this._globalDSManager=t.globalDSManager,this._default=Pv.get("default-cube-texture"),this._model||(this._model=c.director.root.createModel(c.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var e=this._default.isRGBE;if(this.envmap&&(e=this.envmap.isRGBE),!dA){var n=new rg;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:e}}),dA=new _A({parent:n})}this.enabled&&(fA||(fA=c.utils.createMesh(c.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,fA.renderingSubMeshes[0],dA)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},e._updatePipeline=function(){var t=c.director.root,e=t.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;e.macros.CC_USE_IBL===n&&e.macros.CC_USE_DIFFUSEMAP===i&&e.macros.CC_USE_HDR===r||(e.macros.CC_USE_IBL=n,e.macros.CC_USE_DIFFUSEMAP=i,e.macros.CC_USE_HDR=r,t.onGlobalPipelineStateChanged()),this.enabled&&dA&&dA.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,dA)},e._updateGlobalBinding=function(){if(this._globalDSManager){var t=c.director.root.device,e=this.envmap?this.envmap:this._default;if(e){var n=e.getGFXTexture(),i=t.getSampler(e.getSamplerInfo());this._globalDSManager.bindSampler(tp,i),this._globalDSManager.bindTexture(tp,n)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var o=r.getGFXTexture(),a=t.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(ip,a),this._globalDSManager.bindTexture(ip,o)}this._globalDSManager.update()}},e._destroy=function(){},e.destroy=function(){this._destroy()},K(t,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnabled(t),t?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(t){this._setUseHDR(t),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._setUseIBL(t),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(t){this._useDiffuseMap=t,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(t,this._envmapLDR):this.setEnvMaps(this._envmapHDR,t)}},{key:"diffuseMap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(t,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,t)}},{key:"native",get:function(){return this._nativeObj}}]),t}();c.Skybox=pA;var mA=function(t){Q(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=js.create(),e._pos=new Pn,e._type=ty.SPHERE,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/py(.15),this.luminanceLDR=1},e.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=this._range;js.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}},K(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",set:function(t){this._luminanceLDR=t}},{key:"aabb",get:function(){return this._aabb}}]),n}(my),vA=new Pn(0,0,-1),gA=new Nn,yA=new Hn,xA=new Hn,SA=new Hn,AA=new Hn,CA=function(t){Q(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this)._dir=new Pn(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._aspect=0,e._aabb=js.create(),e._frustum=nc.create(),e._pos=new Pn,e._type=ty.SPOT,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e._setDirection=function(t){this._dir.set(t)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/py(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new Pn(1,-1,-1))},e.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Pn.transformQuat(this._dir,vA,this._node.getWorldRotation(gA)),Pn.normalize(this._dir,this._dir),js.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(yA),Hn.invert(yA,yA),Hn.perspective(xA,this._angle,1,.001,this._range),Hn.multiply(SA,xA,yA),this._frustum.update(SA,AA),this._needUpdate=!1)},K(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(t){this._luminanceLDR=t}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(t){this._aspect=t,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(my),bA=Object.freeze({__proto__:null,Ambient:KS,Octree:QS,get CameraFOVAxis(){return Zv},get CameraProjection(){return $v},get CameraAperture(){return tg},get CameraISO(){return eg},get CameraShutter(){return ng},SKYBOX_FLAG:hg,Camera:fg,CameraVisFlags:aA,VisibilityFlags:sA,DirectionalLight:uA,ColorTemperatureToRGB:ry,get LightType(){return ty},nt2lm:py,Light:my,get ModelType(){return JS},Model:rA,ShadowSize:dg,ShadowType:pg,PCFType:mg,Shadows:gg,RenderScene:oA,Skybox:pA,SphereLight:mA,SpotLight:CA,SubModel:$S,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null}),TA=new Ul((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),EA=new Float32Array(4),wA=[],PA=[],IA=new Hn,RA=new Hn;function DA(t,e){return!(!e.worldBounds||us.aabbWithAABB(e.worldBounds,t.aabb))}function MA(t,e){return!(!e.worldBounds||us.aabbWithAABB(e.worldBounds,t.aabb)&&us.aabbFrustum(e.worldBounds,t.frustum))}var BA=Iv("forward-add"),OA=[];function NA(t,e){e.length=0;for(var n=!1,i=0;i<t.length;i++){for(var r=t[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===BA){o=a,n=!0;break}e.push(o)}return n}var LA,FA,zA,VA,kA,GA,UA,HA,jA,WA,qA,XA=function(){function t(t){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(Jd.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=t,this._device=t.device,this._instancedQueue=new YS,this._batchedQueue=new XS;var e=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(fp.SIZE/e)*e,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new _r(this._lightBuffer,0,fp.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var e=t.prototype;return e.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var t=0;t<this._lightPasses.length;t++){var e=this._lightPasses[t];e.dynamicOffsets.length=0,e.lights.length=0}TA.freeArray(this._lightPasses),this._lightPasses.length=0},e.destroy=function(){for(var t=this._pipeline.globalDSManager.descriptorSetMap,e=t.keys,n=0;n<e.length;n++){var i=e[n],r=t.get(i);r&&(r.getBuffer(Jd.BINDING).destroy(),r.getTexture(Qd).destroy(),r.getTexture(ap).destroy(),r.destroy()),t.delete(i)}},e.gatherLightPasses=function(t,e){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(t,e),this._updateLightDescriptorSet(t,e);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(NA(a,OA)&&(PA.length=0,this._lightCulling(o,n),PA.length))for(var s=0;s<a.length;s++){var c=OA[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(fp.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(e),this._batchedQueue.uploadBuffers(e)}},e.recordCommandBuffer=function(t,e,n){this._instancedQueue.recordCommandBuffer(t,e,n),this._batchedQueue.recordCommandBuffer(t,e,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],_=a.inputAssembler,f=Lv.getOrCreatePipelineState(t,u,h,e,_),d=u.descriptorSet,p=a.descriptorSet;n.bindPipelineState(f),n.bindDescriptorSet(jd.MATERIAL,d),n.bindInputAssembler(_);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);wA[0]=c[m],n.bindDescriptorSet(jd.GLOBAL,g),n.bindDescriptorSet(jd.LOCAL,p,wA),n.draw(_)}}},e._lightCulling=function(t,e){for(var n=0;n<e.length;n++){var i=e[n],r=!1;switch(i.type){case ty.SPHERE:r=DA(i,t);break;case ty.SPOT:r=MA(i,t)}r||PA.push(n)}},e._addRenderQueue=function(t,e,n,i){var r=t.batchingScheme;if(r===bv.INSTANCING)for(var o=0;o<PA.length;o++){var a=PA[o],s=t.getInstancedBuffer(a);s.merge(e,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===bv.VB_MERGING)for(var c=0;c<PA.length;c++){var l=PA[c],u=t.getBatchedBuffer(l);u.merge(e,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=TA.alloc();h.subModel=e,h.passIdx=i;for(var _=0;_<PA.length;_++){var f=PA[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},e._updateLightDescriptorSet=function(t,e){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=t.scene.mainLight,s=Kp(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,d=void 0;switch(h.type){case ty.SPHERE:a&&(Yg(r,a,this._shadowUBO),Kg(r,this._shadowUBO)),this._shadowUBO[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,En.toArray(this._shadowUBO,r.shadowColor,Jd.SHADOW_COLOR_OFFSET);break;case ty.SPOT:if(a&&(Yg(r,a,this._shadowUBO),Kg(r,this._shadowUBO)),Hn.invert(IA,h.node.getWorldMatrix()),Hn.perspective(RA,h.angle,h.aspect,.001,h.range),f=RA.clone(),d=RA.clone().invert(),Hn.multiply(RA,RA,IA),Hn.toArray(this._shadowUBO,IA,Jd.MAT_LIGHT_VIEW_OFFSET),Hn.toArray(this._shadowUBO,RA,Jd.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Jd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Jd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Jd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Jd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Jd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,this._shadowUBO[Jd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,this._shadowUBO[Jd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,this._shadowUBO[Jd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,this._shadowUBO[Jd.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[Jd.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[Jd.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[Jd.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,En.toArray(this._shadowUBO,r.shadowColor,Jd.SHADOW_COLOR_OFFSET),o.has(h)){var p,m=null===(p=o.get(h))||void 0===p?void 0:p.colorTextures[0];m&&_.bindTexture(ap,m)}}_.update(),e.updateBuffer(_.getBuffer(Jd.BINDING),this._shadowUBO)}}},e._updateUBOs=function(t,e){var n=t.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=gn(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new _r(this._lightBuffer,0,fp.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case ty.SPHERE:if(Pn.toArray(EA,l.position),EA[3]=0,this._lightBufferData.set(EA,c+fp.LIGHT_POS_OFFSET),EA[0]=l.size,EA[1]=l.range,EA[2]=0,EA[3]=o.enabled&&o.type===pg.ShadowMap?1:0,this._lightBufferData.set(EA,c+fp.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Pn.toArray(EA,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;EA[0]*=u.x,EA[1]*=u.y,EA[2]*=u.z}EA[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(EA,c+fp.LIGHT_COLOR_OFFSET);break;case ty.SPOT:if(Pn.toArray(EA,l.position),EA[3]=1,this._lightBufferData.set(EA,c+fp.LIGHT_POS_OFFSET),EA[0]=l.size,EA[1]=l.range,EA[2]=l.spotAngle,EA[3]=o.enabled&&o.type===pg.ShadowMap?1:0,this._lightBufferData.set(EA,c+fp.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Pn.toArray(EA,l.direction),this._lightBufferData.set(EA,c+fp.LIGHT_DIR_OFFSET),Pn.toArray(EA,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;EA[0]*=h.x,EA[1]*=h.y,EA[2]*=h.z}EA[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(EA,c+fp.LIGHT_COLOR_OFFSET)}}e.updateBuffer(this._lightBuffer,this._lightBufferData)},t}(),YA=new js,KA=function(){function t(t){this._pendingModels=[],this._castModels=[],this._instancedQueue=new YS,this._pipeline=void 0,this._pipeline=t}var e=t.prototype;return e.gatherShadowPasses=function(t,e){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===pg.Planar&&!(i.normal.length()<1e-6)){var r=t.scene,o=t.frustum,a=0!=(t.visibility&Md.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||(js.transform(YA,_.worldBounds,i.matLight),us.aabbFrustum(YA,o)))if(_.isInstancingEnabled)for(var f=_.subModels,d=0;d<f.length;d++){var p=f[d];u.merge(p,_.instancedAttributes,0,p.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(e)}}},e.recordCommandBuffer=function(t,e,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===pg.Planar&&(this._instancedQueue.recordCommandBuffer(t,e,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(jd.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=Lv.getOrCreatePipelineState(t,r,h,e,_);n.bindPipelineState(f),n.bindDescriptorSet(jd.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},t}(),JA=function(){function t(){this._phaseID=Iv("default")}var e=t.prototype;return e.activate=function(t){this._pipeline=t},e.render=function(t,e){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=t.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(t.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,d=Lv.getOrCreatePipelineState(i,h,_,e,f);r.bindPipelineState(d),r.bindDescriptorSet(jd.MATERIAL,h.descriptorSet);var p=s.descriptorSet;r.bindDescriptorSet(jd.LOCAL,p),r.bindInputAssembler(f),r.draw(f)}}}},t}(),QA=[new sr(0,0,0,1)],ZA=t("ForwardStage",(LA=fc("ForwardStage"),FA=Xc([kS]),zA=kc(),LA((HA=UA=function(t){function e(){var e;return at(e=t.call(this)||this,"renderQueues",GA,it(e)),e._renderQueues=[],e._renderArea=new $i,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Iv("default"),e._clearFlag=4294967295,e._batchedQueue=new XS,e._instancedQueue=new YS,e._uiPhase=new JA,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=jS(this.renderQueues[i]);this._additiveLightQueue=new XA(this._pipeline),this._planarQueue=new KA(this._pipeline),this._uiPhase.activate(e)},n.destroy=function(){},n.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,n=e.device;this._renderQueues.forEach(WS);for(var i=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===bv.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(f===bv.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,o,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(qS);var m=e.commandBuffers[0];e.pipelineUBO.updateShadowUBO(t),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(t,m),this._planarQueue.gatherShadowPasses(t,m),t.clearFlag&Xi.COLOR&&(QA[0].x=t.clearColor.x,QA[0].y=t.clearColor.y,QA[0].z=t.clearColor.z,QA[0].w=t.clearColor.w),e.generateRenderArea(t,this._renderArea);var v=t.window.framebuffer,g=e.getRenderPass(t.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,QA,t.clearDepth,t.clearStencil),m.bindDescriptorSet(jd.GLOBAL,e.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(jd.GLOBAL,e.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._uiPhase.render(t,g),Qv(n,g,m,e.profiler,t),m.endRenderPass()},e}(Ly),UA.initInfo={name:"ForwardStage",priority:Ky.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:LS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:LS.BACK_TO_FRONT,stages:["default","planarShadow"]}]},GA=st((kA=HA).prototype,"renderQueues",[FA,yc,zA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VA=kA))||VA)),$A=t("ForwardFlow",fc("ForwardFlow")((qA=WA=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new ZA;n.initialize(ZA.initInfo),this._stages.push(n)}return!0},n.activate=function(e){t.prototype.activate.call(this,e)},n.render=function(e){t.prototype.render.call(this,e)},n.destroy=function(){t.prototype.destroy.call(this)},e}(zy),WA.initInfo={name:Ld,priority:Jy.FORWARD,stages:[]},jA=qA))||jA),tC=new Hn,eC=new Hn,nC=new Hn,iC=new js,rC=Iv("shadow-caster"),oC=[];function aC(t,e){e.length=0;for(var n=!1,i=0;i<t.length;i++){for(var r=t[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===rC){o=a,n=!0;break}e.push(o)}return n}var sC,cC,lC,uC,hC,_C,fC=function(){function t(t){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=t,this._instancedQueue=new YS,this._batchedQueue=new XS}var e=t.prototype;return e.gatherLightPasses=function(t,e,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(n&&o.enabled&&o.type===pg.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case ty.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;aC(l.subModels,oC)&&this.add(l,oC)}break;case ty.SPOT:Hn.invert(tC,n.node.getWorldMatrix()),Hn.perspective(eC,n.angle,n.aspect,.001,n.range),Hn.multiply(nC,eC,tC);for(var u=0;u<s.length;u++){var h=s[u].model;aC(h.subModels,oC)&&(h.worldBounds&&(js.transform(iC,h.worldBounds,nC),!us.aabbFrustum(iC,e.frustum))||this.add(h,oC))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},e.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},e.add=function(t,e){for(var n=t.subModels,i=0;i<n.length;i++){var r=n[i],o=e[i],a=r.passes[o];if(a.batchingScheme===bv.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,t.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===bv.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,t),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},e.recordCommandBuffer=function(t,e,n){this._instancedQueue.recordCommandBuffer(t,e,n),this._batchedQueue.recordCommandBuffer(t,e,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=Lv.getOrCreatePipelineState(t,a,o,e,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(jd.MATERIAL,l),n.bindDescriptorSet(jd.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},t}(),dC=[new sr(1,1,1,1)],pC=t("ShadowStage",fc("ShadowStage")((lC=cC=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._shadowFrameBuffer=null,e._renderArea=new $i,e._light=null,e._globalDS=null,e}Q(e,t);var n=e.prototype;return n.setUsage=function(t,e,n){this._globalDS=t,this._light=e,this._shadowFrameBuffer=n},n.destroy=function(){var t;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(t=this._additiveShadowQueue)||void 0===t||t.clear()},n.clearFramebuffer=function(t){if(this._light&&this._shadowFrameBuffer){dC[0].w=t.clearColor.w;var e=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;e.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,dC,t.clearDepth,t.clearStencil),e.endRenderPass()}},n.render=function(t){var e=this._pipeline,n=e.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=e.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,t,this._light,a);var s=t.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=e.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,dC,t.clearDepth,t.clearStencil),a.bindDescriptorSet(jd.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._additiveShadowQueue=new fC(e)},e}(Ly),cC.initInfo={name:"ShadowStage",priority:Ky.FORWARD,tag:0},sC=lC))||sC),mC=[],vC=t("ShadowFlow",fc("ShadowFlow")((_C=hC=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._shadowRenderPass=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new pC;n.initialize(pC.initInfo),this._stages.push(n)}return!0},n.render=function(t){var e=this._pipeline,n=e.pipelineSceneData.shadows,i=e.pipelineSceneData.shadowFrameBufferMap,r=e.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===pg.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===ty.SPOT&&(mC.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=t.scene.mainLight;if(l){var u=e.descriptorSet;i.has(l)||this._initShadowFrameBuffer(e,l,t.window.swapchain);for(var h=i.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(t)}}for(var d=0;d<mC.length;d++){var p=mC[d],m=e.globalDSManager.getOrCreateDescriptorSet(d);i.has(p)||this._initShadowFrameBuffer(e,p,t.window.swapchain);for(var v=i.get(p),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,p,v),y.render(t)}}mC.length=0}else this.clearShadowMap(mC,t)}},n.destroy=function(){if(t.prototype.destroy.call(this),this._pipeline){for(var e=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(e.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}e.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(t,e){var n=t.device,i=t.pipelineSceneData.shadows.size,r=t.pipelineSceneData.shadowFrameBufferMap,o=Kp(n)?_i.R32F:_i.RGBA8;if(!this._shadowRenderPass){var a=new Dr;a.format=o,a.loadOp=Mi.CLEAR,a.storeOp=Bi.STORE,a.sampleCount=1;var s=new Mr;s.format=_i.DEPTH_STENCIL,s.depthLoadOp=Mi.CLEAR,s.depthStoreOp=Bi.DISCARD,s.stencilLoadOp=Mi.CLEAR,s.stencilStoreOp=Bi.DISCARD,s.sampleCount=1;var c=new Nr([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new mr(yi.TEX2D,xi.DEPTH_STENCIL_ATTACHMENT,_i.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new zr(this._shadowRenderPass,l,u));r.set(e,h)},n.clearShadowMap=function(t,e){var n=this._pipeline,i=n.pipelineSceneData,r=e.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,e.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(e)}}for(var l=0;l<t.length;l++){var u=t[l],h=i.shadowFrameBufferMap.get(u),_=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var d=this._stages[f];d.setUsage(_,u,h),d.clearFramebuffer(e)}}},n.resizeShadowMap=function(){for(var t=this._pipeline.pipelineSceneData.shadows,e=t.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=Kp(i)?_i.R32F:_i.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,o,e.x,e.y)));var u=c.depthStencilTexture;u&&u.resize(e.x,e.y);var h=c.renderPass;c.destroy(),c.initialize(new zr(h,l,u)),s=a.next()}else s=a.next()}t.shadowMapDirty=!1},e}(zy),hC.initInfo={name:Fd,priority:Jy.SHADOW,tag:MS.SCENE,stages:[]},uC=_C))||uC),gC=new Qn,yC=oe({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),xC=yC.LAYERED+1,SC=function(){function t(){this._fogColor=new En("#C8C8C8"),this._colorArray=new Qn(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var e=t.prototype;return e._setType=function(t){this._type=this.enabled?t:xC},e._setEnable=function(t){this._enabled=t},e._setAccurate=function(t){this._accurate=t},e.initialize=function(t){this.fogColor=t.fogColor,this._setEnable(t.enabled),this._setAccurate(t.accurate),this._setType(t.type),this.fogDensity=t.fogDensity,this.fogStart=t.fogStart,this.fogEnd=t.fogEnd,this.fogAtten=t.fogAtten,this.fogTop=t.fogTop,this.fogRange=t.fogRange},e.activate=function(){this._updatePipeline()},e._updatePipeline=function(){var t=c.director.root,e=this.enabled?this.type:xC,n=this.accurate?1:0,i=t.pipeline;i.macros.CC_USE_FOG===e&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=e,i.macros.CC_USE_ACCURATE_FOG=n,t.onGlobalPipelineStateChanged())},e._destroy=function(){},e.destroy=function(){this._destroy()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),t?this.activate():(this._type=xC,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._setAccurate(t),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),gC.set(t.x,t.y,t.z,t.w),Vv(this._colorArray,gC)}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),t}();function AC(t,e){for(var n,i=ot(e);!(n=i()).done;){var r=n.value;Array.isArray(r)?AC(t,r):t.push(r)}}function CC(t){var e=[];return AC(e,t),e.join("")}c.Fog=SC;var bC=_l.Flags.Destroyed,TC=_l.Flags.PersistentMask,EC=Ze.IDENTIFIER_RE,wC="var ",PC="o",IC={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},RC=Ze.escapeForJS,DC=function(){function t(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}return t.prototype.toString=function(){return wC+this.varName+"="+this.expression+";"},t}();function MC(t,e){return e instanceof DC?new DC(e.varName,t+e.expression):t+e}function BC(t,e,n){Array.isArray(n)?(n[0]=MC(e,n[0]),t.push(n)):t.push(MC(e,n)+";")}var OC=function(){function t(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}var e=t.prototype;return e.append=function(t,e){this._exps.push([t,e])},e.writeCode=function(t){var e;if(this._exps.length>1)t.push("t="+this._targetExp+";"),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];BC(t,e+NC(i[0])+"=",i[1])}},t}();function NC(t){return EC.test(t)?"."+t:"["+RC(t)+"]"}OC.pool=void 0,OC.pool=new te((function(t){t._exps.length=0,t._targetExp=null}),1),OC.pool.get=function(t){var e=this._get()||new OC;return e._targetExp=t,e};var LC=function(){function t(t,e){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=wt(),zt(this.funcModuleCache,IC),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(n=wC+this.globalVariables.join(",")+";");var i=CC(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var e=t.prototype;return e.getFuncModule=function(t,e){var n=Pt(t);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=t===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(t){}}}var o=this.funcs.indexOf(t);o<0&&(o=this.funcs.length,this.funcs.push(t));var a="F["+o+"]";return e&&(a="("+a+")"),this.funcModuleCache[n]=a,a},e.getObjRef=function(t){var e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),"O["+e+"]"},e.setValueType=function(t,e,n,i){var r=OC.pool.get(i),o=e.constructor.__props__;o||(o=Object.keys(e));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(e[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(t),OC.pool.put(r)},e.enumerateCCClass=function(t,e,n){for(var i=n.__values__,r=Ie(n),o=0;o<i.length;o++){var a=i[o],s=e[a],l=r[a+"$_$default"];if(!FC(l,s))if("object"==typeof s&&s instanceof c.ValueType&&(l=Ze.getDefault(l))&&l.constructor===s.constructor){var u=PC+NC(a);this.setValueType(t,l,s,u)}else this.setObjProp(t,e,a,s)}},e.instantiateArray=function(t){if(0===t.length)return"[]";var e="a"+ ++this.localVariableId,n=[new DC(e,"new Array("+t.length+")")];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(var i=0;i<t.length;++i)BC(n,e+"["+i+"]=",this.enumerateField(t,i,t[i]));return n},e.instantiateTypedArray=function(t){var e=t.constructor.name;if(0===t.length)return"new "+e;var n="a"+ ++this.localVariableId,i=[new DC(n,"new "+e+"("+t.length+")")];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(var r=0;r<t.length;++r)0!==t[r]&&BC(i,n+"["+r+"]=",t[r]);return i},e.enumerateField=function(t,e,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=MC(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?RC(n):("_objFlags"===e&&t instanceof _l&&(n&=TC),n)},e.setObjProp=function(t,e,n,i){BC(t,PC+NC(n)+"=",this.enumerateField(e,n,i))},e.enumerateObject=function(t,e){var n=e.constructor;if(c.Class._isCCClass(n))this.enumerateCCClass(t,e,n);else for(var i in e)if(e.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=e[i];"object"==typeof r&&r&&r===e._iN$t||this.setObjProp(t,e,i,r)}},e.instantiateObj=function(t){if(t instanceof c.ValueType)return Ze.getNewValueTypeCode(t);if(t instanceof c.Asset)return this.getObjRef(t);if(t._objFlags&bC)return null;var e,n=t.constructor;if(c.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof c.Component){if(t instanceof c._BaseNode||t instanceof c.Component)return this.getObjRef(t)}else if(this.parent instanceof c._BaseNode)if(t instanceof c._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof c.Component){var i;if(!(null===(i=t.node)||void 0===i?void 0:i.isChildOf(this.parent)))return this.getObjRef(t)}e=new DC(PC,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)e=new DC(PC,"{}");else{if(n)return this.getObjRef(t);e=new DC(PC,"Object.create(null)")}var r=[e];return t._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(t),this.enumerateObject(r,t),["(function(){",r,"return o;})();"]},t}();function FC(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof c.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return St(t)&&St(e)}return!1}var zC,VC,kC,GC,UC,HC,jC,WC,qC,XC,YC=function(){function t(t){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=t}return t.prototype.applyOpacity=function(t){this._opacity=this._localOpacity*t},t.markOpacityTree=function(){},K(t,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(t){this._uiTransformComp=t}},{key:"uiComp",get:function(){return this._uiComp},set:function(t){this._uiComp&&t?I(12002):this._uiComp=t}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(t){this._localOpacity=t,this.colorDirty=!0}}]),t}();_l.Flags.Destroying,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed",t.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(zC||(zC={}));var KC=_l.Flags.Destroying,JC=_l.Flags.DontDestroy,QC=_l.Flags.Deactivating,ZC=new pt("Node");function $C(t){return t?"string"==typeof t?Zt(t):t:(D(3804),null)}var tb,eb,nb,ib,rb,ob,ab,sb,cb,lb,ub,hb=t("BaseNode",fc("cc.BaseNode")((XC=qC=function(t){Q(n,t),n._setScene=function(t){t._updateScene()},n._findComponent=function(t,e){var n=e,i=t._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===e)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof e)return s}return null},n._findComponents=function(t,e,n){var i=e,r=t._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===e&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof e&&n.push(c)}},n._findChildComponent=function(t,e){for(var i=0;i<t.length;++i){var r=t[i],o=n._findComponent(r,e);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,e)))return o}return null},n._findChildComponents=function(t,e,i){for(var r=0;r<t.length;++r){var o=t[r];n._findComponents(o,e,i),o._children.length>0&&n._findChildComponents(o._children,e,i)}};var e=n.prototype;function n(e){var n;return at(n=t.call(this,e)||this,"_parent",GC,it(n)),at(n,"_children",UC,it(n)),at(n,"_active",HC,it(n)),at(n,"_components",jC,it(n)),at(n,"_prefab",WC,it(n)),n._scene=null,n._activeInHierarchy=!1,n._id=ZC.getNewId(),n._name=void 0,n._eventProcessor=new c.NodeEventProcessor(it(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==e?e:"New Node",n}return e._updateScene=function(){null==this._parent?x("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},e.attr=function(t){zt(this,t)},e.getParent=function(){return this._parent},e.setParent=function(t,e){if(void 0===e&&(e=!1),this._parent!==t){var n=this._parent,i=t;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,e),this.emit&&this.emit(zC.PARENT_CHANGED,n),n&&!(n._objFlags&KC)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(zC.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(zC.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},e.getChildByUuid=function(t){if(!t)return g("Invalid uuid"),null;for(var e=this._children,n=0,i=e.length;n<i;n++)if(e[n]._id===t)return e[n];return null},e.getChildByName=function(t){if(!t)return g("Invalid name"),null;for(var e=this._children,n=0,i=e.length;n<i;n++)if(e[n]._name===t)return e[n];return null},e.getChildByPath=function(t){for(var e=t.split("/"),n=this,i=function(t){var i=e[t];if(0===i.length)return"continue";var r=n.children.find((function(t){return t.name===i}));if(!r)return{v:null};n=r},r=0;r<e.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},e.addChild=function(t){t.setParent(this)},e.insertChild=function(t,e){t.parent=this,t.setSiblingIndex(e)},e.getSiblingIndex=function(){return this._siblingIndex},e.setSiblingIndex=function(t){if(this._parent)if(this._parent._objFlags&QC)D(3821);else{var e=this._parent._children;t=-1!==t?t:e.length-1;var n=e.indexOf(this);t!==n&&(e.splice(n,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}},e.walk=function(t,e){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&t?t(o):l&&e&&e(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},e.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},e.removeChild=function(t){this._children.indexOf(t)>-1&&(t.parent=null)},e.removeAllChildren=function(){for(var t=this._children,e=t.length-1;e>=0;e--){var n=t[e];n&&(n.parent=null)}this._children.length=0},e.isChildOf=function(t){var e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1},e.getComponent=function(t){var e=$C(t);return e?n._findComponent(this,e):null},e.getComponents=function(t){var e=$C(t),i=[];return e&&n._findComponents(this,e,i),i},e.getComponentInChildren=function(t){var e=$C(t);return e?n._findChildComponent(this._children,e):null},e.getComponentsInChildren=function(t){var e=$C(t),i=[];return e&&(n._findComponents(this,e,i),n._findChildComponents(this._children,e,i)),i},e.addComponent=function(t){var e;if("string"==typeof t){if(!(e=Zt(t)))throw c._RF.peek()&&D(3808,t),TypeError(N(3807,t))}else{if(!t)throw TypeError(N(3804));e=t}if("function"!=typeof e)throw TypeError(N(3809));if(!Gt(e,c.Component))throw TypeError(N(3810));var n=e._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var r=n[i];this.getComponent(r)||this.addComponent(r)}else{var o=n;this.getComponent(o)||this.addComponent(o)}var a=new e;return a.node=this,this._components.push(a),this._activeInHierarchy&&c.director._nodeActivator.activateComp(a),a},e.removeComponent=function(t){if(t){var e=null;(e=t instanceof Qu?t:this.getComponent(t))&&e.destroy()}else D(3813)},e.on=function(t,e,n,i){switch(void 0===i&&(i=!1),t){case zC.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,n,i)},e.off=function(t,e,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(t,e,n,i),!this._eventProcessor.hasEventListener(t))switch(t){case zC.TRANSFORM_CHANGED:this._eventMask&=-2}},e.once=function(t,e,n,i){this._eventProcessor.once(t,e,n,i)},e.emit=function(t,e,n,i,r,o){this._eventProcessor.emit(t,e,n,i,r,o)},e.dispatchEvent=function(t){this._eventProcessor.dispatchEvent(t)},e.hasEventListener=function(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)},e.targetOff=function(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(zC.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},e.destroy=function(){return!!t.prototype.destroy.call(this)&&(this.active=!1,!0)},e.destroyAllChildren=function(){for(var t=this._children,e=0;e<t.length;++e)t[e].destroy()},e._removeComponent=function(t){if(t){if(!(this._objFlags&KC)){var e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&D(3815)}}else D(3814)},e._updateSiblingIndex=function(){for(var t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(zC.SIBLING_ORDER_CHANGED)},e._onSetParent=function(t){this._parent&&(null!=t&&t._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},e._onPostActivated=function(){},e._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},e._onPreDestroy=function(){this._onPreDestroyBase()},e._onHierarchyChanged=function(t){return this._onHierarchyChangedBase(t)},e._instantiate=function(t,e){return t||(t=c.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t},e._onHierarchyChangedBase=function(){var t=this._parent;!this._persistNode||t instanceof c.Scene||c.game.removePersistRootNode(this);var e=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==e&&c.director._nodeActivator.activateNode(this,e)},e._onPreDestroyBase=function(){this._objFlags|=KC;var t=this._parent,e=!!t&&0!=(t._objFlags&KC);if(this._persistNode&&c.game.removePersistRootNode(this),!e&&t){this.emit(zC.PARENT_CHANGED,this);var n=t._children.indexOf(this);t._children.splice(n,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(zC.CHILD_REMOVED,this)}this.emit(zC.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var o=this._components,a=0;a<o.length;++a)o[a]._destroyImmediate();return e},K(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&JC)>0},set:function(t){t?this._objFlags|=JC:this._objFlags&=~JC}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(t){if(this._active!==t){this._active=t;var e=this._parent;e&&e._activeInHierarchy&&c.director._nodeActivator.activateNode(this,t)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(t){this.setParent(t)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(_l),qC.idGenerator=ZC,qC._stacks=[[]],qC._stackId=0,st((kC=XC).prototype,"_persistNode",[vc],Object.getOwnPropertyDescriptor(kC.prototype,"_persistNode"),kC.prototype),st(kC.prototype,"name",[Rc],Object.getOwnPropertyDescriptor(kC.prototype,"name"),kC.prototype),st(kC.prototype,"children",[Rc],Object.getOwnPropertyDescriptor(kC.prototype,"children"),kC.prototype),st(kC.prototype,"active",[Rc],Object.getOwnPropertyDescriptor(kC.prototype,"active"),kC.prototype),st(kC.prototype,"activeInHierarchy",[Rc],Object.getOwnPropertyDescriptor(kC.prototype,"activeInHierarchy"),kC.prototype),st(kC.prototype,"parent",[Rc],Object.getOwnPropertyDescriptor(kC.prototype,"parent"),kC.prototype),GC=st(kC.prototype,"_parent",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UC=st(kC.prototype,"_children",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HC=st(kC.prototype,"_active",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jC=st(kC.prototype,"_components",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WC=st(kC.prototype,"_prefab",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VC=kC))||VC);c._BaseNode=hb;var _b=new Pn,fb=new Nn,db=new Nn,pb=new Nn,mb=new Mn,vb=new Mn,gb=new Hn,yb=[],xb=[],Sb=[],Ab=function(){function t(){this._chunks=[],this._freelists=[],this._createChunk()}var e=t.prototype;return e.alloc=function(){for(var t=this._freelists.length,e=0;e<t;++e)if(this._freelists[e].length)return this._createView(e);return this._createChunk(),this._createView(t)},e.free=function(t,e){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===t)return void this._freelists[i].push(e)},e.clear=function(){for(var t=this._chunks.length,e=0;e<t;++e)this._chunks[e].fill(0)},e._createChunk=function(){this._chunks.push(new Uint32Array(t.CAPACITY_PER_CHUNK));for(var e=[],n=t.CAPACITY_PER_CHUNK-1;n>=0;n--)e.push(n);this._freelists.push(e)},e._createView=function(t){return Sb[0]=this._chunks[t],Sb[1]=this._freelists[t].pop(),Sb},t}();Ab.CAPACITY_PER_CHUNK=256;var Cb,bb,Tb,Eb,wb,Pb,Ib,Rb,Db,Mb,Bb,Ob,Nb,Lb,Fb,zb,Vb,kb,Gb,Ub,Hb,jb,Wb,qb,Xb,Yb,Kb,Jb,Qb,Zb,$b,tT,eT,nT,iT,rT,oT,aT,sT,cT,lT,uT,hT,_T,fT,dT,pT,mT,vT,gT,yT,xT,ST,AT,CT,bT,TT,ET,wT,PT,IT,RT,DT,MT,BT,OT,NT,LT,FT,zT=new Ab,VT=Symbol("ReserveContentsForAllSyncablePrefab"),kT=t("Node",(tb=fc("cc.Node"),eb=Xc(Pn),tb((ub=lb=function(t){Q(n,t);var e=n.prototype;function n(e){var n;return(n=t.call(this,e)||this)._uiProps=new YC(it(n)),n._static=!1,at(n,"_lpos",rb,it(n)),at(n,"_lrot",ob,it(n)),at(n,"_lscale",ab,it(n)),at(n,"_layer",sb,it(n)),at(n,"_euler",cb,it(n)),n._dirtyFlagsPri=$g.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return e._init=function(){var t=zT.alloc(),e=t[0],n=t[1];this._hasChangedFlagsChunk=e,this._hasChangedFlagsOffset=n;var i=new Uint32Array(e.buffer,e.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new Pn,this._rot=new Nn,this._scale=new Pn(1,1,1),this._mat=new Hn},n.isNode=function(t){return t instanceof n&&(t.constructor===n||!(t instanceof c.Scene))},e._onPreDestroy=function(){var t=this._onPreDestroyBase();return zT.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),t},e[ch]=function(t){t.writeThis()},e.setParent=function(e,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),t.prototype.setParent.call(this,e,n)},e._onSetParent=function(e,n){if(t.prototype._onSetParent.call(this,e,n),n){var i=this._parent;i?(i.updateWorldTransform(),Hn.multiply(gb,Hn.invert(gb,i._mat),this._mat),Hn.toRTS(gb,this._lrot,this._lpos,this._lscale)):(Pn.copy(this._lpos,this._pos),Nn.copy(this._lrot,this._rot),Pn.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren($g.TRS)},e._onHierarchyChanged=function(e){this.eventProcessor.reattach(),t.prototype._onHierarchyChangedBase.call(this,e)},e._onBatchCreated=function(t){this.hasChangedFlags=$g.TRS,this._dirtyFlags|=$g.TRS;for(var e=this._children.length,n=0;n<e;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(t)},e._onBeforeSerialize=function(){this.eulerAngles},e._onPostActivated=function(t){t?(this._eventProcessor.setEnabled(!0),this.invalidateChildren($g.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},e.translate=function(t,e){var n=e||Zg.LOCAL;if(n===Zg.LOCAL)Pn.transformQuat(_b,t,this._lrot),this._lpos.x+=_b.x,this._lpos.y+=_b.y,this._lpos.z+=_b.z;else if(n===Zg.WORLD)if(this._parent){Nn.invert(fb,this._parent.worldRotation),Pn.transformQuat(_b,t,fb);var i=this.worldScale;this._lpos.x+=_b.x/i.x,this._lpos.y+=_b.y/i.y,this._lpos.z+=_b.z/i.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren($g.POSITION),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.POSITION)},e.rotate=function(t,e){var n=e||Zg.LOCAL;if(Nn.normalize(fb,t),n===Zg.LOCAL)Nn.multiply(this._lrot,this._lrot,fb);else if(n===Zg.WORLD){var i=this.worldRotation;Nn.multiply(db,fb,i),Nn.invert(fb,i),Nn.multiply(db,fb,db),Nn.multiply(this._lrot,this._lrot,db)}this._eulerDirty=!0,this.invalidateChildren($g.ROTATION),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.ROTATION)},e.lookAt=function(t,e){this.getWorldPosition(_b),Pn.subtract(_b,_b,t),Pn.normalize(_b,_b),Nn.fromViewUp(fb,_b,e),this.setWorldRotation(fb)},e._setDirtyNode=function(t,e){yb[t]=e},e.invalidateChildren=function(t){var e,n,i,r=0,o=0,a=0,s=0,c=0,l=t|$g.POSITION;for(yb[0]=this;r>=0;){if(c=(e=yb[r--])._hasChangedFlags[0],s=e._dirtyFlagsPri,e.isValid&&(s&c&t)!==t)for(s|=t,e._dirtyFlagsPri=s,e._hasChangedFlags[0]=c|t,a=(i=e._children).length,o=0;o<a;o++)n=i[o],yb[++r]=n;t=l}},e.updateWorldTransform=function(){if(this._dirtyFlags){for(var t,e=this,n=0;e&&e._dirtyFlags;)this._setDirtyNode(n++,e),e=e._parent;for(var i=0;n;)i|=(t=yb[--n])._dirtyFlags,e?(i&$g.POSITION&&(Pn.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),i&$g.RS&&(Hn.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),Hn.multiply(t._mat,e._mat,t._mat),i&$g.ROTATION&&Nn.multiply(t._rot,e._rot,t._lrot),Mn.fromQuat(mb,Nn.conjugate(pb,t._rot)),Mn.multiplyMat4(mb,mb,t._mat),t._scale.x=mb.m00,t._scale.y=mb.m04,t._scale.z=mb.m08)):(i&$g.POSITION&&(Pn.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),i&$g.RS&&(i&$g.ROTATION&&Nn.copy(t._rot,t._lrot),i&$g.SCALE&&(Pn.copy(t._scale,t._lscale),Hn.fromRTS(t._mat,t._rot,t._pos,t._scale)))),t._dirtyFlags=$g.NONE,e=t}},e.setPosition=function(t,e,n){void 0===e&&void 0===n?Pn.copy(this._lpos,t):void 0===n?Pn.set(this._lpos,t,e,this._lpos.z):Pn.set(this._lpos,t,e,n),this.invalidateChildren($g.POSITION),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.POSITION)},e.getPosition=function(t){return t?Pn.set(t,this._lpos.x,this._lpos.y,this._lpos.z):Pn.copy(new Pn,this._lpos)},e.setRotation=function(t,e,n,i){void 0===e||void 0===n||void 0===i?Nn.copy(this._lrot,t):Nn.set(this._lrot,t,e,n,i),this._eulerDirty=!0,this.invalidateChildren($g.ROTATION),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.ROTATION)},e.setRotationFromEuler=function(t,e,n){var i=void 0===n?this._euler.z:n;void 0===e?(Pn.copy(this._euler,t),Nn.fromEuler(this._lrot,t.x,t.y,t.z)):(Pn.set(this._euler,t,e,i),Nn.fromEuler(this._lrot,t,e,i)),this._eulerDirty=!1,this.invalidateChildren($g.ROTATION),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.ROTATION)},e.getRotation=function(t){return t?Nn.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Nn.copy(new Nn,this._lrot)},e.setScale=function(t,e,n){void 0===e&&void 0===n?Pn.copy(this._lscale,t):void 0===n?Pn.set(this._lscale,t,e,this._lscale.z):Pn.set(this._lscale,t,e,n),this.invalidateChildren($g.SCALE),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.SCALE)},e.getScale=function(t){return t?Pn.set(t,this._lscale.x,this._lscale.y,this._lscale.z):Pn.copy(new Pn,this._lscale)},e.inverseTransformPoint=function(t,e){Pn.copy(t,e);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)Pn.transformInverseRTS(t,t,n._lrot,n._lpos,n._lscale),n=yb[--i];return t},e.setWorldPosition=function(t,e,n){void 0===e||void 0===n?Pn.copy(this._pos,t):Pn.set(this._pos,t,e,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),Pn.transformMat4(r,this._pos,Hn.invert(gb,i._mat))):Pn.copy(r,this._pos),this.invalidateChildren($g.POSITION),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.POSITION)},e.getWorldPosition=function(t){return this.updateWorldTransform(),t?Pn.copy(t,this._pos):Pn.copy(new Pn,this._pos)},e.setWorldRotation=function(t,e,n,i){void 0===e||void 0===n||void 0===i?Nn.copy(this._rot,t):Nn.set(this._rot,t,e,n,i),this._parent?(this._parent.updateWorldTransform(),Nn.multiply(this._lrot,Nn.conjugate(this._lrot,this._parent._rot),this._rot)):Nn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren($g.ROTATION),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.ROTATION)},e.setWorldRotationFromEuler=function(t,e,n){Nn.fromEuler(this._rot,t,e,n),this._parent?(this._parent.updateWorldTransform(),Nn.multiply(this._lrot,Nn.conjugate(this._lrot,this._parent._rot),this._rot)):Nn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren($g.ROTATION),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.ROTATION)},e.getWorldRotation=function(t){return this.updateWorldTransform(),t?Nn.copy(t,this._rot):Nn.copy(new Nn,this._rot)},e.setWorldScale=function(t,e,n){void 0===e||void 0===n?Pn.copy(this._scale,t):Pn.set(this._scale,t,e,n);var i=this._parent;i?(i.updateWorldTransform(),Mn.fromQuat(mb,Nn.conjugate(pb,i._rot)),Mn.multiplyMat4(mb,mb,i._mat),vb.m00=this._scale.x,vb.m04=this._scale.y,vb.m08=this._scale.z,Mn.multiply(mb,vb,Mn.invert(mb,mb)),this._lscale.x=Pn.set(_b,mb.m00,mb.m01,mb.m02).length(),this._lscale.y=Pn.set(_b,mb.m03,mb.m04,mb.m05).length(),this._lscale.z=Pn.set(_b,mb.m06,mb.m07,mb.m08).length()):Pn.copy(this._lscale,this._scale),this.invalidateChildren($g.SCALE),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.SCALE)},e.getWorldScale=function(t){return this.updateWorldTransform(),t?Pn.copy(t,this._scale):Pn.copy(new Pn,this._scale)},e.getWorldMatrix=function(t){this.updateWorldTransform();var e=t||new Hn;return Hn.copy(e,this._mat)},e.getWorldRS=function(t){this.updateWorldTransform();var e=t||new Hn;return Hn.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e},e.getWorldRT=function(t){this.updateWorldTransform();var e=t||new Hn;return Hn.fromRT(e,this._rot,this._pos)},e.setRTS=function(t,e,n){var i=0;t&&(i|=$g.ROTATION,void 0!==t.w?(Nn.copy(this._lrot,t),this._eulerDirty=!0):(Pn.copy(this._euler,t),Nn.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(Pn.copy(this._lpos,e),i|=$g.POSITION),n&&(Pn.copy(this._lscale,n),i|=$g.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,i))},e.pauseSystemEvents=function(t){this._eventProcessor.setEnabled(!1,t)},e.resumeSystemEvents=function(t){this._eventProcessor.setEnabled(!0,t)},n.resetHasChangedFlags=function(){zT.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,yb.length=0,xb.length=0)},K(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(t){this._dirtyFlagsPri=t}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(t){this.setPosition(t)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(t){this.setWorldPosition(t)}},{key:"rotation",get:function(){return this._lrot},set:function(t){this.setRotation(t)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Nn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(t){this.setRotationFromEuler(t.x,t.y,t.z)}},{key:"angle",get:function(){return this._euler.z},set:function(t){Pn.set(this._euler,0,0,t),Nn.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren($g.ROTATION),1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(t){this.setWorldRotation(t)}},{key:"scale",get:function(){return this._lscale},set:function(t){this.setScale(t)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(t){this.setWorldScale(t)}},{key:"matrix",set:function(t){Hn.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren($g.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(zC.TRANSFORM_CHANGED,$g.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return Pn.transformQuat(new Pn,Pn.FORWARD,this.worldRotation)},set:function(t){var e=t.length();Pn.multiplyScalar(_b,t,-1/e),Nn.fromViewUp(fb,_b),this.setWorldRotation(fb)}},{key:"up",get:function(){return Pn.transformQuat(new Pn,Pn.UP,this.worldRotation)}},{key:"right",get:function(){return Pn.transformQuat(new Pn,Pn.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(t){this._layer=t,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(zC.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(t){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=t}}]),n}(hb),lb.EventType=zC,lb.NodeSpace=Zg,lb.TransformDirtyBit=$g,lb.TransformBit=$g,lb.reserveContentsForAllSyncablePrefabTag=VT,lb.ClearFrame=0,lb.ClearRound=1e3,rb=st((ib=ub).prototype,"_lpos",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn}}),ob=st(ib.prototype,"_lrot",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn}}),ab=st(ib.prototype,"_lscale",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(1,1,1)}}),sb=st(ib.prototype,"_layer",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Md.Enum.DEFAULT}}),cb=st(ib.prototype,"_euler",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn}}),st(ib.prototype,"eulerAngles",[eb],Object.getOwnPropertyDescriptor(ib.prototype,"eulerAngles"),ib.prototype),st(ib.prototype,"angle",[Rc],Object.getOwnPropertyDescriptor(ib.prototype,"angle"),ib.prototype),st(ib.prototype,"layer",[Rc],Object.getOwnPropertyDescriptor(ib.prototype,"layer"),ib.prototype),nb=ib))||nb));c.Node=kT;var GT=fc("cc.TargetInfo")((Tb=st((bb=function(){at(this,"localID",Tb,this)}).prototype,"localID",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cb=bb))||Cb,UT=(Eb=fc("cc.TargetOverrideInfo"),wb=Xc(_l),Pb=Xc(GT),Ib=Xc(kT),Rb=Xc(GT),Eb((Bb=st((Mb=function(){at(this,"source",Bb,this),at(this,"sourceInfo",Ob,this),at(this,"propertyPath",Nb,this),at(this,"target",Lb,this),at(this,"targetInfo",Fb,this)}).prototype,"source",[yc,wb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ob=st(Mb.prototype,"sourceInfo",[yc,Pb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nb=st(Mb.prototype,"propertyPath",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Lb=st(Mb.prototype,"target",[yc,Ib],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fb=st(Mb.prototype,"targetInfo",[yc,Rb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Db=Mb))||Db),HT=fc("cc.CompPrefabInfo")((kb=st((Vb=function(){at(this,"fileId",kb,this)}).prototype,"fileId",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zb=Vb))||zb,jT=(Gb=fc("CCPropertyOverrideInfo"),Ub=Xc(GT),Gb((Yb=function(){function t(){at(this,"targetInfo",Wb,this),at(this,"propertyPath",qb,this),at(this,"value",Xb,this)}return t.prototype.isTarget=function(){},t}(),Wb=st((jb=Yb).prototype,"targetInfo",[yc,Ub],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qb=st(jb.prototype,"propertyPath",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xb=st(jb.prototype,"value",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Hb=jb))||Hb),WT=(Kb=fc("cc.MountedChildrenInfo"),Jb=Xc(GT),Qb=Xc([kT]),Kb((nT=function(){function t(){at(this,"targetInfo",tT,this),at(this,"nodes",eT,this)}return t.prototype.isTarget=function(){},t}(),tT=st(($b=nT).prototype,"targetInfo",[yc,Jb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eT=st($b.prototype,"nodes",[yc,Qb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zb=$b))||Zb),qT=(iT=fc("cc.MountedComponentsInfo"),rT=Xc(GT),oT=Xc([Qu]),iT((uT=function(){function t(){at(this,"targetInfo",cT,this),at(this,"components",lT,this)}return t.prototype.isTarget=function(){},t}(),cT=st((sT=uT).prototype,"targetInfo",[yc,rT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lT=st(sT.prototype,"components",[yc,oT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aT=sT))||aT),XT=(hT=fc("cc.PrefabInstance"),_T=Xc(kT),fT=Xc([WT]),dT=Xc([qT]),pT=Xc([jT]),mT=Xc([GT]),hT((TT=function(){function t(){at(this,"fileId",yT,this),at(this,"prefabRootNode",xT,this),at(this,"mountedChildren",ST,this),at(this,"mountedComponents",AT,this),at(this,"propertyOverrides",CT,this),at(this,"removedComponents",bT,this),this.targetMap={}}var e=t.prototype;return e.findPropertyOverride=function(){},e.removePropertyOverride=function(){},t}(),yT=st((gT=TT).prototype,"fileId",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xT=st(gT.prototype,"prefabRootNode",[yc,_T],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ST=st(gT.prototype,"mountedChildren",[yc,fT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AT=st(gT.prototype,"mountedComponents",[yc,dT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CT=st(gT.prototype,"propertyOverrides",[yc,pT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bT=st(gT.prototype,"removedComponents",[yc,mT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vT=gT))||vT),YT=(ET=fc("cc.PrefabInfo"),wT=Xc(kT),PT=Xc(XT),IT=Xc([UT]),ET((MT=st((DT=function(){at(this,"root",MT,this),at(this,"asset",BT,this),at(this,"fileId",OT,this),at(this,"instance",NT,this),at(this,"targetOverrides",LT,this),at(this,"nestedPrefabInstanceRoots",FT,this)}).prototype,"root",[yc,wT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),BT=st(DT.prototype,"asset",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),OT=st(DT.prototype,"fileId",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),NT=st(DT.prototype,"instance",[yc,PT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),LT=st(DT.prototype,"targetOverrides",[yc,IT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),FT=st(DT.prototype,"nestedPrefabInstanceRoots",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),RT=DT))||RT);function KT(t){var e=t._prefab;if(e&&e.instance){if(!e.asset)return D(3701,t.name),void(e.instance=void 0);var n=t._objFlags,i=t._parent,r=t._id,o=t._prefab;t[sl],c.game._isCloning=!0,e.asset._doInstantiate(t),c.game._isCloning=!1,t._objFlags=n,t._parent=i,t._id=r,t._prefab&&(t._prefab.instance=null==o?void 0:o.instance)}}function JT(t,e,n){var i;if(e&&t){var r=e,o=null===(i=t._prefab)||void 0===i?void 0:i.instance;!n&&o&&(e[o.fileId]={},r=e[o.fileId]);var a=t._prefab;a&&(r[a.fileId]=t);for(var s=t.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<t.children.length;u++)JT(t.children[u],r,!1)}}function QT(t,e){if(!t)return null;for(var n=e,i=0;i<t.length;i++){if(!n)return null;n=n[t[i]]}return n}function ZT(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r&&r.targetInfo){var o=QT(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,JT(u,a,!1),u._siblingIndex=o._children.length-1,iE(u,!0))}}}}function $T(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r&&r.targetInfo){var o=QT(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function tE(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r){var o=QT(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function eE(t,e,n){if(!(e.length<=0))for(var i=null,r=0;r<e.length;r++){var o=e[r];if(o&&o.targetInfo){if(!(i=QT(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof le?a[c].set(o.value):a[c]=o.value}}}}function nE(t){var e,n=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=QT(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var d=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(d&&d.targetMap&&(_=QT(f.localID,d.targetMap))){var p=a.propertyPath.slice(),m=s;if(p.length>0){var v=p.pop();if(!v)return;for(var g=0;g<p.length&&(m=m[p[g]]);g++);if(!m)continue;m[v]=_}}}}}}function iE(t,e){void 0===e&&(e=!1);var n=t._prefab,i=null==n?void 0:n.instance;if(i){KT(t);var r={};i.targetMap=r,JT(t,r,!0),ZT(0,i.mountedChildren,r),tE(0,i.removedComponents,r),$T(0,i.mountedComponents,r),eE(0,i.propertyOverrides,r)}e&&t&&t.children&&t.children.forEach((function(t){iE(t,!0)}))}function rE(t){var e=t._prefab;e&&e.nestedPrefabInstanceRoots&&e.nestedPrefabInstanceRoots.forEach((function(t){iE(t)}))}c._PrefabInfo=YT;var oE,aE,sE,cE,lE,uE,hE,_E,fE,dE,pE,mE,vE,gE,yE=Object.freeze({__proto__:null,TargetInfo:GT,TargetOverrideInfo:UT,CompPrefabInfo:HT,PropertyOverrideInfo:jT,MountedChildrenInfo:WT,MountedComponentsInfo:qT,PrefabInstance:XT,PrefabInfo:YT,createNodeWithPrefab:KT,generateTargetMap:JT,getTarget:QT,applyMountedChildren:ZT,applyMountedComponents:$T,applyRemovedComponents:tE,applyPropertyOverrides:eE,applyTargetOverrides:nE,expandPrefabInstanceNode:iE,expandNestedPrefabInstanceNode:rE}),xE=oe({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),SE=t("Prefab",fc("cc.Prefab")((hE=uE=function(t){function e(){var e;return at(e=t.call(this)||this,"data",sE,it(e)),at(e,"optimizationPolicy",cE,it(e)),at(e,"persistent",lE,it(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}Q(e,t);var n=e.prototype;return n.createNode=function(t){var e=c.instantiate(this);e.name=this.name,t(null,e)},n.compileCreateFunction=function(){var t,e;this._createFunction=(e=(t=this.data)instanceof c._BaseNode&&t,new LC(t,e).result)},n._doInstantiate=function(t){return this.data._prefab||I(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)},n._instantiate=function(){var t;return this.optimizationPolicy!==xE.SINGLE_INSTANCE&&(this.optimizationPolicy===xE.MULTI_INSTANCE||this._instantiatedTimes+1>=e.OptimizationPolicyThreshold)?(t=this._doInstantiate(),this.data._instantiate(t)):t=this.data._instantiate(),++this._instantiatedTimes,t},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.data=new kT,this.data.name="(Missing Node)";var n=new c._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var t=this.data;rE(t),nE(t)},e}(Ru),uE.OptimizationPolicy=xE,uE.OptimizationPolicyThreshold=3,sE=st((aE=hE).prototype,"data",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cE=st(aE.prototype,"optimizationPolicy",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xE.AUTO}}),lE=st(aE.prototype,"persistent",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oE=aE))||oE);ne.value(SE,"_utils",yE),c.Prefab=SE,It(c,"cc._Prefab","Prefab"),t("PrefabLink",(_E=fc("cc.PrefabLink"),fE=Xc(SE),dE=Dc(),_E((gE=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"prefab",vE,it(e)),e}return Q(e,t),e}(Qu),vE=st((mE=gE).prototype,"prefab",[fE,yc,dE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pE=mE))||pE));var AE=new Pn;function CE(t,e,n,i){i||(i=new Pn),t.convertToUINode(e,n,i);var r=n.position;return i.add(r),i}function bE(t,e,n){return n||(n=new Pn),t.worldToScreen(e,n),n.x/=c.view.getScaleX(),n.y/=c.view.getScaleY(),n}var TE,EE,wE=t("convertUtils",{WorldNode3DToLocalNodeUI:CE,WorldNode3DToWorldNodeUI:bE});c.pipelineUtils=wE,z(c.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=e[0],r=e[3]||AE;return i.convertToUINode(e[1],e[2],r),r.add(e[2].position),e[3]||r.clone()}}]),V(Ym.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),z(NS.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var PE,IE=t("BufferAsset",fc("cc.BufferAsset")((st((EE=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._buffer=null,e}Q(e,t);var n=e.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},K(e,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}}]),e}(Ru)).prototype,"_nativeAsset",[il],Object.getOwnPropertyDescriptor(EE.prototype,"_nativeAsset"),EE.prototype),TE=EE))||TE);c.BufferAsset=IE;var RE=((PE={})[fi.UNORM]="Uint",PE[fi.SNORM]="Int",PE[fi.UINT]="Uint",PE[fi.INT]="Int",PE[fi.UFLOAT]="Float",PE[fi.FLOAT]="Float",PE.default="Uint",PE);function DE(t){return""+(RE[t.type]||RE.default)+t.size/t.count*8}function ME(t,e,n,i,r){void 0===n&&(n=_i.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=Zr[n];r||(r=o.size);for(var a="set"+DE(o),s=o.size/o.count,c=Math.floor(e.length/o.count),l=sh.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,_=0;_<o.count;++_){var f=h+s*_;t[a](f,e[o.count*u+_],l)}}function BE(t,e,n,i,r,o,a){void 0===n&&(n=_i.R32F),void 0===i&&(i=0),void 0===r&&(r=t.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));var s=Zr[n];o||(o=s.size);for(var c="set"+DE(s),l="get"+DE(s),u=s.size/s.count,h=Math.floor(r/o),_=sh.isLittleEndian,f=0;f<h;++f)for(var d=i+o*f,p=0;p<s.count;++p){var m=d+u*p,v=t[l](m,_);a[c](m,e(v,p,t),_)}return a}var OE,NE,LE=t("RenderingSubMesh",function(){var t=e.prototype;function e(t,e,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new Rr(e,t,i,r),this._init()}return t._init=function(){},t.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var t=this.mesh,e=0,n=t.struct.primitives[this.subMeshIdx];n.indexView&&(e=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=t.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(t.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=t.readIndices(this.subMeshIdx),_=0;_<e;++_)for(var f=_*s,d=h[_]*s,p=0;p<s;++p)u[f+p]=l[d+p];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(t.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},t.destroy=function(){for(var t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var e=0;e<this._jointMappedBufferIndices.length;e++)this._jointMappedBuffers[this._jointMappedBufferIndices[e]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},t.enableVertexIdChannel=function(t){if(!this._vertexIdChannel){var e=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(t);this._vertexBuffers.push(i),this._attributes.push(new Pr("a_vertexId",_i.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:n}}},t._allocVertexIdBuffer=function(t){for(var e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(e),i=0;i<e;++i)n[i]=i+.5;var r=t.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},K(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Pn.ZERO,max:Pn.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Pn.ZERO,max:Pn.ZERO}};var t=this.mesh,e=this.subMeshIdx,n=t.readAttribute(e,Ki.ATTR_POSITION),i=t.readIndices(e),r=new Pn,o=new Pn,a=this.attributes.find((function(t){return t.name===Ki.ATTR_POSITION}));if(a){var s=Zr[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var t=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var e=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,o=this.mesh.struct,a=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===a.jointMapIndex||!o.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=c.director.root.device,l=0;l<a.vertexBundelIndices.length;l++){var u=o.vertexBundles[a.vertexBundelIndices[l]];r=0,i=_i.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===Ki.ATTR_JOINTS){i=_.format;break}r+=Zr[_.format].size}i?function(){var c=new Uint8Array(t.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(c.slice().buffer),_=o.jointMaps[a.jointMapIndex];BE(h,(function(t){return _.indexOf(t)}),i,r,u.view.length,u.view.stride,h);var f=s.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.DEVICE,u.view.length,u.view.stride));f.update(h.buffer),e.push(f),n.push(l)}():e.push(this.vertexBuffers[a.vertexBundelIndices[l]])}return this._vertexIdChannel&&e.push(this._allocVertexIdBuffer(s)),e}},{key:"iaInfo",get:function(){return this._iaInfo}}]),e}());!function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(OE||(OE=t("SystemEventType",{}))),function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.KEY_DOWN="keydown",t.KEY_PRESSING="key-pressing",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion"}(NE||(NE={})),c.SystemEventType=OE;var FE,zE=new Array(16),VE=null,kE=new Xn,GE=[zC.TOUCH_START,zC.TOUCH_MOVE,zC.TOUCH_END,zC.TOUCH_CANCEL],UE=[zC.MOUSE_DOWN,zC.MOUSE_ENTER,zC.MOUSE_MOVE,zC.MOUSE_LEAVE,zC.MOUSE_UP,zC.MOUSE_WHEEL];!function(t){t[t.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",t[t.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",t[t.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(FE||(FE={}));var HE,jE,WE,qE,XE,YE,KE,JE,QE,ZE,$E,tw,ew,nw,iw,rw,ow,aw,sw,cw,lw,uw,hw,_w,fw,dw,pw,mw,vw,gw,yw,xw,Sw,Aw,Cw,bw,Tw,Ew,ww,Pw,Iw,Rw,Dw,Mw,Bw,Ow,Nw,Lw,Fw,zw,Vw,kw,Gw,Uw,Hw,jw,Ww,qw,Xw,Yw,Kw,Jw,Qw,Zw,$w,tP,eP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,_P,fP,dP,pP,mP,vP,gP,yP,xP,SP,AP,CP,bP,TP,EP,wP,PP,IP,RP,DP,MP,BP,OP,NP,LP,FP,zP,VP,kP,GP,UP,HP,jP,WP,qP,XP,YP,KP,JP,QP,ZP,$P,tI,eI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,_I,fI,dI,pI,mI,vI,gI,yI,xI,SI,AI,CI,bI,TI,EI,wI,PI,II,RI,DI,MI,BI,OI,NI,LI,FI,zI,VI,kI,GI,UI,HI,jI,WI,qI,XI,YI,KI,JI,QI,ZI,$I,tR,eR,nR,iR,rR,oR,aR,sR,cR,lR,uR,hR,_R,fR,dR,pR,mR,vR,gR,yR,xR,SR,AR=function(){var t=e.prototype;function e(t){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=t}return t.setEnabled=function(t,n){if(void 0===n&&(n=!1),this._isEnabled!==t){this._isEnabled=t;var i=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(FE.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(t,!0)}},t._searchComponentsInParent=function(t){var e=this.node;if(t){for(var n=0,i=[],r=e;r&&kT.isNode(r);r=r.parent,++n){var o=r.getComponent(t);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t.reattach=function(){var t,n=this;this.node.walk((function(i){t||(t=n._searchComponentsInParent(e._maskComp)),i.eventProcessor.maskList=t}))},t.destroy=function(){VE===this._node&&(VE=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(FE.REMOVE_POINTER_EVENT_PROCESSOR,this)},t._isTouchEvent=function(t){return-1!==GE.indexOf(t)},t._isMouseEvent=function(t){return-1!==UE.indexOf(t)},t._hasTouchListeners=function(){for(var t=0;t<GE.length;++t){var e=GE[t];if(this.hasEventListener(e))return!0}return!1},t._hasMouseListeners=function(){for(var t=0;t<UE.length;++t){var e=UE[t];if(this.hasEventListener(e))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var n=this._isTouchEvent(t),i=this._isMouseEvent(t);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||e.callbacksInvoker.emit(FE.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,n=new Ql;return n._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(FE.REMOVE_POINTER_EVENT_PROCESSOR,t)})),n},t.on=function(t,e,n,i){var r,o;return this._tryEmittingAddEvent(t),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,n),e},t.once=function(t,e,n,i){var r,o;return this._tryEmittingAddEvent(t),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,n,!0),e},t.off=function(t,e,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(t,e,n)},t.targetOff=function(t){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(FE.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(t,e,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(t,e,n,i,r,o)},t.dispatchEvent=function(t){var e,n=this.node,i=0;for(t.target=n,zE.length=0,this.getCapturingTargets(t.type,zE),t.eventPhase=1,i=zE.length-1;i>=0;--i)if((e=zE[i]).eventProcessor.capturingTarget&&(t.currentTarget=e,e.eventProcessor.capturingTarget.emit(t.type,t,zE),t.propagationStopped))return void(zE.length=0);if(zE.length=0,t.eventPhase=2,t.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(t.type,t),!t.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(this.getBubblingTargets(t.type,zE),t.eventPhase=3,i=0;i<zE.length;++i)if((e=zE[i]).eventProcessor.bubblingTarget&&(t.currentTarget=e,e.eventProcessor.bubblingTarget.emit(t.type,t),t.propagationStopped))return void(zE.length=0);zE.length=0},t.hasEventListener=function(t,e,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(t,e,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(t,e,n)),i},t.getCapturingTargets=function(t,e){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(t))&&e.push(n),n=n.parent}},t.getBubblingTargets=function(t,e){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(t))&&e.push(n),n=n.parent}},t._handleEventMouse=function(t){switch(t.type){case NE.MOUSE_DOWN:return this._handleMouseDown(t);case NE.MOUSE_MOVE:return this._handleMouseMove(t);case NE.MOUSE_UP:return this._handleMouseUp(t);case NE.MOUSE_WHEEL:return this._handleMouseWheel(t);default:return!1}},t._handleMouseDown=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(kE=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(kE)||(t.type=zC.MOUSE_DOWN,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseMove=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(kE=t.getUILocation(),e._uiProps.uiTransformComp.isHit(kE)?(this.previousMouseIn||(VE&&VE!==e&&(t.type=zC.MOUSE_LEAVE,VE.dispatchEvent(t),VE.eventProcessor.previousMouseIn=!1),VE=e,t.type=zC.MOUSE_ENTER,e.dispatchEvent(t),this.previousMouseIn=!0),t.type=zC.MOUSE_MOVE,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0):(this.previousMouseIn&&(t.type=zC.MOUSE_LEAVE,e.dispatchEvent(t),this.previousMouseIn=!1,VE=null),1)))},t._handleMouseUp=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(kE=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(kE)||(t.type=zC.MOUSE_UP,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseWheel=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(kE=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(kE)||(t.type=zC.MOUSE_WHEEL,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleEventTouch=function(t){switch(t.type){case NE.TOUCH_START:return this._handleTouchStart(t);case NE.TOUCH_MOVE:return this._handleTouchMove(t);case NE.TOUCH_END:return this._handleTouchEnd(t);case NE.TOUCH_CANCEL:return this._handleTouchCancel(t);default:return!1}},t._handleTouchStart=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.getUILocation(kE),!e._uiProps.uiTransformComp.isHit(kE)||(t.type=zC.TOUCH_START,t.bubbles=!0,e.dispatchEvent(t),0)))},t._handleTouchMove=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.type=zC.TOUCH_MOVE,t.bubbles=!0,e.dispatchEvent(t),0))},t._handleTouchEnd=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.getUILocation(kE),e._uiProps.uiTransformComp.isHit(kE)?t.type=zC.TOUCH_END:t.type=zC.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},t._handleTouchCancel=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.type=zC.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},K(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}();AR._maskComp=null,AR.callbacksInvoker=new Ql,c.NodeEventProcessor=AR;var CR=new Pn(0,1,0),bR=new Pn,TR=new Qn,ER=new En,wR=new Nn,PR=function(t){var e=1/Math.max(Math.max(Math.max(t.x,t.y),t.z),1e-4);e<1&&(t.x*=e,t.y*=e,t.z*=e)},IR=(HE=fc("cc.AmbientInfo"),jE=Ic(),WE=xc("_skyColor"),qE=xc("_skyIllum"),XE=xc("_groundAlbedo"),YE=Dc(),KE=Oc(),JE=Xc(Be),QE=Oc(),ZE=Dc(),$E=Oc(),HE(tw=jE((cw=function(){function t(){at(this,"_skyColorHDR",nw,this),at(this,"_skyIllumHDR",iw,this),at(this,"_groundAlbedoHDR",rw,this),at(this,"_skyColorLDR",ow,this),at(this,"_skyIllumLDR",aw,this),at(this,"_groundAlbedoLDR",sw,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},K(t,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var t=c.director.root.pipeline.pipelineSceneData.isHDR;return TR.set(t?this._skyColorHDR:this._skyColorLDR),PR(TR),ER.set(255*TR.x,255*TR.y,255*TR.z,255)},set:function(t){TR.set(t.x,t.y,t.z,t.w),c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(TR):this._skyColorLDR.set(TR),this._resource&&this._resource.skyColor.set(TR)}},{key:"skyColor",set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t),this._resource&&this._resource.skyColor.set(t)}},{key:"skyIllum",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t,this._resource&&(this._resource.skyIllum=t)}},{key:"groundLightingColor",get:function(){var t=c.director.root.pipeline.pipelineSceneData.isHDR;return TR.set(t?this._groundAlbedoHDR:this._groundAlbedoLDR),PR(TR),ER.set(255*TR.x,255*TR.y,255*TR.z,255)},set:function(t){TR.set(t.x,t.y,t.z,t.w),c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(TR):this._groundAlbedoLDR.set(TR),this._resource&&this._resource.groundAlbedo.set(TR)}},{key:"groundAlbedo",set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t),this._resource&&this._resource.groundAlbedo.set(t)}}]),t}(),nw=st((ew=cw).prototype,"_skyColorHDR",[yc,WE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn(.2,.5,.8,1)}}),iw=st(ew.prototype,"_skyIllumHDR",[yc,qE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KS.SKY_ILLUM}}),rw=st(ew.prototype,"_groundAlbedoHDR",[yc,XE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn(.2,.2,.2,1)}}),ow=st(ew.prototype,"_skyColorLDR",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn(.2,.5,.8,1)}}),aw=st(ew.prototype,"_skyIllumLDR",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KS.SKY_ILLUM}}),sw=st(ew.prototype,"_groundAlbedoLDR",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn(.2,.2,.2,1)}}),st(ew.prototype,"skyLightingColor",[YE,Rc,KE],Object.getOwnPropertyDescriptor(ew.prototype,"skyLightingColor"),ew.prototype),st(ew.prototype,"skyIllum",[Rc,JE,QE],Object.getOwnPropertyDescriptor(ew.prototype,"skyIllum"),ew.prototype),st(ew.prototype,"groundLightingColor",[ZE,Rc,$E],Object.getOwnPropertyDescriptor(ew.prototype,"groundLightingColor"),ew.prototype),tw=ew))||tw)||tw);c.AmbientInfo=IR;var RR=(lw=fc("cc.SkyboxInfo"),uw=Ic(),hw=Xc(xv),_w=xc("_envmap"),fw=Xc(xv),dw=Xc(xv),pw=Xc(xv),mw=Dc(),vw=Oc(),gw=kc(),yw=Oc(),xw=Oc(),Sw=Oc(),Aw=Xc(xv),Cw=Oc(),bw=Dc(),Tw=Xc(xv),Ew=kc(),lw(ww=uw((Fw=function(){function t(){at(this,"_applyDiffuseMap",Iw,this),at(this,"_envmapHDR",Rw,this),at(this,"_envmapLDR",Dw,this),at(this,"_diffuseMapHDR",Mw,this),at(this,"_diffuseMapLDR",Bw,this),at(this,"_enabled",Ow,this),at(this,"_useIBL",Nw,this),at(this,"_useHDR",Lw,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},K(t,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(t){this._applyDiffuseMap=t,this._resource&&(this._resource.useDiffuseMap=t)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._useIBL=t,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR=t,this._useHDR=t,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=t:this._envmapLDR=t,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=t)}},{key:"diffuseMap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=t:this._diffuseMapLDR=t,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),t}(),Iw=st((Pw=Fw).prototype,"_applyDiffuseMap",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Rw=st(Pw.prototype,"_envmapHDR",[yc,hw,_w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Dw=st(Pw.prototype,"_envmapLDR",[yc,fw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mw=st(Pw.prototype,"_diffuseMapHDR",[yc,dw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bw=st(Pw.prototype,"_diffuseMapLDR",[yc,pw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ow=st(Pw.prototype,"_enabled",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Nw=st(Pw.prototype,"_useIBL",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lw=st(Pw.prototype,"_useHDR",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),st(Pw.prototype,"applyDiffuseMap",[mw,Rc,vw,gw],Object.getOwnPropertyDescriptor(Pw.prototype,"applyDiffuseMap"),Pw.prototype),st(Pw.prototype,"enabled",[Rc,yw],Object.getOwnPropertyDescriptor(Pw.prototype,"enabled"),Pw.prototype),st(Pw.prototype,"useIBL",[Rc,xw],Object.getOwnPropertyDescriptor(Pw.prototype,"useIBL"),Pw.prototype),st(Pw.prototype,"useHDR",[Rc,Sw],Object.getOwnPropertyDescriptor(Pw.prototype,"useHDR"),Pw.prototype),st(Pw.prototype,"envmap",[Rc,Aw,Cw],Object.getOwnPropertyDescriptor(Pw.prototype,"envmap"),Pw.prototype),st(Pw.prototype,"diffuseMap",[bw,Rc,Mc,Tw,Ew],Object.getOwnPropertyDescriptor(Pw.prototype,"diffuseMap"),Pw.prototype),ww=Pw))||ww)||ww);c.SkyboxInfo=RR;var DR=(zw=fc("cc.FogInfo"),Vw=Ic(),kw=Oc(),Gw=kc(),Uw=Oc(),Hw=kc(),jw=Oc(),Ww=Xc(yC),qw=kc(),Xw=Oc(),Yw=Dc(),Kw=Xc(Be),Jw=Nc(),Qw=zc(),Zw=Oc(),$w=Dc(),tP=Xc(Be),eP=zc(),nP=Oc(),iP=Dc(),rP=Xc(Be),oP=zc(),aP=Oc(),sP=Dc(),cP=Xc(Be),lP=Lc(),uP=zc(),hP=Oc(),_P=Dc(),fP=Xc(Be),dP=zc(),pP=Oc(),mP=Dc(),vP=Xc(Be),gP=zc(),yP=Oc(),zw(xP=Vw((BP=MP=function(){function t(){at(this,"_type",AP,this),at(this,"_fogColor",CP,this),at(this,"_enabled",bP,this),at(this,"_fogDensity",TP,this),at(this,"_fogStart",EP,this),at(this,"_fogEnd",wP,this),at(this,"_fogAtten",PP,this),at(this,"_fogTop",IP,this),at(this,"_fogRange",RP,this),at(this,"_accurate",DP,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.activate()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._accurate!==t&&(this._accurate=t,this._resource&&(this._resource.accurate=t,t&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}}]),t}(),MP.FogType=yC,AP=st((SP=BP).prototype,"_type",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yC.LINEAR}}),CP=st(SP.prototype,"_fogColor",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En("#C8C8C8")}}),bP=st(SP.prototype,"_enabled",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TP=st(SP.prototype,"_fogDensity",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),EP=st(SP.prototype,"_fogStart",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),wP=st(SP.prototype,"_fogEnd",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),PP=st(SP.prototype,"_fogAtten",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),IP=st(SP.prototype,"_fogTop",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),RP=st(SP.prototype,"_fogRange",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),DP=st(SP.prototype,"_accurate",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),st(SP.prototype,"enabled",[Rc,kw,Gw],Object.getOwnPropertyDescriptor(SP.prototype,"enabled"),SP.prototype),st(SP.prototype,"accurate",[Rc,Uw,Hw],Object.getOwnPropertyDescriptor(SP.prototype,"accurate"),SP.prototype),st(SP.prototype,"fogColor",[Rc,jw],Object.getOwnPropertyDescriptor(SP.prototype,"fogColor"),SP.prototype),st(SP.prototype,"type",[Rc,Ww,qw,Xw],Object.getOwnPropertyDescriptor(SP.prototype,"type"),SP.prototype),st(SP.prototype,"fogDensity",[Yw,Kw,Jw,Qw,Vc,Zw],Object.getOwnPropertyDescriptor(SP.prototype,"fogDensity"),SP.prototype),st(SP.prototype,"fogStart",[$w,tP,eP,nP],Object.getOwnPropertyDescriptor(SP.prototype,"fogStart"),SP.prototype),st(SP.prototype,"fogEnd",[iP,rP,oP,aP],Object.getOwnPropertyDescriptor(SP.prototype,"fogEnd"),SP.prototype),st(SP.prototype,"fogAtten",[sP,cP,lP,uP,hP],Object.getOwnPropertyDescriptor(SP.prototype,"fogAtten"),SP.prototype),st(SP.prototype,"fogTop",[_P,fP,dP,pP],Object.getOwnPropertyDescriptor(SP.prototype,"fogTop"),SP.prototype),st(SP.prototype,"fogRange",[mP,vP,gP,yP],Object.getOwnPropertyDescriptor(SP.prototype,"fogRange"),SP.prototype),xP=SP))||xP)||xP),MR=(OP=fc("cc.ShadowsInfo"),NP=Ic(),LP=Oc(),FP=Xc(pg),zP=Dc(),VP=Dc(),kP=Oc(),GP=Xc(Be),UP=Oc(),HP=Dc(),jP=Nc(),WP=Xc(Be),qP=Oc(),XP=Dc(),YP=Xc(mg),KP=Oc(),JP=Dc(),QP=Xc(Me),ZP=Dc(),$P=Xc(Be),tI=Oc(),eI=Dc(),nI=Xc(Be),iI=Oc(),rI=Dc(),oI=Xc(dg),aI=Oc(),sI=Dc(),cI=Xc(Oe),lI=Oc(),uI=Dc(),hI=Xc(Be),_I=Oc(),fI=Dc(),dI=Xc(Be),pI=Oc(),mI=Dc(),vI=Nc(),gI=Xc(Be),yI=Oc(),xI=Dc(),SI=Nc(),AI=Xc(Be),CI=Oc(),bI=Dc(),TI=Xc(Be),EI=Oc(),wI=Dc(),OP(PI=NP((YI=function(){function t(){at(this,"_type",RI,this),at(this,"_enabled",DI,this),at(this,"_normal",MI,this),at(this,"_distance",BI,this),at(this,"_shadowColor",OI,this),at(this,"_firstSetCSM",NI,this),at(this,"_fixedArea",LI,this),at(this,"_pcf",FI,this),at(this,"_bias",zI,this),at(this,"_normalBias",VI,this),at(this,"_near",kI,this),at(this,"_far",GI,this),at(this,"_shadowDistance",UI,this),at(this,"_invisibleOcclusionRange",HI,this),at(this,"_orthoSize",jI,this),at(this,"_maxReceived",WI,this),at(this,"_size",qI,this),at(this,"_saturation",XI,this),this._resource=null}var e=t.prototype;return e.setPlaneFromNode=function(t){t.getWorldRotation(wR),this.normal=Pn.transformQuat(bR,CR,wR),t.getWorldPosition(bR),this.distance=Pn.dot(this._normal,bR)},e.activate=function(t){this.pcf=Math.min(this._pcf,mg.SOFT_2X),this._resource=t,this._resource.initialize(this),this._resource.activate()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}},{key:"normal",get:function(){return this._normal},set:function(t){Pn.copy(this._normal,t),this._resource&&(this._resource.normal=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t,this._resource&&(this._resource.distance=t)}},{key:"saturation",get:function(){return this._saturation},set:function(t){t>1?(this._saturation=t/t,this._resource&&(this._resource.saturation=t/t)):(this._saturation=t,this._resource&&(this._resource.saturation=t))}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t,this._resource&&(this._resource.pcf=t)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t,this._resource&&(this._resource.bias=t)}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t,this._resource&&(this._resource.normalBias=t)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(t){this._size.set(t,t),this._resource&&(this._resource.size.set(t,t),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t,this._resource&&(this._resource.fixedArea=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._resource&&(this._resource.near=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=Math.min(t,gg.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=Math.min(t,gg.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=Math.min(t,gg.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t,this._resource&&(this._resource.orthoSize=t)}}]),t}(),RI=st((II=YI).prototype,"_type",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pg.Planar}}),DI=st(II.prototype,"_enabled",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),MI=st(II.prototype,"_normal",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(0,1,0)}}),BI=st(II.prototype,"_distance",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OI=st(II.prototype,"_shadowColor",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En(0,0,0,76)}}),NI=st(II.prototype,"_firstSetCSM",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LI=st(II.prototype,"_fixedArea",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FI=st(II.prototype,"_pcf",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mg.HARD}}),zI=st(II.prototype,"_bias",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),VI=st(II.prototype,"_normalBias",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kI=st(II.prototype,"_near",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),GI=st(II.prototype,"_far",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),UI=st(II.prototype,"_shadowDistance",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),HI=st(II.prototype,"_invisibleOcclusionRange",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),jI=st(II.prototype,"_orthoSize",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),WI=st(II.prototype,"_maxReceived",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),qI=st(II.prototype,"_size",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(512,512)}}),XI=st(II.prototype,"_saturation",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),st(II.prototype,"enabled",[Rc,LP],Object.getOwnPropertyDescriptor(II.prototype,"enabled"),II.prototype),st(II.prototype,"type",[Rc,FP],Object.getOwnPropertyDescriptor(II.prototype,"type"),II.prototype),st(II.prototype,"shadowColor",[zP],Object.getOwnPropertyDescriptor(II.prototype,"shadowColor"),II.prototype),st(II.prototype,"normal",[VP,kP],Object.getOwnPropertyDescriptor(II.prototype,"normal"),II.prototype),st(II.prototype,"distance",[GP,UP,HP],Object.getOwnPropertyDescriptor(II.prototype,"distance"),II.prototype),st(II.prototype,"saturation",[Rc,jP,Vc,WP,qP,XP],Object.getOwnPropertyDescriptor(II.prototype,"saturation"),II.prototype),st(II.prototype,"pcf",[YP,KP,JP],Object.getOwnPropertyDescriptor(II.prototype,"pcf"),II.prototype),st(II.prototype,"maxReceived",[QP,ZP],Object.getOwnPropertyDescriptor(II.prototype,"maxReceived"),II.prototype),st(II.prototype,"bias",[$P,tI,eI],Object.getOwnPropertyDescriptor(II.prototype,"bias"),II.prototype),st(II.prototype,"normalBias",[nI,iI,rI],Object.getOwnPropertyDescriptor(II.prototype,"normalBias"),II.prototype),st(II.prototype,"shadowMapSize",[oI,aI,sI],Object.getOwnPropertyDescriptor(II.prototype,"shadowMapSize"),II.prototype),st(II.prototype,"fixedArea",[cI,lI,uI],Object.getOwnPropertyDescriptor(II.prototype,"fixedArea"),II.prototype),st(II.prototype,"near",[hI,_I,fI],Object.getOwnPropertyDescriptor(II.prototype,"near"),II.prototype),st(II.prototype,"far",[dI,pI,mI],Object.getOwnPropertyDescriptor(II.prototype,"far"),II.prototype),st(II.prototype,"invisibleOcclusionRange",[Rc,vI,Vc,gI,yI,xI],Object.getOwnPropertyDescriptor(II.prototype,"invisibleOcclusionRange"),II.prototype),st(II.prototype,"shadowDistance",[Rc,SI,Vc,AI,CI,bI],Object.getOwnPropertyDescriptor(II.prototype,"shadowDistance"),II.prototype),st(II.prototype,"orthoSize",[TI,EI,wI],Object.getOwnPropertyDescriptor(II.prototype,"orthoSize"),II.prototype),PI=II))||PI)||PI);c.ShadowsInfo=MR;var BR=new Pn(-1024,-1024,-1024),OR=new Pn(1024,1024,1024),NR=(KI=fc("cc.OctreeInfo"),JI=Ic(),QI=Oc(),ZI=Oc(),$I=Bc(),tR=Oc(),eR=Bc(),nR=Nc(),iR=Xc(Me),rR=Oc(),KI(oR=JI((hR=function(){function t(){at(this,"_enabled",sR,this),at(this,"_minPos",cR,this),at(this,"_maxPos",lR,this),at(this,"_depth",uR,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t))}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t,this._resource&&(this._resource.minPos=t)}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t,this._resource&&(this._resource.maxPos=t)}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t,this._resource&&(this._resource.depth=t)}}]),t}(),sR=st((aR=hR).prototype,"_enabled",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cR=st(aR.prototype,"_minPos",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(BR)}}),lR=st(aR.prototype,"_maxPos",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(OR)}}),uR=st(aR.prototype,"_depth",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),st(aR.prototype,"enabled",[Rc,QI],Object.getOwnPropertyDescriptor(aR.prototype,"enabled"),aR.prototype),st(aR.prototype,"minPos",[Rc,ZI,$I],Object.getOwnPropertyDescriptor(aR.prototype,"minPos"),aR.prototype),st(aR.prototype,"maxPos",[Rc,tR,eR],Object.getOwnPropertyDescriptor(aR.prototype,"maxPos"),aR.prototype),st(aR.prototype,"depth",[Rc,nR,iR,rR],Object.getOwnPropertyDescriptor(aR.prototype,"depth"),aR.prototype),oR=aR))||oR)||oR),LR=(_R=fc("cc.SceneGlobals"),fR=Xc(RR),_R((SR=function(){function t(){at(this,"ambient",mR,this),at(this,"shadows",vR,this),at(this,"_skybox",gR,this),at(this,"fog",yR,this),at(this,"octree",xR,this)}return t.prototype.activate=function(){var t=c.director.root.pipeline.pipelineSceneData;this.skybox.activate(t.skybox),this.ambient.activate(t.ambient),this.shadows.activate(t.shadows),this.fog.activate(t.fog),this.octree.activate(t.octree)},K(t,[{key:"skybox",get:function(){return this._skybox},set:function(t){this._skybox=t}}]),t}(),mR=st((pR=SR).prototype,"ambient",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new IR}}),vR=st(pR.prototype,"shadows",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new MR}}),gR=st(pR.prototype,"_skybox",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RR}}),yR=st(pR.prototype,"fog",[Rc,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new DR}}),st(pR.prototype,"skybox",[Rc,fR],Object.getOwnPropertyDescriptor(pR.prototype,"skybox"),pR.prototype),xR=st(pR.prototype,"octree",[Rc,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new NR}}),dR=pR))||dR);c.SceneGlobals=LR;var FR=t("Event",function(){function t(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}var e=t.prototype;return e.unuse=function(){this.type=t.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=t.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},e.reuse=function(t,e){this.type=t,this.bubbles=e||!1},e.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},e.getCurrentTarget=function(){return this.currentTarget},e.getType=function(){return this.type},t}());FR.NO_TYPE="no_type",FR.TOUCH="touch",FR.MOUSE="mouse",FR.KEYBOARD="keyboard",FR.ACCELERATION="acceleration",FR.NONE=0,FR.CAPTURING_PHASE=1,FR.AT_TARGET=2,FR.BUBBLING_PHASE=3,c.Event=FR;var zR=t("EventAcceleration",function(t){function e(e,n){var i;return(i=t.call(this,OE.DEVICEMOTION,n)||this).acc=void 0,i.acc=e,i}return Q(e,t),e}(FR));FR.EventAcceleration=zR;var VR=t("EventKeyboard",function(t){function e(e,n,i){var r;return"boolean"==typeof n&&(n=n?OE.KEY_DOWN:OE.KEY_UP),(r=t.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==OE.KEY_UP,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r}return Q(e,t),K(e,[{key:"isPressed",get:function(){return this._isPressed}}]),e}(FR));FR.EventKeyboard=VR;var kR=t("EventMouse",function(t){function e(n,i,r){var o;return(o=t.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=e.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}Q(e,t);var n=e.prototype;return n.setScrollData=function(t,e){this._scrollX=t,this._scrollY=e},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(t,e){this._x=t,this._y=e},n.getLocation=function(t){return t||(t=new Xn),Xn.set(t,this._x,this._y),t},n.getLocationInView=function(t){return t||(t=new Xn),Xn.set(t,this._x,c.view._designResolutionSize.height-this._y),t},n.getUILocation=function(t){return t||(t=new Xn),Xn.set(t,this._x,this._y),c.view._convertToUISpace(t),t},n.getPreviousLocation=function(t){return t||(t=new Xn),Xn.set(t,this._prevX,this._prevY),t},n.getUIPreviousLocation=function(t){return t||(t=new Xn),Xn.set(t,this._prevX,this._prevY),c.view._convertToUISpace(t),t},n.getDelta=function(t){return t||(t=new Xn),Xn.set(t,this._x-this._prevX,this._y-this._prevY),t},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(t){return t||(t=new Xn),Xn.set(t,(this._x-this._prevX)/c.view.getScaleX(),(this._y-this._prevY)/c.view.getScaleY()),t},n.getUIDeltaX=function(){return(this._x-this._prevX)/c.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/c.view.getScaleY()},n.setButton=function(t){this._button=t},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var t=c.view.getViewportRect();return(this._x-t.x)/c.view.getScaleX()},n.getUILocationY=function(){var t=c.view.getViewportRect();return(this._y-t.y)/c.view.getScaleY()},K(e,[{key:"eventType",get:function(){return this._eventType}}]),e}(FR));kR.BUTTON_MISSING=-1,kR.BUTTON_LEFT=0,kR.BUTTON_RIGHT=2,kR.BUTTON_MIDDLE=1,kR.BUTTON_4=3,kR.BUTTON_5=4,kR.BUTTON_6=5,kR.BUTTON_7=6,kR.BUTTON_8=7,FR.EventMouse=kR;var GR=new Xn,UR=t("EventTouch",function(t){function e(e,n,i,r){var o;return void 0===r&&(r=[]),(o=t.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=e||[],o._allTouches=r,o}Q(e,t);var n=e.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)},n.getLocation=function(t){return this.touch?this.touch.getLocation(t):new Xn},n.getUILocation=function(t){return this.touch?this.touch.getUILocation(t):new Xn},n.getLocationInView=function(t){return this.touch?this.touch.getLocationInView(t):new Xn},n.getPreviousLocation=function(t){return this.touch?this.touch.getPreviousLocation(t):new Xn},n.getStartLocation=function(t){return this.touch?this.touch.getStartLocation(t):new Xn},n.getUIStartLocation=function(t){return this.touch?this.touch.getUIStartLocation(t):new Xn},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(t){return this.touch?this.touch.getDelta(t):new Xn},n.getUIDelta=function(t){return this.touch?this.touch.getUIDelta(t):new Xn},n.getDeltaX=function(){return this.touch?this.touch.getDelta(GR).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(GR).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},e}(FR));UR.MAX_TOUCHES=5,FR.EventTouch=UR;var HR,jR=t("Acceleration",(function(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=n,this.timestamp=i}));!function(t){t[t.NONE=0]="NONE",t[t.MOBILE_BACK=6]="MOBILE_BACK",t[t.BACKSPACE=8]="BACKSPACE",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER",t[t.SHIFT_LEFT=16]="SHIFT_LEFT",t[t.CTRL_LEFT=17]="CTRL_LEFT",t[t.ALT_LEFT=18]="ALT_LEFT",t[t.PAUSE=19]="PAUSE",t[t.CAPS_LOCK=20]="CAPS_LOCK",t[t.ESCAPE=27]="ESCAPE",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.ARROW_LEFT=37]="ARROW_LEFT",t[t.ARROW_UP=38]="ARROW_UP",t[t.ARROW_RIGHT=39]="ARROW_RIGHT",t[t.ARROW_DOWN=40]="ARROW_DOWN",t[t.INSERT=45]="INSERT",t[t.DELETE=46]="DELETE",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_1=49]="DIGIT_1",t[t.DIGIT_2=50]="DIGIT_2",t[t.DIGIT_3=51]="DIGIT_3",t[t.DIGIT_4=52]="DIGIT_4",t[t.DIGIT_5=53]="DIGIT_5",t[t.DIGIT_6=54]="DIGIT_6",t[t.DIGIT_7=55]="DIGIT_7",t[t.DIGIT_8=56]="DIGIT_8",t[t.DIGIT_9=57]="DIGIT_9",t[t.KEY_A=65]="KEY_A",t[t.KEY_B=66]="KEY_B",t[t.KEY_C=67]="KEY_C",t[t.KEY_D=68]="KEY_D",t[t.KEY_E=69]="KEY_E",t[t.KEY_F=70]="KEY_F",t[t.KEY_G=71]="KEY_G",t[t.KEY_H=72]="KEY_H",t[t.KEY_I=73]="KEY_I",t[t.KEY_J=74]="KEY_J",t[t.KEY_K=75]="KEY_K",t[t.KEY_L=76]="KEY_L",t[t.KEY_M=77]="KEY_M",t[t.KEY_N=78]="KEY_N",t[t.KEY_O=79]="KEY_O",t[t.KEY_P=80]="KEY_P",t[t.KEY_Q=81]="KEY_Q",t[t.KEY_R=82]="KEY_R",t[t.KEY_S=83]="KEY_S",t[t.KEY_T=84]="KEY_T",t[t.KEY_U=85]="KEY_U",t[t.KEY_V=86]="KEY_V",t[t.KEY_W=87]="KEY_W",t[t.KEY_X=88]="KEY_X",t[t.KEY_Y=89]="KEY_Y",t[t.KEY_Z=90]="KEY_Z",t[t.NUM_0=96]="NUM_0",t[t.NUM_1=97]="NUM_1",t[t.NUM_2=98]="NUM_2",t[t.NUM_3=99]="NUM_3",t[t.NUM_4=100]="NUM_4",t[t.NUM_5=101]="NUM_5",t[t.NUM_6=102]="NUM_6",t[t.NUM_7=103]="NUM_7",t[t.NUM_8=104]="NUM_8",t[t.NUM_9=105]="NUM_9",t[t.NUM_MULTIPLY=106]="NUM_MULTIPLY",t[t.NUM_PLUS=107]="NUM_PLUS",t[t.NUM_SUBTRACT=109]="NUM_SUBTRACT",t[t.NUM_DECIMAL=110]="NUM_DECIMAL",t[t.NUM_DIVIDE=111]="NUM_DIVIDE",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NUM_LOCK=144]="NUM_LOCK",t[t.SCROLL_LOCK=145]="SCROLL_LOCK",t[t.SEMICOLON=186]="SEMICOLON",t[t.EQUAL=187]="EQUAL",t[t.COMMA=188]="COMMA",t[t.DASH=189]="DASH",t[t.PERIOD=190]="PERIOD",t[t.SLASH=191]="SLASH",t[t.BACK_QUOTE=192]="BACK_QUOTE",t[t.BRACKET_LEFT=219]="BRACKET_LEFT",t[t.BACKSLASH=220]="BACKSLASH",t[t.BRACKET_RIGHT=221]="BRACKET_RIGHT",t[t.QUOTE=222]="QUOTE",t[t.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",t[t.CTRL_RIGHT=2001]="CTRL_RIGHT",t[t.ALT_RIGHT=2002]="ALT_RIGHT",t[t.NUM_ENTER=2003]="NUM_ENTER"}(HR||(HR=t("KeyCode",{})));var WR=new Xn,qR=t("Touch",function(){function t(t,e,n){void 0===n&&(n=0),this._point=new Xn,this._prevPoint=new Xn,this._lastModified=0,this._id=0,this._startPoint=new Xn,this._startPointCaptured=!1,this.setTouchInfo(n,t,e)}var e=t.prototype;return e.getLocation=function(t){return t||(t=new Xn),t.set(this._point.x,this._point.y),t},e.getLocationX=function(){return this._point.x},e.getLocationY=function(){return this._point.y},e.getUILocation=function(t){return t||(t=new Xn),t.set(this._point.x,this._point.y),c.view._convertToUISpace(t),t},e.getUILocationX=function(){var t=c.view.getViewportRect();return(this._point.x-t.x)/c.view.getScaleX()},e.getUILocationY=function(){var t=c.view.getViewportRect();return(this._point.y-t.y)/c.view.getScaleY()},e.getPreviousLocation=function(t){return t||(t=new Xn),t.set(this._prevPoint.x,this._prevPoint.y),t},e.getUIPreviousLocation=function(t){return t||(t=new Xn),t.set(this._prevPoint.x,this._prevPoint.y),c.view._convertToUISpace(t),t},e.getStartLocation=function(t){return t||(t=new Xn),t.set(this._startPoint.x,this._startPoint.y),t},e.getUIStartLocation=function(t){return t||(t=new Xn),t.set(this._startPoint.x,this._startPoint.y),c.view._convertToUISpace(t),t},e.getDelta=function(t){return t||(t=new Xn),t.set(this._point),t.subtract(this._prevPoint),t},e.getUIDelta=function(t){return t||(t=new Xn),WR.set(this._point),WR.subtract(this._prevPoint),t.set(c.view.getScaleX(),c.view.getScaleY()),Xn.divide(t,WR,t),t},e.getLocationInView=function(t){return t||(t=new Xn),t.set(this._point.x,c.view._designResolutionSize.height-this._point.y),t},e.getPreviousLocationInView=function(t){return t||(t=new Xn),t.set(this._prevPoint.x,c.view._designResolutionSize.height-this._prevPoint.y),t},e.getStartLocationInView=function(t){return t||(t=new Xn),t.set(this._startPoint.x,c.view._designResolutionSize.height-this._startPoint.y),t},e.getID=function(){return this._id},e.setTouchInfo=function(t,e,n){void 0===t&&(t=0),this._prevPoint=this._point,this._point=new Xn(e||0,n||0),this._id=t,this._startPointCaptured||(this._startPoint=new Xn(this._point),this._startPointCaptured=!0)},e.setPoint=function(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=c.game.frameStartTime},e.setPrevPoint=function(t,e){this._prevPoint="object"==typeof t?new Xn(t.x,t.y):new Xn(t||0,e||0),this._lastModified=c.game.frameStartTime},K(t,[{key:"lastModified",get:function(){return this._lastModified}}]),t}());c.Touch=qR;var XR,YR,KR=function(){function t(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new $l,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,fu.browserType===eu.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var e=t.prototype;return e._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._didAccelerate=function(t){var e=performance.now();if(!(e-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=e;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=t.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=t;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(rh.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),fu.os===ru.ANDROID&&fu.browserType!==eu.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new jR(n,i,r,l),h=new zR(u);this._eventTarget.emit(NE.DEVICEMOTION,h)}},e.start=function(){var t=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){"granted"===e&&t._registerEvent()})).catch((function(){})):this._registerEvent()},e.stop=function(){this._unregisterEvent()},e.setInterval=function(t){this._intervalInMileSeconds=t},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),JR={Backspace:HR.BACKSPACE,Tab:HR.TAB,Enter:HR.ENTER,ShiftLeft:HR.SHIFT_LEFT,ControlLeft:HR.CTRL_LEFT,AltLeft:HR.ALT_LEFT,ShiftRight:HR.SHIFT_RIGHT,ControlRight:HR.CTRL_RIGHT,AltRight:HR.ALT_RIGHT,Pause:HR.PAUSE,CapsLock:HR.CAPS_LOCK,Escape:HR.ESCAPE,Space:HR.SPACE,PageUp:HR.PAGE_UP,PageDown:HR.PAGE_DOWN,End:HR.END,Home:HR.HOME,ArrowLeft:HR.ARROW_LEFT,ArrowUp:HR.ARROW_UP,ArrowRight:HR.ARROW_RIGHT,ArrowDown:HR.ARROW_DOWN,Insert:HR.INSERT,Delete:HR.DELETE,Digit0:HR.DIGIT_0,Digit1:HR.DIGIT_1,Digit2:HR.DIGIT_2,Digit3:HR.DIGIT_3,Digit4:HR.DIGIT_4,Digit5:HR.DIGIT_5,Digit6:HR.DIGIT_6,Digit7:HR.DIGIT_7,Digit8:HR.DIGIT_8,Digit9:HR.DIGIT_9,KeyA:HR.KEY_A,KeyB:HR.KEY_B,KeyC:HR.KEY_C,KeyD:HR.KEY_D,KeyE:HR.KEY_E,KeyF:HR.KEY_F,KeyG:HR.KEY_G,KeyH:HR.KEY_H,KeyI:HR.KEY_I,KeyJ:HR.KEY_J,KeyK:HR.KEY_K,KeyL:HR.KEY_L,KeyM:HR.KEY_M,KeyN:HR.KEY_N,KeyO:HR.KEY_O,KeyP:HR.KEY_P,KeyQ:HR.KEY_Q,KeyR:HR.KEY_R,KeyS:HR.KEY_S,KeyT:HR.KEY_T,KeyU:HR.KEY_U,KeyV:HR.KEY_V,KeyW:HR.KEY_W,KeyX:HR.KEY_X,KeyY:HR.KEY_Y,KeyZ:HR.KEY_Z,Numpad0:HR.NUM_0,Numpad1:HR.NUM_1,Numpad2:HR.NUM_2,Numpad3:HR.NUM_3,Numpad4:HR.NUM_4,Numpad5:HR.NUM_5,Numpad6:HR.NUM_6,Numpad7:HR.NUM_7,Numpad8:HR.NUM_8,Numpad9:HR.NUM_9,NumpadMultiply:HR.NUM_MULTIPLY,NumpadAdd:HR.NUM_PLUS,NumpadSubtract:HR.NUM_SUBTRACT,NumpadDecimal:HR.NUM_DECIMAL,NumpadDivide:HR.NUM_DIVIDE,NumpadEnter:HR.NUM_ENTER,F1:HR.F1,F2:HR.F2,F3:HR.F3,F4:HR.F4,F5:HR.F5,F6:HR.F6,F7:HR.F7,F8:HR.F8,F9:HR.F9,F10:HR.F10,F11:HR.F11,F12:HR.F12,NumLock:HR.NUM_LOCK,ScrollLock:HR.SCROLL_LOCK,Semicolon:HR.SEMICOLON,Equal:HR.EQUAL,Comma:HR.COMMA,Minus:HR.DASH,Period:HR.PERIOD,Slash:HR.SLASH,Backquote:HR.BACK_QUOTE,BracketLeft:HR.BRACKET_LEFT,Backslash:HR.BACKSLASH,BracketRight:HR.BRACKET_RIGHT,Quote:HR.QUOTE},QR=function(){function t(){this._eventTarget=new $l,this._registerEvent()}var e=t.prototype;return e._registerEvent=function(){var t=this,e=document.getElementById("GameCanvas");null==e||e.addEventListener("keydown",(function(e){if(e.stopPropagation(),e.preventDefault(),e.repeat){var n=t._getInputEvent(e,NE.KEY_PRESSING);t._eventTarget.emit(NE.KEY_PRESSING,n)}else{var i=t._getInputEvent(e,NE.KEY_DOWN);t._eventTarget.emit(NE.KEY_DOWN,i)}})),null==e||e.addEventListener("keyup",(function(e){var n=t._getInputEvent(e,NE.KEY_UP);e.stopPropagation(),e.preventDefault(),t._eventTarget.emit(NE.KEY_UP,n)}))},e._getInputEvent=function(t,e){var n,i=(n=t.code,JR[n]||HR.NONE);return new VR(i,e)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),ZR=function(){function t(){this._canvas=void 0,this._eventTarget=new $l,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Xn,fu.hasFeature(au.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new ni(e.x,e.y,e.width,e.height):new ni(0,0,0,0)},e._getLocation=function(t){var e=this._getCanvasRect(),n=rh.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+t.movementX:t.clientX-e.x,r=this._pointLocked?this._preMousePos.y/n-t.movementY:e.y+e.height-t.clientY;return new Xn(i*=n,r*=n)},e._registerEvent=function(){var t,e,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(t=this._canvas)||void 0===t||t.addEventListener("mousedown",this._createCallback(NE.MOUSE_DOWN)),null===(e=this._canvas)||void 0===e||e.addEventListener("mousemove",this._createCallback(NE.MOUSE_MOVE));var o=this._createCallback(NE.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},e._registerPointerLockEvent=function(){var t=this,e=function(){var e=t._canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)},e._createCallback=function(t){var e=this;return function(n){var i,r=e._getLocation(n),o=n.button;switch(t){case NE.MOUSE_DOWN:null===(i=e._canvas)||void 0===i||i.focus(),e._isPressed=!0;break;case NE.MOUSE_UP:e._isPressed=!1;break;case NE.MOUSE_MOVE:e._isPressed||(o=kR.BUTTON_MISSING)}var a=new kR(t,!1,e._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,e._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===e._canvas&&n.preventDefault(),e._eventTarget.emit(t,a)}},e._handleMouseWheel=function(t){var e=NE.MOUSE_WHEEL,n=this._getLocation(t),i=t.button,r=new kR(e,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=t.movementX,r.movementY=t.movementY,r.setScrollData(5*t.deltaX,5*-t.deltaY),this._preMousePos.set(n.x,n.y),t.stopPropagation(),t.target===this._canvas&&t.preventDefault(),this._eventTarget.emit(e,r)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),$R=new Xn,tD=new(function(){function t(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var e=t.prototype;return e._cloneTouch=function(t){var e=t.getID();t.getStartLocation($R);var n=new qR($R.x,$R.y,e);return t.getLocation($R),n.setPoint($R.x,$R.y),t.getPreviousLocation($R),n.setPrevPoint($R),n},e._createTouch=function(t,e,n){if(this._touchMap.has(t))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(t)){var i=new qR(e,n,t);return this._touchMap.set(t,i),this._updateTouch(i,e,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},e.releaseTouch=function(t){this._touchMap.has(t)&&this._touchMap.delete(t)},e.getTouch=function(t,e,n){var i=this._touchMap.get(t);return i?this._updateTouch(i,e,n):i=this._createTouch(t,e,n),i?this._cloneTouch(i):void 0},e.getAllTouches=function(){var t=this,e=[];return this._touchMap.forEach((function(n){if(n){var i=t._cloneTouch(n);e.push(i)}})),e},e._updateTouch=function(t,e,n){t.getLocation($R),t.setPrevPoint($R),t.setPoint(e,n)},e._checkTouchMapSizeMoreThanMax=function(t){var e=this;if(this._touchMap.has(t))return!1;var n=ue.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(t){i-t.lastModified>ue.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+t.getID()+"."),e.releaseTouch(t.getID()))})),n>=this._touchMap.size},t}()),eD=function(){function t(){this._canvas=void 0,this._eventTarget=new $l,fu.hasFeature(au.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._registerEvent=function(){var t,e,n,i;null===(t=this._canvas)||void 0===t||t.addEventListener("touchstart",this._createCallback(NE.TOUCH_START)),null===(e=this._canvas)||void 0===e||e.addEventListener("touchmove",this._createCallback(NE.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(NE.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(NE.TOUCH_CANCEL))},e._createCallback=function(t){var e=this;return function(n){for(var i,r=e._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=e._getLocation(c,r),h=tD.getTouch(l,u.x,u.y);h&&(t!==NE.TOUCH_END&&t!==NE.TOUCH_CANCEL||tD.releaseTouch(l),o.push(h))}}if(n.stopPropagation(),n.target===e._canvas&&n.preventDefault(),t===NE.TOUCH_START&&(null===(i=e._canvas)||void 0===i||i.focus()),o.length>0){var _=new UR(o,!1,t,ue.ENABLE_MULTI_TOUCH?tD.getAllTouches():o);e._eventTarget.emit(t,_)}}},e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new ni(e.x,e.y,e.width,e.height):new ni(0,0,0,0)},e._getLocation=function(t,e){var n=t.clientX-e.x,i=e.y+e.height-t.clientY;if(rh.isFrameRotated){var r=n;n=e.height-i,i=r}var o=rh.devicePixelRatio;return new Xn(n*=o,i*=o)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}();!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.UI=1]="UI"}(YR||(YR={}));var nD=function(){function t(t){this.priority=YR.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=t}return t.prototype.dispatchEvent=function(t){return this._inputEventTarget.emit(t.type,t),!0},t}(),iD=((XR={})[NE.MOUSE_DOWN]=NE.TOUCH_START,XR[NE.MOUSE_MOVE]=NE.TOUCH_MOVE,XR[NE.MOUSE_UP]=NE.TOUCH_END,XR),rD=t("Input",function(){function t(){this._dispatchImmediately=!0,this._eventTarget=new $l,this._touchInput=new eD,this._mouseInput=new ZR,this._keyboardInput=new QR,this._accelerometerInput=new KR,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new nD(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var e=t.prototype;return e.on=function(t,e,n){return this._eventTarget.on(t,e,n),e},e.once=function(t,e,n){return this._eventTarget.once(t,e,n),e},e.off=function(t,e,n){this._eventTarget.off(t,e,n)},e.setAccelerometerEnabled=function(t){t?this._accelerometerInput.start():this._accelerometerInput.stop()},e.setAccelerometerInterval=function(t){this._accelerometerInput.setInterval(t)},e._simulateEventTouch=function(t){var e=iD[t.type],n=tD.getTouch(0,t.getLocationX(),t.getLocationY());if(n){var i=[n],r=new UR(i,!1,e,i);e===NE.TOUCH_END&&tD.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},e._registerEventDispatcher=function(t){this._eventDispatcherList.push(t),this._eventDispatcherList.sort((function(t,e){return e.priority-t.priority}))},e._emitEvent=function(t){for(var e=this._eventDispatcherList.length,n=0;n<e&&this._eventDispatcherList[n].dispatchEvent(t);++n);},e._registerEvent=function(){var t=this;if(sh.hasFeature(sh.Feature.INPUT_TOUCH)){var e=this._eventTouchList;this._touchInput.on(NE.TOUCH_START,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(NE.TOUCH_MOVE,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(NE.TOUCH_END,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(NE.TOUCH_CANCEL,(function(n){t._dispatchOrPushEventTouch(n,e)}))}if(sh.hasFeature(sh.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(NE.MOUSE_DOWN,(function(e){t._needSimulateTouchMoveEvent=!0,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(NE.MOUSE_MOVE,(function(e){t._needSimulateTouchMoveEvent&&t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(NE.MOUSE_UP,(function(e){t._needSimulateTouchMoveEvent=!1,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(NE.MOUSE_WHEEL,(function(e){t._dispatchOrPushEvent(e,n)}))}if(sh.hasFeature(sh.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(NE.KEY_DOWN,(function(e){t._dispatchOrPushEvent(e,i)})),this._keyboardInput.on(NE.KEY_PRESSING,(function(e){t._dispatchOrPushEvent(e,i)})),this._keyboardInput.on(NE.KEY_UP,(function(e){t._dispatchOrPushEvent(e,i)}))}if(sh.hasFeature(sh.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(NE.DEVICEMOTION,(function(e){t._dispatchOrPushEvent(e,r)}))}},e._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},e._dispatchOrPushEvent=function(t,e){this._dispatchImmediately?this._emitEvent(t):e.push(t)},e._dispatchOrPushEventTouch=function(t,e){if(this._dispatchImmediately)for(var n=t.getTouches(),i=n.length,r=0;r<i;++r)t.touch=n[r],t.propagationStopped=t.propagationImmediateStopped=!1,this._emitEvent(t);else e.push(t)},e._frameDispatchEvents=function(){for(var t=this._eventMouseList,e=0,n=t.length;e<n;++e){var i=t[e];this._emitEvent(i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var d=h[_];this._emitEvent(d)}for(var p=this._eventAccelerationList,m=0,v=p.length;m<v;++m){var g=p[m];this._emitEvent(g)}this._clearEvents()},t}());rD.EventType=NE;var oD=t("input",new rD),aD=t("SystemEvent",function(t){function e(){var e;return e=t.call(this)||this,oD.on(NE.MOUSE_DOWN,(function(t){e.emit(OE.MOUSE_DOWN,t)})),oD.on(NE.MOUSE_MOVE,(function(t){e.emit(OE.MOUSE_MOVE,t)})),oD.on(NE.MOUSE_UP,(function(t){e.emit(OE.MOUSE_UP,t)})),oD.on(NE.MOUSE_WHEEL,(function(t){e.emit(OE.MOUSE_WHEEL,t)})),oD.on(NE.TOUCH_START,(function(t){e.emit(OE.TOUCH_START,t.touch,t)})),oD.on(NE.TOUCH_MOVE,(function(t){e.emit(OE.TOUCH_MOVE,t.touch,t)})),oD.on(NE.TOUCH_END,(function(t){e.emit(OE.TOUCH_END,t.touch,t)})),oD.on(NE.TOUCH_CANCEL,(function(t){e.emit(OE.TOUCH_CANCEL,t.touch,t)})),oD.on(NE.KEY_DOWN,(function(t){e.emit(OE.KEY_DOWN,t)})),oD.on(NE.KEY_PRESSING,(function(t){e.emit(OE.KEY_DOWN,t)})),oD.on(NE.KEY_UP,(function(t){e.emit(OE.KEY_UP,t)})),oD.on(NE.DEVICEMOTION,(function(t){e.emit(OE.DEVICEMOTION,t)})),e}Q(e,t);var n=e.prototype;return n.setAccelerometerEnabled=function(t){oD.setAccelerometerEnabled(t)},n.setAccelerometerInterval=function(t){oD.setAccelerometerInterval(t)},n.on=function(e,n,i,r){return t.prototype.on.call(this,e,n,i,r),n},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i)},e}($l));aD.EventType=OE,c.SystemEvent=aD;var sD,cD=t("systemEvent",new aD);c.systemEvent=cD,z(OE,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),z(FR,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:aD.EventType,targetName:"SystemEvent.EventType"}]),k(FR,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),z(kR,"EventMouse",["DOWN","UP","MOVE"].map((function(t){return{name:t,newName:"MOUSE_"+t,target:aD.EventType,targetName:"SystemEvent.EventType"}}))),z(kR,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:aD.EventType,targetName:"SystemEvent.EventType"}]),k(kR.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),z(UR,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:aD.EventType,targetName:"SystemEvent.EventType"}]),z(UR,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:aD.EventType,targetName:"SystemEvent.EventType"}]),z(UR,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:aD.EventType,targetName:"SystemEvent.EventType"}]),z(UR,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:aD.EventType,targetName:"SystemEvent.EventType"}]),k(UR.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),z(UR.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:UR,targetName:"EventTouch"}]),k(ue.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(t){return{name:t}}))),k(ue.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),k(ue.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),k(ue.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),k(ue,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),z(hb.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),z(kT.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(t){this._uiProps.uiTransformComp.width=t}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(t){this._uiProps.uiTransformComp.height=t}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(t){this._uiProps.uiTransformComp.anchorX=t}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(t){this._uiProps.uiTransformComp.anchorY=t}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(t){return t||(t=new Xn),t.set(this._uiProps.uiTransformComp.anchorPoint),t}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(t,e){this._uiProps.uiTransformComp.setAnchorPoint(t,e)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(t){return t||(t=new ti),t.set(this._uiProps.uiTransformComp.contentSize),t}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(t,e){"number"==typeof t?this._uiProps.uiTransformComp.setContentSize(t,e):this._uiProps.uiTransformComp.setContentSize(t)}}]),V(LR.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),V(kT.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),z(YC.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),V(Md,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),z(Md,"Layers",[{name:"Default",newName:"DEFAULT",target:Md.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Md.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Md.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Md.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Md.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Md.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Md.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Md.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Md,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Md,targetName:"Layers"}]),V(Md.Enum,"Layers.Enum",[{name:"ALWAYS"}]),V(Md.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var lD,uD,hD,_D,fD=_l.Flags.HideInHierarchy,dD=_l.Flags.DontSave,pD=t("PrivateNode",fc("cc.PrivateNode")(sD=function(t){function e(e){var n;return I(12003,(n=t.call(this,e)||this).name),n.hideFlags|=dD|fD,n}return Q(e,t),e}(kT))||sD);z(OE,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(t){return{name:t,target:kT.EventType,targetName:"Node.EventType"}}))),z(kT.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:aD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:aD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:aD.EventType,targetName:"SystemEvent.EventType"}]),c.PrivateNode=pD;var mD=t("Scene",fc("cc.Scene")((st((uD=function(t){Q(n,t);var e=n.prototype;function n(e){var n;return at(n=t.call(this,e)||this,"autoReleaseAssets",hD,it(n)),at(n,"_globals",_D,it(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=Pn.ZERO,n._rot=Nn.IDENTITY,n._scale=Pn.ONE,n._mat=Hn.IDENTITY,n._dirtyFlags=0,n._lpos=Pn.ZERO,n._lrot=Nn.IDENTITY,n._lscale=Pn.ONE,n._activeInHierarchy=!1,c.director&&c.director.root&&(n._renderScene=c.director.root.createScene({})),n._inited=!c.game||!c.game._isCloning,n._init(),n}return e._updateScene=function(){this._scene=this},e._init=function(){},e.destroy=function(){var t=_l.prototype.destroy.call(this);if(t)for(var e=this._children,n=0;n<e.length;++n)e[n].active=!1;return this._renderScene&&c.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t},e.addComponent=function(){throw new Error(N(3822))},e._onHierarchyChanged=function(){},e._onBatchCreated=function(e){t.prototype._onBatchCreated.call(this,e);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)},e.getPosition=function(t){return Pn.copy(t||new Pn,Pn.ZERO)},e.getRotation=function(t){return Nn.copy(t||new Nn,Nn.IDENTITY)},e.getScale=function(t){return Pn.copy(t||new Pn,Pn.ONE)},e.getWorldPosition=function(t){return Pn.copy(t||new Pn,Pn.ZERO)},e.getWorldRotation=function(t){return Nn.copy(t||new Nn,Nn.IDENTITY)},e.getWorldScale=function(t){return Pn.copy(t||new Pn,Pn.ONE)},e.getWorldMatrix=function(t){return Hn.copy(t||new Hn,Hn.IDENTITY)},e.getWorldRS=function(t){return Hn.copy(t||new Hn,Hn.IDENTITY)},e.getWorldRT=function(t){return Hn.copy(t||new Hn,Hn.IDENTITY)},e.updateWorldTransform=function(){},e._instantiate=function(){},e._load=function(){this._inited||(rE(this),nE(this),this._onBatchCreated(false),this._inited=!0),this.walk(hb._setScene)},e._activate=function(t){t=!1!==t,c.director._nodeActivator.activateNode(this,t),this._globals.activate(),this._renderScene&&this._renderScene.activate()},K(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return Pn.ZERO}},{key:"worldPosition",get:function(){return Pn.ZERO}},{key:"rotation",get:function(){return Nn.IDENTITY}},{key:"worldRotation",get:function(){return Nn.IDENTITY}},{key:"scale",get:function(){return Pn.ONE}},{key:"worldScale",get:function(){return Pn.ONE}},{key:"eulerAngles",get:function(){return Pn.ZERO}},{key:"worldMatrix",get:function(){return Hn.IDENTITY}}]),n}(hb)).prototype,"globals",[Rc],Object.getOwnPropertyDescriptor(uD.prototype,"globals"),uD.prototype),hD=st(uD.prototype,"autoReleaseAssets",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_D=st(uD.prototype,"_globals",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new LR}}),lD=uD))||lD);function vD(t,e){if(!e){var n=c.director.getScene();if(!n)return null;e=n}return e.getChildByPath(t)}c.Scene=mD,c.find=vD;var gD=ee.fastRemoveAt,yD=_l.Flags.IsStartCalled,xD=_l.Flags.IsOnEnableCalled;function SD(t,e){for(var n=e.constructor._executionOrder,i=e._id,r=0,o=t.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=t[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function AD(t,e){for(var n=t.array,i=t.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(t.removeAt(i),e&&(r._objFlags&=~e))}}_l.Flags.IsEditorOnEnableCalled;var CD=function(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var e=ct;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t};function bD(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}CD.stableRemoveInactive=AD;var TD=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.add=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)},n.remove=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)},n.cancelInactive=function(t){AD(this._zero,t),AD(this._neg,t),AD(this._pos,t)},n.invoke=function(){var t=this._neg;t.array.length>0&&(t.array.sort(bD),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var e=this._pos;e.array.length>0&&(e.array.sort(bD),this._invoke(e),e.array.length=0)},e}(CD),ED=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.add=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{var n=e<0?this._neg.array:this._pos.array,i=SD(n,t);i<0&&n.splice(~i,0,t)}},n.remove=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{var n=e<0?this._neg:this._pos,i=SD(n.array,t);i>=0&&n.removeAt(i)}},n.invoke=function(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)},e}(CD);function wD(t,e,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+t+"}",r=e?Function("it","dt",i):Function("it",i);return function(t,e,n){return function(i,r){try{e(i,r)}catch(e){c._throw(e);var o=i.array;for(n&&(o[i.i]._objFlags|=n),++i.i;i.i<o.length;++i.i)try{t(o[i.i],r)}catch(t){c._throw(t),n&&(o[i.i]._objFlags|=n)}}}}(Function("c","dt",t),r,n)}var PD=wD("c.start();c._objFlags|="+yD,!1,yD),ID=wD("c.update(dt)",!0),RD=wD("c.lateUpdate(dt)",!0),DD=function(t){var e=c.director._compScheduler,n=t.array;for(t.i=0;t.i<n.length;++t.i){var i=n[t.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||e._onEnabled(i))}},MD=function(){function t(){this._deferredComps=[],this.unscheduleAll()}var e=t.prototype;return e.unscheduleAll=function(){this.startInvoker=new TD(PD),this.updateInvoker=new ED(ID),this.lateUpdateInvoker=new ED(RD),this._updating=!1},e._onEnabled=function(t){c.director.getScheduler().resumeTarget(t),t._objFlags|=xD,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)},e._onDisabled=function(t){c.director.getScheduler().pauseTarget(t),t._objFlags&=~xD;var e=this._deferredComps.indexOf(t);e>=0?gD(this._deferredComps,e):(!t.start||t._objFlags&yD||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))},e.enableComp=function(t,e){if(!(t._objFlags&xD)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}},e.disableComp=function(t){t._objFlags&xD&&(t.onDisable&&t.onDisable(),this._onDisabled(t))},e.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},e.updatePhase=function(t){this.updateInvoker.invoke(t)},e.lateUpdatePhase=function(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()},e._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},e._scheduleImmediate=function(t){"function"!=typeof t.start||t._objFlags&yD||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)},e._deferredSchedule=function(){for(var t=this._deferredComps,e=0,n=t.length;e<n;e++)this._scheduleImmediate(t[e]);t.length=0},t}(),BD=_l.Flags.IsPreloadStarted,OD=_l.Flags.IsOnLoadStarted,ND=_l.Flags.IsOnLoadCalled,LD=_l.Flags.Deactivating,FD=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.add=function(t){this._zero.array.push(t)},n.remove=function(t){this._zero.fastRemove(t)},n.cancelInactive=function(t){CD.stableRemoveInactive(this._zero,t)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},e}(CD),zD=wD("c.__preload();"),VD=wD("c.onLoad();c._objFlags|="+ND,!1,ND),kD=new te(4);function GD(t,e,n){D(3817,t.name,n),console.log("Corrupted component value:",e),e?t._removeComponent(e):ee.removeAt(t._components,n)}kD.get=function(){var t=this._get()||{preload:new FD(zD),onLoad:new TD(VD),onEnable:new TD(DD)};t.preload._zero.i=-1;var e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,(e=t.onEnable)._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};var UD,HD,jD,WD,qD,XD,YD,KD,JD=t("NodeActivator",function(){function t(){this.resetComp=void 0,this.reset()}var e=t.prototype;return e.reset=function(){this._activatingStack=[]},e.activateNode=function(t,e){if(e){var n=kD.get();this._activatingStack.push(n),this._activateNodeRecursively(t,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),kD.put(n)}else{this._deactivateNodeRecursively(t);for(var i,r=ot(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(BD),o.onLoad.cancelInactive(OD),o.onEnable.cancelInactive()}}t.emit(zC.ACTIVE_IN_HIERARCHY_CHANGED,t)},e.activateComp=function(t,e,n,i){if(dl(t,!0)&&(t._objFlags&BD||(t._objFlags|=BD,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&OD||(t._objFlags|=OD,t.onLoad?n?n.add(t):(t.onLoad(),t._objFlags|=ND):t._objFlags|=ND),t._enabled)){if(!t.node._activeInHierarchy)return;c.director._compScheduler.enableComp(t,i)}},e.destroyComp=function(t){c.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&ND&&t.onDestroy()},e._activateNodeRecursively=function(t,e,n,i){if(t._objFlags&LD)D(3816,t.name);else{t._activeInHierarchy=!0;for(var r=t._components.length,o=0;o<r;++o){var a=t._components[o];a instanceof c.Component?this.activateComp(a,e,n,i):(GD(t,a,o),--o,--r)}for(var s=0,l=t._children.length;s<l;++s){var u=t._children[s];u._active&&this._activateNodeRecursively(u,e,n,i)}t._onPostActivated(!0)}},e._deactivateNodeRecursively=function(t){t._objFlags|=LD,t._activeInHierarchy=!1;for(var e=t._components.length,n=0;n<e;++n){var i=t._components[n];if(i._enabled&&(c.director._compScheduler.disableComp(i),t._activeInHierarchy))return void(t._objFlags&=~LD)}for(var r=0,o=t._children.length;r<o;++r){var a=t._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),t._activeInHierarchy))return void(t._objFlags&=~LD)}t._onPostActivated(!1),t._objFlags&=~LD},t}()),QD=t("SceneAsset",fc("cc.SceneAsset")((WD=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"scene",jD,it(e)),e}Q(e,t);var n=e.prototype;return n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.scene=new mD("New Scene")},n.validate=function(){return!!this.scene},e}(Ru),jD=st((HD=WD).prototype,"scene",[Rc,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UD=HD))||UD);c.SceneAsset=QD;var ZD,$D,tM,eM,nM=t("TextAsset",fc("cc.TextAsset")((KD=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"text",YD,it(e)),e}return Q(e,t),e.prototype.toString=function(){return this.text},e}(Ru),YD=st((XD=KD).prototype,"text",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qD=XD))||qD);c.TextAsset=nM;var iM=t("JsonAsset",fc("cc.JsonAsset")((eM=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"json",tM,it(e)),e}return Q(e,t),e}(Ru),tM=st(($D=eM).prototype,"json",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZD=$D))||ZD);c.JsonAsset=iM;var rM,oM,aM,sM,cM,lM,uM,hM,_M,fM,dM,pM,mM,vM,gM,yM,xM,SM,AM,CM,bM,TM,EM,wM,PM,IM,RM,DM,MM,BM,OM,NM,LM,FM,zM,VM,kM,GM,UM=function(){var t=e.prototype;function e(){this.fog=new SC,this.ambient=new KS,this.skybox=new pA,this.shadows=new gg,this.octree=new QS,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return t._init=function(){},t.activate=function(t,e){return this._device=t,this._pipeline=e,this.initOcclusionQuery(),!0},t.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var t=new rg;t._uuid="default-occlusion-query-material",t.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=t,this._occlusionQueryShader=t.passes[0].getShaderVariant()}},t.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},t.onGlobalPipelineStateChanged=function(){},t.destroy=function(){var t,e,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(t=this._occlusionQueryInputAssembler)||void 0===t||t.destroy(),this._occlusionQueryInputAssembler=null,null===(e=this._occlusionQueryVertexBuffer)||void 0===e||e.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},t._createOcclusionQueryIA=function(){var t=this._device,e=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=t.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(e);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=t.createBuffer(new hr(pi.INDEX|pi.TRANSFER_DST,gi.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Pr("a_position",_i.RGB32F)],c=new Rr(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return t.createInputAssembler(c)},K(e,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(t){this._isHDR=t}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(t){this._shadingScale!==t&&(this._shadingScale=t,this._pipeline.emit(Fy.ATTACHMENT_SCALE_CAHNGED,t))}}]),e}(),HM=t("ForwardPipeline",(rM=fc("ForwardPipeline"),oM=Xc([FS]),aM=kc(),rM((uM=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"renderTextures",lM,it(e)),e._postRenderPass=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var n=new vC;n.initialize(vC.initInfo),this._flows.push(n);var i=new $A;i.initialize($A.initInfo),this._flows.push(i)}return!0},n.activate=function(e){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new UM,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(D(2402),1))},n._ensureEnoughSize=function(t){for(var e=this._width,n=this._height,i=0;i<t.length;++i){var r=t[i].window;e=Math.max(r.width,e),n=Math.max(r.height,n)}e===this._width&&n===this._height||(this._width=e,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},n._activeRenderer=function(){var t=this.device;this._commandBuffers.push(t.commandBuffer);var e=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(Qd,e),this._descriptorSet.bindTexture(Qd,Pv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(ap,e),this._descriptorSet.bindTexture(ap,Pv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Yd.BINDING).destroy(),this._descriptorSet.getBuffer(Jd.BINDING).destroy(),this._descriptorSet.getBuffer(Kd.BINDING).destroy(),this._descriptorSet.getTexture(Qd).destroy(),this._descriptorSet.getTexture(ap).destroy())},K(e,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),e}(ox),lM=st((cM=uM).prototype,"renderTextures",[oM,yc,aM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sM=cM))||sM)),jM=[new sr(0,0,0,0),new sr(0,0,0,0),new sr(0,0,0,0)],WM=t("GbufferStage",(hM=fc("GbufferStage"),_M=Xc([kS]),fM=kc(),hM((gM=vM=function(t){function e(){var e;return at(e=t.call(this)||this,"renderQueues",mM,it(e)),e._renderQueues=[],e._renderArea=new $i,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Iv("default"),e._batchedQueue=new XS,e._instancedQueue=new YS,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=jS(this.renderQueues[i])},n.destroy=function(){},n.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,n=e.device;this._renderQueues.forEach(WS),e.generateRenderArea(t,this._renderArea),e.updateQuadVertexData(this._renderArea,t.window);for(var i=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===bv.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(f===bv.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,o,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(qS);var m=e.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),t.clearFlag&Xi.COLOR&&(e.pipelineSceneData.isHDR?Vv(jM[0],t.clearColor):(jM[0].x=t.clearColor.x,jM[0].y=t.clearColor.y,jM[0].z=t.clearColor.z)),jM[0].w=t.clearColor.w;var v=e.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,jM,t.clearDepth,t.clearStencil),m.setScissor(e.generateScissor(t)),m.setViewport(e.generateViewport(t)),m.bindDescriptorSet(jd.GLOBAL,e.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},e}(Ly),vM.initInfo={name:"GbufferStage",priority:Qy.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:LS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:LS.BACK_TO_FRONT,stages:["default"]}]},mM=st((pM=gM).prototype,"renderQueues",[_M,yc,fM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dM=pM))||dM)),qM=[new sr(0,0,0,1)],XM=t("LightingStage",(yM=fc("LightingStage"),xM=Xc(rg),SM=kc(),AM=Xc([kS]),CM=kc(),yM((IM=PM=function(t){function e(){var e;return(e=t.call(this)||this)._deferredLitsBufs=null,e._maxDeferredLights=dp.LIGHTS_PER_PASS,e._lightMeterScale=1e4,e._descriptorSet=null,e._renderArea=new $i,e._uiPhase=void 0,at(e,"_deferredMaterial",EM,it(e)),at(e,"renderQueues",wM,it(e)),e._phaseID=Iv("default"),e._renderQueues=[],e._uiPhase=new JA,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.gatherLights=function(t){for(var e=this._pipeline,n=e.commandBuffers[0],i=t.scene.sphereLights,r=t.scene.spotLights,o=aa.create(0,0,0,1),a=new Float32Array(4),s=t.exposure,c=0,l=Qn.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(aa.set(o,_.position.x,_.position.y,_.position.z,_.range),us.sphereFrustum(o,t.frustum)){if(Pn.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),Pn.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}e.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var d=0;d<r.length&&c<this._maxDeferredLights;d++,++c){var p=r[d];if(aa.set(o,p.position.x,p.position.y,p.position.z,p.range),us.sphereFrustum(o,t.frustum)){if(Pn.toArray(a,p.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),Pn.toArray(a,p.color),p.useColorTemperature){var m=p.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}e.pipelineSceneData.isHDR?a[3]=p.luminance*s*this._lightMeterScale:a[3]=p.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=p.size,a[1]=p.range,a[2]=p.spotAngle,this._lightBufferData.set(a,c*l+2*u),Pn.toArray(a,p.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._uiPhase.activate(e);for(var i=e.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=jS(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,o,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new _r(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new kr(kd.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new Gr(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(fp.BINDING,a),this._planarQueue=new KA(this._pipeline),this._deferredMaterial&&(e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var t;null===(t=this._deferredLitsBufs)||void 0===t||t.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(t){var e=this._pipeline,n=e.device,i=e.commandBuffers[0],r=e.pipelineSceneData,o=r.renderObjects;this.gatherLights(t),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(t,i),i.bindDescriptorSet(jd.LOCAL,this._descriptorSet,[0]),e.generateRenderArea(t,this._renderArea),t.clearFlag&Xi.COLOR&&(qM[0].x=t.clearColor.x,qM[0].y=t.clearColor.y,qM[0].z=t.clearColor.z),qM[0].w=0;var a=e.getPipelineRenderData(),s=a.outputFrameBuffer,c=s.renderPass;e.pipelineUBO.updateShadowUBO(t),i.beginRenderPass(c,s,this._renderArea,qM,t.clearDepth,t.clearStencil),i.setScissor(e.generateScissor(t)),i.setViewport(e.generateViewport(t)),i.bindDescriptorSet(jd.GLOBAL,e.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<3;++h)l.descriptorSet.bindTexture(h,a.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,a.sampler);l.descriptorSet.bindTexture(3,a.outputDepth),l.descriptorSet.bindSampler(3,a.sampler),l.descriptorSet.update(),i.bindDescriptorSet(jd.MATERIAL,l.descriptorSet);var _=e.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=_&&(f=Lv.getOrCreatePipelineState(n,l,u,c,_)),null!=f&&(i.bindPipelineState(f),i.bindInputAssembler(_),i.draw(_)),this._renderQueues.forEach(WS);for(var d=0,p=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(d=0;d<y.length;++d){var x=y[d].passes;for(p=0;p<x.length;++p)if(x[p].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,d,p)}}if(o.length>0){this._renderQueues.forEach(qS);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(t,c),i.endRenderPass()},e}(Ly),PM.initInfo={name:"LightingStage",priority:Qy.LIGHTING,tag:0},EM=st((TM=IM).prototype,"_deferredMaterial",[xM,yc,SM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wM=st(TM.prototype,"renderQueues",[AM,yc,CM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bM=TM))||bM)),YM=[new sr(0,0,0,1)],KM=t("PostProcessStage",(RM=fc("PostProcessStage"),DM=Xc(rg),MM=kc(),BM=Xc([kS]),OM=kc(),RM((kM=VM=function(t){function e(){var e;return at(e=t.call(this)||this,"_postProcessMaterial",FM,it(e)),at(e,"renderQueues",zM,it(e)),e._renderArea=new $i,e._uiPhase=new JA,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._postProcessMaterial&&(e.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(e)},n.destroy=function(){},n.render=function(t){var e=this._pipeline,n=e.device,i=e.pipelineSceneData,r=e.commandBuffers[0];e.pipelineUBO.updateCameraUBO(t);var o=t.viewport;this._renderArea.x=o.x*t.window.width,this._renderArea.y=o.y*t.window.height,this._renderArea.width=o.width*t.window.width,this._renderArea.height=o.height*t.window.height;var a=e.getPipelineRenderData(),s=t.window.framebuffer,c=e.getRenderPass(t.clearFlag,s);t.clearFlag&Xi.COLOR&&(YM[0].x=t.clearColor.x,YM[0].y=t.clearColor.y,YM[0].z=t.clearColor.z),YM[0].w=t.clearColor.w,r.beginRenderPass(c,s,this._renderArea,YM,t.clearDepth,t.clearStencil),r.bindDescriptorSet(jd.GLOBAL,e.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();e.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update(),r.bindDescriptorSet(jd.MATERIAL,l.descriptorSet);var h=t.window.swapchain?e.quadIAOnscreen:e.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=Lv.getOrCreatePipelineState(n,l,u,c,h));var f=e.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(r.bindPipelineState(_),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(t,c),Qv(n,c,r,e.profiler,t),r.endRenderPass()},e}(Ly),VM.initInfo={name:"PostProcessStage",priority:Yy.POST_PROCESS,tag:0},FM=st((LM=kM).prototype,"_postProcessMaterial",[DM,yc,MM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zM=st(LM.prototype,"renderQueues",[BM,yc,OM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NM=LM))||NM));!function(t){t[t.NONE=0]="NONE",t[t.FXAA=1]="FXAA"}(GM||(GM={}));var JM,QM,ZM,$M,tB,eB,nB,iB,rB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._antiAliasing=GM.NONE,e}Q(e,t);var n=e.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var t=this._bloomMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently();for(var e=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),e.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var t=this.postprocessMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var t=new rg;t._uuid="builtin-deferred-material",t.initialize({effectName:"deferred-lighting"});for(var e=0;e<t.passes.length;++e)t.passes[e].tryCompile();this._deferredLightingMaterial=t;var n=new rg;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new rg;r._uuid="builtin-post-process-material",ue.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=GM.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(e,n){return t.prototype.activate.call(this,e,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var t=this._deferredLightingMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},K(e,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(t){if(this._antiAliasing=t,this._postprocessMaterial){var e=this._postprocessMaterial.passes[0].defines;Object.assign(e,{ANTIALIAS_TYPE:t});var n=new rg;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:e});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(t){this._bloomMaterial!==t&&t&&(this._bloomMaterial=t,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(t){this._postprocessMaterial!==t&&t&&(this._postprocessMaterial=t,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(t){this._deferredLightingMaterial!==t&&t&&(this._deferredLightingMaterial=t,this.updatePipelinePassInfo())}}]),e}(UM),oB=[new sr(0,0,0,1)],aB=function(){};aB.SIZE=4*(aB.COUNT=4+(aB.TEXTURE_SIZE_OFFSET=0));var sB,cB,lB,uB,hB,_B,fB,dB,pB,mB,vB=t("BloomStage",(JM=fc("BloomStage"),QM=Xc(rg),ZM=kc(),JM((iB=nB=function(t){function e(){var e;return(e=t.call(this)||this).threshold=1,e.intensity=.8,e.iterations=2,at(e,"_bloomMaterial",eB,it(e)),e._renderArea=new $i,e._bloomUBO=[],e}Q(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._bloomMaterial&&(e.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(t){var e,n=this._pipeline;if(n.generateBloomRenderData(),((null===(e=t.window)||void 0===e?void 0:e.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,aB.SIZE,aB.SIZE));t.clearFlag&Xi.COLOR&&(oB[0].x=t.clearColor.x,oB[0].y=t.clearColor.y,oB[0].z=t.clearColor.z),oB[0].w=t.clearColor.w,this._prefilterPass(t,n),this._downsamplePass(t,n),this._upsamplePass(t,n),this._combinePass(t,n)}},n._prefilterPass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial.passes[0],r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(aB.COUNT);a[aB.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,oB,0,0),n.bindDescriptorSet(jd.GLOBAL,e.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(jd.MATERIAL,i.descriptorSet);var s=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=Lv.getOrCreatePipelineState(e.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData().bloom,o=new Float32Array(aB.COUNT),a=0;a<this.iterations;++a){o[aB.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[aB.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,oB,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(jd.MATERIAL,s.descriptorSet);var l=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=Lv.getOrCreatePipelineState(e.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(t,e){var n=e.getPipelineRenderData().bloom;e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=e.commandBuffers[0],r=e.pipelineSceneData.bloomMaterial,o=new Float32Array(aB.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[aB.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[aB.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,oB,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(jd.MATERIAL,c.descriptorSet);var u=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=Lv.getOrCreatePipelineState(e.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(t,e){e.generateRenderArea(t,this._renderArea);var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(aB.COUNT);a[aB.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,oB,0,0),n.bindDescriptorSet(jd.GLOBAL,e.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(jd.MATERIAL,s.descriptorSet);var c=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=Lv.getOrCreatePipelineState(e.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},e}(Ly),nB.initInfo={name:"BloomStage",priority:Yy.BLOOM,tag:0},eB=st((tB=iB).prototype,"_bloomMaterial",[QM,yc,ZM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$M=tB))||$M)),gB=t("MainFlow",fc("MainFlow")((lB=cB=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new WM;n.initialize(WM.initInfo),this._stages.push(n);var i=new XM;i.initialize(XM.initInfo),this._stages.push(i);var r=new vB;r.initialize(vB.initInfo),this._stages.push(r);var o=new KM;o.initialize(KM.initInfo),this._stages.push(o)}return!0},n.activate=function(e){t.prototype.activate.call(this,e)},n.render=function(e){t.prototype.render.call(this,e)},n.destroy=function(){t.prototype.destroy.call(this)},e}(zy),cB.initInfo={name:Nd,priority:Zy.MAIN,stages:[]},sB=lB))||sB),yB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).gbufferFrameBuffer=null,e.gbufferRenderTargets=[],e}return Q(e,t),e}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),xB=t("DeferredPipeline",(uB=fc("DeferredPipeline"),hB=Xc([FS]),_B=kc(),uB((mB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gbufferRenderPass=null,e._lightingRenderPass=null,at(e,"renderTextures",pB,it(e)),e}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var n=new vC;n.initialize(vC.initInfo),this._flows.push(n);var i=new gB;i.initialize(gB.initInfo),this._flows.push(i)}return!0},n.activate=function(e){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new rB,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(D(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(t){var e=this.device;this._commandBuffers.push(e.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(Qd,n),this._descriptorSet.bindTexture(Qd,Pv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(ap,n),this._descriptorSet.bindTexture(ap,Pv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new rx;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new Dr;o.format=_i.RGBA16F,o.loadOp=Mi.CLEAR,o.storeOp=Bi.STORE;var a=new Dr;a.format=_i.RGBA16F,a.loadOp=Mi.CLEAR,a.storeOp=Bi.STORE;var s=new Dr;s.format=_i.RGBA16F,s.loadOp=Mi.CLEAR,s.storeOp=Bi.STORE;var c=new Mr;c.format=_i.DEPTH_STENCIL,c.depthLoadOp=Mi.CLEAR,c.depthStoreOp=Bi.STORE,c.stencilLoadOp=Mi.CLEAR,c.stencilStoreOp=Bi.STORE;var l=new Nr([o,a,s],c);this._gbufferRenderPass=e.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Dr;u.format=_i.RGBA8,u.loadOp=Mi.CLEAR,u.storeOp=Bi.STORE,u.endAccesses=[Oi.COLOR_ATTACHMENT_WRITE];var h=new Mr;h.format=_i.DEPTH_STENCIL,h.depthLoadOp=Mi.LOAD,h.depthStoreOp=Bi.DISCARD,h.stencilLoadOp=Mi.LOAD,h.stencilStoreOp=Bi.DISCARD,h.beginAccesses=[Oi.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Oi.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new Nr([u],h);this._lightingRenderPass=e.createRenderPass(_)}return this._width=t.width,this._height=t.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Yd.BINDING).destroy(),this._descriptorSet.getBuffer(Jd.BINDING).destroy(),this._descriptorSet.getBuffer(Kd.BINDING).destroy(),this._descriptorSet.getTexture(Qd).destroy(),this._descriptorSet.getTexture(ap).destroy())},n._destroyDeferredData=function(){var t=this._pipelineRenderData;if(t){t.gbufferFrameBuffer&&t.gbufferFrameBuffer.destroy(),t.outputFrameBuffer&&t.outputFrameBuffer.destroy(),t.outputDepth&&t.outputDepth.destroy();for(var e=0;e<t.gbufferRenderTargets.length;e++)t.gbufferRenderTargets[e].destroy();t.gbufferRenderTargets.length=0;for(var n=0;n<t.outputRenderTargets.length;n++)t.outputRenderTargets[n].destroy();t.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(t){for(var e=this._width,n=this._height,i=0;i<t.length;++i){var r=t[i].window;e=Math.max(r.width,e),n=Math.max(r.height,n)}e===this._width&&n===this._height||(this._width=e,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var t=this,e=this.device,n=this._pipelineRenderData=new yB,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=e.createTexture(new mr(yi.TEX2D,xi.DEPTH_STENCIL_ATTACHMENT|xi.SAMPLED,_i.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=e.createFramebuffer(new zr(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(e.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=e.createFramebuffer(new zr(this._lightingRenderPass,n.outputRenderTargets,null)),this.on(Fy.ATTACHMENT_SCALE_CAHNGED,(function(e){n.sampler=e<1?t.globalDSManager.pointSampler:t.globalDSManager.linearSampler,t.applyFramebufferRatio(n.gbufferFrameBuffer),t.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler},e}(ox),pB=st((dB=mB).prototype,"renderTextures",[hB,yc,_B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fB=dB))||fB));function SB(){var t=new HM;return t.initialize({flows:[]}),t}var AB=new Xn,CB=function(){var t=e.prototype;function e(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return t.pauseRendering=function(){this.isPause=!0},t.resumeRendering=function(){this.isPause=!1},t.main=function(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){var e=this.settings=window._CCSettings.splashScreen;e.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,e.base64src=this.settings.base64src||"",e.effect=this.settings.effect||"FADE-INOUT",e.clearColor=this.settings.clearColor||new sr(.88,.88,.88,1),e.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,e.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new sr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{c.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?c.view.setDesignResolutionSize(n.width,n.height,n.policy):c.view.setDesignResolutionSize(960,640,4),this.device=t.device,this.swapchain=t.mainWindow.swapchain,this.framebuffer=t.mainWindow.framebuffer,c.game.once(c.Game.EVENT_GAME_INITED,(function(){c.director._lateUpdate=performance.now()}),c.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else x("RENDER ROOT IS NULL.")},t.setOnFinish=function(t){if(this._directCall&&t)return e._ins=void 0,void t();this.callBack=t},t._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),c.game.resume())},t.preInit=function(){var t=this.settings.clearColor;this.clearColors=[new sr(t.x,t.y,t.z,t.w)];var e=this.device,n=this.swapchain;this.renderArea=new $i(0,0,n.width,n.height),this.cmdBuff=e.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=e.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=e.createBuffer(new hr(pi.INDEX|pi.TRANSFER_DST,gi.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new Pr("a_position",_i.RG32F),new Pr("a_texCoord",_i.RG32F)],u=new Rr(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(u),this.projection=new Hn,Hn.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,n.surfaceTransform)},t.init=function(){var t=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),c.game.pause(),this.handle=requestAnimationFrame((function e(n){if(!t.cancelAnimate){var i=t.settings,r=t.device,o=t.swapchain;Hn.ortho(t.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;t.startTime<0&&(t.startTime=n);var l=n-t.startTime,u=h_(cn(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=t.logoTexture.width,_=t.logoTexture.height,f=c*i.displayRatio,d=f*h/_,p=f;if(o.surfaceTransform!==ui.ROTATE_90&&o.surfaceTransform!==ui.ROTATE_270||(d=f*a/s,p=f*_/h*s/a),t.logoMat.setProperty("resolution",AB.set(a,s),0),t.logoMat.setProperty("scale",AB.set(d,p),0),t.logoMat.setProperty("translate",AB.set(.5*a,.5*s),0),t.logoMat.setProperty("percent",u),t.logoMat.setProperty("u_projection",t.projection),t.logoMat.passes[0].update(),i.displayWatermark&&t.watermarkMat){var m=.5*c,v=t.watermarkTexture.width,g=m,y=m*t.watermarkTexture.height/v;o.surfaceTransform!==ui.ROTATE_90&&o.surfaceTransform!==ui.ROTATE_270||(g=.5*m,y=m*a/s*.5),t.watermarkMat.setProperty("resolution",AB.set(a,s),0),t.watermarkMat.setProperty("scale",AB.set(g,y),0),t.watermarkMat.setProperty("translate",AB.set(.5*a,.1*s),0),t.watermarkMat.setProperty("percent",u),t.watermarkMat.setProperty("u_projection",t.projection),t.watermarkMat.passes[0].update()}t.isPause||(t.frame(),l>i.totalTime&&(t.splashFinish=!0)),requestAnimationFrame(e)}}))},t.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},t.initLogo=function(){var t=this.device;this.logoMat=new rg,this.logoMat.initialize({effectName:"splash-screen"});var e=new gr;e.addressU=Ti.CLAMP,e.addressV=Ti.CLAMP,e.addressW=Ti.CLAMP,this.sampler=t.getSampler(e),this.logoTexture=t.createTexture(new mr(yi.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,_i.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new or;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},t.initWarterMark=function(){var t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=""+t.width,t.style.height=""+t.height;var e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=e.measureText(n);e.fillText(n,(330-i.width)/2,6);var r=new or;r.texExtent.width=t.width,r.texExtent.height=t.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new mr(yi.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,_i.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[r]),this.watermarkMat=new rg,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},t.frame=function(){var t=this.device,e=this.swapchain;t.acquire([e]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=e.width,r.height=e.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=Lv.getOrCreatePipelineState(t,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(jd.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=Lv.getOrCreatePipelineState(t,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(jd.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),t.flushCommands([n]),t.queue.submit([n]),t.present()},t.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,e._ins=void 0},K(e,[{key:"splashFinish",set:function(t){this._splashFinish=t,this._tryToStart()}},{key:"loadFinish",set:function(t){this._loadFinish=t,this._tryToStart()}}],[{key:"instance",get:function(){return e._ins||(e._ins=new e),e._ins}}]),e}();CB._ins=void 0,c.internal.SplashScreen=CB;var bB=t("System",function(){function t(){this._id="",this._priority=0,this._executeInEditMode=!1}t.sortByPriority=function(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0};var e=t.prototype;return e.init=function(){},e.update=function(){},e.postUpdate=function(){},K(t,[{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"id",get:function(){return this._id},set:function(t){this._id=t}}]),t}());bB.Priority=oe({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var TB=new pt("Scheduler"),EB=function(t,e,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=n,this.markedForDeletion=i};EB.get=function(t,e,n,i){var r=EB._listEntries.pop();return r?(r.target=t,r.priority=e,r.paused=n,r.markedForDeletion=i):r=new EB(t,e,n,i),r},EB.put=function(t){EB._listEntries.length<20&&(t.target=null,EB._listEntries.push(t))},EB._listEntries=[];var wB=function(t,e,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=n,this.callback=i};wB.get=function(t,e,n,i){var r=wB._hashUpdateEntries.pop();return r?(r.list=t,r.entry=e,r.target=n,r.callback=i):r=new wB(t,e,n,i),r},wB.put=function(t){wB._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,wB._hashUpdateEntries.push(t))},wB._hashUpdateEntries=[];var PB=function(t,e,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};PB.get=function(t,e,n,i,r,o){var a=PB._hashTimerEntries.pop();return a?(a.timers=t,a.target=e,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new PB(t,e,n,i,r,o),a},PB.put=function(t){PB._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,PB._hashTimerEntries.push(t))},PB._hashTimerEntries=[];var IB=function(){function t(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var e=t.prototype;return e.initWithCallback=function(t,e,n,i,r,o){return this._lock=!1,this._scheduler=t,this._target=n,this._callback=e,this._elapsed=-1,this._interval=i,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===c.macro.REPEAT_FOREVER,!0},e.getInterval=function(){return this._interval},e.setInterval=function(t){this._interval=t},e.update=function(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},e.getCallback=function(){return this._callback},e.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},e.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},t}();IB._timers=[],IB.get=function(){return IB._timers.pop()||new IB},IB.put=function(t){IB._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,IB._timers.push(t))};var RB,DB=t("Scheduler",function(t){function e(){var e;return(e=t.call(this)||this)._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=wt(!0),e._hashForTimers=wt(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}Q(e,t),e.enableForTarget=function(t){var e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?I(1513):t.id=TB.getNewId())};var n=e.prototype;return n.setTimeScale=function(t){this._timeScale=t},n.getTimeScale=function(){return this._timeScale},n.update=function(t){var e,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,i=(n=this._updatesNegList).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,i=(n=this._updates0List).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,i=(n=this._updatesPosList).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);var a=this._arrayForTimers;for(e=0;e<a.length;e++){if(o=a[e],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(t),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,n=this._updatesNegList;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,n=this._updates0List;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,n=this._updatesPosList;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(t,e,n,i,r,o){if("function"!=typeof t){var a=t;t=e,e=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!i,i=c.macro.REPEAT_FOREVER,r=0),O(e,1502);var s=e.uuid||e.id;if(s){var l,u,h=this._hashForTimers[s];if(h?h.paused!==o&&I(1511):(h=PB.get(null,e,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[s]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((l=h.timers[u])&&t===l._callback)return w(1507,l.getInterval(),n),void(l._interval=n);(l=IB.get()).initWithCallback(this,t,e,n,i,r),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else D(1510)},n.scheduleUpdate=function(t,e,n){var i=t.uuid||t.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===e)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return w(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(t)}var o,a=EB.get(t,e,n,!1);0===e?(o=this._updates0List,this._appendIn(o,a)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,e)),this._hashForUpdates[i]=wB.get(o,a,t,null)}else D(1510)},n.unschedule=function(t,e){if(e&&t){var n=e.uuid||e.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(t===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),IB.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else D(1510)}},n.unscheduleUpdate=function(t){if(t){var e=t.uuid||t.id;if(e){var n=this._hashForUpdates[e];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else D(1510)}},n.unscheduleAllForTarget=function(t){if(t){var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)IB.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(t)}else D(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(bB.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(t){var e,n,i,r=this._arrayForTimers;for(e=r.length-1;e>=0;e--)n=r[e],this.unscheduleAllForTarget(n.target);var o=0;if(t<0)for(e=0;e<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[e])&&i.priority>=t&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[e])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[e])&&i.priority>=t&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&e++},n.isScheduled=function(t,e){O(t,1508),O(e,1509);var n=e.uuid||e.id;if(!n)return D(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(t===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(bB.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(t){var e,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(e=a[n])&&(e.paused=!0,o.push(e.target));if(t<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=t&&(r.paused=!0,o.push(r.target));if(t<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=t&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)this.resumeTarget(t[e])},n.pauseTarget=function(t){O(t,1503);var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];n&&(n.paused=!0);var i=this._hashForUpdates[e];i&&(i.entry.paused=!0)}else D(1510)},n.resumeTarget=function(t){O(t,1504);var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];n&&(n.paused=!1);var i=this._hashForUpdates[e];i&&(i.entry.paused=!1)}else D(1510)},n.isTargetPaused=function(t){O(t,1505);var e=t.uuid||t.id;if(!e)return D(1510),!1;var n=this._hashForTimers[e];if(n)return n.paused;var i=this._hashForUpdates[e];return!!i&&i.entry.paused},n._removeHashElement=function(t){var e=t.target.uuid||t.target.id;delete this._hashForTimers[e];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===t){n.splice(i,1);break}PB.put(t)},n._removeUpdateFromHash=function(t){var e=t.target.uuid||t.target.id,n=this._hashForUpdates[e];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[e],EB.put(r),wB.put(n)}},n._priorityIn=function(t,e,n){for(var i=0;i<t.length;i++)if(n<t[i].priority)return void t.splice(i,0,e);t.push(e)},n._appendIn=function(t,e){t.push(e)},e}(bB));DB.ID="scheduler",c.Scheduler=DB;var MB=((RB={})[$u.PORTRAIT]=ui.IDENTITY,RB[$u.LANDSCAPE_RIGHT]=ui.ROTATE_90,RB[$u.PORTRAIT_UPSIDE_DOWN]=ui.ROTATE_180,RB[$u.LANDSCAPE_LEFT]=ui.ROTATE_270,RB),BB=function(){function t(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}t.registerCreateFunc=function(e){e._createWindowFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t,e){if(this._init(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchain&&(this._swapchain=e.swapchain),this._width=e.width,this._height=e.height,this._renderPass=t.createRenderPass(e.renderPassInfo),e.swapchain)this._setSwapchain(e.swapchain),this._colorTextures.push(e.swapchain.colorTexture),this._depthStencilTexture=e.swapchain.depthStencilTexture;else{for(var n=0;n<e.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(t.createTexture(new mr(yi.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED|xi.TRANSFER_SRC,e.renderPassInfo.colorAttachments[n].format,this._width,this._height)));e.renderPassInfo.depthStencilAttachment.format!==_i.UNKNOWN&&(this._depthStencilTexture=t.createTexture(new mr(yi.TEX2D,xi.DEPTH_STENCIL_ATTACHMENT|xi.SAMPLED,e.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(t.createFramebuffer(new zr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},e.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var t=0;t<this._colorTextures.length;t++){var e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._destroy()},e.resize=function(t,e){if(this._swapchain)this._swapchain.resize(t,e,MB[rh.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(t,e);this._depthStencilTexture&&this._depthStencilTexture.resize(t,e),this._width=t,this._height=e}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new zr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=ot(this._cameras);!(i=r()).done;)i.value.resize(t,e)},e.extractRenderCameras=function(t){for(var e=0;e<this._cameras.length;e++){var n=this._cameras[e];n.enabled&&(n.update(),t.push(n))}},e.attachCamera=function(t){for(var e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()},e.detachCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)},e.clearCameras=function(){this._cameras.length=0},e.sortCameras=function(){this._cameras.sort((function(t,e){return t.priority-e.priority}))},e._init=function(){},e._destroy=function(){},e._setSwapchain=function(t){this._swapchain=t},e._setFrameBuffer=function(t){this._framebuffer=t},K(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),t}(),OB=function(){var t=e.prototype;function e(t){var e=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=t,this._dataPoolMgr=c.internal.DataPoolManager&&new c.internal.DataPoolManager(t),oA.registerCreateFunc(this),BB.registerCreateFunc(this),this._cameraPool=new Ul((function(){return new fg(e._device)}),4,(function(t){return t.destroy()}))}return t._init=function(){},t._destroy=function(){},t._setCumulativeTime=function(t){this._cumulativeTime+=t},t._setFrameTime=function(t){this._frameTime=t},t.initialize=function(){this._init();var t=c.game._swapchain,e=new Dr;e.format=t.colorTexture.format;var n=new Mr;n.format=t.depthStencilTexture.format,n.depthStoreOp=Bi.DISCARD,n.stencilStoreOp=Bi.DISCARD;var i=new Nr([e],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:t.width,height:t.height,renderPassInfo:i,swapchain:t}),this._curWindow=this._mainWindow,Promise.resolve(Pv.initBuiltinRes(this._device))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},t.resize=function(t,e){for(var n,i=ot(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(t,e)}},t.setRenderPipeline=function(t){t instanceof xB&&(this._useDeferredPipeline=!0);var e=!1;if(t||(t=SB(),e=!0),this._pipeline=t,this._useDeferredPipeline&&this.device.hasFeature(hi.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return e&&this._pipeline.destroy(),this._pipeline=null,!1;var n=c.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&c.internal.Batcher2D&&(this._batcher=new c.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},t.activeWindow=function(t){this._curWindow=t},t.resetCumulativeTime=function(){this._setCumulativeTime(0)},t.frameMove=function(t){this._setFrameTime(t),++this._frameCount,this._setCumulativeTime(t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();for(var n=this._windows,i=[],r=0;r<n.length;r++)n[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([c.game._swapchain]);var o=this._scenes,a=c.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<o.length;s++)o[s].update(a);c.director.emit(c.Director.EVENT_BEFORE_COMMIT),i.sort((function(t,e){return t.priority-e.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(t){var e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e},t.destroyWindow=function(t){for(var e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)},t.destroyWindows=function(){for(var t,e=ot(this._windows);!(t=e()).done;)t.value.destroy();this._windows.length=0},t.createScene=function(t){var e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e},t.destroyScene=function(t){for(var e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)},t.destroyScenes=function(){for(var t,e=ot(this._scenes);!(t=e()).done;)t.value.destroy();this._scenes.length=0},t.createModel=function(t){var e=this._modelPools.get(t);e||(this._modelPools.set(t,new Ul((function(){return new t}),10,(function(t){return t.destroy()}))),e=this._modelPools.get(t));var n=e.alloc();return n.initialize(),n},t.destroyModel=function(t){var e=this._modelPools.get(t.constructor);e?(e.free(t),t.scene&&t.scene.removeModel(t)):I(1300,t.constructor.name),t.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(t){var e=this._lightPools.get(t);e||(this._lightPools.set(t,new Ul((function(){return new t}),4,(function(t){return t.destroy()}))),e=this._lightPools.get(t));var n=e.alloc();return n.initialize(),n},t.destroyLight=function(t){var e=this._lightPools.get(t.constructor);if(e&&(e.free(t),t.scene))switch(t.type){case ty.SPHERE:t.scene.removeSphereLight(t);break;case ty.SPOT:t.scene.removeSpotLight(t)}t.destroy()},K(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(t){this._curWindow=t}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(t){this._tempWindow=t}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}();c.Root=OB;var NB=t("Game",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).frame=null,e.container=null,e.canvas=null,e.renderType=-1,e.eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e.config={},e.onStart=null,e.frameTime=1e3/60,e.collisionMatrix=[],e.groupList=[],e._persistRootNodes={},e._gfxDevice=null,e._swapchain=null,e._configLoaded=!1,e._isCloning=!1,e._inited=!1,e._engineInited=!1,e._rendererInitialized=!1,e._paused=!0,e._frameRate=60,e._intervalId=0,e._initTime=0,e._startTime=0,e._deltaTime=0,e._onEngineInitedCallback=[],e}Q(e,t);var i=e.prototype;return i.setFrameRate=function(t){this.frameRate=t},i.getFrameRate=function(){return this.frameRate},i.step=function(){c.director.tick(this.frameTime/1e3)},i.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},i.resume=function(){this._paused&&(oD._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},i.isPaused=function(){return this._paused},i.restart=function(){var t=this;return new Promise((function(t){return c.director.once(c.Director.EVENT_END_FRAME,(function(){return t()}))})).then((function(){for(var n in t._persistRootNodes)t.removePersistRootNode(t._persistRootNodes[n]);return c.director.getScene().destroy(),c.Object._deferredDestroy(),c.director.reset(),c.profiler.reset(),t.pause(),t._setRenderPipelineNShowSplash().then((function(){t.resume(),t._safeEmit(e.EVENT_RESTART)}))}))},i.end=function(){fu.close()},i.on=function(t,n,i,r){return(this._engineInited&&t===e.EVENT_ENGINE_INITED||this._inited&&t===e.EVENT_GAME_INITED||this._rendererInitialized&&t===e.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(t,n,i,r)},i.once=function(t,n,i){return this._engineInited&&t===e.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(t,n,i)},i.init=function(t){var e=this;if(this._initConfig(t),ah._init({configOrientation:t.orientation||"auto",exactFitScreen:t.exactFitScreen}),this.config.assetOptions&&c.assetManager.init(this.config.assetOptions),this.config.layers)for(var i=this.config.layers,r=0;r<i.length;r++){var o=i[r],a=n(o.value);Md.addLayer(o.name,a)}return this._initEngine().then((function(){return e._initEvents(),c.director.root&&c.director.root.dataPoolManager&&c.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),e._engineInited}))},i.run=function(t,e){var n,i=this;return"function"!=typeof t&&t?(n=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,su.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},i.addPersistRootNode=function(t){if(c.Node.isNode(t)&&t.uuid){var e=t.uuid;if(!this._persistRootNodes[e]){var n=c.director._scene;if(c.isValid(n))if(t.parent){if(!(t.parent instanceof c.Scene))return void I(3801);if(t.parent!==n)return void I(3802);t._originalSceneId=n.uuid}else t.parent=n;this._persistRootNodes[e]=t,t._persistNode=!0,c.assetManager._releaseManager._addPersistNodeRef(t)}}else I(3800)},i.removePersistRootNode=function(t){var e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",c.assetManager._releaseManager._removePersistNodeRef(t))},i.isPersistRootNode=function(t){return!!t._persistNode},i.onEngineInitedAsync=function(t){this._onEngineInitedCallback.push(t)},i._initEngine=function(){var t=this;this._initDevice();var n=c.director;return Promise.resolve(n._init()).then((function(){c.view.init(),g("Cocos Creator v"+l),t.emit(e.EVENT_ENGINE_INITED),t._engineInited=!0,c.internal.dynamicAtlasManager&&(c.internal.dynamicAtlasManager.enabled=!ue.CLEANUP_IMAGE_CACHE)})).then((function(){var e=t._onEngineInitedCallback.map((function(t){return t()})).filter(Boolean);return t._onEngineInitedCallback.length=0,Promise.all(e)}))},i._setAnimFrame=function(){var t=this._frameRate,e=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==t&&30!==t?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=e||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},i._stTime=function(t){var e=performance.now(),n=Math.max(0,e-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(t,i)},i._ctTime=function(t){window.clearTimeout(t)},i._calculateDT=function(t){return t||(t=performance.now()),this._deltaTime=t>this._startTime?(t-this._startTime)/1e3:0,this._deltaTime>e.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=t,this._deltaTime},i._updateCallback=function(){var t,e=this,n=c.director;if(30===this._frameRate){var i=!0;t=function(t){e._intervalId=window.rAF(e._frameCB),(i=!i)||n.tick(e._calculateDT(t))}}else t=function(t){n.tick(e._calculateDT(t)),e._intervalId=window.rAF(e._frameCB)};this._frameCB=t},i._runMainLoop=function(){if(this._inited){var t=this.config,e=c.director;F(!!t.showFPS),e.startAnimation(),this.resume()}},i._initConfig=function(t){"number"!=typeof t.debugMode&&(t.debugMode=M.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);var e=t.renderMode;("number"!=typeof e||e>3||e<0)&&(t.renderMode=0),t.showFPS=!!t.showFPS,C(t.debugMode),this.config=t,this._configLoaded=!0,this.frameRate=t.frameRate},i._determineRenderType=function(){var t=this.config,n=parseInt(t.renderMode,10);this.renderType=e.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=e.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=e.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=e.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(N(3820,n))},i._initDevice=function(){if(!this._rendererInitialized){var t=this.config.adapter;if(t&&(this.canvas=t.canvas,this.frame=t.frame,this.container=t.container),this._determineRenderType(),this.renderType===e.RENDER_TYPE_WEBGL){var n=new ur(Xd),i=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||sh.browserType===eu.UC)&&(i=!1);var o=[];i&&c.WebGL2Device&&o.push(c.WebGL2Device),c.WebGLDevice&&o.push(c.WebGLDevice),c.EmptyDevice&&o.push(c.EmptyDevice),ho.canvas=this.canvas;for(var a=0;a<o.length&&(this._gfxDevice=new o[a],!this._gfxDevice.initialize(n));a++);}else this.renderType===e.RENDER_TYPE_HEADLESS&&c.EmptyDevice&&(this._gfxDevice=new c.EmptyDevice,this._gfxDevice.initialize(new ur(Xd)));if(!this._gfxDevice)return x("can not support canvas rendering in 3D"),void(this.renderType=e.RENDER_TYPE_CANVAS);var s=new lr(this.canvas),l=ah.windowSize;s.width=l.width,s.height=l.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}},i._initEvents=function(){fu.on("show",this._onShow,this),fu.on("hide",this._onHide,this)},i._onHide=function(){this.emit(e.EVENT_HIDE),this.pause()},i._onShow=function(){this.emit(e.EVENT_SHOW),this.resume()},i._setRenderPipelineNShowSplash=function(){var t=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(t._showSplashScreen()).then((function(){t._inited=!0,t._initTime=performance.now(),t._runMainLoop(),t._safeEmit(e.EVENT_GAME_INITED),t.onStart&&t.onStart()}))}))},i._setupRenderPipeline=function(){var t=this,e=this.config.renderPipeline;return e?new Promise((function(t,n){c.assetManager.loadAny(e,(function(e,i){return!e&&i instanceof ox?t(i):n(e)}))})).then((function(e){t._setRenderPipeline(e)})).catch((function(n){y(n),y("Failed load render pipeline: "+e+", engine failed to initialize, will fallback to default pipeline"),t._setRenderPipeline()})):this._setRenderPipeline()},i._showSplashScreen=function(){if(c.internal.SplashScreen){var t=c.internal.SplashScreen.instance;return t.main(c.director.root),new Promise((function(e){t.setOnFinish((function(){return e()})),t.loadFinish=!0}))}return null},i._setRenderPipeline=function(t){c.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(e.EVENT_RENDERER_INITED)},i._safeEmit=function(t){this.emit(t)},K(e,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(t){"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),this._frameRate=t,this.frameTime=1e3/t,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),e}($l));NB.EVENT_HIDE="game_on_hide",NB.EVENT_SHOW="game_on_show",NB.EVENT_LOW_MEMORY="game_on_low_memory",NB.EVENT_GAME_INITED="game_inited",NB.EVENT_ENGINE_INITED="engine_inited",NB.EVENT_RENDERER_INITED="renderer_inited",NB.EVENT_RESTART="game_on_restart",NB.RENDER_TYPE_CANVAS=0,NB.RENDER_TYPE_WEBGL=1,NB.RENDER_TYPE_OPENGL=2,NB.RENDER_TYPE_HEADLESS=3,NB.DEBUG_DT_THRESHOLD=1,c.Game=NB;var LB=t("game",c.game=new NB),FB=t("Director",function(t){function e(){var e;return(e=t.call(this)||this)._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._scheduler=new DB,e._compScheduler=new MD,e._nodeActivator=new JD,e._systems=[],LB.once(NB.EVENT_RENDERER_INITED,e._initOnRendererInitialized,it(e)),e}Q(e,t);var n=e.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var t=this;this.once(e.EVENT_END_FRAME,(function(){t.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),c.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),c.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(e.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(t,e,n){t instanceof QD&&(t=t.scene),O(t instanceof mD,1216),t._load();for(var i=Object.keys(LB._persistRootNodes).map((function(t){return LB._persistRootNodes[t]})),r=0;r<i.length;r++){var o=i[r];o.emit(c.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);var a=t.uuid===o._originalSceneId&&t.getChildByUuid(o.uuid);if(a){var s=a.getSiblingIndex();a._destroyImmediate(),t.insertChild(o,s)}else o.parent=t}var l=this._scene;c.isValid(l)&&l.destroy(),c.assetManager._releaseManager._autoRelease(l,t,LB._persistRootNodes),this._scene=null,_l._deferredDestroy(),e&&e(),this.emit(c.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,t),this.emit(c.Director.EVENT_AFTER_SCENE_LAUNCH,t)},n.runScene=function(t,e,n){var i=this;t instanceof QD&&(t=t.scene),O(t,1205),O(t instanceof mD,1216),t._load(),this.once(c.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(t,e,n)}))},n.loadScene=function(t,e,n){var i=this;if(this._loadingScene)return I(1208,t,this._loadingScene),!1;var r=c.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));return r?(this.emit(c.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time("LoadScene "+t),r.loadScene(t,(function(r,o){console.timeEnd("LoadScene "+t),i._loadingScene="",r?(x(r),e&&e(r)):i.runSceneImmediate(o,n,e)})),!0):(D(1209,t),!1)},n.preloadScene=function(t,e,n){var i=c.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));if(i)i.preloadScene(t,null,e,n);else{var r='Can not preload the scene "'+t+'" because it is not in the build settings.';n&&n(new Error(r)),x("preloadScene: "+r)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return LB.deltaTime},n.getTotalTime=function(){return LB.totalTime},n.getCurrentTime=function(){return LB.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(DB.ID,t,200))},n.registerSystem=function(t,e,n){e.id=t,e.priority=n,e.init(),this._systems.push(e),this._systems.sort(bB.sortByPriority)},n.unregisterSystem=function(t){ee.fastRemove(this._systems,t),this._systems.sort(bB.sortByPriority)},n.getSystem=function(t){return this._systems.find((function(e){return e.id===t}))},n.getAnimationManager=function(){return this.getSystem(c.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(t){var e;e=LB._calculateDT(t),this.tick(e)},n.tick=function(t){if(!this._invalid){if(this.emit(e.EVENT_BEGIN_FRAME),oD._frameDispatchEvents(),!this._paused){this.emit(e.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var n=0;n<this._systems.length;++n)this._systems[n].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(e.EVENT_AFTER_UPDATE),_l._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(t)}this.emit(e.EVENT_BEFORE_DRAW),this._root.frameMove(t),this.emit(e.EVENT_AFTER_DRAW),kT.resetHasChangedFlags(),kT.clearNodeArray(),kl.update(t),this.emit(e.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(DB.ID,this._scheduler,200),this.emit(e.EVENT_INIT)},n._init=function(){return this._root=new OB(LB._gfxDevice),this._root.initialize({}).catch((function(t){return D(1217),Promise.reject(t)}))},K(e,[{key:"root",get:function(){return this._root}}]),e}($l));FB.EVENT_INIT="director_init",FB.EVENT_RESET="director_reset",FB.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",FB.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",FB.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",FB.EVENT_BEFORE_UPDATE="director_before_update",FB.EVENT_AFTER_UPDATE="director_after_update",FB.EVENT_BEFORE_DRAW="director_before_draw",FB.EVENT_AFTER_DRAW="director_after_draw",FB.EVENT_BEFORE_COMMIT="director_before_commit",FB.EVENT_BEFORE_PHYSICS="director_before_physics",FB.EVENT_AFTER_PHYSICS="director_after_physics",FB.EVENT_BEGIN_FRAME="director_begin_frame",FB.EVENT_END_FRAME="director_end_frame",FB.instance=void 0,c.Director=FB;var zB=t("director",FB.instance=c.director=new FB),VB={};z(VB,"vmath",[{name:"vec2",newName:"Vec2",target:ai,targetName:"math"},{name:"vec3",newName:"Vec3",target:ai,targetName:"math"},{name:"vec4",newName:"Vec4",target:ai,targetName:"math"},{name:"quat",newName:"Quat",target:ai,targetName:"math"},{name:"mat3",newName:"Mat3",target:ai,targetName:"math"},{name:"mat4",newName:"Mat4",target:ai,targetName:"math"},{name:"color4",newName:"Color",target:ai,targetName:"math"},{name:"rect",newName:"Rect",target:ai,targetName:"math"},{name:"approx",newName:"approx",target:ai,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:ai,targetName:"math"},{name:"equals",newName:"equals",target:ai,targetName:"math"},{name:"clamp",newName:"clamp",target:ai,targetName:"math"},{name:"clamp01",newName:"clamp01",target:ai,targetName:"math"},{name:"lerp",newName:"lerp",target:ai,targetName:"math"},{name:"toRadian",newName:"toRadian",target:ai,targetName:"math"},{name:"toDegree",newName:"toDegree",target:ai,targetName:"math"},{name:"random",newName:"random",target:ai,targetName:"math"},{name:"randomRange",newName:"randomRange",target:ai,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:ai,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:ai,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:ai,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:ai,targetName:"math"},{name:"repeat",newName:"repeat",target:ai,targetName:"math"},{name:"pingPong",newName:"pingPong",target:ai,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:ai,targetName:"math"}]),c.vmath=VB,z(DB.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:DB,targetName:"Scheduler"}]),z(DB,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return bB.Priority.SCHEDULER}}]),V(DB,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),z($S.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),V($S.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),z(OB.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),k(LB,"game",[{name:"collisionMatrix"},{name:"groupList"}]),k(FB.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),V(FB.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var kB,GB={topLeft:c.v2(0,0),topRight:c.v2(0,0),top:c.v2(0,0),bottomLeft:c.v2(0,0),bottomRight:c.v2(0,0),bottom:c.v2(0,0),center:c.v2(0,0),left:c.v2(0,0),right:c.v2(0,0),width:0,height:0,init:function(t){var e=this.width=t.width,n=this.height=t.height,i=t.x,r=t.y,o=r+n,a=i+e;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+e/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+e/2,this.bottom.y=r,this.center.x=i+e/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};c.visibleRect=GB;var UB=new ti,HB=((kB={})[ue.ORIENTATION_AUTO]=$u.AUTO,kB[ue.ORIENTATION_LANDSCAPE]=$u.LANDSCAPE,kB[ue.ORIENTATION_PORTRAIT]=$u.PORTRAIT,kB),jB=t("View",function(t){function e(){var e;(e=t.call(this)||this)._designResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;var n=WB,i=qB;return e._designResolutionSize=new ti(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new ni(0,0,0,0),e._visibleRect=new ni(0,0,0,0),e._autoFullScreen=!1,e._retinaEnabled=!1,e._resizeCallback=null,e._rpExactFit=new XB(n.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new XB(n.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new XB(n.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new XB(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new XB(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,e}Q(e,t);var n=e.prototype;return n.init=function(){var t=ah.windowSize,e=t.width,n=t.height;this._designResolutionSize.width=e,this._designResolutionSize.height=n,this._viewportRect.width=e,this._viewportRect.height=n,this._visibleRect.width=e,this._visibleRect.height=n,UB.width=this._visibleRect.width,UB.height=this._visibleRect.height,GB&&GB.init(this._visibleRect),rh.on("window-resize",this._updateAdaptResult,this),rh.on("orientation-change",this._updateAdaptResult,this),rh.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(t){rh.handleResizeEvent=t},n.setResizeCallback=function(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)},n.setOrientation=function(t){rh.orientation=HB[t]},n.adjustViewportMeta=function(){},n.enableRetina=function(t){this._retinaEnabled=!!t},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(t){t!==this._autoFullScreen&&(this._autoFullScreen=t,t&&ah.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(t,e){rh.resolutionScale=1;var n=rh.devicePixelRatio,i=new ti(t*n,e*n);ah.windowSize=i},n.getCanvasSize=function(){return ah.windowSize},n.getFrameSize=function(){var t=rh.devicePixelRatio,e=ah.windowSize;return e.width/=t,e.height/=t,e},n.setFrameSize=function(t,e){var n=rh.devicePixelRatio;ah.windowSize=new ti(t*n,e*n)},n.getVisibleSize=function(){return new ti(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new ti(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Xn(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Xn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(t){if(t instanceof XB)this._resolutionPolicy=t;else{var e=XB;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(t){this._updateResolutionPolicy(t);var e=YB.getDesignResolutionSize();YB.setDesignResolutionSize(e.width,e.height,t)},n.setDesignResolutionSize=function(t,e,n){if(t>0&&e>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=t,this._designResolutionSize.height=e;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),UB.width=this._visibleRect.width,UB.height=this._visibleRect.height,GB&&GB.init(this._visibleRect),this.emit("design-resolution-changed")}else D(2200)},n.getDesignResolutionSize=function(){return new ti(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(t,e,n){document.documentElement.style.width=t+"px",document.body.style.width=t+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(t,e,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return rh.devicePixelRatio},n.convertToLocationInView=function(t,e,n,i){void 0===i&&(i=new Xn);var r=rh.devicePixelRatio*(t-n.left),o=rh.devicePixelRatio*(n.top+n.height-e);return rh.isFrameRotated?(i.x=ah.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(t){var e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY},n._updateAdaptResult=function(){var t;c.director.root.resize(ah.windowSize.width,ah.windowSize.height);var e=this._designResolutionSize.width,n=this._designResolutionSize.height;e>0&&this.setDesignResolutionSize(e,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(t=this._resizeCallback)||void 0===t||t.call(this)},e}($l));jB.instance=void 0;var WB=function(){function t(){this.name="ContainerStrategy"}var e=t.prototype;return e.preApply=function(){},e.apply=function(){},e.postApply=function(){},e._setupCanvas=function(){var t=LB.canvas;if(t){var e=ah.windowSize;t.width=e.width,t.height=e.height}},t}();WB.EQUAL_TO_FRAME=void 0,WB.PROPORTION_TO_FRAME=void 0;var qB=function(){function t(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var e=t.prototype;return e.preApply=function(){},e.apply=function(){return{scale:[1,1]}},e.postApply=function(){},e._buildResult=function(t,e,n,i,r,o){Math.abs(t-n)<2&&(n=t),Math.abs(e-i)<2&&(i=e);var a=new ni(Math.round((t-n)/2),Math.round((e-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},t}();qB.EXACT_FIT=void 0,qB.SHOW_ALL=void 0,qB.NO_BORDER=void 0,qB.FIXED_HEIGHT=void 0,qB.FIXED_WIDTH=void 0,function(){var t=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="EqualToFrame",e}return Q(e,t),e.prototype.apply=function(){rh.isProportionalToFrame=!1,this._setupCanvas()},e}(WB),e=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ProportionalToFrame",e}return Q(e,t),e.prototype.apply=function(){rh.isProportionalToFrame=!0,this._setupCanvas()},e}(WB);WB.EQUAL_TO_FRAME=new t,WB.PROPORTION_TO_FRAME=new e;var n=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ExactFit",e}return Q(e,t),e.prototype.apply=function(t,e){var n=ah.windowSize,i=n.width,r=n.height,o=i/e.width,a=r/e.height;return this._buildResult(i,r,i,r,o,a)},e}(qB),i=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ShowAll",e}return Q(e,t),e.prototype.apply=function(t,e){var n,i,r=ah.windowSize,o=r.width,a=r.height,s=e.width,c=e.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},e}(qB),r=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="NoBorder",e}return Q(e,t),e.prototype.apply=function(t,e){var n,i,r,o=ah.windowSize,a=o.width,s=o.height,c=e.width,l=e.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},e}(qB),o=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="FixedHeight",e}return Q(e,t),e.prototype.apply=function(t,e){var n=ah.windowSize,i=n.width,r=n.height,o=r/e.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},e}(qB),a=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="FixedWidth",e}return Q(e,t),e.prototype.apply=function(t,e){var n=ah.windowSize,i=n.width,r=n.height,o=i/e.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},e}(qB);qB.EXACT_FIT=new n,qB.SHOW_ALL=new i,qB.NO_BORDER=new r,qB.FIXED_HEIGHT=new o,qB.FIXED_WIDTH=new a}();var XB=t("ResolutionPolicy",function(){function t(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}var e=t.prototype;return e.preApply=function(t){this._contentStrategy.preApply(t)},e.apply=function(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)},e.postApply=function(t){this._contentStrategy.postApply(t)},e.setContainerStrategy=function(t){t instanceof WB&&(this._containerStrategy=t)},e.setContentStrategy=function(t){t instanceof qB&&(this._contentStrategy=t)},K(t,[{key:"canvasSize",get:function(){return ah.windowSize}}]),t}());XB.EXACT_FIT=0,XB.NO_BORDER=1,XB.SHOW_ALL=2,XB.FIXED_HEIGHT=3,XB.FIXED_WIDTH=4,XB.UNKNOWN=5,XB.ContainerStrategy=WB,XB.ContentStrategy=qB,c.ResolutionPolicy=XB;var YB=t("view",jB.instance=c.view=new jB);c.winSize=UB,V(jB.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),k(jB.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),k(c,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),k(sh,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),z(sh,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(t){return{name:"LANGUAGE_"+t,newName:t,target:sh.Language,targetName:"sys.Language"}}))),z(sh,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(t){return{name:"OS_"+t,newName:t,target:sh.OS,targetName:"sys.OS"}}))),z(sh,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(t){return{name:"BROWSER_TYPE_"+t,newName:t,target:sh.BrowserType,targetName:"sys.BrowserType"}}))),z(sh,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:sh.BrowserType,targetName:"sys.BrowserType"}]),z(sh,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(t){return{name:t,target:sh.Platform,targetName:"sys.Platform"}}))),z(sh,"sys",[{name:"IPHONE",newName:"IOS",target:sh.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:sh.Platform,targetName:"sys.Platform"}]),V(sh,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(t){return{name:t}}))),z(sh,"sys",[{name:"windowPixelResolution",target:ah,targetName:"screen",newName:"windowSize"}]),k(ah,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var KB=function(){function t(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new pl,this.scenes=new pl,this.paths=new pl}var e=t.prototype;return e.init=function(t){var e=this;!function(t){var e=t.uuids,n=t.paths,i=t.types,r=t.deps,o=t.paths=Object.create(null);if(!1===t.debug){for(var a=0,s=e.length;a<s;a++)e[a]=Ml(e[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=e.length;_<f;_++){var d=e[_];e[_]=h[d]=Ml(d)}e=h}for(var p in n){var m=n[p];o[e[p]]=m}var v=t.scenes;for(var g in v){var y=v[g];v[g]=e[y]}var x=t.packs;for(var S in x)for(var A=x[S],C=0;C<A.length;++C)A[C]=e[A[C]];var b=t.versions;if(b)for(var T in b)for(var E=b[T],w=0;w<E.length;w+=2){var P=E[w];E[w]=e[P]||P}var I=t.redirect;if(I)for(var R=0;R<I.length;R+=2)I[R]=e[I[R]],I[R+1]=r[I[R+1]];if(t.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,n))return"continue";t.extensionMap[n].forEach((function(i,r){t.extensionMap[n][r]=e[i]||i}))};for(var M in t.extensionMap)D(M)}}(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,n))return"continue";t.extensionMap[n].forEach((function(t){var i=e.assetInfos.get(t);i&&(i.extension=n)}))};for(var i in t.extensionMap)n(i)},e.getInfoWithPath=function(t,e){if(!t)return null;t=Fl(t);var n=this.paths.get(t);if(n){if(!e)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(ne.isChildClassOf(o.ctor,e))return o}}return null},e.getDirWithPath=function(t,e,n){"/"===(t=Fl(t))[t.length-1]&&(t=t.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(t)&&function(t,e){return!(t.length>e.length)||47===t.charCodeAt(e.length)}(r,t)||!t)for(var o=0,a=n.length;o<a;o++){var s=n[o];e&&!ne.isChildClassOf(s.ctor,e)||i.push(s)}})),i},e.getAssetInfo=function(t){return this.assetInfos.get(t)||null},e.getSceneInfo=function(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t="/"+t),this.scenes.find((function(e,n){return n.endsWith(t)}))},e.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},e._initUuid=function(t){if(t){this.assetInfos.clear();for(var e=0,n=t.length;e<n;e++){var i=t[e];this.assetInfos.add(i,{uuid:i})}}},e._initPath=function(t){if(t){var e=this.paths;for(var n in e.clear(),t){var i=t[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=ne._getClassById(o),e.has(r)?a?e.get(r).push(s):e.get(r).unshift(s):e.add(r,[s])}}},e._initScene=function(t){if(t){var e=this.scenes;e.clear();var n=this.assetInfos;for(var i in t){var r=t[i],o=n.get(r);o.url=i,e.add(i,o)}}},e._initPackage=function(t){if(t){var e=this.assetInfos;for(var n in t){var i=t[n],r={uuid:n,packedUuids:i,ext:".json"};e.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=e.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},e._initVersion=function(t){if(t){var e=this.assetInfos,n=t.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];e.get(o).ver=n[i+1]}if(n=t.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];e.get(c).nativeVer=n[a+1]}}},e._initRedirect=function(t){if(t)for(var e=this.assetInfos,n=0,i=t.length;n<i;n+=2){var r=t[n];e.get(r).redirect=t[n+1]}},t}();function JB(t,e){t._uuid&&e.push(t._uuid)}function QB(t,e){for(var n=Object.getOwnPropertyNames(t),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=t[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Ru&&JB(s,e)}else if(o.constructor&&o.constructor!==Object)o instanceof Ru&&JB(o,e);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Ru&&JB(u,e)}}}}function ZB(t,e){for(var n=0;n<t._components.length;n++)QB(t._components[n],e);for(var i=0;i<t._children.length;i++)ZB(t._children[i],e)}function $B(t,e,n,i){n.push(t._uuid);for(var r=nv.getDeps(t._uuid),o=0,a=r.length;o<a;o++){var s=gl.get(r[o]);if(s){var c=s._uuid;c in e?e[c]+=i:e[c]=s.refCount+i,n.includes(c)||$B(s,e,n,i)}}}var tO=[],eO=new(function(){function t(){this._persistNodeDeps=new pl,this._toDelete=new pl,this._eventListener=!1}var e=t.prototype;return e.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},e._addPersistNodeRef=function(t){var e=[];ZB(t,e);for(var n=0,i=e.length;n<i;n++){var r=gl.get(e[n]);r&&r.addRef()}this._persistNodeDeps.add(t.uuid,e)},e._removePersistNodeRef=function(t){if(this._persistNodeDeps.has(t.uuid)){for(var e=this._persistNodeDeps.get(t.uuid),n=0,i=e.length;n<i;n++){var r=gl.get(e[n]);r&&r.decRef()}this._persistNodeDeps.remove(t.uuid)}},e._autoRelease=function(t,e,n){if(t){for(var i=nv.getDeps(t.uuid),r=0,o=i.length;r<o;r++){var a=gl.get(i[r]);a&&a.decRef(t.autoReleaseAssets)}var s=nv._depends.get(t.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=gl.get(c[l]);h&&h.decRef(t.autoReleaseAssets)}t.uuid!==e.uuid&&nv.remove(t.uuid)}var _=nv._depends.get(e.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var d,p,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=ot(v);!(p=g()).done;){var y=p.value,x=gl.get(y);x&&x.addRef()}_&&(d=_.persistDeps).push.apply(d,v)}},e.tryRelease=function(t,e){void 0===e&&(e=!1),t instanceof Ru&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,xe(this._freeAssets.bind(this)))))},e._freeAssets=function(){var t=this;this._eventListener=!1,this._toDelete.forEach((function(e){t._free(e)})),this._toDelete.clear()},e._free=function(t,e){void 0===e&&(e=!1);var n=t._uuid;if(this._toDelete.remove(n),dl(t,!0)&&!(!e&&t.refCount>0&&function(t){var e=Object.create(null);if(e[t._uuid]=t.refCount,$B(t,e,tO,-1),tO.length=0,0!==e[t._uuid])return e[t._uuid];for(var n in e)0!==e[n]&&$B(gl.get(n),e,tO,1);return tO.length=0,e[t._uuid]}(t)>0)){gl.remove(n);for(var i=nv.getDeps(n),r=0,o=i.length;r<o;r++){var a=gl.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}t.destroy(),nv.remove(n)}},t}()),nO=null;function iO(t,e){for(var n=0,i=t.input.length;n<i;n++){var r=t.input[n];e&&!r.isNative&&r.content instanceof Ru&&r.content.decRef(!1),r.recycle()}t.input=null}function rO(t,e){return e?/\?/.test(t)?t+"&_t="+Date.now():t+"?_t="+Date.now():t}function oO(t,e,n,i,r){void 0===r&&(r=0),t(r,(function(o,a){r++,!o||r>e?i&&i(o,a):setTimeout((function(){oO(t,e,n,i,r)}),n)}))}function aO(t,e,n,i,r){try{for(var o=nv.parse(t,e),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(J({},o.nativeDep)))}catch(t){x(t.message,t.stack)}}function sO(t,e,n){e&&(n=void 0!==n?n:c.assetManager.cacheAsset,Ll(e)||!n||e.isDefault||gl.add(t,e))}function cO(t,e,n){var i=0,r=[],o=t.length;0===o&&n&&n(r);for(var a=function(t){t&&r.push(t),++i===o&&n&&n(r)},s=0;s<o;s++)e(t[s],a)}function lO(t,e,n){var i=t,r=e,o=n;if(void 0===n){var a="function"==typeof t;e?(o=e,a||(r=null)):void 0===e&&a&&(o=t,i=null,r=null),void 0!==e&&a&&(r=t,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function uO(t,e,n){var i=t,r=e,o=n;if(void 0===n){var a=ne.isChildClassOf(t,Ru);e?(o=e,a&&(r=null)):void 0!==e||a||(o=t,r=null,i=null),void 0===e||a||(r=t,i=null)}return{type:i,onProgress:r||nO,onComplete:o}}function hO(t,e,n,i){if(void 0===i&&(i={}),!n[e]||i[e])return!1;i[e]=!0;var r=!1,o=nv.getDeps(e);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===t||hO(t,c,n,i)){r=!0;break}}return r}function _O(t){return function(e,n){if(t){var i=[];Array.isArray(n)?n.forEach((function(t){return t instanceof Ru&&i.push(t.addRef())})):n instanceof Ru&&i.push(n.addRef()),xe((function(){i.forEach((function(t){return t.decRef(!1)})),t(e,n)}))}}}var fO=function(){function t(){this._config=new KB}var e=t.prototype;return e.getInfoWithPath=function(t,e){return this._config.getInfoWithPath(t,e)},e.getDirWithPath=function(t,e,n){return this._config.getDirWithPath(t,e,n)},e.getAssetInfo=function(t){return this._config.getAssetInfo(t)},e.getSceneInfo=function(t){return this._config.getSceneInfo(t)},e.init=function(t){this._config.init(t),Sl.add(t.name,this)},e.load=function(t,e,n,i){var r=uO(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete,l={__requestType__:vl.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(t)};c.assetManager.loadAny(t,l,a,s)},e.preload=function(t,e,n,i){var r=uO(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;c.assetManager.preloadAny(t,{__requestType__:vl.PATH,type:o,bundle:this.name},a,s)},e.loadDir=function(t,e,n,i){var r=uO(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;c.assetManager.loadAny(t,{__requestType__:vl.DIR,type:o,bundle:this.name,__outputAsArray__:!0},a,s)},e.preloadDir=function(t,e,n,i){var r=uO(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;c.assetManager.preloadAny(t,{__requestType__:vl.DIR,type:o,bundle:this.name},a,s)},e.loadScene=function(t,e,n,i){var r=lO(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"scene",o.bundle=this.name,c.assetManager.loadAny({scene:t},o,a,(function(t,e){if(t)x(t.message,t.stack);else if(e instanceof QD&&e.scene){var n=e.scene;n._id=e._uuid,n.name=e.name}else t=new Error("The asset "+e._uuid+" is not a scene");s&&s(t,e)}))},e.preloadScene=function(t,e,n,i){var r=lO(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.bundle=this.name,c.assetManager.preloadAny({scene:t},o,a,(function(e){e&&D(1210,t,e.message),s&&s(e)}))},e.get=function(t,e){var n=this.getInfoWithPath(t,e);return n&&gl.get(n.uuid)||null},e.release=function(t,e){var n=this.get(t,e);n&&eO.tryRelease(n,!0)},e.releaseUnusedAssets=function(){var t=this;gl.forEach((function(e){var n=t.getAssetInfo(e._uuid);n&&!n.redirect&&eO.tryRelease(e)}))},e.releaseAll=function(){var t=this;gl.forEach((function(e){var n=t.getAssetInfo(e._uuid);n&&!n.redirect&&eO.tryRelease(e,!0)}))},e._destroy=function(){this._config.destroy()},K(t,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),t}(),dO=t("resources",new fO);function pO(t,e,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(N(4930,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=t,i}function mO(t,e,n,i){var r=new XMLHttpRequest,o="download failed: "+t+", status: ";if(r.open("GET",t,!0),void 0!==e.xhrResponseType&&(r.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(r.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(r.timeout=e.xhrTimeout),e.xhrHeader)for(var a in e.xhrHeader)r.setRequestHeader(a,e.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(t){t.lengthComputable&&n(t.loaded,t.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}c.resources=dO;var vO={};function gO(t,e,n){if(vO[t])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),vO[t]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(N(4928,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=e.scriptAsyncLoading||!1,i.src=t,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var yO=/^(?:\w+:\/\/|\.+\/).+/,xO=function(t,e,n){(sh.hasFeature(sh.Feature.IMAGE_BITMAP)&&c.assetManager.allowImageBitmap?SO:pO)(t,e,n)},SO=function(t,e,n){e.xhrResponseType="blob",mO(t,e,e.onFileProgress,n)},AO=function(t,e,n){e.xhrResponseType="json",mO(t,e,e.onFileProgress,n)},CO=function(t,e,n){e.xhrResponseType="arraybuffer",mO(t,e,e.onFileProgress,n)},bO=function(t,e,n){AO(t,e,(function(e,i){if(e)n(e);else{var r=hh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){CO(""+yu(t)+n,{},(function(t,n){e?r(e):i(new Uint8Array(n))}))}))}))).then((function(t){var e=new uh(r.document,t);n(null,e)})).catch((function(t){n(t)}))}}))},TO=function(t,e,n){CO(t,e,(function(t,e){if(t)n(t);else try{var i=_h(new Uint8Array(e));n(null,i)}catch(t){n(t)}}))},EO=function(t,e,n){e.xhrResponseType="text",mO(t,e,e.onFileProgress,n)},wO=function(t,e,n){var i=xu(t),r=t;yO.test(r)||(r=-1!==PO.remoteBundles.indexOf(i)?PO.remoteServerAddress+"remote/"+i:"assets/"+i);var o=e.version||PO.bundleVers[i],a=0,s=null,c=null;AO(r+"/config."+(o?o+".":"")+"json",e,(function(t,e){c=t,(s=e)&&(s.base=r+"/"),2==++a&&n(c,s)})),gO(r+"/index."+(o?o+".":"")+"js",e,(function(t){c=t,2==++a&&n(t,s)}))},PO=new(function(){function t(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=pO,this.downloadDomAudio=null,this.downloadFile=mO,this.downloadScript=gO,this._downloaders={".png":xO,".jpg":xO,".bmp":xO,".jpeg":xO,".gif":xO,".ico":xO,".tiff":xO,".webp":xO,".image":xO,".pvr":CO,".pkm":CO,".astc":CO,".txt":EO,".xml":EO,".vsh":EO,".fsh":EO,".atlas":EO,".tmx":EO,".tsx":EO,".json":AO,".ExportJson":AO,".plist":EO,".ccon":bO,".cconb":TO,".fnt":EO,".binary":CO,".bin":CO,".dbbin":CO,".skel":CO,".js":gO,bundle:wO,default:EO},this._downloading=new pl,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var e=t.prototype;return e.init=function(t,e,n){void 0===t&&(t=""),void 0===e&&(e={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=n},e.register=function(t,e){"object"==typeof t?zt(this._downloaders,t):this._downloaders[t]=e},e.download=function(t,e,n,i,r){var o=this,a=yl.get(t);if(a)r(null,a);else{var s=this._downloading.get(t);if(s){s.push(r);var c=this._queue.find((function(e){return e.id===t}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;oO((function(n,a){if(0===n&&o._downloading.add(t,[r]),o.limited){o._updateTime();var s=function(t,e){o._totalNum--,o._handleQueueInNextFrame(h,_),a(t,e)};o._totalNum<h&&o._totalNumThisPeriod<_?(f(rO(e,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:t,priority:i.priority||0,url:e,options:i,done:s,handler:f}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,_))}else f(rO(e,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(e,n){e||yl.add(t,n);for(var i=o._downloading.remove(t),r=0,a=i.length;r<a;r++)i[r](e,n)}))}}},e.loadSubpackage=function(t,e){c.assetManager.loadBundle(t,null,e)},e._updateTime=function(){var t=performance.now(),e=c.game.deltaTime,n=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=t)},e._handleQueue=function(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort((function(t,e){return t.priority-e.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(rO(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(t,e)},e._handleQueueInNextFrame=function(t,e){!this._checkNextPeriod&&this._queue.length>0&&(xe(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)},K(t,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),t}());function IO(t,e,n,i){var r=null,o=null;try{(r=new Jm)._nativeUrl=t,r._nativeAsset=e}catch(t){o=t}i(o,r)}function RO(t,e,n,i){var r=new iM;r.json=e,i(null,r)}function DO(t,e,n,i){var r=new nM;r.text=e,i(null,r)}function MO(t,e,n,i){var r=new IE;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}function BO(t,e,n,i){var r=new Ru;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}function OO(t,n,i,r){var o=Sl.get(n.name);o||(o=n.name===Tl.RESOURCES?dO:new fO,n.base=n.base||t+"/",o.init(n)),e.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var NO=new(function(){function t(){this._creating=new pl,this._producers={".png":IO,".jpg":IO,".bmp":IO,".jpeg":IO,".gif":IO,".ico":IO,".tiff":IO,".webp":IO,".image":IO,".pvr":IO,".pkm":IO,".txt":DO,".xml":DO,".vsh":DO,".fsh":DO,".atlas":DO,".tmx":DO,".tsx":DO,".fnt":DO,".json":RO,".ExportJson":RO,".binary":MO,".bin":MO,".dbbin":MO,".skel":MO,bundle:OO,default:BO}}var e=t.prototype;return e.register=function(t,e){"object"==typeof t?ne.mixin(this._producers,t):this._producers[t]=e},e.create=function(t,e,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=gl.get(t);if(i.reloadAsset||!s){var c=this._creating.get(t);c?c.push(r):(this._creating.add(t,[r]),a(t,e,i,(function(e,n){!e&&n instanceof Ru&&(n._uuid=t,sO(t,n,i.cacheAsset));for(var r=o._creating.remove(t),a=0,s=r.length;a<s;a++)r[a](e,n)})))}else r(null,s)},t}()),LO=new(function(){function t(){this._loading=new pl,this._unpackers={".json":this.unpackJson}}var e=t.prototype;return e.unpackJson=function(t,e,n,i){var r=ne.createMap(!0),o=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(N(5304,t[0]));Mh(t,!0,void 0,Oh.reportMissingClass),Bh(t);for(var e=new Nh(t[0]),n=t[1],i=t[2],r=t[3],o=t[4],a=t[5],s=0;s<a.length;++s)a[s].unshift(e,n,i,r,o);return a}(e)).length!==t.length&&D(4915);for(var a=0;a<t.length;a++)r[t[a]+"@import"]=e[a]}else{var s=ne._getClassId(yv),c=ne._getClassId(Jm);if(e.type===s&&e.data){var l=e.data;l.length!==t.length&&D(4915);for(var u=0;u<t.length;u++)r[t[u]+"@import"]=Lh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(e.type===c&&e.data){var h=e.data;h.length!==t.length&&D(4915);for(var _=0;_<t.length;_++)r[t[_]+"@import"]=h[_]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},e.init=function(){this._loading.clear()},e.register=function(t,e){"object"==typeof t?ne.mixin(this._unpackers,t):this._unpackers[t]=e},e.unpack=function(t,e,n,i,r){e?(0,this._unpackers[n])(t,e,i,r):r(new Error("package data is wrong!"))},e.load=function(t,e,n){var i=this;if(!t.isNative&&t.info&&t.info.packs)if(yl.has(t.id))n(null,yl.get(t.id));else{var r=t.info.packs,o=r.find((function(t){return i._loading.has(t.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:t.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:t.id}]);var a=zl(o.uuid,{ext:o.ext,bundle:t.config.name});PO.download(o.uuid,a,o.ext,t.options,(function(e,n){yl.remove(o.uuid),e&&x(e.message,e.stack),i.unpack(o.packedUuids,n,o.ext,t.options,(function(t,n){if(!t)for(var r in n)yl.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(e||t)l.onComplete(e||t);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else PO.download(t.id,t.url,t.ext,t.options,n)},t}());function FO(t,e){var n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);var i=t.options,r=t.progress,o=[],a=r.total,s=i.__exclude__=i.__exclude__||Object.create(null);t.output=[],cO(t.input,(function(i,l){if(!i.isNative&&gl.has(i.uuid)){var u=gl.get(i.uuid);return i.content=u.addRef(),t.output.push(i),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,i),void l()}LO.load(i,t.options,(function(u,h){u?t.isFinish||(!c.assetManager.force||n?(x(u.message,u.stack),r.canInvoke=!1,e(u)):(t.output.push(i),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,i))):t.isFinish||(i.file=h,t.output.push(i),i.isNative||(s[i.uuid]=!0,aO(i.uuid,h,s,o,i.config),r.total=a+o.length),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,i)),l()}))}),(function(){if(t.isFinish)return iO(t,!0),void t.dispatch("error");if(o.length>0){var a=wl.create({input:o,progress:r,options:i,onProgress:t.onProgress,onError:wl.prototype.recycle,onComplete:function(i){var r;i||((r=t.output).push.apply(r,a.output),a.recycle()),n&&zO(t),e(i)}});Cl.async(a)}else n&&zO(t),e()}))}function zO(t){for(var e=t.output,n=0,i=e.length;n<i;n++)e[n].content&&e[n].content.decRef(!1)}var VO=new(function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.parse=function(t){var e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return I(5100),{};for(var n=null,i=0,r=e.childNodes.length;i<r&&1!==(n=e.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(t){var e=null,n=t.tagName;if("dict"===n)e=this._parseDict(t);else if("array"===n)e=this._parseArray(t);else if("string"===n)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(var i=0;i<t.childNodes.length;i++)e+=t.childNodes[i].nodeValue}else"false"===n?e=!1:"true"===n?e=!0:"real"===n?e=parseFloat(t.firstChild.nodeValue):"integer"===n&&(e=parseInt(t.firstChild.nodeValue,10));return e},n._parseArray=function(t){for(var e=[],n=0,i=t.childNodes.length;n<i;n++){var r=t.childNodes[n];1===r.nodeType&&e.push(this._parseNode(r))}return e},n._parseDict=function(t){for(var e={},n="",i=0,r=t.childNodes.length;i<r;i++){var o=t.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:e[n]=this._parseNode(o))}return e},e}(function(){function t(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var e=t.prototype;return e.parse=function(t){return this._parseXML(t)},e._parseXML=function(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")},t}()));function kO(t,e){return t[e]<<8|t[e+1]}var GO=new(function(){function t(){this._parsing=new pl,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var e=t.prototype;return e.parseImage=function(t,e,n){t instanceof HTMLImageElement?n(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((function(t){n(null,t)}),(function(t){n(t,null)}))},e.parsePVRTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:_,height:h,format:0}}}catch(t){i=t}n(i,r)},e.parsePKMTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o),s=kO(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=kO(a,12),l=kO(a,14);kO(a,8),kO(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(t){i=t}n(i,r)},e.parseASTCTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(t,e){return 4===t?wm.RGBA_ASTC_4x4:5===t?4===e?wm.RGBA_ASTC_5x4:wm.RGBA_ASTC_5x5:6===t?5===e?wm.RGBA_ASTC_6x5:wm.RGBA_ASTC_6x6:8===t?5===e?wm.RGBA_ASTC_8x5:6===e?wm.RGBA_ASTC_8x6:wm.RGBA_ASTC_8x8:10===t?5===e?wm.RGBA_ASTC_10x5:6===e?wm.RGBA_ASTC_10x6:8===e?wm.RGBA_ASTC_10x8:wm.RGBA_ASTC_10x10:10===e?wm.RGBA_ASTC_12x10:wm.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:_,format:u}}catch(t){i=t}n(i,r)},e.parsePlist=function(t,e,n){var i=null,r=VO.parse(t);r||(i=new Error("parse failed")),n(i,r)},e.parseImport=function(t,e,n){if(t){var i=null,r=null;try{i=tv(t,e)}catch(t){r=t}n(r,i)}else n(new Error("The json file of asset "+e.__uuid__+" is empty or missing"))},e.init=function(){this._parsing.clear()},e.register=function(t,e){"object"==typeof t?zt(this._parsers,t):this._parsers[t]=e},e.parse=function(t,e,n,i,r){var o=this,a=xl.get(t);if(a)r(null,a);else{var s=this._parsing.get(t);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(t,[r]),c(e,i,(function(e,n){e?yl.remove(t):Ll(n)||xl.add(t,n);for(var i=o._parsing.remove(t),r=0,a=i.length;r<a;r++)i[r](e,n)}))):r(null,e)}}},t}());function UO(t,e){var n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);var i=t.options,r=t.progress;i.__exclude__=i.__exclude__||Object.create(null),t.output=[],cO(t.input,(function(o,a){var s=wl.create({input:o,onProgress:t.onProgress,options:i,progress:r,onComplete:function(i,l){i&&!t.isFinish&&(!c.assetManager.force||n?(x(i.message,i.stack),r.canInvoke=!1,e(i)):r.canInvoke&&t.dispatch("progress",++r.finish,r.total,o)),t.output.push(l),s.recycle(),a(null)}});HO.async(s)}),(function(){if(i.__exclude__=null,t.isFinish)return iO(t,!0),void t.dispatch("error");!function(t){var e=t.source;if(t.options.__outputAsArray__||1!==e.length)for(var n=t.output=[],i=0,r=e.length;i<r;i++)n.push(e[i].content);else t.output=e[0].content}(t),iO(t,!0),e()}))}var HO=new ml("loadOneAsset",[function(t,e){var n=t.output=t.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&gl.has(o)?e():LO.load(n,t.options,(function(t,i){n.file=i,e(t)}))},function(t,e){var n=t.output=t.input,i=t.progress,r=t.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)GO.parse(o,a,n.ext,s,(function(r,a){r?e(r):(n.content=a,i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),yl.remove(o),xl.remove(o),e())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),u||hO(c,c,r)?(h&&h.addRef(),n.content=h,e(_)):f.push({done:e,item:n})}else if(!s.reloadAsset&&gl.has(c)){var d=gl.get(c);n.content=d.addRef(),i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),e()}else s.__uuid__=c,GO.parse(o,a,"import",s,(function(n,i){n?e(n):function(t,e,n){var i=t.input,r=t.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];e.addRef&&e.addRef(),aO(a,e,Object.create(null),h,l),r.canInvoke&&t.dispatch("progress",++r.finish,r.total+=h.length,i);var _=t.options.__exclude__[a]={content:e,finish:!1,callbacks:[{done:n,item:i}]},f=wl.create({input:h,options:t.options,onProgress:t.onProgress,onError:wl.prototype.recycle,progress:r,onComplete:function(t){if(e.decRef&&e.decRef(!1),_.finish=!0,_.err=t,!t){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),o=ot(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof Ru?c._uuid+"@import":a+"@native"]=c)}!function(t,e,n){var i=Qm.get(e);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(x("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Ru){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}Qm.delete(e)}Zm.has(e)&&(n[t+"@native"]?e._nativeAsset=n[t+"@native"]:(!0,console.error("the native asset of "+t+" is missing!")),Zm.delete(e))}(a,e,r);try{"function"!=typeof e.onLoaded||$m.has(e)||Zm.has(e)||(e.onLoaded(),$m.add(e))}catch(t){x("The asset "+a+" is invalid for some reason, detail message: "+t.message+", stack: "+t.stack)}yl.remove(s),xl.remove(s),sO(a,e,u),f.recycle()}for(var l=_.callbacks,h=0,d=l.length;h<d;h++){var p=l[h];e.addRef&&e.addRef(),p.item.content=e,p.done(t)}l.length=0}});Al.async(f)}(t,i,e)}))}}]);function jO(t,e){var n=t.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case vl.PATH:case vl.UUID:case vl.DIR:case vl.SCENE:case vl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}t.options=r;var a=wl.create({input:t.input,options:i}),s=null;try{t.output=t.source=bl.sync(a)}catch(t){s=t;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),e(s)}var WO=function(){function t(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return t.create=function(){return 0!==t._deadPool.length?t._deadPool.pop():new t},t.prototype.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),t._deadPool.push(this))},K(t,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),t}();WO.MAX_DEAD_NUM=500,WO._deadPool=[];var qO=[];function XO(t){var e=t.options,n=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(var i=function(i){var r,o=n[i],a=WO.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[e.__requestType__||vl.UUID]=n[i]),"object"==typeof o)for(var l in Ft(o,e),o.preset&&Ft(o,El[o.preset]),o){switch(l){case vl.UUID:if("break"===function(){var t,e=a.uuid=Ml(o.uuid);if(!o.bundle){var n=Sl.find((function(t){return!!t.getAssetInfo(e)}));o.bundle=n&&n.name}if(Sl.has(o.bundle)){if(s=Sl.get(o.bundle).config,(c=s.getAssetInfo(e))&&c.redirect){if(!Sl.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=Sl.get(c.redirect).config,c=s.getAssetInfo(e)}a.config=s,a.info=c}return a.ext=o.ext||(null===(t=c)||void 0===t?void 0:t.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case vl.DIR:if(Sl.has(o.bundle)){Sl.get(o.bundle).config.getDirWithPath(o.dir,o.type,qO);for(var u,h=ot(qO);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:o.bundle})}qO.length=0}a.recycle(),a=null;break;case vl.PATH:if(Sl.has(o.bundle)){if(s=Sl.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!Sl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Sl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case vl.SCENE:if(!o.bundle){var f=Sl.find((function(t){return!!t.getSceneInfo(o.scene)}));o.bundle=f&&f.name}if(Sl.has(o.bundle)){if(s=Sl.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!Sl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Sl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case vl.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||gu(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(t.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function YO(t){for(var e=t.output=t.input,n=0;n<e.length;n++){var i=e[n];if(!i.url){var r,o,a=i.config;o=i.isNative?a&&a.nativeBase?a.base+a.nativeBase:c.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:c.assetManager.generalImportBase;var s=i.uuid,l="";i.info&&(l=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),r=".ttf"===i.ext?o+"/"+s.slice(0,2)+"/"+s+l+"/"+i.options.__nativeName__:o+"/"+s.slice(0,2)+"/"+s+l+i.ext,i.url=r}}return null}var KO=t("AssetManager",function(){function t(){this.pipeline=Al.append(jO).append(UO),this.fetchPipeline=Cl.append(jO).append(FO),this.transformPipeline=bl.append(XO).append(YO),this.bundles=Sl,this.assets=gl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=nv,this.force=!1,this.allowImageBitmap=!sh.isMobile,this.utils=Vl,this.downloader=PO,this.parser=GO,this.packManager=LO,this.cacheAsset=!0,this.cacheManager=null,this.presets=El,this.factory=NO,this.preprocessPipe=jO,this.fetchPipe=FO,this.loadPipe=UO,this.references=null,this._releaseManager=eO,this._files=yl,this._parsed=xl,this._parsePipeline=null}var e=t.prototype;return e.init=function(t){void 0===t&&(t={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();var e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));var n=t.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=e,this.generalNativeBase=n},e.getBundle=function(t){return Sl.get(t)||null},e.removeBundle=function(t){t._destroy(),Sl.remove(t.name)},e.loadAny=function(t,e,n,i){var r=lO(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",t=Array.isArray(t)?t.slice():t;var c=wl.create({input:t,onProgress:a,onComplete:_O(s),options:o});Al.async(c)},e.preloadAny=function(t,e,n,i){var r=lO(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",t=Array.isArray(t)?t.slice():t;var c=wl.create({input:t,onProgress:a,onComplete:_O(s),options:o});Cl.async(c)},e.loadRemote=function(t,e,n){var i=lO(e,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(t)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:t},r,null,(function(e,n){e?(x(e.message,e.stack),o&&o(e,n)):NO.create(t,n,r.ext||gu(t),r,(function(t,e){o&&o(t,e)}))}))):_O(o)(null,this.assets.get(t))},e.loadBundle=function(t,e,n){var i=lO(e,void 0,n),r=i.options,o=i.onComplete,a=xu(t);this.bundles.has(a)?_O(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:t},r,null,(function(e,n){e?(x(e.message,e.stack),o&&o(e,n)):NO.create(t,n,"bundle",r,(function(t,e){o&&o(t,e)}))})))},e.releaseAsset=function(t){eO.tryRelease(t,!0)},e.releaseUnusedAssets=function(){gl.forEach((function(t){eO.tryRelease(t)}))},e.releaseAll=function(){gl.forEach((function(t){eO.tryRelease(t,!0)}))},e.loadWithJson=function(){throw new Error("Only valid in Editor")},K(t,[{key:"main",get:function(){return Sl.get(Tl.MAIN)||null}},{key:"resources",get:function(){return Sl.get(Tl.RESOURCES)||null}}]),t}());KO.Pipeline=ml,KO.Task=wl,KO.Cache=pl,KO.RequestItem=WO,KO.Bundle=fO,KO.BuiltinBundleName=Tl;var JO=t("assetManager",c.assetManager=new KO);c.AssetManager=KO;var QO=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],ZO=[".mp3",".ogg",".wav",".m4a"];function $O(){return!0}var tN={transformURL:function(t){var e=Ol(t);if(!e)return t;var n=Sl.find((function(t){return!!t.getAssetInfo(e)}));if(!n)return t;var i,r=n.getAssetInfo(e);if(!(i=t.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==t.indexOf(i))return t;var o=!1;if(".ttf"===gu(t)&&(o=!0),o){var a=Su(t),s=xu(t);t=a+"."+i+"/"+s}else t=t.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(t){return t+"."+i}));return t}},eN=t("CCLoader",function(){function t(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=uO}var e=t.prototype;return e.load=function(t,e,n){void 0===n&&void 0!==e&&(n=e,e=null);for(var i=Array.isArray(t)?t:[t],r=0;r<i.length;r++){var o=i[r];"string"==typeof o?i[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];JO.loadAny(i,null,(function(t,n,i){i.content&&(QO.includes(i.ext)?a.push(i.content):ZO.includes(i.ext)&&s.push(i.content)),e&&e(t,n,i)}),(function(t,e){var r=null;if(!t){e=Array.isArray(e)?e:[e];for(var o=function(t){var n=e[t];if(!(n instanceof Ru)){var r=n,o=i[t].url;a.includes(r)?NO.create(o,n,".png",{},(function(n,i){r=e[t]=i})):s.includes(r)&&NO.create(o,n,".mp3",{},(function(n,i){r=e[t]=i})),gl.add(o,r)}},c=0;c<e.length;c++)o(c);if(e.length>1){var l=Object.create(null);e.forEach((function(t){l[t._uuid]=t})),r={isCompleted:$O,_map:l}}else r=e[0]}n&&n(t,r)}))},e.getXMLHttpRequest=function(){return new XMLHttpRequest},e.getItem=function(t){return JO.assets.has(t)?{content:JO.assets.get(t)}:null},e.loadRes=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c=gu(t);c&&!dO.getInfoWithPath(t,o)&&(t=t.slice(0,-c.length)),dO.load(t,o,a,s)},e.loadResArray=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;t.forEach((function(e,n){var i=gu(e);i&&!dO.getInfoWithPath(e,o)&&(t[n]=e.slice(0,-i.length))})),dO.load(t,o,a,s)},e.loadResDir=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;dO.loadDir(t,o,a,(function(e,n){var i=[];e||(i=dO.getDirWithPath(t,o).map((function(t){return t.path}))),s&&s(e,n,i)}))},e.getRes=function(t,e){return gl.has(t)?gl.get(t):dO.get(t,e)},e.getResCount=function(){return gl.count},e.getDependsRecursively=function(t){if(!t)return[];var e="string"==typeof t?t:t._uuid;return nv.getDepsRecursively(e).concat([e])},e.addDownloadHandlers=function(t){var e=Object.create(null),n=function(n){var i=t[n];e["."+n]=function(t,e,n){i({url:t},n)}};for(var i in t)n(i);PO.register(e)},e.addLoadHandlers=function(t){var e=Object.create(null),n=function(n){var i=t[n];e["."+n]=function(t,e,n){i({content:t},n)}};for(var i in t)n(i);GO.register(e)},e.release=function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++){var n=t[e];"string"==typeof n&&(n=gl.get(n)),JO.releaseAsset(n)}else t&&("string"==typeof t&&(t=gl.get(t)),JO.releaseAsset(t))},e.releaseAsset=function(t){JO.releaseAsset(t)},e.releaseRes=function(t,e){dO.release(t,e)},e.releaseAll=function(){JO.releaseAll(),gl.clear()},e.removeItem=function(t){return!!gl.remove(t)},e.setAutoRelease=function(t,e){"object"==typeof t&&(t=t._uuid),this._autoReleaseSetting[t]=!!e},e.setAutoReleaseRecursively=function(t,e){"object"==typeof t&&(t=t._uuid),e=!!e,this._autoReleaseSetting[t]=e;for(var n=nv.getDepsRecursively(t),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=e},e.isAutoRelease=function(t){return"object"==typeof t&&(t=t._uuid),!!this._autoReleaseSetting[t]},K(t,[{key:"onProgress",set:function(t){nO=t}},{key:"_cache",get:function(){if(gl instanceof pl)return gl._map;var t={};return gl.forEach((function(e,n){t[n]=e})),t}},{key:"md5Pipe",get:function(){return tN}},{key:"downloader",get:function(){return PO}},{key:"loader",get:function(){return JO.parser}}]),t}()),nN=t("loader",new eN),iN=t("AssetLibrary",{init:function(t){t.importBase=t.libraryPath,t.nativeBase=t.rawAssetsBase,JO.init(t),t.rawAssets&&dO.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:Tl.RESOURCES,importBase:t.importBase,nativeBase:t.nativeBase,paths:t.rawAssets.assets,uuids:Object.keys(t.rawAssets.assets),extensionMap:{}})},loadAsset:function(t,e){JO.loadAny(t,e)}}),rN=t("url",{});z(rN,"url",[{name:"normalize",target:JO.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(t){return t.startsWith("resources/")?zl({path:Au(t.substr(10)),bundle:Tl.RESOURCES,__isNative__:!0,ext:gu(t)}):""}}]),V(iN,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),V(nN,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),z(c,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return nN}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return iN}},{name:"Pipeline",target:KO,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return rN}}]),V(c,"cc",[{name:"LoadingItems",suggest:N(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),z(ue,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:PO,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),z(zB,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(t){var e;return JO.main?null===(e=JO.main.getSceneInfo(t))||void 0===e?void 0:e.uuid:""}}]),z(LB,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var t=[];return JO.main&&JO.main.config.scenes.forEach((function(e){t.push(e)})),t}}]);var oN,aN,sN,cN,lN,uN,hN,_N,fN,dN,pN,mN,vN,gN,yN=eO._autoRelease;eO._autoRelease=function(t,e,n){yN.call(eO,t,e,n);for(var i=nN._autoReleaseSetting,r=Object.keys(i),o=0;o<r.length;o++){var a=r[o];if(!0===i[a]){var s=gl.get(a);s&&eO.tryRelease(s)}}};var xN,SN,AN,CN,bN,TN,EN,wN,PN,IN,RN,DN,MN,BN,ON,NN,LN,FN,zN,VN,kN,GN,UN,HN,jN,WN,qN,XN,YN,KN,JN,QN,ZN,$N,tL,eL,nL,iL,rL,oL,aL,sL,cL,lL,uL,hL,_L,fL,dL,pL,mL,vL,gL,yL,xL,SL,AL,CL,bL,TL,EL,wL,PL,IL,RL,DL,ML,BL=t("EventHandler",(oN=fc("cc.ClickEvent"),aN=Xc(c.Node),sN=Oc(),cN=Oc(),lN=Oc(),uN=Oc(),oN((gN=function(){function t(){at(this,"target",fN,this),at(this,"component",dN,this),at(this,"_componentId",pN,this),at(this,"handler",mN,this),at(this,"customEventData",vN,this)}t.emitEvents=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=e.length;o<a;o++){var s=e[o];s instanceof t&&s.emit(i)}};var e=t.prototype;return e.emit=function(t){var e=this.target;if(c.isValid(e)){this._genCompIdIfNeeded();var n=c.js._getClassById(this._componentId),i=e.getComponent(n);if(c.isValid(i)){var r=i[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),r.apply(i,t))}}},e._compName2Id=function(t){var e=c.js.getClassByName(t);return c.js._getClassId(e)},e._compId2Name=function(t){var e=c.js._getClassById(t);return c.js.getClassName(e)},e._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},K(t,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(t){this._componentId=this._compName2Id(t)}}]),t}(),fN=st((_N=gN).prototype,"target",[yc,aN,yc,sN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dN=st(_N.prototype,"component",[yc,Rc,cN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pN=st(_N.prototype,"_componentId",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mN=st(_N.prototype,"handler",[yc,Rc,lN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vN=st(_N.prototype,"customEventData",[yc,Rc,uN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hN=_N))||hN));c.Component.EventHandler=BL;var OL,NL,LL,FL,zL,VL,kL,GL,UL,HL,jL,WL=new Pn,qL=oe($v),XL=oe(Zv),YL=oe(tg),KL=oe(ng),JL=oe(eg),QL=oe({SKYBOX:hg|Xi.DEPTH_STENCIL,SOLID_COLOR:Xi.ALL,DEPTH_ONLY:Xi.DEPTH_STENCIL,DONT_CLEAR:Xi.NONE}),ZL=(xN=fc("cc.Camera"),SN=Ic(),AN=Tc(),CN=kc(),bN=Oc(),TN=Xc(Md.BitMask),EN=kc(),wN=Oc(),PN=Xc(QL),IN=kc(),RN=Oc(),DN=kc(),MN=Oc(),BN=kc(),ON=Oc(),NN=kc(),LN=Oc(),FN=Xc(qL),zN=kc(),VN=Oc(),kN=Xc(XL),GN=kc(),UN=Oc(),HN=kc(),jN=Oc(),WN=kc(),qN=Oc(),XN=kc(),YN=Oc(),KN=kc(),JN=Oc(),QN=Xc(YL),ZN=kc(),$N=Oc(),tL=Xc(KL),eL=kc(),nL=Oc(),iL=Xc(JL),rL=kc(),oL=Oc(),aL=kc(),sL=Oc(),cL=Xc(NS),lL=kc(),uL=Oc(),OL=xN(hL=SN(hL=AN(hL=bc((ML=DL=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_projection",fL,it(e)),at(e,"_priority",dL,it(e)),at(e,"_fov",pL,it(e)),at(e,"_fovAxis",mL,it(e)),at(e,"_orthoHeight",vL,it(e)),at(e,"_near",gL,it(e)),at(e,"_far",yL,it(e)),at(e,"_color",xL,it(e)),at(e,"_depth",SL,it(e)),at(e,"_stencil",AL,it(e)),at(e,"_clearFlags",CL,it(e)),at(e,"_rect",bL,it(e)),at(e,"_aperture",TL,it(e)),at(e,"_shutter",EL,it(e)),at(e,"_iso",wL,it(e)),at(e,"_screenScale",PL,it(e)),at(e,"_visibility",IL,it(e)),at(e,"_targetTexture",RL,it(e)),e._camera=null,e._inEditorMode=!1,e._flows=void 0,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=$g.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(t,e,n){return n||(n=$o.create()),this._camera&&this._camera.screenPointToRay(n,t,e),n},n.worldToScreen=function(t,e){return e||(e=new Pn),this._camera&&this._camera.worldToScreen(e,t),e},n.screenToWorld=function(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e},n.convertToUINode=function(t,e,n){if(n||(n=new Pn),!this._camera)return n;this.worldToScreen(t,WL);var i=e.getComponent("cc.UITransform"),r=YB.getVisibleSize(),o=WL.x-.5*this._camera.width,a=WL.y-.5*this._camera.height;return WL.x=o/c.view.getScaleX()+.5*r.width,WL.y=a/c.view.getScaleY()+.5*r.height,i&&i.convertToNodeSpaceAR(WL,n),n},n._createCamera=function(){this._camera||(this._camera=c.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?c.director.root&&c.director.root.mainWindow:c.director.root&&c.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=un(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(t){var e=this;t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(t){e._camera&&e._camera.setFixedSize(t.width,t.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}},K(e,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t,this._camera&&(this._camera.priority=t)}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}},{key:"clearColor",get:function(){return this._color},set:function(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}},{key:"clearStencil",get:function(){return this._stencil},set:function(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}},{key:"projection",get:function(){return this._projection},set:function(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===Zv.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._camera&&(this._camera.fov=un(t))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._camera&&(this._camera.nearClip=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=t,this._camera&&(this._camera.farClip=t)}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._camera&&(this._camera.iso=t)}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect=t,this._camera&&this._camera.setViewportInOrientedSpace(t)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(t){if(this._targetTexture!==t){var n=this._targetTexture;this._targetTexture=t,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(e.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?c.director.root&&c.director.root.mainWindow:c.director.root&&c.director.root.tempWindow)}}]),e}(Qu),DL.ProjectionType=qL,DL.FOVAxis=XL,DL.ClearFlag=QL,DL.Aperture=YL,DL.Shutter=KL,DL.ISO=JL,DL.TARGET_TEXTURE_CHANGE="tex-change",fL=st((_L=ML).prototype,"_projection",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qL.PERSPECTIVE}}),dL=st(_L.prototype,"_priority",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pL=st(_L.prototype,"_fov",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),mL=st(_L.prototype,"_fovAxis",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XL.VERTICAL}}),vL=st(_L.prototype,"_orthoHeight",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),gL=st(_L.prototype,"_near",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yL=st(_L.prototype,"_far",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),xL=st(_L.prototype,"_color",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En("#333333")}}),SL=st(_L.prototype,"_depth",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),AL=st(_L.prototype,"_stencil",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CL=st(_L.prototype,"_clearFlags",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QL.SOLID_COLOR}}),bL=st(_L.prototype,"_rect",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni(0,0,1,1)}}),TL=st(_L.prototype,"_aperture",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YL.F16_0}}),EL=st(_L.prototype,"_shutter",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KL.D125}}),wL=st(_L.prototype,"_iso",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JL.ISO100}}),PL=st(_L.prototype,"_screenScale",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),IL=st(_L.prototype,"_visibility",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qp}}),RL=st(_L.prototype,"_targetTexture",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),st(_L.prototype,"priority",[CN,bN],Object.getOwnPropertyDescriptor(_L.prototype,"priority"),_L.prototype),st(_L.prototype,"visibility",[TN,EN,wN],Object.getOwnPropertyDescriptor(_L.prototype,"visibility"),_L.prototype),st(_L.prototype,"clearFlags",[PN,IN,RN],Object.getOwnPropertyDescriptor(_L.prototype,"clearFlags"),_L.prototype),st(_L.prototype,"clearColor",[DN,MN],Object.getOwnPropertyDescriptor(_L.prototype,"clearColor"),_L.prototype),st(_L.prototype,"clearDepth",[BN,ON],Object.getOwnPropertyDescriptor(_L.prototype,"clearDepth"),_L.prototype),st(_L.prototype,"clearStencil",[NN,LN],Object.getOwnPropertyDescriptor(_L.prototype,"clearStencil"),_L.prototype),st(_L.prototype,"projection",[FN,zN,VN],Object.getOwnPropertyDescriptor(_L.prototype,"projection"),_L.prototype),st(_L.prototype,"fovAxis",[kN,GN,UN],Object.getOwnPropertyDescriptor(_L.prototype,"fovAxis"),_L.prototype),st(_L.prototype,"fov",[HN,jN],Object.getOwnPropertyDescriptor(_L.prototype,"fov"),_L.prototype),st(_L.prototype,"orthoHeight",[WN,qN],Object.getOwnPropertyDescriptor(_L.prototype,"orthoHeight"),_L.prototype),st(_L.prototype,"near",[XN,YN],Object.getOwnPropertyDescriptor(_L.prototype,"near"),_L.prototype),st(_L.prototype,"far",[KN,JN],Object.getOwnPropertyDescriptor(_L.prototype,"far"),_L.prototype),st(_L.prototype,"aperture",[QN,ZN,$N],Object.getOwnPropertyDescriptor(_L.prototype,"aperture"),_L.prototype),st(_L.prototype,"shutter",[tL,eL,nL],Object.getOwnPropertyDescriptor(_L.prototype,"shutter"),_L.prototype),st(_L.prototype,"iso",[iL,rL,oL],Object.getOwnPropertyDescriptor(_L.prototype,"iso"),_L.prototype),st(_L.prototype,"rect",[aL,sL],Object.getOwnPropertyDescriptor(_L.prototype,"rect"),_L.prototype),st(_L.prototype,"targetTexture",[cL,lL,uL],Object.getOwnPropertyDescriptor(_L.prototype,"targetTexture"),_L.prototype),hL=_L))||hL)||hL)||hL)||hL,t({Camera:OL,CameraComponent:OL}),OL);c.Camera=ZL;var $L,tF,eF,nF,iF,rF,oF,aF,sF={parent:null,owner:null,subModelIdx:0},cF=t("RenderableComponent",(NL=fc("cc.RenderableComponent"),LL=Xc([rg]),FL=Xc(rg),zL=kc(),VL=Bc(),NL((jL=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_materials",UL,it(e)),at(e,"_visFlags",HL,it(e)),e._materialInstances=[],e._models=[],e}Q(e,t);var n=e.prototype;return n.getMaterial=function(t){return t<0||t>=this._materials.length?null:this._materials[t]},n.setMaterial=function(t,e){t&&t instanceof _A&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;var n=this._materialInstances[e];n&&(n.destroy(),this._materialInstances[e]=null),this._onMaterialModified(e,this._materials[e])},n.getMaterialInstance=function(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){sF.parent=this._materials[t],sF.owner=this,sF.subModelIdx=t;var e=new _A(sF);sF.parent=null,sF.owner=null,sF.subModelIdx=0,this.setMaterialInstance(e,t)}return this._materialInstances[t]},n.setMaterialInstance=function(t,e){if("number"==typeof t){I(12007);var n=t;t=e,e=n}var i=this._materialInstances[e];t&&t.parent?t!==i&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):(t!==this._materials[e]||i)&&this.setMaterial(t,e)},n.getRenderMaterial=function(t){return this._materialInstances[t]||this._materials[t]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},K(e,[{key:"visibility",get:function(){return this._visFlags},set:function(t){this._visFlags=t,this._onVisibilityChange(t)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var n=t.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(t.length)}}},{key:"materials",get:function(){for(var t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances},set:function(t){var e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(var n=this._materials.length-e;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=t[i]&&this.setMaterialInstance(t[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(t){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==t)&&this.setMaterialInstance(t,0)}}]),e}(Qu),UL=st((GL=jL).prototype,"_materials",[LL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HL=st(GL.prototype,"_visFlags",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Md.Enum.NONE}}),st(GL.prototype,"sharedMaterials",[FL,zL,VL],Object.getOwnPropertyDescriptor(GL.prototype,"sharedMaterials"),GL.prototype),kL=GL))||kL));function lF(t){return"string"==typeof t||"number"==typeof t}c.RenderableComponent=cF,z(ZL,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),z(ZL.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),c.CameraComponent=ZL,ne.setClassAlias(ZL,"cc.CameraComponent");var uF,hF,_F,fF,dF,pF,mF,vF,gF,yF,xF,SF,AF,CF,bF,TF,EF,wF,PF,IF,RF,DF,MF=fc("cc.animation.HierarchyPath")((nF=function(){function t(t){at(this,"path",eF,this),this.path=t||""}return t.prototype.get=function(t){return t instanceof kT?t.getChildByPath(this.path)||(I(3926,t.name,this.path),null):(I(3925),null)},t}(),eF=st((tF=nF).prototype,"path",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$L=tF))||$L,BF=fc("cc.animation.ComponentPath")((aF=function(){function t(t){at(this,"component",oF,this),this.component=t||""}return t.prototype.get=function(t){return t instanceof kT?t.getComponent(this.component)||(I(3928,t.name,this.component),null):(I(3927),null)},t}(),oF=st((rF=aF).prototype,"component",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),iF=rF))||iF,OF=fc("cc.animation.UniformProxyFactory")((pF=function(){function t(t,e){at(this,"passIndex",_F,this),at(this,"uniformName",fF,this),at(this,"channelIndex",dF,this),this.passIndex=e||0,this.uniformName=t||""}return t.prototype.forTarget=function(t){var e=t.passes[this.passIndex],n=e.getHandle(this.uniformName);if(!n)throw new Error('Material "'+t.name+'" has no uniform "'+this.uniformName+'"');if(Nv.getTypeFromHandle(n)<di.SAMPLER1D){var i=void 0===this.channelIndex?n:e.getHandle(this.uniformName,this.channelIndex,di.FLOAT);if(!i)throw new Error('Uniform "'+this.uniformName+" (in material "+t.name+") has no channel "+this.channelIndex+'"');return function(t,e){for(var n,i=ot(t.shaderInfo.blocks);!(n=i()).done;)for(var r,o=ot(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===e)return a.count>1}return!1}(e,this.uniformName)?{set:function(t){e.setUniformArray(i,t)}}:{set:function(t){e.setUniform(i,t)}}}var r=Nv.getBindingFromHandle(n),o=e.properties[this.uniformName],a=o&&o.value?o.value+"-texture":cm(o.type),s=Pv.get(a);return s||(y("Illegal texture default value: "+a+"."),s=Pv.get("default-texture")),{set:function(t){t||(t=s);var n=t.getGFXTexture();n&&n.width&&n.height&&(e.bindTexture(r,n),t instanceof Ym&&e.bindSampler(r,c.game._gfxDevice.getSampler(t.getSamplerInfo())))}}},t}(),_F=st((hF=pF).prototype,"passIndex",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fF=st(hF.prototype,"uniformName",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dF=st(hF.prototype,"channelIndex",[jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),uF=hF))||uF,NF=fc("cc.animation.MorphWeightValueProxy")((xF=function(){function t(){at(this,"subMeshIndex",gF,this),at(this,"shapeIndex",yF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(n){t.setWeight(n,e.subMeshIndex,e.shapeIndex)}}},t}(),gF=st((vF=xF).prototype,"subMeshIndex",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yF=st(vF.prototype,"shapeIndex",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mF=vF))||mF,LF=fc("cc.animation.MorphWeightsValueProxy")((bF=function(){function t(){at(this,"subMeshIndex",CF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(n){t.setWeights(n,e.subMeshIndex)}}},t}(),CF=st((AF=bF).prototype,"subMeshIndex",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SF=AF))||SF,FF=fc("cc.animation.MorphWeightsAllValueProxy")(TF=function(){function t(){}return t.prototype.forTarget=function(t){return{set:function(e){for(var n,i,r=null!==(n=null===(i=t.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)t.setWeights(e,o)}}},t}())||TF;function zF(t,e,n,i){var r,o,a,s,c,l,u=new e,h=new e,_=new e,f=fc(t)((l=function(){function t(t,n,i){at(this,"dataPoint",a,this),at(this,"inTangent",s,this),at(this,"outTangent",c,this),this.dataPoint=t||new e,this.inTangent=n||new e,this.outTangent=i||new e}var r=t.prototype;return r.lerp=function(t,e,r){var o=this.dataPoint,a=t.dataPoint;h=n(h,this.inTangent,r),_=n(_,t.outTangent,r);var s=e*e*e,c=e*e,l=s-2*c+e,f=-2*s+3*c,d=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,f),u=i(u,u,_,d)},r.getNoLerp=function(){return this.dataPoint},t}(),a=st((o=l).prototype,"dataPoint",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=st(o.prototype,"inTangent",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),c=st(o.prototype,"outTangent",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),r=o))||r;if(e===Nn){var d=f.prototype.lerp;f.prototype.lerp=function(t,e,n){var i=d.call(this,t,e,n);return Nn.normalize(i,i),i}}return f}var VF=t("CubicSplineVec2Value",zF("cc.CubicSplineVec2Value",Xn,Xn.multiplyScalar,Xn.scaleAndAdd));c.CubicSplineVec2Value=VF;var kF=t("CubicSplineVec3Value",zF("cc.CubicSplineVec3Value",Pn,Pn.multiplyScalar,Pn.scaleAndAdd));c.CubicSplineVec3Value=kF;var GF=t("CubicSplineVec4Value",zF("cc.CubicSplineVec4Value",Qn,Qn.multiplyScalar,Qn.scaleAndAdd));c.CubicSplineVec4Value=GF;var UF=t("CubicSplineQuatValue",zF("cc.CubicSplineQuatValue",Nn,Nn.multiplyScalar,Nn.scaleAndAdd));c.CubicSplineQuatValue=UF;var HF=t("CubicSplineNumberValue",fc("cc.CubicSplineNumberValue")((DF=function(){function t(t,e,n){at(this,"dataPoint",PF,this),at(this,"inTangent",IF,this),at(this,"outTangent",RF,this),this.dataPoint=t,this.inTangent=e,this.outTangent=n}var e=t.prototype;return e.lerp=function(t,e,n){var i=this.dataPoint,r=t.dataPoint,o=e*e*e,a=e*e;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+e)+r*(-2*o+3*a)+t.inTangent*n*(o-a)},e.getNoLerp=function(){return this.dataPoint},t}(),PF=st((wF=DF).prototype,"dataPoint",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IF=st(wF.prototype,"inTangent",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RF=st(wF.prototype,"outTangent",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EF=wF))||EF);c.CubicSplineNumberValue=HF;var jF,WF,qF,XF,YF,KF,JF,QF,ZF,$F,tz,ez,nz,iz,rz,oz,az,sz,cz,lz,uz,hz,_z,fz,dz,pz,mz,vz=Symbol("CreateEval"),gz=Symbol("NormalizedFollow"),yz=Symbol("ConvertAsTrsPath"),xz=Symbol("TrackBinding"),Sz=fc("cc.animation.TrackPath")((XF=function(){function t(){at(this,"_paths",qF,this)}var e=t.prototype;return e.toProperty=function(t){return this._paths.push(t),this},e.toElement=function(t){return this._paths.push(t),this},e.toHierarchy=function(t){return this._paths.push(new MF(t)),this},e.toComponent=function(t){var e=new BF("string"==typeof t?t:ne.getClassName(t));return this._paths.push(e),this},e.toCustomized=function(t){return this._paths.push(t),this},e.append=function(){for(var t,e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];var r=(t=this._paths).concat.apply(t,n.map((function(t){return t._paths})));return this._paths=r,this},e.isPropertyAt=function(t){return"string"==typeof this._paths[t]},e.parsePropertyAt=function(t){return this._paths[t]},e.isElementAt=function(t){return"number"==typeof this._paths[t]},e.parseElementAt=function(t){return this._paths[t]},e.isHierarchyAt=function(t){return this._paths[t]instanceof MF},e.parseHierarchyAt=function(t){return this.isHierarchyAt(t),this._paths[t].path},e.isComponentAt=function(t){return this._paths[t]instanceof BF},e.parseComponentAt=function(t){return this.isComponentAt(t),this._paths[t].component},e.slice=function(e,n){var i=new t;return i._paths=this._paths.slice(e,n),i},e.trace=function(t,e,n){var i,r;return null!==(i=e)&&void 0!==i||(e=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[gz](t,e,n)},e[yz]=function(){for(var t,e=this._paths,n=e.length,i=0,r="";i<n;++i){var o=e[i];if(!(o instanceof MF))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(e[i]){case"position":case"scale":case"rotation":case"eulerAngles":t=e[i];break;default:return null}return{node:r,property:t}},e[gz]=function(t,e,n){for(var i=this._paths,r=t,o=e;o<n;++o){var a=i[o];if(lF(a)){if(!(a in r))return I(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},K(t,[{key:"length",get:function(){return this._paths.length}}]),t}(),qF=st((WF=XF).prototype,"_paths",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jF=WF))||jF,Az=fc("cc.animation.TrackBinding")(YF=Cc((ZF=function(){function t(){at(this,"path",JF,this),at(this,"proxy",QF,this)}var e=t.prototype;return e.parseTrsPath=function(){return this.proxy?null:this.path[yz]()},e.createRuntimeBinding=function(t,e,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[gz](t,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(t){c.set(t)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return D(3921),null}var h=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),_=i[gz](t,0,o-1);return null===_?null:e&&_ instanceof kT&&function(t){return"position"===t||"rotation"===t||"scale"===t||"eulerAngles"===t}(h)?e.createPoseWriter(_,h,n):{setValue:function(t){_[h]=t},getValue:function(){return _[h]}}},t}(),JF=st((KF=ZF).prototype,"path",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Sz}}),QF=st(KF.prototype,"proxy",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),YF=KF))||YF)||YF,Cz=fc("cc.animation.Track")((nz=function(){function t(){at(this,"_binding",ez,this)}var e=t.prototype;return e.channels=function(){return[]},e.range=function(){for(var t,e={min:1/0,max:-1/0},n=ot(this.channels());!(t=n()).done;){var i=t.value;e.min=Math.min(e.min,i.curve.rangeMin),e.max=Math.max(e.max,i.curve.rangeMax)}return e},K(t,[{key:"path",get:function(){return this._binding.path},set:function(t){this._binding.path=t}},{key:"proxy",get:function(){return this._binding.proxy},set:function(t){this._binding.proxy=t}},{key:xz,get:function(){return this._binding}}]),t}(),ez=st((tz=nz).prototype,"_binding",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Az}}),$F=tz))||$F,bz=fc("cc.animation.Channel")((az=function(){function t(t){this.name="",at(this,"_curve",oz,this),this._curve=t}return K(t,[{key:"curve",get:function(){return this._curve}}]),t}(),oz=st((rz=az).prototype,"_curve",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),iz=rz))||iz,Tz=fc("cc.animation.SingleChannelTrack")((uz=function(t){function e(){var e;return at(e=t.call(this)||this,"_channel",lz,it(e)),e._channel=new bz(e.createCurve()),e}Q(e,t);var n=e.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[vz]=function(){var t=this._channel.curve;return new Ez(t)},K(e,[{key:"channel",get:function(){return this._channel}}]),e}(Cz),lz=st((cz=uz).prototype,"_channel",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),sz=cz))||sz,Ez=function(){function t(t){this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t)},t}(),wz=fc("cc.animation.RealTrack")(hz=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.prototype.createCurve=function(){return new ff},e}(Tz))||hz;function Pz(t){return 0===t.keyFramesCount?void 0:t}var Iz,Rz,Dz,Mz,Bz,Oz,Nz,Lz,Fz,zz,Vz=["X","Y","Z","W"],kz=fc("cc.animation.VectorTrack")((mz=function(t){function e(){var e;at(e=t.call(this)||this,"_channels",dz,it(e)),at(e,"_nComponents",pz,it(e)),e._channels=new Array(4);for(var n=0;n<e._channels.length;++n){var i=new bz(new ff);i.name=Vz[n],e._channels[n]=i}return e}Q(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[vz]=function(){switch(this._nComponents){default:case 2:return new Gz(Pz(this._channels[0].curve),Pz(this._channels[1].curve));case 3:return new Uz(Pz(this._channels[0].curve),Pz(this._channels[1].curve),Pz(this._channels[2].curve));case 4:return new Hz(Pz(this._channels[0].curve),Pz(this._channels[1].curve),Pz(this._channels[2].curve),Pz(this._channels[3].curve))}},K(e,[{key:"componentsCount",get:function(){return this._nComponents},set:function(t){this._nComponents=t}}]),e}(Cz),dz=st((fz=mz).prototype,"_channels",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),pz=st(fz.prototype,"_nComponents",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),_z=fz))||_z,Gz=function(){function t(t,e){this._result=new Xn,this._x=t,this._y=e}return t.prototype.evaluate=function(t,e){return this._x&&this._y||!e.getValue||Xn.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._result},t}(),Uz=function(){function t(t,e,n){this._result=new Pn,this._x=t,this._y=e,this._z=n}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z||!e.getValue||Pn.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._result},t}(),Hz=function(){function t(t,e,n,i){this._result=new Qn,this._x=t,this._y=e,this._z=n,this._w=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||Qn.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._w&&(this._result.w=this._w.evaluate(t)),this._result},t}(),jz=fc("cc.animation.QuatTrack")(Iz=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.createCurve=function(){return new $f},n[vz]=function(){return new Wz(this.channels()[0].curve)},e}(Tz))||Iz,Wz=function(){function t(t){this._result=new Nn,this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t,this._result),this._result},t}(),qz=["Red","Green","Blue","Alpha"],Xz=fc("cc.animation.ColorTrack")((Bz=function(t){function e(){var e;at(e=t.call(this)||this,"_channels",Mz,it(e)),e._channels=new Array(4);for(var n=0;n<e._channels.length;++n){var i=new bz(new ff);i.name=qz[n],e._channels[n]=i}return e}Q(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[vz]=function(){return new Yz(Pz(this._channels[0].curve),Pz(this._channels[1].curve),Pz(this._channels[2].curve),Pz(this._channels[3].curve))},e}(Cz),Mz=st((Dz=Bz).prototype,"_channels",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Rz=Dz))||Rz,Yz=function(){function t(t,e,n,i){this._result=new En,this._x=t,this._y=e,this._z=n,this._w=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||En.copy(this._result,e.getValue()),this._x&&(this._result.r=this._x.evaluate(t)),this._y&&(this._result.g=this._y.evaluate(t)),this._z&&(this._result.b=this._z.evaluate(t)),this._w&&(this._result.a=this._w.evaluate(t)),this._result},t}(),Kz=["Width","Height"],Jz=fc("cc.animation.SizeTrack")((Fz=function(t){function e(){var e;at(e=t.call(this)||this,"_channels",Lz,it(e)),e._channels=new Array(2);for(var n=0;n<e._channels.length;++n){var i=new bz(new ff);i.name=Kz[n],e._channels[n]=i}return e}Q(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[vz]=function(){return new Qz(Pz(this._channels[0].curve),Pz(this._channels[1].curve))},e}(Cz),Lz=st((Nz=Fz).prototype,"_channels",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Oz=Nz))||Oz,Qz=function(){function t(t,e){this._result=new ti,this._width=t,this._height=e}return t.prototype.evaluate=function(t,e){if((!this._width||!this._height)&&e.getValue){var n=e.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(t)),this._height&&(this._result.height=this._height.evaluate(t)),this._result},t}(),Zz=fc("cc.animation.ObjectTrack")(zz=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.prototype.createCurve=function(){return new dd},e}(Tz))||zz,$z=Symbol("[[Owner]]");function tV(t){t[$z]}var eV,nV,iV,rV,oV,aV,sV,cV,lV,uV,hV,_V,fV,dV,pV,mV,vV,gV,yV,xV=function(t){function e(e){var n;return(n=t.call(this,e+" transition is invalid")||this).name="TransitionRejectError",n}return Q(e,t),e}(nt(Error)),SV=function(t){function e(e){return t.call(this,"Graph variable "+e+" is not defined")||this}return Q(e,t),e}(nt(Error)),AV=function(t){function e(e,n,i){return t.call(this,"Expect graph variable "+e+" to have type '"+n+"' instead of received '"+(null!=i?i:typeof i)+"'")||this}return Q(e,t),e}(nt(Error)),CV=Symbol("[[createEval]]"),bV=Symbol("[[Outgoing transitions]]"),TV=Symbol("[[Incoming transitions]]"),EV=fc("cc.animation.State")((rV=function(t){function e(){var e;return at(e=t.call(this)||this,"name",iV,it(e)),e[bV]=[],e[TV]=[],e}return Q(e,t),e}(cl),iV=st((nV=rV).prototype,"name",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),eV=nV))||eV,wV=fc("cc.animation.InteractiveState")((cV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_components",sV,it(e)),e}Q(e,t);var n=e.prototype;return n.addComponent=function(t){var e=new t;return this._components.push(e),e},n.removeComponent=function(t){ht(this._components,t)},n.instantiateComponents=function(){return this._components.map((function(t){return Qh(t)}))},K(e,[{key:"components",get:function(){return this._components}}]),e}(EV),sV=st((aV=cV).prototype,"_components",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oV=aV))||oV;!function(t){t[t.FLOAT=0]="FLOAT",t[t.BOOLEAN=1]="BOOLEAN",t[t.TRIGGER=2]="TRIGGER",t[t.INTEGER=3]="INTEGER"}(yV||(yV={}));var PV,IV,RV,DV,MV,BV=fc("cc.animation.BindableNumber")((fV=function(){function t(t){void 0===t&&(t=0),at(this,"variable",hV,this),at(this,"value",_V,this),this.value=t}return t.prototype.clone=function(){var e=new t;return e.value=this.value,e.variable=this.variable,e},t}(),hV=st((uV=fV).prototype,"variable",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_V=st(uV.prototype,"value",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lV=uV))||lV,OV=fc("cc.animation.BindableBoolean")((gV=function(){function t(t){void 0===t&&(t=!1),at(this,"variable",mV,this),at(this,"value",vV,this),this.value=t}return t.prototype.clone=function(){var e=new t;return e.value=this.value,e.variable=this.variable,e},t}(),mV=st((pV=gV).prototype,"variable",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vV=st(pV.prototype,"value",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dV=pV))||dV;function NV(t,e,n,i,r){var o=e.variable,a=e.value;if(!o)return a;var s=t.getVar(o);if(!FV(s,o))return a;if(s.type!==n)throw new AV(o,"number");for(var c=arguments.length,l=new Array(c>5?c-5:0),u=5;u<c;u++)l[u-5]=arguments[u];var h=s.bind.apply(s,[i,r].concat(l));return h}function LV(t,e,n,i,r){var o=e.variable,a=e.value;if(!o)return a;var s=t.getVar(o);if(!FV(s,o))return a;if(n!==yV.FLOAT&&n!==yV.INTEGER)throw new AV(o,"number or integer");for(var c=arguments.length,l=new Array(c>5?c-5:0),u=5;u<c;u++)l[u-5]=arguments[u];var h=s.bind.apply(s,[i,r].concat(l));return h}function FV(t,e){if(t)return!0;throw new SV(e)}var zV,VV,kV,GV,UV,HV,jV,WV,qV,XV,YV,KV,JV,QV,ZV,$V,tk,ek,nk,ik,rk,ok,ak,sk,ck,lk,uk,hk,_k,fk,dk,pk,mk,vk,gk,yk,xk,Sk,Ak,Ck,bk,Tk,Ek,wk=fc("cc.animation.Motion")((MV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"motion",RV,it(e)),at(e,"speed",DV,it(e)),e}return Q(e,t),e.prototype.clone=function(){var t,n,i=new e;return i.motion=null!==(t=null===(n=this.motion)||void 0===n?void 0:n.clone())&&void 0!==t?t:null,i.speed=this.speed.clone(),i},e}(wV),RV=st((IV=MV).prototype,"motion",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DV=st(IV.prototype,"speed",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BV(1)}}),PV=IV))||PV,Pk=Symbol("[[OnAfterDeserialized]]"),Ik=fc("cc.animation.Transition")((HV=function(t){function e(e,n,i){var r;return at(r=t.call(this)||this,"from",kV,it(r)),at(r,"to",GV,it(r)),at(r,"conditions",UV,it(r)),r[$z]=void 0,r.from=e,r.to=n,i&&(r.conditions=i),r}return Q(e,t),e}(cl),kV=st((VV=HV).prototype,"from",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),GV=st(VV.prototype,"to",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),UV=st(VV.prototype,"conditions",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zV=VV))||zV,Rk=fc("cc.animation.AnimationTransition")((JV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"duration",qV,it(e)),at(e,"relativeDuration",XV,it(e)),at(e,"exitConditionEnabled",YV,it(e)),at(e,"_exitCondition",KV,it(e)),e}return Q(e,t),K(e,[{key:"exitCondition",get:function(){return this._exitCondition},set:function(t){this._exitCondition=t}}]),e}(Ik),qV=st((WV=JV).prototype,"duration",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),XV=st(WV.prototype,"relativeDuration",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YV=st(WV.prototype,"exitConditionEnabled",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),KV=st(WV.prototype,"_exitCondition",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jV=WV))||jV;function Dk(t){return t instanceof Rk}var Mk,Bk=fc("cc.animation.StateMachine")((rk=function(t){Q(n,t);var e=n.prototype;function n(){var e;return at(e=t.call(this)||this,"_states",$V,it(e)),at(e,"_transitions",tk,it(e)),at(e,"_entryState",ek,it(e)),at(e,"_exitState",nk,it(e)),at(e,"_anyState",ik,it(e)),e._entryState=e._addState(new EV),e._entryState.name="Entry",e._exitState=e._addState(new EV),e._exitState.name="Exit",e._anyState=e._addState(new EV),e._anyState.name="Any",e}return e.__callOnAfterDeserializeRecursive=function(){this[Pk]();for(var t=this._states.length,e=0;e<t;++e){var n=this._states[e];n instanceof Ok&&n.stateMachine.__callOnAfterDeserializeRecursive()}},e[Pk]=function(){this._states.forEach((function(){})),this._transitions.forEach((function(t){t.from[bV].push(t),t.to[TV].push(t)}))},e[CV]=function(){throw new Error("Method not implemented.")},e.states=function(){return this._states},e.transitions=function(){return this._transitions},e.getTransitionsBetween=function(t,e){return tV(t),tV(e),t[bV].filter((function(t){return t.to===e}))},e.getOutgoings=function(t){return tV(t),t[bV]},e.getIncomings=function(t){return tV(t),t[TV]},e.addMotion=function(){return this._addState(new wk)},e.addSubStateMachine=function(){return this._addState(new Ok)},e.remove=function(t){tV(t),t!==this.entryState&&t!==this.exitState&&t!==this.anyState&&(this.eraseTransitionsIncludes(t),ht(this._states,t))},e.connect=function(t,e,n){if(tV(t),tV(e),e===this.entryState)throw new xV("to-entry");if(e===this.anyState)throw new xV("to-any");if(t===this.exitState)throw new xV("from-exit");var i=t instanceof wk||t===this._anyState?new Rk(t,e,n):new Ik(t,e,n);return this._transitions.push(i),t[bV].push(i),e[TV].push(i),i},e.disconnect=function(t,e){tV(t),tV(e);for(var n=t[bV],i=e[TV],r=this._transitions,o=n.filter((function(t){return t.to===e})),a=o.length,s=function(t){var e=o[t];ht(n,e),ht(r,e),_t(i,(function(t){return t===e}))},c=0;c<a;++c)s(c)},e.removeTransition=function(t){ht(this._transitions,t),_t(t.from[bV],(function(e){return e===t})),_t(t.to[TV],(function(e){return e===t}))},e.eraseOutgoings=function(t){var e=this;tV(t);for(var n=t[bV],i=function(t){var i=n[t],r=i.to;ht(e._transitions,i),_t(r[TV],(function(t){return t===i}))},r=0;r<n.length;++r)i(r);n.length=0},e.eraseIncomings=function(t){var e=this;tV(t);for(var n=t[TV],i=function(t){var i=n[t],r=i.from;ht(e._transitions,i),_t(r[bV],(function(t){return t===i}))},r=0;r<n.length;++r)i(r);n.length=0},e.eraseTransitionsIncludes=function(t){this.eraseIncomings(t),this.eraseOutgoings(t)},e.clone=function(){for(var t,e=new n,i=new Map,r=ot(this._states);!(t=r()).done;){var o=t.value;switch(o){case this._entryState:i.set(o,e._entryState);break;case this._exitState:i.set(o,e._exitState);break;case this._anyState:i.set(o,e._anyState);break;default:if(o instanceof wk||o instanceof Ok){var a=o.clone();e._addState(a),i.set(o,a)}}}for(var s,c=ot(this._transitions);!(s=c()).done;){var l=s.value,u=i.get(l.from),h=i.get(l.to),_=e.connect(u,h);_.conditions=l.conditions.map((function(t){return t.clone()})),_ instanceof Rk&&(_.duration=l.duration,_.exitConditionEnabled=l.exitConditionEnabled,_.exitCondition=l.exitCondition)}return e},e._addState=function(t){return this._states.push(t),t},K(n,[{key:"entryState",get:function(){return this._entryState}},{key:"exitState",get:function(){return this._exitState}},{key:"anyState",get:function(){return this._anyState}}]),n}(cl),$V=st((ZV=rk).prototype,"_states",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tk=st(ZV.prototype,"_transitions",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ek=st(ZV.prototype,"_entryState",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),nk=st(ZV.prototype,"_exitState",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ik=st(ZV.prototype,"_anyState",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QV=ZV))||QV,Ok=fc("cc.animation.SubStateMachine")((ck=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_stateMachine",sk,it(e)),e}return Q(e,t),e.prototype.clone=function(){var t=new e;return t._stateMachine=this._stateMachine.clone(),t},K(e,[{key:"stateMachine",get:function(){return this._stateMachine}}]),e}(wV),sk=st((ak=ck).prototype,"_stateMachine",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bk}}),ok=ak))||ok,Nk=fc("cc.animation.Layer")((mk=function(){function t(){this[$z]=void 0,at(this,"_stateMachine",hk,this),at(this,"name",_k,this),at(this,"weight",fk,this),at(this,"mask",dk,this),at(this,"blending",pk,this),this._stateMachine=new Bk}return K(t,[{key:"stateMachine",get:function(){return this._stateMachine}}]),t}(),hk=st((uk=mk).prototype,"_stateMachine",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_k=st(uk.prototype,"name",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),fk=st(uk.prototype,"weight",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),dk=st(uk.prototype,"mask",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pk=st(uk.prototype,"blending",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mk.additive}}),lk=uk))||lk;!function(t){t[t.override=0]="override",t[t.additive=1]="additive"}(Mk||(Mk={}));var Lk=fc("cc.animation.Variable")((Sk=function(){function t(t){if(at(this,"_type",yk,this),at(this,"_value",xk,this),void 0!==t)switch(this._type=t,t){default:break;case yV.FLOAT:case yV.INTEGER:this._value=0;break;case yV.BOOLEAN:case yV.TRIGGER:this._value=!1}}return K(t,[{key:"type",get:function(){return this._type}},{key:"value",get:function(){return this._value},set:function(t){this._value=t}}]),t}(),yk=st((gk=Sk).prototype,"_type",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yV.FLOAT}}),xk=st(gk.prototype,"_value",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vk=gk))||vk,Fk=fc("cc.animation.AnimationGraph")((Ek=function(t){function e(){var e;return at(e=t.call(this)||this,"_layers",bk,it(e)),at(e,"_variables",Tk,it(e)),e}Q(e,t);var n=e.prototype;return n.onLoaded=function(){for(var t=this._layers,e=t.length,n=0;n<e;++n)t[n].stateMachine.__callOnAfterDeserializeRecursive()},n.addLayer=function(){var t=new Nk;return this._layers.push(t),t},n.removeLayer=function(t){ee.removeAt(this._layers,t)},n.moveLayer=function(t,e){!function(t,e,n){if(re(t,e),re(t,n),e===n)return t;var i=t[e];if(e<n)for(var r=e+1;r<=n;++r)t[r-1]=t[r];else for(var o=e;o!==n;--o)t[o]=t[o-1];t[n]=i}(this._layers,t,e)},n.addVariable=function(t,e,n){var i=new Lk(e);void 0!==n&&(i.value=n),this._variables[t]=i},n.removeVariable=function(t){delete this._variables[t]},n.getVariable=function(t){return this._variables[t]},K(e,[{key:"layers",get:function(){return this._layers}},{key:"variables",get:function(){return Object.entries(this._variables)}}]),e}(Ru),bk=st((Ck=Ek).prototype,"_layers",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tk=st(Ck.prototype,"_variables",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),Ak=Ck))||Ak,zk=Symbol("BakeNodeCurves"),Vk=function(){function t(){}return t.getOrExtract=function(e){var n=t.pool.get(e);if(!n||n.samples!==e.sample){n&&c.director.root.dataPoolManager.releaseAnimationClip(e);var i=Math.ceil(e.sample*e.duration)+1,r=e.sample;n=e[zk](0,r,i),t.pool.set(e,n)}return n},t.destroy=function(e){t.pool.delete(e)},t}();Vk.pool=new Map;var kk=t("RatioSampler",function(){function t(t){var e,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;for(var i=!0,r=1,o=t.length;r<o;r++)if(e=t[r]-t[r-1],1===r)n=e;else if(Math.abs(e-n)>1e-6){i=!1;break}this._findRatio=i?jk:rc}return t.prototype.sample=function(t){return this._findRatio(this.ratios,t)},t}());c.RatioSampler=kk;var Gk=t("AnimCurve",function(){function t(e,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=e.values;var i=function(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?t.Linear:t.Bezier(e):t.Linear};if(void 0!==e.easingMethod)this.type=i(e.easingMethod);else if(Array.isArray(e.easingMethods))this.types=e.easingMethods.map(i);else if(void 0!==e.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(e.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(e.easingMethods[a])}}else this.type=null;var s=e.values[0];(void 0===e.interpolate||e.interpolate)&&(this._lerp=$k(s)),void 0!==e._arrayLength&&(this._array=new Array(e._arrayLength))}t.Bezier=function(t){return t};var e=t.prototype;return e.hasLerp=function(){return!!this._lerp},e.valueAt=function(t){if(void 0===this._array){var e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*t+n];return this._array},e.valueBetween=function(t,e,n,i,r){if(this._lerp){var o=this.types?this.types[e]:this.type,a=r-n,s=(t-n)/a;if(o&&(s=Hk(s,o)),void 0===this._array){var c=this._values[e],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*e+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*e+f];return this._array},e.empty=function(){return 0===this._values.length},e.constant=function(){return 1===this._values.length},t}());function Uk(t,e,n){var i=e.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=e.ratios.length))return t.valueBetween(n,i-1,e.ratios[i-1],i,e.ratios[i]);i=e.ratios.length-1}return t.valueAt(i)}function Hk(t,e){if("string"==typeof e){var n=Z_[e];n?t=n(t):D(3906,e)}else Array.isArray(e)&&(t=Kf(e,t));return t}function jk(t,e){var n=t.length-1;if(0===n)return 0;var i=t[0];if(e<i)return 0;var r=t[n];if(e>r)return n;var o=(e=(e-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}Gk.Linear=null,c.AnimCurve=Gk,t("EventInfo",function(){function t(){this.events=[]}return t.prototype.add=function(t,e){this.events.push({func:t||"",params:e||[]})},t}()),c.sampleAnimationCurve=Uk;var Wk,qk,Xk,Yk,Kk,Jk,Qk,Zk,$k=function(){function t(t,e,n,i){return t.lerp(e,n,i)}return function(e){if(null!==e){if("number"==typeof e)return ln;if("object"==typeof e&&e.constructor){if(e instanceof Nn)return n=new Nn,function(t,e,i){return Nn.slerp(n,t,e,i)};if(e instanceof le)return function(t){var e=new t;return function(n,i,r){return t.lerp(e,n,i,r),e}}(e.constructor);if(e.constructor===Number)return ln;if("function"==typeof e.lerp)return t}var n}}}(),tG=fc("cc.animation.UntypedTrackChannel")((Yk=function(t){function e(){var e;return at(e=t.call(this,new ff)||this,"property",Xk,it(e)),e}return Q(e,t),e}(bz),Xk=st((qk=Yk).prototype,"property",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Wk=qk))||Wk,eG=fc("cc.animation.UntypedTrack")((Zk=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_channels",Qk,it(e)),e}Q(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[vz]=function(t){var e=this;if(!t.getValue)throw new Error(N(3930));var n=function(t){var n;return null===(n=e._channels.find((function(e){return e.property===t})))||void 0===n?void 0:n.curve},i=t.getValue();switch(!0){default:throw new Error(N(3931));case i instanceof Xn:return new Gz(n("x"),n("y"));case i instanceof Pn:return new Uz(n("x"),n("y"),n("z"));case i instanceof Qn:return new Hz(n("x"),n("y"),n("z"),n("w"));case i instanceof En:return new Yz(n("r"),n("g"),n("b"),n("a"));case i instanceof ti:return new Qz(n("width"),n("height"))}},n.addChannel=function(t){var e=new tG;return e.property=t,this._channels.push(e),e},n.upgrade=function(t){var e=this,n=function(t,n){var i=e.channels().find((function(e){return e.property===t}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=t(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new kz;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new Xz,h=u.channels(),_=h[0],f=h[1],d=h[2],p=h[3];return n("r",_),n("g",f),n("b",d),n("a",p),n("x",_),n("y",f),n("z",d),n("w",p),u;case"size":}return null},e}(Cz),Qk=st((Jk=Zk).prototype,"_channels",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kk=Jk))||Kk,nG=function(){function t(t){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}var e=t.prototype;return e.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},e.toTracks=function(){for(var t,e=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(t,e,n){for(var i,r=new Sz,o=ot(e);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof MF?r.toHierarchy(a.path):a instanceof BF?r.toComponent(a.component):r.toCustomized(a)}t.path=r,t.proxy=n},a=r.map((function(t){var n=new eG;return o(n,t.modifiers,t.valueAdapter),e.push(n),n})),s=function(){var i,r=t.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new rG(s,l.length),f=function(t){o(t,r.modifiers,r.valueAdapter)},d=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(t){return"number"==typeof t})))return I(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return I(3933),"continue";var p=r.modifiers[0],m=a[r.commonTarget].addChannel(p).curve;d=m}!function(){if("number"==typeof u){if(!c.every((function(t){return"number"==typeof t})))return void I(3934);var t;if(d)t=d;else{var n=new wz;f(n),e.push(n),t=n.channel.curve}var i=h?tl.LINEAR:tl.CONSTANT;return t.assignSorted(l,c.map((function(t){return{value:t,interpolationMode:i}}))),void _.convert(t)}if("object"==typeof u)switch(!0){default:break;case iG(c,Xn):case iG(c,Pn):case iG(c,Qn):var r=u instanceof Xn?2:u instanceof Pn?3:4,o=new kz;f(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,p=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?tl.LINEAR:tl.CONSTANT,y=function(t){return{value:t,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(t){return y(t.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(t){return y(t.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(t){return y(t.x)}))),_.convert(s),p.assignSorted(l,c.map((function(t){return y(t.y)}))),_.convert(p)}return void e.push(o);case iG(c,Nn):var x=new jz;f(x);var S=h?Uf.SLERP:Uf.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(t){return{value:Nn.clone(t),interpolationMode:S}}))),_.convertQuatCurve(x.channel.curve),void e.push(x);case iG(c,En):var A=new Xz;f(A);var C=A.channels(),b=C[0].curve,T=C[1].curve,E=C[2].curve,w=C[3].curve,P=h?tl.LINEAR:tl.CONSTANT,R=function(t){return{value:t,interpolationMode:P}};return b.assignSorted(l,c.map((function(t){return R(t.r)}))),_.convert(b),T.assignSorted(l,c.map((function(t){return R(t.g)}))),_.convert(T),E.assignSorted(l,c.map((function(t){return R(t.b)}))),_.convert(E),w.assignSorted(l,c.map((function(t){return R(t.a)}))),_.convert(w),void e.push(A);case iG(c,ti):var D=new Jz;f(D);var M=D.channels(),B=M[0].curve,O=M[1].curve,N=h?tl.LINEAR:tl.CONSTANT,L=function(t){return{value:t,interpolationMode:N}};return B.assignSorted(l,c.map((function(t){return L(t.width)}))),_.convert(B),O.assignSorted(l,c.map((function(t){return L(t.height)}))),_.convert(O),void e.push(D);case iG(c,HF):var F=new wz;f(F);var z=h?tl.CUBIC:tl.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(t){return{value:t.dataPoint,leftTangent:t.inTangent,rightTangent:t.outTangent,interpolationMode:z}}))),void e.push(F);case iG(c,VF):case iG(c,kF):case iG(c,GF):var V=u instanceof VF?2:u instanceof kF?3:4,k=new kz;f(k),k.componentsCount=V;var G=k.channels(),U=G[0],H=G[1],j=G[2],W=G[3],q=h?tl.LINEAR:tl.CONSTANT,X=function(t,e,n){return{value:t,leftTangent:e,rightTangent:n,interpolationMode:q}};switch(V){case 4:W.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.w,t.inTangent.w,t.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.z,t.inTangent.z,t.outTangent.z)})));default:U.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.y,t.inTangent.y,t.outTangent.y)}))),H.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.x,t.inTangent.x,t.outTangent.x)})))}return void e.push(k);case c.every((function(t){return t instanceof UF})):I(3935)}var Y=new Zz;f(Y),Y.channel.curve.assignSorted(l,c),e.push(Y)}()},c=ot(i);!(t=c()).done;)s();return e},e._createPropertyCurves=function(){var t=this;this._ratioSamplers=this._keys.map((function(e){return new kk(e.map((function(e){return e/t._duration})))})),this._runtimeCurves=this._curves.map((function(e){return{curve:new Gk(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys],commonTarget:e.commonTarget}}))},K(t,[{key:"keys",get:function(){return this._keys},set:function(t){this._keys=t}},{key:"curves",get:function(){return this._curves},set:function(t){this._curves=t,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(t){this._commonTargets=t}},{key:"data",get:function(){return this._data}}]),t}();function iG(t,e){return t.every((function(t){return t instanceof e}))}var rG=function(){function t(t,e){this._easingMethods=void 0;var n=t.easingMethods;Array.isArray(n)?0===n.length&&0!==e?this._easingMethods=new Array(e).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(e).fill(t.easingMethod):Array.from({length:e},(function(t,e){var i;return null!==(i=n[e])&&void 0!==i?i:null}))}var e=t.prototype;return e.convert=function(t){var e,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g,y,x,S,A,C=this._easingMethods;if(C){var b=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(C)&&C.length;for(var T=b-1,E=0;E<T;++E){var w=C[E];w&&(Array.isArray(w)?(e=w,n=t.getKeyframeTime(E),i=t.getKeyframeValue(E),r=t.getKeyframeTime(E+1),o=t.getKeyframeValue(E+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,d=void 0,p=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,A=void 0,s=e[0],c=e[1],l=e[2],u=e[3],h=i.value,_=3*(r-n),f=3*(o.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(p=c*f)/(d=s*_),x=Math.sqrt(d*d+p*p)*g,S=v/m,A=Math.sqrt(m*m+v*v)*g,i.interpolationMode=tl.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===nl.NONE?nl.RIGHT:a===nl.LEFT?nl.BOTH:a,i.rightTangent=y,i.rightTangentWeight=x,o.tangentWeightMode=function(t){return t===nl.NONE?nl.LEFT:t===nl.RIGHT?nl.BOTH:t}(o.tangentWeightMode),o.leftTangent=S,o.leftTangentWeight=A):oG(w,t,E))}}}},e.convertQuatCurve=function(t){var e=this._easingMethods;if(e){var n=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(e)&&e.length;for(var i=n-1,r=0;r<i;++r){var o=e[r];o&&(Array.isArray(o)?t.getKeyframeValue(r).easingMethod=o.slice():aG(o,t,r))}}}},K(t,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(t){return null==t}))}}]),t}();function oG(t,e,n){e.keyFramesCount;var i=e.getKeyframeValue(n),r=LG[t];r===Q_.CONSTANT?i.interpolationMode=tl.CONSTANT:(i.interpolationMode=tl.LINEAR,i.easingMethod=r)}function aG(t,e,n){e.keyFramesCount;var i=e.getKeyframeValue(n),r=LG[t];i.easingMethod=r}var sG,cG,lG,uG,hG,_G,fG,dG,pG,mG,vG,gG,yG,xG,SG,AG,CG,bG,TG,EG,wG,PG,IG,RG,DG,MG,BG,OG,NG,LG={constant:Q_.CONSTANT,linear:Q_.LINEAR,quadIn:Q_.QUAD_IN,quadOut:Q_.QUAD_OUT,quadInOut:Q_.QUAD_IN_OUT,quadOutIn:Q_.QUAD_OUT_IN,cubicIn:Q_.CUBIC_IN,cubicOut:Q_.CUBIC_OUT,cubicInOut:Q_.CUBIC_IN_OUT,cubicOutIn:Q_.CUBIC_OUT_IN,quartIn:Q_.QUART_IN,quartOut:Q_.QUART_OUT,quartInOut:Q_.QUART_IN_OUT,quartOutIn:Q_.QUART_OUT_IN,quintIn:Q_.QUINT_IN,quintOut:Q_.QUINT_OUT,quintInOut:Q_.QUINT_IN_OUT,quintOutIn:Q_.QUINT_OUT_IN,sineIn:Q_.SINE_IN,sineOut:Q_.SINE_OUT,sineInOut:Q_.SINE_IN_OUT,sineOutIn:Q_.SINE_OUT_IN,expoIn:Q_.EXPO_IN,expoOut:Q_.EXPO_OUT,expoInOut:Q_.EXPO_IN_OUT,expoOutIn:Q_.EXPO_OUT_IN,circIn:Q_.CIRC_IN,circOut:Q_.CIRC_OUT,circInOut:Q_.CIRC_IN_OUT,circOutIn:Q_.CIRC_OUT_IN,elasticIn:Q_.ELASTIC_IN,elasticOut:Q_.ELASTIC_OUT,elasticInOut:Q_.ELASTIC_IN_OUT,elasticOutIn:Q_.ELASTIC_OUT_IN,backIn:Q_.BACK_IN,backOut:Q_.BACK_OUT,backInOut:Q_.BACK_IN_OUT,backOutIn:Q_.BACK_OUT_IN,bounceIn:Q_.BOUNCE_IN,bounceOut:Q_.BOUNCE_OUT,bounceInOut:Q_.BOUNCE_IN_OUT,bounceOutIn:Q_.BOUNCE_OUT_IN,smooth:Q_.SMOOTH,fade:Q_.FADE};function FG(){throw new Error("split() only valid in Editor.")}fc("cc.animation.ExoticAnimation")((lG=function(){function t(){at(this,"_nodeAnimations",cG,this)}var e=t.prototype;return e.createEvaluator=function(t){return new XG(this._nodeAnimations,t)},e.addNodeAnimation=function(t){var e=new zG(t);return this._nodeAnimations.push(e),e},e.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(t){return t.path}))))},e.split=function(){return FG()},e.toHashString=function(){return this._nodeAnimations.map((function(t){return t.toHashString()})).join("\n")},t}(),cG=st((sG=lG).prototype,"_nodeAnimations",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sG));var zG=fc("cc.animation.ExoticNodeAnimation")((mG=function(){function t(t){at(this,"_path",_G,this),at(this,"_position",fG,this),at(this,"_rotation",dG,this),at(this,"_scale",pG,this),this._path=t}var e=t.prototype;return e.createPosition=function(t,e){this._position=new jG(t,new UG(e))},e.createRotation=function(t,e){this._rotation=new jG(t,new HG(e))},e.createScale=function(t,e){this._scale=new jG(t,new UG(e))},e.createEvaluator=function(t){return new YG(this._path,this._position,this._rotation,this._scale,t)},e.split=function(){return FG()},e.toHashString=function(){var t,e,n,i,r,o;return this._path+"\n"+(null!==(t=null===(e=this._position)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},K(t,[{key:"path",get:function(){return this._path}}]),t}(),_G=st((hG=mG).prototype,"_path",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),fG=st(hG.prototype,"_position",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dG=st(hG.prototype,"_rotation",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pG=st(hG.prototype,"_scale",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uG=hG))||uG;function VG(t){return t.toPrecision(2)}function kG(t){return t.map(VG).join(" ")}var GG=fc("cc.animation.ExoticVectorLikeTrackValues")((SG=function(){function t(t){at(this,"_values",yG,this),at(this,"_isQuantized",xG,this),this._values=t,this._isQuantized=!1}var e=t.prototype;return e.quantize=function(t){this._isQuantized,this._values=function(t,e){var n=JG[e],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;t.forEach((function(t){r=Math.min(t,r),o=Math.max(t,o)}));var a=o-r,s=n.from(t,(function(t){return(t-r)/a*i}));return new hU(QG(t),s,a,r)}(this._values,t),this._isQuantized=!0},e.toHashString=function(){var t=this._isQuantized,e=this._values;return t+" "+(t?e.toHashString():kG(e))},K(t,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:QG(this._values)}}]),t}(),yG=st((gG=SG).prototype,"_values",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),xG=st(gG.prototype,"_isQuantized",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),vG=gG))||vG,UG=fc("cc.animation.ExoticVec3TrackValues")(AG=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t),e.imitate=function(t,n){var i=new e(t);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=e.prototype;return n.get=function(t,e){var n=this._values;this._isQuantized?dU(n,t,e):Pn.fromArray(e,n,3*t)},n.lerp=function(t,e,n,i,r,o){var a=this._values;this._isQuantized?(dU(a,t,i),dU(a,e,r)):(Pn.fromArray(i,a,3*t),Pn.fromArray(r,a,3*e)),Pn.lerp(o,i,r,n)},e}(GG))||AG,HG=fc("cc.animation.ExoticQuatTrackValues")(CG=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t),e.imitate=function(t,n){var i=new e(t);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=e.prototype;return n.get=function(t,e){var n=this._values;this._isQuantized?pU(n,t,e):Nn.fromArray(e,n,4*t)},n.lerp=function(t,e,n,i,r,o){var a=this._values;this._isQuantized?(pU(a,t,i),pU(a,e,r)):(Nn.fromArray(i,a,4*t),Nn.fromArray(r,a,4*e)),Nn.slerp(o,i,r,n)},e}(GG))||CG,jG=fc("cc.animation.ExoticTrack")((PG=function(){function t(t,e){at(this,"times",EG,this),at(this,"values",wG,this),this.times=t,this.values=e}return t.prototype.toHashString=function(){var t=this.times,e=this.values;return"times: "+kG(t)+"; values: "+e.toHashString()},t}(),EG=st((TG=PG).prototype,"times",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),wG=st(TG.prototype,"values",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),bG=TG))||bG;function WG(t,e){t.length,t.length;var n=0,i=0,r=rc(t,e);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=t[o],c=t[a];i=(e-c)/(s-c)}return{index:n,ratio:i}}!function(){function t(){this._reset()}var e=t.prototype;e.transformTime=function(t){return t-this._timeOffset},e.calculate=function(t,e,n){this._reset();var i=t.length;if(i){var r=t[0],o=t[i-1],a=sn(e,r,o),s=sn(n,r,o);this._timeOffset=a;var c=function(t,e,n){var i=t.length;n>=e&&e>=t[0]&&t[i-1];var r=WG(t,e),o=r.index,a=r.ratio,s=WG(t,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(t,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,d=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,d||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},e._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},K(t,[{key:"keyframesCount",get:function(){var t=this.preLerpIndex,e=this.directKeyframesBegin;return 0+(t<0?0:1)+(this.directKeyframesEnd-e)+(this.postLerpIndex<0?0:1)}}])}();var qG,XG=function(){function t(t,e){this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((function(t){return t.createEvaluator(e)}))}return t.prototype.evaluate=function(t){this._nodeEvaluations.forEach((function(e){e.evaluate(t)}))},t}(),YG=function(){function t(t,e,n,i,r){this._position=null,this._rotation=null,this._scale=null,e&&(this._position=fU(e.times,e.values,Pn,t,"position",r)),n&&(this._rotation=fU(n.times,n.values,Nn,t,"rotation",r)),i&&(this._scale=fU(i.times,i.values,Pn,t,"scale",r))}return t.prototype.evaluate=function(t){if(this._position){var e=this._position.evaluator.evaluate(t);this._position.runtimeBinding.setValue(e)}if(this._rotation){var n=this._rotation.evaluator.evaluate(t);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(t);this._scale.runtimeBinding.setValue(i)}},t}(),KG=function(){function t(t,e,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=e,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return t.prototype.evaluate=function(t){var e=this._times,n=this._values,i=this._resultValue;if(0===e.length)return i;var r=function(t,e,n){var i=t.length,r=t[0],o=t[i-1];if(e<r)n.just=!0,n.index=0;else if(e>o)n.just=!0,n.index=i-1;else{var a=rc(t,e);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=t[c],u=t[s],h=(e-t[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(e,t,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},t}(),JG={uint8:Uint8Array,uint16:Uint16Array};function QG(t){switch(t.BYTES_PER_ELEMENT){default:case 4:return qG.FLOAT_32;case 8:return qG.FLOAT_64}}!function(t){t[t.FLOAT_32=0]="FLOAT_32",t[t.FLOAT_64=1]="FLOAT_64"}(qG||(qG={}));var ZG,$G,tU,eU,nU,iU,rU,oU,aU,sU,cU,lU,uU,hU=fc("cc.animation.QuantizedFloatArray")((NG=function(){function t(t,e,n,i){void 0===i&&(i=0),at(this,"originalPrecision",DG,this),at(this,"min",MG,this),at(this,"extent",BG,this),at(this,"values",OG,this),this.originalPrecision=t,this.values=e,this.extent=n,this.min=i}return t.prototype.toHashString=function(){var t=this.originalPrecision,e=this.min,n=this.extent,i=this.values;return t+" "+VG(e)+" "+VG(n)+" "+i.join(" ")},K(t,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),t}(),DG=st((RG=NG).prototype,"originalPrecision",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),MG=st(RG.prototype,"min",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),BG=st(RG.prototype,"extent",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),OG=st(RG.prototype,"values",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),IG=RG))||IG;function _U(t,e){return t.values[e]/(1<<t.values.BYTES_PER_ELEMENT)*t.extent+t.min}function fU(t,e,n,i,r,o){var a=new Az;a.path=(new Sz).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new KG(t,e,n)}:null}function dU(t,e,n){Pn.set(n,_U(t,3*e+0),_U(t,3*e+1),_U(t,3*e+2))}function pU(t,e,n){Nn.set(n,_U(t,4*e+0),_U(t,4*e+1),_U(t,4*e+2),_U(t,4*e+3))}var mU=Symbol("SearchForRootBonePath"),vU=Symbol("ExoticAnimation"),gU=t("AnimationClip",fc("cc.AnimationClip")((uU=lU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"sample",tU,it(e)),at(e,"speed",eU,it(e)),at(e,"wrapMode",nU,it(e)),at(e,"enableTrsBlending",iU,it(e)),at(e,"_duration",rU,it(e)),at(e,"_hash",oU,it(e)),e.frameRate=0,at(e,"_tracks",aU,it(e)),at(e,"_exoticAnimation",sU,it(e)),e._legacyData=void 0,e._legacyDataDirty=!1,at(e,"_events",cU,it(e)),e._runtimeEvents={ratios:[],eventGroups:[]},e}Q(e,t),e.createWithSpriteFrames=function(t,n){var i=new e;i.sample=n||i.sample,i.duration=t.length/i.sample;var r=1/i.sample,o=new Zz;return o.path=(new Sz).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(t.map((function(t,e){return[r*e,t]}))),i.addTrack(o),i};var n=e.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var t={min:1/0,max:-1/0},e=this._tracks,n=e.length,i=0;i<n;++i){var r=e[i].range();t.min=Math.min(t.min,r.min),t.max=Math.max(t.max,r.max)}return t},n.getTrack=function(t){return this._tracks[t]},n.addTrack=function(t){var e=this._tracks.length;return this._tracks.push(t),e},n.removeTrack=function(t){this._tracks.splice(t,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(t){return new EU(t,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(t){var e=this,n=t.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,e.enableTrsBlending?t.pose:void 0,!1);return null!=r?r:void 0}),t.rootMotion)},n.destroy=function(){var e;return(null===(e=c.director.root)||void 0===e?void 0:e.dataPoolManager)&&c.director.root.dataPoolManager.releaseAnimationClip(this),Vk.destroy(this),t.prototype.destroy.call(this)},n[zk]=function(t,e,n){for(var i=1/e,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new Hn}))};var c=r.reduce((function(t,e){return t[e]=new SU,t}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var d=this._createEvalWithBinder(void 0,(function(t){var e=t.parseTrsPath();if(e){var n=c[e.node];if(n)return TU(n,e.property)}}),void 0),p=0;p<n;++p){var m=t+i*p;d.evaluate(m);for(var v=0;v<o;++v){var g=r[v];Hn.copy(a[g].transforms[p],c[g].globalTransform)}for(var y=0;y<o;++y){var x=r[y];c[x].invalidate()}}return{samples:e,frames:n,joints:a}},n.upgradeUntypedTracks=function(t){for(var e=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof eG){var s=a.upgrade(t);s&&(e.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)ee.remove(i,n[l]);i.push.apply(i,e)},n[mU]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(t,e,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(t,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(t){return 0===t.curve.keyFramesCount}))){var h=e(u[xz]);if(h){var _=u[vz](h);a.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(e)),new yU(a,o,i)},n._createRootMotionEvaluation=function(t,e,n){if(t instanceof kT){var i=this._searchForRootBonePath();if(i){var r=t.getChildByPath(i);if(r){for(var o=new xU,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[xz].parseTrsPath();if(h&&h.node===i){n.push(u);var _=TU(o,h.property);if(_){var f=u[vz](_);a.push({binding:_,trackEval:f})}}}return new CU(r,this._duration,o,a)}I(3924)}else I(3923)}else D(3920)},n._searchForRootBonePath=function(){var t=this._tracks.map((function(t){var e=t[xz].parseTrsPath();if(e){var n=e.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));t.sort((function(t,e){return t.rank-e.rank}));var e=t.findIndex((function(t){return 0!==t.rank}));if(e<0)return"";for(var n=t.length,i=t[e],r=!0,o=e+1;o<n;++o){var a=t[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var t=new nG(this._duration);return t.keys=[],t.curves=[],t.commonTargets=[],t},n._fromLegacy=function(t){for(var e=t.toTracks(),n=e.length,i=0;i<n;++i)this.addTrack(e[i])},n._collectAnimatedJoints=function(){for(var t=new Set,e=this._tracks,n=e.length,i=0;i<n;++i){var r=e[i][xz].parseTrsPath();r&&t.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)t.add(o[s]);return Array.from(t)},K(e,[{key:"duration",get:function(){return this._duration},set:function(t){this._duration=t}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var t,e;if(this._hash)return this._hash;var n="Exotic:"+(null!==(t=null===(e=this._exoticAnimation)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"");return this._hash=vo(n,666)}},{key:"events",get:function(){return this._events},set:function(t){var e=this;this._events=t;for(var n=[],i=[],r=this.events.sort((function(t,e){return t.frame-e.frame})),o=r.length,a=function(t){var o=r[t],a=o.frame/e._duration,s=n.findIndex((function(t){return t===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:vU,get:function(){return this._exoticAnimation}},{key:vU,set:function(t){this._exoticAnimation=t}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().keys=t}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(t){this._getLegacyData().curves=t}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=t}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),e}(Ru),lU.WrapMode=Zs,tU=st(($G=uU).prototype,"sample",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),eU=st($G.prototype,"speed",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nU=st($G.prototype,"wrapMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zs.Normal}}),iU=st($G.prototype,"enableTrsBlending",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rU=st($G.prototype,"_duration",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oU=st($G.prototype,"_hash",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aU=st($G.prototype,"_tracks",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sU=st($G.prototype,"_exoticAnimation",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cU=st($G.prototype,"_events",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZG=$G))||ZG);c.AnimationClip=gU;var yU=function(){function t(t,e,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=e,this._rootMotionEvaluation=n}var e=t.prototype;return e.evaluate=function(t){for(var e=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=e.length,r=0;r<i;++r){var o=e[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}n&&n.evaluate(t)},e.evaluateRootMotion=function(t,e){var n=this._rootMotionEvaluation;n&&n.evaluate(t,e)},t}(),xU=function(){function t(){this.position=new Pn,this.scale=new Pn(1,1,1),this.rotation=new Nn,this.eulerAngles=new Pn}return t.prototype.getTransform=function(t){Hn.fromRTS(t,this.rotation,this.position,this.scale)},t}(),SU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).parent=null,e._dirty=!0,e._transform=new Hn,e}return Q(e,t),e.prototype.invalidate=function(){this._dirty=!0},K(e,[{key:"globalTransform",get:function(){var t=this._transform;return this._dirty&&(this._dirty=!1,Hn.fromRTS(t,this.rotation,this.position,this.scale),this.parent&&Hn.multiply(t,this.parent.globalTransform,t)),this._transform}}]),e}(xU),AU=new Hn,CU=function(){function t(t,e,n,i){this._initialTransformCache=new Hn,this._clipEndTransformCache=new Hn,this._startTransformCache=new Hn,this._endTransformCache=new Hn,this._motionTransformCache=new Hn,this._translationMotionCache=new Pn,this._rotationMotionCache=new Nn,this._scaleMotionCache=new Pn,this._rootBone=t,this._duration=e,this._boneTransform=n,this._trackEvalStatuses=i}var e=t.prototype;return e.evaluate=function(t,e){var n=this._calcMotionTransform(t,e,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;Hn.toRTS(n,r,i,o),Pn.add(i,i,a.position),a.setPosition(i),Nn.multiply(r,r,a.rotation),a.setRotation(r),Pn.multiply(o,o,a.scale),a.setScale(o)},e._calcMotionTransform=function(t,e,n){var i=this._duration,r=i-t,o=this._evaluateAt(t,this._startTransformCache);if(e<r){var a=this._evaluateAt(t+e,this._endTransformCache);bU(n,o,a)}else{Hn.identity(n);var s=function(t,e){bU(AU,t,e),Hn.multiply(n,n,AU)},c=e-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(o,_),bU(AU,h,_);for(var d=0;d<l;++d)Hn.multiply(n,n,AU);s(h,f)}return n},e._evaluateAt=function(t,e){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}return this._boneTransform.getTransform(e),e},t}();function bU(t,e,n){Hn.invert(t,e),Hn.multiply(t,n,t)}function TU(t,e){switch(e){default:return;case"position":return{setValue:function(e){Pn.copy(t.position,e)}};case"rotation":return{setValue:function(e){Nn.copy(t.rotation,e)}};case"scale":return{setValue:function(e){Pn.copy(t.scale,e)}};case"eulerAngles":return{setValue:function(e){Pn.copy(t.eulerAngles,e)}}}}var EU=function(){function t(t,e,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=e,this._eventGroups=n,this._wrapMode=i}var e=t.prototype;return e.setWrapMode=function(t){this._wrapMode=t},e.ignore=function(t,e){this._ignoreIndex=-1,this._sampled=!1;var n=PU(t,this._ratios);n<0&&(n=~n-1,e<0&&(n+=1),this._ignoreIndex=n)},e.sample=function(t,e,n){var i=this._eventGroups.length,r=PU(t,this._ratios);if(r<0&&(r=~r-1,e<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=e);var o=this._wrapMode,a=wU(n),s=wU(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){e=l;do{if(c!==r){if(-1===e&&0===c&&r>0?((o&Qs.PingPong)===Qs.PingPong?e*=-1:c=i,s++):1===e&&c===i-1&&r<i-1&&((o&Qs.PingPong)===Qs.PingPong?e*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=e,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=e},e._doFire=function(t,e){e?c.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[t]):this._checkAndFire(t)},e._checkAndFire=function(t){if(this._targetNode&&this._targetNode.isValid){var e=this._eventGroups;if(!(t<0||t>=e.length||this._ignoreIndex===t))for(var n=e[t],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},t}();function wU(t){return t-(0|t)==0&&(t-=1),0|t}function PU(t,e){return rc(e,t)}var IU,RU=function(){function t(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var e=t.prototype;return e.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(N(3912)):(this._isPlaying=!0,this.onPlay())},e.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},e.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},e.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},e.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},e.update=function(){},e.onPlay=function(){},e.onPause=function(){},e.onResume=function(){},e.onStop=function(){},e.onError=function(){},K(t,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),t}(),DU=function(){function t(t){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this._blendStateWriters.length;++t)this._pose.destroyWriter(this._blendStateWriters[t]);this._blendStateWriters.length=0},e.createPoseWriter=function(t,e,n){var i=this._pose.createWriter(t,e,this,n);return this._blendStateWriters.push(i),i},t}();!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(IU||(IU={})),ce(IU);var MU=t("AnimationState",function(t){function e(e,n){var i;return void 0===n&&(n=""),(i=t.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=Zs.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new ic,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=e,i._name=n||e&&e.name,i._playbackRange={min:0,max:e.duration},i._playbackDuration=e.duration,e.duration||A("Clip "+e.name+" has zero duration."),i}Q(e,t);var n=e.prototype;return n.initialize=function(t,e){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=t;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&Qs.Loop)===Qs.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var i,r,o,a=null!==(i=null!=e?e:null===(r=c.director.getAnimationManager())||void 0===r?void 0:r.blendState)&&void 0!==i?i:null;a&&(this._poseOutput=new DU(a)),this._clipEval=n.createEvaluator({target:t,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||c.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];c.director.getAnimationManager().pushDelayEvent(this._emit,this,e)},n.on=function(t,e,n){return this._target&&this._target.isValid?this._target.on(t,e,n):null},n.once=function(t,e,n){return this._target&&this._target.isValid?this._target.once(t,e,n):null},n.off=function(t,e,n){this._target&&this._target.isValid&&this._target.off(t,e,n)},n.allowLastFrameEvent=function(t){this._allowLastFrame=t},n._setEventTarget=function(t){this._target=t},n.setTime=function(t){this._currentFramePlayed=!1,this.time=t||0;var e,n=this.getWrappedInfo(t,this._wrappedInfo);null===(e=this._clipEventEval)||void 0===e||e.ignore(n.ratio,n.direction)},n.update=function(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.time),this._sampleEvents(t),t},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(IU.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(IU.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(IU.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(IU.PAUSE,this)},n._sampleCurves=function(t){var e=this._poseOutput,n=this._clipEval;e&&(e.weight=this.weight),n&&n.evaluate(t)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var t,e=this.sample();this._allowLastFrame&&(t=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new ic(e),this.repeatCount>1&&(0|e.iterations)>(0|t.iterations)&&this.emit(IU.LASTFRAME,this),t.set(e)),e.stopped&&(this.stop(),this.emit(IU.FINISHED,this))},n.simpleProcess=function(){var t=this._playbackRange.min,e=this._playbackDuration,n=this.time%e;n<0&&(n+=e);var i=(t+n)*this._invDuration;this._sampleCurves(t+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(IU.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(t){var e=this.wrapMode,n=!1;return(e&Qs.PingPong)===Qs.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(n=!n)),(e&Qs.Reverse)===Qs.Reverse&&(n=!n),n},n.getWrappedInfo=function(t,e){e=e||new ic;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(t-=n)>0?t/i:-t/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),t=s*i*(t>0?1:-1)}if(t>i){var c=t%i;t=0===c?i:c}else t<0&&0!=(t%=i)&&(t+=i);var l=!1,u=this._wrapMode&Qs.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(t=i-t),e.time=n+t,e.ratio=e.time/this.duration,e.direction=h,e.stopped=r,e.iterations=a,e},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(t){var e;null===(e=this._clipEventEval)||void 0===e||e.sample(t.ratio,t.direction,t.iterations)},n._emit=function(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)},n._onReplayOrResume=function(){c.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){c.director.getAnimationManager().removeAnimation(this)},K(e,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(t){var e;this._wrapMode=t,this.time=0,t&Qs.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(e=this._clipEventEval)||void 0===e||e.setWrapMode(t)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t;var e=this._wrapMode&Qs.ShouldWrap,n=(this.wrapMode&Qs.Reverse)===Qs.Reverse;this._useSimpleProcess=t===1/0&&!e&&!n}},{key:"delay",get:function(){return this._delay},set:function(t){this._delayTime=this._delay=t}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(t){this._weight=t,this._poseOutput&&(this._poseOutput.weight=t)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),e}(RU));c.AnimationState=MU;var BU,OU,NU,LU,FU,zU=kU,VU=kU;function kU(){}BU=fc("cc.animation.ClipMotion"),OU=Xc(gU),BU((FU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"clip",LU,it(e)),e}Q(e,t);var n=e.prototype;return n[CV]=function(t){return this.clip?new aH(t,this.clip):null},n.clone=function(){var t=new e;return t.clip=this.clip,t},e}(cl),LU=st((NU=FU).prototype,"clip",[OU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NU));var GU,UU,HU,jU,WU,qU,XU,YU,KU,JU,QU,ZU,$U,tH,eH,nH,iH,rH,oH,aH=function(){function t(t,e){this.duration=e.duration,this._state=new MU(e),this._state.initialize(t.node,t.blendBuffer)}var e=t.prototype;return e.getClipStatuses=function(t){var e=this,n=!1;return{next:function(){return n?{done:!0,value:void 0}:(n=!0,{done:!1,value:{__DEBUG_ID__:e.__DEBUG__ID__,clip:e._state.clip,weight:t}})}}},e.sample=function(t,e){if(0!==e){this._state.name;var n=this._state.duration*t;this._state.time=n,this._state.weight=e,this._state.sample(),this._state.weight=0}},K(t,[{key:"progress",get:function(){return this._state.time/this.duration}}]),t}(),sH=fc("cc.animation.AnimationBlendItem")((jU=function(){function t(){at(this,"motion",HU,this)}var e=t.prototype;return e.clone=function(){var e=new t;return this._assign(e),e},e._assign=function(t){var e,n;return t.motion=null!==(e=null===(n=this.motion)||void 0===n?void 0:n.clone())&&void 0!==e?e:null,t},t}(),HU=st((UU=jU).prototype,"motion",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GU=UU))||GU,cH=fc("cc.animation.AnimationBlend")((YU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"name",XU,it(e)),e}return Q(e,t),e}(cl),XU=st((qU=YU).prototype,"name",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),WU=qU))||WU,lH=function(){function t(t,e,n){this._childEvaluators=e.map((function(e){var n,i;return null!==(n=null===(i=e.motion)||void 0===i?void 0:i[CV](t))&&void 0!==n?n:null})),this._weights=new Array(this._childEvaluators.length).fill(0),this._inputs=[].concat(n)}var e=t.prototype;return e.getClipStatuses=function(t){var e,n=this._childEvaluators,i=this._weights,r=n.length,o=0;return{next:function(){for(;;){if(e){var a=e.next();if(!a.done)return a}if(o>=r)return{done:!0,value:void 0};var s=n[o];e=null==s?void 0:s.getClipStatuses(t*i[o]),++o}}}},e.sample=function(t,e){for(var n=0;n<this._childEvaluators.length;++n){var i;null===(i=this._childEvaluators[n])||void 0===i||i.sample(t,e*this._weights[n])}},e.setInput=function(t,e){this._inputs[e]=t,this.doEval()},e.doEval=function(){this.eval(this._weights,this._inputs)},e.eval=function(){},K(t,[{key:"duration",get:function(){for(var t=0,e=0;e<this._childEvaluators.length;++e){var n,i;t+=(null!==(n=null===(i=this._childEvaluators[e])||void 0===i?void 0:i.duration)&&void 0!==n?n:0)*this._weights[e]}return t}}]),t}(),uH=fc("cc.animation.AnimationBlend1DItem")((ZU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"threshold",QU,it(e)),e}Q(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return this._assign(t),t},n._assign=function(e){return t.prototype._assign.call(this,e),e.threshold=this.threshold,e},e}(sH),QU=st((JU=ZU).prototype,"threshold",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KU=JU))||KU,hH=(fc("cc.animation.AnimationBlend1D")((iH=nH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_items",tH,it(e)),at(e,"param",eH,it(e)),e}Q(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return t._items=this._items.map((function(t){return t.clone()})),t.param=this.param.clone(),t},n[CV]=function(t){var e=new hH(t,this._items,this._items.map((function(t){return t.threshold})),0),n=NV(t,this.param,yV.FLOAT,e.setInput,e,0);return e.setInput(n,0),e},K(e,[{key:"items",get:function(){return this._items},set:function(t){this._items=Array.from(t).sort((function(t,e){return t.threshold-e.threshold}))}}]),e}(cH),nH.Item=uH,tH=st(($U=iH).prototype,"_items",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eH=st($U.prototype,"param",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BV}}),$U)),function(t){function e(e,n,i,r){var o;return(o=t.call(this,e,n,[r])||this)._thresholds=i,o.doEval(),o}return Q(e,t),e.prototype.eval=function(t,e){var n=e[0];!function(t,e,n){if(t.fill(0),0===e.length);else if(n<=e[0])t[0]=1;else if(n>=e[e.length-1])t[t.length-1]=1;else{for(var i=0,r=1;r<e.length;++r)if(e[r]>n){i=r;break}var o=e[i-1],a=e[i],s=a-o;t[i-1]=(a-n)/s,t[i]=(n-o)/s}}(t,this._thresholds,n)},e}(lH)),_H=(rH=new Xn,oH={wA:0,wB:0},function(t,e,n){if(t.length,e.length,0!==e.length)if(1!==e.length)if(Xn.strictEquals(n,Xn.ZERO)){var i=e.findIndex((function(t){return Xn.strictEquals(t,Xn.ZERO)}));i>=0?t[i]=1:t.fill(1/e.length)}else{for(var r=-1,o=-1,a=-1,s=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=n.x,u=n.y,h=0;h<e.length;++h){var _=e[h];if(Xn.equals(_,Xn.ZERO))a=h;else{var f=Xn.normalize(rH,_),d=Xn.dot(f,n);f.x*u-f.y*l>0?d>=c&&(c=d,r=h):d>=s&&(s=d,o=h)}}var p=0;if(r<0||o<0)p=1;else{var m=(b=e[r],T=e[o],E=n,w=oH,(P=Xn.cross(b,T))?(w.wA=Xn.cross(E,T)/P,w.wB=Xn.cross(E,b)/-P):(w.wA=0,w.wB=0),w),v=m.wA,g=m.wB,y=0,x=0,S=v+g;S>1?(y=v/S,x=g/S):S<0?(y=0,x=0,p=1):(y=v,x=g,p=1-S),t[r]=y,t[o]=x}if(p>0)if(a>=0)t[a]=p;else for(var A=p/t.length,C=0;C<t.length;++C)t[C]+=A}else t[0]=1;var b,T,E,w,P});function fH(t,e,n,i){t.fill(0);for(var r=new Xn(0,0),o=new Xn(0,0),a=0,s=e.length,c=0;c<s;++c){for(var l=Number.MAX_VALUE,u=!1,h=0;h<s;++h)if(c!==h){i(e[c],e[h],n,r,o);var _=1-Xn.dot(r,o)/Xn.lengthSqr(o);if(_<0){u=!0;break}l=Math.min(l,_)}u||(t[c]=l,a+=l)}a>0&&t.forEach((function(e,n){return t[n]=e/a}))}var dH,pH,mH,vH,gH,yH,xH,SH,AH,CH,bH,TH,EH,wH,PH,IH,RH,DH,MH=function(t,e,n,i,r){Xn.subtract(i,n,t),Xn.subtract(r,e,t)},BH=(dH=new Pn(0,0,0),pH=new Pn(0,0,0),mH=new Pn(0,0,0),vH=new Pn(0,0,0),gH=new Pn(0,0,0),yH=new Pn(0,0,0),function(t,e,n,i,r){var o=0,a=0,s=2;Pn.set(mH,n.x,n.y,0),Xn.equals(t,Xn.ZERO)?(o=Xn.angle(n,e),a=0,s=1):Xn.equals(e,Xn.ZERO)?(a=o=Xn.angle(n,t),s=1):(o=Xn.angle(t,e))<=0?a=0:Xn.equals(n,Xn.ZERO)?a=o:(Pn.set(vH,t.x,t.y,0),Pn.set(gH,e.x,e.y,0),Pn.set(yH,n.x,n.y,0),Pn.cross(dH,vH,gH),Pn.projectOnPlane(mH,yH,dH),a=Pn.angle(vH,mH),o<.99*Math.PI&&Pn.dot(Pn.cross(pH,vH,mH),dH)<0&&(a=-a));var c=Xn.len(t),l=Xn.len(e),u=(l+c)/2;Xn.set(r,(l-c)/u,o*s),Xn.set(i,(Pn.len(mH)-c)/u,a*s)});!function(t){t[t.SIMPLE_DIRECTIONAL=0]="SIMPLE_DIRECTIONAL",t[t.FREEFORM_CARTESIAN=1]="FREEFORM_CARTESIAN",t[t.FREEFORM_DIRECTIONAL=2]="FREEFORM_DIRECTIONAL"}(DH||(DH={})),ce(DH);var OH,NH,LH,FH,zH,VH,kH,GH,UH,HH,jH,WH,qH,XH,YH,KH,JH,QH,ZH,$H,tj,ej,nj,ij,rj=fc("cc.animation.AnimationBlend2DItem")((CH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"threshold",AH,it(e)),e}Q(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return this._assign(t),t},n._assign=function(e){return t.prototype._assign.call(this,e),Xn.copy(e.threshold,this.threshold),e},e}(sH),AH=st((SH=CH).prototype,"threshold",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn}}),xH=SH))||xH,oj=(fc("cc.animation.AnimationBlend2D")((RH=IH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"algorithm",TH,it(e)),at(e,"_items",EH,it(e)),at(e,"paramX",wH,it(e)),at(e,"paramY",PH,it(e)),e}Q(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return t._items=this._items.map((function(t){var e;return null!==(e=null==t?void 0:t.clone())&&void 0!==e?e:null})),t.paramX=this.paramX.clone(),t.paramY=this.paramY.clone(),t},n[CV]=function(t){var e=new oj(t,this._items,this._items.map((function(t){return t.threshold})),this.algorithm,[0,0]),n=NV(t,this.paramX,yV.FLOAT,e.setInput,e,0),i=NV(t,this.paramY,yV.FLOAT,e.setInput,e,1);return e.setInput(n,0),e.setInput(i,1),e},K(e,[{key:"items",get:function(){return this._items},set:function(t){this._items=Array.from(t)}}]),e}(cH),IH.Algorithm=DH,IH.Item=rj,TH=st((bH=RH).prototype,"algorithm",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DH.SIMPLE_DIRECTIONAL}}),EH=st(bH.prototype,"_items",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wH=st(bH.prototype,"paramX",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BV}}),PH=st(bH.prototype,"paramY",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BV}}),bH)),function(t){function e(e,n,i,r,o){var a;return(a=t.call(this,e,n,o)||this)._thresholds=void 0,a._algorithm=void 0,a._value=new Xn,a._thresholds=i,a._algorithm=r,a.doEval(),a}return Q(e,t),e.prototype.eval=function(t,e){var n=e[0],i=e[1];switch(Xn.set(this._value,n,i),t.fill(0),this._algorithm){case DH.SIMPLE_DIRECTIONAL:_H(t,this._thresholds,this._value);break;case DH.FREEFORM_CARTESIAN:!function(t,e,n){fH(t,e,n,MH)}(t,this._thresholds,this._value);break;case DH.FREEFORM_DIRECTIONAL:!function(t,e,n){fH(t,e,n,BH)}(t,this._thresholds,this._value)}},e}(lH)),aj=fc("cc.animation.AnimationBlendDirectItem")((FH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"weight",LH,it(e)),e}Q(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return this._assign(t),t},n._assign=function(e){return t.prototype._assign.call(this,e),e.weight=this.weight,e},e}(sH),LH=st((NH=FH).prototype,"weight",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OH=NH))||OH,sj=(fc("cc.animation.AnimationBlendDirect")((GH=kH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_items",VH,it(e)),e}Q(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return t._items=this._items.map((function(t){var e;return null!==(e=null==t?void 0:t.clone())&&void 0!==e?e:null})),t},n[CV]=function(t){return new sj(t,this._items,this._items.map((function(t){return t.weight})))},K(e,[{key:"items",get:function(){return this._items},set:function(t){this._items=Array.from(t)}}]),e}(cH),kH.Item=aj,VH=st((zH=GH).prototype,"_items",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zH)),function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).doEval(),e}return Q(e,t),e.prototype.eval=function(t,e){for(var n=t.length,i=0;i<n;++i)t[i]=e[i]},e}(lH));!function(t){t[t.EQUAL_TO=0]="EQUAL_TO",t[t.NOT_EQUAL_TO=1]="NOT_EQUAL_TO",t[t.LESS_THAN=2]="LESS_THAN",t[t.LESS_THAN_OR_EQUAL_TO=3]="LESS_THAN_OR_EQUAL_TO",t[t.GREATER_THAN=4]="GREATER_THAN",t[t.GREATER_THAN_OR_EQUAL_TO=5]="GREATER_THAN_OR_EQUAL_TO"}(ij||(ij={})),fc("cc.animation.BinaryCondition")((XH=qH=function(){function t(){at(this,"operator",HH,this),at(this,"lhs",jH,this),at(this,"rhs",WH,this)}var e=t.prototype;return e.clone=function(){var e=new t;return e.operator=this.operator,e.lhs=this.lhs.clone(),e.rhs=this.rhs.clone(),e},e[CV]=function(t){var e=this.operator,n=this.lhs,i=this.rhs,r=new lj(e,0,0),o=LV(t,n,yV.FLOAT,r.setLhs,r),a=LV(t,i,yV.FLOAT,r.setRhs,r);return r.reset(o,a),r},t}(),qH.Operator=ij,HH=st((UH=XH).prototype,"operator",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ij.EQUAL_TO}}),jH=st(UH.prototype,"lhs",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BV}}),WH=st(UH.prototype,"rhs",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BV}}),UH));var cj,lj=function(){function t(t,e,n){this._operator=t,this._lhs=e,this._rhs=n,this._eval()}var e=t.prototype;return e.reset=function(t,e){this._lhs=t,this._rhs=e,this._eval()},e.setLhs=function(t){this._lhs=t,this._eval()},e.setRhs=function(t){this._rhs=t,this._eval()},e.eval=function(){return this._result},e._eval=function(){var t=this._lhs,e=this._rhs;switch(this._operator){default:case ij.EQUAL_TO:this._result=t===e;break;case ij.NOT_EQUAL_TO:this._result=t!==e;break;case ij.LESS_THAN:this._result=t<e;break;case ij.LESS_THAN_OR_EQUAL_TO:this._result=t<=e;break;case ij.GREATER_THAN:this._result=t>e;break;case ij.GREATER_THAN_OR_EQUAL_TO:this._result=t>=e}},t}();!function(t){t[t.TRUTHY=0]="TRUTHY",t[t.FALSY=1]="FALSY"}(cj||(cj={})),fc("cc.animation.UnaryCondition")((ZH=QH=function(){function t(){at(this,"operator",KH,this),at(this,"operand",JH,this)}var e=t.prototype;return e.clone=function(){var e=new t;return e.operator=this.operator,e.operand=this.operand.clone(),e},e[CV]=function(t){var e=this.operator,n=this.operand,i=new fj(e,!1),r=NV(t,n,yV.BOOLEAN,i.setOperand,i);return i.reset(r),i},t}(),QH.Operator=cj,KH=st((YH=ZH).prototype,"operator",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cj.TRUTHY}}),JH=st(YH.prototype,"operand",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OV}}),YH));var uj,hj,_j,fj=function(){function t(t,e){this._operator=t,this._operand=e,this._eval()}var e=t.prototype;return e.reset=function(t){this.setOperand(t)},e.setOperand=function(t){this._operand=t,this._eval()},e.eval=function(){return this._result},e._eval=function(){var t=this._operand;switch(this._operator){default:case cj.TRUTHY:this._result=!!t;break;case cj.FALSY:this._result=!t}},t}(),dj=fc("cc.animation.TriggerCondition")((nj=function(){function t(){at(this,"trigger",ej,this)}var e=t.prototype;return e.clone=function(){var e=new t;return e.trigger=this.trigger,e},e[CV]=function(t){var e=new pj(!1),n=t.getVar(this.trigger);return FV(n,this.trigger)&&(function(t,e,n){if(t!==e)throw new AV(n,"number")}(n.type,yV.TRIGGER,this.trigger),e.setTrigger(n.bind(e.setTrigger,e))),e},t}(),ej=st((tj=nj).prototype,"trigger",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$H=tj))||$H,pj=function(){function t(t){this._triggered=!1,this._triggered=t}var e=t.prototype;return e.setTrigger=function(t){this._triggered=t},e.eval=function(){return this._triggered},t}(),mj=function(){function t(){this._nodeBlendStates=new Map}var e=t.prototype;return e.createWriter=function(t,e,n,i){var r=this.ref(t,e);return new vj(t,e,r,n,i)},e.destroyWriter=function(t){var e=t;this.deRef(e.node,e.property)},e.ref=function(t,e){var n=this._nodeBlendStates.get(t);return n||(n=new Sj,this._nodeBlendStates.set(t,n)),n.refProperty(e)},e.deRef=function(t,e){var n=this._nodeBlendStates.get(t);n&&(n.deRefProperty(e),n.empty&&this._nodeBlendStates.delete(t))},e.apply=function(){this._nodeBlendStates.forEach((function(t,e){t.apply(e)}))},t}(),vj=function(){function t(t,e,n,i,r){this._node=t,this._property=e,this._propertyBlendState=n,this._host=i,this._constants=r}var e=t.prototype;return e.getValue=function(){return this._node[this._property]},e.setValue=function(t){var e=this._propertyBlendState,n=this._host.weight;e.blend(t,n)},K(t,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),t}(),gj=function(t){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=t},yj=function(t){function e(){return t.call(this,new Pn)||this}Q(e,t);var n=e.prototype;return n.blend=function(t,e){var n=this.blendedValue;1===e?Pn.copy(n,t):Pn.scaleAndAdd(n,n,t,e),this.blendedWeight+=e},n.reset=function(){this.blendedWeight=0,Pn.zero(this.blendedValue)},e}(gj),xj=function(t){function e(){return t.call(this,new Nn)||this}Q(e,t);var n=e.prototype;return n.blend=function(t,e){if(0!==e){var n=this.blendedValue,i=this.blendedWeight;if(1===e)Nn.copy(n,t);else{var r=e/(i+e);Nn.slerp(n,n,t,r)}this.blendedWeight+=e}},n.reset=function(){this.blendedWeight=0,Nn.identity(this.blendedValue)},e}(gj),Sj=function(){function t(){this._properties={}}var e=t.prototype;return e.refProperty=function(t){var e,n,i,r=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":i=null!==(e=r[t])&&void 0!==e?e:r[t]=new yj;break;case"rotation":i=null!==(n=r[t])&&void 0!==n?n:r[t]=new xj}return++i.refCount,i},e.deRefProperty=function(t){var e=this._properties,n=e[t];n&&(--n.refCount,n.refCount>0||delete e[t])},e.apply=function(t){var e,n,i,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,_=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(t.position,1-o.blendedWeight),e=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(t.scale,1-a.blendedWeight),n=a.blendedValue),c&&c.blendedWeight&&(_=!0,c.blendedWeight<1&&c.blend(t.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(t.rotation,1-s.blendedWeight),i=s.blendedValue),(i||e||n)&&t.setRTS(i,e,n),l&&o.reset(),u&&a.reset(),h&&s.reset(),_&&c.reset()},K(t,[{key:"empty",get:function(){var t=this._properties;return!(t.position||t.rotation||t.eulerAngles||t.scale)}}]),t}(),Aj=fc("cc.animation.StateMachineComponent")(uj=function(){function t(){}var e=t.prototype;return e.onMotionStateEnter=function(){},e.onMotionStateExit=function(){},e.onMotionStateUpdate=function(){},e.onStateMachineEnter=function(){},e.onStateMachineExit=function(){},t}())||uj,Cj=function(){function t(t,e,n){var i=this;this._blendBuffer=new mj,this._currentTransitionCache={duration:0,time:0},this._varInstances={};for(var r,o=ot(t.variables);!(r=o()).done;){var a=r.value,s=a[0],c=a[1],l=c.type,u=c.value;this._varInstances[s]=new jj(l,u)}var h={controller:n,blendBuffer:this._blendBuffer,node:e,getVar:function(t){return i._varInstances[t]},triggerResetFn:function(t){i.setValue(t,!1)}};this._layerEvaluations=Array.from(t.layers).map((function(t){var e;return new bj(t,J({},h,{mask:null!==(e=t.mask)&&void 0!==e?e:void 0}))}))}var e=t.prototype;return e.update=function(t){for(var e,n=ot(this._layerEvaluations);!(e=n()).done;)e.value.update(t);this._blendBuffer.apply()},e.getVariables=function(){return Object.entries(this._varInstances)},e.getCurrentStateStatus=function(t){return this._layerEvaluations[t].getCurrentStateStatus()},e.getCurrentClipStatuses=function(t){return this._layerEvaluations[t].getCurrentClipStatuses()},e.getCurrentTransition=function(t){var e=this._layerEvaluations,n=this._currentTransitionCache;return e[t].getCurrentTransition(n)?n:null},e.getNextStateStatus=function(t){return this._layerEvaluations[t].getNextStateStatus()},e.getNextClipStatuses=function(t){return this.getCurrentTransition(t),this._layerEvaluations[t].getNextClipStatuses()},e.getValue=function(t){var e=this._varInstances[t];return e?e.value:void 0},e.setValue=function(t,e){var n=this._varInstances[t];n&&(n.value=e)},t}(),bj=function(){function t(t,e){this._weight=void 0,this._nodes=[],this._topLevelEntry=void 0,this._topLevelExit=void 0,this._currentNode=void 0,this._currentTransitionToNode=null,this._currentTransitionPath=[],this._transitionProgress=0,this._fromWeight=0,this._toWeight=0,this._fromUpdated=!1,this._toUpdated=!1,this.name=t.name,this._controller=e.controller,this._weight=t.weight;var n=this._addStateMachine(t.stateMachine,null,J({},e),t.name),i=n.entry,r=n.exit;this._topLevelEntry=i,this._topLevelExit=r,this._currentNode=i,this._resetTrigger=e.triggerResetFn}var e=t.prototype;return e.update=function(t){this.exited||(this._fromWeight=1,this._toWeight=0,this._eval(t),this._sample())},e.getCurrentStateStatus=function(){var t=this._currentNode;return t.kind===_j.animation?t.getFromPortStatus():null},e.getCurrentClipStatuses=function(){var t=this._currentNode;return t.kind===_j.animation?t.getClipStatuses(this._fromWeight):Ej},e.getCurrentTransition=function(t){var e=this._currentTransitionPath;if(0!==e.length){if(e[e.length-1].to.kind!==_j.animation)return!1;var n=e[0],i=n.duration,r=n.normalizedDuration,o=t.duration=r?i*(this._currentNode.kind===_j.animation?this._currentNode.duration:0):i;return t.time=this._transitionProgress*o,!0}return!1},e.getNextStateStatus=function(){return this._currentTransitionToNode,this._currentTransitionToNode.getToPortStatus()},e.getNextClipStatuses=function(){var t,e=this._currentTransitionPath,n=e[e.length-1].to;return n.kind,_j.animation,null!==(t=n.getClipStatuses(this._toWeight))&&void 0!==t?t:Ej},e._addStateMachine=function(t,e,n,i){for(var r,o,a,s=this,c=Array.from(t.states()),l=c.map((function(e){return e instanceof wk?new Bj(e,n):e===t.entryState?r=new Hj(e,_j.entry,e.name):e===t.exitState?a=new Hj(e,_j.exit,e.name):e===t.anyState?o=new Hj(e,_j.any,e.name):null})),u={components:null,parent:e,entry:r,exit:a,any:o},h=0;h<c.length;++h){var _=l[h];_&&(_.stateMachine=u)}for(var f=c.map((function(t){if(t instanceof Ok){var e=s._addStateMachine(t.stateMachine,u,n,i+"/"+t.name);return e.components=new Mj(t),e}return null})),d=0;d<c.length;++d){var p=c[d],m=t.getOutgoings(p),v=[],g=void 0;g=p instanceof Ok?f[d].exit:l[d];for(var y,x=function(){var t=y.value,e=t.to,i=c.findIndex((function(e){return e===t.to})),r={to:e instanceof Ok?f[i].entry:l[i],conditions:t.conditions.map((function(t){return t[CV](n)})),duration:Dk(t)?t.duration:0,normalizedDuration:!!Dk(t)&&t.relativeDuration,exitConditionEnabled:!!Dk(t)&&t.exitConditionEnabled,exitCondition:Dk(t)?t.exitCondition:0,triggers:void 0};r.conditions.forEach((function(e,n){var i,o=t.conditions[n];o instanceof dj&&o.trigger&&(null!==(i=r.triggers)&&void 0!==i?i:r.triggers=[]).push(o.trigger)})),v.push(r)},S=ot(m);!(y=S()).done;)x();g.outgoingTransitions=v}return u},e._eval=function(t){if(this.exited,VU("[Layer "+this.name+"]: UpdateStart "+t+"s"),this._continueDanglingTransition())return 0;for(var e=t,n=!0,i=0;n||e>0;){if(n=!1,100===i){I(14e3,100);break}if(++i,this._currentTransitionPath.length>0){if(e-=this._updateCurrentTransition(e),this._currentNode.kind===_j.exit)break;0===this._currentTransitionPath.length&&(n=!0)}else{var r=this._currentNode,o=this._matchCurrentNodeTransition(e);if(o){var a=o.transition,s=o.requires;if(zU("[SubStateMachine "+this.name+"]: CurrentNodeUpdate: "+r.name),e-=s,r.kind===_j.animation&&(r.updateFromPort(s),this._fromUpdated=!0),this._switchTo(a))break;n=!0}else zU("[SubStateMachine "+this.name+"]: CurrentNodeUpdate: "+r.name),r.kind===_j.animation&&(r.updateFromPort(e),this._fromUpdated=!0,e=0)}}return zU("[SubStateMachine "+this.name+"]: UpdateEnd"),this._fromUpdated&&this._currentNode.kind===_j.animation&&(this._fromUpdated=!1,this._currentNode.triggerFromPortUpdate(this._controller)),this._currentTransitionToNode&&this._toUpdated&&this._currentNode.kind===_j.animation&&(this._toUpdated=!1,this._currentTransitionToNode.triggerToPortUpdate(this._controller)),e},e._sample=function(){var t=this._currentNode,e=this._currentTransitionToNode,n=this._fromWeight;t.kind===_j.animation&&t.sampleFromPort(n),e&&e.kind===_j.animation&&e.sampleToPort(this._toWeight)},e._matchCurrentNodeTransition=function(t){var e=this._currentNode,n=1/0,i=null,r=this._matchTransition(e,e,t,Ij);if(r&&(n=r.requires,i=r.transition),e.kind===_j.animation)for(var o=e.stateMachine;null!==o;o=o.parent){var a=this._matchTransition(o.any,e,t,Rj);a&&a.requires<n&&(n=a.requires,i=a.transition)}return i?Pj.set(i,n):null},e._matchTransition=function(t,e,n,i){t===e||(t.kind,_j.any);for(var r=t.outgoingTransitions,o=r.length,a=1/0,s=null,c=0;c<o;++c){var l=r[c],u=l.conditions,h=u.length;if(0===h){if(t.kind===_j.entry||t.kind===_j.exit)return i.set(l,0);if(!l.exitConditionEnabled)continue}var _=0;if(e.kind===_j.animation&&l.exitConditionEnabled){var f=e.duration*l.exitCondition;if((_=Math.max(f-e.fromPortTime,0))>n)continue}for(var d=!0,p=0;p<h;++p)if(!u[p].eval()){d=!1;break}if(d){if(0===_)return i.set(l,0);_<a&&(a=_,s=l)}}return s?i.set(s,a):null},e._switchTo=function(t){var e=this._currentNode;VU("[SubStateMachine "+this.name+"]: STARTED "+e.name+" -> "+t.to.name+".");var n=this._currentTransitionPath;this._consumeTransition(t),n.push(t);var i=this._matchTransitionPathUntilMotion();return!i||(this._doTransitionToMotion(i),!1)},e._continueDanglingTransition=function(){var t=this._currentTransitionPath,e=t.length;if(0===e)return!1;if(t[e-1].to.kind!==_j.animation){var n=this._matchTransitionPathUntilMotion();return!n||(this._doTransitionToMotion(n),!1)}return!1},e._matchTransitionPathUntilMotion=function(){for(var t=this._currentTransitionPath,e=t[t.length-1].to;e.kind!==_j.animation;){var n=this._matchTransition(e,e,0,Pj);if(!n)break;var i=n.transition;this._consumeTransition(i),t.push(i),e=i.to}return e.kind===_j.animation?e:null},e._consumeTransition=function(t){var e=t.to;e.kind===_j.entry&&this._callEnterMethods(e)},e._resetTriggersAlongThePath=function(){for(var t=this._currentTransitionPath,e=t.length,n=0;n<e;++n){var i=t[n];this._resetTriggersOnTransition(i)}},e._doTransitionToMotion=function(t){this._resetTriggersAlongThePath(),this._transitionProgress=0,this._currentTransitionToNode=t,this._toUpdated=!1,t.resetToPort(),this._callEnterMethods(t)},e._updateCurrentTransition=function(t){var e,n=this._currentTransitionPath,i=this._currentTransitionToNode;n.length;var r=n[0],o=r.duration,a=r.normalizedDuration,s=this._currentNode,c=i,l=0,u=0;if(o<=0)l=0,u=1;else{s.kind,_j.animation;var h=this._transitionProgress,_=a?o*s.duration:o,f=h*_,d=_-f;l=Math.min(d,t),u=this._transitionProgress=(f+l)/_}var p=null!==(e=null==c?void 0:c.name)&&void 0!==e?e:"<Empty>",m=this._weight;VU("[SubStateMachine "+this.name+"]: TransitionUpdate: "+s.name+" -> "+p+"with ratio "+u+" in base weight "+this._weight+"."),this._fromWeight=m*(1-u),this._toWeight=m*u;var v=0!==l,g=1===u;if(s.kind===_j.animation&&v&&(VU("Update "+s.name),s.updateFromPort(l),this._fromUpdated=!0),c&&v&&(VU("Update "+c.name),c.updateToPort(l),this._toUpdated=!0),g){zU("[SubStateMachine "+this.name+"]: Transition finished:  "+s.name+" -> "+p+"."),this._callExitMethods(s);for(var y=this._currentTransitionPath,x=y.length,S=0;S<x;++S){var A=y[S].to;A.kind===_j.exit&&this._callExitMethods(A)}this._fromUpdated=this._toUpdated,this._toUpdated=!1,c.finishTransition(),this._currentNode=c,this._currentTransitionToNode=null,this._currentTransitionPath.length=0,this._fromWeight=1,this._toWeight=0}return l},e._resetTriggersOnTransition=function(t){var e=t.triggers;if(e)for(var n=e.length,i=0;i<n;++i){var r=e[i];this._resetTrigger(r)}},e._resetTrigger=function(t){(0,this._triggerReset)(t)},e._callEnterMethods=function(t){var e,n=this._controller;switch(t.kind){default:break;case _j.animation:t.components.callMotionStateEnterMethods(n,t.getToPortStatus());break;case _j.entry:null===(e=t.stateMachine.components)||void 0===e||e.callStateMachineEnterMethods(n)}},e._callExitMethods=function(t){var e,n=this._controller;switch(t.kind){default:break;case _j.animation:t.components.callMotionStateExitMethods(n,t.getFromPortStatus());break;case _j.exit:null===(e=t.stateMachine.components)||void 0===e||e.callStateMachineExitMethods(n)}},K(t,[{key:"exited",get:function(){return this._currentNode===this._topLevelExit}}]),t}(),Tj=Object.freeze({next:function(){return{done:!0,value:void 0}}}),Ej=Object.freeze(((hj={})[Symbol.iterator]=function(){return Tj},hj)),wj=function(){function t(){this.transition=null,this.requires=0}return t.prototype.set=function(t,e){return this.transition=t,this.requires=e,this},t}(),Pj=new wj,Ij=new wj,Rj=new wj;!function(t){t[t.entry=0]="entry",t[t.exit=1]="exit",t[t.any=2]="any",t[t.animation=3]="animation"}(_j||(_j={}));var Dj=function(t){this.name=void 0,this.outgoingTransitions=[],this.name=t.name},Mj=function(){function t(t){this._components=t.instantiateComponents()}var e=t.prototype;return e.callMotionStateEnterMethods=function(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateEnter",t,e)},e.callMotionStateUpdateMethods=function(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateUpdate",t,e)},e.callMotionStateExitMethods=function(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateExit",t,e)},e.callStateMachineEnterMethods=function(t){this._callStateMachineCallbackIfNonDefault("onStateMachineEnter",t)},e.callStateMachineExitMethods=function(t){this._callStateMachineCallbackIfNonDefault("onStateMachineExit",t)},e._callMotionStateCallbackIfNonDefault=function(t,e,n){for(var i=this._components,r=i.length,o=0;o<r;++o){var a=i[o];a[t]!==Aj.prototype[t]&&a[t](e,n)}},e._callStateMachineCallbackIfNonDefault=function(t,e){for(var n=this._components,i=n.length,r=0;r<i;++r){var o=n[r];o[t]!==Aj.prototype[t]&&o[t](e)}},t}(),Bj=function(t){function e(e,n){var i,r,o;(o=t.call(this,e)||this).kind=_j.animation,o._source=null,o._speed=1,o._fromPort={progress:0,statusCache:{progress:0}},o._toPort={progress:0,statusCache:{progress:0}};var a=NV(n,e.speed,yV.FLOAT,o._setSpeed,it(o));o._speed=a;var s=J({},n),c=null!==(i=null===(r=e.motion)||void 0===r?void 0:r[CV](s))&&void 0!==i?i:null;return c&&Object.defineProperty(c,"__DEBUG_ID__",{value:o.name}),o._source=c,o.components=new Mj(e),o}Q(e,t);var n=e.prototype;return n.updateFromPort=function(t){this._fromPort.progress=Oj(this._fromPort.progress,this.duration,t*this._speed)},n.updateToPort=function(t){this._toPort.progress=Oj(this._toPort.progress,this.duration,t*this._speed)},n.triggerFromPortUpdate=function(t){this.components.callMotionStateUpdateMethods(t,this.getFromPortStatus())},n.triggerToPortUpdate=function(t){this.components.callMotionStateUpdateMethods(t,this.getToPortStatus())},n.getFromPortStatus=function(){var t=this._fromPort.statusCache;return t.progress=Nj(this._fromPort.progress),t},n.getToPortStatus=function(){var t=this._toPort.statusCache;return t.progress=Nj(this._toPort.progress),t},n.resetToPort=function(){this._toPort.progress=0},n.finishTransition=function(){this._fromPort.progress=this._toPort.progress},n.sampleFromPort=function(t){var e;null===(e=this._source)||void 0===e||e.sample(this._fromPort.progress,t)},n.sampleToPort=function(t){var e;null===(e=this._source)||void 0===e||e.sample(this._toPort.progress,t)},n.getClipStatuses=function(t){var e,n=this._source;return n?((e={})[Symbol.iterator]=function(){return n.getClipStatuses(t)},e):Ej},n._setSpeed=function(t){this._speed=t},K(e,[{key:"duration",get:function(){var t,e;return null!==(t=null===(e=this._source)||void 0===e?void 0:e.duration)&&void 0!==t?t:0}},{key:"fromPortTime",get:function(){return this._fromPort.progress*this.duration}}]),e}(Dj);function Oj(t,e,n){return 0===e?0:t+n/e}function Nj(t){return t-Math.trunc(t)}var Lj,Fj,zj,Vj,kj,Gj,Uj,Hj=function(t){function e(e,n){var i;return(i=t.call(this,e)||this).kind=void 0,i.kind=n,i}return Q(e,t),e}(Dj),jj=function(){function t(t,e){this.type=void 0,this._value=void 0,this._refs=[],this.type=t,this._value=e}return t.prototype.bind=function(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this._refs.push({fn:t,thisArg:e,args:i}),this._value},K(t,[{key:"value",get:function(){return this._value},set:function(t){this._value=t;for(var e,n=ot(this._refs);!(e=n()).done;){var i=e.value,r=i.fn,o=i.thisArg,a=i.args;r.call.apply(r,[o,t].concat(a))}}}]),t}(),Wj=(Lj=fc("cc.animation.AnimationController"),Fj=Tc(),zj=vc(Fk),Lj(Vj=Fj((Uj=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"graph",Gj,it(e)),e._graphEval=null,e}Q(e,t);var n=e.prototype;return n.start=function(){this.graph&&(this._graphEval=new Cj(this.graph,this.node,this))},n.update=function(t){var e;null===(e=this._graphEval)||void 0===e||e.update(t)},n.getVariables=function(){return this._graphEval.getVariables()},n.setValue=function(t,e){this._graphEval.setValue(t,e)},n.getValue=function(t){return this._graphEval.getValue(t)},n.getCurrentStateStatus=function(t){return this._graphEval.getCurrentStateStatus(t)},n.getCurrentClipStatuses=function(t){return this._graphEval.getCurrentClipStatuses(t)},n.getCurrentTransition=function(t){return this._graphEval.getCurrentTransition(t)},n.getNextStateStatus=function(t){return this._graphEval.getNextStateStatus(t)},n.getNextClipStatuses=function(t){return this._graphEval.getNextClipStatuses(t)},e}(Qu),Gj=st((kj=Uj).prototype,"graph",[zj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vj=kj))||Vj)||Vj);t("animation",Object.freeze({__proto__:null,UniformProxyFactory:OF,MorphWeightValueProxy:NF,MorphWeightsValueProxy:LF,MorphWeightsAllValueProxy:FF,Track:Cz,TrackPath:Sz,RealTrack:wz,VectorTrack:kz,QuatTrack:jz,ColorTrack:Xz,SizeTrack:Jz,ObjectTrack:Zz,isPropertyPath:lF,isCustomPath:function(t,e){return t instanceof e},HierarchyPath:MF,ComponentPath:BF,CubicSplineVec2Value:VF,CubicSplineVec3Value:kF,CubicSplineVec4Value:GF,CubicSplineQuatValue:UF,CubicSplineNumberValue:HF,AnimationController:Wj,get VariableType(){return yV},StateMachineComponent:Aj}));var qj,Xj,Yj,Kj,Jj,Qj,Zj,$j,tW,eW,nW,iW,rW,oW,aW,sW,cW,lW=function(t){function e(e){var n;return(n=t.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=e?e:c.director.getAnimationManager(),n}Q(e,t);var n=e.prototype;return n.update=function(t){if(!this.isMotionless){var e=this._managedStates,n=this._fadings;if(1===e.length&&1===n.length){var i=e[0].state;i&&(i.weight=1)}else this._calculateWeights(t);1===e.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(t,e){var n;0===this._managedStates.length&&(e=0),0===e&&this.clear();var i=this._managedStates.find((function(e){return e.state===t}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var t=0;t<this._managedStates.length;++t){var e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){t.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){t.prototype.onPause.call(this);for(var e=0;e<this._managedStates.length;++e){var n=this._managedStates[e].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){t.prototype.onResume.call(this);for(var e=0;e<this._managedStates.length;++e){var n=this._managedStates[e].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){t.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(t){for(var e=this._managedStates,n=this._fadings,i=0;i<e.length;++i){var r=e[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=t;var l=0===c.easeDuration?1:cn(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),ht(this._managedStates,_.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},e}(RU),uW=function(e){return t({AnimationComponent:e,Animation:e}),e}((qj=fc("cc.Animation"),Xj=Ic(),Yj=pc(99),Kj=Tc(),Jj=Xc([gU]),Qj=Oc(),Zj=Xc(gU),$j=Oc(),tW=Oc(),eW=Xc([gU]),qj(nW=Xj(nW=Yj(nW=bc(nW=Kj((cW=sW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"playOnLoad",rW,it(e)),e._crossFade=new lW,e._nameToState=wt(!0),at(e,"_clips",oW,it(e)),at(e,"_defaultClip",aW,it(e)),e._hasBeenPlayed=!1,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){for(var t in this.clips=this._clips,this._nameToState)this._nameToState[t].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var t in this._crossFade.stop(),this._nameToState)this._nameToState[t].destroy();this._nameToState=wt(!0)},n.play=function(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)},n.crossFade=function(t,e){void 0===e&&(e=.3),this._hasBeenPlayed=!0;var n=this._nameToState[t];n&&this.doPlayOrCrossFade(n,e)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(t){return this.getState(t)},n.getState=function(t){var e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null},n.createState=function(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)},n.removeState=function(t){var e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])},n.addClip=function(t,e){return ft(this._clips,t)||this._clips.push(t),this.createState(t,e)},n.removeClip=function(t,e){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===t){n=r;break}}if(t===this._defaultClip){if(!e)return void I(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!e)return void I(3903);n.stop()}this._clips=this._clips.filter((function(e){return e!==t})),n&&delete this._nameToState[n.name]},n.on=function(e,n,i,r){var o=t.prototype.on.call(this,e,n,i,r);return e===IU.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(e,n,i){var r=t.prototype.once.call(this,e,n,i);return e===IU.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i),e===IU.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(t,e){return new MU(t,e)},n._doCreateState=function(t,e){var n=this._createState(t,e);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(IU.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(t,e){this._crossFade.play(),this._crossFade.crossFade(t,e)},n._removeStateOfAutomaticClip=function(t){for(var e in this._nameToState){var n=this._nameToState[e];hW(t,n.clip)&&(n.stop(),delete this._nameToState[e])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(IU.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(IU.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)},K(e,[{key:"clips",get:function(){return this._clips},set:function(t){var e=this;this._crossFade&&this._crossFade.clear();for(var n,i=ot(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=ot(t);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=t.find((function(t){return hW(t,e._defaultClip)}));this._defaultClip=c||null,this._clips=t}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){this._defaultClip=t,t&&(this._clips.findIndex((function(e){return hW(e,t)}))>=0||(this._clips.push(t),this.createState(t)))}}]),e}(Zl(Qu)),sW.EventType=IU,st((iW=cW).prototype,"clips",[Jj,Qj],Object.getOwnPropertyDescriptor(iW.prototype,"clips"),iW.prototype),st(iW.prototype,"defaultClip",[Zj,$j],Object.getOwnPropertyDescriptor(iW.prototype,"defaultClip"),iW.prototype),rW=st(iW.prototype,"playOnLoad",[yc,tW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oW=st(iW.prototype,"_clips",[eW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aW=st(iW.prototype,"_defaultClip",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nW=iW))||nW)||nW)||nW)||nW)||nW));function hW(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}c.Animation=uW,z(uW.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var t=arguments.length<=0?void 0:arguments[0];return uW.prototype.removeState.call(this,t.name)}}]),c.AnimationComponent=uW,ne.setClassAlias(uW,"cc.AnimationComponent");var _W,fW,dW,pW=[],mW=new Map;function vW(t,e){for(var n=0,i=Hn.IDENTITY;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){i=t.world,t.stamp=e;break}t.stamp=e,pW[n++]=t,t=t.parent}for(;n>0;){t=pW[--n],pW[n]=null;var r=t.node;Hn.fromRTS(t.local,r.rotation,r.position,r.scale),i=Hn.multiply(t.world,i,t.local)}return i}function gW(t){for(var e=mW.get(t.uuid)||null;e;)mW.delete(e.node.uuid),e=e.parent}var yW=t("AnimationManager",fc((dW=fW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._anims=new ct([]),e._crossFades=new ct([]),e._delayEvents=[],e._blendStateBuffer=new mj,e._sockets=[],e}Q(e,t);var n=e.prototype;return n.addCrossFade=function(t){-1===this._crossFades.array.indexOf(t)&&this._crossFades.push(t)},n.removeCrossFade=function(t){var e=this._crossFades.array.indexOf(t);e>=0?this._crossFades.fastRemoveAt(e):D(3907)},n.update=function(t){var e=this._delayEvents,n=this._crossFades,i=this._sockets,r=n.array;for(n.i=0;n.i<r.length;++n.i)r[n.i].update(t);var o=this._anims,a=o.array;for(o.i=0;o.i<a.length;++o.i){var s=a[o.i];s.isMotionless||s.update(t)}this._blendStateBuffer.apply();for(var l=c.director.getTotalFrames(),u=0,h=i.length;u<h;u++){var _=i[u],f=_.target,d=_.transform;f.matrix=vW(d,l)}for(var p=0,m=e.length;p<m;p++){var v=e[p];v.fn.apply(v.thisArg,v.args)}e.length=0},n.destruct=function(){},n.addAnimation=function(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)},n.removeAnimation=function(t){var e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):D(3907)},n.pushDelayEvent=function(t,e,n){this._delayEvents.push({fn:t,thisArg:e,args:n})},n.addSockets=function(t,e){for(var n=this,i=function(i){var r=e[i];if(n._sockets.find((function(t){return t.target===r.target})))return"continue";var o=t.getChildByPath(r.path),a=r.target&&o&&function(t,e){for(var n,i=null,r=0;t!==e;){var o=t.uuid;if(mW.has(o)){i=mW.get(o);break}i={node:t,local:new Hn,world:new Hn,stamp:-1,parent:null},mW.set(o,i),pW[r++]=i,t=t.parent,i=null}for(;r>0;)n=pW[--r],pW[r]=null,n.parent=i,i=n;return i}(o,t);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<e.length;++r)i(r)},n.removeSockets=function(t,e){for(var n=0;n<e.length;++n)for(var i=e[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){gW(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},K(e,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),e}(bB),fW.ID="animation",_W=dW))||_W);zB.on(FB.EVENT_INIT,(function(){var t=new yW;zB.registerSystem(yW.ID,t,bB.Priority.HIGH)})),c.AnimationManager=yW;var xW,SW,AW,CW,bW=new Hn;c.easing=Z_;var TW=t("HierachyModifier",fc("cc.HierachyModifier")(xW=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(MF))||xW);c.HierachyModifier=TW;var EW=t("ComponentModifier",fc("cc.ComponentModifier")(SW=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(BF))||SW);c.ComponentModifier=EW;var wW=t("CurveValueAdapter",fc("cc.CurveValueAdapter")(AW=function(){function t(){}return t.prototype.forTarget=function(){return{set:function(){}}},t}())||AW);c.CurveValueAdapter=wW;var PW=t("UniformCurveValueAdapter",fc("cc.UniformCurveValueAdapter")(CW=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(OF))||CW);function IW(t){return"string"==typeof t}function RW(t){return"number"==typeof t}function DW(t,e){return t instanceof e}c.UniformCurveValueAdapter=PW,c.isPropertyModifier=IW,c.isElementModifier=RW,c.isCustomTargetModifier=DW,c.math=ai,c.geometry=Rd;var MW=new Pn,BW=new Hn;function OW(t,e,n,i){var r=n.chunk,o=n.data,a=r.vb,s=n.vertexCount;t.getWorldMatrix(BW);for(var c=0,l=0;l<s;l++){var u=o[l];Pn.set(MW,u.x,u.y,0),Pn.transformMat4(MW,MW,BW),a[c++]=MW.x,a[c++]=MW.y,a[c++]=MW.z,En.toArray(a,i,c+2),c+=6}for(var h=r.bufferId,_=r.vertexOffset,f=r.vertexAccessor.getMeshBuffer(r.bufferId),d=r.vertexAccessor.getIndexBuffer(h),p=f.indexOffset,m=0,v=s/4;m<v;m++){var g=_+4*m;d[p++]=g,d[p++]=g+1,d[p++]=g+2,d[p++]=g+1,d[p++]=g+3,d[p++]=g+2}f.indexOffset+=n.indexCount,f.setDirty()}var NW=function(){function t(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new LW;n.initWithSize(t,e),this._texture=n,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var e=t.prototype;return e.insertSpriteFrame=function(t){var e=t.rect,n=t.texture,i=this._innerTextureInfos[n.getId()],r=e.x,o=e.y;if(i)r+=i.x,o+=i.y;else{var a=n.width,s=n.height;if(this._x+a+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;c.internal.dynamicAtlasManager.textureBleeding&&((a<=8||s<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,o+=this._y,this._x+=a+2}var l={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(t),l},e.deleteInnerTexture=function(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)},e.isEmpty=function(){return this._count<=0},e.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var t=this._innerSpriteFrames,e=0,n=t.length;e<n;e++){var i=t[e];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},e.destroy=function(){this.reset(),this._texture.destroy()},t}(),LW=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.initWithSize=function(t,e,n){void 0===n&&(n=wm.RGBA8888),this.reset({width:t,height:e,format:n})},n.drawTextureAt=function(t,e,n){var i=this.getGFXTexture();if(t&&i){var r=this._getGFXDevice();if(r){var o=new or;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],i,[o])}else console.warn("Unable to get device")}},e}(yv),FW=function(){function t(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var e=t.prototype;return e.newAtlas=function(){var t=this._atlases[++this._atlasIndex];return t||(t=new NW(this._textureSize,this._textureSize),this._atlases.push(t)),t},e.beforeSceneLoad=function(){this.reset()},e.insertSpriteFrame=function(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;var e=t.texture.getSamplerInfo();if(e.minFilter!==Im.LINEAR||e.magFilter!==Im.LINEAR||e.mipFilter!==Im.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(t);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(t)},e.reset=function(){for(var t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1},e.deleteAtlasSpriteFrame=function(t){if(t._original){for(var e,n=this._atlases.length-1;n>=0;n--)e=this._atlases[n],ne.array.fastRemove(e._innerSpriteFrames,t);var i=t._original._texture;this.deleteAtlasTexture(i)}},e.deleteAtlasTexture=function(t){if(t)for(var e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)},e.packToDynamicAtlas=function(t,e){if(e&&!e._original&&e.packable&&e.texture&&e.texture.width>0&&e.texture.height>0){var n=this.insertSpriteFrame(e);n&&e._setDynamicAtlasFrame(n)}},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(t?(this.reset(),c.director.on(c.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),c.director.off(c.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=t)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(t){this._maxAtlasCount=t}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(t){this._textureBleeding=t}},{key:"textureSize",get:function(){return this._textureSize},set:function(t){this._textureSize=t}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(t){this._maxFrameSize=t}}]),t}();FW.instance=void 0;var zW,VW,kW,GW=t("dynamicAtlasManager",FW.instance=new FW);c.internal.dynamicAtlasManager=GW;var UW,HW,jW,WW,qW=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],XW=t("SpriteFrame",fc("cc.SpriteFrame")((kW=VW=function(t){function e(){var e;return(e=t.call(this)||this).vertices=null,e.uv=[],e.unbiasUV=[],e.uvSliced=[],e._rect=new ni,e._offset=new Xn,e._originalSize=new ti,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._isFlipUVY=!1,e._isFlipUVX=!1,e._original=null,e._packable=!0,e}Q(e,t),e.createWithImage=function(t){var n=t instanceof Jm?t:new Jm(t),i=new yv;i.image=n;var r=new e;return r.texture=i,r};var n=e.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(t){this.rotated=t},n.getRect=function(t){return t?(t.set(this._rect),t):this._rect.clone()},n.setRect=function(t){this.rect=t},n.getOriginalSize=function(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()},n.setOriginalSize=function(t){this.originalSize=t},n.getOffset=function(t){return t?(t.set(this._offset),t):this._offset.clone()},n.setOffset=function(t){this.offset=t},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(t,e){void 0===e&&(e=!1);var n=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),t&&(t.texture&&(this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(t){var e=this._rect,n=e.x,i=e.y;return this._rotated?(n+=e.height,i+=e.width):(n+=e.width,i+=e.height),n>t.width?(D(3300,this.name+"/"+t.name,n,t.width),!1):!(i>t.height&&(D(3301,this.name+"/"+t.name,i,t.height),1))},n.destroy=function(){return this._packable&&GW&&GW.deleteAtlasSpriteFrame(this),t.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var t=this._rect,n=this.texture,i=n.width,r=n.height,o=this._capInsets[0],a=this._capInsets[2],s=t.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=t.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){qW[0].u=t.x/i,qW[1].u=(t.x+l)/i,qW[2].u=(t.x+l+u)/i,qW[3].u=(t.x+t.height)/i,qW[3].v=t.y/r,qW[2].v=(t.y+o)/r,qW[1].v=(t.y+o+s)/r,qW[0].v=(t.y+t.width)/r;for(var _=0;_<4;++_)for(var f=qW[_],d=0;d<4;++d){var p=qW[3-d];h.push({u:f.u,v:p.v})}}else{qW[0].u=t.x/i,qW[1].u=(t.x+o)/i,qW[2].u=(t.x+o+s)/i,qW[3].u=(t.x+t.width)/i,qW[3].v=t.y/r,qW[2].v=(t.y+c)/r,qW[1].v=(t.y+c+u)/r,qW[0].v=(t.y+t.height)/r;for(var m=0;m<4;++m)for(var v=qW[m],g=0;g<4;++g){var y=qW[g];h.push({u:y.u,v:v.v})}}this.emit(e.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var t=this._rect,e=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:t.x/r,s=0===r?1:(t.x+t.height)/r,c=0===o?0:t.y/o,l=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=s,e[1]=l,e[2]=s,e[3]=c,e[4]=a,e[5]=l,e[6]=a,e[7]=c):this._isFlipUVX?(e[0]=s,e[1]=c,e[2]=s,e[3]=l,e[4]=a,e[5]=c,e[6]=a,e[7]=l):this._isFlipUVY?(e[0]=a,e[1]=l,e[2]=a,e[3]=c,e[4]=s,e[5]=l,e[6]=s,e[7]=c):(e[0]=a,e[1]=c,e[2]=a,e[3]=l,e[4]=s,e[5]=c,e[6]=s,e[7]=l);var u=0===r?0:t.x/r,h=0===r?1:(t.x+t.height)/r,_=0===o?0:t.y/o,f=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var d=0===r?0:t.x/r,p=0===r?1:(t.x+t.width)/r,m=0===o?1:(t.y+t.height)/o,v=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=p,e[1]=v,e[2]=d,e[3]=v,e[4]=p,e[5]=m,e[6]=d,e[7]=m):this._isFlipUVX?(e[0]=p,e[1]=m,e[2]=d,e[3]=m,e[4]=p,e[5]=v,e[6]=d,e[7]=v):this._isFlipUVY?(e[0]=d,e[1]=v,e[2]=p,e[3]=v,e[4]=d,e[5]=m,e[6]=p,e[7]=m):(e[0]=d,e[1]=m,e[2]=p,e[3]=m,e[4]=d,e[5]=v,e[6]=p,e[7]=v);var g=0===r?0:t.x/r,y=0===r?1:(t.x+t.width)/r,x=0===o?1:(t.y+t.height)/o,S=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var A=this.vertices;if(A){A.nu.length=0,A.nv.length=0;for(var C=0;C<A.u.length;C++)A.nu[C]=A.u[C]/r,A.nv[C]=A.v[C]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var t=GW;if(t){var e=this._texture;if(e instanceof yv&&!e.isCompressed){var n=this.width,i=this.height;!e.image||n>t.maxFrameSize||i>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(t){var e=t,n=e.rect;n&&(this._rect=new ni(n.x,n.y,n.width,n.height));var i=e.offset;e.offset&&(this._offset=new Xn(i.x,i.y));var r=e.originalSize;e.originalSize&&(this._originalSize=new ti(r.width,r.height)),this._rotated=!!e.rotated,this._name=e.name,this._packable=!!e.packable;var o=e.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=e.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var t,n,i,r,o,a,s,c,l=new e,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(t=u.nu)||void 0===t?void 0:t.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(t){this._texture=t;var e=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(n.rect=new ni(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new ti(e.width,e.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new yv;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},K(e,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t)}},{key:"rotated",get:function(){return this._rotated},set:function(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(t){t?this.reset({texture:t},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(t){this._atlasUuid=t}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(t){this._isFlipUVX=t,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(t){this._isFlipUVY=t,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(t){this._packable=t}},{key:"original",get:function(){return this._original}}]),e}(Ru),VW.EVENT_UV_UPDATED="uv_updated",zW=kW))||zW);c.SpriteFrame=XW;var YW,KW=t("SpriteAtlas",fc("cc.SpriteAtlas")((WW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"spriteFrames",jW,it(e)),e}Q(e,t);var n=e.prototype;return n.getTexture=function(){var t=Object.keys(this.spriteFrames);if(t.length>0){var e=this.spriteFrames[t[0]];return e&&e.texture}return null},n.getSpriteFrame=function(t){var e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null},n.getSpriteFrames=function(){for(var t=[],e=this.spriteFrames,n=0,i=Object.keys(e);n<i.length;n++){var r=i[n];t.push(e[r])}return t},n._serialize=function(){},n._deserialize=function(t,e){var n=t;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=wt();for(var r=0;r<i.length;r+=2)e.result.push(this.spriteFrames,i[r],i[r+1],$t(XW))},e}(Ru),jW=st((HW=WW).prototype,"spriteFrames",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wt()}}),UW=HW))||UW);c.SpriteAtlas=KW;var JW,QW,ZW,$W,tq=t("Font",fc("cc.Font")(YW=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(Ru))||YW);c.Font=tq;var eq,nq,iq,rq,oq,aq,sq,cq,lq,uq=t("TTFFont",fc("cc.TTFFont")(($W=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_fontFamily",ZW,it(e)),e}return Q(e,t),e.prototype.initDefault=function(e){this._fontFamily="Arial",t.prototype.initDefault.call(this,e)},K(e,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(t){this._fontFamily=t||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:gu(this._native),__isNative__:!0}}}]),e}(tq),ZW=st((QW=$W).prototype,"_fontFamily",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),st(QW.prototype,"_nativeAsset",[il,qc],Object.getOwnPropertyDescriptor(QW.prototype,"_nativeAsset"),QW.prototype),st(QW.prototype,"_nativeDep",[il],Object.getOwnPropertyDescriptor(QW.prototype,"_nativeDep"),QW.prototype),JW=QW))||JW);c.TTFFont=uq;var hq,_q=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},fq=function(){function t(t){this.letterDefinitions={},this.texture=t}var e=t.prototype;return e.addLetterDefinitions=function(t,e){this.letterDefinitions[t]=e},e.cloneLetterDefinition=function(){for(var t={},e=0,n=Object.keys(this.letterDefinitions);e<n.length;e++){var i=n[e],r=new _q;zt(r,this.letterDefinitions[i]),t[i]=r}return t},e.getTexture=function(){return this.texture},e.getLetter=function(t){return this.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t){var e=t.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(e)?this.letterDefinitions[e]:null},e.clear=function(){this.letterDefinitions={}},t}(),dq=t("BitmapFont",(eq=fc("cc.BitmapFont"),nq=Xc(XW),eq((lq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"fntDataStr",oq,it(e)),at(e,"spriteFrame",aq,it(e)),at(e,"fontSize",sq,it(e)),at(e,"fntConfig",cq,it(e)),e}return Q(e,t),e.prototype.onLoaded=function(){var t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new fq(t.texture));var e=this.fntConfig;if(e){var n=e.fontDefDictionary;for(var i in n){var r=new _q,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else y("The fnt config is not exists!")},e}(tq),oq=st((rq=lq).prototype,"fntDataStr",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aq=st(rq.prototype,"spriteFrame",[nq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sq=st(rq.prototype,"fontSize",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),cq=st(rq.prototype,"fntConfig",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iq=rq))||iq));c.BitmapFont=dq;var pq=t("LabelAtlas",fc("cc.LabelAtlas")(hq=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(dq))||hq);c.LabelAtlas=pq;var mq=t("BASELINE_RATIO",.26),vq=t("MIDDLE_RATIO",(mq+1)/2-mq);var gq=new te(2);gq.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var yq,xq=new(function(){function t(t){this.count=0,this.limit=0,this.datas={},this.limit=t}var e=t.prototype;return e.moveToHead=function(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t},e.put=function(t,e){var n=gq.get();if(n.key=t,n.value=e,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,gq.put(i)}this.moveToHead(n)},e.remove=function(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--},e.get=function(t){var e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null},e.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},e.has=function(t){return!!this.datas[t]},e.delete=function(t){var e=this.datas[t];this.remove(e)},t}())(100),Sq=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,Aq=/^[!,.:;'}\]%\?>、‘“》？。，！]/,Cq=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,bq=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,Tq=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function Eq(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function wq(t){var e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function Pq(t,e,n){var i=(n||t.font)+"🎮"+e,r=xq.get(i);if(null!==r)return r;var o=t.measureText(e),a=o&&o.width||0;return xq.put(i,a),a}function Iq(t,e,n){var i=e,r=n,o=t[e];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==e){var a=t[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return t.substring(i,r)}function Rq(t,e,n,i){var r=[];if(0===t.length||n<0)return r.push(""),r;for(var o=t;e>n&&o.length>1;){for(var a=o.length*(n/e)|0,s=Iq(o,a),c=e-i(s),l=s,u=0,h=0;c>n&&h++<10;)a*=n/c,c=e-i(s=Iq(o,a|=0));for(h=0;c<=n&&h++<10;){if(s){var _=Sq.exec(s);u=_?_[0].length:1,l=s}c=e-i(s=Iq(o,a+=u))}0==(a-=u)?(a=1,l=Iq(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=Iq(o,2));var f=Iq(o,0,a),d=void 0;Aq.test(l||s)&&(0==(a-=(d=Cq.exec(f))?d[0].length:0)&&(a=1),l=Iq(o,a),f=Iq(o,0,a)),Tq.test(l)&&(d=bq.exec(f))&&f!==d[0]&&(l=Iq(o,a-=d[0].length),f=Iq(o,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),e=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var Dq=t("CanvasPool",function(){function t(){this.pool=[]}t.getInstance=function(){return yq||(yq=new t),yq};var e=t.prototype;return e.get=function(){var t=this.pool.pop();if(!t){var e=document.createElement("canvas"),n=e.getContext("2d");t={canvas:e,context:n}}return t},e.put=function(t){this.pool.length>=ue.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)},t}()),Mq=En.WHITE.clone(),Bq=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},Oq="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",Nq=function(){function t(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}var e=t.prototype;return e.updateRenderData=function(){this._updateProperties(),this._updateTexture()},e.destroy=function(){this.image=null},e._updateProperties=function(){if(this.data=Dq.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var t=Pq(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+mq)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*mq/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Jm),this.image.reset(this.canvas)},e._updateTexture=function(){if(this.context&&this.canvas){var t=this.context,e=this.labelInfo,n=this.canvas.width,i=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,n,i),t.fillStyle=Oq,t.fillRect(0,0,n,i),t.font=e.fontDesc;var r=e.fontSize,o=n/2,a=i/2+r*vq+0*r,s=e.color;if(t.lineJoin="round",t.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",e.isOutlined){var c=e.out||Mq;t.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",t.lineWidth=2*e.margin,t.strokeText(this.char,o,a)}t.fillText(this.char,o,a)}},t}(),Lq=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.initWithSize=function(t,e,n){void 0===n&&(n=wm.RGBA8888),this.reset({width:t,height:e,format:n})},n.drawTextureAt=function(t,e,n){var i=this.getGFXTexture();if(t&&i){var r=this._getGFXDevice();if(r){var o=new or;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],i,[o])}else console.warn("Unable to get device")}},e}(yv),Fq=function(){function t(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new Lq;n.initWithSize(t,e),this.fontDefDictionary=new fq(n),this._halfBleed=1,this._width=t,this._height=e,zB.on(FB.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var e=t.prototype;return e.insertLetterTexture=function(t){var e=t.image,n=zB.root.device;if(!e||!this.fontDefDictionary||!n)return null;var i=e.width,r=e.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return I(12100),null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;var o=new Bq;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=t.width-2,o.h=t.height-2,o.xAdvance=o.w,o.offsetY=t.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(t.hash,o),o},e.update=function(){this._dirty&&(this._dirty=!1)},e.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},e.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},e.getTexture=function(){return this.fontDefDictionary.getTexture()},e.beforeSceneLoad=function(){this.clearAllCache()},e.clearAllCache=function(){this.destroy();var t=new Lq;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t},e.getLetter=function(t){return this.fontDefDictionary.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t,e){var n=t.charCodeAt(0)+e.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new Nq(t,e);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},K(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(),zq={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:En.WHITE.clone(),isOutlined:!1,out:En.WHITE.clone(),margin:0},Vq=[new Pr(Ki.ATTR_POSITION,_i.RGB32F)],kq=[new Pr(Ki.ATTR_POSITION,_i.RGB32F),new Pr(Ki.ATTR_COLOR,_i.RGBA32F)],Gq=[new Pr(Ki.ATTR_POSITION,_i.RGB32F),new Pr(Ki.ATTR_TEX_COORD,_i.RG32F),new Pr(Ki.ATTR_COLOR,_i.RGBA32F)],Uq=[new Pr(Ki.ATTR_POSITION,_i.RGB32F),new Pr(Ki.ATTR_TEX_COORD,_i.RG32F),new Pr(Ki.ATTR_COLOR,_i.RGBA32F),new Pr(Ki.ATTR_COLOR2,_i.RGBA32F)];function Hq(t){for(var e=0,n=0;n<t.length;n++){var i=t[n];e+=Zr[i.format].count}return e}function jq(t){for(var e=0,n=0;n<t.length;n++){var i=t[n];e+=Zr[i.format].size}return e}c.internal.vfmtPosUvColor=Gq,c.internal.vfmtPosUvTwoColor=Uq,t("UIVertexFormat",Object.freeze({__proto__:null,vfmt:Vq,vfmtPosColor:kq,vfmtPosUvColor:Gq,vfmtPosUvTwoColor:Uq,getComponentPerVertex:Hq,getAttributeStride:jq}));var Wq,qq,Xq,Yq,Kq,Jq,Qq,Zq,$q,tX,eX,nX,iX,rX,oX,aX=jq(Gq)>>2,sX=new Ul((function(){return{x:0,y:0,z:0,u:0,v:0,color:En.WHITE.clone()}}),128),cX=null,lX=t("BaseRenderData",function(){function t(t){void 0===t&&(t=Gq),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=Gq,this._floatStride=t===Gq?aX:jq(t)>>2,this._vertexFormat=t}return t.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},K(t,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),t}()),uX=t("RenderData",function(t){function e(e,n){var i;return void 0===e&&(e=Gq),(i=t.call(this,e)||this).indices=null,i.vertDirty=!0,i.frame=void 0,i.layer=0,i.blendHash=-1,i.textureHash=0,i.nodeDirty=!0,i.passDirty=!0,i.textureDirty=!0,i.hashDirty=!0,i._data=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i._accessor=null,n||(n=zB.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i}Q(e,t),e.add=function(t,n){void 0===t&&(t=Gq),cX||(cX=new Hl((function(){return new e}),32));var i=cX.add();return i._floatStride=t===Gq?aX:jq(t)>>2,i._vertexFormat=t,n||(n=zB.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i},e.remove=function(t){var e=cX.data.indexOf(t);-1!==e&&(t.clear(),t._accessor=null,cX.removeAt(e))};var n=e.prototype;return n.resize=function(t,e){t===this._vc&&e===this._ic&&this.chunk||(this._vc=t,this._ic=e,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(t,e),this.updateHash())},n.resizeAndCopy=function(t,e){if(t!==this._vc||e!==this._ic||!this.chunk){this._vc=t,this._ic=e;var n=this.chunk;this.chunk=this._accessor.allocateChunk(t,e),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}},n.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},n.updateNode=function(t){this.layer=t.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(t){this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(t){this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var t=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=vo(t,666),this.hashDirty=!1},n.updateRenderData=function(t,e){if(this.passDirty&&(this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=t.node.scene?t._getRenderScene():null;this.layer=t.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(t,e,n,i){t===this._width&&e===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=t,this._height=e,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},K(e,[{key:"dataLength",get:function(){return this._data.length},set:function(t){var e=this._data;if(e.length!==t){var n=e.length,i=0;for(i=t;i<n;i++)sX.free(e[i]);for(i=n;i<t;i++)e[i]=sX.alloc();e.length=t}}},{key:"data",get:function(){return this._data}}]),e}(lX)),hX=t("MeshRenderData",function(t){function e(e){var n;return void 0===e&&(e=Gq),(n=t.call(this,e)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}Q(e,t),e.add=function(t){void 0===t&&(t=Gq);var e=_X.add();return e._floatStride=t===Gq?aX:jq(t)>>2,e._vertexFormat=t,e},e.remove=function(t){var e=_X.data.indexOf(t);-1!==e&&(_X.data[e].clear(),_X.removeAt(e))};var n=e.prototype;return n.request=function(t,e){var n=this._byteLength+t*this.stride;return!!this.reserve(t,e)&&(this._vc+=t,this._ic+=e,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},n.reserve=function(t,e){var n=this._byteLength+t*this.stride,i=this.indexCount+e;if(t+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.resize=function(t,e){var n=t*this.stride;t>=0&&e>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=t,this._ic=e,this._byteLength=n,this.updateRange(0,t,0,e)},n.updateRange=function(t,e,n,i){e>=0&&i>=0&&e<=this._vc&&this._ic,this.vertexStart=t,this.indexStart=n,this.vertexRange=e,this.indexRange=i},n.requestIA=function(t){this._initIAInfo(t);var e=this._iaPool.add();return e.firstIndex=this.indexStart,e.indexCount=this.indexRange,e},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var t=this._ic,e=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,t),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(e);var r=t<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(t){var e=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(t.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=t.createBuffer(new hr(pi.INDEX|pi.TRANSFER_DST,gi.DEVICE,r,r))),this._iaInfo=new Rr(this._vertexFormat,i,this._indexBuffer),this._iaPool=new Hl((function(){return t.createInputAssembler(e._iaInfo)}),1,(function(t){t.destroy()}))}},n._reallocBuffer=function(t,e){var n=this.vData;this.vData=new Float32Array(t),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(e),i&&this.iData.set(i,0)},K(e,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),e}(lX)),_X=new Hl((function(){return new hX}),32),fX=new Xn,dX=new Xn,pX=(new Pn,new Hn),mX=new Hn,vX=new Hn,gX=new Hn(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),yX=new ni,xX=function(e){return t({UITransform:e,UITransformComponent:e}),e}((Wq=fc("cc.UITransform"),qq=Ic(),Xq=pc(110),Yq=Tc(),Kq=kc(),Jq=Oc(),Qq=kc(),Zq=Oc(),Wq($q=qq($q=Xq($q=Yq($q=mc($q=bc((rX=iX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._priority=0,at(e,"_contentSize",eX,it(e)),at(e,"_anchorPoint",nX,it(e)),e}Q(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&e.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(zC.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(zC.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(t,e){var n=this._contentSize;if(void 0===e){if((t=t).width===n.width&&t.height===n.height)return;n.width=t.width,n.height=t.height}else{if(t===n.width&&e===n.height)return;n.width=t,n.height=e}this.node.emit(zC.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(t,e){var n=this._anchorPoint;if(void 0===e){if((t=t).x===n.x&&t.y===n.y)return;n.x=t.x,n.y=t.y}else{if(t===n.x&&e===n.y)return;n.x=t,n.y=e}this.node.emit(zC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(t){for(var e,n=this._contentSize.width,i=this._contentSize.height,r=fX,o=dX,a=null===(e=this.node)||void 0===e?void 0:e.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(pX);var u=pX.m12,h=pX.m13,_=GB.center;if(pX.m12=_.x-(pX.m00*u+pX.m04*h),pX.m13=_.y-(pX.m01*u+pX.m05*h),Hn.invert(pX,pX),Xn.transformMat4(r,t,pX),this.node.getWorldMatrix(vX),Hn.invert(pX,vX),!Hn.strictEquals(pX,gX)){Xn.transformMat4(o,r,pX),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i;var f=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i&&(f=!0,a&&a.maskList))for(var d=a.maskList,p=this.node,m=d?d.length:0,v=0,g=0;p&&g<m;++v,p=p.parent){var y=d[g];if(v===y.index){if(p!==y.comp.node){d.length=g;break}var x=y.comp;if(x&&x._enabled&&!x.isHit(r)){f=!1;break}g++}else if(v>y.index){d.length=g;break}}if(f)return!0}}}return!1},n.convertToNodeSpaceAR=function(t,e){return this.node.getWorldMatrix(vX),Hn.invert(pX,vX),e||(e=new Pn),Pn.transformMat4(e,t,pX)},n.convertToWorldSpaceAR=function(t,e){return this.node.getWorldMatrix(vX),e||(e=new Pn),Pn.transformMat4(e,t,vX)},n.getBoundingBox=function(){Hn.fromRTS(mX,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,e=this._contentSize.height,n=new ni(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return n.transformMat4(mX),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(vX),this.getBoundingBoxTo(vX)):this.getBoundingBox()},n.getBoundingBoxTo=function(t){Hn.fromRTS(mX,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new ni(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(Hn.multiply(vX,t,mX),r.transformMat4(vX),!this.node.children)return r;for(var o,a=ot(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(e);if(c){var l=c.getBoundingBoxTo(t);l&&ni.union(r,r,l)}}}return r},n.getComputeAABB=function(t){var e=this._contentSize.width,n=this._contentSize.height;yX.set(-this._anchorPoint.x*e,-this._anchorPoint.y*n,e,n),yX.transformMat4(this.node.worldMatrix);var i=yX.x+.5*yX.width,r=yX.y+.5*yX.height,o=this.node.worldPosition.z,a=yX.width/2,s=yX.height/2;return null!=t?(js.set(t,i,r,o,a,s,.001),t):new js(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&e.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var t=this.node._uiProps.uiComp;t&&(t.markForUpdateRenderData(),t.renderData&&(t.renderData.vertDirty=!0))},e.insertChangeMap=function(t){var n=t.uuid;e.priorityChangeNodeMap.has(n)||e.priorityChangeNodeMap.set(n,t)},e._sortChildrenSibling=function(t){var e=t.children;e&&e.sort((function(t,e){var n=t._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?t.getSiblingIndex()-e.getSiblingIndex():r}))},e._sortSiblings=function(){e.priorityChangeNodeMap.forEach((function(t){e._sortChildrenSibling(t),t._updateSiblingIndex(),t.emit("childrenSiblingOrderChanged")})),e.priorityChangeNodeMap.clear()},e._cleanChangeMap=function(){e.priorityChangeNodeMap.clear()},K(e,[{key:"contentSize",get:function(){return this._contentSize},set:function(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(zC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(zC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(zC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(zC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(zC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(zC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority!==t&&(this.node.getComponent("cc.RenderRoot2D")?I(6706):(this._priority=t,this.node.parent&&e.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var t=zB.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}},{key:"cameraPriority",get:function(){var t=zB.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}}]),e}(Qu),iX.EventType=zC,iX.priorityChangeNodeMap=new Map,st((tX=rX).prototype,"contentSize",[Kq,Jq],Object.getOwnPropertyDescriptor(tX.prototype,"contentSize"),tX.prototype),st(tX.prototype,"anchorPoint",[Qq,Zq],Object.getOwnPropertyDescriptor(tX.prototype,"anchorPoint"),tX.prototype),eX=st(tX.prototype,"_contentSize",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(100,100)}}),nX=st(tX.prototype,"_anchorPoint",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(.5,.5)}}),$q=tX))||$q)||$q)||$q)||$q)||$q)||$q));zB.on(FB.EVENT_AFTER_UPDATE,xX._sortSiblings),zB.on(FB.EVENT_BEFORE_SCENE_LAUNCH,xX._cleanChangeMap),function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(oX||(oX={}));var SX,AX,CX,bX,TX,EX,wX,PX,IX,RX,DX,MX,BX,OX,NX,LX,FX,zX,VX,kX,GX=t("StencilManager",function(){function t(){this.stage=oX.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Ei.ALWAYS,stencilMask:65535,writeMask:65535,failOp:wi.KEEP,zFailOp:wi.KEEP,passOp:wi.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var e=t.prototype;return e.pushMask=function(t){this._maskStack.push(t)},e.clear=function(t){t.stencilStage=t.inverted?oX.CLEAR_INVERTED:oX.CLEAR},e.enterLevel=function(t){t.graphics.stencilStage=t.inverted?oX.ENTER_LEVEL_INVERTED:oX.ENTER_LEVEL},e.enableMask=function(){this.stage=oX.ENABLED},e.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=oX.DISABLED:this.stage=oX.ENABLED)},e.getWriteMask=function(){return 1<<this._maskStack.length-1},e.getExitWriteMask=function(){return 1<<this._maskStack.length},e.getStencilRef=function(){for(var t=0,e=0;e<this._maskStack.length;++e)t+=1<<e;return t},e.reset=function(){this._maskStack.length=0,this.stage=oX.DISABLED},e.destroy=function(){this.stencilStateMap.forEach((function(t){t.destroy()})),this.stencilStateMap.clear()},e.getStencilStage=function(t,e){var n=0,i=!1,r=!1,o=Ei.LESS,a=this.stencilStateMap;if(e&&e.passes[0]){var s=e.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|t<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=t<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(t);var u=new Co(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},e.getStencilHash=function(t){return t<<8|this._maskStack.length},e.setStateFromStage=function(t){var e=this._stencilPattern;t===oX.DISABLED?(e.stencilTest=!1,e.func=Ei.ALWAYS,e.failOp=wi.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===oX.ENABLED?(e.func=Ei.EQUAL,e.failOp=wi.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===oX.CLEAR?(e.func=Ei.NEVER,e.failOp=wi.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===oX.CLEAR_INVERTED||t===oX.ENTER_LEVEL?(e.func=Ei.NEVER,e.failOp=wi.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===oX.ENTER_LEVEL_INVERTED&&(e.func=Ei.NEVER,e.failOp=wi.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))},K(t,[{key:"pattern",get:function(){return this._stencilPattern}}]),t}());GX.sharedManager=null,GX.sharedManager=new GX,ce(Pi),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(kX||(kX=t("InstanceMaterialType",{})));var UX,HX,jX,WX,qX,XX,YX,KX,JX,QX,ZX,$X,tY,eY,nY,iY,rY,oY,aY,sY,cY,lY,uY,hY,_Y,fY,dY,pY,mY,vY,gY,yY,xY,SY,AY,CY,bY,TY,EY,wY,PY,IY,RY,DY,MY,BY,OY,NY,LY,FY,zY,VY,kY,GY,UY,HY,jY,WY,qY,XY,YY,KY,JY,QY,ZY,$Y,tK,eK,nK,iK,rK=function(e){return t({Renderable2D:e,RenderComponent:e,UIRenderable:e}),e}((SX=fc("cc.Renderable2D"),AX=dc(xX),CX=Dc(),bX=Xc(rg),TX=Xc(rg),EX=kc(),wX=Oc(),PX=Bc(),IX=kc(),RX=Oc(),SX(DX=AX(DX=mc(DX=bc((VX=zX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_materials",BX,it(e)),at(e,"_customMaterial",OX,it(e)),e.stencilStage=oX.DISABLED,at(e,"_srcBlendFactor",NX,it(e)),at(e,"_dstBlendFactor",LX,it(e)),at(e,"_color",FX,it(e)),e._assembler=null,e._postAssembler=null,e._renderData=null,e._renderDataFlag=!0,e._renderFlag=!0,e._delegateSrc=null,e._instanceMaterialType=-1,e._blendState=new To,e._blendHash=0,e._lastParent=null,e}Q(e,t);var n=e.prototype;return n.updateBlendHash=function(){var t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(zC.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(zC.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(zC.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(zC.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var t=0;t<this._materialInstances.length;t++){var e=this._materialInstances[t];e&&e.destroy()}this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(t){if(void 0===t&&(t=!0),this._renderFlag=this._canRender(),t){var e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else this._renderDataFlag=t},n.requestRenderData=function(){var t=uX.add();return this._renderData=t,t},n.destroyRenderData=function(){this._renderData&&(uX.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(t){this._renderDataFlag&&(this._assembler.updateRenderData(this,t),this._renderDataFlag=!1),this._renderFlag&&this._render(t)},n.postUpdateAssembler=function(t){this._postAssembler&&this._renderFlag&&this._postRender(t)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._renderData&&(this._renderData.material=t,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var t=this._blendState.targets[0];t||(t=new bo,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=Pi.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var t=0;t<this.node.children.length;++t){var n=this.node.children[t].getComponent(e);n&&n.markForUpdateRenderData()}},n._onMaterialModified=function(e,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),t.prototype._onMaterialModified.call(this,e,n)},n._updateBuiltinMaterial=function(){var t;switch(this._instanceMaterialType){case kX.ADD_COLOR:t=Pv.get("ui-base-material");break;case kX.GRAYSCALE:t=Pv.get("ui-sprite-gray-material");break;case kX.USE_ALPHA_SEPARATED:t=Pv.get("ui-sprite-alpha-sep-material");break;case kX.USE_ALPHA_SEPARATED_AND_GRAY:t=Pv.get("ui-sprite-gray-alpha-sep-material");break;default:t=Pv.get("ui-sprite-material")}return t},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},K(e,[{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var n=t.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(t.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(t){this._customMaterial=t,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&I(12001),this._srcBlendFactor},set:function(t){this._customMaterial?I(12001):this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&I(12001),this._dstBlendFactor},set:function(t){this._customMaterial?I(12001):this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color.equals(t)||(this._color.set(t),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(t){this._delegateSrc=t}},{key:"blendHash",get:function(){return this._blendHash}}]),e}(cF),zX.BlendState=Pi,zX.Assembler=null,zX.PostAssembler=null,BX=st((MX=VX).prototype,"_materials",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),st(MX.prototype,"sharedMaterials",[il,CX],Object.getOwnPropertyDescriptor(MX.prototype,"sharedMaterials"),MX.prototype),OX=st(MX.prototype,"_customMaterial",[bX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),st(MX.prototype,"customMaterial",[TX,EX,wX,PX],Object.getOwnPropertyDescriptor(MX.prototype,"customMaterial"),MX.prototype),st(MX.prototype,"color",[IX,RX],Object.getOwnPropertyDescriptor(MX.prototype,"color"),MX.prototype),NX=st(MX.prototype,"_srcBlendFactor",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pi.SRC_ALPHA}}),LX=st(MX.prototype,"_dstBlendFactor",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pi.ONE_MINUS_SRC_ALPHA}}),FX=st(MX.prototype,"_color",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return En.WHITE.clone()}}),DX=MX))||DX)||DX)||DX)||DX));c.internal.Renderable2D=rK,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(tK||(tK=t("HorizontalTextAlignment",{}))),ce(tK),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(eK||(eK=t("VerticalTextAlignment",{}))),ce(eK),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(nK||(nK=t("Overflow",{}))),ce(nK),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(iK||(iK=t("CacheMode",{}))),ce(iK);var oK=function(e){return t({Label:e,LabelComponent:e}),e}((UX=fc("cc.Label"),HX=Ic(),jX=pc(110),WX=Tc(),qX=kc(),XX=Oc(),YX=Xc(tK),KX=kc(),JX=Oc(),QX=Xc(eK),ZX=kc(),$X=Oc(),tY=kc(),eY=Oc(),nY=kc(),iY=Dc(),rY=Oc(),oY=kc(),aY=Oc(),sY=Dc(),cY=kc(),lY=Oc(),uY=Xc(nK),hY=kc(),_Y=Oc(),fY=kc(),dY=Oc(),pY=Xc(tq),mY=kc(),vY=Dc(),gY=Oc(),yY=kc(),xY=Oc(),SY=Xc(iK),AY=kc(),CY=Oc(),bY=kc(),TY=Oc(),EY=kc(),wY=Oc(),PY=kc(),IY=Oc(),RY=Dc(),DY=kc(),MY=Oc(),UX(BY=HX(BY=jX(BY=WX(($Y=ZY=function(t){function e(){var e;return at(e=t.call(this)||this,"_string",NY,it(e)),at(e,"_horizontalAlign",LY,it(e)),at(e,"_verticalAlign",FY,it(e)),at(e,"_actualFontSize",zY,it(e)),at(e,"_fontSize",VY,it(e)),at(e,"_fontFamily",kY,it(e)),at(e,"_lineHeight",GY,it(e)),at(e,"_overflow",UY,it(e)),at(e,"_enableWrapText",HY,it(e)),at(e,"_font",jY,it(e)),at(e,"_isSystemFontUsed",WY,it(e)),at(e,"_spacingX",qY,it(e)),at(e,"_isItalic",XY,it(e)),at(e,"_isBold",YY,it(e)),at(e,"_isUnderline",KY,it(e)),at(e,"_underlineHeight",JY,it(e)),at(e,"_cacheMode",QY,it(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}Q(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var e=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),e){var n=e;n.image&&n.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,t.prototype.onDestroy.call(this)},n.updateRenderData=function(t){void 0===t&&(t=!1),this.markForUpdateRenderData(),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){t.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!t.prototype._canRender.call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof dq){var n=e.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var t=this._font;if(t instanceof dq){var e=t.spriteFrame;e&&e.texture&&(this._texture=e,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===iK.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new XW,this._assemblerData=this._assembler.getAssemblerData();var n=new Jm(this._assemblerData.canvas),i=new yv;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==iK.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var t=!1;if(this.cacheMode!==iK.CHAR){var e=this._texture.texture;if(e instanceof Ym){var n=e.getPixelFormat();t=n===wm.RGBA_ETC1||n===wm.RGB_A_PVRTC_4BPPV1||n===wm.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=t?kX.USE_ALPHA_SEPARATED:kX.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},K(e,[{key:"string",get:function(){return this._string},set:function(t){t=null==t?"":t.toString(),this._string!==t&&(this._string=t,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(t){this._actualFontSize=t}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode!==iK.BITMAP||this._font instanceof dq||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===iK.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(t){this._fontAtlas=t}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof dq?this._font.fontSize:-1}}]),e}(rK),ZY.HorizontalAlign=tK,ZY.VerticalAlign=eK,ZY.Overflow=nK,ZY.CacheMode=iK,ZY._canvasPool=Dq.getInstance(),st((OY=$Y).prototype,"string",[qX,XX,Gc],Object.getOwnPropertyDescriptor(OY.prototype,"string"),OY.prototype),st(OY.prototype,"horizontalAlign",[YX,KX,JX],Object.getOwnPropertyDescriptor(OY.prototype,"horizontalAlign"),OY.prototype),st(OY.prototype,"verticalAlign",[QX,ZX,$X],Object.getOwnPropertyDescriptor(OY.prototype,"verticalAlign"),OY.prototype),st(OY.prototype,"fontSize",[tY,eY],Object.getOwnPropertyDescriptor(OY.prototype,"fontSize"),OY.prototype),st(OY.prototype,"fontFamily",[nY,iY,rY],Object.getOwnPropertyDescriptor(OY.prototype,"fontFamily"),OY.prototype),st(OY.prototype,"lineHeight",[oY,aY],Object.getOwnPropertyDescriptor(OY.prototype,"lineHeight"),OY.prototype),st(OY.prototype,"spacingX",[sY,cY,lY],Object.getOwnPropertyDescriptor(OY.prototype,"spacingX"),OY.prototype),st(OY.prototype,"overflow",[uY,hY,_Y],Object.getOwnPropertyDescriptor(OY.prototype,"overflow"),OY.prototype),st(OY.prototype,"enableWrapText",[fY,dY],Object.getOwnPropertyDescriptor(OY.prototype,"enableWrapText"),OY.prototype),st(OY.prototype,"font",[pY,mY,vY,gY],Object.getOwnPropertyDescriptor(OY.prototype,"font"),OY.prototype),st(OY.prototype,"useSystemFont",[yY,xY],Object.getOwnPropertyDescriptor(OY.prototype,"useSystemFont"),OY.prototype),st(OY.prototype,"cacheMode",[SY,AY,CY],Object.getOwnPropertyDescriptor(OY.prototype,"cacheMode"),OY.prototype),st(OY.prototype,"isBold",[bY,TY],Object.getOwnPropertyDescriptor(OY.prototype,"isBold"),OY.prototype),st(OY.prototype,"isItalic",[EY,wY],Object.getOwnPropertyDescriptor(OY.prototype,"isItalic"),OY.prototype),st(OY.prototype,"isUnderline",[PY,IY],Object.getOwnPropertyDescriptor(OY.prototype,"isUnderline"),OY.prototype),st(OY.prototype,"underlineHeight",[RY,Rc,DY,MY],Object.getOwnPropertyDescriptor(OY.prototype,"underlineHeight"),OY.prototype),NY=st(OY.prototype,"_string",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),LY=st(OY.prototype,"_horizontalAlign",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tK.CENTER}}),FY=st(OY.prototype,"_verticalAlign",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eK.CENTER}}),zY=st(OY.prototype,"_actualFontSize",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VY=st(OY.prototype,"_fontSize",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),kY=st(OY.prototype,"_fontFamily",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),GY=st(OY.prototype,"_lineHeight",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),UY=st(OY.prototype,"_overflow",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nK.NONE}}),HY=st(OY.prototype,"_enableWrapText",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jY=st(OY.prototype,"_font",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WY=st(OY.prototype,"_isSystemFontUsed",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qY=st(OY.prototype,"_spacingX",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XY=st(OY.prototype,"_isItalic",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YY=st(OY.prototype,"_isBold",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),KY=st(OY.prototype,"_isUnderline",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JY=st(OY.prototype,"_underlineHeight",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),QY=st(OY.prototype,"_cacheMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iK.NONE}}),BY=OY))||BY)||BY)||BY)||BY));c.Label=oK;var aK,sK,cK=0,lK={};function uK(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function hK(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(aK||(aK={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(sK||(sK={}));var _K,fK,dK,pK=function(){function t(t){this._device=void 0,this._format=_i.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new or,this._region1=new or,this._region2=new or,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}var e=t.prototype;return e.initialize=function(t){var e=Zr[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=so(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)},e.destroy=function(){for(var t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0},e.alloc=function(t,e){t=hK(t,this._alignment);var n=-1,i=-1;if(void 0!==e&&(n=e,i=this._findAvailableSpace(t,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(t,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=t;var a={chunkIdx:n,start:i,end:i+t,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(t/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,uK(s)),l=this._chunks[this.createChunk(c)];l.start+=t;var u={chunkIdx:this._chunkCount-1,start:0,end:t,texture:l.texture};return this._handles.push(u),u},e.free=function(t){for(var e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)},e.createChunk=function(t){var e=t*t*this._formatSize;A("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+e+", format: "+this._format);var n={texture:this._device.createTexture(new mr(yi.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,this._format,t,t)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=n,this._chunkCount++},e.update=function(t,e){var n=[],i=[],r=t.start/this._formatSize,o=e.byteLength/this._formatSize,a=r%t.texture.width,s=Math.floor(r/t.texture.width),c=Math.min(t.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(o/t.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,t.texture,i)},e._findAvailableSpace=function(t,e){var n=this._chunks[e],i=!1,r=n.start;if(r+t<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(t){return t.chunkIdx===e})).sort((function(t,e){return t.start-e.start})),a=0;a<o.length;a++){var s=o[a];if(r+t<=s.start){i=!0;break}r=s.end}!i&&r+t<=n.size&&(i=!0)}return i?r:-1},e._McDonaldAlloc=function(t){t=hK(t,this._alignment);for(var e=0;e<this._chunkCount;++e){var n=this._chunks[e],i=!1,r=n.start;if(r+t<=n.end?i=!0:r>n.end?r+t<=n.size?i=!0:t<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,t<=n.end&&(i=!0)),i){n.start+=t;var o={chunkIdx:e,start:r,end:r+t,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(t/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,uK(a)),c=this._chunks[this.createChunk(s)];c.start+=t;var l={chunkIdx:this._chunkCount,start:0,end:t,texture:c.texture};return this._handles.push(l),l},t}(),mK=function(t){if(void 0===lK[t]){var e=1<<cK;lK[t]=e,cK+=1}},vK=Object.freeze({__proto__:null,addStage:mK,scene:bA,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;for(var n=[],i=e.positions.length/3,r=0;r<i;++r)n.push(e.positions[3*r],e.positions[3*r+1],e.positions[3*r+2]),e.normals&&n.push(e.normals[3*r],e.normals[3*r+1],e.normals[3*r+2]),e.uvs&&n.push(e.uvs[2*r],e.uvs[2*r+1]),e.colors&&n.push(e.colors[3*r],e.colors[3*r+1],e.colors[3*r+2]);var o=[];o.push(new Pr(Ki.ATTR_POSITION,_i.RGB32F)),e.normals&&o.push(new Pr(Ki.ATTR_NORMAL,_i.RGB32F)),e.uvs&&o.push(new Pr(Ki.ATTR_TEX_COORD,_i.RG32F)),e.colors&&o.push(new Pr(Ki.ATTR_COLOR,_i.RGB32F));var a=t.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return e.indices&&(s=t.createBuffer(new hr(pi.INDEX|pi.TRANSFER_DST,gi.DEVICE,2*e.indices.length,2))).update(new Uint16Array(e.indices)),t.createInputAssembler(new Rr(o,[a],s))},get RenderQueue(){return aK},get PassStage(){return sK},genHandle:$p,getTypeFromHandle:tm,getBindingFromHandle:em,getCountFromHandle:nm,getOffsetFromHandle:im,customizeType:rm,type2reader:om,type2writer:am,getDefaultFromType:cm,overrideMacros:lm,get BatchingSchemes(){return bv},Pass:Nv,getDeviceShaderVersion:mm,programLib:Tm,nearestPOT:uK,TextureBufferPool:pK,MaterialInstance:_A,PassInstance:hA,get PoolType(){return bs},NULL_HANDLE:0,get NodeView(){return Ts},NodePool:Rs,get PassView(){return ws},PassPool:Os,get AABBView(){return Ds},AABBPool:Fs});t("renderer",vK),function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}(_K||(_K={})),ce(_K),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(fK||(fK={})),ce(fK),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(dK||(dK={})),ce(dK);var gK=Math.PI,yK=Math.min,xK=Math.max,SK=Math.cos,AK=Math.sin,CK=Math.abs,bK=Math.sign,TK=.5522847493;function EK(t,e,n,i,r){t.moveTo(e-i,n),t.bezierCurveTo(e-i,n+r*TK,e-i*TK,n+r,e,n+r),t.bezierCurveTo(e+i*TK,n+r,e+i,n+r*TK,e+i,n),t.bezierCurveTo(e+i,n-r*TK,e+i*TK,n-r,e,n-r),t.bezierCurveTo(e-i*TK,n-r,e-i,n-r*TK,e-i,n),t.close()}function wK(t,e,n,i,r,o,a,s,c,l,u){var h,_,f,d,p,m,v,g,y,x,S,A,C,b,T,E;l>10||(p=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(e+i))+(f=.5*(i+o))),g=.5*((_=.5*(n+r))+(d=.5*(r+a))),((T=CK((i-s)*(b=c-n)-(r-c)*(C=s-e)))+(E=CK((o-s)*b-(a-c)*C)))*(T+E)<t.tessTol*(C*C+b*b)?t.addPoint(s,c,0===u?u|dK.PT_BEVEL:u):(wK(t,e,n,h,_,v,g,S=.5*(v+(y=.5*(f+p))),A=.5*(g+(x=.5*(d+m))),l+1,0),wK(t,S,A,y,x,p,m,s,c,l+1,u)))}var PK,IK,RK,DK,MK,BK,OK,NK,LK,FK,zK,VK,kK,GK,UK,HK,jK,WK,qK,XK,YK,KK,JK,QK,ZK,$K,tJ,eJ,nJ,iJ,rJ,oJ,aJ,sJ,cJ,lJ,uJ,hJ,_J,fJ,dJ,pJ,mJ,vJ,gJ,yJ,xJ,SJ=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return Q(e,t),e.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},e}(Xn),AJ=function(){function t(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return t.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},t}(),CJ=function(){function t(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=En.WHITE.clone(),this.lineCap=_K.BUTT,this.strokeColor=En.BLACK.clone(),this.lineJoin=fK.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var e=t.prototype;return e.moveTo=function(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,dK.PT_CORNER),this._commandX=t,this._commandY=e},e.lineTo=function(t,e){this.addPoint(t,e,dK.PT_CORNER),this._commandX=t,this._commandY=e},e.bezierCurveTo=function(t,e,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==t||s.y!==e||n!==r||i!==o?(wK(this,s.x,s.y,t,e,n,i,r,o,0,dK.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},e.quadraticCurveTo=function(t,e,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(t-r),o+2/3*(e-o),n+2/3*(t-n),i+2/3*(e-i),n,i)},e.arc=function(t,e,n,i,r,o){!function(t,e,n,i,r,o,a){var s,c,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0,g=0,y=0,x=0,S=0,A=0;if(u=o-r,a=a||!1)if(CK(u)>=2*gK)u=2*gK;else for(;u<0;)u+=2*gK;else if(CK(u)>=2*gK)u=2*-gK;else for(;u>0;)u-=2*gK;for(c=0|xK(1,yK(CK(u)/(.5*gK)+.5,5)),h=CK(4/3*(1-SK(s=u/c/2))/AK(s)),a||(h=-h),A=0;A<=c;A++)d=e+(_=SK(l=r+u*(A/c)))*i,p=n+(f=AK(l))*i,m=-f*i*h,v=_*i*h,0===A?t.moveTo(d,p):t.bezierCurveTo(g+x,y+S,d-m,p-v,d,p),g=d,y=p,x=m,S=v}(this,t,e,n,i,r,o)},e.ellipse=function(t,e,n,i){EK(this,t,e,n,i),this._curPath.complex=!1},e.circle=function(t,e,n){EK(this,t,e,n,n),this._curPath.complex=!1},e.rect=function(t,e,n,i){this.moveTo(t,e),this.lineTo(t+n,e),this.lineTo(t+n,e+i),this.lineTo(t,e+i),this.close(),this._curPath.complex=!1},e.roundRect=function(t,e,n,i,r){!function(t,e,n,i,r,o){if(o<.1)t.rect(e,n,i,r);else{var a=yK(o,.5*CK(i))*bK(i),s=yK(o,.5*CK(r))*bK(r);t.moveTo(e,n+s),t.lineTo(e,n+r-s),t.bezierCurveTo(e,n+r-s*(1-TK),e+a*(1-TK),n+r,e+a,n+r),t.lineTo(e+i-a,n+r),t.bezierCurveTo(e+i-a*(1-TK),n+r,e+i,n+r-s*(1-TK),e+i,n+r-s),t.lineTo(e+i,n+s),t.bezierCurveTo(e+i,n+s*(1-TK),e+i-a*(1-TK),n,e+i-a,n),t.lineTo(e+a,n),t.bezierCurveTo(e+a*(1-TK),n,e,n+s*(1-TK),e,n+s),t.close()}}(this,t,e,n,i,r),this._curPath.complex=!1},e.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var t=this._renderDataList,e=0,n=t.length;e<n;e++){var i=t[e];i&&hX.remove(i)}this._renderDataList.length=0},e.close=function(){this._curPath.closed=!0},e.requestRenderData=function(){var t=hX.add();return this._renderDataList.push(t),t},e.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},e.addPoint=function(t,e,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=t,a.y=e):(a=new SJ(t,e),r.push(a)),a.flags=n,o.push(a)}},e._addPath=function(){var t=this.pathLength,e=this.paths[t];return e?e.reset():(e=new AJ,this.paths.push(e)),this.pathLength++,this._curPath=e,e},t}(),bJ=kq.concat([new Pr("a_dist",_i.R32F)]),TJ=Hq(bJ),EJ=jq(bJ),wJ=function(e){return t({Graphics:e,GraphicsComponent:e}),e}((PK=fc("cc.Graphics"),IK=Ic(),RK=pc(110),DK=Tc(),MK=Oc(),BK=Xc(fK),OK=Oc(),NK=Xc(_K),LK=Oc(),FK=Oc(),zK=Oc(),VK=Oc(),kK=Dc(),PK(GK=IK(GK=RK(GK=DK((JK=KK=function(t){function e(){var e;return(e=t.call(this)||this).impl=null,e.model=null,at(e,"_lineWidth",HK,it(e)),at(e,"_strokeColor",jK,it(e)),at(e,"_lineJoin",WK,it(e)),at(e,"_lineCap",qK,it(e)),at(e,"_fillColor",XK,it(e)),at(e,"_miterLimit",YK,it(e)),e._isDrawing=!1,e._isNeedUploadData=!0,e._graphicsUseSubMeshes=[],e._instanceMaterialType=kX.ADD_COLOR,e.impl=new CJ,e}Q(e,t);var n=e.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=zB.root.createModel(rA),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){t.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){t.prototype.onDisable.call(this)},n.onDestroy=function(){this._sceneGetter=null,this.model&&(zB.root.destroyModel(this.model),this.model=null);var e=this._graphicsUseSubMeshes.length;if(e>0){for(var n=0;n<e;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),t.prototype.onDestroy.call(this)},n.moveTo=function(t,e){this.impl&&this.impl.moveTo(t,e)},n.lineTo=function(t,e){this.impl&&this.impl.lineTo(t,e)},n.bezierCurveTo=function(t,e,n,i,r,o){this.impl&&this.impl.bezierCurveTo(t,e,n,i,r,o)},n.quadraticCurveTo=function(t,e,n,i){this.impl&&this.impl.quadraticCurveTo(t,e,n,i)},n.arc=function(t,e,n,i,r,o){this.impl&&this.impl.arc(t,e,n,i,r,o)},n.ellipse=function(t,e,n,i){this.impl&&this.impl.ellipse(t,e,n,i)},n.circle=function(t,e,n){this.impl&&this.impl.circle(t,e,n)},n.rect=function(t,e,n,i){this.impl&&this.impl.rect(t,e,n,i)},n.roundRect=function(t,e,n,i,r){this.impl&&this.impl.roundRect(t,e,n,i,r)},n.fillRect=function(t,e,n,i){this.rect(t,e,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var t;this._customMaterial?t=this.getMaterialInstance(0):(t=Pv.get("ui-graphics-material"),this.setMaterial(t,0),(t=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(t){if(this.model){if(this.model.subModels.length<=t){var e=c.director.root.device,n=e.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.DEVICE,65535*EJ,EJ)),i=e.createBuffer(new hr(pi.INDEX|pi.TRANSFER_DST,gi.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new LE([n],bJ,Fi.TRIANGLE_LIST,i);r.subMeshIdx=0,this.model.initSubModel(t,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else I(4500,this.node.name)},n._uploadData=function(){var t=this.impl;if(t){var e=t&&t.getRenderDataList();if(!(e.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<e.length;i++){var r=e[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*TJ);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(t){if(this._isNeedUploadData){if(this.impl){var e=this.impl.getRenderDataList(),n=this.model.subModels.length;if(e.length>n)for(var i=n;i<e.length;i++)this.activeSubModel(i)}this._uploadData()}t.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t)},n._canRender=function(){return!!t.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},K(e,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}},{key:"lineCap",get:function(){return this._lineCap},set:function(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(t){this._miterLimit=t}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),e}(rK),KK.LineJoin=fK,KK.LineCap=_K,st((UK=JK).prototype,"lineWidth",[Rc,MK],Object.getOwnPropertyDescriptor(UK.prototype,"lineWidth"),UK.prototype),st(UK.prototype,"lineJoin",[BK,OK],Object.getOwnPropertyDescriptor(UK.prototype,"lineJoin"),UK.prototype),st(UK.prototype,"lineCap",[NK,LK],Object.getOwnPropertyDescriptor(UK.prototype,"lineCap"),UK.prototype),st(UK.prototype,"strokeColor",[FK],Object.getOwnPropertyDescriptor(UK.prototype,"strokeColor"),UK.prototype),st(UK.prototype,"fillColor",[zK],Object.getOwnPropertyDescriptor(UK.prototype,"fillColor"),UK.prototype),st(UK.prototype,"miterLimit",[VK],Object.getOwnPropertyDescriptor(UK.prototype,"miterLimit"),UK.prototype),st(UK.prototype,"color",[il,kK],Object.getOwnPropertyDescriptor(UK.prototype,"color"),UK.prototype),HK=st(UK.prototype,"_lineWidth",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jK=st(UK.prototype,"_strokeColor",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return En.BLACK.clone()}}),WK=st(UK.prototype,"_lineJoin",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fK.MITER}}),qK=st(UK.prototype,"_lineCap",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _K.BUTT}}),XK=st(UK.prototype,"_fillColor",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return En.WHITE.clone()}}),YK=st(UK.prototype,"_miterLimit",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),GK=UK))||GK)||GK)||GK)||GK));c.Graphics=wJ;var PJ,IJ=new Hn,RJ=new Xn,DJ=new Hn,MJ=[];!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(PJ||(PJ={})),ce(PJ);var BJ=function(e){return t({Mask:e,MaskComponent:e}),e}((QK=fc("cc.Mask"),ZK=Ic(),$K=pc(110),tJ=Tc(),eJ=Xc(PJ),nJ=Oc(),iJ=kc(),rJ=Oc(),oJ=Dc(),aJ=Xc(XW),sJ=Dc(),cJ=Dc(),lJ=Nc(),uJ=Dc(),hJ=Dc(),QK(_J=ZK(_J=$K(_J=tJ((xJ=yJ=function(t){function e(){var e;return(e=t.call(this)||this)._clearStencilMtl=null,e._clearModel=null,at(e,"_type",dJ,it(e)),at(e,"_inverted",pJ,it(e)),at(e,"_segments",mJ,it(e)),at(e,"_spriteFrame",vJ,it(e)),at(e,"_alphaThreshold",gJ,it(e)),e._graphics=null,e._clearModelMesh=null,e._instanceMaterialType=kX.ADD_COLOR,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){t.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),t.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){t.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){this._clearModel&&this._clearModelMesh&&(zB.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),t.prototype.onDestroy.call(this)},n.isHit=function(t){var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=n.width,r=n.height,o=RJ;this.node.getWorldMatrix(IJ),Hn.invert(DJ,IJ),Xn.transformMat4(o,t,DJ);var a=e.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===PJ.RECT||this.type===PJ.GRAPHICS_STENCIL||this.type===PJ.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===PJ.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(t){t.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(t){this._postAssembler&&t.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(e){t.prototype._nodeStateChange.call(this,e),this._updateGraphics()},n._canRender=function(){return!!t.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==PJ.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this),n=e.PostAssembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var t=this._graphics=new wJ;t._objFlags|=_l.Flags.IsOnLoadCalled,t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;var e=En.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===PJ.RECT||this._type===PJ.ELLIPSE)){var t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();var n=t.contentSize,i=n.width,r=n.height,o=t.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===PJ.RECT)e.rect(a,s,i,r);else if(this._type===PJ.ELLIPSE){for(var c=function(t,e,n){MJ.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)MJ.push(new Pn(e.x*Math.cos(i*r)+t.x,e.y*Math.sin(i*r)+t.y,0));return MJ}(new Pn(a+i/2,s+r/2,0),new Pn(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?e.moveTo(u.x,u.y):e.lineTo(u.x,u.y)}e.close()}e.fill()}},n._createClearModel=function(){if(!this._clearModel){var t=Pv.get("default-clear-stencil");this._clearStencilMtl=new _A({parent:t,owner:this,subModelIdx:0}),this._clearModel=zB.root.createModel(rA),this._clearModel.node=this._clearModel.transform=this.node;var e=jq(Vq),n=c.director.root.device,i=n.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.DEVICE,4*e,e)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(r);var o=n.createBuffer(new hr(pi.INDEX|pi.TRANSFER_DST,gi.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a),this._clearModelMesh=new LE([i],Vq,Fi.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var t,e=this._graphics;e.stencilStage=oX.DISABLED,this._type===PJ.IMAGE_STENCIL?(t=Pv.get("ui-alpha-test-material"),e.setMaterial(t,0),(t=e.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(t=Pv.get("ui-graphics-material"),e.setMaterial(t,0),e.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==PJ.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},K(e,[{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==PJ.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(t){this._inverted=t,this.stencilStage=oX.DISABLED,this._graphics&&(this._graphics.stencilStage=oX.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(t){this._segments!==t&&(this._segments=sn(t,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this._type===PJ.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===PJ.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),e}(rK),yJ.Type=PJ,st((fJ=xJ).prototype,"type",[eJ,nJ],Object.getOwnPropertyDescriptor(fJ.prototype,"type"),fJ.prototype),st(fJ.prototype,"inverted",[iJ,rJ],Object.getOwnPropertyDescriptor(fJ.prototype,"inverted"),fJ.prototype),st(fJ.prototype,"segments",[oJ],Object.getOwnPropertyDescriptor(fJ.prototype,"segments"),fJ.prototype),st(fJ.prototype,"spriteFrame",[aJ,sJ],Object.getOwnPropertyDescriptor(fJ.prototype,"spriteFrame"),fJ.prototype),st(fJ.prototype,"alphaThreshold",[cJ,lJ,Vc],Object.getOwnPropertyDescriptor(fJ.prototype,"alphaThreshold"),fJ.prototype),st(fJ.prototype,"color",[il,uJ],Object.getOwnPropertyDescriptor(fJ.prototype,"color"),fJ.prototype),st(fJ.prototype,"customMaterial",[il,hJ],Object.getOwnPropertyDescriptor(fJ.prototype,"customMaterial"),fJ.prototype),dJ=st(fJ.prototype,"_type",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PJ.RECT}}),pJ=st(fJ.prototype,"_inverted",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mJ=st(fJ.prototype,"_segments",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),vJ=st(fJ.prototype,"_spriteFrame",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gJ=st(fJ.prototype,"_alphaThreshold",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_J=fJ))||_J)||_J)||_J)||_J));AR._maskComp=BJ,c.Mask=BJ;var OJ,NJ,LJ,FJ,zJ,VJ,kJ,GJ,UJ,HJ,jJ,WJ,qJ,XJ,YJ,KJ,JJ,QJ,ZJ,$J,tQ,eQ,nQ,iQ,rQ,oQ,aQ,sQ,cQ,lQ,uQ,hQ,_Q,fQ,dQ,pQ,mQ,vQ,gQ,yQ,xQ,SQ,AQ,CQ,bQ,TQ,EQ,wQ,PQ,IQ,RQ,DQ,MQ,BQ,OQ,NQ,LQ,FQ,zQ,VQ,kQ,GQ,UQ=/^(click)(\s)*=|(param)(\s)*=/,HQ=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,jQ=t("HtmlTextParser",function(){function t(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var e=t.prototype;return e.parse=function(t){this._resultObjectArray.length=0,this._stack.length=0;for(var e=0,n=t.length;e<n;){var i=t.indexOf(">",e),r=-1;if(i>=0&&(r=t.lastIndexOf("<",i))<e-1&&(r=t.indexOf("<",i+1),i=t.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(t.substring(e)),e=n;else{var o=t.substring(e,r),a=t.substring(r+1,i);""===a&&(o=t.substring(e,i+1)),this._processResult(o),-1===i?i=r:"/"===t.charAt(r+1)?this._stack.pop():this._addToStack(a),e=i+1}}return this._resultObjectArray},e._attributeToObject=function(t){t=t.trim();var e={},n=/^(color|size)(\s)*=/.exec(t),i="",r=0,o="";if(n){if(i=n[0],""===(t=t.substring(i.length).trim()))return e;switch(r=t.indexOf(" "),i[0]){case"c":e.color=r>-1?t.substring(0,r).trim():t;break;case"s":e.size=parseInt(t)}return r>-1&&(o=t.substring(r+1).trim(),e.event=this._processEventHandler(o)),e}if((n=/^(br(\s)*\/)/.exec(t))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;var a="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=HQ.exec(t);for(var c=!1;n;){if(i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),s=(r=(a=t.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}e.isImage=!0,e.src=s}else if("height"===i)e.imageHeight=parseInt(s);else if("width"===i)e.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}e.imageAlign=s.toLowerCase()}else"offset"===i?e.imageOffset=s:"click"===i&&(e.event=this._processEventHandler(i+"="+s));e.event&&"param"===i&&(e.event[i]=s.replace(/^"|"$/g,"")),n=HQ.exec(t)}return c&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(t)){var l={color:"#ffffff",width:1};if(t=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(t);n;)i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),u=(r=(a=t.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),"click"===i?e.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),e.event&&"param"===i&&(e.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(t)}e.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(t))&&n[0].length>0){switch(i=n[0],t=t.substring(i.length).trim(),i[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e},e._processEventHandler=function(t){for(var e={},n=0,i=!1,r=UQ.exec(t);r;){var o=r[0],a="";if(i=!1,'"'===(t=t.substring(o.length).trim()).charAt(0))(n=t.indexOf('"',1))>-1&&(a=t.substring(1,n).trim(),i=!0),n++;else if("'"===t.charAt(0))(n=t.indexOf("'",1))>-1&&(a=t.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(t);n=(a=s?s[0]:"").length}i&&(e[o=o.substring(0,o.length-1).trim()]=a),t=t.substring(n).trim(),r=UQ.exec(t)}return e},e._addToStack=function(t){var e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)e[i]||(e[i]=n[i]);this._stack.push(e)}},e._processResult=function(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))},e._escapeSpecialSymbol=function(t){for(var e,n=ot(this._specialSymbolArray);!(e=n()).done;){var i=e.value,r=i[0],o=i[1];t=t.replace(r,o)}return t},t}()),WQ=function(e){return t({LabelOutline:e,LabelOutlineComponent:e}),e}((OJ=fc("cc.LabelOutline"),NJ=Ic(),LJ=pc(110),FJ=Tc(),zJ=dc(oK),VJ=Oc(),kJ=Oc(),OJ(GJ=NJ(GJ=LJ(GJ=FJ(GJ=zJ(GJ=bc((WJ=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_color",HJ,it(e)),at(e,"_width",jJ,it(e)),e}Q(e,t);var n=e.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var t=this.node.getComponent(oK);t&&t.updateRenderData(!0)},K(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(t){this._width!==t&&(this._width=t,this._updateRenderData())}}]),e}(Qu),HJ=st((UJ=WJ).prototype,"_color",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En(0,0,0,255)}}),jJ=st(UJ.prototype,"_width",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),st(UJ.prototype,"color",[VJ],Object.getOwnPropertyDescriptor(UJ.prototype,"color"),UJ.prototype),st(UJ.prototype,"width",[kJ],Object.getOwnPropertyDescriptor(UJ.prototype,"width"),UJ.prototype),GJ=UJ))||GJ)||GJ)||GJ)||GJ)||GJ)||GJ));c.LabelOutline=WQ,function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}(zQ||(zQ={})),ce(zQ),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(VQ||(VQ={})),ce(VQ),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(kQ||(kQ={})),ce(kQ),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(GQ||(GQ={}));var qQ,XQ=function(e){return t({Sprite:e,SpriteComponent:e}),e}((qJ=fc("cc.Sprite"),XJ=Ic(),YJ=pc(110),KJ=Tc(),JJ=Xc(KW),QJ=kc(),ZJ=Oc(),$J=Xc(XW),tQ=kc(),eQ=Oc(),nQ=Xc(zQ),iQ=kc(),rQ=Oc(),oQ=Xc(VQ),aQ=kc(),sQ=Oc(),cQ=kc(),lQ=Oc(),uQ=Nc(),hQ=kc(),_Q=Oc(),fQ=Nc(),dQ=kc(),pQ=Oc(),mQ=Dc(),vQ=kc(),gQ=Oc(),yQ=kc(),xQ=Oc(),SQ=Xc(kQ),AQ=kc(),CQ=Oc(),qJ(bQ=XJ(bQ=YJ(bQ=KJ((FQ=LQ=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_spriteFrame",EQ,it(e)),at(e,"_type",wQ,it(e)),at(e,"_fillType",PQ,it(e)),at(e,"_sizeMode",IQ,it(e)),at(e,"_fillCenter",RQ,it(e)),at(e,"_fillStart",DQ,it(e)),at(e,"_fillRange",MQ,it(e)),at(e,"_isTrimmedMode",BQ,it(e)),at(e,"_useGrayscale",OQ,it(e)),at(e,"_atlas",NQ,it(e)),e}Q(e,t);var n=e.prototype;return n.__preload=function(){this.changeMaterialForDefine(),t.prototype.__preload.call(this)},n.onEnable=function(){t.prototype.onEnable.call(this),this._activateMaterial();var e=this._spriteFrame;e&&(this._updateUVs(),this._type===zQ.SLICED&&e.on(XW.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===zQ.SLICED&&this._spriteFrame.off(XW.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){t.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(t){if(this._atlas){var e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var t,e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);var n=!1;if(t instanceof Ym){var i=t.getPixelFormat();n=i===wm.RGBA_ETC1||i===wm.RGB_A_PVRTC_4BPPV1||i===wm.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=kX.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=kX.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=kX.GRAYSCALE:this._instanceMaterialType=kX.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var e=t.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof NS){var n=J({SAMPLE_FROM_RT:!0},e.passes[0].defines),i=new rg;i.initialize({effectAsset:e.effectAsset,defines:n}),e=i}return e},n._render=function(t){t.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!t.prototype._canRender.call(this))return!1;var e=this._spriteFrame;return!(!e||!e.texture)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===zQ.SLICED?this._spriteFrame.on(XW.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(XW.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(kQ.RAW===this._sizeMode){var t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(kQ.TRIMMED===this._sizeMode){var e=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(t){var e=this._spriteFrame;t&&this._type===zQ.SLICED&&t.off(XW.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;e&&(t&&t.texture===e.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===zQ.SLICED&&e.on(XW.EVENT_UV_UPDATED,this._updateUVs,this))},K(e,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(t){this._atlas!==t&&(this._atlas=t)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}}},{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(t){this._fillType!==t&&(t===VQ.RADIAL||this._fillType===VQ.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===zQ.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(t){this._fillStart=sn(t,0,1),this._type===zQ.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(t){this._fillRange=sn(t,-1,1),this._type===zQ.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===zQ.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(t){this._useGrayscale!==t&&(this._useGrayscale=t,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,t!==kQ.CUSTOM&&this._applySpriteSize())}}]),e}(rK),LQ.FillType=VQ,LQ.Type=zQ,LQ.SizeMode=kQ,LQ.EventType=GQ,st((TQ=FQ).prototype,"spriteAtlas",[JJ,QJ,ZJ],Object.getOwnPropertyDescriptor(TQ.prototype,"spriteAtlas"),TQ.prototype),st(TQ.prototype,"spriteFrame",[$J,tQ,eQ],Object.getOwnPropertyDescriptor(TQ.prototype,"spriteFrame"),TQ.prototype),st(TQ.prototype,"type",[nQ,iQ,rQ],Object.getOwnPropertyDescriptor(TQ.prototype,"type"),TQ.prototype),st(TQ.prototype,"fillType",[oQ,aQ,sQ],Object.getOwnPropertyDescriptor(TQ.prototype,"fillType"),TQ.prototype),st(TQ.prototype,"fillCenter",[cQ,lQ],Object.getOwnPropertyDescriptor(TQ.prototype,"fillCenter"),TQ.prototype),st(TQ.prototype,"fillStart",[uQ,hQ,_Q],Object.getOwnPropertyDescriptor(TQ.prototype,"fillStart"),TQ.prototype),st(TQ.prototype,"fillRange",[fQ,dQ,pQ],Object.getOwnPropertyDescriptor(TQ.prototype,"fillRange"),TQ.prototype),st(TQ.prototype,"trim",[mQ,vQ,gQ],Object.getOwnPropertyDescriptor(TQ.prototype,"trim"),TQ.prototype),st(TQ.prototype,"grayscale",[Rc,yQ,xQ],Object.getOwnPropertyDescriptor(TQ.prototype,"grayscale"),TQ.prototype),st(TQ.prototype,"sizeMode",[SQ,AQ,CQ],Object.getOwnPropertyDescriptor(TQ.prototype,"sizeMode"),TQ.prototype),EQ=st(TQ.prototype,"_spriteFrame",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wQ=st(TQ.prototype,"_type",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zQ.SIMPLE}}),PQ=st(TQ.prototype,"_fillType",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VQ.HORIZONTAL}}),IQ=st(TQ.prototype,"_sizeMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kQ.TRIMMED}}),RQ=st(TQ.prototype,"_fillCenter",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(0,0)}}),DQ=st(TQ.prototype,"_fillStart",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MQ=st(TQ.prototype,"_fillRange",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BQ=st(TQ.prototype,"_isTrimmedMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),OQ=st(TQ.prototype,"_useGrayscale",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NQ=st(TQ.prototype,"_atlas",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bQ=TQ))||bQ)||bQ)||bQ)||bQ));c.Sprite=XQ;var YQ,KQ,JQ,QQ,ZQ,$Q,tZ,eZ,nZ,iZ,rZ,oZ,aZ,sZ,cZ,lZ,uZ,hZ,_Z,fZ,dZ,pZ,mZ,vZ,gZ,yZ,xZ,SZ,AZ,CZ,bZ,TZ,EZ,wZ,PZ,IZ,RZ,DZ,MZ,BZ,OZ,NZ,LZ,FZ,zZ,VZ,kZ,GZ,UZ,HZ=t("RenderRoot2D",fc("cc.RenderRoot2D")(qQ=pc(100)(qQ=Tc()(qQ=dc(xX)(qQ=mc(qQ=bc(qQ=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.onEnable=function(){c.director.root.batcher2D.addScreen(this)},n.onDisable=function(){c.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){c.director.root.batcher2D.removeScreen(this)},e}(Qu))||qQ)||qQ)||qQ)||qQ)||qQ)||qQ),jZ=new Pn,WZ=oe({OVERLAY:0,INTERSPERSE:1}),qZ=function(e){return t({Canvas:e,CanvasComponent:e}),e}((YQ=fc("cc.Canvas"),KQ=Ic(),JQ=pc(100),QQ=Tc(),ZQ=Xc(ZL),$Q=Oc(),tZ=Oc(),eZ=Xc(ZL),YQ(nZ=KQ(nZ=JQ(nZ=QQ(nZ=bc(nZ=mc((st((iZ=function(t){function e(){var e;return at(e=t.call(this)||this,"_cameraComponent",rZ,it(e)),at(e,"_alignCanvasWithScreen",oZ,it(e)),e._thisOnCameraResized=void 0,e._fitDesignResolution=void 0,e._pos=new Pn,e._renderMode=WZ.OVERLAY,e._thisOnCameraResized=e._onResizeCamera.bind(it(e)),e}Q(e,t);var n=e.prototype;return n.__preload=function(){var t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(ZL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(zC.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){t.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(ZL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){t.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(ZL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){t.prototype.onDestroy.call(this),this.node.off(zC.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=GB.height/2;else{var t=ah.windowSize;this._cameraComponent.orthoHeight=t.height/YB.getScaleY()/2}this.node.getWorldPosition(jZ),this._cameraComponent.node.setWorldPosition(jZ.x,jZ.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var t,e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return this._renderMode===WZ.OVERLAY?e|1<<30:e&~(1<<30)}return 0},K(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}}]),e}(HZ)).prototype,"cameraComponent",[ZQ,$Q],Object.getOwnPropertyDescriptor(iZ.prototype,"cameraComponent"),iZ.prototype),st(iZ.prototype,"alignCanvasWithScreen",[tZ],Object.getOwnPropertyDescriptor(iZ.prototype,"alignCanvasWithScreen"),iZ.prototype),rZ=st(iZ.prototype,"_cameraComponent",[eZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oZ=st(iZ.prototype,"_alignCanvasWithScreen",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nZ=iZ))||nZ)||nZ)||nZ)||nZ)||nZ)||nZ));c.Canvas=qZ,V(t("UIComponent",fc("cc.UIComponent")(aZ=dc(xX)(aZ=pc(110)(aZ=mc(aZ=bc(aZ=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._lastParent=null,e.stencilStage=oX.DISABLED,e}Q(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},e}(Qu))||aZ)||aZ)||aZ)||aZ)||aZ).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),z(qZ.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.clearFlags=t)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:En.BLACK},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.clearColor=t)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.priority=t)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.targetTexture=t)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),k(rK.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),k(xX.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),c.UITransformComponent=xX,ne.setClassAlias(xX,"cc.UITransformComponent"),ne.setClassAlias(rK,"cc.RenderComponent"),c.CanvasComponent=qZ,ne.setClassAlias(qZ,"cc.CanvasComponent");var XZ=new jQ,YZ="RICHTEXT_CHILD",KZ="RICHTEXT_Image_CHILD",JZ=new te((function(t){if(!c.isValid(t.node))return!1;var e=t.node.getComponent(WQ);return e&&(e.width=0),!0}),20),QZ=new te((function(t){return c.isValid(t.node)}),10);function ZZ(t){return{node:new kT(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function $Z(t,e){var n;t===YZ?n=JZ._get():t===KZ&&(n=QZ._get());var i=(n=n||ZZ(t)).node;return i||(i=new kT(t)),i.hideFlags|=_l.Flags.DontSave|_l.Flags.HideInHierarchy,t===KZ?(n.comp=i.getComponent(XQ)||i.addComponent(XQ),n.comp.spriteFrame=e,n.comp.type=XQ.Type.SLICED,n.comp.sizeMode=XQ.SizeMode.CUSTOM):(n.comp=i.getComponent(oK)||i.addComponent(oK),n.comp.string=e,n.comp.horizontalAlign=tK.LEFT,n.comp.verticalAlign=eK.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var t$,e$=function(e){return t({RichText:e,RichTextComponent:e}),e}((sZ=fc("cc.RichText"),cZ=Ic(),lZ=pc(110),uZ=Tc(),hZ=Oc(),_Z=Xc(tK),fZ=Oc(),dZ=Oc(),pZ=Oc(),mZ=Xc(tq),vZ=Oc(),gZ=Oc(),yZ=kc(),xZ=Xc(iK),SZ=Oc(),AZ=Oc(),CZ=Oc(),bZ=Xc(KW),TZ=Oc(),EZ=Oc(),sZ(wZ=cZ(wZ=lZ(wZ=uZ(wZ=bc((UZ=GZ=function(t){function e(){var e;return at(e=t.call(this)||this,"_lineHeight",IZ,it(e)),at(e,"_string",RZ,it(e)),at(e,"_horizontalAlign",DZ,it(e)),at(e,"_fontSize",MZ,it(e)),at(e,"_maxWidth",BZ,it(e)),at(e,"_fontFamily",OZ,it(e)),at(e,"_font",NZ,it(e)),at(e,"_isSystemFontUsed",LZ,it(e)),at(e,"_userDefinedFont",FZ,it(e)),at(e,"_cacheMode",zZ,it(e)),at(e,"_imageAtlas",VZ,it(e)),at(e,"_handleTouchEvent",kZ,it(e)),e._textArray=[],e._segments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this.node.on(zC.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(zC.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var t,e=ot(this._segments);!(t=e()).done;){var n=t.value;n.node.removeFromParent(),n.type===YZ?JZ.put(n):n.type===KZ&&QZ.put(n)}this.node.off(zC.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(zC.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(zC.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(zC.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var t=this;this._segments.forEach((function(e){t._applyTextAttribute(e)}))},n._createFontLabel=function(t){return $Z(YZ,t)},n._createImage=function(t){return $Z(KZ,t)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(t,e){var n=this,i=function(e){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(e),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(oK).string=e,i.styleIndex=t,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return e?i(e):i},n._onTouchEnded=function(t){for(var e,n=this,i=this.node.getComponents(Qu),r=function(){var r=e.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,t.touch.getUILocation())&&(i.forEach((function(e){var n=e[o];e.enabledInHierarchy&&n&&n.call(e,t,a)})),t.propagationStopped=!0)},o=ot(this._segments);!(e=o()).done;)r()},n._containsTouchLocation=function(t,e){var n=t.node.getComponent(xX);return!!n&&n.getBoundingBoxToWorld().contains(e)},n._resetState=function(){for(var t=this.node.children,e=t.length-1;e>=0;e--){var n=t[e];if(n.name===YZ||n.name===KZ){n.parent===this.node?n.parent=null:t.splice(e,1);var i=ZZ(n.name);i.node=n,n.name===YZ?(i.comp=n.getComponent(oK),JZ.put(i)):(i.comp=n.getComponent(XQ),QZ.put(i))}}t.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(t){for(var e=this.node.children.length-1;e>=0;e--){var n=this.node.children[e];n.name!==YZ&&n.name!==KZ||(n.active=t)}},n._addLabelSegment=function(t,e){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(t);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(oK);i&&(i.string=t)}return n.styleIndex=e,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(t,e,n){var i=e;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(t,r,t.length),a=t.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=t.substr(0,r);this._addLabelSegment(c,n),t=t.substr(r,t.length),i=this._measureText(n,t)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=Rq(t,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(t,n)},n._isLastComponentCR=function(t){return t.length-1===t.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(var e=0;e<this._textArray.length;e++){var n=this._textArray[e],i=t[e];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(t){if(t.style){var e=t.style,n=e.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,e.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}e.imageOffset&&(r.imageOffset=e.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=e.imageWidth||0,u=e.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=e.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else I(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var t=XZ.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();for(var e,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(c,i),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+mq)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(t,e,n){var i=t.charAt(e);if(Eq(i)||wq(i))return 1;for(var r=1,o=e+1;o<n&&!wq(i=t.charAt(o))&&!Eq(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var t=0,e=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>e&&(t=0,e=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case tK.LEFT:break;case tK.CENTER:l-=this._linesWidth[c-1]/2;break;case tK.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(t+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===e&&(t+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(XQ)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+mq);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var d=s.imageOffset.split(",");if(1===d.length&&d[0]){var p=parseFloat(d[0]);Number.isInteger(p)&&(h.y+=p)}else if(2===d.length){var m=parseFloat(d[0]),v=parseFloat(d[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(WQ);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(t){var e=t.toUpperCase();return En[e]?En[e]:(new En).fromHEX(t)},n._applyTextAttribute=function(t){var e=t.node.getComponent(oK);if(e){this._resetLabelState(e);var n,i=t.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(e.color=this._convertLiteralColorValue(n.color||"white"),e.isBold=!!n.bold,e.isItalic=!!n.italic,e.isUnderline=!!n.underline,n.outline){var r=t.node.getComponent(WQ);r||(r=t.node.addComponent(WQ)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}e.fontSize=n.size||this._fontSize,t.clickHandler="",t.clickParam="";var o=n.event;o&&(t.clickHandler=o.click||"",t.clickParam=o.param||"")}e.cacheMode=this._cacheMode,this._font instanceof tq&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);var a=e._assembler;a&&a.updateRenderData(e)}},n._applyLayer=function(){for(var t,e=ot(this._segments);!(t=e()).done;)t.value.node.layer=this.node.layer},n._resetLabelState=function(t){t.fontSize=this._fontSize,t.color=En.WHITE,t.isBold=!1,t.isItalic=!1,t.isUnderline=!1},K(e,[{key:"string",get:function(){return this._string},set:function(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),e}(Qu),GZ.HorizontalAlign=tK,GZ.VerticalAlign=eK,st((PZ=UZ).prototype,"string",[Gc,hZ],Object.getOwnPropertyDescriptor(PZ.prototype,"string"),PZ.prototype),st(PZ.prototype,"horizontalAlign",[_Z,fZ],Object.getOwnPropertyDescriptor(PZ.prototype,"horizontalAlign"),PZ.prototype),st(PZ.prototype,"fontSize",[dZ],Object.getOwnPropertyDescriptor(PZ.prototype,"fontSize"),PZ.prototype),st(PZ.prototype,"fontFamily",[pZ],Object.getOwnPropertyDescriptor(PZ.prototype,"fontFamily"),PZ.prototype),st(PZ.prototype,"font",[mZ,vZ],Object.getOwnPropertyDescriptor(PZ.prototype,"font"),PZ.prototype),st(PZ.prototype,"useSystemFont",[gZ,yZ],Object.getOwnPropertyDescriptor(PZ.prototype,"useSystemFont"),PZ.prototype),st(PZ.prototype,"cacheMode",[xZ,SZ],Object.getOwnPropertyDescriptor(PZ.prototype,"cacheMode"),PZ.prototype),st(PZ.prototype,"maxWidth",[AZ],Object.getOwnPropertyDescriptor(PZ.prototype,"maxWidth"),PZ.prototype),st(PZ.prototype,"lineHeight",[CZ],Object.getOwnPropertyDescriptor(PZ.prototype,"lineHeight"),PZ.prototype),st(PZ.prototype,"imageAtlas",[bZ,TZ],Object.getOwnPropertyDescriptor(PZ.prototype,"imageAtlas"),PZ.prototype),st(PZ.prototype,"handleTouchEvent",[EZ],Object.getOwnPropertyDescriptor(PZ.prototype,"handleTouchEvent"),PZ.prototype),IZ=st(PZ.prototype,"_lineHeight",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),RZ=st(PZ.prototype,"_string",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),DZ=st(PZ.prototype,"_horizontalAlign",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tK.LEFT}}),MZ=st(PZ.prototype,"_fontSize",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),BZ=st(PZ.prototype,"_maxWidth",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OZ=st(PZ.prototype,"_fontFamily",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),NZ=st(PZ.prototype,"_font",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LZ=st(PZ.prototype,"_isSystemFontUsed",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),FZ=st(PZ.prototype,"_userDefinedFont",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zZ=st(PZ.prototype,"_cacheMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iK.NONE}}),VZ=st(PZ.prototype,"_imageAtlas",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kZ=st(PZ.prototype,"_handleTouchEvent",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wZ=PZ))||wZ)||wZ)||wZ)||wZ)||wZ));c.RichText=e$;var n$=function(e){return t({UIMeshRenderer:e,UIModelComponent:e}),e}(fc("cc.UIMeshRenderer")(t$=Ic()(t$=pc(110)(t$=Tc()(t$=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._models=null,e._modelComponent=null,e.stencilStage=oX.DISABLED,e}Q(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(t){if(this._models){this._modelComponent._detachFromScene();for(var e,n=ot(this._models);!(e=n()).done;){var i=e.value;t.commitModel.call(t,this,i,this._modelComponent.material)}return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var t=this._modelComponent.sharedMaterials.length,e=0;e<t;e++){var n=this._modelComponent.getMaterialInstance(e);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=Od.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},K(e,[{key:"modelComponent",get:function(){return this._modelComponent}}]),e}(Qu))||t$)||t$)||t$)||t$);c.UIMeshRenderer=n$;var i$,r$,o$,a$,s$,c$,l$,u$,h$,_$,f$,d$,p$,m$,v$,g$,y$,x$,S$,A$,C$,b$,T$,E$,w$,P$,I$,R$,D$,M$=Md.Enum.NONE|Md.Enum.UI_3D,B$=t("UIDrawBatch",function(){function t(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=M$,this._inputAssembler=null,this._descriptorSet=null}var e=t.prototype;return e.destroy=function(){this._passes=[]},e.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=M$,this.renderScene=null},e.fillPasses=function(t,e,n,i,r,o){if(t){var a=t.passes;if(!a)return;var s=0;this._shaders.length=a.length;for(var l=0;l<a.length;l++){this._passes[l]||(this._passes[l]=new Nv(c.director.root));var u=a[l],h=this._passes[l];u.update(),e||(e=u.depthStencilState,n=0),i||(i=u.blendState,r=0),-1===r&&(r=0),s=n<<16|r,h._initPassFromTarget(u,e,i,s),this._shaders[l]=h.getShaderVariant(o)}}},K(t,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(t){this._inputAssembler=t}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(t){this._descriptorSet=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),t}()),O$=function(e){return t({UIStaticBatch:e,UIStaticBatchComponent:e}),e}((i$=fc("cc.UIStaticBatch"),r$=Ic(),o$=Tc(),a$=pc(110),s$=Dc(),i$(c$=r$(c$=o$(c$=a$((st((l$=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._init=!1,e._bufferAccessor=null,e._dirty=!0,e._uiDrawBatchList=[],e}Q(e,t);var n=e.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var t=new B$;return t.isStatic=!0,this._uiDrawBatchList.push(t),t},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var t=this._getBatcher(),e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return zB.root&&zB.root.batcher2D?zB.root.batcher2D:(I(9301),null)},K(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),e}(rK)).prototype,"color",[il,s$],Object.getOwnPropertyDescriptor(l$.prototype,"color"),l$.prototype),c$=l$))||c$)||c$)||c$)||c$)),N$=t("LabelShadow",(u$=fc("cc.LabelShadow"),h$=Ic(),_$=pc(110),f$=Tc(),d$=dc(oK),p$=Oc(),m$=Oc(),v$=Oc(),u$(g$=h$(g$=_$(g$=f$(g$=d$(g$=bc((C$=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_color",x$,it(e)),at(e,"_offset",S$,it(e)),at(e,"_blur",A$,it(e)),e}Q(e,t);var n=e.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var t=this.node.getComponent(oK);t&&t.updateRenderData(!0)},K(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset=t,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(t){this._blur=t,this._updateRenderData()}}]),e}(Qu),x$=st((y$=C$).prototype,"_color",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En(0,0,0,255)}}),S$=st(y$.prototype,"_offset",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(2,2)}}),A$=st(y$.prototype,"_blur",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),st(y$.prototype,"color",[p$],Object.getOwnPropertyDescriptor(y$.prototype,"color"),y$.prototype),st(y$.prototype,"offset",[m$],Object.getOwnPropertyDescriptor(y$.prototype,"offset"),y$.prototype),st(y$.prototype,"blur",[v$],Object.getOwnPropertyDescriptor(y$.prototype,"blur"),y$.prototype),g$=y$))||g$)||g$)||g$)||g$)||g$)||g$)),L$=function(e){return t({UIOpacity:e,UIOpacityComponent:e}),e}((b$=fc("cc.UIOpacity"),T$=Ic(),E$=pc(110),w$=Tc(),P$=Oc(),b$(I$=T$(I$=E$(I$=w$(I$=bc((st((R$=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_opacity",D$,it(e)),e}Q(e,t);var n=e.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},K(e,[{key:"opacity",get:function(){return this._opacity},set:function(t){this._opacity!==t&&(t=Ae(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255)}}]),e}(Qu)).prototype,"opacity",[Rc,P$],Object.getOwnPropertyDescriptor(R$.prototype,"opacity"),R$.prototype),D$=st(R$.prototype,"_opacity",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),I$=R$))||I$)||I$)||I$)||I$)||I$));c.MaskComponent=BJ,ne.setClassAlias(BJ,"cc.MaskComponent"),c.LabelComponent=oK,ne.setClassAlias(oK,"cc.LabelComponent"),c.LabelOutlineComponent=WQ,ne.setClassAlias(WQ,"cc.LabelOutlineComponent"),c.RichTextComponent=e$,ne.setClassAlias(e$,"cc.RichTextComponent"),c.SpriteComponent=XQ,ne.setClassAlias(XQ,"cc.SpriteComponent"),c.UIModelComponent=n$,ne.setClassAlias(n$,"cc.UIModelComponent"),c.GraphicsComponent=wJ,ne.setClassAlias(wJ,"cc.GraphicsComponent"),ne.setClassAlias(O$,"cc.UIStaticBatchComponent"),ne.setClassAlias(L$,"cc.UIOpacityComponent");var F$=function(t,e,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=n};function z$(t,e,n,i,r){var o=0,a=null;if(r===function(t,e,n,i){for(var r=0,o=e,a=n-i;o<n;o+=i)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}(t,e,n,i)>0)for(o=e;o<n;o+=i)a=n0(o,t[o],t[o+1],a);else for(o=n-i;o>=e;o-=i)a=n0(o,t[o],t[o+1],a);return a&&Z$(a,a.next)&&(i0(a),a=a.next),a}function V$(t,e){if(void 0===e&&(e=null),!t)return t;e||(e=t);var n=t,i=!1;do{if(i=!1,n.steiner||!Z$(n,n.next)&&0!==Q$(n.prev,n,n.next))n=n.next;else{if(i0(n),(n=e=n.prev)===n.next)return null;i=!0}}while(i||n!==e);return e}function k$(t,e,n,i,r,o,a){if(void 0===a&&(a=0),t){!a&&o&&function(t,e,n,i){var r=t;do{null===r.z&&(r.z=X$(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=t,t=null,o=null,a=0;n;){for(a++,i=n,s=0,e=0;e<l&&(s++,i=i.nextZ);e++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(t,i,r,o);for(var s=t,c=null,l=null;t.prev!==t.next;)if(c=t.prev,l=t.next,o?U$(t,i,r,o):G$(t))e.push(c.i/n),e.push(t.i/n),e.push(l.i/n),i0(t),t=l.next,s=l.next;else if((t=l)===s){a?1===a?k$(t=H$(t,e,n),e,n,i,r,o,2):2===a&&j$(t,e,n,i,r,o):k$(V$(t),e,n,i,r,o,1);break}}}function G$(t){var e=t.prev,n=t,i=t.next;if(Q$(e,n,i)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(K$(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&Q$(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function U$(t,e,n,i){var r=t.prev,o=t,a=t.next;if(Q$(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=X$(s,c,e,n,i),_=X$(l,u,e,n,i),f=t.nextZ;f&&f.z<=_;){if(f!==t.prev&&f!==t.next&&K$(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&Q$(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=t.prevZ;f&&f.z>=h;){if(f!==t.prev&&f!==t.next&&K$(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&Q$(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function H$(t,e,n){var i=t;do{var r=i.prev,o=i.next.next;!Z$(r,o)&&$$(r,i,i.next,o)&&t0(r,o)&&t0(o,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(o.i/n),i0(i),i0(i.next),i=t=o),i=i.next}while(i!==t);return i}function j$(t,e,n,i,r,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&J$(a,s)){var c=e0(a,s);return a=V$(a,a.next),c=V$(c,c.next),k$(a,e,n,i,r,o),void k$(c,e,n,i,r,o)}s=s.next}a=a.next}while(a!==t)}function W$(t,e){return t.x-e.x}function q$(t,e){if(e=function(t,e){var n=e,i=t.x,r=t.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&K$(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>a.x)&&t0(n,t)&&(a=n,_=c),n=n.next;return a}(t,e)){var n=e0(e,t);V$(n,n.next)}}function X$(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Y$(t){var e=t,n=t;do{e.x<n.x&&(n=e),e=e.next}while(e!==t);return n}function K$(t,e,n,i,r,o,a,s){return(r-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(i-s)-(n-a)*(e-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function J$(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&$$(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&t0(t,e)&&t0(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)}function Q$(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Z$(t,e){return t.x===e.x&&t.y===e.y}function $$(t,e,n,i){return!!(Z$(t,e)&&Z$(n,i)||Z$(t,i)&&Z$(n,e))||Q$(t,e,n)>0!=Q$(t,e,i)>0&&Q$(n,i,t)>0!=Q$(n,i,e)>0}function t0(t,e){return Q$(t.prev,t,t.next)<0?Q$(t,e,t.next)>=0&&Q$(t,t.prev,e)>=0:Q$(t,e,t.prev)<0||Q$(t,t.next,e)<0}function e0(t,e){var n=new F$(t.i,t.x,t.y),i=new F$(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function n0(t,e,n,i){var r=new F$(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function i0(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function r0(t,e,n){n=n||3;var i=e?e.length:0,r=i?e[0]*n:t.length,o=z$(t,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(o=function(t,e,n,i){var r,o=[],a=0,s=null;for(a=0,r=e.length;a<r;a++)(s=z$(t,e[a]*i,a<r-1?e[a+1]*i:t.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(Y$(s)));if(o.sort(W$),!n)return n;for(a=0;a<o.length;a++)q$(o[a],n),n=V$(n,n.next);return n}(t,e,o,n)),t.length>80*n){s=l=t[0],c=u=t[1];for(var d=n;d<r;d+=n)(h=t[d])<s&&(s=h),(_=t[d+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return k$(o,a,n,s,c,f),a}for(var o0=Math.PI,a0=Math.min,s0=Math.max,c0=Math.ceil,l0=Math.acos,u0=Math.cos,h0=Math.sin,_0=Math.atan2,f0=null,d0=null,p0=new En,m0=[],v0=0;v0<4;v0++)m0.push(new Pn);function g0(t,e,n){return t<e?e:t>n?n:t}var y0={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(t,e){if(!d0)return null;var n=d0.getRenderDataList(),i=n[d0.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+e:0;return(o>65535||3*o>131070)&&(++d0.dataOffset,d0.dataOffset<n.length?i=n[d0.dataOffset]:(i=d0.requestRenderData(),n[d0.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(e,3*e),i},stroke:function(t){En.copy(p0,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill:function(t){En.copy(p0,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end:function(t){t.markForUpdateRenderData()},_expandStroke:function(t){var e,n,i,r,o=.5*t.lineWidth,a=t.lineCap,s=t.lineJoin,c=t.miterLimit;if(d0=t.impl){var l=(e=o,n=o0,i=d0.tessTol,r=2*l0(e/(e+i)),s0(2,c0(n/r)));this._calculateJoins(d0,o,s,c);for(var u=d0.paths,h=0,_=d0.pathOffset,f=d0.pathLength;_<f;_++){var d=u[_],p=d.points.length;s===fK.ROUND?h+=2*(p+d.bevel*(l+2)+1):h+=2*(p+5*d.bevel+1),d.closed||(a===_K.ROUND?h+=2*(2*l+2):h+=12)}var m=f0=this.getRenderData(t,h);if(m){for(var v=m.vData,g=m.iData,y=d0.pathOffset,x=d0.pathLength;y<x;y++){var S=u[y],A=S.points,C=A.length,b=m.vertexStart,T=void 0,E=void 0,w=0,P=0,I=S.closed;if(I?(T=A[C-1],E=A[0],w=0,P=C):(T=A[0],E=A[1],w=1,P=C-1),E=E||T,!I){var R=new SJ(E.x,E.y);R.subtract(T),R.normalize();var D=R.x,M=R.y;a===_K.BUTT?this._buttCapStart(T,D,M,o,0):a===_K.SQUARE?this._buttCapStart(T,D,M,o,o):a===_K.ROUND&&this._roundCapStart(T,D,M,o,l)}for(var B=w;B<P;++B)s===fK.ROUND?this._roundJoin(T,E,o,o,l):0!=(E.flags&(dK.PT_BEVEL|dK.PT_INNERBEVEL))?this._bevelJoin(T,E,o,o):(this._vSet(E.x+E.dmx*o,E.y+E.dmy*o,1),this._vSet(E.x-E.dmx*o,E.y-E.dmy*o,-1)),T=E,E=A[B+1];if(I){var O=8*b;this._vSet(v[O],v[O+1],1),this._vSet(v[O+8],v[O+8+1],-1)}else{var N=new SJ(E.x,E.y);N.subtract(T),N.normalize();var L=N.x,F=N.y;a===_K.BUTT?this._buttCapEnd(E,L,F,o,0):a===_K.SQUARE?this._buttCapEnd(E,L,F,o,o):a===_K.ROUND&&this._roundCapEnd(E,L,F,o,l)}for(var z=m.indexStart,V=b+2,k=m.vertexStart;V<k;V++)g[z++]=V-2,g[z++]=V-1,g[z++]=V;m.indexStart=z}f0=null,d0=null}}},_expandFill:function(t){if(d0=t.impl){for(var e=d0.paths,n=0,i=d0.pathOffset,r=d0.pathLength;i<r;i++)n+=e[i].points.length;var o=f0=this.getRenderData(t,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=d0.pathOffset,u=d0.pathLength;l<u;l++){var h=e[l],_=h.points,f=_.length;if(0!==f){for(var d=o.vertexStart,p=0;p<f;++p)this._vSet(_[p].x,_[p].y);var m=o.indexStart;if(h.complex){for(var v=[],g=d,y=o.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=r0(v,null,3);if(!S||0===S.length)continue;for(var A=0,C=S.length;A<C;A++)c[m++]=S[A]+d}else for(var b=d,T=d+2,E=a.vertexStart;T<E;T++)c[m++]=b,c[m++]=T-1,c[m++]=T;a.indexStart=m}}f0=null,d0=null}}},_calculateJoins:function(t,e,n,i){var r=0;e>0&&(r=1/e);for(var o=t.paths,a=t.pathOffset,s=t.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var d,p,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(d=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var x=1/d;x>600&&(x=600),_.dmx*=x,_.dmy*=x}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=dK.PT_LEFT),d*(p=s0(11,a0(h.len,_.len)*r))*p<1&&(_.flags|=dK.PT_INNERBEVEL),_.flags&dK.PT_CORNER&&(d*i*i<1||n===fK.BEVEL||n===fK.ROUND)&&(_.flags|=dK.PT_BEVEL),0!=(_.flags&(dK.PT_BEVEL|dK.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(t){for(var e=t.paths,n=t.pathOffset,i=t.pathLength;n<i;n++){var r=e[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new SJ(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(t,e,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==t?(a=r+e.dy*i,s=o-e.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(t,e,n,i,r){var o=t.x-e*r,a=t.y-n*r,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(t,e,n,i,r){var o=t.x+e*r,a=t.y+n*r,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(t,e,n,i,r){for(var o=t.x,a=t.y,s=n,c=-e,l=0;l<r;l++){var u=l/(r-1)*o0,h=u0(u)*i,_=h0(u)*i;this._vSet(o-s*h-e*_,a-c*h-n*_,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(t,e,n,i,r){var o=t.x,a=t.y,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*o0,h=u0(u)*i,_=h0(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+e*_,a-c*h+n*_,1)}},_roundJoin:function(t,e,n,i,r){var o=t.dy,a=-t.dx,s=e.dy,c=-e.dx,l=e.x,u=e.y;if(0!=(e.flags&dK.PT_LEFT)){var h=this._chooseBevel(e.flags&dK.PT_INNERBEVEL,t,e,n),_=h[0],f=h[1],d=h[2],p=h[3],m=_0(-a,-o),v=_0(-c,-s);v>m&&(v-=2*o0),this._vSet(_,f,1),this._vSet(l-o*i,e.y-a*i,-1);for(var g=g0(c0((m-v)/o0)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+u0(x)*i,A=u+h0(x)*i;this._vSet(l,u,0),this._vSet(S,A,-1)}this._vSet(d,p,1),this._vSet(l-s*i,u-c*i,-1)}else{var C=this._chooseBevel(e.flags&dK.PT_INNERBEVEL,t,e,-i),b=C[0],T=C[1],E=C[2],w=C[3],P=_0(a,o),I=_0(c,s);I<P&&(I+=2*o0),this._vSet(l+o*i,u+a*i,1),this._vSet(b,T,-1);for(var R=g0(c0((I-P)/o0)*r,2,r),D=0;D<R;D++){var M=P+D/(R-1)*(I-P),B=l+u0(M)*n,O=u+h0(M)*n;this._vSet(B,O,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(E,w,-1)}},_bevelJoin:function(t,e,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=t.dy,f=-t.dx,d=e.dy,p=-e.dx;if(e.flags&dK.PT_LEFT){var m=this._chooseBevel(e.flags&dK.PT_INNERBEVEL,t,e,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(e.x-_*i,e.y-f*i,-1),this._vSet(u,h,1),this._vSet(e.x-d*i,e.y-p*i,-1)}else{var v=this._chooseBevel(e.flags&dK.PT_INNERBEVEL,t,e,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(e.x+_*n,e.y+f*n,1),this._vSet(r,o,-1),this._vSet(e.x+d*n,e.y+p*n,1),this._vSet(a,s,-1)}},_vSet:function(t,e,n){if(void 0===n&&(n=0),f0){var i=f0,r=8*i.vertexStart,o=i.vData;o[r++]=t,o[r++]=e,o[r++]=0,En.toArray(o,p0,r),r+=4,o[r++]=n,i.vertexStart++}}},x0=t("graphicsAssembler",{getAssembler:function(){return y0}});wJ.Assembler=x0;var S0=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},A0=new ni,C0=null,b0=null,T0=[],E0=[],w0=[],P0=[],I0=new ti,R0=new ti,D0=new Xn,M0=null,B0=0,O0=0,N0=0,L0=0,F0=0,z0=1,V0=null,k0="",G0=0,U0=0,H0=0,j0=0,W0=0,q0=0,X0=0,Y0=!1,K0=0,J0=0,Q0=0,Z0={updateRenderData:function(t){t.renderData&&C0!==t&&(t.renderData.vertDirty&&(b0=(C0=t).node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),C0.actualFontSize=G0,b0.setContentSize(R0),this.updateUVs(t),C0.renderData.vertDirty=!1,C0.markForUpdateRenderData(!1),C0=null,this._resetProperties()),t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame))},updateUVs:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.vertexCount,r=e.data,o=3,a=0;a<i;a++){var s=r[a];n[o]=s.u,n[o+1]=s.v,o+=9}},_updateFontScale:function(){z0=G0/U0},_updateFontFamily:function(t){var e=t.font;V0=e.spriteFrame,M0=e.fntConfig,zq.fontAtlas=e.fontDefDictionary,GW.packToDynamicAtlas(t,V0)},_updateLabelInfo:function(){zq.hash="",zq.margin=0},_updateProperties:function(t){k0=t.string.toString(),G0=t.fontSize,U0=M0?M0.fontSize:t.fontSize,H0=t.horizontalAlign,j0=t.verticalAlign,W0=t.spacingX,X0=t.overflow,q0=t._lineHeight;var e=b0.contentSize;R0.width=e.width,R0.height=e.height,X0===nK.NONE?(Y0=!1,R0.width+=2*zq.margin,R0.height+=2*zq.margin):X0===nK.RESIZE_HEIGHT?(Y0=!0,R0.height+=2*zq.margin):Y0=t.enableWrapText,zq.lineHeight=q0,zq.fontSize=G0,this._setupBMFontOverflowMetrics()},_resetProperties:function(){M0=null,V0=null,zq.hash="",zq.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var t=k0,e=t.length,n=M0.kerningDict,i=T0,r=-1,o=0;o<e;++o){var a=t.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<e-1?s:0,r=a}},_multilineTextWrap:function(t){for(var e=k0.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<e;){var h=k0.charAt(u);if("\n"!==h){for(var _=t(k0,u,e),f=s,d=c,p=a,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=k0.charAt(y)))if(l=zq.fontAtlas.getLetterDefinitionForChar(h,zq)){var x=m+l.offsetX*z0-zq.margin;if(Y0&&Q0>0&&i>0&&x+l.w*z0>Q0&&!wq(h)){w0.push(a),a=0,n++,i=0,r-=q0*this._getFontScale()+0,v=!0;break}D0.x=x,D0.y=r-l.offsetY*z0,this._recordLetterInfo(D0,h,y,n),y+1<T0.length&&y<e-1&&(m+=T0[y+1]),m+=l.xAdvance*z0+W0,p=D0.x+l.w*z0,f<D0.y&&(f=D0.y),d>D0.y-l.h*z0&&(d=D0.y-l.h*z0)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+M0.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>d&&(c=d),o<(a=p)&&(o=a),u+=_)}else w0.push(a),a=0,n++,i=0,r-=q0*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return w0.push(a),O0=(B0=n+1)*q0*this._getFontScale(),B0>1&&(O0+=0*(B0-1)),R0.width=K0,R0.height=J0,K0<=0&&(R0.width=parseFloat(o.toFixed(2))+2*zq.margin),J0<=0&&(R0.height=parseFloat(O0.toFixed(2))+2*zq.margin),L0=R0.height,F0=0,s>0&&(L0=R0.height+s),c<-O0&&(F0=O0+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return X0===nK.SHRINK?z0:1},_getFirstWordLen:function(t,e,n){var i=t.charAt(e);if(Eq(i)||"\n"===i||wq(i))return 1;var r=1,o=zq.fontAtlas.getLetterDefinitionForChar(i,zq);if(!o)return r;for(var a=o.xAdvance*z0+W0,s=e+1;s<n&&(i=t.charAt(s),o=zq.fontAtlas.getLetterDefinitionForChar(i,zq));++s){if(a+o.offsetX*z0+o.w*z0>Q0&&!wq(i)&&Q0>0)return r;if(a+=o.xAdvance*z0+W0,"\n"===i||wq(i)||Eq(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(t,e){if(t>=E0.length){var n=new S0;E0.push(n)}E0[t].char=e,E0[t].hash=""+e.charCodeAt(0)+zq.hash,E0[t].valid=!1},_recordLetterInfo:function(t,e,n,i){if(n>=E0.length){var r=new S0;E0.push(r)}var o=""+e.charCodeAt(0)+zq.hash;E0[n].line=i,E0[n].char=e,E0[n].hash=o,E0[n].valid=zq.fontAtlas.getLetter(o).valid,E0[n].x=t.x,E0[n].y=t.y},_alignText:function(){O0=0,w0.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),X0===nK.SHRINK&&G0>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||X0===nK.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(t){var e=!0;t||(t=.1,e=!1),G0=t,e&&this._updateContent()},_shrinkLabelToContentSize:function(t){for(var e=0,n=0|G0,i=0;e<n;){var r=i=e+n+1>>1;if(r<=0)break;z0=r/U0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?n=i-1:e=i}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:function(){return O0>R0.height},_isHorizontalClamp:function(){for(var t=!1,e=0,n=k0.length;e<n;++e){var i=E0[e];if(i.valid){var r=zq.fontAtlas.getLetterDefinitionForChar(i.char,zq);if(!r)continue;var o=i.x+r.w*z0,a=i.line;if(K0>0)if(Y0){if(w0[a]>R0.width&&(o>R0.width||o<0)){t=!0;break}}else if(o>R0.width){t=!0;break}}}return t},_isHorizontalClamped:function(t,e){var n=w0[e],i=t>R0.width||t<0;return Y0?n>R0.width&&i:i},_updateQuads:function(){if(!C0)return!1;var t=V0?V0.texture:zq.fontAtlas.getTexture(),e=C0.renderData;e.dataLength=0,e.resize(0,0);for(var n=b0.anchorPoint,i=R0,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=k0.length;s<c;++s){var l=E0[s];if(l.valid){var u=zq.fontAtlas.getLetter(l.hash);if(u){A0.height=u.h,A0.width=u.w,A0.x=u.u,A0.y=u.v;var h=l.y+N0;if(J0>0){if(h>L0){var _=h-L0;A0.y+=_,A0.height-=_,h-=_}h-u.h*z0<F0&&X0===nK.CLAMP&&(A0.height=h<F0?0:(h-F0)/z0)}var f=l.line,d=l.x+u.w/2*z0+P0[f];if(K0>0&&this._isHorizontalClamped(d,f))if(X0===nK.CLAMP)A0.width=0;else if(X0===nK.SHRINK){if(R0.width>u.w){a=!1;break}A0.width=0}if(A0.height>0&&A0.width>0){var p=this._determineRect(),m=l.x+P0[l.line];this.appendQuad(C0,t,A0,p,m-r,h-o,z0)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var t=V0.isRotated(),e=V0.getOriginalSize(),n=V0.getRect(),i=V0.getOffset(),r=i.x+(e.width-n.width)/2,o=i.y-(e.height-n.height)/2;if(t){var a=A0.x;A0.x=n.x+n.height-A0.y-A0.height-o,A0.y=a+n.y-r,A0.y<0&&(A0.height+=o)}else A0.x+=n.x-r,A0.y+=n.y+o;return t},_computeAlignmentOffset:function(){switch(P0.length=0,H0){case tK.LEFT:for(var t=0;t<B0;++t)P0.push(0);break;case tK.CENTER:for(var e=0,n=w0.length;e<n;e++)P0.push((R0.width-w0[e])/2);break;case tK.RIGHT:for(var i=0,r=w0.length;i<r;i++)P0.push(R0.width-w0[i])}if(N0=R0.height,j0!==eK.TOP){var o=R0.height-O0+q0*this._getFontScale()-U0*z0;j0===eK.BOTTOM?N0-=o:N0-=o/2}},_setupBMFontOverflowMetrics:function(){var t=R0.width,e=R0.height;X0===nK.RESIZE_HEIGHT&&(e=0),X0===nK.NONE&&(t=0,e=0),K0=t,J0=e,I0.width=t,I0.height=e,Q0=t}},$0=new En(255,255,255,255),t1={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){var e=t.node;$0.set(t.color),$0.a=255*e._uiProps.opacity,OW(e,0,t.renderData,$0)},appendQuad:function(t,e,n,i,r,o,a){var s=t.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=e.width,h=e.height,_=n.width,f=n.height,d=0,p=0,m=0,v=0;i?(d=n.x/u,v=(n.x+f)/u,p=(n.y+_)/h,m=n.y/h,l[c].u=d,l[c].v=m,l[c+1].u=d,l[c+1].v=p,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=p):(d=n.x/u,v=(n.x+_)/u,p=(n.y+f)/h,m=n.y/h,l[c].u=d,l[c].v=p,l[c+1].u=v,l[c+1].v=p,l[c+2].u=d,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-f*a,l[c+1].x=r+_*a,l[c+1].y=o-f*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+_*a,l[c+3].y=o}},updateColor:function(){}};Ft(t1,Z0);var e1=null,n1=zt(Z0,{getAssemblerData:function(){return e1||(e1=new Fq(1024,1024)),e1.getTexture()},_updateFontFamily:function(t){zq.fontAtlas=e1,zq.fontFamily=this._getFontFamily(t);var e=t.getComponent(WQ);e&&e.enabled?(zq.isOutlined=!0,zq.margin=e.width,zq.out=e.color.clone(),zq.out.a=e.color.a*t.color.a/255):(zq.isOutlined=!1,zq.margin=0)},_getFontFamily:function(t){var e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(e=t.font._nativeAsset||"Arial"),e},_updateLabelInfo:function(t){zq.fontDesc=this._getFontDesc(),zq.color=t.color,zq.hash=function(t){var e=t.color.toHEX(),n="";return t.isOutlined&&t.margin>0&&(n=n+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+n}(zq)},_getFontDesc:function(){return zq.fontSize.toString()+"px "+zq.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),i1=new En(255,255,255,255),r1={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){if(t.renderData){var e=t.node;i1.a=255*e._uiProps.opacity,OW(e,0,t.renderData,i1)}},updateColor:function(){},appendQuad:t1.appendQuad};Ft(r1,n1);var o1=oK.Overflow,a1=(1/255).toFixed(3),s1=null,c1=null,l1=null,u1="",h1="",_1=0,f1=0,d1=[],p1=new ti,m1=0,v1=0,g1=0,y1=new En,x1="",S1=o1.NONE,A1=!1,C1=null,b1=En.BLACK.clone(),T1=null,E1=En.BLACK.clone(),w1=new ni,P1=ti.ZERO.clone(),I1=ti.ZERO.clone(),R1=Xn.ZERO.clone(),D1=Xn.ZERO.clone(),M1=0,B1=0,O1=!1,N1=!1,L1=!1,F1=["left","center","right"],z1={getAssemblerData:function(){return oK._canvasPool.get()},resetAssemblerData:function(t){t&&oK._canvasPool.put(t)},updateRenderData:function(t){if(t.renderData){if(t.renderData.vertDirty){var e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(t),this._calDynamicAtlas(t),t.actualFontSize=_1,e.setContentSize(p1),this.updateVertexData(t),this.updateUVs(t),t.markForUpdateRenderData(!1),s1=null,c1=null,l1=null}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(t){x1=t.useSystemFont?t.fontFamily||"Arial":t.font&&t.font._nativeAsset||"Arial"},_updateProperties:function(t,e){var n=t.assemblerData;n&&(s1=n.context,c1=n.canvas,l1=t.spriteFrame,h1=t.string.toString(),_1=t.fontSize,f1=_1,S1=t.overflow,I1.width=p1.width=e.width,I1.height=p1.height=e.height,B1=t.underlineHeight,m1=t.lineHeight,v1=t.horizontalAlign,g1=t.verticalAlign,y1=t.color,t.node._uiProps.opacity,O1=t.isBold,N1=t.isItalic,L1=t.isUnderline,A1=S1!==o1.NONE&&(S1===o1.RESIZE_HEIGHT||t.enableWrapText),(C1=(C1=WQ&&t.getComponent(WQ))&&C1.enabled&&C1.width>0?C1:null)&&b1.set(C1.color),(T1=(T1=N$&&t.getComponent(N$))&&T1.enabled?T1:null)&&E1.set(T1.color),this._updatePaddingRect())},_updatePaddingRect:function(){var t=0,e=0,n=0,i=0,r=0;if(P1.width=P1.height=0,C1&&(t=e=n=i=r=C1.width,P1.width=P1.height=2*r),T1){var o=T1.blur+r,a=T1.offset.x,s=T1.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),t=Math.max(t,s+o),e=Math.max(e,-s+o)}if(N1){var c=f1*Math.tan(.20943951);i+=c,P1.width+=c}w1.x=n,w1.y=t,w1.width=n+i,w1.height=t+e},_calculateFillTextStartPosition:function(){var t=0;v1===tK.RIGHT?t=p1.width-w1.width:v1===tK.CENTER&&(t=(p1.width-w1.width)/2);var e=this._getLineHeight()*(d1.length-1),n=_1*(1-mq/2);if(g1!==eK.TOP){var i=e+w1.height+_1-p1.height;g1===eK.BOTTOM?n-=i+=mq/2*_1:n-=i/2}n+=0*_1,R1.set(t+w1.x,n+w1.y)},_updateTexture:function(t){if(s1&&c1){s1.clearRect(0,0,c1.width,c1.height),s1.font=u1,this._calculateFillTextStartPosition();var e=this._getLineHeight();s1.lineJoin="round",C1?(s1.fillStyle="rgba("+b1.r+", "+b1.g+", "+b1.b+", "+a1+")",s1.fillRect(0,0,c1.width,c1.height)):t._srcBlendFactor===Pi.SRC_ALPHA&&(s1.fillStyle="rgba("+y1.r+", "+y1.g+", "+y1.b+", "+a1+")",s1.fillRect(0,0,c1.width,c1.height)),s1.fillStyle="rgb("+y1.r+", "+y1.g+", "+y1.b+")";var n=R1.x,i=0;this._drawTextEffect(R1,e);for(var r=0;r<d1.length;++r)i=R1.y+r*e,C1&&s1.strokeText(d1[r],n,i),s1.fillText(d1[r],n,i);T1&&(s1.shadowColor="transparent"),this._uploadTexture(t)}},_uploadTexture:function(t){if(t.cacheMode===oK.CacheMode.BITMAP){var e=t.ttfSpriteFrame;GW.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()}var n;l1&&c1&&(n=l1 instanceof XW?l1.texture:l1,0!==c1.width&&0!==c1.height&&(n.reset({width:c1.width,height:c1.height,mipmapLevel:1}),n.uploadData(c1),l1 instanceof XW&&(l1.rect=new ni(0,0,c1.width,c1.height),l1._calculateUV()),t.renderData&&(t.renderData.textureDirty=!0),c.director.root&&c.director.root.batcher2D&&c.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(t){if(!(t.cacheMode!==oK.CacheMode.BITMAP||!c1||c1.width<=0||c1.height<=0)){var e=t.ttfSpriteFrame;GW.packToDynamicAtlas(t,e)}},_setupOutline:function(){s1.strokeStyle="rgba("+b1.r+", "+b1.g+", "+b1.b+", "+b1.a/255+")",s1.lineWidth=2*C1.width},_setupShadow:function(){s1.shadowColor="rgba("+E1.r+", "+E1.g+", "+E1.b+", "+E1.a/255+")",s1.shadowBlur=T1.blur,s1.shadowOffsetX=T1.offset.x,s1.shadowOffsetY=-T1.offset.y},_drawTextEffect:function(t,e){if(T1||C1||L1){var n=d1.length>1&&T1,i=this._measureText(s1,u1),r=0,o=0;T1&&this._setupShadow(),C1&&this._setupOutline();for(var a=0;a<d1.length;++a)r=t.x,o=t.y+a*e,n&&(C1&&s1.strokeText(d1[a],r,o),s1.fillText(d1[a],r,o)),L1&&(M1=i(d1[a]),v1===tK.RIGHT?D1.x=t.x-M1:v1===tK.CENTER?D1.x=t.x-M1/2:D1.x=t.x,D1.y=o+f1/8,s1.fillRect(D1.x,D1.y,M1,B1));n&&(s1.shadowColor="transparent")}},_updateLabelDimensions:function(){p1.width=Math.min(p1.width,2048),p1.height=Math.min(p1.height,2048);var t=!1;c1.width!==p1.width&&(c1.width=p1.width,t=!0),c1.height!==p1.height&&(c1.height=p1.height,t=!0),t&&(s1.font=u1),s1.textAlign=F1[v1],s1.textBaseline="alphabetic"},_getFontDesc:function(){var t=_1.toString()+"px ";return t+=x1,O1&&(t="bold "+t),N1&&(t="italic "+t),t},_getLineHeight:function(){return 0|(0===m1?_1:m1*_1/f1)},_calculateParagraphLength:function(t,e){for(var n,i=[],r=ot(t);!(n=r()).done;){var o=Pq(e,n.value,u1);i.push(o)}return i},_measureText:function(t,e){return function(n){return Pq(t,n,e)}},_calculateShrinkFont:function(t){if(s1){var e=this._calculateParagraphLength(t,s1),n=0,i=0,r=0;if(A1){var o=I1.width,a=I1.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|_1+1,l=0;s<c;){if((l=s+c+1>>1)<=0){w(4003);break}_1=l,u1=this._getFontDesc(),s1.font=u1;var u=this._getLineHeight();for(i=0,n=0;n<t.length;++n){var h=Pq(s1,t[n],u1);i+=Rq(t[n],h,o,this._measureText(s1,u1)).length*u}i>a?c=l-1:s=l}0===s?w(4003):(_1=s,u1=this._getFontDesc(),s1.font=u1)}else{for(i=t.length*this._getLineHeight(),n=0;n<t.length;++n)r<e[n]&&(r=e[n]);var _=(p1.width-w1.width)/r,f=p1.height/i;_1=f1*Math.min(1,_,f)|0,u1=this._getFontDesc(),s1.font=u1}}},_calculateWrapText:function(t){if(A1&&s1){d1=[];for(var e=I1.width,n=0;n<t.length;++n){var i=Pq(s1,t[n],u1),r=Rq(t[n],i,e,this._measureText(s1,u1));d1=d1.concat(r)}}},_calculateLabelFont:function(){if(s1){var t=h1.split("\n");switch(d1=t,u1=this._getFontDesc(),s1.font=u1,S1){case o1.NONE:for(var e=0,n=0,i=0;i<t.length;++i){var r=Pq(s1,t[i],u1);e=e>r?e:r}n=(d1.length+mq)*this._getLineHeight();var o=parseFloat(e.toFixed(2)),a=parseFloat(n.toFixed(2));p1.width=o+w1.width,p1.height=a+w1.height,I1.width=o+P1.width,I1.height=a+P1.height;break;case o1.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case o1.CLAMP:this._calculateWrapText(t);break;case o1.RESIZE_HEIGHT:this._calculateWrapText(t);var s=(d1.length+mq)*this._getLineHeight();p1.height=s+w1.height,I1.height=s+P1.height}}}},V1=En.WHITE.clone(),k1={createData:function(t){var e=t.requestRenderData();e.dataLength=2,e.resize(4,6);var n=e.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)En.toArray(n,V1,i),i+=9;return e},fillBuffers:function(t){var e=t.renderData.chunk,n=t.renderData.data,i=t.node,r=e.vb,o=n[0],a=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=o.x*l.x,h=a.x*l.x,_=o.y*l.y,f=a.y*l.y,d=c.x,p=c.y,m=c.z,v=c.w,g=d*p,y=m*v,x=d*d-p*p,S=v*v-m*m,A=S+x,C=2*(g-y),b=S-x,T=2*(g+y),E=s.x,w=s.y;r[0]=A*u+C*_+E,r[1]=b*_+T*u+w,r[9]=A*h+C*_+E,r[10]=b*_+T*h+w,r[18]=A*u+C*f+E,r[19]=b*f+T*u+w,r[27]=A*h+C*f+E,r[28]=b*f+T*h+w;var P=e.bufferId,I=e.vertexOffset,R=e.vertexAccessor.getMeshBuffer(e.bufferId),D=e.vertexAccessor.getIndexBuffer(P),M=R.indexOffset;D[M++]=I,D[M++]=I+1,D[M++]=I+2,D[M++]=I+2,D[M++]=I+1,D[M++]=I+3,R.indexOffset+=6},updateVertexData:function(t){var e=t.renderData;if(e){var n=t.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=e.data;s[0].x=-o,s[0].y=-a,s[1].x=i-o,s[1].y=r-a}},updateUVs:function(t){var e=t.renderData;if(e&&t.ttfSpriteFrame){var n=e.chunk.vb,i=t.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Ft(k1,z1);var G1=t("labelAssembler",{getAssembler:function(t){var e=k1;return t.font instanceof dq?e=t1:t.cacheMode===oK.CacheMode.CHAR&&(e=r1),e}});oK.Assembler=G1;var U1=XQ.FillType,H1=new Hn,j1=new Pn,W1={updateRenderData:function(t){var e=t.spriteFrame;GW.packToDynamicAtlas(t,e);var n=t.renderData;if(n&&e){if(n.updateRenderData(t,e),!n.vertDirty)return;var i=t.fillStart,r=t.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var o=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);o=o>1?1:o,this.updateUVs(t,i,o),this.updateVertexData(t,i,o)}},updateUVs:function(t,e,n){var i=t.spriteFrame,r=t.renderData.chunk.vb,o=i.width,a=i.height,s=i.rect,c=0,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0;switch(i.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=_=c,d=m=(s.x+s.height)/o,f=v=l,h=p=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=d=c,_=m=(s.x+s.width)/o,h=f=l,p=v=s.y/a),t.fillType){case U1.HORIZONTAL:r[3]=u+(_-u)*e,r[4]=h+(f-h)*e,r[12]=u+(_-u)*n,r[13]=h+(f-h)*n,r[21]=d+(m-d)*e,r[22]=p+(v-p)*e,r[30]=d+(m-d)*n,r[31]=p+(v-p)*n;break;case U1.VERTICAL:r[3]=u+(d-u)*e,r[4]=h+(p-h)*e,r[12]=_+(m-_)*e,r[13]=f+(v-f)*e,r[21]=u+(d-u)*n,r[22]=h+(p-h)*n,r[30]=_+(m-_)*n,r[31]=f+(v-f)*n;break;default:D(2626)}},updateVertexData:function(t,e,n){var i=t.renderData.data,r=t.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,_=a-c,f=0;switch(t.fillType){case U1.HORIZONTAL:f=l+(h-l)*n,l+=(h-l)*e,h=f;break;case U1.VERTICAL:f=u+(_-u)*n,u+=(_-u)*e,_=f;break;default:D(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=_,i[3].x=h,i[3].y=_},createData:function(t){var e=t.requestRenderData();e.dataLength=4,e.resize(4,6);for(var n,i=ot(e.data);!(n=i()).done;)n.value.z=0;return e},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(H1);for(var n=t.renderData.floatStride,i=t.renderData.data,r=e.vb,o=0,a=0;a<4;a++){var s=i[a];Pn.transformMat4(j1,s,H1),r[o=a*n]=j1.x,r[o+1]=j1.y,r[o+2]=j1.z}},fillBuffers:function(t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,n),e.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<4;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},q1=2*Math.PI,X1=1e-6,Y1=new Hn,K1=new Pn,J1=[new Xn,new Xn,new Xn,new Xn],Q1=new Array(4),Z1=new Array(8),$1=[new Xn,new Xn,new Xn,new Xn],t2=[new Xn,new Xn,new Xn,new Xn],e2=new Xn,n2=[new Xn,new Xn,new Xn,new Xn];function i2(t,e,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>X1?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>X1?c:0)){if(l=s/c,(t-r.x)*c>0){var h=r.y+l*(t-r.x);a[0].x=t,a[0].y=h}if((e-r.x)*c>0){var _=r.y+l*(e-r.x);a[2].x=e,a[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);a[3].x=f,a[3].y=i}if((n-r.y)*s>0){var d=r.x+u*(n-r.y);a[1].x=d,a[1].y=n}}}function r2(t,e){var n=e.x-t.x,i=e.y-t.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function o2(t,e,n,i,r){var o=Q1,a=o[0],s=o[1],c=o[2],l=o[3];t[e].x=n.x,t[e].y=n.y,t[e+1].x=i.x,t[e+1].y=i.y,t[e+2].x=r.x,t[e+2].y=r.y,a2((n.x-a)/(c-a),(n.y-s)/(l-s),t,e),a2((i.x-a)/(c-a),(i.y-s)/(l-s),t,e+1),a2((r.x-a)/(c-a),(r.y-s)/(l-s),t,e+2)}function a2(t,e,n,i){var r=Z1,o=r[0]+(r[2]-r[0])*t,a=r[4]+(r[6]-r[4])*t,s=r[1]+(r[3]-r[1])*t,c=r[5]+(r[7]-r[5])*t,l=n[i];l.u=o+(a-o)*e,l.v=s+(c-s)*e}for(var s2={useModel:!1,createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.spriteFrame;GW.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;if(n&&e){if(!n.vertDirty)return;var i=n.data,r=t.fillStart,o=t.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=q1)+(o*=q1);!function(t){var e=t.node._uiProps.uiTransformComp,n=e.width,i=e.height,r=e.anchorX*n,o=e.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=Q1;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=t.fillCenter,_=e2.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,f=e2.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;J1[0].x=J1[3].x=a,J1[1].x=J1[2].x=c,J1[0].y=J1[1].y=s,J1[2].y=J1[3].y=l;for(var d,p=ot(n2);!(d=p()).done;){var m=d.value;Xn.set(m,0,0)}_!==u[0]&&Xn.set(n2[0],3,0),_!==u[2]&&Xn.set(n2[2],1,2),f!==u[1]&&Xn.set(n2[1],0,1),f!==u[3]&&Xn.set(n2[3],2,3)}(t),function(t){var e=t.width,n=t.height,i=t.getRect(),r=0,o=0,a=0,s=0,c=Z1;t.isRotated()?(r=i.x/e,o=(i.x+i.height)/e,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/e,o=(i.x+i.width)/e,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(e),i2(Q1[0],Q1[2],Q1[1],Q1[3],e2,r,$1),i2(Q1[0],Q1[2],Q1[1],Q1[3],e2,r+o,t2);for(var s=0,c=0;c<4;++c){var l=n2[c];if(l)if(o>=q1)n.dataLength=s+3,o2(i,s,e2,J1[l.x],J1[l.y]),s+=3;else{var u=r2(e2,J1[l.x]),h=r2(e2,J1[l.y]);h<u&&(h+=q1),u-=q1,h-=q1;for(var _=0;_<3;++_)u>=a||(u>=r?(n.dataLength=s+3,o2(i,s,e2,J1[l.x],h>=a?t2[c]:J1[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,o2(i,s,e2,$1[c],J1[l.y]),s+=3):(n.dataLength=s+3,o2(i,s,e2,$1[c],t2[c]),s+=3))),u+=q1,h+=q1}}n.resize(s,s),n.updateRenderData(t,e)}},fillBuffers:function(t){var e=t.node,n=t.renderData,i=n.chunk;(e.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,i),n.vertDirty=!1),this.updataColorLate(t);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=o+l;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(t,e){t.node.getWorldMatrix(Y1);for(var n=t.renderData,i=n.floatStride,r=t.renderData.data,o=e.vb,a=n.vertexCount,s=0,c=0;c<a;c++){var l=r[c];Pn.set(K1,l.x,l.y,0),Pn.transformMat4(K1,K1,Y1),o[s+0]=K1.x,o[s+1]=K1.y,o[s+2]=K1.z,o[s+3]=l.u,o[s+4]=l.v,s+=i}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},updataColorLate:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},c2=[],l2=0;l2<4;l2++)c2.push(new Pn);for(var u2={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){var e=t.spriteFrame;GW.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.updateRenderData(t,e))},updateWorldVerts:function(t,e){var n=t.renderData,i=e.vb,r=n.data,o=t.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,_=c.m05,f=1===l&&0===u&&0===h&&1===_,d=c.m12,p=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(f){var x=m+d,S=v+d,A=g+p,C=y+p;i[0]=x,i[1]=A,i[9]=S,i[10]=A,i[18]=x,i[19]=C,i[27]=S,i[28]=C}else{var b=l*m,T=l*v,E=u*m,w=u*v,P=h*g+d,I=h*y+d,R=_*g+p,D=_*y+p;i[0]=b+P,i[1]=E+R,i[9]=T+P,i[10]=w+R,i[18]=b+I,i[19]=E+D,i[27]=T+I,i[28]=w+D}},fillBuffers:function(t){if(null!==t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVerts(t,n),e.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(i),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(t){var e=t.renderData;if(e){var n=t.node._uiProps.uiTransformComp,i=e.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(t.trim)c=-a,l=-s,u=r-a,h=o-s;else{var _=t.spriteFrame,f=_.getOriginalSize(),d=_.getRect(),p=f.width,m=f.height,v=d.width,g=d.height,y=_.getOffset(),x=r/p,S=o/m,A=y.x+(p-v)/2,C=y.x-(p-v)/2;c=A*x-a,l=(y.y+(m-g)/2)*S-s,u=r+C*x-a,h=o+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,e.vertDirty=!0}},updateUVs:function(t){if(t.spriteFrame){var e=t.renderData.chunk.vb,n=t.spriteFrame.uv;e[3]=n[0],e[4]=n[1],e[12]=n[2],e[13]=n[3],e[21]=n[4],e[22]=n[5],e[30]=n[6],e[31]=n[7]}},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=5,r=t.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=e.floatStride)n[i]=o,n[i+1]=a,n[i+2]=s,n[i+3]=c}},h2=new Pn,_2=new Hn,f2={createData:function(t){var e=t.requestRenderData();return e.dataLength=4,e.resize(16,54),e},updateRenderData:function(t){var e=t.spriteFrame;GW.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.updateRenderData(t,e))},updateVertexData:function(t){var e=t.renderData.data,n=t.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,_=i-c-l,f=r-u-h,d=i/(c+l),p=r/(u+h);d=Number.isNaN(d)||d>1?1:d,p=Number.isNaN(p)||p>1?1:p,_=_<0?0:_,f=f<0?0:f,e[0].x=-o,e[0].y=-a,e[1].x=c*d-o,e[1].y=h*p-a,e[2].x=e[1].x+_,e[2].y=e[1].y+f,e[3].x=i-o,e[3].y=r-a},fillBuffers:function(t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,n),e.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(_2);for(var n=t.renderData,i=n.floatStride,r=n.data,o=e.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];Pn.set(h2,u.x,c.y,0),Pn.transformMat4(h2,h2,_2),a=(4*s+l)*i,o[a++]=h2.x,o[a++]=h2.y,o[a++]=h2.z}},updateUVs:function(t){if(t.spriteFrame)for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=t.spriteFrame.uvSliced,o=3,a=0;a<16;a++)n[o]=r[a].u,n[o+1]=r[a].v,o+=i},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<16;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},d2=[],p2=0;p2<4;p2++)d2.push(new Pn);var m2=new Hn,v2={createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.renderData,n=t.spriteFrame;if(n&&e&&(e.updateRenderData(t,n),e.vertDirty)){var i=t.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,_=a.height-u-h,f=r-s-c,d=o-u-h;f=f>0?f:0,d=d>0?d:0;var p=0===l?f:f/l,m=0===_?d:d/_,v=Math.ceil(m+2),g=Math.ceil(p+2);e.dataLength=Math.max(8,v+1,g+1),this.updateVerts(t,f,d,v,g),e.resize(v*g*4,v*g*6)}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},fillBuffers:function(t){var e=t.node,n=t.renderData,i=n.chunk;(e.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,i),n.vertDirty=!1),this.updataColorLate(t);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(t,e){var n=t.node;n.getWorldMatrix(m2);var i=t.renderData,r=i.floatStride,o=i.data,a=e.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=t.spriteFrame,h=u.rotated,_=u.uv,f=u.uvSliced,d=u.rect,p=u.insetLeft,m=u.insetRight,v=d.width-p-m,g=u.insetTop,y=u.insetBottom,x=d.height-g-y,S=c-p-m,A=l-g-y;S=S>0?S:0,A=A>0?A:0;for(var C=0===v?S:S/v,b=0===x?A:A/x,T=Math.ceil(b+2),E=Math.ceil(C+2),w=0,P=0,I=0,R=0,D=0,M=0,B=T;M<B;++M){R=o[M].y,D=o[M+1].y;for(var O=0,N=E;O<N;++O){P=o[O].x,I=o[O+1].x,Pn.set(d2[0],P,R,0),Pn.set(d2[1],I,R,0),Pn.set(d2[2],P,D,0),Pn.set(d2[3],I,D,0);for(var L=0;L<4;L++){var F=d2[L];Pn.transformMat4(F,F,m2);var z=L*r;a[w+z]=F.x,a[w+z+1]=F.y,a[w+z+2]=F.z}w+=4*r}}w=0;for(var V=r,k=2*r,G=3*r,U=4*r,H=0,j=0,W=[],q=[],X=0,Y=T;X<Y;++X){j=A>x?A>=X*x?1:b%1:b;for(var K=0,J=E;K<J;++K){H=S>v?S>=K*v?1:C%1:C;var Q=w+3,Z=Q+1;h?(0===X?(W[0]=f[0].u,W[1]=f[0].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X<T-1?(W[0]=f[4].u,W[1]=f[4].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X===T-1&&(W[0]=f[8].u,W[1]=f[8].u,W[2]=f[12].u),0===K?(q[0]=f[0].v,q[1]=f[1].v+(f[2].v-f[1].v)*H,q[2]=f[0].v):K<E-1?(q[0]=f[1].v,q[1]=f[1].v+(f[2].v-f[1].v)*H,q[2]=f[1].v):K===E-1&&(q[0]=f[2].v,q[1]=f[3].v,q[2]=f[2].v),W[3]=W[2],q[3]=q[1]):(0===K?(W[0]=f[0].u,W[1]=f[1].u+(f[2].u-f[1].u)*H,W[2]=_[0]):K<E-1?(W[0]=f[1].u,W[1]=f[1].u+(f[2].u-f[1].u)*H,W[2]=f[1].u):K===E-1&&(W[0]=f[2].u,W[1]=f[3].u,W[2]=f[2].u),0===X?(q[0]=f[0].v,q[1]=f[0].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X<T-1?(q[0]=f[4].v,q[1]=f[4].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X===T-1&&(q[0]=f[8].v,q[1]=f[8].v,q[2]=f[12].v),W[3]=W[1],q[3]=q[2]),a[Q]=W[0],a[Z]=q[0],a[Q+V]=W[1],a[Z+V]=q[1],a[Q+k]=W[2],a[Z+k]=q[2],a[Q+G]=W[3],a[Z+G]=q[3],w+=U}}},updateVerts:function(t,e,n,i,r){var o,a,s=t.node._uiProps.uiTransformComp,c=t.renderData.data,l=t.spriteFrame,u=l.rect,h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,d=s.anchorY*_,p=l.insetLeft,m=l.insetRight,v=u.width-p-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(p+m)>1?1:s.width/(p+m),A=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*e)/1e3%v==0?v:e%v:e,a=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var C=0;C<=r;C++)0===C?c[C].x=-f:C>0&&C<r?c[C].x=1===C?p*S+Math.min(v,e)-f:v>0?C===r-1?p+o+v*(C-2)-f:p+Math.min(v,e)+v*(C-2)-f:p+e-f:C===r&&(c[C].x=Math.min(p+e+m,h)-f);for(var b=0;b<=i;b++)0===b?c[b].y=-d:b>0&&b<i?c[b].y=1===b?y*A+Math.min(x,n)-d:x>0?b===i-1?y+a+(b-2)*x-d:y+Math.min(x,n)+(b-2)*x-d:y+n-d:b===i&&(c[b].y=Math.min(y+n+g,_)-d)},updataColorLate:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},g2=XQ.Type,y2=XQ.FillType,x2=t("spriteAssembler",{getAssembler:function(t){var e=u2,n=t;switch(n.type){case g2.SLICED:e=f2;break;case g2.TILED:e=v2;break;case g2.FILLED:e=n.fillType===y2.RADIAL?s2:W1}return e}});XQ.Assembler=x2;var S2=GX.sharedManager,A2={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){t.type===PJ.IMAGE_STENCIL&&(u2.updateRenderData(t),u2.updateColor(t))},fillBuffers:function(t,e){(t.type!==PJ.IMAGE_STENCIL||t.spriteFrame)&&(S2.pushMask(t),e.finishMergeBatches(),function(t,e){S2.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(S2.enterLevel(t),t.type===PJ.IMAGE_STENCIL){u2.fillBuffers(t,e);var n=t.graphics.getMaterialInstance(0);e.forceMergeBatches(n,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),S2.enableMask())}},C2={fillBuffers:function(){S2.exitMask()}},b2={getAssembler:function(){return A2}},T2={getAssembler:function(){return C2}};BJ.Assembler=b2,BJ.PostAssembler=T2;var E2=t("MeshBuffer",function(){function t(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var e=t.prototype;return e.initialize=function(t,e,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=e,this._floatsPerVertex=Hq(e),this._initVDataCount,this._floatsPerVertex,N(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(t))},e.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},e.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var t=0;t<this._iaPool.length;++t){var e=this._iaPool[t];e.vertexBuffers[0]&&e.vertexBuffers[0].destroy(),e.indexBuffer&&e.indexBuffer.destroy(),e.ia.destroy()}this._iaPool.length=0},e.setDirty=function(){this._dirty=!0},e.request=function(){return I(9002),!1},e.requireFreeIA=function(t){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(t)),this._iaPool[this._nextFreeIAHandle++].ia},e.recycleIA=function(t){for(var e=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(t===e[n].ia){var i=e[n];return e[n]=e[--this._nextFreeIAHandle],void(e[this._nextFreeIAHandle]=i)}},e.checkCapacity=function(t,e){var n=this.vertexOffset+t,i=this.indexOffset+e;return!(n>this._initVDataCount||i>this._initIDataCount)},e.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var t=sh.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,e=this.byteOffset,n=this.indexOffset,i=0;i<t;++i){var r=this._iaPool[i],o=new Float32Array(this.vData.buffer,0,e>>2),a=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];e>s.size&&s.resize(e),s.update(o),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(a)}this._dirty=!1}},e.createNewIA=function(t){var e,n,i;if(sh.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=t.createBuffer(new hr(pi.VERTEX|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,r,r));i=t.createBuffer(new hr(pi.INDEX|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,o,o)),n=[a],this._iaInfo=new Rr(this._attributes,n,i),e=t.createInputAssembler(this._iaInfo)}else e=t.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:e,vertexBuffers:n,indexBuffer:i}},K(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),t}()),w2=[rD.EventType.MOUSE_DOWN,rD.EventType.MOUSE_MOVE,rD.EventType.MOUSE_UP,rD.EventType.MOUSE_WHEEL],P2=[rD.EventType.TOUCH_START,rD.EventType.TOUCH_MOVE,rD.EventType.TOUCH_END,rD.EventType.TOUCH_CANCEL],I2=(new(function(){function t(){this.priority=YR.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],oD._registerEventDispatcher(this),AR.callbacksInvoker.on(FE.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),AR.callbacksInvoker.on(FE.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),AR.callbacksInvoker.on(FE.MARK_LIST_DIRTY,this._markListDirty,this)}var e=t.prototype;return e.dispatchEvent=function(t){var e=t.type;return P2.includes(e)?this.dispatchEventTouch(t):!w2.includes(e)||this.dispatchEventMouse(t)},e.addPointerEventProcessor=function(t){0===this._inDispatchCount?this._pointerEventProcessorList.includes(t)||(this._pointerEventProcessorList.push(t),this._isListDirty=!0):this._processorListToAdd.includes(t)||this._processorListToAdd.push(t),ne.array.remove(this._processorListToRemove,t)},e.removePointerEventProcessor=function(t){0===this._inDispatchCount?(ne.array.remove(this._pointerEventProcessorList,t),this._isListDirty=!0):this._processorListToRemove.includes(t)||this._processorListToRemove.push(t),ne.array.remove(this._processorListToAdd,t)},e.dispatchEventMouse=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,n=e.length,i=!0,r=0;r<n;++r){var o=e[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(t)){if(i=!1,!t.preventSwallow)break;t.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},e.dispatchEventTouch=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,n=e.length,i=t.touch,r=!0,o=0;o<n;++o){var a=e[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(t.type===NE.TOUCH_START){if(a._handleEventTouch(t)){if(a.claimedTouchIdList.push(i.getID()),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(a._handleEventTouch(t),t.type!==NE.TOUCH_END&&t.type!==NE.TOUCH_CANCEL||ne.array.removeAt(a.claimedTouchIdList,s),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},e._updatePointerEventProcessorList=function(){for(var t=this._processorListToAdd,e=t.length,n=0;n<e;++n)this.addPointerEventProcessor(t[n]);t.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},e._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var t=this._pointerEventProcessorList,e=t.length,n=0;n<e;++n){var i=t[n],r=i.node;if(r._uiProps){var o=r._uiProps.uiTransformComp;i.cachedCameraPriority=o.cameraPriority}}t.sort(this._sortByPriority),this._isListDirty=!1}},e._sortByPriority=function(t,e){var n=t.node,i=e.node;if(!(e&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(t&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(t.cachedCameraPriority!==e.cachedCameraPriority)return e.cachedCameraPriority-t.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var f=r?r.getSiblingIndex():0,d=o?o.getSiblingIndex():0;return a?f-d:d-f},e._markListDirty=function(){this._isListDirty=!0},t}()),function(){function t(t,e){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=t,this._attributes=e,this._floatsPerVertex=Hq(e),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var e=t.prototype;return e.initialize=function(){},e.reset=function(){},e.request=function(){},e.appendBuffers=function(){},e.uploadBuffers=function(){},e.destroy=function(){this._attributes.length=0},K(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),t}()),R2=new Ul((function(){return{offset:0,length:0}}),32),D2=function(t,e,n,i){this.vertexAccessor=t,this.bufferId=e,this.vertexOffset=n,this.vb=i},M2=function(t){function e(n,i,r,o){var a;return(a=t.call(this,n,i)||this)._freeLists=[],a._vCount=0,a._iCount=0,a._vCount=r||Math.floor(1024*ue.BATCHER2D_MEM_INCREMENT/a._vertexFormatBytes),a._iCount=o||a._vCount*e.IB_SCALE,a._allocateBuffer(),a}Q(e,t);var n=e.prototype;return n.destroy=function(){for(var e=0;e<this._buffers.length;++e){this._buffers[e].destroy();for(var n=this._freeLists[e],i=0;i<n.length;++i)R2.free(n[i])}this._buffers.length=0,this._freeLists.length=0,t.prototype.destroy.call(this)},n.reset=function(){for(var t=0;t<this._buffers.length;++t){var e=this._buffers[t];e.indexOffset=0,e.reset()}},n.getVertexBuffer=function(t){return this._buffers[t].vData},n.getIndexBuffer=function(t){return this._buffers[t].iData},n.getMeshBuffer=function(t){return this._buffers[t]},n.uploadBuffers=function(){for(var t=0;t<this._buffers.length;++t){var e=this._freeLists[t][0],n=this._buffers[t];(!e||e.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(t,e){var n=this._buffers[t];e.length&&(n.iData.set(e,n.indexOffset),n.indexOffset+=e.length)},n.allocateChunk=function(t,e){for(var n,i=t*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(t,e)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,i),new D2(this,o,u,h,e)}return I(9004,i),null},n.recycleChunk=function(t){var e=this._freeLists[t.bufferId],n=this._buffers[t.bufferId],i=t.vertexOffset*this.vertexFormatBytes,r=t.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=e[a];c&&c.offset<i;)s=c,c=e[++a];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,e.splice(a,1),R2.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=R2.alloc();l.offset=i,l.length=r,e.splice(a,0,l)}o=!0}if(o)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=R2.alloc();u.offset=i,u.length=r,e.push(u)}}},n._allocateChunkFromEntry=function(t,e,n,i){var r=n.length-i,o=n.offset+i,a=this._buffers[t];a.byteOffset<o&&(a.byteOffset=o),O(r>=0,9004,t,n.offset,n.length),0===r?(this._freeLists[t].splice(e,1),R2.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){O(this._buffers.length===this._freeLists.length,9003);var t=new E2,e=this._vCount*this._floatsPerVertex;t.initialize(this._device,this._attributes,e,this._iCount),this._buffers.push(t);var n=R2.alloc();n.offset=0,n.length=t.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1},e}(I2);M2.IB_SCALE=4;var B2=new Gr(null),O2=new Hn,N2=t("UI",function(){function t(t){var e=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new rg,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new F2,this._meshDataArray=[],this._root=t,this.device=t.device,this._batches=new jl(64),this._drawBatchPool=new Ul((function(){return new B$}),128,(function(t){return t.destroy(e)}))}var e=t.prototype;return e.initialize=function(){return!0},e.destroy=function(){for(var t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(t){t.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),GX.sharedManager.destroy()},e.addScreen=function(t){this._screens.push(t),this._screens.sort(this._screenSort)},e.removeScreen=function(t){var e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)},e.sortScreens=function(){this._screens.sort(this._screenSort)},e.getFirstRenderCamera=function(t){if(t.scene&&t.scene.renderScene)for(var e=t.scene.renderScene.cameras,n=0;n<e.length;n++){var i=e[n];if(i.visibility&t.layer)return i}return null},e.update=function(){for(var t=this._screens,e=0,n=0;n<t.length;++n){var i=t[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var o=0;if(this._batches.length>e)for(;e<this._batches.length;++e){var a=this._batches.array[e];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},e.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(t){t.uploadBuffers()})),this._bufferAccessors.forEach((function(t){t.uploadBuffers(),t.reset()})),this._descriptorSetCache.update())},e.reset=function(){for(var t=0;t<this._batches.length;++t){var e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._bufferAccessors.forEach((function(t){t.reset()})),this._meshDataArray.forEach((function(t){t.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),GX.sharedManager.reset()},e.switchBufferAccessor=function(t){void 0===t&&(t=Gq);var e=t===Gq?36:jq(t);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==e){var n=this._bufferAccessors.get(e);n||(n=new M2(this.device,t),this._bufferAccessors.set(e,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},e.registerBufferAccessor=function(t,e){this._bufferAccessors.set(t,e)},e.updateBuffer=function(t,e){var n=this.switchBufferAccessor(t);this._currBID!==e&&(this._currBID=e,this._indexStart=n.getMeshBuffer(e).indexOffset)},e.commitComp=function(t,e,n,i,r){var o,a=0,s=-1;if(e&&e.chunk){if(!e.isValid())return;a=e.dataHash,o=e.material,s=e.chunk.bufferId}t.stencilStage=GX.sharedManager.stage;var c=t.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),e&&!e.isMeshBuffer&&this.updateBuffer(e.vertexFormat,s),this._currRenderData=e,this._currHash=e?e.dataHash:0,this._currComponent=t,this._currTransform=r,this._currMaterial=t.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=t.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(t,this)},e.commitIA=function(t,e,n,i,r){var o,a;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;t&&(o=-1===t.blendHash?null:t.getBlendState(),c=t.blendHash,t.stencilStage=GX.sharedManager.stage,a=null!==t.customMaterial?GX.sharedManager.getStencilStage(t.stencilStage,i):GX.sharedManager.getStencilStage(t.stencilStage),s=GX.sharedManager.getStencilHash(t.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=t.node.layer,l.inputAssembler=e,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,a,s,o,c,null,this),this._batches.push(l)},e.commitModel=function(t,e,n){var i;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;n&&(t.stencilStage!==oX.ENABLED&&t.stencilStage!==oX.DISABLED||(t.stencilStage=GX.sharedManager.stage),i=GX.sharedManager.getStencilStage(t.stencilStage,n),r=GX.sharedManager.getStencilHash(t.stencilStage));var o=c.director.getTotalFrames();e&&(e.updateTransform(o),e.updateUBOs(o));for(var a=0;a<e.subModels.length;a++){var s=this._drawBatchPool.alloc(),l=e.subModels[a];s.visFlags=t.node.layer,s.model=e,s.texture=null,s.sampler=null,s.useLocalData=null,i||(i=null),s.fillPasses(n,i,r,null,0,l.patches,this),s.inputAssembler=l.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=l.descriptorSet,this._batches.push(s)}},e.setupStaticBatch=function(t,e){this.finishMergeBatches(),this._staticVBBuffer=e,this.currStaticRoot=t},e.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},e.commitStaticBatch=function(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()},e.autoMergeBatches=function(t){var e=this._currMaterial;if(e){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(n=a.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;t&&(c=-1===t.blendHash?null:t.getBlendState(),h=t.blendHash,l=null!==t.customMaterial?GX.sharedManager.getStencilStage(t.stencilStage,e):GX.sharedManager.getStencilStage(t.stencilStage),u=GX.sharedManager.getStencilHash(t.stencilStage));var _=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();_.visFlags=this._currLayer,_.texture=this._currTexture,_.sampler=this._currSampler,_.inputAssembler=n,_.useLocalData=this._currTransform,_.textureHash=this._currTextureHash,_.samplerHash=this._currSamplerHash,_.fillPasses(e,l,u,c,h,null,this),this._batches.push(_)}}},e.forceMergeBatches=function(t,e,n){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},e.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},e.flushMaterial=function(t){this._currMaterial=t},e.walk=function(t,e){if(void 0===e&&(e=0),t.activeInHierarchy){var n=t.children,i=t._uiProps,r=i.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*i.localOpacity,i._opacity=a,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&r.renderData.vertexCount>0){!function(t,e){for(var n,i,r,o=t.vertexFormat,a=t.chunk.vb,s=0,c=0;c<o.length;++c){if(n=o[c],(i=Zr[n.format]).hasAlpha)if(r=t.floatStride,i.size/i.count==1)for(var l=~~sn(Math.round(255*e),0,255),u=s;u<a.length;u+=r)a[u]=(4294967040&a[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<a.length;h+=r)a[h]=e;s+=i.size>>2}}(r.renderData,a);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!t._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,e)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),e+=1}},e._screenSort=function(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()},e._releaseDescriptorSetCache=function(t){this._descriptorSetCache.releaseDescriptorSetCache(t)},K(t,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(t){this._currStaticRoot=t}},{key:"currIsStatic",set:function(t){this._currIsStatic=t}}]),t}()),L2=function(){function t(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var t=c.director.root.device;this._localData=new Float32Array(lp.COUNT),this._localBuffer=t.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,lp.SIZE,lp.SIZE))}var e=t.prototype;return e.initialize=function(t){var e=c.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,B2.layout=t.passes[0].localSetLayout,this._descriptorSet=e.createDescriptorSet(B2),this._descriptorSet.bindBuffer(lp.BINDING,this._localBuffer);var n=Gd.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,t.texture),this._descriptorSet.bindSampler(n,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0},e.updateTransform=function(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())},e.equals=function(t,e,n){return this._transform===t&&this._textureHash===e&&this._samplerHash===n},e.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},e.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},e.isValid=function(){return this._transform&&this._transform.isValid},e.uploadLocalData=function(){var t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var e=t.worldMatrix;Hn.toArray(this._localData,e,lp.MAT_WORLD_OFFSET),Hn.inverseTranspose(O2,e);var n=Hn.determinant(O2),i=1/Math.sqrt(n);Hn.multiplyScalar(O2,O2,i),Hn.toArray(this._localData,O2,lp.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},K(t,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),t}(),F2=function(){function t(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Ul((function(){return new L2}),16,(function(t){return t.destroy()}))}var e=t.prototype;return e.getDescriptorSet=function(t){var e,n=c.director.root;if(t.useLocalData){for(var i=this._localDescriptorSetCache,r=0,o=i.length;r<o;r++){var a=i[r];if(a.equals(t.useLocalData,t.textureHash,t.samplerHash))return a.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(t),this._localDescriptorSetCache.push(s),s.descriptorSet}if(e=t.textureHash^t.samplerHash,this._descriptorSetCache.has(e))return this._descriptorSetCache.get(e);B2.layout=t.passes[0].localSetLayout;var l=n.device.createDescriptorSet(B2),u=Gd.SAMPLER_SPRITE;return l.bindTexture(u,t.texture),l.bindSampler(u,t.sampler),l.update(),this._descriptorSetCache.set(e,l),this._dsCacheHashByTexture.set(t.textureHash,e),l},e.update=function(){var t=this._localDescriptorSetCache,e=[];t.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=t.indexOf(n);e.push(i)}}));for(var n=e.length-1;n>=0;n--)t.splice(e[n],1)},e.reset=function(){var t=this;this._localDescriptorSetCache.forEach((function(e){t._localCachePool.free(e)})),this._localDescriptorSetCache.length=0},e.releaseDescriptorSetCache=function(t){var e=this._dsCacheHashByTexture.get(t);e&&this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).destroy(),this._descriptorSetCache.delete(e),this._dsCacheHashByTexture.delete(t))},e.destroy=function(){this._descriptorSetCache.forEach((function(t){t.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},t}();c.internal.Batcher2D=N2,k(E2.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(t){return{name:t,suggest:"please use meshBuffer.accessor."+t+" instead"}}))),z(E2.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),V(E2.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),z(N2.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),V(hX.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),z(hX.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),t("QuadRenderData",function(t){function e(e){var n;return n=t.call(this,e)||this,I(9006),n}return Q(e,t),e}(hX));var z2,V2,k2,G2,U2=null,H2=-1,j2="BES bswy:->@123丁ぁᄁ",W2=Object.create(null),q2=[],X2=3e3;function Y2(){for(var t=!0,e=Date.now(),n=q2.length-1;n>=0;n--){var i=q2[n],r=i.fontFamilyName;if(e-i.startTime>X2)I(4933,r),i.onComplete(null,r),q2.splice(n,1);else{var o=i.refWidth,a="40px "+r;U2.font=a,o!==Pq(U2,j2,a)?(q2.splice(n,1),i.onComplete(null,r)):t=!1}}t&&(clearInterval(H2),H2=-1)}function K2(t,e,n){var i=function(t){var e=t.lastIndexOf(".ttf");if(-1===e)return t;var n,i=t.lastIndexOf("/");return-1!==(n=-1===i?t.substring(0,e)+"_LABEL":t.substring(i+1,e)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(t);if(W2[i])n(null,i);else{if(!U2){var r=document.createElement("canvas");r.width=100,r.height=100,U2=r.getContext("2d")}var o=Pq(U2,j2,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+t+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===z2)if("FontFace"in window){var t=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),e=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);z2=t?parseInt(t[1],10)>42:!e}else z2=!1;return z2}())!function(t,e,n){var i=new Promise((function(n,i){!function r(){Date.now()-t>=X2?i():document.fonts.load("40px "+e).then((function(t){t.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,o=new Promise((function(t,e){r=setTimeout(e,X2)}));Promise.race([o,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,e)}),(function(){I(4933,e),n(null,e)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};q2.push(u),-1===H2&&(H2=setInterval(Y2,100))}W2[i]=a}}function J2(t,e,n,i){var r=new uq;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}PO.register({".font":K2,".eot":K2,".ttf":K2,".woff":K2,".svg":K2,".ttc":K2}),NO.register({".font":J2,".eot":J2,".ttf":J2,".woff":J2,".svg":J2,".ttc":J2}),c.UI={MeshBuffer:E2,spriteAssembler:x2,graphicsAssembler:x0,labelAssembler:G1,RenderData:uX,MeshRenderData:hX},function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(V2||(V2={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(k2||(k2={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(G2||(G2={}));var Q2,Z2=0;function $2(t,e){var n;e.invoking||(e.invoking=!0,(n=e.func).call.apply(n,[t].concat(e.args)).then((function(){e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString());var n=t._operationQueue[0];n&&$2(t,n)})).catch((function(){})))}function t4(t,e,n){var i=n.value;n.value=function(){for(var t=this,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return new Promise((function(e){var r=Z2++,o=t;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),e),$2(o,o._operationQueue[0])}))}}function e4(t){return new Promise((function(e){var n=t.play();return void 0===n?e():(n.then(e).catch((function(){var n=function(){t.play().catch((function(){})),e()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var n4,i4,r4=function(){function t(t,e){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=t,t.volume=e}var e=t.prototype;return e.play=function(){var t=this;e4(this._domAudio).then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t)})).catch((function(){}))},e.stop=function(){this._domAudio.pause()},K(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=t,t&&this._domAudio.addEventListener("ended",t)}}]),t}(),o4=(st((Q2=function(){function t(t){var e=this;this._domAudio=void 0,this._state=G2.INIT,this._onEnded=void 0,this._eventTarget=new $l,this._operationQueue=[],this._domAudio=t,fu.on("hide",this._onHide,this),fu.on("show",this._onShow,this),this._onEnded=function(){e.seek(0).catch((function(){})),e._state=G2.INIT,e._eventTarget.emit(V2.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var e=t.prototype;return e.destroy=function(){fu.off("hide",this._onHide,this),fu.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},t.load=function(e){return new Promise((function(n){t.loadNative(e).then((function(e){n(new t(e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,n){var i=document.createElement("audio"),r="canplaythrough";fu.os===ru.IOS?r="loadedmetadata":fu.browserType===eu.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),e(i)},c=function(){a(),n("load audio failure - "+t)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=t}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,r){t.loadNative(e).then((function(t){var e=new r4(t,n);i(e)})).catch(r)}))},e._onHide=function(){var t=this;this._state===G2.PLAYING&&this.pause().then((function(){t._state=G2.INTERRUPTED,t._eventTarget.emit(V2.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===G2.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(V2.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){return t=sn(t,0,this.duration),this._domAudio.currentTime=t,Promise.resolve()},e.play=function(){var t=this;return new Promise((function(e){e4(t._domAudio).then((function(){t._state=G2.PLAYING,e()})).catch((function(){}))}))},e.pause=function(){return this._domAudio.pause(),this._state=G2.PAUSED,Promise.resolve()},e.stop=function(){var t=this;return new Promise((function(e){t._domAudio.pause(),t._domAudio.currentTime=0,t._state=G2.STOPPED,e()}))},e.onInterruptionBegin=function(t){this._eventTarget.on(V2.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(V2.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(V2.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(V2.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(V2.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(V2.ENDED,t)},K(t,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return k2.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(t){this._domAudio.loop=t}},{key:"volume",get:function(){return this._domAudio.volume},set:function(t){t=cn(t),this._domAudio.volume=t}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),t}()).prototype,"seek",[t4],Object.getOwnPropertyDescriptor(Q2.prototype,"seek"),Q2.prototype),st(Q2.prototype,"play",[t4],Object.getOwnPropertyDescriptor(Q2.prototype,"play"),Q2.prototype),st(Q2.prototype,"pause",[t4],Object.getOwnPropertyDescriptor(Q2.prototype,"pause"),Q2.prototype),st(Q2.prototype,"stop",[t4],Object.getOwnPropertyDescriptor(Q2.prototype,"stop"),Q2.prototype),Q2),a4=function(){function t(t){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=t}var e=t.prototype;return e.destroy=function(){this._nativeAudio=void 0},e._now=function(){return performance.now()/1e3},e._calculateCurrentTime=function(){var t=this._now()-this._startTime,e=this._startOffset+t;return e>=this.duration&&(this._startTime=this._now(),this._startOffset=0),e%this.duration},e.start=function(){this._isPaused=!1,this._startTime=this._now()},e.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},e.stop=function(){this._isPaused=!0,this._startOffset=0},e.seek=function(t){this._startTime=this._now(),this._startOffset=sn(t,0,this.duration)},K(t,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),t}(),s4=new(function(){function t(){this._audioBufferDataMap={}}var e=t.prototype;return e.addCache=function(t,e){this._audioBufferDataMap[t]?console.warn("Audio buffer "+t+" has been cached"):this._audioBufferDataMap[t]={usedCount:1,audioBuffer:e}},e.retainCache=function(t){var e=this._audioBufferDataMap[t];e?e.usedCount++:console.warn("Audio buffer cache "+t+" has not been added.")},e.getCache=function(t){var e=this._audioBufferDataMap[t];return null==e?void 0:e.audioBuffer},e.tryReleasingCache=function(t){var e=this._audioBufferDataMap[t];e?--e.usedCount<=0&&delete this._audioBufferDataMap[t]:console.warn("Audio buffer cache "+t+" has not been added.")},t}()),c4=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,l4=function(){function t(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var e=t.prototype;return e.decodeAudioData=function(t){var e=this;return new Promise((function(n){var i=e._context.decodeAudioData(t,(function(t){n(t)}),(function(t){console.error("failed to load Web Audio",t)}));null==i||i.catch((function(){}))}))},e.runContext=function(){var t=this;return new Promise((function(e){var n=t._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(e).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else e();else e()}))},e.createBufferSource=function(t,e){var n=this._context.createBufferSource();return void 0!==t&&(n.buffer=t),void 0!==e&&(n.loop=e),n},e.createGain=function(t){void 0===t&&(t=1);var e=this._context.createGain();return this.setGainValue(e,t),e},e.setGainValue=function(t,e){if(t.gain.setTargetAtTime)try{t.gain.setTargetAtTime(e,this._context.currentTime,0)}catch(n){t.gain.setTargetAtTime(e,this._context.currentTime,.01)}else t.gain.value=e},e.connectContext=function(t){this._context&&t.connect(this._context.destination)},K(t,[{key:"currentTime",get:function(){return this._context.currentTime}}]),t}();l4.support=!!c4,l4.support&&(i4=new l4);var u4,h4,_4,f4,d4,p4=function(){function t(t,e,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=t.duration,this._url=n,this._bufferSourceNode=i4.createBufferSource(t,!1);var i=i4.createGain(e);this._bufferSourceNode.connect(i),i4.connectContext(i)}var e=t.prototype;return e.play=function(){var t=this;this._bufferSourceNode.start(),i4.runContext().then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t),t._currentTimer=window.setTimeout((function(){var e;s4.tryReleasingCache(t._url),null===(e=t.onEnd)||void 0===e||e.call(t)}),1e3*t._duration)})).catch((function(){}))},e.stop=function(){clearTimeout(this._currentTimer),s4.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},K(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb=t}}]),t}(),m4=(st((n4=function(){function t(t,e){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=G2.INIT,this._audioTimer=void 0,this._eventTarget=new $l,this._operationQueue=[],this._audioBuffer=t,this._audioTimer=new a4(t),this._gainNode=i4.createGain(),i4.connectContext(this._gainNode),this._src=e,fu.on("hide",this._onHide,this),fu.on("show",this._onShow,this)}var e=t.prototype;return e.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),s4.tryReleasingCache(this._src),fu.off("hide",this._onHide,this),fu.off("show",this._onShow,this)},t.load=function(e){return new Promise((function(n){t.loadNative(e).then((function(i){n(new t(i,e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,n){var i=s4.getCache(t);if(i)return s4.retainCache(t),void e(i);var r=new XMLHttpRequest,o="load audio failed: "+t+", status: ";r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?i4.decodeAudioData(r.response).then((function(n){s4.addCache(t,n),e(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,r){t.loadNative(e).then((function(t){var r=new p4(t,n,e);i(r)})).catch(r)}))},e._onHide=function(){var t=this;this._state===G2.PLAYING&&this.pause().then((function(){t._state=G2.INTERRUPTED,t._eventTarget.emit(V2.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===G2.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(V2.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){var e=this;return new Promise((function(n){e._audioTimer.seek(t),e._state===G2.PLAYING?e._doPlay().then(n).catch((function(){})):n()}))},e.play=function(){return this._doPlay()},e._doPlay=function(){var t=this;return new Promise((function(e){t._stopSourceNode(),t._sourceNode=i4.createBufferSource(t._audioBuffer,t.loop),t._sourceNode.connect(t._gainNode),t._sourceNode.start(0,t._audioTimer.currentTime),i4.runContext().then((function(){t._state=G2.PLAYING,t._audioTimer.start(),window.clearTimeout(t._currentTimer),t._currentTimer=window.setTimeout((function e(){t.loop?t._currentTimer=window.setTimeout(e,1e3*t._audioBuffer.duration):(t._audioTimer.stop(),t._eventTarget.emit(V2.ENDED),t._state=G2.INIT)}),1e3*(t._audioBuffer.duration-t._audioTimer.currentTime)),e()})).catch((function(){}))}))},e._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(t){}},e.pause=function(){return this._state===G2.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=G2.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=G2.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.onInterruptionBegin=function(t){this._eventTarget.on(V2.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(V2.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(V2.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(V2.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(V2.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(V2.ENDED,t)},K(t,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return k2.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._sourceNode&&(this._sourceNode.loop=t)}},{key:"volume",get:function(){return this._volume},set:function(t){t=cn(t),this._volume=t,i4.setGainValue(this._gainNode,t)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),t}()).prototype,"seek",[t4],Object.getOwnPropertyDescriptor(n4.prototype,"seek"),n4.prototype),st(n4.prototype,"play",[t4],Object.getOwnPropertyDescriptor(n4.prototype,"play"),n4.prototype),st(n4.prototype,"pause",[t4],Object.getOwnPropertyDescriptor(n4.prototype,"pause"),n4.prototype),st(n4.prototype,"stop",[t4],Object.getOwnPropertyDescriptor(n4.prototype,"stop"),n4.prototype),n4),v4=function(){function t(t){this._audio=void 0,this._audio=t}var e=t.prototype;return e.play=function(){this._audio.play()},e.stop=function(){this._audio.stop()},K(t,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(t){this._audio.onPlay=t}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(t){this._audio.onEnd=t}}]),t}(),g4=function(){function t(t){this._player=void 0,this._player=t}t.load=function(e,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==k2.DOM_AUDIO&&l4.support?m4.load(e).then((function(e){i(new t(e))})).catch((function(){})):(l4.support||I(5201),o4.load(e).then((function(e){i(new t(e))})).catch((function(){})))}))};var e=t.prototype;return e.destroy=function(){this._player.destroy()},t.loadNative=function(t,e){return(null==e?void 0:e.audioLoadMode)!==k2.DOM_AUDIO&&l4.support?m4.loadNative(t):(l4.support||I(5201),o4.loadNative(t))},t.loadOneShotAudio=function(t,e,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==k2.DOM_AUDIO&&l4.support?m4.loadOneShotAudio(t,e).then((function(t){i(new v4(t))})).catch(r):(l4.support||I(5201),o4.loadOneShotAudio(t,e).then((function(t){i(new v4(t))})).catch(r))}))},e.seek=function(t){return this._player.seek(t)},e.play=function(){return this._player.play()},e.pause=function(){return this._player.pause()},e.stop=function(){return this._player.stop()},e.onInterruptionBegin=function(t){this._player.onInterruptionBegin(t)},e.offInterruptionBegin=function(t){this._player.offInterruptionBegin(t)},e.onInterruptionEnd=function(t){this._player.onInterruptionEnd(t)},e.offInterruptionEnd=function(t){this._player.offInterruptionEnd(t)},e.onEnded=function(t){this._player.onEnded(t)},e.offEnded=function(t){this._player.offEnded(t)},K(t,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(t){this._player.loop=t}},{key:"volume",get:function(){return this._player.volume},set:function(t){this._player.volume=t}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),t}();g4.maxAudioChannel=24;var y4=t("AudioClip",fc("cc.AudioClip")((d4=f4=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_duration",_4,it(e)),e._loadMode=k2.UNKNOWN_AUDIO,e._meta=null,e._player=null,e}Q(e,t);var n=e.prototype;return n.destroy=function(){var e,n=t.prototype.destroy.call(this);return null===(e=this._player)||void 0===e||e.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(t){var e;null===(e=this._player)||void 0===e||e.seek(t).catch((function(){}))},n.setVolume=function(t){this._player&&(this._player.volume=t)},n.setLoop=function(t){this._player&&(this._player.loop=t)},n.play=function(){var t;null===(t=this._player)||void 0===t||t.play().catch((function(){}))},n.pause=function(){var t;null===(t=this._player)||void 0===t||t.pause().catch((function(){}))},n.stop=function(){var t;null===(t=this._player)||void 0===t||t.stop().catch((function(){}))},n.playOneShot=function(t){void 0===t&&(t=1),this._nativeAsset&&g4.loadOneShotAudio(this._nativeAsset.url,t).then((function(t){t.play()})).catch((function(){}))},K(e,[{key:"_nativeAsset",get:function(){return this._meta},set:function(t){this._meta=t,t?(this._loadMode=t.type,this._player=t.player):(this._meta=null,this._loadMode=k2.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:G2.INIT}}]),e}(Ru),f4.AudioType=k2,_4=st((h4=d4).prototype,"_duration",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),st(h4.prototype,"_nativeDep",[il],Object.getOwnPropertyDescriptor(h4.prototype,"_nativeDep"),h4.prototype),u4=h4))||u4);function x4(t,e,n){g4.load(t,{audioLoadMode:e.audioLoadMode}).then((function(e){var i={player:e,url:t,duration:e.duration,type:e.type};n(null,i)})).catch((function(t){n(t)}))}function S4(t,e,n,i){var r=new y4;r._nativeUrl=t,r._nativeAsset=e,r._duration=e.duration,i(null,r)}c.AudioClip=y4,PO.register({".mp3":x4,".ogg":x4,".wav":x4,".m4a":x4}),NO.register({".mp3":S4,".ogg":S4,".wav":S4,".m4a":S4});var A4,C4,b4,T4,E4,w4,P4,I4,R4,D4,M4,B4,O4,N4,L4,F4,z4,V4,k4,G4=new(function(){function t(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var e=t.prototype;return e._findIndex=function(t,e){return t.findIndex((function(t){return t.audio===e}))},e._tryAddPlaying=function(t,e){var n=this._findIndex(t,e);return n>-1?(t[n].playTime=performance.now(),!1):(t.push({audio:e,playTime:performance.now()}),!0)},e.addPlaying=function(t){if(t instanceof g4){if(this._tryAddPlaying(this._audioPlayerInfoList,t))return}else this._tryAddPlaying(this._oneShotAudioInfoList,t)},e._tryRemovePlaying=function(t,e){var n=this._findIndex(t,e);return-1!==n&&(ut(t,n),!0)},e.removePlaying=function(t){if(t instanceof g4){if(this._tryRemovePlaying(this._audioPlayerInfoList,t))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,t)},e.discardOnePlayingIfNeeded=function(){var t;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<g4.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio)))},t}());!function(t){t.STARTED="started",t.ENDED="ended"}(k4||(k4={}));var U4=function(e){return t({AudioSource:e,AudioSourceComponent:e}),e}((A4=fc("cc.AudioSource"),C4=Ic(),b4=Tc(),T4=Xc(y4),E4=Xc(y4),w4=Oc(),P4=Oc(),I4=Oc(),R4=Nc(),D4=Oc(),A4(M4=C4(M4=b4((V4=z4=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_clip",O4,it(e)),e._player=null,at(e,"_loop",N4,it(e)),at(e,"_playOnAwake",L4,it(e)),at(e,"_volume",F4,it(e)),e._cachedCurrentTime=0,e._operationsBeforeLoading=[],e._isLoaded=!1,e._lastSetClip=null,e}Q(e,t);var n=e.prototype;return n._syncPlayer=function(){var t=this,e=this._clip;this._isLoaded=!1,this._lastSetClip!==e&&(e?e._nativeAsset?(this._lastSetClip=e,g4.load(e._nativeAsset.url,{audioLoadMode:e.loadMode}).then((function(n){t._lastSetClip===e?(t._isLoaded=!0,t._player&&(t._player.offEnded(),t._player.offInterruptionBegin(),t._player.offInterruptionEnd(),t._player.destroy()),t._player=n,n.onEnded((function(){G4.removePlaying(n),t.node.emit(k4.ENDED,t)})),n.onInterruptionBegin((function(){G4.removePlaying(n)})),n.onInterruptionEnd((function(){G4.addPlaying(n)})),t._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var t=this._getRootNode();(null==t?void 0:t._persistNode)||this.pause()},n.onDestroy=function(){var t;this.stop(),null===(t=this._player)||void 0===t||t.destroy(),this._player=null},n._getRootNode=function(){for(var t,e,n=this.node,i=null===(t=n)||void 0===t||null===(e=t.parent)||void 0===e?void 0:e.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var t,e,n=this;this._isLoaded?(G4.discardOnePlayingIfNeeded(),this.state===G2.PLAYING&&(null===(e=this._player)||void 0===e||e.stop().catch((function(){}))),null===(t=this._player)||void 0===t||t.play().then((function(){G4.addPlaying(n._player),n.node.emit(k4.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.pause().then((function(){G4.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.stop().then((function(){G4.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(t,e){void 0===e&&(e=1),t._nativeAsset?g4.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((function(t){G4.discardOnePlayingIfNeeded(),t.onPlay=function(){G4.addPlaying(t)},t.onEnd=function(){G4.removePlaying(t)},t.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var t=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){t._player&&(t._player.loop=t._loop,t._player.volume=t._volume,t._operationsBeforeLoading.forEach((function(e){var n;null===(n=t[e])||void 0===n||n.call(t)})),t._operationsBeforeLoading.length=0)})).catch((function(){}))},K(e,[{key:"clip",get:function(){return this._clip},set:function(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._player&&(this._player.loop=t)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(t){this._playOnAwake=t}},{key:"volume",get:function(){return this._volume},set:function(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=sn(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(t){var e;Number.isNaN(t)?console.warn("illegal audio time!"):(t=sn(t,0,this.duration),this._cachedCurrentTime=t,null===(e=this._player)||void 0===e||e.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var t,e;return null!==(t=null===(e=this._clip)||void 0===e?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:G2.INIT}},{key:"playing",get:function(){return this.state===e.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return g4.maxAudioChannel}}]),e}(Qu),z4.AudioState=G2,z4.EventType=k4,O4=st((B4=V4).prototype,"_clip",[T4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N4=st(B4.prototype,"_loop",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),L4=st(B4.prototype,"_playOnAwake",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),F4=st(B4.prototype,"_volume",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),st(B4.prototype,"clip",[E4,w4],Object.getOwnPropertyDescriptor(B4.prototype,"clip"),B4.prototype),st(B4.prototype,"loop",[P4],Object.getOwnPropertyDescriptor(B4.prototype,"loop"),B4.prototype),st(B4.prototype,"playOnAwake",[I4],Object.getOwnPropertyDescriptor(B4.prototype,"playOnAwake"),B4.prototype),st(B4.prototype,"volume",[R4,D4],Object.getOwnPropertyDescriptor(B4.prototype,"volume"),B4.prototype),M4=B4))||M4)||M4)||M4));z(y4,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:U4,targetName:"AudioSource"}]),k(y4.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(t){return{name:t,suggest:"please use AudioSource.prototype."+t+" instead"}}))),c.AudioSourceComponent=U4,ne.setClassAlias(U4,"cc.AudioSourceComponent"),c.log=g,c.warn=y,c.error=x,c.assert=S,c._throw=b,c.logID=w,c.warnID=I,c.errorID=D,c.assertID=O,c.debug=j,c.path={join:vu,extname:gu,mainFileName:yu,basename:xu,dirname:Su,changeExtname:Au,changeBasename:Cu,_normalize:bu,stripSep:Tu,get sep(){return Eu()}};var H4=t("NodePool",function(){function t(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}var e=t.prototype;return e.size=function(){return this._pool.length},e.clear=function(){for(var t=this._pool.length,e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0},e.put=function(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();var e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}},e.get=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},t}());c.NodePool=H4,c.renderer=vK;var j4,W4=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSet=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,n=e.bindings,i=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)if(t[e].type&$r){var n=this._buffers[e];n&&(t[e].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else t[e].type&to&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},K(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(yo);!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.SRGB_EXT=35904]="SRGB_EXT",t[t.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",t[t.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(j4||(j4={}));var q4=function(){function t(){}return t.setInstance=function(e){t._instance=e},K(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();function X4(t,e){switch(t){case _i.R8:return e.UNSIGNED_BYTE;case _i.R8SN:return e.BYTE;case _i.R8UI:return e.UNSIGNED_BYTE;case _i.R8I:return e.BYTE;case _i.R16F:return j4.HALF_FLOAT_OES;case _i.R16UI:return e.UNSIGNED_SHORT;case _i.R16I:return e.SHORT;case _i.R32F:return e.FLOAT;case _i.R32UI:return e.UNSIGNED_INT;case _i.R32I:return e.INT;case _i.RG8:return e.UNSIGNED_BYTE;case _i.RG8SN:return e.BYTE;case _i.RG8UI:return e.UNSIGNED_BYTE;case _i.RG8I:return e.BYTE;case _i.RG16F:return j4.HALF_FLOAT_OES;case _i.RG16UI:return e.UNSIGNED_SHORT;case _i.RG16I:return e.SHORT;case _i.RG32F:return e.FLOAT;case _i.RG32UI:return e.UNSIGNED_INT;case _i.RG32I:return e.INT;case _i.RGB8:case _i.SRGB8:return e.UNSIGNED_BYTE;case _i.RGB8SN:return e.BYTE;case _i.RGB8UI:return e.UNSIGNED_BYTE;case _i.RGB8I:return e.BYTE;case _i.RGB16F:return j4.HALF_FLOAT_OES;case _i.RGB16UI:return e.UNSIGNED_SHORT;case _i.RGB16I:return e.SHORT;case _i.RGB32F:return e.FLOAT;case _i.RGB32UI:return e.UNSIGNED_INT;case _i.RGB32I:return e.INT;case _i.BGRA8:case _i.RGBA8:case _i.SRGB8_A8:return e.UNSIGNED_BYTE;case _i.RGBA8SN:return e.BYTE;case _i.RGBA8UI:return e.UNSIGNED_BYTE;case _i.RGBA8I:return e.BYTE;case _i.RGBA16F:return j4.HALF_FLOAT_OES;case _i.RGBA16UI:return e.UNSIGNED_SHORT;case _i.RGBA16I:return e.SHORT;case _i.RGBA32F:return e.FLOAT;case _i.RGBA32UI:return e.UNSIGNED_INT;case _i.RGBA32I:return e.INT;case _i.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case _i.R11G11B10F:return e.FLOAT;case _i.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case _i.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case _i.RGB10A2:return e.UNSIGNED_BYTE;case _i.RGB10A2UI:return e.UNSIGNED_INT;case _i.RGB9E5:return e.UNSIGNED_BYTE;case _i.DEPTH:return e.UNSIGNED_INT;case _i.DEPTH_STENCIL:return j4.UNSIGNED_INT_24_8_WEBGL;case _i.BC1:case _i.BC1_SRGB:case _i.BC2:case _i.BC2_SRGB:case _i.BC3:case _i.BC3_SRGB:case _i.BC4:return e.UNSIGNED_BYTE;case _i.BC4_SNORM:return e.BYTE;case _i.BC5:return e.UNSIGNED_BYTE;case _i.BC5_SNORM:return e.BYTE;case _i.BC6H_SF16:case _i.BC6H_UF16:return e.FLOAT;case _i.BC7:case _i.BC7_SRGB:case _i.ETC_RGB8:case _i.ETC2_RGB8:case _i.ETC2_SRGB8:case _i.ETC2_RGB8_A1:case _i.ETC2_SRGB8_A1:case _i.EAC_R11:return e.UNSIGNED_BYTE;case _i.EAC_R11SN:return e.BYTE;case _i.EAC_RG11:return e.UNSIGNED_BYTE;case _i.EAC_RG11SN:return e.BYTE;case _i.PVRTC_RGB2:case _i.PVRTC_RGBA2:case _i.PVRTC_RGB4:case _i.PVRTC_RGBA4:case _i.PVRTC2_2BPP:case _i.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case _i.ASTC_RGBA_4X4:case _i.ASTC_RGBA_5X4:case _i.ASTC_RGBA_5X5:case _i.ASTC_RGBA_6X5:case _i.ASTC_RGBA_6X6:case _i.ASTC_RGBA_8X5:case _i.ASTC_RGBA_8X6:case _i.ASTC_RGBA_8X8:case _i.ASTC_RGBA_10X5:case _i.ASTC_RGBA_10X6:case _i.ASTC_RGBA_10X8:case _i.ASTC_RGBA_10X10:case _i.ASTC_RGBA_12X10:case _i.ASTC_RGBA_12X12:case _i.ASTC_SRGBA_4X4:case _i.ASTC_SRGBA_5X4:case _i.ASTC_SRGBA_5X5:case _i.ASTC_SRGBA_6X5:case _i.ASTC_SRGBA_6X6:case _i.ASTC_SRGBA_8X5:case _i.ASTC_SRGBA_8X6:case _i.ASTC_SRGBA_8X8:case _i.ASTC_SRGBA_10X5:case _i.ASTC_SRGBA_10X6:case _i.ASTC_SRGBA_10X8:case _i.ASTC_SRGBA_10X10:case _i.ASTC_SRGBA_12X10:case _i.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function Y4(t,e){switch(t){case di.BOOL:return e.BOOL;case di.BOOL2:return e.BOOL_VEC2;case di.BOOL3:return e.BOOL_VEC3;case di.BOOL4:return e.BOOL_VEC4;case di.INT:return e.INT;case di.INT2:return e.INT_VEC2;case di.INT3:return e.INT_VEC3;case di.INT4:return e.INT_VEC4;case di.UINT:return e.UNSIGNED_INT;case di.FLOAT:return e.FLOAT;case di.FLOAT2:return e.FLOAT_VEC2;case di.FLOAT3:return e.FLOAT_VEC3;case di.FLOAT4:return e.FLOAT_VEC4;case di.MAT2:return e.FLOAT_MAT2;case di.MAT3:return e.FLOAT_MAT3;case di.MAT4:return e.FLOAT_MAT4;case di.SAMPLER2D:return e.SAMPLER_2D;case di.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),di.UNKNOWN}}function K4(t){switch(t){case di.BOOL:case di.BOOL2:case di.BOOL3:case di.BOOL4:case di.INT:case di.INT2:case di.INT3:case di.INT4:case di.UINT:return Int32Array;case di.FLOAT:case di.FLOAT2:case di.FLOAT3:case di.FLOAT4:case di.MAT2:case di.MAT3:case di.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function J4(t,e){switch(t){case e.BOOL:return di.BOOL;case e.BOOL_VEC2:return di.BOOL2;case e.BOOL_VEC3:return di.BOOL3;case e.BOOL_VEC4:return di.BOOL4;case e.INT:return di.INT;case e.INT_VEC2:return di.INT2;case e.INT_VEC3:return di.INT3;case e.INT_VEC4:return di.INT4;case e.UNSIGNED_INT:return di.UINT;case e.FLOAT:return di.FLOAT;case e.FLOAT_VEC2:return di.FLOAT2;case e.FLOAT_VEC3:return di.FLOAT3;case e.FLOAT_VEC4:return di.FLOAT4;case e.FLOAT_MAT2:return di.MAT2;case e.FLOAT_MAT3:return di.MAT3;case e.FLOAT_MAT4:return di.MAT4;case e.SAMPLER_2D:return di.SAMPLER2D;case e.SAMPLER_CUBE:return di.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),di.UNKNOWN}}function Q4(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Z4(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}q4._instance=null;var $4,t3=[512,513,514,515,516,517,518,519],e3=[0,7680,7681,7682,7683,5386,34055,34056],n3=[32774,32778,32779,32775,32776],i3=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}($4||($4={}));var r3=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},o3=function(t){function e(){var e;return(e=t.call(this,$4.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new $i,e.clearFlag=Xi.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return Q(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(r3),a3=function(t){function e(){var e;return(e=t.call(this,$4.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new Jr,e}return Q(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},e}(r3),s3=function(t){function e(){var e;return(e=t.call(this,$4.DRAW)||this).drawInfo=new fr,e}return Q(e,t),e.prototype.clear=function(){},e}(r3),c3=function(t){function e(){var e;return(e=t.call(this,$4.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return Q(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(r3),l3=function(t){function e(){var e;return(e=t.call(this,$4.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return Q(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(r3),u3=function(){function t(){this.cmds=new jl(1),this.beginRenderPassCmds=new jl(1),this.bindStatesCmds=new jl(1),this.drawCmds=new jl(1),this.updateBufferCmds=new jl(1),this.copyBufferToTextureCmds=new jl(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function h3(t,e,n,i,r){if(e.usage&pi.UNIFORM)ArrayBuffer.isView(n)?e.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&pi.INDIRECT){e.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)e.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=t.gl,l=t.stateCache;switch(e.glTarget){case c.ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),_3.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),_3.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r))}}var _3={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function f3(t,e,n,i,r,o,a){var s=t.gl,c=t.stateCache,l=0;if(n&&e){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;t.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=e.colorAttachments[h];if(_.format!==_i.UNKNOWN)switch(_.loadOp){case Mi.LOAD:break;case Mi.CLEAR:c.bs.targets[0].blendColorMask!==Ri.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case Mi.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==_i.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Mi.LOAD:break;case Mi.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Mi.DISCARD:}if(Zr[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Mi.LOAD:break;case Mi.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Mi.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var d=c.bs.targets[0].blendColorMask;if(d!==Ri.ALL){var p=(d&Ri.R)!==Ri.NONE,m=(d&Ri.G)!==Ri.NONE,v=(d&Ri.B)!==Ri.NONE,g=(d&Ri.A)!==Ri.NONE;s.colorMask(p,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function d3(t,e,n,i,r,o){var a,s,c,l=t.gl,u=t.stateCache,h=e&&e.gpuShader,_=!1;if(e&&_3.gpuPipelineState!==e){if(_3.gpuPipelineState=e,_3.glPrimitive=e.glPrimitive,e.gpuShader){var f=e.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var d=e.rs;if(d){if(u.rs.cullMode!==d.cullMode){switch(d.cullMode){case ki.NONE:l.disable(l.CULL_FACE);break;case ki.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case ki.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=d.cullMode}var p=d.isFrontFaceCCW;u.rs.isFrontFaceCCW!==p&&(l.frontFace(p?l.CCW:l.CW),u.rs.isFrontFaceCCW=p),u.rs.depthBias===d.depthBias&&u.rs.depthBiasSlop===d.depthBiasSlop||(l.polygonOffset(d.depthBias,d.depthBiasSlop),u.rs.depthBias=d.depthBias,u.rs.depthBiasSlop=d.depthBiasSlop),u.rs.lineWidth!==d.lineWidth&&(l.lineWidth(d.lineWidth),u.rs.lineWidth=d.lineWidth)}var m=e.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(t3[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,t3[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,e3[m.stencilFailOpFront],e3[m.stencilZFailOpFront],e3[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,t3[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,e3[m.stencilFailOpBack],e3[m.stencilZFailOpBack],e3[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=e.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(n3[g.blendEq],n3[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(i3[g.blendSrc],i3[g.blendDst],i3[g.blendSrcAlpha],i3[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&Ri.R)!==Ri.NONE,(g.blendColorMask&Ri.G)!==Ri.NONE,(g.blendColorMask&Ri.B)!==Ri.NONE,(g.blendColorMask&Ri.A)!==Ri.NONE),y.blendColorMask=g.blendColorMask)}}if(e&&e.gpuPipelineLayout&&h){for(var S=h.glBlocks.length,A=e.gpuPipelineLayout.dynamicOffsetIndices,C=0;C<S;C++){var b=h.glBlocks[C],T=i[b.set],E=T&&T.descriptorIndices[b.binding],w=E>=0&&T.gpuDescriptors[E],P=null,I=0;if(w&&w.gpuBuffer){var R=w.gpuBuffer,D=A[b.set],M=D&&D[b.binding];M>=0&&(I=r[M]),"vf32"in R?P=R.vf32:(I+=R.offset,P=R.gpuBuffer.vf32),I>>=2}if(P)for(var B=b.glActiveUniforms.length,O=0;O<B;O++){var N=b.glActiveUniforms[O];switch(N.glType){case l.BOOL:case l.INT:for(var L=0;L<N.array.length;++L){var F=N.offset+I+L;if(P[F]!==N.array[L]){for(var z=L,V=F;z<N.array.length;++z,++V)N.array[z]=P[V];l.uniform1iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var k=0;k<N.array.length;++k){var G=N.offset+I+k;if(P[G]!==N.array[k]){for(var U=k,H=G;U<N.array.length;++U,++H)N.array[U]=P[H];l.uniform2iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<N.array.length;++j){var W=N.offset+I+j;if(P[W]!==N.array[j]){for(var q=j,X=W;q<N.array.length;++q,++X)N.array[q]=P[X];l.uniform3iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<N.array.length;++Y){var K=N.offset+I+Y;if(P[K]!==N.array[Y]){for(var J=Y,Q=K;J<N.array.length;++J,++Q)N.array[J]=P[Q];l.uniform4iv(N.glLoc,N.array);break}}break;case l.FLOAT:for(var Z=0;Z<N.array.length;++Z){var $=N.offset+I+Z;if(P[$]!==N.array[Z]){for(var tt=Z,et=$;tt<N.array.length;++tt,++et)N.array[tt]=P[et];l.uniform1fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC2:for(var nt=0;nt<N.array.length;++nt){var it=N.offset+I+nt;if(P[it]!==N.array[nt]){for(var rt=nt,ot=it;rt<N.array.length;++rt,++ot)N.array[rt]=P[ot];l.uniform2fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC3:for(var at=0;at<N.array.length;++at){var st=N.offset+I+at;if(P[st]!==N.array[at]){for(var ct=at,lt=st;ct<N.array.length;++ct,++lt)N.array[ct]=P[lt];l.uniform3fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC4:for(var ut=0;ut<N.array.length;++ut){var ht=N.offset+I+ut;if(P[ht]!==N.array[ut]){for(var _t=ut,ft=ht;_t<N.array.length;++_t,++ft)N.array[_t]=P[ft];l.uniform4fv(N.glLoc,N.array);break}}break;case l.FLOAT_MAT2:for(var dt=0;dt<N.array.length;++dt){var pt=N.offset+I+dt;if(P[pt]!==N.array[dt]){for(var mt=dt,vt=pt;mt<N.array.length;++mt,++vt)N.array[mt]=P[vt];l.uniformMatrix2fv(N.glLoc,!1,N.array);break}}break;case l.FLOAT_MAT3:for(var gt=0;gt<N.array.length;++gt){var yt=N.offset+I+gt;if(P[yt]!==N.array[gt]){for(var xt=gt,St=yt;xt<N.array.length;++xt,++St)N.array[xt]=P[St];l.uniformMatrix3fv(N.glLoc,!1,N.array);break}}break;case l.FLOAT_MAT4:for(var At=0;At<N.array.length;++At){var Ct=N.offset+I+At;if(P[Ct]!==N.array[At]){for(var bt=At,Tt=Ct;bt<N.array.length;++bt,++Tt)N.array[bt]=P[Tt];l.uniformMatrix4fv(N.glLoc,!1,N.array);break}}}}else x("Buffer binding '"+b.name+"' at set "+b.set+" binding "+b.binding+" is not bounded")}for(var Et=h.glSamplerTextures.length,wt=0;wt<Et;wt++)for(var Pt=h.glSamplerTextures[wt],It=i[Pt.set],Rt=It&&It.descriptorIndices[Pt.binding],Dt=Rt>=0&&It.gpuDescriptors[Rt],Mt=Pt.units.length,Bt=0;Bt<Mt;Bt++){var Ot=Pt.units[Bt];if(Dt&&Dt.gpuSampler){if(Dt.gpuTexture&&Dt.gpuTexture.size>0){var Nt=Dt.gpuTexture,Lt=u.glTexUnits[Ot];Lt.glTexture!==Nt.glTexture&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),Nt.glTexture?l.bindTexture(Nt.glTarget,Nt.glTexture):l.bindTexture(Nt.glTarget,t.nullTex2D.gpuTexture.glTexture),Lt.glTexture=Nt.glTexture);var Ft=Dt.gpuSampler;Nt.isPowerOf2?(a=Ft.glWrapS,s=Ft.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Nt.isPowerOf2?Nt.mipLevel<=1&&(Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Ft.glMinFilter:Ft.glMinFilter===l.LINEAR||Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Nt.glWrapS!==a&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_WRAP_S,a),Nt.glWrapS=a),Nt.glWrapT!==s&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_WRAP_T,s),Nt.glWrapT=s),Nt.glMinFilter!==c&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_MIN_FILTER,c),Nt.glMinFilter=c),Nt.glMagFilter!==Ft.glMagFilter&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_MAG_FILTER,Ft.glMagFilter),Nt.glMagFilter=Ft.glMagFilter)}Dt=It.gpuDescriptors[++Rt]}else x("Sampler binding '"+Pt.name+"' at set "+Pt.set+" binding "+Pt.binding+" index "+Bt+" is not bounded")}}if(n&&h&&(_||_3.gpuInputAssembler!==n)){_3.gpuInputAssembler=n;var zt=t.extensions.ANGLE_instanced_arrays;if(t.extensions.useVAO){var Vt=t.extensions.OES_vertex_array_object,kt=n.glVAOs.get(h.glProgram);if(!kt){var Gt;kt=Vt.createVertexArrayOES(),n.glVAOs.set(h.glProgram,kt),Vt.bindVertexArrayOES(kt),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var Ut=h.glInputs.length,Ht=0;Ht<Ut;Ht++){var jt=h.glInputs[Ht];Gt=null;for(var Wt=n.glAttribs.length,qt=0;qt<Wt;qt++){var Xt=n.glAttribs[qt];if(Xt.name===jt.name){Gt=Xt;break}}if(Gt){u.glArrayBuffer!==Gt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Gt.glBuffer),u.glArrayBuffer=Gt.glBuffer);for(var Yt=0;Yt<Gt.componentCount;++Yt){var Kt=jt.glLoc+Yt,Jt=Gt.offset+Gt.size*Yt;l.enableVertexAttribArray(Kt),u.glCurrentAttribLocs[Kt]=!0,l.vertexAttribPointer(Kt,Gt.count,Gt.glType,Gt.isNormalized,Gt.stride,Jt),zt&&zt.vertexAttribDivisorANGLE(Kt,Gt.isInstanced?1:0)}}}var Qt=n.gpuIndexBuffer;Qt&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Qt.glBuffer),Vt.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==kt&&(Vt.bindVertexArrayOES(kt),u.glVAO=kt)}else{for(var Zt=0;Zt<t.capabilities.maxVertexAttributes;++Zt)u.glCurrentAttribLocs[Zt]=!1;for(var $t=h.glInputs.length,te=0;te<$t;te++){for(var ee=h.glInputs[te],ne=null,ie=n.glAttribs.length,re=0;re<ie;re++){var oe=n.glAttribs[re];if(oe.name===ee.name){ne=oe;break}}if(ne){u.glArrayBuffer!==ne.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,ne.glBuffer),u.glArrayBuffer=ne.glBuffer);for(var ae=0;ae<ne.componentCount;++ae){var se=ee.glLoc+ae,ce=ne.offset+ne.size*ae;!u.glEnabledAttribLocs[se]&&se>=0&&(l.enableVertexAttribArray(se),u.glEnabledAttribLocs[se]=!0),u.glCurrentAttribLocs[se]=!0,l.vertexAttribPointer(se,ne.count,ne.glType,ne.isNormalized,ne.stride,ce),zt&&zt.vertexAttribDivisorANGLE(se,ne.isInstanced?1:0)}}}var le=n.gpuIndexBuffer;le&&u.glElementArrayBuffer!==le.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,le.glBuffer),u.glElementArrayBuffer=le.glBuffer);for(var ue=0;ue<t.capabilities.maxVertexAttributes;++ue)u.glEnabledAttribLocs[ue]!==u.glCurrentAttribLocs[ue]&&(l.disableVertexAttribArray(ue),u.glEnabledAttribLocs[ue]=!1)}}if(e&&e.dynamicStates.length)for(var he=e.dynamicStates.length,_e=0;_e<he;_e++)switch(e.dynamicStates[_e]){case Gi.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case Gi.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case Gi.BLEND_CONSTANTS:var fe=o.blendConstant;u.bs.blendColor.x===fe.x&&u.bs.blendColor.y===fe.y&&u.bs.blendColor.z===fe.z&&u.bs.blendColor.w===fe.w||(l.blendColor(fe.x,fe.y,fe.z,fe.w),u.bs.blendColor.copy(fe));break;case Gi.STENCIL_WRITE_MASK:var de=o.stencilStatesFront,pe=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==de.writeMask&&(l.stencilMaskSeparate(l.FRONT,de.writeMask),u.dss.stencilWriteMaskFront=de.writeMask),u.dss.stencilWriteMaskBack!==pe.writeMask&&(l.stencilMaskSeparate(l.BACK,pe.writeMask),u.dss.stencilWriteMaskBack=pe.writeMask);break;case Gi.STENCIL_COMPARE_MASK:var me=o.stencilStatesFront,ve=o.stencilStatesBack;u.dss.stencilRefFront===me.reference&&u.dss.stencilReadMaskFront===me.compareMask||(l.stencilFuncSeparate(l.FRONT,t3[u.dss.stencilFuncFront],me.reference,me.compareMask),u.dss.stencilRefFront=me.reference,u.dss.stencilReadMaskFront=me.compareMask),u.dss.stencilRefBack===ve.reference&&u.dss.stencilReadMaskBack===ve.compareMask||(l.stencilFuncSeparate(l.BACK,t3[u.dss.stencilFuncBack],ve.reference,ve.compareMask),u.dss.stencilRefBack=ve.reference,u.dss.stencilReadMaskBack=ve.compareMask)}}function p3(t,e){var n=t.gl,i=t.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=_3.gpuInputAssembler,s=_3.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):n.drawArrays(s,l.offsets[_],l.counts[_])}else if(e.instanceCount&&r)if(c){if(e.indexCount>0){var f=e.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,e.indexCount,a.glIndexType,f,e.instanceCount)}}else e.vertexCount>0&&r.drawArraysInstancedANGLE(s,e.firstVertex,e.vertexCount,e.instanceCount);else if(c){if(e.indexCount>0){var d=e.firstIndex*c.stride;n.drawElements(s,e.indexCount,a.glIndexType,d)}}else e.vertexCount>0&&n.drawArrays(s,e.firstVertex,e.vertexCount)}}var m3=new Array($4.COUNT);function v3(t,e){m3.fill(0);for(var n=0;n<e.cmds.length;++n){var i=e.cmds.array[n],r=m3[i]++;switch(i){case $4.BEGIN_RENDER_PASS:var o=e.beginRenderPassCmds.array[r];f3(t,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case $4.BIND_STATES:var a=e.bindStatesCmds.array[r];d3(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case $4.DRAW:p3(t,e.drawCmds.array[r].drawInfo);break;case $4.UPDATE_BUFFER:var s=e.updateBufferCmds.array[r];h3(t,s.gpuBuffer,s.buffer,s.offset,s.size);break;case $4.COPY_BUFFER_TO_TEXTURE:var c=e.copyBufferToTextureCmds.array[r];g3(t,c.buffers,c.gpuTexture,c.regions)}}}function g3(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=Zr[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=e[a++];u?n.glInternalFmt===j4.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=e[a++];u?n.glInternalFmt===j4.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Si.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var y3=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=r(t);var e=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=e,this.offsets=n,this.instances=i}},t}(),x3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuBuffer=null,e._gpuBufferView=null,e._uniformBuffer=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&pi.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new y3,glTarget:0,glBuffer:null},this._usage&pi.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&gi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&pi.VERTEX){e.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),_3.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&pi.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),_3.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&pi.UNIFORM?(e.glTarget=n.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&pi.INDIRECT||e.usage&pi.TRANSFER_DST||e.usage&pi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(q4.instance,this._gpuBuffer),q4.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(t,e){var n=t.gl,i=t.stateCache;if(e.glBuffer){switch(e.glTarget){case n.ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),_3.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),_3.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null}n.deleteBuffer(e.glBuffer),e.glBuffer=null}}(q4.instance,this._gpuBuffer),q4.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&gi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&pi.VERTEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),_3.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&pi.INDEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),_3.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&pi.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&pi.INDIRECT||e.usage&pi.TRANSFER_DST||e.usage&pi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(q4.instance,this._gpuBuffer),q4.instance.memoryStatus.bufferSize-=e,q4.instance.memoryStatus.bufferSize+=t)))}},n.update=function(t,e){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==e?e:this._usage&pi.INDIRECT?0:t.byteLength,h3(q4.instance,this._gpuBuffer,t,0,n))},K(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),e}(lo),S3=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new jl(e);for(var n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,n=this._frees;this._frees=new Array(e);for(var i=e-n.length,r=0;r<i;++r)this._frees[r]=new t;for(var o=i,a=0;o<e;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),A3=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new S3(o3,1),this.bindStatesCmdPool=new S3(a3,1),this.drawCmdPool=new S3(s3,1),this.updateBufferCmdPool=new S3(c3,1),this.copyBufferToTextureCmdPool=new S3(l3,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),C3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).cmdPackage=new u3,e._cmdAllocator=new A3,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUInputAssembler=null,e._curGPUDescriptorSets=[],e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new Jr,e._isStateInvalied=!1,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=q4.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<e;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(t,e,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(o3);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=n,a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push($4.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},n.bindDescriptorSet=function(t,e,n){var i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[t],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},n.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},n.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},n.setDepthBias=function(t,e,n){var i=this._curDynamicStates;i.depthBiasConstant===t&&i.depthBiasClamp===e&&i.depthBiasSlope===n||(i.depthBiasConstant=t,i.depthBiasClamp=e,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},n.setDepthBound=function(t,e){var n=this._curDynamicStates;n.depthMinBounds===t&&n.depthMaxBounds===e||(n.depthMinBounds=t,n.depthMaxBounds=e,this._isStateInvalied=!0)},n.setStencilWriteMask=function(t,e){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;t&Ui.FRONT&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0),t&Ui.BACK&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0)},n.setStencilCompareMask=function(t,e,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&Ui.FRONT&&(i.compareMask===n&&i.reference===e||(i.reference=e,i.compareMask=n,this._isStateInvalied=!0)),t&Ui.BACK&&(r.compareMask===n&&r.reference===e||(r.reference=e,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(t){if(this._type===qi.PRIMARY&&this._isInRenderPass||this._type===qi.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,n=this._cmdAllocator.drawCmdPool.alloc(s3);n.drawInfo.copy(e),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push($4.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(t,e,n){if(this._type===qi.PRIMARY&&!this._isInRenderPass||this._type===qi.SECONDARY){var i=t.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(c3),a=0;t.usage&pi.INDIRECT||(a=void 0!==n?n:e.byteLength),r=e,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push($4.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(t,e,n){if(this._type===qi.PRIMARY&&!this._isInRenderPass||this._type===qi.SECONDARY){var i=e.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(l3);r&&(r.gpuTexture=i,r.regions=n,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push($4.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(t,e){for(var n=0;n<e;++n){for(var i=t[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(a3);t&&(t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push($4.BIND_STATES),this._isStateInvalied=!1)},e}(uo),b3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuFramebuffer=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=[],n=0;n<t.colorTextures.length;++n){var i=t.colorTextures[n];i&&e.push(i.gpuTexture)}var r=null;t.depthStencilTexture&&(r=t.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(t){o=t},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(t){a=t}},function(t,e){for(var n=0;n<e.gpuColorTextures.length;++n)if(e.gpuColorTextures[n].isSwapchainTexture)return void(e.isOffscreen=!1);var i=t.gl,r=[],o=i.createFramebuffer();if(o){e.glFramebuffer=o,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var s=e.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}var c=e.gpuDepthStencilTexture;if(c){var l=Zr[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),e.width=Math.min(e.width,c.width),e.height=Math.min(e.height,c.height)}t.extensions.WEBGL_draw_buffers&&t.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(q4.instance,this._gpuFramebuffer)},n.destroy=function(){var t,e;this._gpuFramebuffer&&(t=q4.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},K(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(fo),T3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuInputAssembler=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var n=new Array(t.vertexBuffers.length),i=0;i<t.vertexBuffers.length;++i){var r=t.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(t.indexBuffer&&(o=t.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var n=t.gl;e.glAttribs=new Array(e.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var o=e.attributes[r],a=void 0!==o.stream?o.stream:0,s=e.gpuVertexBuffers[a],c=X4(o.format,n),l=Zr[o.format].size;e.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:Zr[o.format].count,stride:s.stride,componentCount:Z4(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(q4.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var t=q4.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var n=e.glVAOs.values(),i=n.next(),r=t.extensions.OES_vertex_array_object,o=t.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),o===i.value&&(r.bindVertexArrayOES(null),o=null),i=n.next();t.stateCache.glVAO=o,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},K(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(go),E3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSetLayout=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(e),e+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&eo)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:e}},n.destroy=function(){this._bindings.length=0},K(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(xo),w3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineLayout=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),e.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},K(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(So),P3=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],I3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineState=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var n=t.blendState,i=n.targets;i&&i.forEach((function(t,n){e.setTarget(n,t)})),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:P3[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},K(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(wo),R3=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.beginRenderPass=function(t,e,n,i,r,o){f3(q4.instance,t.gpuRenderPass,e.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;p3(q4.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(t){var e=q4.instance,n=e.stateCache,i=e.gl;n.viewport.left===t.left&&n.viewport.top===t.top&&n.viewport.width===t.width&&n.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),n.viewport.left=t.left,n.viewport.top=t.top,n.viewport.width=t.width,n.viewport.height=t.height)},n.setScissor=function(t){var e=q4.instance,n=e.stateCache,i=e.gl;n.scissorRect.x===t.x&&n.scissorRect.y===t.y&&n.scissorRect.width===t.width&&n.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),n.scissorRect.x=t.x,n.scissorRect.y=t.y,n.scissorRect.width=t.width,n.scissorRect.height=t.height)},n.updateBuffer=function(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=t.gpuBuffer;r&&(i=void 0!==n?n:t.usage&pi.INDIRECT?0:e.byteLength,h3(q4.instance,r,e,0,i))}},n.copyBuffersToTexture=function(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=e.gpuTexture;i&&g3(q4.instance,t,i,n)}},n.execute=function(t,e){for(var n=0;n<e;++n){var i=t[n];v3(q4.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){d3(q4.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(C3),D3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type},n.destroy=function(){},n.submit=function(t){for(var e=t.length,n=0;n<e;n++){var i=t[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(Po),M3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuRenderPass=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},K(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(Io),B3=[10497,33648,33071,33071],O3=function(t){function e(e,n){var i;(i=t.call(this,e,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===bi.LINEAR||a===bi.ANISOTROPIC?c===bi.LINEAR||c===bi.ANISOTROPIC?9987:c===bi.POINT?9985:9729:c===bi.LINEAR||c===bi.ANISOTROPIC?9986:c===bi.POINT?9984:9728,o=s===bi.LINEAR||s===bi.ANISOTROPIC?9729:9728;var l=B3[i._info.addressU],u=B3[i._info.addressV],h=B3[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return Q(e,t),K(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(Ro),N3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuShader=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}!function(t,e){for(var n=t.gl,i=function(t){var i=e.gpuStages[t],r=0,o="",a=1;switch(i.type){case Di.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Di.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<e.gpuStages.length;c++){var l=e.gpuStages[t];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){e.glProgram=a;for(var s=0;s<e.gpuStages.length;s++){var c=e.gpuStages[s];n.attachShader(e.glProgram,c.glShader)}if(n.linkProgram(e.glProgram),t.extensions.destroyShadersImmediately)for(var l=0;l<e.gpuStages.length;l++){var u=e.gpuStages[l];u.glShader&&(n.detachShader(e.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(n.getProgramInfoLog(e.glProgram));A("Shader '"+e.name+"' compilation succeeded.");var h=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(e.glProgram,_);if(f){var d,p=f.name.indexOf("[");d=-1!==p?f.name.substr(0,p):f.name;var m=n.getAttribLocation(e.glProgram,d),v=J4(f.type,n),g=Q4(f.type,n);e.glInputs[_]={binding:m,name:d,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(var y=0;y<e.blocks.length;++y){var x=e.blocks[y],S={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};e.glBlocks[y]=S;for(var C=0;C<x.members.length;++C){var b=x.members[C],T=Y4(b.type,n),E=Q4(T,n),w=E*b.count;S.glUniforms[C]={binding:-1,name:b.name,type:b.type,stride:E,count:b.count,size:w,offset:0,glType:T,glLoc:null,array:null}}}}for(var P=0;P<e.subpassInputs.length;++P){var I=e.subpassInputs[P];e.samplerTextures.push(new Sr(I.set,I.binding,I.name,di.SAMPLER2D,I.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var R=0;R<e.samplerTextures.length;++R){var D=e.samplerTextures[R];e.glSamplerTextures[R]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:Y4(D.type,n),glLoc:null}}}for(var M=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORMS),B=0;B<M;++B){var O=n.getActiveUniform(e.glProgram,B);if(O&&O.type!==n.SAMPLER_2D&&O.type!==n.SAMPLER_CUBE){var N=n.getUniformLocation(e.glProgram,O.name);if(t.extensions.isLocationActive(N)){var L,F=O.name.indexOf("[");L=-1!==F?O.name.substr(0,F):O.name;for(var z=0;z<e.glBlocks.length;z++)for(var V=e.glBlocks[z],k=0;k<V.glUniforms.length;k++){var G=V.glUniforms[k];if(G.name===L){G.glLoc=N,G.count=O.size,G.size=G.stride*G.count,G.array=new(K4(G.type))(G.size/4),V.glActiveUniforms.push(G);break}}}}}for(var U=0;U<e.glBlocks.length;U++)for(var H=e.glBlocks[U],j=0;j<H.glUniforms.length;j++){var W=H.glUniforms[j];W.offset=H.size/4,H.size+=W.size}for(var q=[],X=[],Y=t.bindingMappingInfo,K=t.stateCache.texUnitCacheMap,J=0,Q=0;Q<e.blocks.length;++Q)e.blocks[Q].set===Y.flexibleSet&&J++;for(var Z=0,$=0;$<e.samplerTextures.length;++$){var tt=e.samplerTextures[$],et=n.getUniformLocation(e.glProgram,tt.name);if(t.extensions.isLocationActive(et)&&(q.push(e.glSamplerTextures[$]),X.push(et)),void 0===K[tt.name]){var nt=tt.binding+Y.samplerOffsets[tt.set]+Z;tt.set===Y.flexibleSet&&(nt-=J),K[tt.name]=nt%t.capabilities.maxTextureUnits,Z+=tt.count-1}}if(q.length){for(var it=[],rt=0;rt<q.length;++rt){var ot=q[rt],at=K[ot.name];if(void 0!==at){ot.glLoc=X[rt];for(var st=0;st<ot.count;++st){for(;it[at];)at=(at+1)%t.capabilities.maxTextureUnits;ot.units.push(at),it[at]=!0}}}for(var ct=0,lt=0;lt<q.length;++lt){var ut=q[lt];if(!t.extensions.isLocationActive(ut.glLoc)){ut.glLoc=X[lt];for(var ht=0;ht<ut.count;++ht){for(;it[ct];)ct=(ct+1)%t.capabilities.maxTextureUnits;void 0===K[ut.name]&&(K[ut.name]=ct),ut.units.push(ct),it[ct]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(var _t=0;_t<q.length;_t++){var ft=q[_t];ft.glUnits=new Int32Array(ft.units),n.uniform1iv(ft.glLoc,ft.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}for(var dt=0;dt<e.glBlocks.length;)e.glBlocks[dt].glActiveUniforms.length?dt++:(e.glBlocks[dt]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=q}}(q4.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(t,e){if(e.glProgram){var n=t.gl;if(!t.extensions.destroyShadersImmediately)for(var i=0;i<e.gpuStages.length;i++){var r=e.gpuStages[i];r.glShader&&(n.detachShader(e.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null}}(q4.instance,this._gpuShader),this._gpuShader=null)},K(e,[{key:"gpuShader",get:function(){return this._gpuShader}}]),e}(Do),L3=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new ar,this.scissorRect=new $i(0,0,0,0),this.rs=new Ao,this.dss=new Co,this.bs=new To,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e){for(var n=0;n<t;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)},t}(),F3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuTexture=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t,e){"texture"in t?console.log("WebGL does not support texture view."):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=no(this._width)&&no(this._height),this._size=ro(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},function(t,e){var n=t.gl;e.glFormat=e.glInternalFmt=function(t,e){switch(t){case _i.A8:return e.ALPHA;case _i.L8:return e.LUMINANCE;case _i.LA8:return e.LUMINANCE_ALPHA;case _i.RGB8:case _i.RGB16F:case _i.RGB32F:return e.RGB;case _i.BGRA8:case _i.RGBA8:case _i.SRGB8_A8:case _i.RGBA16F:case _i.RGBA32F:return e.RGBA;case _i.R5G6B5:return e.RGB;case _i.RGB5A1:case _i.RGBA4:return e.RGBA;case _i.DEPTH:return e.DEPTH_COMPONENT;case _i.DEPTH_STENCIL:return e.DEPTH_STENCIL;case _i.BC1:return j4.COMPRESSED_RGB_S3TC_DXT1_EXT;case _i.BC1_ALPHA:return j4.COMPRESSED_RGBA_S3TC_DXT1_EXT;case _i.BC1_SRGB:return j4.COMPRESSED_SRGB_S3TC_DXT1_EXT;case _i.BC1_SRGB_ALPHA:return j4.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case _i.BC2:return j4.COMPRESSED_RGBA_S3TC_DXT3_EXT;case _i.BC2_SRGB:return j4.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case _i.BC3:return j4.COMPRESSED_RGBA_S3TC_DXT5_EXT;case _i.BC3_SRGB:return j4.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case _i.ETC_RGB8:return j4.COMPRESSED_RGB_ETC1_WEBGL;case _i.ETC2_RGB8:return j4.COMPRESSED_RGB8_ETC2;case _i.ETC2_SRGB8:return j4.COMPRESSED_SRGB8_ETC2;case _i.ETC2_RGB8_A1:return j4.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_SRGB8_A1:return j4.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_RGBA8:return j4.COMPRESSED_RGBA8_ETC2_EAC;case _i.ETC2_SRGB8_A8:return j4.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case _i.EAC_R11:return j4.COMPRESSED_R11_EAC;case _i.EAC_R11SN:return j4.COMPRESSED_SIGNED_R11_EAC;case _i.EAC_RG11:return j4.COMPRESSED_RG11_EAC;case _i.EAC_RG11SN:return j4.COMPRESSED_SIGNED_RG11_EAC;case _i.PVRTC_RGB2:return j4.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGBA2:return j4.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGB4:return j4.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case _i.PVRTC_RGBA4:return j4.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case _i.ASTC_RGBA_4X4:return j4.COMPRESSED_RGBA_ASTC_4x4_KHR;case _i.ASTC_RGBA_5X4:return j4.COMPRESSED_RGBA_ASTC_5x4_KHR;case _i.ASTC_RGBA_5X5:return j4.COMPRESSED_RGBA_ASTC_5x5_KHR;case _i.ASTC_RGBA_6X5:return j4.COMPRESSED_RGBA_ASTC_6x5_KHR;case _i.ASTC_RGBA_6X6:return j4.COMPRESSED_RGBA_ASTC_6x6_KHR;case _i.ASTC_RGBA_8X5:return j4.COMPRESSED_RGBA_ASTC_8x5_KHR;case _i.ASTC_RGBA_8X6:return j4.COMPRESSED_RGBA_ASTC_8x6_KHR;case _i.ASTC_RGBA_8X8:return j4.COMPRESSED_RGBA_ASTC_8x8_KHR;case _i.ASTC_RGBA_10X5:return j4.COMPRESSED_RGBA_ASTC_10x5_KHR;case _i.ASTC_RGBA_10X6:return j4.COMPRESSED_RGBA_ASTC_10x6_KHR;case _i.ASTC_RGBA_10X8:return j4.COMPRESSED_RGBA_ASTC_10x8_KHR;case _i.ASTC_RGBA_10X10:return j4.COMPRESSED_RGBA_ASTC_10x10_KHR;case _i.ASTC_RGBA_12X10:return j4.COMPRESSED_RGBA_ASTC_12x10_KHR;case _i.ASTC_RGBA_12X12:return j4.COMPRESSED_RGBA_ASTC_12x12_KHR;case _i.ASTC_SRGBA_4X4:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case _i.ASTC_SRGBA_5X4:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case _i.ASTC_SRGBA_5X5:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case _i.ASTC_SRGBA_6X5:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case _i.ASTC_SRGBA_6X6:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case _i.ASTC_SRGBA_8X5:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case _i.ASTC_SRGBA_8X6:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case _i.ASTC_SRGBA_8X8:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case _i.ASTC_SRGBA_10X5:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case _i.ASTC_SRGBA_10X6:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case _i.ASTC_SRGBA_10X8:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case _i.ASTC_SRGBA_10X10:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case _i.ASTC_SRGBA_12X10:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case _i.ASTC_SRGBA_12X12:return j4.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,n),e.glType=X4(e.format,n);var i=e.width,r=e.height;switch(e.type){case yi.TEX2D:if(e.glTarget=n.TEXTURE_2D,e.isSwapchainTexture)break;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&D(9100,o,t.capabilities.maxTextureSize),!t.extensions.WEBGL_depth_texture&&Zr[e.format].hasDepth)e.glInternalFmt=function(t,e){switch(t){case _i.R5G6B5:return e.RGB565;case _i.RGB5A1:return e.RGB5_A1;case _i.RGBA4:return e.RGBA4;case _i.RGBA16F:return j4.RGBA16F_EXT;case _i.RGBA32F:return j4.RGBA32F_EXT;case _i.SRGB8_A8:return j4.SRGB8_ALPHA8_EXT;case _i.DEPTH:return e.DEPTH_COMPONENT16;case _i.DEPTH_STENCIL:return e.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,n),e.glRenderbuffer=n.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,r));else if(e.glTexture=n.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=io(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break;case yi.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>t.capabilities.maxCubeMapTextureSize&&D(9100,h,t.capabilities.maxTextureSize),e.glTexture=n.createTexture(),e.size>0){var _=t.stateCache.glTexUnits[t.stateCache.texUnit];if(_.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),_.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var f=0;f<6;++f){i=e.width,r=e.height;for(var d=0;d<e.mipLevel;++d){var p=io(e.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,e.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=yi.TEX2D,e.glTarget=n.TEXTURE_2D}}(q4.instance,this._gpuTexture),q4.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(function(t,e){var n=t.gl;if(e.glTexture){var i=t.stateCache.glTexUnits,r=t.stateCache.texUnit;n.deleteTexture(e.glTexture);for(var o=0;o<i.length;o++)i[o].glTexture===e.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(e.glTarget,null),i[o].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;n.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}(q4.instance,this._gpuTexture),q4.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(t,e){var n=this._size;this._width=t,this._height=e,this._size=ro(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(e.size){var n=t.gl,i=e.width,r=e.height;switch(e.type){case yi.TEX2D:e.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&D(9100,o,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,r);else if(e.glTexture){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=io(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case yi.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>t.capabilities.maxCubeMapTextureSize&&D(9100,h,t.capabilities.maxTextureSize);var _=t.stateCache.glTexUnits[t.stateCache.texUnit];if(_.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),_.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var f=0;f<6;++f){i=e.width,r=e.height;for(var d=0;d<e.mipLevel;++d){var p=io(e.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,e.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=yi.TEX2D,e.glTarget=n.TEXTURE_2D}}}(q4.instance,this._gpuTexture),q4.instance.memoryStatus.textureSize-=n,q4.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(t){var e=new mr;e.format=t.format,e.usage=Zr[t.format].hasDepth?xi.DEPTH_STENCIL_ATTACHMENT:xi.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},K(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),e}(Mo),z3="webglcontextlost";function V3(t,e){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=t.getExtension(n[i]+e);if(r)return r}return null}function k3(t){var e={EXT_texture_filter_anisotropic:V3(t,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:V3(t,"EXT_blend_minmax"),EXT_frag_depth:V3(t,"EXT_frag_depth"),EXT_shader_texture_lod:V3(t,"EXT_shader_texture_lod"),EXT_sRGB:V3(t,"EXT_sRGB"),OES_vertex_array_object:V3(t,"OES_vertex_array_object"),EXT_color_buffer_half_float:V3(t,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:V3(t,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:V3(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:V3(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:V3(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:V3(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:V3(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:V3(t,"WEBGL_debug_shaders"),WEBGL_draw_buffers:V3(t,"WEBGL_draw_buffers"),WEBGL_lose_context:V3(t,"WEBGL_lose_context"),WEBGL_depth_texture:V3(t,"WEBGL_depth_texture"),OES_texture_half_float:V3(t,"OES_texture_half_float"),OES_texture_half_float_linear:V3(t,"OES_texture_half_float_linear"),OES_texture_float:V3(t,"OES_texture_float"),OES_texture_float_linear:V3(t,"OES_texture_float_linear"),OES_standard_derivatives:V3(t,"OES_standard_derivatives"),OES_element_index_uint:V3(t,"OES_element_index_uint"),ANGLE_instanced_arrays:V3(t,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:V3(t,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(t){return!!t},useVAO:!1};return fu.os===ru.IOS&&14===fu.osMainVersion&&fu.isBrowser||(e.WEBGL_compressed_texture_astc=V3(t,"WEBGL_compressed_texture_astc")),fu.os!==ru.ANDROID&&fu.os!==ru.IOS&&(e.WEBGL_multi_draw=V3(t,"WEBGL_multi_draw")),fu.browserType===eu.UC&&(e.ANGLE_instanced_arrays=null),fu.os===ru.IOS&&fu.osMainVersion<=10&&(e.destroyShadersImmediately=!1),e.OES_vertex_array_object&&(e.useVAO=!0),e}var G3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).stateCache=new L3,e.cmdAllocator=new A3,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGLContextLostHandler=null,e._extensions=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._canvas=t.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(z3,this._onWebGLContextLost);var e=q4.instance.gl;this.stateCache.initialize(q4.instance.capabilities.maxTextureUnits,q4.instance.capabilities.maxVertexAttributes),this._extensions=k3(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var n=_i.RGBA8,i=_i.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),o=e.getParameter(e.STENCIL_BITS);r&&o?i=_i.DEPTH_STENCIL:r&&(i=_i.DEPTH),this._colorTexture=new F3,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this._depthStencilTexture=new F3,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this.nullTex2D=q4.instance.createTexture(new mr(yi.TEX2D,xi.SAMPLED,_i.RGBA8,2,2,Si.GEN_MIPMAP)),this.nullTexCube=q4.instance.createTexture(new mr(yi.CUBE,xi.SAMPLED,_i.RGBA8,2,2,Si.GEN_MIPMAP,6));var a=new or;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),q4.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,q4.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(z3,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(A("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},n._onWebGLContextLost=function(t){I(11e3),y(t)},K(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(_o),U3=t("WebGLDevice",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._swapchain=null,e._context=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){q4.setInstance(this),this._gfxAPI=li.WEBGL,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var e=this._context=function(t){var e=null;try{var n={alpha:ue.ENABLE_TRANSPARENT_CANVAS,antialias:ue.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl",n)}catch(t){return null}return e}(ho.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Wr(ji.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new jr(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var n=e.getSupportedExtensions(),i="";if(n)for(var r,o=ot(n);!(r=o()).done;)i+=r.value+" ";var a=k3(e);a.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR));var s=e.getParameter(e.VERSION);this._features.fill(!1),a.EXT_sRGB&&(this._features[hi.FORMAT_SRGB]=!0),a.EXT_blend_minmax&&(this._features[hi.BLEND_MINMAX]=!0),a.WEBGL_color_buffer_float&&(this._features[hi.COLOR_FLOAT]=!0),a.EXT_color_buffer_half_float&&(this._features[hi.COLOR_HALF_FLOAT]=!0),a.OES_texture_float&&(this._features[hi.TEXTURE_FLOAT]=!0),a.OES_texture_half_float&&(this._features[hi.TEXTURE_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[hi.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[hi.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[hi.FORMAT_RGB8]=!0,a.OES_element_index_uint&&(this._features[hi.ELEMENT_INDEX_UINT]=!0),a.ANGLE_instanced_arrays&&(this._features[hi.INSTANCED_ARRAYS]=!0),a.WEBGL_draw_buffers&&(this._features[hi.MULTIPLE_RENDER_TARGETS]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[hi.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[hi.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[hi.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[hi.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[hi.FORMAT_ASTC]=!0,c+="astc "),A("WebGL device initialized."),A("RENDERER: "+this._renderer),A("VENDOR: "+this._vendor),A("VERSION: "+s),A("COMPRESSED_FORMAT: "+c),A("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},n.createCommandBuffer=function(t){var e=new(t.type===qi.PRIMARY?R3:C3);return e.initialize(t),e},n.createSwapchain=function(t){var e=new G3;return this._swapchain=e,e.initialize(t),e},n.createBuffer=function(t){var e=new x3;return e.initialize(t),e},n.createTexture=function(t){var e=new F3;return e.initialize(t),e},n.createDescriptorSet=function(t){var e=new W4;return e.initialize(t),e},n.createShader=function(t){var e=new N3;return e.initialize(t),e},n.createInputAssembler=function(t){var e=new T3;return e.initialize(t),e},n.createRenderPass=function(t){var e=new M3;return e.initialize(t),e},n.createFramebuffer=function(t){var e=new b3;return e.initialize(t),e},n.createDescriptorSetLayout=function(t){var e=new E3;return e.initialize(t),e},n.createPipelineLayout=function(t){var e=new w3;return e.initialize(t),e},n.createPipelineState=function(t){var e=new I3;return e.initialize(t),e},n.createQueue=function(t){var e=new D3;return e.initialize(t),e},n.getSampler=function(t){var e=Ro.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new O3(t,e)),this._samplers.get(e)},n.getGlobalBarrier=function(t){var e=Bo.computeHash(t);return this._globalBarriers.has(e)||this._globalBarriers.set(e,new Bo(t,e)),this._globalBarriers.get(e)},n.getTextureBarrier=function(t){var e=Oo.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Oo(t,e)),this._textureBarriers.get(e)},n.copyBuffersToTexture=function(t,e,n){g3(this,t,e.gpuTexture,n)},n.copyTextureToBuffers=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(e.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,e.glFormat,e.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,n)},n.copyTexImagesToTexture=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Si.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)},K(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),e}(ho));c.WebGLDevice=U3;var H3,j3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSet=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,n=e.bindings,i=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)t[e].type&$r?this._buffers[e]&&(t[e].gpuBuffer=this._buffers[e].gpuBuffer):t[e].type&to&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},K(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(yo);!function(t){t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(H3||(H3={}));var W3=function(){function t(){}return t.setInstance=function(e){t._instance=e},K(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();W3._instance=null;var q3=[10497,33648,33071,33071],X3=new Float32Array(4);function Y3(t,e){switch(t){case _i.R8:return e.UNSIGNED_BYTE;case _i.R8SN:return e.BYTE;case _i.R8UI:return e.UNSIGNED_BYTE;case _i.R8I:return e.BYTE;case _i.R16F:return e.HALF_FLOAT;case _i.R16UI:return e.UNSIGNED_SHORT;case _i.R16I:return e.SHORT;case _i.R32F:return e.FLOAT;case _i.R32UI:return e.UNSIGNED_INT;case _i.R32I:return e.INT;case _i.RG8:return e.UNSIGNED_BYTE;case _i.RG8SN:return e.BYTE;case _i.RG8UI:return e.UNSIGNED_BYTE;case _i.RG8I:return e.BYTE;case _i.RG16F:return e.HALF_FLOAT;case _i.RG16UI:return e.UNSIGNED_SHORT;case _i.RG16I:return e.SHORT;case _i.RG32F:return e.FLOAT;case _i.RG32UI:return e.UNSIGNED_INT;case _i.RG32I:return e.INT;case _i.RGB8:case _i.SRGB8:return e.UNSIGNED_BYTE;case _i.RGB8SN:return e.BYTE;case _i.RGB8UI:return e.UNSIGNED_BYTE;case _i.RGB8I:return e.BYTE;case _i.RGB16F:return e.HALF_FLOAT;case _i.RGB16UI:return e.UNSIGNED_SHORT;case _i.RGB16I:return e.SHORT;case _i.RGB32F:return e.FLOAT;case _i.RGB32UI:return e.UNSIGNED_INT;case _i.RGB32I:return e.INT;case _i.BGRA8:case _i.RGBA8:case _i.SRGB8_A8:return e.UNSIGNED_BYTE;case _i.RGBA8SN:return e.BYTE;case _i.RGBA8UI:return e.UNSIGNED_BYTE;case _i.RGBA8I:return e.BYTE;case _i.RGBA16F:return e.HALF_FLOAT;case _i.RGBA16UI:return e.UNSIGNED_SHORT;case _i.RGBA16I:return e.SHORT;case _i.RGBA32F:return e.FLOAT;case _i.RGBA32UI:return e.UNSIGNED_INT;case _i.RGBA32I:return e.INT;case _i.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case _i.R11G11B10F:return e.UNSIGNED_INT_10F_11F_11F_REV;case _i.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case _i.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case _i.RGB10A2:case _i.RGB10A2UI:return e.UNSIGNED_INT_2_10_10_10_REV;case _i.RGB9E5:case _i.DEPTH:return e.FLOAT;case _i.DEPTH_STENCIL:return e.UNSIGNED_INT_24_8;case _i.BC1:case _i.BC1_SRGB:case _i.BC2:case _i.BC2_SRGB:case _i.BC3:case _i.BC3_SRGB:case _i.BC4:return e.UNSIGNED_BYTE;case _i.BC4_SNORM:return e.BYTE;case _i.BC5:return e.UNSIGNED_BYTE;case _i.BC5_SNORM:return e.BYTE;case _i.BC6H_SF16:case _i.BC6H_UF16:return e.FLOAT;case _i.BC7:case _i.BC7_SRGB:case _i.ETC_RGB8:case _i.ETC2_RGB8:case _i.ETC2_SRGB8:case _i.ETC2_RGB8_A1:case _i.ETC2_SRGB8_A1:case _i.EAC_R11:return e.UNSIGNED_BYTE;case _i.EAC_R11SN:return e.BYTE;case _i.EAC_RG11:return e.UNSIGNED_BYTE;case _i.EAC_RG11SN:return e.BYTE;case _i.PVRTC_RGB2:case _i.PVRTC_RGBA2:case _i.PVRTC_RGB4:case _i.PVRTC_RGBA4:case _i.PVRTC2_2BPP:case _i.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case _i.ASTC_RGBA_4X4:case _i.ASTC_RGBA_5X4:case _i.ASTC_RGBA_5X5:case _i.ASTC_RGBA_6X5:case _i.ASTC_RGBA_6X6:case _i.ASTC_RGBA_8X5:case _i.ASTC_RGBA_8X6:case _i.ASTC_RGBA_8X8:case _i.ASTC_RGBA_10X5:case _i.ASTC_RGBA_10X6:case _i.ASTC_RGBA_10X8:case _i.ASTC_RGBA_10X10:case _i.ASTC_RGBA_12X10:case _i.ASTC_RGBA_12X12:case _i.ASTC_SRGBA_4X4:case _i.ASTC_SRGBA_5X4:case _i.ASTC_SRGBA_5X5:case _i.ASTC_SRGBA_6X5:case _i.ASTC_SRGBA_6X6:case _i.ASTC_SRGBA_8X5:case _i.ASTC_SRGBA_8X6:case _i.ASTC_SRGBA_8X8:case _i.ASTC_SRGBA_10X5:case _i.ASTC_SRGBA_10X6:case _i.ASTC_SRGBA_10X8:case _i.ASTC_SRGBA_10X10:case _i.ASTC_SRGBA_12X10:case _i.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function K3(t,e){switch(t){case di.BOOL:return e.BOOL;case di.BOOL2:return e.BOOL_VEC2;case di.BOOL3:return e.BOOL_VEC3;case di.BOOL4:return e.BOOL_VEC4;case di.INT:return e.INT;case di.INT2:return e.INT_VEC2;case di.INT3:return e.INT_VEC3;case di.INT4:return e.INT_VEC4;case di.UINT:return e.UNSIGNED_INT;case di.FLOAT:return e.FLOAT;case di.FLOAT2:return e.FLOAT_VEC2;case di.FLOAT3:return e.FLOAT_VEC3;case di.FLOAT4:return e.FLOAT_VEC4;case di.MAT2:return e.FLOAT_MAT2;case di.MAT2X3:return e.FLOAT_MAT2x3;case di.MAT2X4:return e.FLOAT_MAT2x4;case di.MAT3X2:return e.FLOAT_MAT3x2;case di.MAT3:return e.FLOAT_MAT3;case di.MAT3X4:return e.FLOAT_MAT3x4;case di.MAT4X2:return e.FLOAT_MAT4x2;case di.MAT4X3:return e.FLOAT_MAT4x3;case di.MAT4:return e.FLOAT_MAT4;case di.SAMPLER2D:return e.SAMPLER_2D;case di.SAMPLER2D_ARRAY:return e.SAMPLER_2D_ARRAY;case di.SAMPLER3D:return e.SAMPLER_3D;case di.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),di.UNKNOWN}}function J3(t,e){switch(t){case e.BOOL:return di.BOOL;case e.BOOL_VEC2:return di.BOOL2;case e.BOOL_VEC3:return di.BOOL3;case e.BOOL_VEC4:return di.BOOL4;case e.INT:return di.INT;case e.INT_VEC2:return di.INT2;case e.INT_VEC3:return di.INT3;case e.INT_VEC4:return di.INT4;case e.UNSIGNED_INT:return di.UINT;case e.UNSIGNED_INT_VEC2:return di.UINT2;case e.UNSIGNED_INT_VEC3:return di.UINT3;case e.UNSIGNED_INT_VEC4:return di.UINT4;case e.FLOAT:return di.FLOAT;case e.FLOAT_VEC2:return di.FLOAT2;case e.FLOAT_VEC3:return di.FLOAT3;case e.FLOAT_VEC4:return di.FLOAT4;case e.FLOAT_MAT2:return di.MAT2;case e.FLOAT_MAT2x3:return di.MAT2X3;case e.FLOAT_MAT2x4:return di.MAT2X4;case e.FLOAT_MAT3x2:return di.MAT3X2;case e.FLOAT_MAT3:return di.MAT3;case e.FLOAT_MAT3x4:return di.MAT3X4;case e.FLOAT_MAT4x2:return di.MAT4X2;case e.FLOAT_MAT4x3:return di.MAT4X3;case e.FLOAT_MAT4:return di.MAT4;case e.SAMPLER_2D:return di.SAMPLER2D;case e.SAMPLER_2D_ARRAY:return di.SAMPLER2D_ARRAY;case e.SAMPLER_3D:return di.SAMPLER3D;case e.SAMPLER_CUBE:return di.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),di.UNKNOWN}}function Q3(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:return 4;case e.UNSIGNED_INT_VEC2:return 8;case e.UNSIGNED_INT_VEC3:return 12;case e.UNSIGNED_INT_VEC4:return 16;case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT2x3:return 24;case e.FLOAT_MAT2x4:return 32;case e.FLOAT_MAT3x2:return 24;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT3x4:return 48;case e.FLOAT_MAT4x2:return 32;case e.FLOAT_MAT4x3:return 48;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_2D_ARRAY:case e.SAMPLER_2D_ARRAY_SHADOW:case e.SAMPLER_3D:case e.SAMPLER_CUBE:case e.INT_SAMPLER_2D:case e.INT_SAMPLER_2D_ARRAY:case e.INT_SAMPLER_3D:case e.INT_SAMPLER_CUBE:case e.UNSIGNED_INT_SAMPLER_2D:case e.UNSIGNED_INT_SAMPLER_2D_ARRAY:case e.UNSIGNED_INT_SAMPLER_3D:case e.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Z3(t,e){switch(t){case e.FLOAT_MAT2:case e.FLOAT_MAT2x3:case e.FLOAT_MAT2x4:return 2;case e.FLOAT_MAT3x2:case e.FLOAT_MAT3:case e.FLOAT_MAT3x4:return 3;case e.FLOAT_MAT4x2:case e.FLOAT_MAT4x3:case e.FLOAT_MAT4:return 4;default:return 1}}var $3,t5=[512,513,514,515,516,517,518,519],e5=[0,7680,7681,7682,7683,5386,34055,34056],n5=[32774,32778,32779,32775,32776],i5=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}($3||($3={}));var r5=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},o5=function(t){function e(){var e;return(e=t.call(this,$3.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new $i,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return Q(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(r5),a5=function(t){function e(){var e;return(e=t.call(this,$3.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new Jr,e}return Q(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},e}(r5),s5=function(t){function e(){var e;return(e=t.call(this,$3.DRAW)||this).drawInfo=new fr,e}return Q(e,t),e.prototype.clear=function(){},e}(r5),c5=function(t){function e(){var e;return(e=t.call(this,$3.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return Q(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(r5),l5=function(t){function e(){var e;return(e=t.call(this,$3.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return Q(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(r5),u5=function(){function t(){this.cmds=new jl(1),this.beginRenderPassCmds=new jl(1),this.bindStatesCmds=new jl(1),this.drawCmds=new jl(1),this.updateBufferCmds=new jl(1),this.copyBufferToTextureCmds=new jl(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function h5(t,e,n,i,r){if(e.usage&pi.INDIRECT){e.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)e.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=t.gl,l=t.stateCache;switch(e.glTarget){case c.ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),d5.gpuInputAssembler=null,l.glArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,e.glBuffer),l.glArrayBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),d5.gpuInputAssembler=null,l.glElementArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,e.glBuffer),l.glElementArrayBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==e.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,e.glBuffer),l.glUniformBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function _5(t,e){var n=t.gl;e.glInternalFmt=function(t,e){switch(t){case _i.A8:return e.ALPHA;case _i.L8:return e.LUMINANCE;case _i.LA8:return e.LUMINANCE_ALPHA;case _i.R8:return e.R8;case _i.R8SN:return e.R8_SNORM;case _i.R8UI:return e.R8UI;case _i.R8I:return e.R8I;case _i.RG8:return e.RG8;case _i.RG8SN:return e.RG8_SNORM;case _i.RG8UI:return e.RG8UI;case _i.RG8I:return e.RG8I;case _i.RGB8:return e.RGB8;case _i.RGB8SN:return e.RGB8_SNORM;case _i.RGB8UI:return e.RGB8UI;case _i.RGB8I:return e.RGB8I;case _i.BGRA8:case _i.RGBA8:return e.RGBA8;case _i.RGBA8SN:return e.RGBA8_SNORM;case _i.RGBA8UI:return e.RGBA8UI;case _i.RGBA8I:return e.RGBA8I;case _i.R16I:return e.R16I;case _i.R16UI:return e.R16UI;case _i.R16F:return e.R16F;case _i.RG16I:return e.RG16I;case _i.RG16UI:return e.RG16UI;case _i.RG16F:return e.RG16F;case _i.RGB16I:return e.RGB16I;case _i.RGB16UI:return e.RGB16UI;case _i.RGB16F:return e.RGB16F;case _i.RGBA16I:return e.RGBA16I;case _i.RGBA16UI:return e.RGBA16UI;case _i.RGBA16F:return e.RGBA16F;case _i.R32I:return e.R32I;case _i.R32UI:return e.R32UI;case _i.R32F:return e.R32F;case _i.RG32I:return e.RG32I;case _i.RG32UI:return e.RG32UI;case _i.RG32F:return e.RG32F;case _i.RGB32I:return e.RGB32I;case _i.RGB32UI:return e.RGB32UI;case _i.RGB32F:return e.RGB32F;case _i.RGBA32I:return e.RGBA32I;case _i.RGBA32UI:return e.RGBA32UI;case _i.RGBA32F:return e.RGBA32F;case _i.R5G6B5:return e.RGB565;case _i.RGB5A1:return e.RGB5_A1;case _i.RGBA4:return e.RGBA4;case _i.SRGB8:return e.SRGB8;case _i.SRGB8_A8:return e.SRGB8_ALPHA8;case _i.RGB10A2:return e.RGB10_A2;case _i.RGB10A2UI:return e.RGB10_A2UI;case _i.R11G11B10F:return e.R11F_G11F_B10F;case _i.DEPTH:return e.DEPTH_COMPONENT32F;case _i.DEPTH_STENCIL:return e.DEPTH24_STENCIL8;case _i.BC1:return H3.COMPRESSED_RGB_S3TC_DXT1_EXT;case _i.BC1_ALPHA:return H3.COMPRESSED_RGBA_S3TC_DXT1_EXT;case _i.BC1_SRGB:return H3.COMPRESSED_SRGB_S3TC_DXT1_EXT;case _i.BC1_SRGB_ALPHA:return H3.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case _i.BC2:return H3.COMPRESSED_RGBA_S3TC_DXT3_EXT;case _i.BC2_SRGB:return H3.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case _i.BC3:return H3.COMPRESSED_RGBA_S3TC_DXT5_EXT;case _i.BC3_SRGB:return H3.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case _i.ETC_RGB8:return H3.COMPRESSED_RGB_ETC1_WEBGL;case _i.ETC2_RGB8:return H3.COMPRESSED_RGB8_ETC2;case _i.ETC2_SRGB8:return H3.COMPRESSED_SRGB8_ETC2;case _i.ETC2_RGB8_A1:return H3.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_SRGB8_A1:return H3.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_RGBA8:return H3.COMPRESSED_RGBA8_ETC2_EAC;case _i.ETC2_SRGB8_A8:return H3.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case _i.EAC_R11:return H3.COMPRESSED_R11_EAC;case _i.EAC_R11SN:return H3.COMPRESSED_SIGNED_R11_EAC;case _i.EAC_RG11:return H3.COMPRESSED_RG11_EAC;case _i.EAC_RG11SN:return H3.COMPRESSED_SIGNED_RG11_EAC;case _i.PVRTC_RGB2:return H3.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGBA2:return H3.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGB4:return H3.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case _i.PVRTC_RGBA4:return H3.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case _i.ASTC_RGBA_4X4:return H3.COMPRESSED_RGBA_ASTC_4x4_KHR;case _i.ASTC_RGBA_5X4:return H3.COMPRESSED_RGBA_ASTC_5x4_KHR;case _i.ASTC_RGBA_5X5:return H3.COMPRESSED_RGBA_ASTC_5x5_KHR;case _i.ASTC_RGBA_6X5:return H3.COMPRESSED_RGBA_ASTC_6x5_KHR;case _i.ASTC_RGBA_6X6:return H3.COMPRESSED_RGBA_ASTC_6x6_KHR;case _i.ASTC_RGBA_8X5:return H3.COMPRESSED_RGBA_ASTC_8x5_KHR;case _i.ASTC_RGBA_8X6:return H3.COMPRESSED_RGBA_ASTC_8x6_KHR;case _i.ASTC_RGBA_8X8:return H3.COMPRESSED_RGBA_ASTC_8x8_KHR;case _i.ASTC_RGBA_10X5:return H3.COMPRESSED_RGBA_ASTC_10x5_KHR;case _i.ASTC_RGBA_10X6:return H3.COMPRESSED_RGBA_ASTC_10x6_KHR;case _i.ASTC_RGBA_10X8:return H3.COMPRESSED_RGBA_ASTC_10x8_KHR;case _i.ASTC_RGBA_10X10:return H3.COMPRESSED_RGBA_ASTC_10x10_KHR;case _i.ASTC_RGBA_12X10:return H3.COMPRESSED_RGBA_ASTC_12x10_KHR;case _i.ASTC_RGBA_12X12:return H3.COMPRESSED_RGBA_ASTC_12x12_KHR;case _i.ASTC_SRGBA_4X4:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case _i.ASTC_SRGBA_5X4:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case _i.ASTC_SRGBA_5X5:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case _i.ASTC_SRGBA_6X5:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case _i.ASTC_SRGBA_6X6:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case _i.ASTC_SRGBA_8X5:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case _i.ASTC_SRGBA_8X6:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case _i.ASTC_SRGBA_8X8:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case _i.ASTC_SRGBA_10X5:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case _i.ASTC_SRGBA_10X6:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case _i.ASTC_SRGBA_10X8:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case _i.ASTC_SRGBA_10X10:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case _i.ASTC_SRGBA_12X10:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case _i.ASTC_SRGBA_12X12:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,n),e.glFormat=function(t,e){switch(t){case _i.A8:return e.ALPHA;case _i.L8:return e.LUMINANCE;case _i.LA8:return e.LUMINANCE_ALPHA;case _i.R8:case _i.R8SN:return e.RED;case _i.R8UI:case _i.R8I:return e.RED;case _i.RG8:case _i.RG8SN:case _i.RG8UI:case _i.RG8I:return e.RG;case _i.RGB8:case _i.RGB8SN:case _i.RGB8UI:case _i.RGB8I:return e.RGB;case _i.BGRA8:case _i.RGBA8:case _i.RGBA8SN:case _i.RGBA8UI:case _i.RGBA8I:return e.RGBA;case _i.R16UI:case _i.R16I:case _i.R16F:return e.RED;case _i.RG16UI:case _i.RG16I:case _i.RG16F:return e.RG;case _i.RGB16UI:case _i.RGB16I:case _i.RGB16F:return e.RGB;case _i.RGBA16UI:case _i.RGBA16I:case _i.RGBA16F:return e.RGBA;case _i.R32UI:case _i.R32I:case _i.R32F:return e.RED;case _i.RG32UI:case _i.RG32I:case _i.RG32F:return e.RG;case _i.RGB32UI:case _i.RGB32I:case _i.RGB32F:return e.RGB;case _i.RGBA32UI:case _i.RGBA32I:case _i.RGBA32F:case _i.RGB10A2:return e.RGBA;case _i.R11G11B10F:case _i.R5G6B5:return e.RGB;case _i.RGB5A1:case _i.RGBA4:return e.RGBA;case _i.SRGB8:return e.RGB;case _i.SRGB8_A8:return e.RGBA;case _i.DEPTH:return e.DEPTH_COMPONENT;case _i.DEPTH_STENCIL:return e.DEPTH_STENCIL;case _i.BC1:return H3.COMPRESSED_RGB_S3TC_DXT1_EXT;case _i.BC1_ALPHA:return H3.COMPRESSED_RGBA_S3TC_DXT1_EXT;case _i.BC1_SRGB:return H3.COMPRESSED_SRGB_S3TC_DXT1_EXT;case _i.BC1_SRGB_ALPHA:return H3.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case _i.BC2:return H3.COMPRESSED_RGBA_S3TC_DXT3_EXT;case _i.BC2_SRGB:return H3.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case _i.BC3:return H3.COMPRESSED_RGBA_S3TC_DXT5_EXT;case _i.BC3_SRGB:return H3.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case _i.ETC_RGB8:return H3.COMPRESSED_RGB_ETC1_WEBGL;case _i.ETC2_RGB8:return H3.COMPRESSED_RGB8_ETC2;case _i.ETC2_SRGB8:return H3.COMPRESSED_SRGB8_ETC2;case _i.ETC2_RGB8_A1:return H3.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_SRGB8_A1:return H3.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_RGBA8:return H3.COMPRESSED_RGBA8_ETC2_EAC;case _i.ETC2_SRGB8_A8:return H3.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case _i.EAC_R11:return H3.COMPRESSED_R11_EAC;case _i.EAC_R11SN:return H3.COMPRESSED_SIGNED_R11_EAC;case _i.EAC_RG11:return H3.COMPRESSED_RG11_EAC;case _i.EAC_RG11SN:return H3.COMPRESSED_SIGNED_RG11_EAC;case _i.PVRTC_RGB2:return H3.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGBA2:return H3.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGB4:return H3.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case _i.PVRTC_RGBA4:return H3.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case _i.ASTC_RGBA_4X4:return H3.COMPRESSED_RGBA_ASTC_4x4_KHR;case _i.ASTC_RGBA_5X4:return H3.COMPRESSED_RGBA_ASTC_5x4_KHR;case _i.ASTC_RGBA_5X5:return H3.COMPRESSED_RGBA_ASTC_5x5_KHR;case _i.ASTC_RGBA_6X5:return H3.COMPRESSED_RGBA_ASTC_6x5_KHR;case _i.ASTC_RGBA_6X6:return H3.COMPRESSED_RGBA_ASTC_6x6_KHR;case _i.ASTC_RGBA_8X5:return H3.COMPRESSED_RGBA_ASTC_8x5_KHR;case _i.ASTC_RGBA_8X6:return H3.COMPRESSED_RGBA_ASTC_8x6_KHR;case _i.ASTC_RGBA_8X8:return H3.COMPRESSED_RGBA_ASTC_8x8_KHR;case _i.ASTC_RGBA_10X5:return H3.COMPRESSED_RGBA_ASTC_10x5_KHR;case _i.ASTC_RGBA_10X6:return H3.COMPRESSED_RGBA_ASTC_10x6_KHR;case _i.ASTC_RGBA_10X8:return H3.COMPRESSED_RGBA_ASTC_10x8_KHR;case _i.ASTC_RGBA_10X10:return H3.COMPRESSED_RGBA_ASTC_10x10_KHR;case _i.ASTC_RGBA_12X10:return H3.COMPRESSED_RGBA_ASTC_12x10_KHR;case _i.ASTC_RGBA_12X12:return H3.COMPRESSED_RGBA_ASTC_12x12_KHR;case _i.ASTC_SRGBA_4X4:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case _i.ASTC_SRGBA_5X4:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case _i.ASTC_SRGBA_5X5:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case _i.ASTC_SRGBA_6X5:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case _i.ASTC_SRGBA_6X6:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case _i.ASTC_SRGBA_8X5:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case _i.ASTC_SRGBA_8X6:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case _i.ASTC_SRGBA_8X8:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case _i.ASTC_SRGBA_10X5:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case _i.ASTC_SRGBA_10X6:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case _i.ASTC_SRGBA_10X8:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case _i.ASTC_SRGBA_10X10:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case _i.ASTC_SRGBA_12X10:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case _i.ASTC_SRGBA_12X12:return H3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,n),e.glType=Y3(e.format,n);var i=e.width,r=e.height;switch(e.type){case yi.TEX2D:if(e.glTarget=n.TEXTURE_2D,e.isSwapchainTexture)break;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&D(9100,o,t.capabilities.maxTextureSize),e.samples===Ai.ONE){if(e.glTexture=n.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=io(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,e.mipLevel,e.glInternalFmt,i,r)}}else e.glRenderbuffer=n.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,e.samples,e.glInternalFmt,e.width,e.height));break;case yi.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>t.capabilities.maxCubeMapTextureSize&&D(9100,u,t.capabilities.maxTextureSize),e.glTexture=n.createTexture(),e.size>0){var h=t.stateCache.glTexUnits[t.stateCache.texUnit];if(h.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),h.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var _=0;_<e.mipLevel;++_){for(var f=io(e.format,i,r,1),d=new Uint8Array(f),p=0;p<6;++p)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+p,_,e.glInternalFmt,i,r,0,d);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,e.mipLevel,e.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=yi.TEX2D,e.glTarget=n.TEXTURE_2D}}function f5(t,e){var n=t.gl;if(e.glTexture){var i=t.stateCache.glTexUnits,r=t.stateCache.texUnit;n.deleteTexture(e.glTexture);for(var o=0;o<i.length;++o)i[o].glTexture===e.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(e.glTarget,null),i[o].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;n.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}var d5={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function p5(t,e,n,i,r,o,a){var s=t.gl,c=t.stateCache,l=0;if(n&&e){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),d5.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=e.colorAttachments[u];if(h.format!==_i.UNKNOWN)switch(h.loadOp){case Mi.LOAD:break;case Mi.CLEAR:if(c.bs.targets[0].blendColorMask!==Ri.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)X3[0]=r[u].x,X3[1]=r[u].y,X3[2]=r[u].z,X3[3]=r[u].w,s.clearBufferfv(s.COLOR,u,X3);else{var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT}break;case Mi.DISCARD:d5.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==_i.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Mi.LOAD:break;case Mi.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Mi.DISCARD:d5.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(Zr[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Mi.LOAD:break;case Mi.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Mi.DISCARD:d5.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&d5.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,d5.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var f=c.bs.targets[0].blendColorMask;if(f!==Ri.ALL){var d=(f&Ri.R)!==Ri.NONE,p=(f&Ri.G)!==Ri.NONE,m=(f&Ri.B)!==Ri.NONE,v=(f&Ri.A)!==Ri.NONE;s.colorMask(d,p,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function m5(t,e,n,i,r,o){var a=t.gl,s=t.stateCache,c=e&&e.gpuShader,l=!1;if(e&&d5.gpuPipelineState!==e){if(d5.gpuPipelineState=e,d5.glPrimitive=e.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(a.useProgram(u),s.glProgram=u,l=!0)}var h=e.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case ki.NONE:a.disable(a.CULL_FACE);break;case ki.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case ki.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}t.stateCache.rs.cullMode=h.cullMode}var _=h.isFrontFaceCCW;t.stateCache.rs.isFrontFaceCCW!==_&&(a.frontFace(_?a.CCW:a.CW),t.stateCache.rs.isFrontFaceCCW=_),t.stateCache.rs.depthBias===h.depthBias&&t.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(a.polygonOffset(h.depthBias,h.depthBiasSlop),t.stateCache.rs.depthBias=h.depthBias,t.stateCache.rs.depthBiasSlop=h.depthBiasSlop),t.stateCache.rs.lineWidth!==h.lineWidth&&(a.lineWidth(h.lineWidth),t.stateCache.rs.lineWidth=h.lineWidth)}var f=e.dss;f&&(s.dss.depthTest!==f.depthTest&&(f.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),s.dss.depthTest=f.depthTest),s.dss.depthWrite!==f.depthWrite&&(a.depthMask(f.depthWrite),s.dss.depthWrite=f.depthWrite),s.dss.depthFunc!==f.depthFunc&&(a.depthFunc(t5[f.depthFunc]),s.dss.depthFunc=f.depthFunc),s.dss.stencilTestFront===f.stencilTestFront&&s.dss.stencilTestBack===f.stencilTestBack||(f.stencilTestFront||f.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),s.dss.stencilTestFront=f.stencilTestFront,s.dss.stencilTestBack=f.stencilTestBack),s.dss.stencilFuncFront===f.stencilFuncFront&&s.dss.stencilRefFront===f.stencilRefFront&&s.dss.stencilReadMaskFront===f.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,t5[f.stencilFuncFront],f.stencilRefFront,f.stencilReadMaskFront),s.dss.stencilFuncFront=f.stencilFuncFront,s.dss.stencilRefFront=f.stencilRefFront,s.dss.stencilReadMaskFront=f.stencilReadMaskFront),s.dss.stencilFailOpFront===f.stencilFailOpFront&&s.dss.stencilZFailOpFront===f.stencilZFailOpFront&&s.dss.stencilPassOpFront===f.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,e5[f.stencilFailOpFront],e5[f.stencilZFailOpFront],e5[f.stencilPassOpFront]),s.dss.stencilFailOpFront=f.stencilFailOpFront,s.dss.stencilZFailOpFront=f.stencilZFailOpFront,s.dss.stencilPassOpFront=f.stencilPassOpFront),s.dss.stencilWriteMaskFront!==f.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,f.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=f.stencilWriteMaskFront),s.dss.stencilFuncBack===f.stencilFuncBack&&s.dss.stencilRefBack===f.stencilRefBack&&s.dss.stencilReadMaskBack===f.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,t5[f.stencilFuncBack],f.stencilRefBack,f.stencilReadMaskBack),s.dss.stencilFuncBack=f.stencilFuncBack,s.dss.stencilRefBack=f.stencilRefBack,s.dss.stencilReadMaskBack=f.stencilReadMaskBack),s.dss.stencilFailOpBack===f.stencilFailOpBack&&s.dss.stencilZFailOpBack===f.stencilZFailOpBack&&s.dss.stencilPassOpBack===f.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,e5[f.stencilFailOpBack],e5[f.stencilZFailOpBack],e5[f.stencilPassOpBack]),s.dss.stencilFailOpBack=f.stencilFailOpBack,s.dss.stencilZFailOpBack=f.stencilZFailOpBack,s.dss.stencilPassOpBack=f.stencilPassOpBack),s.dss.stencilWriteMaskBack!==f.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,f.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=f.stencilWriteMaskBack));var d=e.bs;if(d){s.bs.isA2C!==d.isA2C&&(d.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=d.isA2C),s.bs.blendColor.x===d.blendColor.x&&s.bs.blendColor.y===d.blendColor.y&&s.bs.blendColor.z===d.blendColor.z&&s.bs.blendColor.w===d.blendColor.w||(a.blendColor(d.blendColor.x,d.blendColor.y,d.blendColor.z,d.blendColor.w),s.bs.blendColor.x=d.blendColor.x,s.bs.blendColor.y=d.blendColor.y,s.bs.blendColor.z=d.blendColor.z,s.bs.blendColor.w=d.blendColor.w);var p=d.targets[0],m=s.bs.targets[0];m.blend!==p.blend&&(p.blend?a.enable(a.BLEND):a.disable(a.BLEND),m.blend=p.blend),m.blendEq===p.blendEq&&m.blendAlphaEq===p.blendAlphaEq||(a.blendEquationSeparate(n5[p.blendEq],n5[p.blendAlphaEq]),m.blendEq=p.blendEq,m.blendAlphaEq=p.blendAlphaEq),m.blendSrc===p.blendSrc&&m.blendDst===p.blendDst&&m.blendSrcAlpha===p.blendSrcAlpha&&m.blendDstAlpha===p.blendDstAlpha||(a.blendFuncSeparate(i5[p.blendSrc],i5[p.blendDst],i5[p.blendSrcAlpha],i5[p.blendDstAlpha]),m.blendSrc=p.blendSrc,m.blendDst=p.blendDst,m.blendSrcAlpha=p.blendSrcAlpha,m.blendDstAlpha=p.blendDstAlpha),m.blendColorMask!==p.blendColorMask&&(a.colorMask((p.blendColorMask&Ri.R)!==Ri.NONE,(p.blendColorMask&Ri.G)!==Ri.NONE,(p.blendColorMask&Ri.B)!==Ri.NONE,(p.blendColorMask&Ri.A)!==Ri.NONE),m.blendColorMask=p.blendColorMask)}}if(e&&e.gpuPipelineLayout&&c){for(var v=c.glBlocks.length,g=e.gpuPipelineLayout.dynamicOffsetIndices,y=0;y<v;y++){var S=c.glBlocks[y],A=i[S.set],C=A&&A.descriptorIndices[S.binding],b=C>=0&&A.gpuDescriptors[C];if(b&&b.gpuBuffer){var T=g[S.set],E=T&&T[S.binding],w=b.gpuBuffer.glOffset;E>=0&&(w+=r[E]),s.glBindUBOs[S.glBinding]===b.gpuBuffer.glBuffer&&s.glBindUBOOffsets[S.glBinding]===w||(w?a.bindBufferRange(a.UNIFORM_BUFFER,S.glBinding,b.gpuBuffer.glBuffer,w,b.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,S.glBinding,b.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[S.glBinding]=b.gpuBuffer.glBuffer,s.glBindUBOOffsets[S.glBinding]=w)}else x("Buffer binding '"+S.name+"' at set "+S.set+" binding "+S.binding+" is not bounded")}for(var P=c.glSamplerTextures.length,I=0;I<P;I++)for(var R=c.glSamplerTextures[I],D=i[R.set],M=D&&D.descriptorIndices[R.binding],B=M>=0&&D.gpuDescriptors[M],O=0;O<R.units.length;O++){var N=R.units[O],L=s.glTexUnits[N];if(B&&B.gpuTexture&&B.gpuSampler){if(B.gpuTexture&&B.gpuTexture.size>0){var F=B.gpuTexture;L.glTexture!==F.glTexture&&(s.texUnit!==N&&(a.activeTexture(a.TEXTURE0+N),s.texUnit=N),F.glTexture?a.bindTexture(F.glTarget,F.glTexture):a.bindTexture(F.glTarget,t.nullTex2D.gpuTexture.glTexture),L.glTexture=F.glTexture);var z=B.gpuSampler;s.glSamplerUnits[N]!==z.glSampler&&(a.bindSampler(N,z.glSampler),s.glSamplerUnits[N]=z.glSampler)}B=D.gpuDescriptors[++M]}else x("Sampler binding '"+R.name+"' at set "+R.set+" binding "+R.binding+" index "+O+" is not bounded")}}if(n&&c&&(l||d5.gpuInputAssembler!==n))if(d5.gpuInputAssembler=n,t.extensions.useVAO){var V=n.glVAOs.get(c.glProgram);if(!V){var k;V=a.createVertexArray(),n.glVAOs.set(c.glProgram,V),a.bindVertexArray(V),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var G=0;G<c.glInputs.length;G++){var U=c.glInputs[G];k=null;for(var H=0;H<n.glAttribs.length;H++){var j=n.glAttribs[H];if(j.name===U.name){k=j;break}}if(k){s.glArrayBuffer!==k.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,k.glBuffer),s.glArrayBuffer=k.glBuffer);for(var W=0;W<k.componentCount;++W){var q=U.glLoc+W,X=k.offset+k.size*W;a.enableVertexAttribArray(q),s.glCurrentAttribLocs[q]=!0,a.vertexAttribPointer(q,k.count,k.glType,k.isNormalized,k.stride,X),a.vertexAttribDivisor(q,k.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Y.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==V&&(a.bindVertexArray(V),s.glVAO=V)}else{for(var K=0;K<t.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var J=0;J<c.glInputs.length;J++){for(var Q=c.glInputs[J],Z=null,$=0;$<n.glAttribs.length;$++){var tt=n.glAttribs[$];if(tt.name===Q.name){Z=tt;break}}if(Z){s.glArrayBuffer!==Z.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,Z.glBuffer),s.glArrayBuffer=Z.glBuffer);for(var et=0;et<Z.componentCount;++et){var nt=Q.glLoc+et,it=Z.offset+Z.size*et;!s.glEnabledAttribLocs[nt]&&nt>=0&&(a.enableVertexAttribArray(nt),s.glEnabledAttribLocs[nt]=!0),s.glCurrentAttribLocs[nt]=!0,a.vertexAttribPointer(nt,Z.count,Z.glType,Z.isNormalized,Z.stride,it),a.vertexAttribDivisor(nt,Z.isInstanced?1:0)}}}var rt=n.gpuIndexBuffer;rt&&s.glElementArrayBuffer!==rt.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,rt.glBuffer),s.glElementArrayBuffer=rt.glBuffer);for(var ot=0;ot<t.capabilities.maxVertexAttributes;++ot)s.glEnabledAttribLocs[ot]!==s.glCurrentAttribLocs[ot]&&(a.disableVertexAttribArray(ot),s.glEnabledAttribLocs[ot]=!1)}if(e&&e.dynamicStates.length)for(var at=e.dynamicStates.length,st=0;st<at;st++)switch(e.dynamicStates[st]){case Gi.LINE_WIDTH:s.rs.lineWidth!==o.lineWidth&&(a.lineWidth(o.lineWidth),s.rs.lineWidth=o.lineWidth);break;case Gi.DEPTH_BIAS:s.rs.depthBias===o.depthBiasConstant&&s.rs.depthBiasSlop===o.depthBiasSlope||(a.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),s.rs.depthBias=o.depthBiasConstant,s.rs.depthBiasSlop=o.depthBiasSlope);break;case Gi.BLEND_CONSTANTS:var ct=o.blendConstant;s.bs.blendColor.x===ct.x&&s.bs.blendColor.y===ct.y&&s.bs.blendColor.z===ct.z&&s.bs.blendColor.w===ct.w||(a.blendColor(ct.x,ct.y,ct.z,ct.w),s.bs.blendColor.copy(ct));break;case Gi.STENCIL_WRITE_MASK:var lt=o.stencilStatesFront,ut=o.stencilStatesBack;s.dss.stencilWriteMaskFront!==lt.writeMask&&(a.stencilMaskSeparate(a.FRONT,lt.writeMask),s.dss.stencilWriteMaskFront=lt.writeMask),s.dss.stencilWriteMaskBack!==ut.writeMask&&(a.stencilMaskSeparate(a.BACK,ut.writeMask),s.dss.stencilWriteMaskBack=ut.writeMask);break;case Gi.STENCIL_COMPARE_MASK:var ht=o.stencilStatesFront,_t=o.stencilStatesBack;s.dss.stencilRefFront===ht.reference&&s.dss.stencilReadMaskFront===ht.compareMask||(a.stencilFuncSeparate(a.FRONT,t5[s.dss.stencilFuncFront],ht.reference,ht.compareMask),s.dss.stencilRefFront=ht.reference,s.dss.stencilReadMaskFront=ht.compareMask),s.dss.stencilRefBack===_t.reference&&s.dss.stencilReadMaskBack===_t.compareMask||(a.stencilFuncSeparate(a.BACK,t5[s.dss.stencilFuncBack],_t.reference,_t.compareMask),s.dss.stencilRefBack=_t.reference,s.dss.stencilReadMaskBack=_t.compareMask)}}function v5(t,e){var n=t.gl,i=d5.gpuInputAssembler,r=d5.glPrimitive,o=t.extensions.WEBGL_multi_draw;if(i){var a=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*a.stride;if(o)s.instancedDraw?o.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):o.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(o)s.instancedDraw?o.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):o.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(e.instanceCount)if(a){if(e.indexCount>0){var h=e.firstIndex*a.stride;n.drawElementsInstanced(r,e.indexCount,i.glIndexType,h,e.instanceCount)}}else e.vertexCount>0&&n.drawArraysInstanced(r,e.firstVertex,e.vertexCount,e.instanceCount);else if(a){if(e.indexCount>0){var _=e.firstIndex*a.stride;n.drawElements(r,e.indexCount,i.glIndexType,_)}}else e.vertexCount>0&&n.drawArrays(r,e.firstVertex,e.vertexCount)}}var g5=new Array($3.COUNT);function y5(t,e){g5.fill(0);for(var n=0;n<e.cmds.length;++n){var i=e.cmds.array[n],r=g5[i]++;switch(i){case $3.BEGIN_RENDER_PASS:var o=e.beginRenderPassCmds.array[r];p5(t,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case $3.BIND_STATES:var a=e.bindStatesCmds.array[r];m5(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case $3.DRAW:v5(t,e.drawCmds.array[r].drawInfo);break;case $3.UPDATE_BUFFER:var s=e.updateBufferCmds.array[r];h5(t,s.gpuBuffer,s.buffer,s.offset,s.size);break;case $3.COPY_BUFFER_TO_TEXTURE:var c=e.copyBufferToTextureCmds.array[r];x5(t,c.buffers,c.gpuTexture,c.regions)}}}function x5(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=Zr[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=e[a++];u?n.glInternalFmt!==H3.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=e[a++];u?n.glInternalFmt!==H3.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Si.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var S5=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=r(t);var e=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=e,this.offsets=n,this.instances=i}},t}(),A5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuBuffer=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:e.gpuBuffer.indirects,glTarget:e.gpuBuffer.glTarget,glBuffer:e.gpuBuffer.glBuffer,glOffset:t.offset}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new S5,glTarget:0,glBuffer:null,glOffset:0},function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&gi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&pi.VERTEX){e.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),d5.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&pi.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),d5.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else if(e.usage&pi.UNIFORM){e.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&e.size>0&&(e.glBuffer=s,t.stateCache.glUniformBuffer!==e.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,e.glBuffer),t.stateCache.glUniformBuffer=e.glBuffer),n.bufferData(n.UNIFORM_BUFFER,e.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null)}else e.usage&pi.INDIRECT||e.usage&pi.TRANSFER_DST||e.usage&pi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE}(W3.instance,this._gpuBuffer),W3.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(t,e){var n=t.gl,i=t.stateCache;if(e.glBuffer){switch(e.glTarget){case n.ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),t.stateCache.glVAO=null),d5.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),t.stateCache.glVAO=null),d5.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null}n.deleteBuffer(e.glBuffer),e.glBuffer=null}}(W3.instance,this._gpuBuffer),W3.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=t,t>0&&(function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&gi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&pi.VERTEX?(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),d5.gpuInputAssembler=null,i.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):e.usage&pi.INDEX?(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),d5.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&pi.UNIFORM?(t.stateCache.glUniformBuffer!==e.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,e.glBuffer),n.bufferData(n.UNIFORM_BUFFER,e.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):(e.usage&pi.INDIRECT||e.usage&pi.TRANSFER_DST||e.usage&pi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(W3.instance,this._gpuBuffer),W3.instance.memoryStatus.bufferSize-=e,W3.instance.memoryStatus.bufferSize+=t)))}},n.update=function(t,e){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==e?e:this._usage&pi.INDIRECT?0:t.byteLength,h5(W3.instance,this._gpuBuffer,t,0,n))},K(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),e}(lo),C5=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new jl(e);for(var n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,n=this._frees;this._frees=new Array(e);for(var i=e-n.length,r=0;r<i;++r)this._frees[r]=new t;for(var o=i,a=0;o<e;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),b5=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new C5(o5,1),this.bindStatesCmdPool=new C5(a5,1),this.drawCmdPool=new C5(s5,1),this.updateBufferCmdPool=new C5(c5,1),this.copyBufferToTextureCmdPool=new C5(l5,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),T5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).cmdPackage=new u5,e._cmdAllocator=new b5,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUDescriptorSets=[],e._curGPUInputAssembler=null,e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new Jr,e._isStateInvalied=!1,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=W3.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<e;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(t,e,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(o5);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=n;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push($3.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},n.bindDescriptorSet=function(t,e,n){var i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[t],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},n.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},n.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},n.setDepthBias=function(t,e,n){var i=this._curDynamicStates;i.depthBiasConstant===t&&i.depthBiasClamp===e&&i.depthBiasSlope===n||(i.depthBiasConstant=t,i.depthBiasClamp=e,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},n.setDepthBound=function(t,e){var n=this._curDynamicStates;n.depthMinBounds===t&&n.depthMaxBounds===e||(n.depthMinBounds=t,n.depthMaxBounds=e,this._isStateInvalied=!0)},n.setStencilWriteMask=function(t,e){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;t&Ui.FRONT&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0),t&Ui.BACK&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0)},n.setStencilCompareMask=function(t,e,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&Ui.FRONT&&(i.compareMask===n&&i.reference===e||(i.reference=e,i.compareMask=n,this._isStateInvalied=!0)),t&Ui.BACK&&(r.compareMask===n&&r.reference===e||(r.reference=e,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(t){if(this._type===qi.PRIMARY&&this._isInRenderPass||this._type===qi.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,n=this._cmdAllocator.drawCmdPool.alloc(s5);n.drawInfo.copy(e),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push($3.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(t,e,n){if(this._type===qi.PRIMARY&&!this._isInRenderPass||this._type===qi.SECONDARY){var i=t.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(c5),a=0;t.usage&pi.INDIRECT||(a=void 0!==n?n:e.byteLength),r=e,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push($3.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(t,e,n){if(this._type===qi.PRIMARY&&!this._isInRenderPass||this._type===qi.SECONDARY){var i=e.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(l5);r.gpuTexture=i,r.regions=n,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push($3.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(t,e){for(var n=0;n<e;++n){for(var i=t[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(a5);t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push($3.BIND_STATES),this._isStateInvalied=!1},e}(uo),E5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuFramebuffer=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=[],n=0;n<t.colorTextures.length;n++){var i=t.colorTextures[n];i&&e.push(i.gpuTexture)}var r=null;t.depthStencilTexture&&(r=t.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(t){o=t},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(t){a=t}},function(t,e){for(var n=0;n<e.gpuColorTextures.length;++n)if(e.gpuColorTextures[n].isSwapchainTexture)return void(e.isOffscreen=!1);var i=t.gl,r=[],o=i.createFramebuffer();if(o){e.glFramebuffer=o,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var s=e.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}var c=e.gpuDepthStencilTexture;if(c){var l=Zr[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),e.width=Math.min(e.width,c.width),e.height=Math.min(e.height,c.height)}i.drawBuffers(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(W3.instance,this._gpuFramebuffer)},n.destroy=function(){var t,e;this._gpuFramebuffer&&(t=W3.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},K(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(fo),w5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuInputAssembler=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var n=new Array(t.vertexBuffers.length),i=0;i<t.vertexBuffers.length;++i){var r=t.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(t.indexBuffer&&(o=t.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var n=t.gl;e.glAttribs=new Array(e.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var o=e.attributes[r],a=void 0!==o.stream?o.stream:0,s=e.gpuVertexBuffers[a],c=Y3(o.format,n),l=Zr[o.format].size;e.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:Zr[o.format].count,stride:s.stride,componentCount:Z3(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(W3.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var t=W3.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var n=e.glVAOs.values(),i=n.next(),r=t.gl,o=t.stateCache.glVAO;!i.done;)r.deleteVertexArray(i.value),o===i.value&&(r.bindVertexArray(null),o=null),i=n.next();t.stateCache.glVAO=o,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},K(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(go),P5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSetLayout=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(e),e+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&eo)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:e}},n.destroy=function(){this._bindings.length=0},K(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(xo),I5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineLayout=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),e.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},K(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(So),R5=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],D5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineState=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var n=t.blendState,i=n.targets;i&&i.forEach((function(t,n){e.setTarget(n,t)})),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:R5[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},K(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(wo),M5=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.beginRenderPass=function(t,e,n,i,r,o){p5(W3.instance,t.gpuRenderPass,e.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;v5(W3.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(t){var e=W3.instance,n=e.stateCache,i=e.gl;n.viewport.left===t.left&&n.viewport.top===t.top&&n.viewport.width===t.width&&n.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),n.viewport.left=t.left,n.viewport.top=t.top,n.viewport.width=t.width,n.viewport.height=t.height)},n.setScissor=function(t){var e=W3.instance,n=e.stateCache,i=e.gl;n.scissorRect.x===t.x&&n.scissorRect.y===t.y&&n.scissorRect.width===t.width&&n.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),n.scissorRect.x=t.x,n.scissorRect.y=t.y,n.scissorRect.width=t.width,n.scissorRect.height=t.height)},n.updateBuffer=function(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=t.gpuBuffer;r&&(i=void 0!==n?n:t.usage&pi.INDIRECT?0:e.byteLength,h5(W3.instance,r,e,0,i))}},n.copyBuffersToTexture=function(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=e.gpuTexture;i&&x5(W3.instance,t,i,n)}},n.execute=function(t,e){for(var n=0;n<e;++n){var i=t[n];y5(W3.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){m5(W3.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(T5),B5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type},n.destroy=function(){},n.submit=function(t){for(var e=0;e<t.length;e++){var n=t[e];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(Po),O5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuRenderPass=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},K(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(Io),N5=function(t){function e(e,n){var i,r,o,a,s;return(i=t.call(this,e,n)||this)._gpuSampler=null,i._gpuSampler={glSampler:null,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},r=W3.instance,o=i._gpuSampler,(s=(a=r.gl).createSampler())&&(o.minFilter===bi.LINEAR||o.minFilter===bi.ANISOTROPIC?o.mipFilter===bi.LINEAR||o.mipFilter===bi.ANISOTROPIC?o.glMinFilter=a.LINEAR_MIPMAP_LINEAR:o.mipFilter===bi.POINT?o.glMinFilter=a.LINEAR_MIPMAP_NEAREST:o.glMinFilter=a.LINEAR:o.mipFilter===bi.LINEAR||o.mipFilter===bi.ANISOTROPIC?o.glMinFilter=a.NEAREST_MIPMAP_LINEAR:o.mipFilter===bi.POINT?o.glMinFilter=a.NEAREST_MIPMAP_NEAREST:o.glMinFilter=a.NEAREST,o.magFilter===bi.LINEAR||o.magFilter===bi.ANISOTROPIC?o.glMagFilter=a.LINEAR:o.glMagFilter=a.NEAREST,o.glWrapS=q3[o.addressU],o.glWrapT=q3[o.addressV],o.glWrapR=q3[o.addressW],o.glSampler=s,a.samplerParameteri(s,a.TEXTURE_MIN_FILTER,o.glMinFilter),a.samplerParameteri(s,a.TEXTURE_MAG_FILTER,o.glMagFilter),a.samplerParameteri(s,a.TEXTURE_WRAP_S,o.glWrapS),a.samplerParameteri(s,a.TEXTURE_WRAP_T,o.glWrapT),a.samplerParameteri(s,a.TEXTURE_WRAP_R,o.glWrapR),a.samplerParameterf(s,a.TEXTURE_MIN_LOD,0),a.samplerParameterf(s,a.TEXTURE_MAX_LOD,1e3)),i}return Q(e,t),e.prototype.destroy=function(){this._gpuSampler&&(function(t,e){var n=t.gl;if(e.glSampler){n.deleteSampler(e.glSampler);for(var i=t.stateCache.glSamplerUnits,r=0;r<i.length;++r)i[r]===e.glSampler&&(n.bindSampler(r,null),i[r]=null);e.glSampler=null}}(W3.instance,this._gpuSampler),this._gpuSampler=null)},K(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(Ro),L5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuShader=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}!function(t,e){for(var n=t.gl,i=function(t){var i=e.gpuStages[t],r=0,o="",a=1;switch(i.type){case Di.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Di.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<e.gpuStages.length;c++){var l=e.gpuStages[t];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){e.glProgram=a;for(var s=0;s<e.gpuStages.length;s++){var c=e.gpuStages[s];n.attachShader(e.glProgram,c.glShader)}n.linkProgram(e.glProgram);for(var l=0;l<e.gpuStages.length;l++){var u=e.gpuStages[l];u.glShader&&(n.detachShader(e.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(n.getProgramInfoLog(e.glProgram));A("Shader '"+e.name+"' compilation succeeded.");var h=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(e.glProgram,_);if(f){var d,p=f.name.indexOf("[");d=-1!==p?f.name.substr(0,p):f.name;var m=n.getAttribLocation(e.glProgram,d),v=J3(f.type,n),g=Q3(f.type,n);e.glInputs[_]={name:d,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}var y,S,C,b,T=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(T){e.glBlocks=new Array(T);for(var E=0;E<T;++E){var w=(y=n.getActiveUniformBlockName(e.glProgram,E)).indexOf("[");-1!==w&&(y=y.substr(0,w)),b=null;for(var P=0;P<e.blocks.length;P++)if(e.blocks[P].name===y){b=e.blocks[P];break}if(b){S=E,C=n.getActiveUniformBlockParameter(e.glProgram,S,n.UNIFORM_BLOCK_DATA_SIZE);var I=b.binding+(t.bindingMappingInfo.bufferOffsets[b.set]||0);n.uniformBlockBinding(e.glProgram,S,I),e.glBlocks[E]={set:b.set,binding:b.binding,idx:S,name:y,size:C,glBinding:I}}else x("Block '"+y+"' does not bound")}}for(var R=0;R<e.subpassInputs.length;++R){var D=e.subpassInputs[R];e.samplerTextures.push(new Sr(D.set,D.binding,D.name,di.SAMPLER2D,D.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var M=0;M<e.samplerTextures.length;++M){var B=e.samplerTextures[M];e.glSamplerTextures[M]={set:B.set,binding:B.binding,name:B.name,type:B.type,count:B.count,units:[],glUnits:null,glType:K3(B.type,n),glLoc:null}}}for(var O=[],N=[],L=t.stateCache.texUnitCacheMap,F=0,z=0;z<e.blocks.length;++z)e.blocks[z].set===t.bindingMappingInfo.flexibleSet&&F++;for(var V=0,k=0;k<e.samplerTextures.length;++k){var G=e.samplerTextures[k],U=n.getUniformLocation(e.glProgram,G.name);if(U&&-1!==U.id&&(O.push(e.glSamplerTextures[k]),N.push(U)),void 0===L[G.name]){var H=G.binding+t.bindingMappingInfo.samplerOffsets[G.set]+V;G.set===t.bindingMappingInfo.flexibleSet&&(H-=F),L[G.name]=H%t.capabilities.maxTextureUnits,V+=G.count-1}}if(O.length){for(var j=[],W=0;W<O.length;++W){var q=O[W],X=L[q.name];if(void 0!==X){q.glLoc=N[W];for(var Y=0;Y<q.count;++Y){for(;j[X];)X=(X+1)%t.capabilities.maxTextureUnits;q.units.push(X),j[X]=!0}}}for(var K=0,J=0;J<O.length;++J){var Q=O[J];if(!Q.glLoc){for(Q.glLoc=N[J];j[K];)K++;for(var Z=0;Z<Q.count;++Z){for(;j[K];)K=(K+1)%t.capabilities.maxTextureUnits;void 0===L[Q.name]&&(L[Q.name]=K),Q.units.push(K),j[K]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(var $=0;$<O.length;$++){var tt=O[$];tt.glUnits=new Int32Array(tt.units),n.uniform1iv(tt.glLoc,tt.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}e.glSamplerTextures=O}}(W3.instance,this._gpuShader)},n.destroy=function(){var t,e;this._gpuShader&&(t=W3.instance,(e=this._gpuShader).glProgram&&(t.gl.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null),this._gpuShader=null)},K(e,[{key:"gpuShader",get:function(){return this._gpuShader}}]),e}(Do),F5=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new ar,this.scissorRect=new $i(0,0,0,0),this.rs=new Ao,this.dss=new Co,this.bs=new To,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e,n){for(var i=0;i<t;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=t,this.glSamplerUnits.fill(null),this.glBindUBOs.length=e,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=e,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},t}(),z5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuTexture=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t,e){"texture"in t?console.log("WebGL2 does not support texture view."):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=no(this._width)&&no(this._height),this._size=ro(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},_5(W3.instance,this._gpuTexture),W3.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(f5(W3.instance,this._gpuTexture),W3.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(t,e){var n=this._size;this._width=t,this._height=e,this._size=ro(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(e.size){var n=t.gl,i=e.width,r=e.height;switch(e.type){case yi.TEX2D:e.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&D(9100,o,t.capabilities.maxTextureSize),e.samples===Ai.ONE){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=io(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else f5(t,e),_5(t,e)}else e.glRenderbuffer&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,e.samples,e.glInternalFmt,e.width,e.height));break;case yi.CUBE:e.type=yi.CUBE,e.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>t.capabilities.maxCubeMapTextureSize&&D(9100,u,t.capabilities.maxTextureSize);var h=t.stateCache.glTexUnits[t.stateCache.texUnit];if(h.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),h.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var _=0;_<6;++_){i=e.width,r=e.height;for(var f=0;f<e.mipLevel;++f){var d=io(e.format,i,r,1),p=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,f,e.glInternalFmt,i,r,0,p),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else f5(t,e),_5(t,e);break;default:console.error("Unsupported TextureType, create texture failed."),e.type=yi.TEX2D,e.glTarget=n.TEXTURE_2D}}}(W3.instance,this._gpuTexture),W3.instance.memoryStatus.textureSize-=n,W3.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(t){var e=new mr;e.format=t.format,e.usage=Zr[t.format].hasDepth?xi.DEPTH_STENCIL_ATTACHMENT:xi.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},K(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),e}(Mo),V5="webglcontextlost";function k5(t,e){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=t.getExtension(n[i]+e);if(r)return r}return null}function G5(t){var e={EXT_texture_filter_anisotropic:k5(t,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:k5(t,"EXT_color_buffer_half_float"),EXT_color_buffer_float:k5(t,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:k5(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:k5(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:k5(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:k5(t,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:k5(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:k5(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:k5(t,"WEBGL_debug_shaders"),WEBGL_lose_context:k5(t,"WEBGL_lose_context"),WEBGL_debug_renderer_info:k5(t,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:k5(t,"OES_texture_half_float_linear"),OES_texture_float_linear:k5(t,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return fu.os!==ru.ANDROID&&fu.os!==ru.IOS&&(e.WEBGL_multi_draw=k5(t,"WEBGL_multi_draw")),e}var U5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).stateCache=new F5,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGL2ContextLostHandler=null,e._extensions=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._canvas=t.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(V5,this._onWebGLContextLost);var e=W3.instance.gl;this.stateCache.initialize(W3.instance.capabilities.maxTextureUnits,W3.instance.capabilities.maxUniformBufferBindings,W3.instance.capabilities.maxVertexAttributes),this._extensions=G5(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var n=_i.RGBA8,i=_i.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),o=e.getParameter(e.STENCIL_BITS);r&&o?i=_i.DEPTH_STENCIL:r&&(i=_i.DEPTH),this._colorTexture=new z5,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this._depthStencilTexture=new z5,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this.nullTex2D=W3.instance.createTexture(new mr(yi.TEX2D,xi.SAMPLED,_i.RGBA8,2,2,Si.NONE)),this.nullTexCube=W3.instance.createTexture(new mr(yi.CUBE,xi.SAMPLED,_i.RGBA8,2,2,Si.NONE,6));var a=new or;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),W3.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,W3.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(V5,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(A("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},n._onWebGLContextLost=function(t){I(11e3),y(t)},K(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(_o),H5=t("WebGL2Device",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._swapchain=null,e._context=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){W3.setInstance(this),this._gfxAPI=li.WEBGL2,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var e=this._context=function(t){var e=null;try{var n={alpha:ue.ENABLE_TRANSPARENT_CANVAS,antialias:ue.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl2",n)}catch(t){return null}return e}(ho.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Wr(ji.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new jr(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var n=e.getSupportedExtensions(),i="";if(n)for(var r,o=ot(n);!(r=o()).done;)i+=r.value+" ";var a=G5(e);a.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR));var s=e.getParameter(e.VERSION);this._features.fill(!1),this._features[hi.TEXTURE_FLOAT]=!0,this._features[hi.TEXTURE_HALF_FLOAT]=!0,this._features[hi.FORMAT_R11G11B10F]=!0,this._features[hi.FORMAT_SRGB]=!0,this._features[hi.FORMAT_RGB8]=!0,this._features[hi.ELEMENT_INDEX_UINT]=!0,this._features[hi.INSTANCED_ARRAYS]=!0,this._features[hi.MULTIPLE_RENDER_TARGETS]=!0,this._features[hi.BLEND_MINMAX]=!0,a.EXT_color_buffer_float&&(this._features[hi.COLOR_FLOAT]=!0,this._features[hi.COLOR_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[hi.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[hi.TEXTURE_HALF_FLOAT_LINEAR]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[hi.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[hi.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[hi.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[hi.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[hi.FORMAT_ASTC]=!0,c+="astc "),A("WebGL2 device initialized."),A("RENDERER: "+this._renderer),A("VENDOR: "+this._vendor),A("VERSION: "+s),A("COMPRESSED_FORMAT: "+c),A("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var t=this._samplers.values(),e=t.next();!e.done;)e.value.destroy(),e=t.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},n.createCommandBuffer=function(t){var e=new(t.type===qi.PRIMARY?M5:T5);return e.initialize(t),e},n.createSwapchain=function(t){var e=new U5;return this._swapchain=e,e.initialize(t),e},n.createBuffer=function(t){var e=new A5;return e.initialize(t),e},n.createTexture=function(t){var e=new z5;return e.initialize(t),e},n.createDescriptorSet=function(t){var e=new j3;return e.initialize(t),e},n.createShader=function(t){var e=new L5;return e.initialize(t),e},n.createInputAssembler=function(t){var e=new w5;return e.initialize(t),e},n.createRenderPass=function(t){var e=new O5;return e.initialize(t),e},n.createFramebuffer=function(t){var e=new E5;return e.initialize(t),e},n.createDescriptorSetLayout=function(t){var e=new P5;return e.initialize(t),e},n.createPipelineLayout=function(t){var e=new I5;return e.initialize(t),e},n.createPipelineState=function(t){var e=new D5;return e.initialize(t),e},n.createQueue=function(t){var e=new B5;return e.initialize(t),e},n.getSampler=function(t){var e=Ro.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new N5(t,e)),this._samplers.get(e)},n.getGlobalBarrier=function(t){var e=Bo.computeHash(t);return this._globalBarriers.has(e)||this._globalBarriers.set(e,new Bo(t,e)),this._globalBarriers.get(e)},n.getTextureBarrier=function(t){var e=Oo.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Oo(t,e)),this._textureBarriers.get(e)},n.copyBuffersToTexture=function(t,e,n){x5(this,t,e.gpuTexture,n)},n.copyTextureToBuffers=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(e.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,e.glFormat,e.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,n)},n.copyTexImagesToTexture=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Si.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)},K(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),e}(ho));function j5(t,e,n,i){var r=(i.x-n.x)*(t.y-n.y)-(i.y-n.y)*(t.x-n.x),o=(e.x-t.x)*(t.y-n.y)-(e.y-t.y)*(t.x-n.x),a=(i.y-n.y)*(e.x-t.x)-(i.x-n.x)*(e.y-t.y);if(0!==a){var s=r/a,c=o/a;if(s>=0&&s<=1&&c>=0&&c<=1)return!0}return!1}c.WebGL2Device=H5;var W5=new Xn,q5=new Xn,X5=new Xn,Y5=new Xn;function K5(t,e,n){for(var i=n.length,r=0;r<i;++r)if(j5(t,e,n[r],n[(r+1)%i]))return!0;return!1}function J5(t,e){for(var n=!1,i=t.x,r=t.y,o=e.length,a=0,s=o-1;a<o;s=a++){var c=e[a].x,l=e[a].y,u=e[s].x,h=e[s].y;l>r!=h>r&&i<(u-c)*(r-l)/(h-l)+c&&(n=!n)}return n}function Q5(t,e,n,i){var r,o=n.x-e.x,a=n.y-e.y,s=o*o+a*a,c=((t.x-e.x)*o+(t.y-e.y)*a)/s;return r=i?s?c<0?e:c>1?n:W5.set(e.x+c*o,e.y+c*a):e:W5.set(e.x+c*o,e.y+c*a),o=t.x-r.x,a=t.y-r.y,Math.sqrt(o*o+a*a)}var Z5,$5,t8=t("Intersection2D",(function(){}));t8.lineLine=j5,t8.lineRect=function(t,e,n){var i=W5.set(n.x,n.y),r=q5.set(n.x,n.yMax),o=X5.set(n.xMax,n.yMax),a=Y5.set(n.xMax,n.y);return!!(j5(t,e,i,r)||j5(t,e,r,o)||j5(t,e,o,a)||j5(t,e,a,i))},t8.linePolygon=K5,t8.rectRect=function(t,e){var n=t.x,i=t.y,r=t.x+t.width,o=t.y+t.height,a=e.x,s=e.y,c=e.x+e.width,l=e.y+e.height;return n<=c&&r>=a&&i<=l&&o>=s},t8.rectPolygon=function(t,e){var n=W5.set(t.x,t.y),i=q5.set(t.x,t.yMax),r=X5.set(t.xMax,t.yMax),o=Y5.set(t.xMax,t.y);if(K5(n,i,e))return!0;if(K5(i,r,e))return!0;if(K5(r,o,e))return!0;if(K5(o,n,e))return!0;for(var a=0,s=e.length;a<s;++a)if(t.contains(e[a]))return!0;return!!(J5(n,e)||J5(i,e)||J5(r,e)||J5(o,e))},t8.rectCircle=function(t,e,n){var i=e.x,r=e.y,o=t.x,a=t.y,s=t.width,c=t.height,l=i,u=r;i<o?l=o:i>o+s&&(l=o+s),r<a?u=a:r>a+c&&(u=a+c);var h=i-l,_=r-u;return Math.sqrt(h*h+_*_)<=n},t8.polygonPolygon=function(t,e){var n,i;for(n=0,i=t.length;n<i;++n)if(K5(t[n],t[(n+1)%i],e))return!0;for(n=0,i=e.length;n<i;++n)if(J5(e[n],t))return!0;for(n=0,i=t.length;n<i;++n)if(J5(t[n],e))return!0;return!1},t8.circleCircle=function(t,e,n,i){return Xn.distance(t,n)<e+i},t8.polygonCircle=function(t,e,n){var i=e;if(J5(i,t))return!0;for(var r=0,o=t.length;r<o;r++)if(Q5(i,0===r?t[t.length-1]:t[r-1],t[r],!0)<n)return!0;return!1},t8.pointInPolygon=J5,t8.pointLineDistance=Q5,"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var e8,n8=function(t,e){return function(t,e){!function(t){function e(t){if(!t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];throw et(Error,n)}}function n(t,e){return void 0!==t?t:e}var i=1e37,r=1e-5,o=r*r,a=3.14159265359,s=2,c=8,l=.1,u=2,h=.008,_=2/180*a,f=2*h,d=8,p=32,m=1,v=.2,g=8/180*a,y=2,x=y*y,S=.5*a,A=S*S,C=.2,b=.75,T=-1,E=2147483647,w=.75,P=1,I=.25,R=.5,D=2,M=D*D,B=256,O=2.5,N=.5,L=.01,F=2/180*a;function z(){return null}function V(){}function k(){}var G=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=n}return t.prototype.toString=function(){return this.major+"."+this.minor+"."+this.revision},t}(),U=new G(2,3,2),H="master",j="fbf51801d80fc389d43dc46524520e89043b6faf";function W(t){return parseInt(t,10)}function q(t){return Math.abs(parseInt(t,10))}function X(t,e){for(var n=new Array(t),i=0;i<t;++i)n[i]=e(i);return n}function Y(t){for(var e=new Array(t),n=0;n<t;++n)e[n]=null;return e}function J(t,e){void 0===e&&(e=0);for(var n=new Array(t),i=0;i<t;++i)n[i]=e;return n}var Z=a/180,$=180/a,tt=2*a,nt=Math.abs;function it(t,e){return t<e?t:e}function rt(t,e){return t>e?t:e}function at(t,e,n){return t<e?e:t>n?n:t}function st(t,e){var n=t[0];t[0]=e[0],e[0]=n}var ct=isFinite;function lt(t){return t*t}function ut(t){return 1/Math.sqrt(t)}var ht=Math.sqrt,_t=Math.pow;function ft(t){return t*Z}function dt(t){return t*$}var pt=Math.cos,mt=Math.sin,vt=Math.acos,gt=Math.asin,yt=Math.atan2;function xt(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,1+((t|=t>>8&16777215)|t>>16&65535)}function St(t){return t>0&&0==(t&t-1)}function At(){return 2*Math.random()-1}function Ct(t,e){return(e-t)*Math.random()+t}var bt=function(){function t(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e[0]instanceof Float32Array){if(2!==e[0].length)throw new Error;this.data=e[0]}else{var i="number"==typeof e[0]?e[0]:0,r="number"==typeof e[1]?e[1]:0;this.data=new Float32Array([i,r])}}var e=t.prototype;return e.Clone=function(){return new t(this.x,this.y)},e.SetZero=function(){return this.x=0,this.y=0,this},e.Set=function(t,e){return this.x=t,this.y=e,this},e.Copy=function(t){return this.x=t.x,this.y=t.y,this},e.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},e.SelfAddXY=function(t,e){return this.x+=t,this.y+=e,this},e.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this},e.SelfSubXY=function(t,e){return this.x-=t,this.y-=e,this},e.SelfMul=function(t){return this.x*=t,this.y*=t,this},e.SelfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},e.SelfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},e.Dot=function(t){return this.x*t.x+this.y*t.y},e.Cross=function(t){return this.x*t.y-this.y*t.x},e.Length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},e.LengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},e.Normalize=function(){var t=this.Length();if(t>=r){var e=1/t;this.x*=e,this.y*=e}return t},e.SelfNormalize=function(){var t=this.Length();if(t>=r){var e=1/t;this.x*=e,this.y*=e}return this},e.SelfRotate=function(t){var e=Math.cos(t),n=Math.sin(t),i=this.x;return this.x=e*i-n*this.y,this.y=n*i+e*this.y,this},e.SelfRotateCosSin=function(t,e){var n=this.x;return this.x=t*n-e*this.y,this.y=e*n+t*this.y,this},e.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)},e.SelfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},e.SelfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},e.SelfMinV=function(t){return this.x=it(this.x,t.x),this.y=it(this.y,t.y),this},e.SelfMaxV=function(t){return this.x=rt(this.x,t.x),this.y=rt(this.y,t.y),this},e.SelfAbs=function(){return this.x=nt(this.x),this.y=nt(this.y),this},e.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this},e.SelfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},t.MakeArray=function(e){return X(e,(function(){return new t}))},t.AbsV=function(t,e){return e.x=nt(t.x),e.y=nt(t.y),e},t.MinV=function(t,e,n){return n.x=it(t.x,e.x),n.y=it(t.y,e.y),n},t.MaxV=function(t,e,n){return n.x=rt(t.x,e.x),n.y=rt(t.y,e.y),n},t.ClampV=function(t,e,n,i){return i.x=at(t.x,e.x,n.x),i.y=at(t.y,e.y,n.y),i},t.RotateV=function(t,e,n){var i=t.x,r=t.y,o=Math.cos(e),a=Math.sin(e);return n.x=o*i-a*r,n.y=a*i+o*r,n},t.DotVV=function(t,e){return t.x*e.x+t.y*e.y},t.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},t.CrossVS=function(t,e,n){var i=t.x;return n.x=e*t.y,n.y=-e*i,n},t.CrossVOne=function(t,e){var n=t.x;return e.x=t.y,e.y=-n,e},t.CrossSV=function(t,e,n){var i=e.x;return n.x=-t*e.y,n.y=t*i,n},t.CrossOneV=function(t,e){var n=t.x;return e.x=-t.y,e.y=n,e},t.AddVV=function(t,e,n){return n.x=t.x+e.x,n.y=t.y+e.y,n},t.SubVV=function(t,e,n){return n.x=t.x-e.x,n.y=t.y-e.y,n},t.MulSV=function(t,e,n){return n.x=e.x*t,n.y=e.y*t,n},t.MulVS=function(t,e,n){return n.x=t.x*e,n.y=t.y*e,n},t.AddVMulSV=function(t,e,n,i){return i.x=t.x+e*n.x,i.y=t.y+e*n.y,i},t.SubVMulSV=function(t,e,n,i){return i.x=t.x-e*n.x,i.y=t.y-e*n.y,i},t.AddVCrossSV=function(t,e,n,i){var r=n.x;return i.x=t.x-e*n.y,i.y=t.y+e*r,i},t.MidVV=function(t,e,n){return n.x=.5*(t.x+e.x),n.y=.5*(t.y+e.y),n},t.ExtVV=function(t,e,n){return n.x=.5*(e.x-t.x),n.y=.5*(e.y-t.y),n},t.IsEqualToV=function(t,e){return t.x===e.x&&t.y===e.y},t.DistanceVV=function(t,e){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.DistanceSquaredVV=function(t,e){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.NegV=function(t,e){return e.x=-t.x,e.y=-t.y,e},K(t,[{key:"x",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y",get:function(){return this.data[1]},set:function(t){this.data[1]=t}}]),t}();bt.ZERO=new bt(0,0),bt.UNITX=new bt(1,0),bt.UNITY=new bt(0,1),bt.s_t0=new bt,bt.s_t1=new bt,bt.s_t2=new bt,bt.s_t3=new bt;var Tt=new bt(0,0),Et=function(){function t(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e[0]instanceof Float32Array){if(3!==e[0].length)throw new Error;this.data=e[0]}else{var i="number"==typeof e[0]?e[0]:0,r="number"==typeof e[1]?e[1]:0,o="number"==typeof e[2]?e[2]:0;this.data=new Float32Array([i,r,o])}}var e=t.prototype;return e.Clone=function(){return new t(this.x,this.y,this.z)},e.SetZero=function(){return this.x=0,this.y=0,this.z=0,this},e.SetXYZ=function(t,e,n){return this.x=t,this.y=e,this.z=n,this},e.Copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},e.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},e.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},e.SelfAddXYZ=function(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this},e.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},e.SelfSubXYZ=function(t,e,n){return this.x-=t,this.y-=e,this.z-=n,this},e.SelfMul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.DotV3V3=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},t.CrossV3V3=function(t,e,n){var i=t.x,r=t.y,o=t.z,a=e.x,s=e.y,c=e.z;return n.x=r*c-o*s,n.y=o*a-i*c,n.z=i*s-r*a,n},K(t,[{key:"x",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"z",get:function(){return this.data[2]},set:function(t){this.data[2]=t}}]),t}();Et.ZERO=new Et(0,0,0),Et.s_t0=new Et;var wt=function(){function t(){this.data=new Float32Array([1,0,0,1]),this.ex=new bt(this.data.subarray(0,2)),this.ey=new bt(this.data.subarray(2,4))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},t.FromVV=function(e,n){return(new t).SetVV(e,n)},t.FromSSSS=function(e,n,i,r){return(new t).SetSSSS(e,n,i,r)},t.FromAngle=function(e){return(new t).SetAngle(e)},e.SetSSSS=function(t,e,n,i){return this.ex.Set(t,n),this.ey.Set(e,i),this},e.SetVV=function(t,e){return this.ex.Copy(t),this.ey.Copy(e),this},e.SetAngle=function(t){var e=Math.cos(t),n=Math.sin(t);return this.ex.Set(e,n),this.ey.Set(-n,e),this},e.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this},e.SetIdentity=function(){return this.ex.Set(1,0),this.ey.Set(0,1),this},e.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this},e.GetAngle=function(){return Math.atan2(this.ex.y,this.ex.x)},e.GetInverse=function(t){var e=this.ex.x,n=this.ey.x,i=this.ex.y,r=this.ey.y,o=e*r-n*i;return 0!==o&&(o=1/o),t.ex.x=o*r,t.ey.x=-o*n,t.ex.y=-o*i,t.ey.y=o*e,t},e.Solve=function(t,e,n){var i=this.ex.x,r=this.ey.x,o=this.ex.y,a=this.ey.y,s=i*a-r*o;return 0!==s&&(s=1/s),n.x=s*(a*t-r*e),n.y=s*(i*e-o*t),n},e.SelfAbs=function(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this},e.SelfInv=function(){return this.GetInverse(this),this},e.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this},e.SelfSubM=function(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this},t.AbsM=function(t,e){var n=t.ex,i=t.ey;return e.ex.x=nt(n.x),e.ex.y=nt(n.y),e.ey.x=nt(i.x),e.ey.y=nt(i.y),e},t.MulMV=function(t,e,n){var i=t.ex,r=t.ey,o=e.x,a=e.y;return n.x=i.x*o+r.x*a,n.y=i.y*o+r.y*a,n},t.MulTMV=function(t,e,n){var i=t.ex,r=t.ey,o=e.x,a=e.y;return n.x=i.x*o+i.y*a,n.y=r.x*o+r.y*a,n},t.AddMM=function(t,e,n){var i=t.ex,r=t.ey,o=e.ex,a=e.ey;return n.ex.x=i.x+o.x,n.ex.y=i.y+o.y,n.ey.x=r.x+a.x,n.ey.y=r.y+a.y,n},t.MulMM=function(t,e,n){var i=t.ex.x,r=t.ex.y,o=t.ey.x,a=t.ey.y,s=e.ex.x,c=e.ex.y,l=e.ey.x,u=e.ey.y;return n.ex.x=i*s+o*c,n.ex.y=r*s+a*c,n.ey.x=i*l+o*u,n.ey.y=r*l+a*u,n},t.MulTMM=function(t,e,n){var i=t.ex.x,r=t.ex.y,o=t.ey.x,a=t.ey.y,s=e.ex.x,c=e.ex.y,l=e.ey.x,u=e.ey.y;return n.ex.x=i*s+r*c,n.ex.y=o*s+a*c,n.ey.x=i*l+r*u,n.ey.y=o*l+a*u,n},t}();wt.IDENTITY=new wt;var Pt=function(){function t(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new Et(this.data.subarray(0,3)),this.ey=new Et(this.data.subarray(3,6)),this.ez=new Et(this.data.subarray(6,9))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.SetVVV=function(t,e,n){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(n),this},e.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this},e.SetIdentity=function(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this},e.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this},e.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this},e.Solve33=function(t,e,n,i){var r=this.ex.x,o=this.ex.y,a=this.ex.z,s=this.ey.x,c=this.ey.y,l=this.ey.z,u=this.ez.x,h=this.ez.y,_=this.ez.z,f=r*(c*_-l*h)+o*(l*u-s*_)+a*(s*h-c*u);return 0!==f&&(f=1/f),i.x=f*(t*(c*_-l*h)+e*(l*u-s*_)+n*(s*h-c*u)),i.y=f*(r*(e*_-n*h)+o*(n*u-t*_)+a*(t*h-e*u)),i.z=f*(r*(c*n-l*e)+o*(l*t-s*n)+a*(s*e-c*t)),i},e.Solve22=function(t,e,n){var i=this.ex.x,r=this.ey.x,o=this.ex.y,a=this.ey.y,s=i*a-r*o;return 0!==s&&(s=1/s),n.x=s*(a*t-r*e),n.y=s*(i*e-o*t),n},e.GetInverse22=function(t){var e=this.ex.x,n=this.ey.x,i=this.ex.y,r=this.ey.y,o=e*r-n*i;0!==o&&(o=1/o),t.ex.x=o*r,t.ey.x=-o*n,t.ex.z=0,t.ex.y=-o*i,t.ey.y=o*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},e.GetSymInverse33=function(t){var e=Et.DotV3V3(this.ex,Et.CrossV3V3(this.ey,this.ez,Et.s_t0));0!==e&&(e=1/e);var n=this.ex.x,i=this.ey.x,r=this.ez.x,o=this.ey.y,a=this.ez.y,s=this.ez.z;t.ex.x=e*(o*s-a*a),t.ex.y=e*(r*a-i*s),t.ex.z=e*(i*a-r*o),t.ey.x=t.ex.y,t.ey.y=e*(n*s-r*r),t.ey.z=e*(r*i-n*a),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(n*o-i*i)},t.MulM33V3=function(t,e,n){var i=e.x,r=e.y,o=e.z;return n.x=t.ex.x*i+t.ey.x*r+t.ez.x*o,n.y=t.ex.y*i+t.ey.y*r+t.ez.y*o,n.z=t.ex.z*i+t.ey.z*r+t.ez.z*o,n},t.MulM33XYZ=function(t,e,n,i,r){return r.x=t.ex.x*e+t.ey.x*n+t.ez.x*i,r.y=t.ex.y*e+t.ey.y*n+t.ez.y*i,r.z=t.ex.z*e+t.ey.z*n+t.ez.z*i,r},t.MulM33V2=function(t,e,n){var i=e.x,r=e.y;return n.x=t.ex.x*i+t.ey.x*r,n.y=t.ex.y*i+t.ey.y*r,n},t.MulM33XY=function(t,e,n,i){return i.x=t.ex.x*e+t.ey.x*n,i.y=t.ex.y*e+t.ey.y*n,i},t}();Pt.IDENTITY=new Pt;var It=function(){function t(t){void 0===t&&(t=0),this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.s=t.s,this.c=t.c,this},e.SetAngle=function(t){return this.s=Math.sin(t),this.c=Math.cos(t),this},e.SetIdentity=function(){return this.s=0,this.c=1,this},e.GetAngle=function(){return Math.atan2(this.s,this.c)},e.GetXAxis=function(t){return t.x=this.c,t.y=this.s,t},e.GetYAxis=function(t){return t.x=-this.s,t.y=this.c,t},t.MulRR=function(t,e,n){var i=t.c,r=t.s,o=e.c,a=e.s;return n.s=r*o+i*a,n.c=i*o-r*a,n},t.MulTRR=function(t,e,n){var i=t.c,r=t.s,o=e.c,a=e.s;return n.s=i*a-r*o,n.c=i*o+r*a,n},t.MulRV=function(t,e,n){var i=t.c,r=t.s,o=e.x,a=e.y;return n.x=i*o-r*a,n.y=r*o+i*a,n},t.MulTRV=function(t,e,n){var i=t.c,r=t.s,o=e.x,a=e.y;return n.x=i*o+r*a,n.y=-r*o+i*a,n},t}();It.IDENTITY=new It;var Rt=function(){function t(){this.p=new bt,this.q=new It}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.p.Copy(t.p),this.q.Copy(t.q),this},e.SetIdentity=function(){return this.p.SetZero(),this.q.SetIdentity(),this},e.SetPositionRotation=function(t,e){return this.p.Copy(t),this.q.Copy(e),this},e.SetPositionAngle=function(t,e){return this.p.Copy(t),this.q.SetAngle(e),this},e.SetPosition=function(t){return this.p.Copy(t),this},e.SetPositionXY=function(t,e){return this.p.Set(t,e),this},e.SetRotation=function(t){return this.q.Copy(t),this},e.SetRotationAngle=function(t){return this.q.SetAngle(t),this},e.GetPosition=function(){return this.p},e.GetRotation=function(){return this.q},e.GetRotationAngle=function(){return this.q.GetAngle()},e.GetAngle=function(){return this.q.GetAngle()},t.MulXV=function(t,e,n){var i=t.q.c,r=t.q.s,o=e.x,a=e.y;return n.x=i*o-r*a+t.p.x,n.y=r*o+i*a+t.p.y,n},t.MulTXV=function(t,e,n){var i=t.q.c,r=t.q.s,o=e.x-t.p.x,a=e.y-t.p.y;return n.x=i*o+r*a,n.y=-r*o+i*a,n},t.MulXX=function(t,e,n){return It.MulRR(t.q,e.q,n.q),bt.AddVV(It.MulRV(t.q,e.p,n.p),t.p,n.p),n},t.MulTXX=function(t,e,n){return It.MulTRR(t.q,e.q,n.q),It.MulTRV(t.q,bt.SubVV(e.p,t.p,n.p),n.p),n},t}();Rt.IDENTITY=new Rt;var Dt,Mt=function(){function t(){this.localCenter=new bt,this.c0=new bt,this.c=new bt,this.a0=0,this.a=0,this.alpha0=0}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this},e.GetTransform=function(t,e){var n=1-e;t.p.x=n*this.c0.x+e*this.c.x,t.p.y=n*this.c0.y+e*this.c.y;var i=n*this.a0+e*this.a;return t.q.SetAngle(i),t.p.SelfSub(It.MulRV(t.q,this.localCenter,bt.s_t0)),t},e.Advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0),n=1-e;this.c0.x=n*this.c0.x+e*this.c.x,this.c0.y=n*this.c0.y+e*this.c.y,this.a0=n*this.a0+e*this.a,this.alpha0=t},e.Normalize=function(){var t=tt*Math.floor(this.a0/tt);this.a0-=t,this.a-=t},t}(),Bt=function(){function t(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e[0]instanceof Float32Array){if(4!==e[0].length)throw new Error;this.data=e[0]}else{var i="number"==typeof e[0]?e[0]:.5,r="number"==typeof e[1]?e[1]:.5,o="number"==typeof e[2]?e[2]:.5,a="number"==typeof e[3]?e[3]:1;this.data=new Float32Array([i,r,o,a])}}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},e.IsEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},e.IsZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},e.Set=function(t,e,n,i){void 0===i&&(i=this.a),this.SetRGBA(t,e,n,i)},e.SetByteRGB=function(t,e,n){return this.r=t/255,this.g=e/255,this.b=n/255,this},e.SetByteRGBA=function(t,e,n,i){return this.r=t/255,this.g=e/255,this.b=n/255,this.a=i/255,this},e.SetRGB=function(t,e,n){return this.r=t,this.g=e,this.b=n,this},e.SetRGBA=function(t,e,n,i){return this.r=t,this.g=e,this.b=n,this.a=i,this},e.SelfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},e.Add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},e.SelfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},e.Sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},e.SelfMul=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},e.Mul=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e},e.Mix=function(e,n){t.MixColors(this,e,n)},t.MixColors=function(t,e,n){var i=n*(e.r-t.r),r=n*(e.g-t.g),o=n*(e.b-t.b),a=n*(e.a-t.a);t.r+=i,t.g+=r,t.b+=o,t.a+=a,e.r-=i,e.g-=r,e.b-=o,e.a-=a},e.MakeStyleString=function(e){return void 0===e&&(e=this.a),t.MakeStyleString(this.r,this.g,this.b,e)},t.MakeStyleString=function(t,e,n,i){return void 0===i&&(i=1),t*=255,e*=255,n*=255,i<1?"rgba("+t+","+e+","+n+","+i+")":"rgb("+t+","+e+","+n+")"},K(t,[{key:"r",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"g",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"b",get:function(){return this.data[2]},set:function(t){this.data[2]=t}},{key:"a",get:function(){return this.data[3]},set:function(t){this.data[3]=t}}]),t}();Bt.ZERO=new Bt(0,0,0,0),Bt.RED=new Bt(1,0,0),Bt.GREEN=new Bt(0,1,0),Bt.BLUE=new Bt(0,0,1),(Dt=t.b2DrawFlags||(t.b2DrawFlags={}))[Dt.e_none=0]="e_none",Dt[Dt.e_shapeBit=1]="e_shapeBit",Dt[Dt.e_jointBit=2]="e_jointBit",Dt[Dt.e_aabbBit=4]="e_aabbBit",Dt[Dt.e_pairBit=8]="e_pairBit",Dt[Dt.e_centerOfMassBit=16]="e_centerOfMassBit",Dt[Dt.e_particleBit=32]="e_particleBit",Dt[Dt.e_controllerBit=64]="e_controllerBit",Dt[Dt.e_all=63]="e_all";var Ot=function(){function t(){this.m_drawFlags=0}var e=t.prototype;return e.SetFlags=function(t){this.m_drawFlags=t},e.GetFlags=function(){return this.m_drawFlags},e.AppendFlags=function(t){this.m_drawFlags|=t},e.ClearFlags=function(t){this.m_drawFlags&=~t},t}(),Nt=function(){function t(){this.m_start=Date.now()}var e=t.prototype;return e.Reset=function(){return this.m_start=Date.now(),this},e.GetMilliseconds=function(){return Date.now()-this.m_start},t}(),Lt=function(){function t(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}var e=t.prototype;return e.GetCount=function(){return this.m_count},e.GetMinCount=function(){return this.m_min_count},e.GetMaxCount=function(){return this.m_max_count},e.ResetCount=function(){var t=this.m_count;return this.m_count=0,t},e.ResetMinCount=function(){this.m_min_count=0},e.ResetMaxCount=function(){this.m_max_count=0},e.Increment=function(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)},e.Decrement=function(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)},t}(),Ft=function(){function t(t){this.m_stack=[],this.m_count=0,this.m_stack=X(t,(function(){return null})),this.m_count=0}var e=t.prototype;return e.Reset=function(){return this.m_count=0,this},e.Push=function(t){this.m_stack[this.m_count]=t,this.m_count++},e.Pop=function(){this.m_count--;var t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===t)throw new Error;return t},e.GetCount=function(){return this.m_count},t}(),zt=function(){},Vt=function(){},kt=function(){function t(){this.m_buffer=bt.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}var e=t.prototype;return e.Copy=function(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this},e.Reset=function(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this},e.SetShape=function(t,e){t.SetupDistanceProxy(this,e)},e.SetVerticesRadius=function(t,e,n){this.m_vertices=t,this.m_count=e,this.m_radius=n},e.GetSupport=function(t){for(var e=0,n=bt.DotVV(this.m_vertices[0],t),i=1;i<this.m_count;++i){var r=bt.DotVV(this.m_vertices[i],t);r>n&&(e=i,n=r)}return e},e.GetSupportVertex=function(t){for(var e=0,n=bt.DotVV(this.m_vertices[0],t),i=1;i<this.m_count;++i){var r=bt.DotVV(this.m_vertices[i],t);r>n&&(e=i,n=r)}return this.m_vertices[e]},e.GetVertexCount=function(){return this.m_count},e.GetVertex=function(t){return this.m_vertices[t]},t}(),Gt=function(){function t(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}return t.prototype.Reset=function(){return this.metric=0,this.count=0,this},t}(),Ut=function(){function t(){this.proxyA=new kt,this.proxyB=new kt,this.transformA=new Rt,this.transformB=new Rt,this.useRadii=!1}return t.prototype.Reset=function(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this},t}(),Ht=function(){function t(){this.pointA=new bt,this.pointB=new bt,this.distance=0,this.iterations=0}return t.prototype.Reset=function(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this},t}(),jt=function(){this.proxyA=new kt,this.proxyB=new kt,this.transformA=new Rt,this.transformB=new Rt,this.translationB=new bt},Wt=function(){this.point=new bt,this.normal=new bt,this.lambda=0,this.iterations=0};function qt(){t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0}t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0;var Xt=function(){function t(){this.wA=new bt,this.wB=new bt,this.w=new bt,this.a=0,this.indexA=0,this.indexB=0}return t.prototype.Copy=function(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this},t}(),Yt=function(){function t(){this.m_v1=new Xt,this.m_v2=new Xt,this.m_v3=new Xt,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}var e=t.prototype;return e.ReadCache=function(t,e,n,i,o){this.m_count=t.count;for(var a=this.m_vertices,s=0;s<this.m_count;++s){var c=a[s];c.indexA=t.indexA[s],c.indexB=t.indexB[s];var l=e.GetVertex(c.indexA),u=i.GetVertex(c.indexB);Rt.MulXV(n,l,c.wA),Rt.MulXV(o,u,c.wB),bt.SubVV(c.wB,c.wA,c.w),c.a=0}if(this.m_count>1){var h=t.metric,_=this.GetMetric();(_<.5*h||2*h<_||_<r)&&(this.m_count=0)}if(0===this.m_count){var f=a[0];f.indexA=0,f.indexB=0;var d=e.GetVertex(0),p=i.GetVertex(0);Rt.MulXV(n,d,f.wA),Rt.MulXV(o,p,f.wB),bt.SubVV(f.wB,f.wA,f.w),f.a=1,this.m_count=1}},e.WriteCache=function(t){t.metric=this.GetMetric(),t.count=this.m_count;for(var e=this.m_vertices,n=0;n<this.m_count;++n)t.indexA[n]=e[n].indexA,t.indexB[n]=e[n].indexB},e.GetSearchDirection=function(t){switch(this.m_count){case 1:return bt.NegV(this.m_v1.w,t);case 2:var e=bt.SubVV(this.m_v2.w,this.m_v1.w,t);return bt.CrossVV(e,bt.NegV(this.m_v1.w,bt.s_t0))>0?bt.CrossOneV(e,t):bt.CrossVOne(e,t);default:return t.SetZero()}},e.GetClosestPoint=function(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return t.SetZero()}},e.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},e.GetMetric=function(){switch(this.m_count){case 0:case 1:return 0;case 2:return bt.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return bt.CrossVV(bt.SubVV(this.m_v2.w,this.m_v1.w,bt.s_t0),bt.SubVV(this.m_v3.w,this.m_v1.w,bt.s_t1));default:return 0}},e.Solve2=function(){var e=this.m_v1.w,n=this.m_v2.w,i=bt.SubVV(n,e,t.s_e12),r=-bt.DotVV(e,i);if(r<=0)return this.m_v1.a=1,void(this.m_count=1);var o=bt.DotVV(n,i);if(o<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);var a=1/(o+r);this.m_v1.a=o*a,this.m_v2.a=r*a,this.m_count=2},e.Solve3=function(){var e=this.m_v1.w,n=this.m_v2.w,i=this.m_v3.w,r=bt.SubVV(n,e,t.s_e12),o=bt.DotVV(e,r),a=bt.DotVV(n,r),s=-o,c=bt.SubVV(i,e,t.s_e13),l=bt.DotVV(e,c),u=bt.DotVV(i,c),h=-l,_=bt.SubVV(i,n,t.s_e23),f=bt.DotVV(n,_),d=bt.DotVV(i,_),p=-f,m=bt.CrossVV(r,c),v=m*bt.CrossVV(n,i),g=m*bt.CrossVV(i,e),y=m*bt.CrossVV(e,n);if(s<=0&&h<=0)return this.m_v1.a=1,void(this.m_count=1);if(a>0&&s>0&&y<=0){var x=1/(a+s);return this.m_v1.a=a*x,this.m_v2.a=s*x,void(this.m_count=2)}if(u>0&&h>0&&g<=0){var S=1/(u+h);return this.m_v1.a=u*S,this.m_v3.a=h*S,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(a<=0&&p<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(u<=0&&d<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(d>0&&p>0&&v<=0){var A=1/(d+p);return this.m_v2.a=d*A,this.m_v3.a=p*A,this.m_count=2,void this.m_v1.Copy(this.m_v3)}var C=1/(v+g+y);this.m_v1.a=v*C,this.m_v2.a=g*C,this.m_v3.a=y*C,this.m_count=3},t}();Yt.s_e12=new bt,Yt.s_e13=new bt,Yt.s_e23=new bt;var Kt=new Yt,Jt=[0,0,0],Qt=[0,0,0],Zt=new bt,$t=new bt,te=new bt,ee=new bt,ne=new bt;function ie(e,n,i){++t.b2_gjkCalls;var a=i.proxyA,s=i.proxyB,c=i.transformA,l=i.transformB,u=Kt;u.ReadCache(n,a,c,s,l);for(var h=u.m_vertices,_=20,f=Jt,d=Qt,p=0,m=0;m<_;){p=u.m_count;for(var v=0;v<p;++v)f[v]=h[v].indexA,d[v]=h[v].indexB;switch(u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3()}if(3===u.m_count)break;var g=u.GetSearchDirection($t);if(g.LengthSquared()<o)break;var y=h[u.m_count];y.indexA=a.GetSupport(It.MulTRV(c.q,bt.NegV(g,bt.s_t0),ee)),Rt.MulXV(c,a.GetVertex(y.indexA),y.wA),y.indexB=s.GetSupport(It.MulTRV(l.q,g,ne)),Rt.MulXV(l,s.GetVertex(y.indexB),y.wB),bt.SubVV(y.wB,y.wA,y.w),++m,++t.b2_gjkIters;for(var x=!1,S=0;S<p;++S)if(y.indexA===f[S]&&y.indexB===d[S]){x=!0;break}if(x)break;++u.m_count}if(t.b2_gjkMaxIters=rt(t.b2_gjkMaxIters,m),u.GetWitnessPoints(e.pointA,e.pointB),e.distance=bt.DistanceVV(e.pointA,e.pointB),e.iterations=m,u.WriteCache(n),i.useRadii){var A=a.m_radius,C=s.m_radius;if(e.distance>A+C&&e.distance>r){e.distance-=A+C;var b=bt.SubVV(e.pointB,e.pointA,te);b.Normalize(),e.pointA.SelfMulAdd(A,b),e.pointB.SelfMulSub(C,b)}else{var T=bt.MidVV(e.pointA,e.pointB,Zt);e.pointA.Copy(T),e.pointB.Copy(T),e.distance=0}}}var re,oe=new bt,ae=new Yt,se=new bt,ce=new bt,le=new bt,ue=new bt,he=new bt,_e=new bt;function fe(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();var n=e.proxyA,i=e.proxyB,r=rt(n.m_radius,f)+rt(i.m_radius,f),o=e.transformA,a=e.transformB,s=e.translationB,c=oe.Set(0,0),l=0,u=ae;u.m_count=0;for(var _=u.m_vertices,d=n.GetSupport(It.MulTRV(o.q,bt.NegV(s,bt.s_t1),bt.s_t0)),p=Rt.MulXV(o,n.GetVertex(d),se),m=i.GetSupport(It.MulTRV(a.q,s,bt.s_t0)),v=Rt.MulXV(a,i.GetVertex(m),ce),g=bt.SubVV(p,v,le),y=rt(f,r-f),x=.5*h,S=20,A=0;A<S&&nt(g.Length()-y)>x;){t.iterations+=1,d=n.GetSupport(It.MulTRV(o.q,bt.NegV(g,bt.s_t1),bt.s_t0)),p=Rt.MulXV(o,n.GetVertex(d),se),m=i.GetSupport(It.MulTRV(a.q,g,bt.s_t0)),v=Rt.MulXV(a,i.GetVertex(m),ce);var C=bt.SubVV(p,v,ue);g.Normalize();var b=bt.DotVV(g,C),T=bt.DotVV(g,s);if(b-y>l*T){if(T<=0)return!1;if((l=(b-y)/T)>1)return!1;c.Copy(g).SelfNeg(),u.m_count=0}var E=_[u.m_count];switch(E.indexA=m,E.wA.Copy(v).SelfMulAdd(l,s),E.indexB=d,E.wB.Copy(p),E.w.Copy(E.wB).SelfSub(E.wA),E.a=1,u.m_count+=1,u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3()}if(3===u.m_count)return!1;u.GetClosestPoint(g),++A}var w=he,P=_e;return u.GetWitnessPoints(w,P),g.LengthSquared()>0&&(c.Copy(g).SelfNeg(),c.Normalize()),t.normal.Copy(c),t.lambda=l,t.iterations=A,!0}(re=t.b2ContactFeatureType||(t.b2ContactFeatureType={}))[re.e_vertex=0]="e_vertex",re[re.e_face=1]="e_face";var de,pe=function(){function t(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}return K(t,[{key:"key",get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}},{key:"indexA",get:function(){return this._indexA},set:function(t){this._indexA=t,this._key_invalid=!0}},{key:"indexB",get:function(){return this._indexB},set:function(t){this._indexB=t,this._key_invalid=!0}},{key:"typeA",get:function(){return this._typeA},set:function(t){this._typeA=t,this._key_invalid=!0}},{key:"typeB",get:function(){return this._typeB},set:function(t){this._typeB=t,this._key_invalid=!0}}]),t}(),me=function(){function t(){this.cf=new pe}var e=t.prototype;return e.Copy=function(t){return this.key=t.key,this},e.Clone=function(){return(new t).Copy(this)},K(t,[{key:"key",get:function(){return this.cf.key},set:function(t){this.cf.key=t}}]),t}(),ve=function(){function t(){this.localPoint=new bt,this.normalImpulse=0,this.tangentImpulse=0,this.id=new me}t.MakeArray=function(e){return X(e,(function(){return new t}))};var e=t.prototype;return e.Reset=function(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0},e.Copy=function(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this},t}();(de=t.b2ManifoldType||(t.b2ManifoldType={}))[de.e_unknown=-1]="e_unknown",de[de.e_circles=0]="e_circles",de[de.e_faceA=1]="e_faceA",de[de.e_faceB=2]="e_faceB";var ge,ye=function(){function e(){this.points=ve.MakeArray(s),this.localNormal=new bt,this.localPoint=new bt,this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}var n=e.prototype;return n.Reset=function(){for(var e=0;e<s;++e)this.points[e].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=t.b2ManifoldType.e_unknown,this.pointCount=0},n.Copy=function(t){this.pointCount=t.pointCount;for(var e=0;e<s;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this},n.Clone=function(){return(new e).Copy(this)},e}(),xe=function(){function e(){this.normal=new bt,this.points=bt.MakeArray(s),this.separations=J(s)}return e.prototype.Initialize=function(n,i,r,a,s){if(0!==n.pointCount)switch(n.type){case t.b2ManifoldType.e_circles:this.normal.Set(1,0);var c=Rt.MulXV(i,n.localPoint,e.Initialize_s_pointA),l=Rt.MulXV(a,n.points[0].localPoint,e.Initialize_s_pointB);bt.DistanceSquaredVV(c,l)>o&&bt.SubVV(l,c,this.normal).SelfNormalize();var u=bt.AddVMulSV(c,r,this.normal,e.Initialize_s_cA),h=bt.SubVMulSV(l,s,this.normal,e.Initialize_s_cB);bt.MidVV(u,h,this.points[0]),this.separations[0]=bt.DotVV(bt.SubVV(h,u,bt.s_t0),this.normal);break;case t.b2ManifoldType.e_faceA:It.MulRV(i.q,n.localNormal,this.normal);for(var _=Rt.MulXV(i,n.localPoint,e.Initialize_s_planePoint),f=0;f<n.pointCount;++f){var d=Rt.MulXV(a,n.points[f].localPoint,e.Initialize_s_clipPoint),p=r-bt.DotVV(bt.SubVV(d,_,bt.s_t0),this.normal),m=bt.AddVMulSV(d,p,this.normal,e.Initialize_s_cA),v=bt.SubVMulSV(d,s,this.normal,e.Initialize_s_cB);bt.MidVV(m,v,this.points[f]),this.separations[f]=bt.DotVV(bt.SubVV(v,m,bt.s_t0),this.normal)}break;case t.b2ManifoldType.e_faceB:It.MulRV(a.q,n.localNormal,this.normal);for(var g=Rt.MulXV(a,n.localPoint,e.Initialize_s_planePoint),y=0;y<n.pointCount;++y){var x=Rt.MulXV(i,n.points[y].localPoint,e.Initialize_s_clipPoint),S=s-bt.DotVV(bt.SubVV(x,g,bt.s_t0),this.normal),A=bt.AddVMulSV(x,S,this.normal,e.Initialize_s_cB),C=bt.SubVMulSV(x,r,this.normal,e.Initialize_s_cA);bt.MidVV(C,A,this.points[y]),this.separations[y]=bt.DotVV(bt.SubVV(C,A,bt.s_t0),this.normal)}this.normal.SelfNeg()}},e}();function Se(e,n,i,r){var o;for(o=0;o<i.pointCount;++o){var a=i.points[o].id.key;e[o]=t.b2PointState.b2_removeState;for(var c=0,l=r.pointCount;c<l;++c)if(r.points[c].id.key===a){e[o]=t.b2PointState.b2_persistState;break}}for(;o<s;++o)e[o]=t.b2PointState.b2_nullState;for(o=0;o<r.pointCount;++o){var u=r.points[o].id.key;n[o]=t.b2PointState.b2_addState;for(var h=0,_=i.pointCount;h<_;++h)if(i.points[h].id.key===u){n[o]=t.b2PointState.b2_persistState;break}}for(;o<s;++o)n[o]=t.b2PointState.b2_nullState}xe.Initialize_s_pointA=new bt,xe.Initialize_s_pointB=new bt,xe.Initialize_s_cA=new bt,xe.Initialize_s_cB=new bt,xe.Initialize_s_planePoint=new bt,xe.Initialize_s_clipPoint=new bt,(ge=t.b2PointState||(t.b2PointState={}))[ge.b2_nullState=0]="b2_nullState",ge[ge.b2_addState=1]="b2_addState",ge[ge.b2_persistState=2]="b2_persistState",ge[ge.b2_removeState=3]="b2_removeState";var Ae=function(){function t(){this.v=new bt,this.id=new me}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t.prototype.Copy=function(t){return this.v.Copy(t.v),this.id.Copy(t.id),this},t}(),Ce=function(){function t(){this.p1=new bt,this.p2=new bt,this.maxFraction=1}return t.prototype.Copy=function(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this},t}(),be=function(){function t(){this.normal=new bt,this.fraction=0}return t.prototype.Copy=function(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this},t}(),Te=function(){function t(){this.lowerBound=new bt,this.upperBound=new bt,this.m_cache_center=new bt,this.m_cache_extent=new bt}var e=t.prototype;return e.Copy=function(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this},e.IsValid=function(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)},e.GetCenter=function(){return bt.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)},e.GetExtents=function(){return bt.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)},e.GetPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))},e.Combine1=function(t){return this.lowerBound.x=it(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=it(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=rt(this.upperBound.x,t.upperBound.x),this.upperBound.y=rt(this.upperBound.y,t.upperBound.y),this},e.Combine2=function(t,e){return this.lowerBound.x=it(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=it(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=rt(t.upperBound.x,e.upperBound.x),this.upperBound.y=rt(t.upperBound.y,e.upperBound.y),this},t.Combine=function(t,e,n){return n.Combine2(t,e),n},e.Contains=function(t){return!(this.lowerBound.x<=t.lowerBound.x||this.lowerBound.y<=t.lowerBound.y||t.upperBound.x<=this.upperBound.x||t.upperBound.y<=this.upperBound.y)},e.RayCast=function(t,e){var n=-i,o=i,a=e.p1.x,s=e.p1.y,c=e.p2.x-e.p1.x,l=e.p2.y-e.p1.y,u=nt(c),h=nt(l),_=t.normal;if(u<r){if(a<this.lowerBound.x||this.upperBound.x<a)return!1}else{var f=1/c,d=(this.lowerBound.x-a)*f,p=(this.upperBound.x-a)*f,m=-1;if(d>p){var v=d;d=p,p=v,m=1}if(d>n&&(_.x=m,_.y=0,n=d),n>(o=it(o,p)))return!1}if(h<r){if(s<this.lowerBound.y||this.upperBound.y<s)return!1}else{var g=1/l,y=(this.lowerBound.y-s)*g,x=(this.upperBound.y-s)*g,S=-1;if(y>x){var A=y;y=x,x=A,S=1}if(y>n&&(_.x=0,_.y=S,n=y),n>(o=it(o,x)))return!1}return!(n<0||e.maxFraction<n||(t.fraction=n,0))},e.TestContain=function(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)},e.TestOverlap=function(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)},t}();function Ee(t,e){return!(t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y||e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y)}function we(e,n,i,r,o){var a=0,s=n[0],c=n[1],l=bt.DotVV(i,s.v)-r,u=bt.DotVV(i,c.v)-r;if(l<=0&&e[a++].Copy(s),u<=0&&e[a++].Copy(c),l*u<0){var h=l/(l-u),_=e[a].v;_.x=s.v.x+h*(c.v.x-s.v.x),_.y=s.v.y+h*(c.v.y-s.v.y);var f=e[a].id;f.cf.indexA=o,f.cf.indexB=s.id.cf.indexB,f.cf.typeA=t.b2ContactFeatureType.e_vertex,f.cf.typeB=t.b2ContactFeatureType.e_face,++a}return a}var Pe=new Ut,Ie=new Gt,Re=new Ht;function De(t,e,n,i,o,a){var s=Pe.Reset();s.proxyA.SetShape(t,e),s.proxyB.SetShape(n,i),s.transformA.Copy(o),s.transformB.Copy(a),s.useRadii=!0;var c=Ie.Reset();c.count=0;var l=Re.Reset();return ie(l,c,s),l.distance<10*r}function Me(t){if(null===t)throw new Error;return t}var Be=function(){function t(t){void 0===t&&(t=0),this.m_id=0,this.aabb=new Te,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}var e=t.prototype;return e.Reset=function(){this._userData=null},e.IsLeaf=function(){return null===this.child1},K(t,[{key:"userData",get:function(){if(null===this._userData)throw new Error;return this._userData},set:function(t){if(null!==this._userData)throw new Error;this._userData=t}}]),t}(),Oe=function(){function t(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new Ft(256)}var e=t.prototype;return e.Query=function(t,e){var n=this.m_stack.Reset();for(n.Push(this.m_root);n.GetCount()>0;){var i=n.Pop();if(null!==i&&i.aabb.TestOverlap(t))if(i.IsLeaf()){if(!e(i))return}else n.Push(i.child1),n.Push(i.child2)}},e.QueryPoint=function(t,e){var n=this.m_stack.Reset();for(n.Push(this.m_root);n.GetCount()>0;){var i=n.Pop();if(null!==i&&i.aabb.TestContain(t))if(i.IsLeaf()){if(!e(i))return}else n.Push(i.child1),n.Push(i.child2)}},e.RayCast=function(e,n){var i=e.p1,r=e.p2,o=bt.SubVV(r,i,t.s_r);o.Normalize();var a=bt.CrossOneV(o,t.s_v),s=bt.AbsV(a,t.s_abs_v),c=e.maxFraction,l=t.s_segmentAABB,u=i.x+c*(r.x-i.x),h=i.y+c*(r.y-i.y);l.lowerBound.x=it(i.x,u),l.lowerBound.y=it(i.y,h),l.upperBound.x=rt(i.x,u),l.upperBound.y=rt(i.y,h);var _=this.m_stack.Reset();for(_.Push(this.m_root);_.GetCount()>0;){var f=_.Pop();if(null!==f&&Ee(f.aabb,l)){var d=f.aabb.GetCenter(),p=f.aabb.GetExtents();if(!(nt(bt.DotVV(a,bt.SubVV(i,d,bt.s_t0)))-bt.DotVV(s,p)>0))if(f.IsLeaf()){var m=t.s_subInput;m.p1.Copy(e.p1),m.p2.Copy(e.p2),m.maxFraction=c;var v=n(m,f);if(0===v)return;v>0&&(c=v,u=i.x+c*(r.x-i.x),h=i.y+c*(r.y-i.y),l.lowerBound.x=it(i.x,u),l.lowerBound.y=it(i.y,h),l.upperBound.x=rt(i.x,u),l.upperBound.y=rt(i.y,h))}else _.Push(f.child1),_.Push(f.child2)}}},e.AllocateNode=function(){if(null!==this.m_freeList){var e=this.m_freeList;return this.m_freeList=e.parent,e.parent=null,e.child1=null,e.child2=null,e.height=0,e}return new Be(t.s_node_id++)},e.FreeNode=function(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t},e.CreateProxy=function(t,e){var n=this.AllocateNode(),i=l,r=l;return n.aabb.lowerBound.x=t.lowerBound.x-i,n.aabb.lowerBound.y=t.lowerBound.y-r,n.aabb.upperBound.x=t.upperBound.x+i,n.aabb.upperBound.y=t.upperBound.y+r,n.userData=e,n.height=0,this.InsertLeaf(n),n},e.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},e.MoveProxy=function(t,e,n){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);var i=l,r=l;t.aabb.lowerBound.x=e.lowerBound.x-i,t.aabb.lowerBound.y=e.lowerBound.y-r,t.aabb.upperBound.x=e.upperBound.x+i,t.aabb.upperBound.y=e.upperBound.y+r;var o=u*n.x,a=u*n.y;return o<0?t.aabb.lowerBound.x+=o:t.aabb.upperBound.x+=o,a<0?t.aabb.lowerBound.y+=a:t.aabb.upperBound.y+=a,this.InsertLeaf(t),!0},e.InsertLeaf=function(e){if(++this.m_insertionCount,null===this.m_root)return this.m_root=e,void(this.m_root.parent=null);for(var n=e.aabb,i=this.m_root;!i.IsLeaf();){var r=Me(i.child1),o=Me(i.child2),a=i.aabb.GetPerimeter(),s=t.s_combinedAABB;s.Combine2(i.aabb,n);var c=s.GetPerimeter(),l=2*c,u=2*(c-a),h=void 0,_=t.s_aabb,f=void 0;r.IsLeaf()?(_.Combine2(n,r.aabb),h=_.GetPerimeter()+u):(_.Combine2(n,r.aabb),f=r.aabb.GetPerimeter(),h=_.GetPerimeter()-f+u);var d=void 0;if(o.IsLeaf()?(_.Combine2(n,o.aabb),d=_.GetPerimeter()+u):(_.Combine2(n,o.aabb),f=o.aabb.GetPerimeter(),d=_.GetPerimeter()-f+u),l<h&&l<d)break;i=h<d?r:o}var p=i.parent,m=this.AllocateNode();m.parent=p,m.aabb.Combine2(n,i.aabb),m.height=i.height+1,null!==p?(p.child1===i?p.child1=m:p.child2=m,m.child1=i,m.child2=e,i.parent=m,e.parent=m):(m.child1=i,m.child2=e,i.parent=m,e.parent=m,this.m_root=m);for(var v=e.parent;null!==v;){var g=Me((v=this.Balance(v)).child1),y=Me(v.child2);v.height=1+rt(g.height,y.height),v.aabb.Combine2(g.aabb,y.aabb),v=v.parent}},e.RemoveLeaf=function(t){if(t!==this.m_root){var e=Me(t.parent),n=e&&e.parent,i=Me(e.child1===t?e.child2:e.child1);if(null!==n){n.child1===e?n.child1=i:n.child2=i,i.parent=n,this.FreeNode(e);for(var r=n;null!==r;){var o=Me((r=this.Balance(r)).child1),a=Me(r.child2);r.aabb.Combine2(o.aabb,a.aabb),r.height=1+rt(o.height,a.height),r=r.parent}}else this.m_root=i,i.parent=null,this.FreeNode(e)}else this.m_root=null},e.Balance=function(t){if(t.IsLeaf()||t.height<2)return t;var e=Me(t.child1),n=Me(t.child2),i=n.height-e.height;if(i>1){var r=Me(n.child1),o=Me(n.child2);return n.child1=t,n.parent=t.parent,t.parent=n,null!==n.parent?n.parent.child1===t?n.parent.child1=n:n.parent.child2=n:this.m_root=n,r.height>o.height?(n.child2=r,t.child2=o,o.parent=t,t.aabb.Combine2(e.aabb,o.aabb),n.aabb.Combine2(t.aabb,r.aabb),t.height=1+rt(e.height,o.height),n.height=1+rt(t.height,r.height)):(n.child2=o,t.child2=r,r.parent=t,t.aabb.Combine2(e.aabb,r.aabb),n.aabb.Combine2(t.aabb,o.aabb),t.height=1+rt(e.height,r.height),n.height=1+rt(t.height,o.height)),n}if(i<-1){var a=Me(e.child1),s=Me(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,a.height>s.height?(e.child2=a,t.child1=s,s.parent=t,t.aabb.Combine2(n.aabb,s.aabb),e.aabb.Combine2(t.aabb,a.aabb),t.height=1+rt(n.height,s.height),e.height=1+rt(t.height,a.height)):(e.child2=s,t.child1=a,a.parent=t,t.aabb.Combine2(n.aabb,a.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+rt(n.height,a.height),e.height=1+rt(t.height,s.height)),e}return t},e.GetHeight=function(){return null===this.m_root?0:this.m_root.height},t.GetAreaNode=function(e){if(null===e)return 0;if(e.IsLeaf())return 0;var n=e.aabb.GetPerimeter();return(n+=t.GetAreaNode(e.child1))+t.GetAreaNode(e.child2)},e.GetAreaRatio=function(){if(null===this.m_root)return 0;var e=this.m_root.aabb.GetPerimeter();return t.GetAreaNode(this.m_root)/e},t.ComputeHeightNode=function(e){return null===e||e.IsLeaf()?0:1+rt(t.ComputeHeightNode(e.child1),t.ComputeHeightNode(e.child2))},e.ComputeHeight=function(){return t.ComputeHeightNode(this.m_root)},e.ValidateStructure=function(t){if(null!==t&&(this.m_root,!t.IsLeaf())){var e=Me(t.child1),n=Me(t.child2);this.ValidateStructure(e),this.ValidateStructure(n)}},e.ValidateMetrics=function(e){if(null!==e&&!e.IsLeaf()){var n=Me(e.child1),i=Me(e.child2);t.s_aabb.Combine2(n.aabb,i.aabb),this.ValidateMetrics(n),this.ValidateMetrics(i)}},e.Validate=function(){},t.GetMaxBalanceNode=function(t,e){if(null===t)return e;if(t.height<=1)return e;var n=Me(t.child1),i=Me(t.child2);return rt(e,nt(i.height-n.height))},e.GetMaxBalance=function(){return t.GetMaxBalanceNode(this.m_root,0)},e.RebuildBottomUp=function(){this.Validate()},t.ShiftOriginNode=function(e,n){if(null!==e&&!(e.height<=1)){var i=e.child1,r=e.child2;t.ShiftOriginNode(i,n),t.ShiftOriginNode(r,n),e.aabb.lowerBound.SelfSub(n),e.aabb.upperBound.SelfSub(n)}},e.ShiftOrigin=function(e){t.ShiftOriginNode(this.m_root,e)},t}();function Ne(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function Le(t,e){return t<e}function Fe(t,e,n,i){void 0===e&&(e=0),void 0===n&&(n=t.length-e),void 0===i&&(i=Le);for(var r=e,o=[],a=0;;){for(;r+1<n;n++){var s=t[r+Math.floor(Math.random()*(n-r))];o[a++]=n;for(var c=r-1;;){for(;i(t[++c],s););for(;i(s,t[--n]););if(c>=n)break;Ne(t,c,n)}}if(0===a)break;r=n,n=o[--a]}return t}Oe.s_r=new bt,Oe.s_v=new bt,Oe.s_abs_v=new bt,Oe.s_segmentAABB=new Te,Oe.s_subInput=new Ce,Oe.s_combinedAABB=new Te,Oe.s_aabb=new Te,Oe.s_node_id=0;var ze=function(t,e){this.proxyA=t,this.proxyB=e},Ve=function(){function t(){this.m_tree=new Oe,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}var e=t.prototype;return e.CreateProxy=function(t,e){var n=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(n),n},e.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},e.MoveProxy=function(t,e,n){this.m_tree.MoveProxy(t,e,n)&&this.BufferMove(t)},e.TouchProxy=function(t){this.BufferMove(t)},e.GetProxyCount=function(){return this.m_proxyCount},e.UpdatePairs=function(t){var e=this;this.m_pairCount=0;for(var n=function(t){var n=e.m_moveBuffer[t];if(null===n)return"continue";var i=n.aabb;e.m_tree.Query(i,(function(t){if(t.m_id===n.m_id)return!0;var i,r;if(t.m_id<n.m_id?(i=t,r=n):(i=n,r=t),e.m_pairCount===e.m_pairBuffer.length)e.m_pairBuffer[e.m_pairCount]=new ze(i,r);else{var o=e.m_pairBuffer[e.m_pairCount];o.proxyA=i,o.proxyB=r}return++e.m_pairCount,!0}))},i=0;i<this.m_moveCount;++i)n(i);this.m_moveCount=0,Fe(this.m_pairBuffer,0,this.m_pairCount,ke);for(var r=0;r<this.m_pairCount;){var o=this.m_pairBuffer[r];for(t(o.proxyA.userData,o.proxyB.userData),++r;r<this.m_pairCount;){var a=this.m_pairBuffer[r];if(a.proxyA.m_id!==o.proxyA.m_id||a.proxyB.m_id!==o.proxyB.m_id)break;++r}}},e.Query=function(t,e){this.m_tree.Query(t,e)},e.QueryPoint=function(t,e){this.m_tree.QueryPoint(t,e)},e.RayCast=function(t,e){this.m_tree.RayCast(t,e)},e.GetTreeHeight=function(){return this.m_tree.GetHeight()},e.GetTreeBalance=function(){return this.m_tree.GetMaxBalance()},e.GetTreeQuality=function(){return this.m_tree.GetAreaRatio()},e.ShiftOrigin=function(t){this.m_tree.ShiftOrigin(t)},e.BufferMove=function(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount},e.UnBufferMove=function(t){var e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null},t}();function ke(t,e){return t.proxyA.m_id<e.proxyA.m_id||t.proxyA.m_id===e.proxyA.m_id&&t.proxyB.m_id<e.proxyB.m_id}function Ge(){t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0}t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0;var Ue,He=new Rt,je=new Rt,We=new bt,qe=new bt,Xe=new bt,Ye=new bt,Ke=new bt,Je=function(){this.proxyA=new kt,this.proxyB=new kt,this.sweepA=new Mt,this.sweepB=new Mt,this.tMax=0};(Ue=t.b2TOIOutputState||(t.b2TOIOutputState={}))[Ue.e_unknown=0]="e_unknown",Ue[Ue.e_failed=1]="e_failed",Ue[Ue.e_overlapped=2]="e_overlapped",Ue[Ue.e_touching=3]="e_touching",Ue[Ue.e_separated=4]="e_separated";var Qe,Ze=function(){this.state=t.b2TOIOutputState.e_unknown,this.t=0};(Qe=t.b2SeparationFunctionType||(t.b2SeparationFunctionType={}))[Qe.e_unknown=-1]="e_unknown",Qe[Qe.e_points=0]="e_points",Qe[Qe.e_faceA=1]="e_faceA",Qe[Qe.e_faceB=2]="e_faceB";var $e=function(){function e(){this.m_sweepA=new Mt,this.m_sweepB=new Mt,this.m_type=t.b2SeparationFunctionType.e_unknown,this.m_localPoint=new bt,this.m_axis=new bt}var n=e.prototype;return n.Initialize=function(e,n,i,r,o,a){this.m_proxyA=n,this.m_proxyB=r;var s=e.count;this.m_sweepA.Copy(i),this.m_sweepB.Copy(o);var c=He,l=je;if(this.m_sweepA.GetTransform(c,a),this.m_sweepB.GetTransform(l,a),1===s){this.m_type=t.b2SeparationFunctionType.e_points;var u=this.m_proxyA.GetVertex(e.indexA[0]),h=this.m_proxyB.GetVertex(e.indexB[0]),_=Rt.MulXV(c,u,We),f=Rt.MulXV(l,h,qe);bt.SubVV(f,_,this.m_axis);var d=this.m_axis.Normalize();return this.m_localPoint.SetZero(),d}if(e.indexA[0]===e.indexA[1]){this.m_type=t.b2SeparationFunctionType.e_faceB;var p=this.m_proxyB.GetVertex(e.indexB[0]),m=this.m_proxyB.GetVertex(e.indexB[1]);bt.CrossVOne(bt.SubVV(m,p,bt.s_t0),this.m_axis).SelfNormalize();var v=It.MulRV(l.q,this.m_axis,Xe);bt.MidVV(p,m,this.m_localPoint);var g=Rt.MulXV(l,this.m_localPoint,qe),y=this.m_proxyA.GetVertex(e.indexA[0]),x=Rt.MulXV(c,y,We),S=bt.DotVV(bt.SubVV(x,g,bt.s_t0),v);return S<0&&(this.m_axis.SelfNeg(),S=-S),S}this.m_type=t.b2SeparationFunctionType.e_faceA;var A=this.m_proxyA.GetVertex(e.indexA[0]),C=this.m_proxyA.GetVertex(e.indexA[1]);bt.CrossVOne(bt.SubVV(C,A,bt.s_t0),this.m_axis).SelfNormalize();var b=It.MulRV(c.q,this.m_axis,Xe);bt.MidVV(A,C,this.m_localPoint);var T=Rt.MulXV(c,this.m_localPoint,We),E=this.m_proxyB.GetVertex(e.indexB[0]),w=Rt.MulXV(l,E,qe),P=bt.DotVV(bt.SubVV(w,T,bt.s_t0),b);return P<0&&(this.m_axis.SelfNeg(),P=-P),P},n.FindMinSeparation=function(e,n,i){var r=He,o=je;switch(this.m_sweepA.GetTransform(r,i),this.m_sweepB.GetTransform(o,i),this.m_type){case t.b2SeparationFunctionType.e_points:var a=It.MulTRV(r.q,this.m_axis,Ye),s=It.MulTRV(o.q,bt.NegV(this.m_axis,bt.s_t0),Ke);e[0]=this.m_proxyA.GetSupport(a),n[0]=this.m_proxyB.GetSupport(s);var c=this.m_proxyA.GetVertex(e[0]),l=this.m_proxyB.GetVertex(n[0]),u=Rt.MulXV(r,c,We),h=Rt.MulXV(o,l,qe);return bt.DotVV(bt.SubVV(h,u,bt.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var _=It.MulRV(r.q,this.m_axis,Xe),f=Rt.MulXV(r,this.m_localPoint,We),d=It.MulTRV(o.q,bt.NegV(_,bt.s_t0),Ke);e[0]=-1,n[0]=this.m_proxyB.GetSupport(d);var p=this.m_proxyB.GetVertex(n[0]),m=Rt.MulXV(o,p,qe);return bt.DotVV(bt.SubVV(m,f,bt.s_t0),_);case t.b2SeparationFunctionType.e_faceB:var v=It.MulRV(o.q,this.m_axis,Xe),g=Rt.MulXV(o,this.m_localPoint,qe),y=It.MulTRV(r.q,bt.NegV(v,bt.s_t0),Ye);n[0]=-1,e[0]=this.m_proxyA.GetSupport(y);var x=this.m_proxyA.GetVertex(e[0]),S=Rt.MulXV(r,x,We);return bt.DotVV(bt.SubVV(S,g,bt.s_t0),v);default:return e[0]=-1,n[0]=-1,0}},n.Evaluate=function(e,n,i){var r=He,o=je;switch(this.m_sweepA.GetTransform(r,i),this.m_sweepB.GetTransform(o,i),this.m_type){case t.b2SeparationFunctionType.e_points:var a=this.m_proxyA.GetVertex(e),s=this.m_proxyB.GetVertex(n),c=Rt.MulXV(r,a,We),l=Rt.MulXV(o,s,qe);return bt.DotVV(bt.SubVV(l,c,bt.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var u=It.MulRV(r.q,this.m_axis,Xe),h=Rt.MulXV(r,this.m_localPoint,We),_=this.m_proxyB.GetVertex(n),f=Rt.MulXV(o,_,qe);return bt.DotVV(bt.SubVV(f,h,bt.s_t0),u);case t.b2SeparationFunctionType.e_faceB:var d=It.MulRV(o.q,this.m_axis,Xe),p=Rt.MulXV(o,this.m_localPoint,qe),m=this.m_proxyA.GetVertex(e),v=Rt.MulXV(r,m,We);return bt.DotVV(bt.SubVV(v,p,bt.s_t0),d);default:return 0}},e}(),tn=new Nt,en=new Gt,nn=new Ut,rn=new Ht,on=new $e,an=[0],sn=[0],cn=new Mt,ln=new Mt;function un(e,n){var i=tn.Reset();++t.b2_toiCalls,e.state=t.b2TOIOutputState.e_unknown,e.t=n.tMax;var r=n.proxyA,o=n.proxyB,a=rt(c,rt(r.m_count,o.m_count)),s=cn.Copy(n.sweepA),l=ln.Copy(n.sweepB);s.Normalize(),l.Normalize();var u=n.tMax,_=r.m_radius+o.m_radius,f=rt(h,_-3*h),d=.25*h,p=0,m=20,v=0,g=en;g.count=0;var y=nn;for(y.proxyA.Copy(n.proxyA),y.proxyB.Copy(n.proxyB),y.useRadii=!1;;){var x=He,S=je;s.GetTransform(x,p),l.GetTransform(S,p),y.transformA.Copy(x),y.transformB.Copy(S);var A=rn;if(ie(A,g,y),A.distance<=0){e.state=t.b2TOIOutputState.e_overlapped,e.t=0;break}if(A.distance<f+d){e.state=t.b2TOIOutputState.e_touching,e.t=p;break}var C=on;C.Initialize(g,r,s,o,l,p);for(var b=!1,T=u,E=0;;){var w=an,P=sn,I=C.FindMinSeparation(w,P,T);if(I>f+d){e.state=t.b2TOIOutputState.e_separated,e.t=u,b=!0;break}if(I>f-d){p=T;break}var R=C.Evaluate(w[0],P[0],p);if(R<f-d){e.state=t.b2TOIOutputState.e_failed,e.t=p,b=!0;break}if(R<=f+d){e.state=t.b2TOIOutputState.e_touching,e.t=p,b=!0;break}for(var D=0,M=p,B=T;;){var O=0;O=1&D?M+(f-R)*(B-M)/(I-R):.5*(M+B),++D,++t.b2_toiRootIters;var N=C.Evaluate(w[0],P[0],O);if(nt(N-f)<d){T=O;break}if(N>f?(M=O,R=N):(B=O,I=N),50===D)break}if(t.b2_toiMaxRootIters=rt(t.b2_toiMaxRootIters,D),++E===a)break}if(++v,++t.b2_toiIters,b)break;if(v===m){e.state=t.b2TOIOutputState.e_failed,e.t=p;break}}t.b2_toiMaxIters=rt(t.b2_toiMaxIters,v);var L=i.GetMilliseconds();t.b2_toiMaxTime=rt(t.b2_toiMaxTime,L),t.b2_toiTime+=L}var hn=new bt,_n=new bt;function fn(e,n,i,r,o){e.pointCount=0;var a=Rt.MulXV(i,n.m_p,hn),s=Rt.MulXV(o,r.m_p,_n),c=bt.DistanceSquaredVV(a,s),l=n.m_radius+r.m_radius;c>l*l||(e.type=t.b2ManifoldType.e_circles,e.localPoint.Copy(n.m_p),e.localNormal.SetZero(),e.pointCount=1,e.points[0].localPoint.Copy(r.m_p),e.points[0].id.key=0)}var dn=new bt,pn=new bt,mn=new bt;function vn(e,n,o,a,s){e.pointCount=0;for(var c=Rt.MulXV(s,a.m_p,dn),l=Rt.MulTXV(o,c,pn),u=0,h=-i,_=n.m_radius+a.m_radius,f=n.m_count,d=n.m_vertices,p=n.m_normals,m=0;m<f;++m){var v=bt.DotVV(p[m],bt.SubVV(l,d[m],bt.s_t0));if(v>_)return;v>h&&(h=v,u=m)}var g=u,y=(g+1)%f,x=d[g],S=d[y];if(h<r)return e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(p[u]),bt.MidVV(x,S,e.localPoint),e.points[0].localPoint.Copy(a.m_p),void(e.points[0].id.key=0);var A=bt.DotVV(bt.SubVV(l,x,bt.s_t0),bt.SubVV(S,x,bt.s_t1)),C=bt.DotVV(bt.SubVV(l,S,bt.s_t0),bt.SubVV(x,S,bt.s_t1));if(A<=0){if(bt.DistanceSquaredVV(l,x)>_*_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,bt.SubVV(l,x,e.localNormal).SelfNormalize(),e.localPoint.Copy(x),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}else if(C<=0){if(bt.DistanceSquaredVV(l,S)>_*_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,bt.SubVV(l,S,e.localNormal).SelfNormalize(),e.localPoint.Copy(S),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}else{var b=bt.MidVV(x,S,mn);if(bt.DotVV(bt.SubVV(l,b,bt.s_t1),p[g])>_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(p[g]).SelfNormalize(),e.localPoint.Copy(b),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}}var gn=new bt,yn=new bt,xn=new bt,Sn=new bt;function An(t,e,n,r,o){for(var a=t.m_vertices,s=t.m_normals,c=r.m_count,l=r.m_vertices,u=It.MulRV(e.q,s[n],gn),h=It.MulTRV(o.q,u,yn),_=0,f=i,d=0;d<c;++d){var p=bt.DotVV(l[d],h);p<f&&(f=p,_=d)}var m=Rt.MulXV(e,a[n],xn),v=Rt.MulXV(o,l[_],Sn);return bt.DotVV(bt.SubVV(v,m,bt.s_t0),u)}var Cn=new bt,bn=new bt;function Tn(t,e,n,r,o){for(var a=e.m_count,s=e.m_normals,c=bt.SubVV(Rt.MulXV(o,r.m_centroid,bt.s_t0),Rt.MulXV(n,e.m_centroid,bt.s_t1),Cn),l=It.MulTRV(n.q,c,bn),u=0,h=-i,_=0;_<a;++_){var f=bt.DotVV(s[_],l);f>h&&(h=f,u=_)}var d=An(e,n,u,r,o),p=(u+a-1)%a,m=An(e,n,p,r,o),v=(u+1)%a,g=An(e,n,v,r,o),y=0,x=0,S=0;if(m>d&&m>g)S=-1,y=p,x=m;else{if(!(g>d))return t[0]=u,d;S=1,y=v,x=g}for(;(d=An(e,n,u=-1===S?(y+a-1)%a:(y+1)%a,r,o))>x;)y=u,x=d;return t[0]=y,x}var En=new bt;function wn(e,n,r,o,a,s){for(var c=n.m_normals,l=a.m_count,u=a.m_vertices,h=a.m_normals,_=It.MulTRV(s.q,It.MulRV(r.q,c[o],bt.s_t0),En),f=0,d=i,p=0;p<l;++p){var m=bt.DotVV(_,h[p]);m<d&&(d=m,f=p)}var v=f,g=(v+1)%l,y=e[0];Rt.MulXV(s,u[v],y.v);var x=y.id.cf;x.indexA=o,x.indexB=v,x.typeA=t.b2ContactFeatureType.e_face,x.typeB=t.b2ContactFeatureType.e_vertex;var S=e[1];Rt.MulXV(s,u[g],S.v);var A=S.id.cf;A.indexA=o,A.indexB=g,A.typeA=t.b2ContactFeatureType.e_face,A.typeB=t.b2ContactFeatureType.e_vertex}var Pn=Ae.MakeArray(2),In=Ae.MakeArray(2),Rn=Ae.MakeArray(2),Dn=[0],Mn=[0],Bn=new bt,On=new bt,Nn=new bt,Ln=new bt,Fn=new bt,zn=new bt,Vn=new bt,kn=new bt;function Gn(e,n,i,r,o){e.pointCount=0;var a=n.m_radius+r.m_radius,c=Dn;c[0]=0;var l=Tn(c,n,i,r,o);if(!(l>a)){var u=Mn;u[0]=0;var h=Tn(u,r,o,n,i);if(!(h>a)){var _,f,d,p,m=0,v=0;h>.98*l+.001?(_=r,f=n,d=o,p=i,m=u[0],e.type=t.b2ManifoldType.e_faceB,v=1):(_=n,f=r,d=i,p=o,m=c[0],e.type=t.b2ManifoldType.e_faceA,v=0);var g=Pn;wn(g,_,d,m,f,p);var y=_.m_count,x=_.m_vertices,S=m,A=(m+1)%y,C=x[S],b=x[A],T=bt.SubVV(b,C,Bn);T.Normalize();var E=bt.CrossVOne(T,On),w=bt.MidVV(C,b,Nn),P=It.MulRV(d.q,T,Fn),I=bt.CrossVOne(P,Ln),R=Rt.MulXV(d,C,Vn),D=Rt.MulXV(d,b,kn),M=bt.DotVV(I,R),B=-bt.DotVV(P,R)+a,O=bt.DotVV(P,D)+a,N=In,L=Rn;if(!(we(N,g,bt.NegV(P,zn),B,S)<2||we(L,N,P,O,A)<2)){e.localNormal.Copy(E),e.localPoint.Copy(w);for(var F=0,z=0;z<s;++z){var V=L[z];if(bt.DotVV(I,V.v)-M<=a){var k=e.points[F];if(Rt.MulTXV(p,V.v,k.localPoint),k.id.Copy(V.id),v){var G=k.id.cf;k.id.cf.indexA=G.indexB,k.id.cf.indexB=G.indexA,k.id.cf.typeA=G.typeB,k.id.cf.typeB=G.typeA}++F}}e.pointCount=F}}}}var Un,Hn=new bt,jn=new bt,Wn=new bt,qn=new bt,Xn=new bt,Yn=new bt,Kn=new bt,Jn=new me;function Qn(e,n,i,r,o){e.pointCount=0;var a=Rt.MulTXV(i,Rt.MulXV(o,r.m_p,bt.s_t0),Hn),s=n.m_vertex1,c=n.m_vertex2,l=bt.SubVV(c,s,jn),u=bt.DotVV(l,bt.SubVV(c,a,bt.s_t0)),h=bt.DotVV(l,bt.SubVV(a,s,bt.s_t0)),_=n.m_radius+r.m_radius,f=Jn;if(f.cf.indexB=0,f.cf.typeB=t.b2ContactFeatureType.e_vertex,h<=0){var d=s,p=bt.SubVV(a,d,Wn);if(bt.DotVV(p,p)>_*_)return;if(n.m_hasVertex0){var m=n.m_vertex0,v=s,g=bt.SubVV(v,m,qn);if(bt.DotVV(g,bt.SubVV(v,a,bt.s_t0))>0)return}return f.cf.indexA=0,f.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(d),e.points[0].id.Copy(f),void e.points[0].localPoint.Copy(r.m_p)}if(u<=0){var y=c,x=bt.SubVV(a,y,Wn);if(bt.DotVV(x,x)>_*_)return;if(n.m_hasVertex3){var S=n.m_vertex3,A=c,C=bt.SubVV(S,A,Xn);if(bt.DotVV(C,bt.SubVV(a,A,bt.s_t0))>0)return}return f.cf.indexA=1,f.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(y),e.points[0].id.Copy(f),void e.points[0].localPoint.Copy(r.m_p)}var b=bt.DotVV(l,l),T=Yn;T.x=1/b*(u*s.x+h*c.x),T.y=1/b*(u*s.y+h*c.y);var E=bt.SubVV(a,T,Wn);if(!(bt.DotVV(E,E)>_*_)){var w=Kn.Set(-l.y,l.x);bt.DotVV(w,bt.SubVV(a,s,bt.s_t0))<0&&w.Set(-w.x,-w.y),w.Normalize(),f.cf.indexA=0,f.cf.typeA=t.b2ContactFeatureType.e_face,e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(w),e.localPoint.Copy(s),e.points[0].id.Copy(f),e.points[0].localPoint.Copy(r.m_p)}}!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(Un||(Un={}));var Zn,$n=function(){this.type=Un.e_unknown,this.index=0,this.separation=0},ti=function(){this.vertices=[],this.normals=[],this.count=0},ei=function(){this.i1=0,this.i2=0,this.v1=new bt,this.v2=new bt,this.normal=new bt,this.sideNormal1=new bt,this.sideOffset1=0,this.sideNormal2=new bt,this.sideOffset2=0};!function(t){t[t.e_isolated=0]="e_isolated",t[t.e_concave=1]="e_concave",t[t.e_convex=2]="e_convex"}(Zn||(Zn={}));var ni=function(){function e(){this.m_polygonB=new ti,this.m_xf=new Rt,this.m_centroidB=new bt,this.m_v0=new bt,this.m_v1=new bt,this.m_v2=new bt,this.m_v3=new bt,this.m_normal0=new bt,this.m_normal1=new bt,this.m_normal2=new bt,this.m_normal=new bt,this.m_type1=Zn.e_isolated,this.m_type2=Zn.e_isolated,this.m_lowerLimit=new bt,this.m_upperLimit=new bt,this.m_radius=0,this.m_front=!1}var n=e.prototype;return n.Collide=function(n,i,r,o,a){Rt.MulTXX(r,a,this.m_xf),Rt.MulXV(this.m_xf,o.m_centroid,this.m_centroidB),this.m_v0.Copy(i.m_vertex0),this.m_v1.Copy(i.m_vertex1),this.m_v2.Copy(i.m_vertex2),this.m_v3.Copy(i.m_vertex3);var c=i.m_hasVertex0,l=i.m_hasVertex3,u=bt.SubVV(this.m_v2,this.m_v1,e.s_edge1);u.Normalize(),this.m_normal1.Set(u.y,-u.x);var h=bt.DotVV(this.m_normal1,bt.SubVV(this.m_centroidB,this.m_v1,bt.s_t0)),_=0,f=0,d=!1,p=!1;if(c){var m=bt.SubVV(this.m_v1,this.m_v0,e.s_edge0);m.Normalize(),this.m_normal0.Set(m.y,-m.x),d=bt.CrossVV(m,u)>=0,_=bt.DotVV(this.m_normal0,bt.SubVV(this.m_centroidB,this.m_v0,bt.s_t0))}if(l){var v=bt.SubVV(this.m_v3,this.m_v2,e.s_edge2);v.Normalize(),this.m_normal2.Set(v.y,-v.x),p=bt.CrossVV(u,v)>0,f=bt.DotVV(this.m_normal2,bt.SubVV(this.m_centroidB,this.m_v2,bt.s_t0))}c&&l?d&&p?(this.m_front=_>=0||h>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):d?(this.m_front=_>=0||h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):p?(this.m_front=f>=0||_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=_>=0&&h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):c?d?(this.m_front=_>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):l?p?(this.m_front=h>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=o.m_count;for(var g=0;g<o.m_count;++g)this.m_polygonB.vertices.length<=g&&this.m_polygonB.vertices.push(new bt),this.m_polygonB.normals.length<=g&&this.m_polygonB.normals.push(new bt),Rt.MulXV(this.m_xf,o.m_vertices[g],this.m_polygonB.vertices[g]),It.MulRV(this.m_xf.q,o.m_normals[g],this.m_polygonB.normals[g]);this.m_radius=o.m_radius+i.m_radius,n.pointCount=0;var y=this.ComputeEdgeSeparation(e.s_edgeAxis);if(y.type!==Un.e_unknown&&!(y.separation>this.m_radius)){var x=this.ComputePolygonSeparation(e.s_polygonAxis);if(!(x.type!==Un.e_unknown&&x.separation>this.m_radius)){var S,A=.98,C=.001;S=x.type===Un.e_unknown?y:x.separation>A*y.separation+C?x:y;var b=e.s_ie,T=e.s_rf;if(S.type===Un.e_edgeA){n.type=t.b2ManifoldType.e_faceA;for(var E=0,w=bt.DotVV(this.m_normal,this.m_polygonB.normals[0]),P=1;P<this.m_polygonB.count;++P){var I=bt.DotVV(this.m_normal,this.m_polygonB.normals[P]);I<w&&(w=I,E=P)}var R=E,D=(R+1)%this.m_polygonB.count,M=b[0];M.v.Copy(this.m_polygonB.vertices[R]),M.id.cf.indexA=0,M.id.cf.indexB=R,M.id.cf.typeA=t.b2ContactFeatureType.e_face,M.id.cf.typeB=t.b2ContactFeatureType.e_vertex;var B=b[1];B.v.Copy(this.m_polygonB.vertices[D]),B.id.cf.indexA=0,B.id.cf.indexB=D,B.id.cf.typeA=t.b2ContactFeatureType.e_face,B.id.cf.typeB=t.b2ContactFeatureType.e_vertex,this.m_front?(T.i1=0,T.i2=1,T.v1.Copy(this.m_v1),T.v2.Copy(this.m_v2),T.normal.Copy(this.m_normal1)):(T.i1=1,T.i2=0,T.v1.Copy(this.m_v2),T.v2.Copy(this.m_v1),T.normal.Copy(this.m_normal1).SelfNeg())}else{n.type=t.b2ManifoldType.e_faceB;var O=b[0];O.v.Copy(this.m_v1),O.id.cf.indexA=0,O.id.cf.indexB=S.index,O.id.cf.typeA=t.b2ContactFeatureType.e_vertex,O.id.cf.typeB=t.b2ContactFeatureType.e_face;var N=b[1];N.v.Copy(this.m_v2),N.id.cf.indexA=0,N.id.cf.indexB=S.index,N.id.cf.typeA=t.b2ContactFeatureType.e_vertex,N.id.cf.typeB=t.b2ContactFeatureType.e_face,T.i1=S.index,T.i2=(T.i1+1)%this.m_polygonB.count,T.v1.Copy(this.m_polygonB.vertices[T.i1]),T.v2.Copy(this.m_polygonB.vertices[T.i2]),T.normal.Copy(this.m_polygonB.normals[T.i1])}T.sideNormal1.Set(T.normal.y,-T.normal.x),T.sideNormal2.Copy(T.sideNormal1).SelfNeg(),T.sideOffset1=bt.DotVV(T.sideNormal1,T.v1),T.sideOffset2=bt.DotVV(T.sideNormal2,T.v2);var L=e.s_clipPoints1,F=e.s_clipPoints2;if(!(we(L,b,T.sideNormal1,T.sideOffset1,T.i1)<s||we(F,L,T.sideNormal2,T.sideOffset2,T.i2)<s)){S.type===Un.e_edgeA?(n.localNormal.Copy(T.normal),n.localPoint.Copy(T.v1)):(n.localNormal.Copy(o.m_normals[T.i1]),n.localPoint.Copy(o.m_vertices[T.i1]));for(var z=0,V=0;V<s;++V)if(bt.DotVV(T.normal,bt.SubVV(F[V].v,T.v1,bt.s_t0))<=this.m_radius){var k=n.points[z];S.type===Un.e_edgeA?(Rt.MulTXV(this.m_xf,F[V].v,k.localPoint),k.id.Copy(F[V].id)):(k.localPoint.Copy(F[V].v),k.id.cf.typeA=F[V].id.cf.typeB,k.id.cf.typeB=F[V].id.cf.typeA,k.id.cf.indexA=F[V].id.cf.indexB,k.id.cf.indexB=F[V].id.cf.indexA),++z}n.pointCount=z}}}},n.ComputeEdgeSeparation=function(t){var e=t;e.type=Un.e_edgeA,e.index=this.m_front?0:1,e.separation=i;for(var n=0;n<this.m_polygonB.count;++n){var r=bt.DotVV(this.m_normal,bt.SubVV(this.m_polygonB.vertices[n],this.m_v1,bt.s_t0));r<e.separation&&(e.separation=r)}return e},n.ComputePolygonSeparation=function(t){var n=t;n.type=Un.e_unknown,n.index=-1,n.separation=-i;for(var r=e.s_perp.Set(-this.m_normal.y,this.m_normal.x),o=0;o<this.m_polygonB.count;++o){var a=bt.NegV(this.m_polygonB.normals[o],e.s_n),s=it(bt.DotVV(a,bt.SubVV(this.m_polygonB.vertices[o],this.m_v1,bt.s_t0)),bt.DotVV(a,bt.SubVV(this.m_polygonB.vertices[o],this.m_v2,bt.s_t0)));if(s>this.m_radius)return n.type=Un.e_edgeB,n.index=o,n.separation=s,n;if(bt.DotVV(a,r)>=0){if(bt.DotVV(bt.SubVV(a,this.m_upperLimit,bt.s_t0),this.m_normal)<-_)continue}else if(bt.DotVV(bt.SubVV(a,this.m_lowerLimit,bt.s_t0),this.m_normal)<-_)continue;s>n.separation&&(n.type=Un.e_edgeB,n.index=o,n.separation=s)}return n},e}();ni.s_edge1=new bt,ni.s_edge0=new bt,ni.s_edge2=new bt,ni.s_ie=Ae.MakeArray(2),ni.s_rf=new ei,ni.s_clipPoints1=Ae.MakeArray(2),ni.s_clipPoints2=Ae.MakeArray(2),ni.s_edgeAxis=new $n,ni.s_polygonAxis=new $n,ni.s_n=new bt,ni.s_perp=new bt;var ii=new ni;function ri(t,e,n,i,r){ii.Collide(t,e,n,i,r)}var oi,ai=function(){this.mass=0,this.center=new bt(0,0),this.I=0};(oi=t.b2ShapeType||(t.b2ShapeType={}))[oi.e_unknown=-1]="e_unknown",oi[oi.e_circleShape=0]="e_circleShape",oi[oi.e_edgeShape=1]="e_edgeShape",oi[oi.e_polygonShape=2]="e_polygonShape",oi[oi.e_chainShape=3]="e_chainShape",oi[oi.e_shapeTypeCount=4]="e_shapeTypeCount";var si=function(){function e(e,n){this.m_type=t.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=e,this.m_radius=n}var n=e.prototype;return n.Copy=function(t){return this.m_radius=t.m_radius,this},n.GetType=function(){return this.m_type},e}(),ci=function(e){function n(n){var i;return void 0===n&&(n=0),(i=e.call(this,t.b2ShapeType.e_circleShape,n)||this).m_p=new bt,i}Q(n,e);var i=n.prototype;return i.Set=function(t,e){return void 0===e&&(e=this.m_radius),this.m_p.Copy(t),this.m_radius=e,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_p.Copy(t.m_p),this},i.GetChildCount=function(){return 1},i.TestPoint=function(t,e){var i=Rt.MulXV(t,this.m_p,n.TestPoint_s_center),r=bt.SubVV(e,i,n.TestPoint_s_d);return bt.DotVV(r,r)<=lt(this.m_radius)},i.ComputeDistance=function(t,e,i){var r=Rt.MulXV(t,this.m_p,n.ComputeDistance_s_center);return bt.SubVV(e,r,i),i.Normalize()-this.m_radius},i.RayCast=function(t,e,i){var o=Rt.MulXV(i,this.m_p,n.RayCast_s_position),a=bt.SubVV(e.p1,o,n.RayCast_s_s),s=bt.DotVV(a,a)-lt(this.m_radius),c=bt.SubVV(e.p2,e.p1,n.RayCast_s_r),l=bt.DotVV(a,c),u=bt.DotVV(c,c),h=l*l-u*s;if(h<0||u<r)return!1;var _=-(l+ht(h));return 0<=_&&_<=e.maxFraction*u&&(_/=u,t.fraction=_,bt.AddVMulSV(a,_,c,t.normal).SelfNormalize(),!0)},i.ComputeAABB=function(t,e){var i=Rt.MulXV(e,this.m_p,n.ComputeAABB_s_p);t.lowerBound.Set(i.x-this.m_radius,i.y-this.m_radius),t.upperBound.Set(i.x+this.m_radius,i.y+this.m_radius)},i.ComputeMass=function(t,e){var n=lt(this.m_radius);t.mass=e*a*n,t.center.Copy(this.m_p),t.I=t.mass*(.5*n+bt.DotVV(this.m_p,this.m_p))},i.SetupDistanceProxy=function(t){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius},i.ComputeSubmergedArea=function(t,e,n,i){var o=Rt.MulXV(n,this.m_p,new bt),s=-(bt.DotVV(t,o)-e);if(s<-this.m_radius+r)return 0;if(s>this.m_radius)return i.Copy(o),a*this.m_radius*this.m_radius;var c=this.m_radius*this.m_radius,l=s*s,u=c*(gt(s/this.m_radius)+a/2)+s*ht(c-l),h=-2/3*_t(c-l,1.5)/u;return i.x=o.x+t.x*h,i.y=o.y+t.y*h,u},i.Dump=function(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)},n}(si);ci.TestPoint_s_center=new bt,ci.TestPoint_s_d=new bt,ci.ComputeDistance_s_center=new bt,ci.RayCast_s_position=new bt,ci.RayCast_s_s=new bt,ci.RayCast_s_r=new bt,ci.ComputeAABB_s_p=new bt;var li=function(e){function n(){var n;return(n=e.call(this,t.b2ShapeType.e_polygonShape,f)||this).m_centroid=new bt(0,0),n.m_vertices=[],n.m_normals=[],n.m_count=0,n}Q(n,e);var o=n.prototype;return o.Clone=function(){return(new n).Copy(this)},o.Copy=function(t){e.prototype.Copy.call(this,t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=bt.MakeArray(this.m_count),this.m_normals=bt.MakeArray(this.m_count);for(var n=0;n<this.m_count;++n)this.m_vertices[n].Copy(t.m_vertices[n]),this.m_normals[n].Copy(t.m_normals[n]);return this},o.GetChildCount=function(){return 1},o.Set=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if("number"==typeof e[0][0]){var i=e[0];if(i.length%2!=0)throw new Error;return this._Set((function(t){return{x:i[2*t],y:i[2*t+1]}}),i.length/2)}var r=e[0],o=e[1]||r.length;return this._Set((function(t){return r[t]}),o)},o._Set=function(t,e){if(e<3)return this.SetAsBox(1,1);for(var i=e,r=[],o=0;o<i;++o){for(var a=t(o),s=!0,c=0;c<r.length;++c)if(bt.DistanceSquaredVV(a,r[c])<.25*h*h){s=!1;break}s&&r.push(a)}if((i=r.length)<3)return this.SetAsBox(1,1);for(var l=0,u=r[0].x,_=1;_<i;++_){var f=r[_].x;(f>u||f===u&&r[_].y<r[l].y)&&(l=_,u=f)}for(var d=[],p=0,m=l;;){d[p]=m;for(var v=0,g=1;g<i;++g)if(v!==m){var y=bt.SubVV(r[v],r[d[p]],n.Set_s_r),x=bt.SubVV(r[g],r[d[p]],n.Set_s_v),S=bt.CrossVV(y,x);S<0&&(v=g),0===S&&x.LengthSquared()>y.LengthSquared()&&(v=g)}else v=g;if(++p,m=v,v===l)break}this.m_count=p,this.m_vertices=bt.MakeArray(this.m_count),this.m_normals=bt.MakeArray(this.m_count);for(var A=0;A<p;++A)this.m_vertices[A].Copy(r[d[A]]);for(var C=0;C<p;++C){var b=this.m_vertices[C],T=this.m_vertices[(C+1)%p],E=bt.SubVV(T,b,bt.s_t0);bt.CrossVOne(E,this.m_normals[C]).SelfNormalize()}return n.ComputeCentroid(this.m_vertices,p,this.m_centroid),this},o.SetAsBox=function(t,e,n,i){if(void 0===i&&(i=0),this.m_count=4,this.m_vertices=bt.MakeArray(this.m_count),this.m_normals=bt.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),n){this.m_centroid.Copy(n);var r=new Rt;r.SetPosition(n),r.SetRotationAngle(i);for(var o=0;o<this.m_count;++o)Rt.MulXV(r,this.m_vertices[o],this.m_vertices[o]),It.MulRV(r.q,this.m_normals[o],this.m_normals[o])}return this},o.TestPoint=function(t,e){for(var i=Rt.MulTXV(t,e,n.TestPoint_s_pLocal),r=0;r<this.m_count;++r)if(bt.DotVV(this.m_normals[r],bt.SubVV(i,this.m_vertices[r],bt.s_t0))>0)return!1;return!0},o.ComputeDistance=function(t,e,r){for(var o=Rt.MulTXV(t,e,n.ComputeDistance_s_pLocal),a=-i,s=n.ComputeDistance_s_normalForMaxDistance.Copy(o),c=0;c<this.m_count;++c){var l=bt.DotVV(this.m_normals[c],bt.SubVV(o,this.m_vertices[c],bt.s_t0));l>a&&(a=l,s.Copy(this.m_normals[c]))}if(a>0){for(var u=n.ComputeDistance_s_minDistance.Copy(s),h=a*a,_=0;_<this.m_count;++_){var f=bt.SubVV(o,this.m_vertices[_],n.ComputeDistance_s_distance),d=f.LengthSquared();h>d&&(u.Copy(f),h=d)}return It.MulRV(t.q,u,r),r.Normalize(),Math.sqrt(h)}return It.MulRV(t.q,s,r),a},o.RayCast=function(t,e,i){for(var r=Rt.MulTXV(i,e.p1,n.RayCast_s_p1),o=Rt.MulTXV(i,e.p2,n.RayCast_s_p2),a=bt.SubVV(o,r,n.RayCast_s_d),s=0,c=e.maxFraction,l=-1,u=0;u<this.m_count;++u){var h=bt.DotVV(this.m_normals[u],bt.SubVV(this.m_vertices[u],r,bt.s_t0)),_=bt.DotVV(this.m_normals[u],a);if(0===_){if(h<0)return!1}else _<0&&h<s*_?(s=h/_,l=u):_>0&&h<c*_&&(c=h/_);if(c<s)return!1}return l>=0&&(t.fraction=s,It.MulRV(i.q,this.m_normals[l],t.normal),!0)},o.ComputeAABB=function(t,e){for(var i=Rt.MulXV(e,this.m_vertices[0],t.lowerBound),r=t.upperBound.Copy(i),o=0;o<this.m_count;++o){var a=Rt.MulXV(e,this.m_vertices[o],n.ComputeAABB_s_v);bt.MinV(a,i,i),bt.MaxV(a,r,r)}var s=this.m_radius;i.SelfSubXY(s,s),r.SelfAddXY(s,s)},o.ComputeMass=function(t,e){for(var i=n.ComputeMass_s_center.SetZero(),r=0,o=0,a=n.ComputeMass_s_s.SetZero(),s=0;s<this.m_count;++s)a.SelfAdd(this.m_vertices[s]);a.SelfMul(1/this.m_count);for(var c=1/3,l=0;l<this.m_count;++l){var u=bt.SubVV(this.m_vertices[l],a,n.ComputeMass_s_e1),h=bt.SubVV(this.m_vertices[(l+1)%this.m_count],a,n.ComputeMass_s_e2),_=bt.CrossVV(u,h),f=.5*_;r+=f,i.SelfAdd(bt.MulSV(f*c,bt.AddVV(u,h,bt.s_t0),bt.s_t1));var d=u.x,p=u.y,m=h.x,v=h.y;o+=.25*c*_*(d*d+m*d+m*m+p*p+v*p+v*v)}t.mass=e*r,i.SelfMul(1/r),bt.AddVV(i,a,t.center),t.I=e*o,t.I+=t.mass*(bt.DotVV(t.center,t.center)-bt.DotVV(i,i))},o.Validate=function(){for(var t=0;t<this.m_count;++t)for(var e=t,i=(t+1)%this.m_count,r=this.m_vertices[e],o=bt.SubVV(this.m_vertices[i],r,n.Validate_s_e),a=0;a<this.m_count;++a)if(a!==e&&a!==i){var s=bt.SubVV(this.m_vertices[a],r,n.Validate_s_v);if(bt.CrossVV(o,s)<0)return!1}return!0},o.SetupDistanceProxy=function(t){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius},o.ComputeSubmergedArea=function(t,e,i,o){for(var a=It.MulTRV(i.q,t,n.ComputeSubmergedArea_s_normalL),s=e-bt.DotVV(t,i.p),c=[],l=0,u=-1,h=-1,_=!1,f=0;f<this.m_count;++f){c[f]=bt.DotVV(a,this.m_vertices[f])-s;var d=c[f]<-r;f>0&&(d?_||(u=f-1,l++):_&&(h=f-1,l++)),_=d}switch(l){case 0:if(_){var p=n.ComputeSubmergedArea_s_md;return this.ComputeMass(p,1),Rt.MulXV(i,p.center,o),p.mass}return 0;case 1:-1===u?u=this.m_count-1:h=this.m_count-1}for(var m,v=(u+1)%this.m_count,g=(h+1)%this.m_count,y=(0-c[u])/(c[v]-c[u]),x=(0-c[h])/(c[g]-c[h]),S=n.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[u].x*(1-y)+this.m_vertices[v].x*y,this.m_vertices[u].y*(1-y)+this.m_vertices[v].y*y),A=n.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[h].x*(1-x)+this.m_vertices[g].x*x,this.m_vertices[h].y*(1-x)+this.m_vertices[g].y*x),C=0,b=n.ComputeSubmergedArea_s_center.SetZero(),T=this.m_vertices[v],E=v;E!==g;){m=(E=(E+1)%this.m_count)===g?A:this.m_vertices[E];var w=.5*((T.x-S.x)*(m.y-S.y)-(T.y-S.y)*(m.x-S.x));C+=w,b.x+=w*(S.x+T.x+m.x)/3,b.y+=w*(S.y+T.y+m.y)/3,T=m}return b.SelfMul(1/C),Rt.MulXV(i,b,o),C},o.Dump=function(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(var e=0;e<this.m_count;++e)t("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)},n.ComputeCentroid=function(t,e,i){var r=i;r.SetZero();for(var o=0,a=n.ComputeCentroid_s_pRef.SetZero(),s=1/3,c=0;c<e;++c){var l=a,u=t[c],h=t[(c+1)%e],_=bt.SubVV(u,l,n.ComputeCentroid_s_e1),f=bt.SubVV(h,l,n.ComputeCentroid_s_e2),d=.5*bt.CrossVV(_,f);o+=d,r.x+=d*s*(l.x+u.x+h.x),r.y+=d*s*(l.y+u.y+h.y)}return r.SelfMul(1/o),r},n}(si);li.Set_s_r=new bt,li.Set_s_v=new bt,li.TestPoint_s_pLocal=new bt,li.ComputeDistance_s_pLocal=new bt,li.ComputeDistance_s_normalForMaxDistance=new bt,li.ComputeDistance_s_minDistance=new bt,li.ComputeDistance_s_distance=new bt,li.RayCast_s_p1=new bt,li.RayCast_s_p2=new bt,li.RayCast_s_d=new bt,li.ComputeAABB_s_v=new bt,li.ComputeMass_s_center=new bt,li.ComputeMass_s_s=new bt,li.ComputeMass_s_e1=new bt,li.ComputeMass_s_e2=new bt,li.Validate_s_e=new bt,li.Validate_s_v=new bt,li.ComputeSubmergedArea_s_normalL=new bt,li.ComputeSubmergedArea_s_md=new ai,li.ComputeSubmergedArea_s_intoVec=new bt,li.ComputeSubmergedArea_s_outoVec=new bt,li.ComputeSubmergedArea_s_center=new bt,li.ComputeCentroid_s_pRef=new bt,li.ComputeCentroid_s_e1=new bt,li.ComputeCentroid_s_e2=new bt;var ui=function(e){function n(){var n;return(n=e.call(this,t.b2ShapeType.e_edgeShape,f)||this).m_vertex1=new bt,n.m_vertex2=new bt,n.m_vertex0=new bt,n.m_vertex3=new bt,n.m_hasVertex0=!1,n.m_hasVertex3=!1,n}Q(n,e);var i=n.prototype;return i.Set=function(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this},i.GetChildCount=function(){return 1},i.TestPoint=function(){return!1},i.ComputeDistance=function(t,e,i){var r=Rt.MulXV(t,this.m_vertex1,n.ComputeDistance_s_v1),o=Rt.MulXV(t,this.m_vertex2,n.ComputeDistance_s_v2),a=bt.SubVV(e,r,n.ComputeDistance_s_d),s=bt.SubVV(o,r,n.ComputeDistance_s_s),c=bt.DotVV(a,s);if(c>0){var l=bt.DotVV(s,s);c>l?bt.SubVV(e,o,a):a.SelfMulSub(c/l,s)}return i.Copy(a),i.Normalize()},i.RayCast=function(t,e,i){var r=Rt.MulTXV(i,e.p1,n.RayCast_s_p1),o=Rt.MulTXV(i,e.p2,n.RayCast_s_p2),a=bt.SubVV(o,r,n.RayCast_s_d),s=this.m_vertex1,c=this.m_vertex2,l=bt.SubVV(c,s,n.RayCast_s_e),u=t.normal.Set(l.y,-l.x).SelfNormalize(),h=bt.DotVV(u,bt.SubVV(s,r,bt.s_t0)),_=bt.DotVV(u,a);if(0===_)return!1;var f=h/_;if(f<0||e.maxFraction<f)return!1;var d=bt.AddVMulSV(r,f,a,n.RayCast_s_q),p=bt.SubVV(c,s,n.RayCast_s_r),m=bt.DotVV(p,p);if(0===m)return!1;var v=bt.DotVV(bt.SubVV(d,s,bt.s_t0),p)/m;return!(v<0||1<v||(t.fraction=f,It.MulRV(i.q,t.normal,t.normal),h>0&&t.normal.SelfNeg(),0))},i.ComputeAABB=function(t,e){var i=Rt.MulXV(e,this.m_vertex1,n.ComputeAABB_s_v1),r=Rt.MulXV(e,this.m_vertex2,n.ComputeAABB_s_v2);bt.MinV(i,r,t.lowerBound),bt.MaxV(i,r,t.upperBound);var o=this.m_radius;t.lowerBound.SelfSubXY(o,o),t.upperBound.SelfAddXY(o,o)},i.ComputeMass=function(t){t.mass=0,bt.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0},i.SetupDistanceProxy=function(t){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius},i.ComputeSubmergedArea=function(t,e,n,i){return i.SetZero(),0},i.Dump=function(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)},n}(si);ui.ComputeDistance_s_v1=new bt,ui.ComputeDistance_s_v2=new bt,ui.ComputeDistance_s_d=new bt,ui.ComputeDistance_s_s=new bt,ui.RayCast_s_p1=new bt,ui.RayCast_s_p2=new bt,ui.RayCast_s_d=new bt,ui.RayCast_s_e=new bt,ui.RayCast_s_q=new bt,ui.RayCast_s_r=new bt,ui.ComputeAABB_s_v1=new bt,ui.ComputeAABB_s_v2=new bt;var hi=function(e){function n(){var n;return(n=e.call(this,t.b2ShapeType.e_chainShape,f)||this).m_vertices=[],n.m_count=0,n.m_prevVertex=new bt,n.m_nextVertex=new bt,n.m_hasPrevVertex=!1,n.m_hasNextVertex=!1,n}Q(n,e);var i=n.prototype;return i.CreateLoop=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if("number"==typeof e[0][0]){var i=e[0];if(i.length%2!=0)throw new Error;return this._CreateLoop((function(t){return{x:i[2*t],y:i[2*t+1]}}),i.length/2)}var r=e[0],o=e[1]||r.length;return this._CreateLoop((function(t){return r[t]}),o)},i._CreateLoop=function(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=bt.MakeArray(this.m_count);for(var n=0;n<e;++n)this.m_vertices[n].Copy(t(n));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this},i.CreateChain=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if("number"==typeof e[0][0]){var i=e[0];if(i.length%2!=0)throw new Error;return this._CreateChain((function(t){return{x:i[2*t],y:i[2*t+1]}}),i.length/2)}var r=e[0],o=e[1]||r.length;return this._CreateChain((function(t){return r[t]}),o)},i._CreateChain=function(t,e){this.m_count=e,this.m_vertices=bt.MakeArray(e);for(var n=0;n<e;++n)this.m_vertices[n].Copy(t(n));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this},i.SetPrevVertex=function(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this},i.SetNextVertex=function(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(t){return e.prototype.Copy.call(this,t),this._CreateChain((function(e){return t.m_vertices[e]}),t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this},i.GetChildCount=function(){return this.m_count-1},i.GetChildEdge=function(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)},i.TestPoint=function(){return!1},i.ComputeDistance=function(t,e,i,r){var o=n.ComputeDistance_s_edgeShape;return this.GetChildEdge(o,r),o.ComputeDistance(t,e,i,0)},i.RayCast=function(t,e,i,r){var o=n.RayCast_s_edgeShape;return o.m_vertex1.Copy(this.m_vertices[r]),o.m_vertex2.Copy(this.m_vertices[(r+1)%this.m_count]),o.RayCast(t,e,i,0)},i.ComputeAABB=function(t,e,i){var r=this.m_vertices[i],o=this.m_vertices[(i+1)%this.m_count],a=Rt.MulXV(e,r,n.ComputeAABB_s_v1),s=Rt.MulXV(e,o,n.ComputeAABB_s_v2);bt.MinV(a,s,t.lowerBound),bt.MaxV(a,s,t.upperBound)},i.ComputeMass=function(t){t.mass=0,t.center.SetZero(),t.I=0},i.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius},i.ComputeSubmergedArea=function(t,e,n,i){return i.SetZero(),0},i.Dump=function(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(var e=0;e<this.m_count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")},n}(si);hi.ComputeDistance_s_edgeShape=new ui,hi.RayCast_s_edgeShape=new ui,hi.ComputeAABB_s_v1=new bt,hi.ComputeAABB_s_v2=new bt;var _i=function(){function t(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this},t}();_i.DEFAULT=new _i;var fi=function(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new _i},di=function(){function t(t,e){this.aabb=new Te,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}var e=t.prototype;return e.Reset=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)},e.Touch=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)},e.Synchronize=function(e,n,i){if(e===n)this.fixture.m_shape.ComputeAABB(this.aabb,e,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i);else{var r=t.Synchronize_s_aabb1,o=t.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(r,e,this.childIndex),this.fixture.m_shape.ComputeAABB(o,n,this.childIndex),this.aabb.Combine2(r,o),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i)}},t}();di.Synchronize_s_aabb1=new Te,di.Synchronize_s_aabb2=new Te;var pi,mi=function(){function t(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new _i,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=n(e.userData,null),this.m_friction=n(e.friction,.2),this.m_restitution=n(e.restitution,0),this.m_filter.Copy(n(e.filter,_i.DEFAULT)),this.m_isSensor=n(e.isSensor,!1),this.m_density=n(e.density,0)}var e=t.prototype;return e.Reset=function(){},e.GetType=function(){return this.m_shape.GetType()},e.GetShape=function(){return this.m_shape},e.SetSensor=function(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)},e.IsSensor=function(){return this.m_isSensor},e.SetFilterData=function(t){this.m_filter.Copy(t),this.Refilter()},e.GetFilterData=function(){return this.m_filter},e.Refilter=function(){for(var t=this.m_body.GetContactList();t;){var e=t.contact,n=e.GetFixtureA(),i=e.GetFixtureB();n!==this&&i!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()},e.GetBody=function(){return this.m_body},e.GetNext=function(){return this.m_next},e.GetUserData=function(){return this.m_userData},e.SetUserData=function(t){this.m_userData=t},e.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},e.ComputeDistance=function(t,e,n){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,n)},e.RayCast=function(t,e,n){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),n)},e.GetMassData=function(t){return void 0===t&&(t=new ai),this.m_shape.ComputeMass(t,this.m_density),t},e.SetDensity=function(t){this.m_density=t},e.GetDensity=function(){return this.m_density},e.GetFriction=function(){return this.m_friction},e.SetFriction=function(t){this.m_friction=t},e.GetRestitution=function(){return this.m_restitution},e.SetRestitution=function(t){this.m_restitution=t},e.GetAABB=function(t){return this.m_proxies[t].aabb},e.Dump=function(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)},e.CreateProxies=function(){if(0!==this.m_proxies.length)throw new Error;for(var t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new di(this,t)},e.DestroyProxies=function(){for(var t,e=ot(this.m_proxies);!(t=e()).done;)t.value.Reset();this.m_proxies.length=0},e.TouchProxies=function(){for(var t,e=ot(this.m_proxies);!(t=e()).done;)t.value.Touch()},e.SynchronizeProxies=function(t,e,n){for(var i,r=ot(this.m_proxies);!(i=r()).done;)i.value.Synchronize(t,e,n)},K(t,[{key:"m_proxyCount",get:function(){return this.m_proxies.length}}]),t}();(pi=t.b2BodyType||(t.b2BodyType={}))[pi.b2_unknown=-1]="b2_unknown",pi[pi.b2_staticBody=0]="b2_staticBody",pi[pi.b2_kinematicBody=1]="b2_kinematicBody",pi[pi.b2_dynamicBody=2]="b2_dynamicBody";var vi,gi,yi=function(){this.type=t.b2BodyType.b2_staticBody,this.position=new bt(0,0),this.angle=0,this.linearVelocity=new bt(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1},xi=function(){function e(e,i){this.m_type=t.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new Rt,this.m_xf0=new Rt,this.m_sweep=new Mt,this.m_linearVelocity=new bt,this.m_angularVelocity=0,this.m_force=new bt,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=n(e.bullet,!1),this.m_fixedRotationFlag=n(e.fixedRotation,!1),this.m_autoSleepFlag=n(e.allowSleep,!0),this.m_awakeFlag=n(e.awake,!0),this.m_activeFlag=n(e.active,!0),this.m_world=i,this.m_xf.p.Copy(n(e.position,bt.ZERO)),this.m_xf.q.SetAngle(n(e.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(n(e.linearVelocity,bt.ZERO)),this.m_angularVelocity=n(e.angularVelocity,0),this.m_linearDamping=n(e.linearDamping,0),this.m_angularDamping=n(e.angularDamping,0),this.m_gravityScale=n(e.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=n(e.type,t.b2BodyType.b2_staticBody),e.type===t.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=e.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}var i=e.prototype;return i.CreateFixture=function(t,e){return void 0===e&&(e=0),t instanceof si?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)},i.CreateFixtureDef=function(t){if(this.m_world.IsLocked())throw new Error;var e=new mi(this,t);return this.m_activeFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e},i.CreateFixtureShapeDensity=function(t,n){void 0===n&&(n=0);var i=e.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=n,this.CreateFixtureDef(i)},i.DestroyFixture=function(t){if(this.m_world.IsLocked())throw new Error;for(var e=this.m_fixtureList,n=null;null!==e;){if(e===t){n?n.m_next=t.m_next:this.m_fixtureList=t.m_next;break}n=e,e=e.m_next}for(var i=this.m_contactList;i;){var r=i.contact;i=i.next;var o=r.GetFixtureA(),a=r.GetFixtureB();t!==o&&t!==a||this.m_world.m_contactManager.Destroy(r)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()},i.SetTransformVec=function(t,e){this.SetTransformXY(t.x,t.y,e)},i.SetTransformXY=function(t,e,n){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(n),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=n,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=n;for(var i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(this.m_xf,this.m_xf,bt.ZERO);this.m_world.m_contactManager.FindNewContacts()},i.SetTransform=function(t){this.SetTransformVec(t.p,t.GetAngle())},i.GetTransform=function(){return this.m_xf},i.GetPosition=function(){return this.m_xf.p},i.SetPosition=function(t){this.SetTransformVec(t,this.GetAngle())},i.SetPositionXY=function(t,e){this.SetTransformXY(t,e,this.GetAngle())},i.GetAngle=function(){return this.m_sweep.a},i.SetAngle=function(t){this.SetTransformVec(this.GetPosition(),t)},i.GetWorldCenter=function(){return this.m_sweep.c},i.GetLocalCenter=function(){return this.m_sweep.localCenter},i.SetLinearVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(bt.DotVV(e,e)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(e))},i.GetLinearVelocity=function(){return this.m_linearVelocity},i.SetAngularVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e*e>0&&this.SetAwake(!0),this.m_angularVelocity=e)},i.GetAngularVelocity=function(){return this.m_angularVelocity},i.GetDefinition=function(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t},i.ApplyForce=function(e,n,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y,this.m_torque+=(n.x-this.m_sweep.c.x)*e.y-(n.y-this.m_sweep.c.y)*e.x))},i.ApplyForceToCenter=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y))},i.ApplyTorque=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=e))},i.ApplyLinearImpulse=function(e,n,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y,this.m_angularVelocity+=this.m_invI*((n.x-this.m_sweep.c.x)*e.y-(n.y-this.m_sweep.c.y)*e.x)))},i.ApplyLinearImpulseToCenter=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y))},i.ApplyAngularImpulse=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*e))},i.GetMass=function(){return this.m_mass},i.GetInertia=function(){return this.m_I+this.m_mass*bt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)},i.GetMassData=function(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*bt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t},i.SetMassData=function(n){if(this.m_world.IsLocked())throw new Error;if(this.m_type===t.b2BodyType.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=n.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,n.I>0&&!this.m_fixedRotationFlag&&(this.m_I=n.I-this.m_mass*bt.DotVV(n.center,n.center),this.m_invI=1/this.m_I);var i=e.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(n.center),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(this.m_sweep.c,i,bt.s_t0),this.m_linearVelocity)}},i.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===t.b2BodyType.b2_staticBody||this.m_type===t.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);for(var n=e.ResetMassData_s_localCenter.SetZero(),i=this.m_fixtureList;i;i=i.m_next)if(0!==i.m_density){var r=i.GetMassData(e.ResetMassData_s_massData);this.m_mass+=r.mass,n.x+=r.center.x*r.mass,n.y+=r.center.y*r.mass,this.m_I+=r.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,n.x*=this.m_invMass,n.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*bt.DotVV(n,n),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var o=e.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(n),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(this.m_sweep.c,o,bt.s_t0),this.m_linearVelocity)},i.GetWorldPoint=function(t,e){return Rt.MulXV(this.m_xf,t,e)},i.GetWorldVector=function(t,e){return It.MulRV(this.m_xf.q,t,e)},i.GetLocalPoint=function(t,e){return Rt.MulTXV(this.m_xf,t,e)},i.GetLocalVector=function(t,e){return It.MulTRV(this.m_xf.q,t,e)},i.GetLinearVelocityFromWorldPoint=function(t,e){return bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(t,this.m_sweep.c,bt.s_t0),e)},i.GetLinearVelocityFromLocalPoint=function(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)},i.GetLinearDamping=function(){return this.m_linearDamping},i.SetLinearDamping=function(t){this.m_linearDamping=t},i.GetAngularDamping=function(){return this.m_angularDamping},i.SetAngularDamping=function(t){this.m_angularDamping=t},i.GetGravityScale=function(){return this.m_gravityScale},i.SetGravityScale=function(t){this.m_gravityScale=t},i.SetType=function(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==e){this.m_type=e,this.ResetMassData(),this.m_type===t.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var n=this.m_contactList;n;){var i=n;n=n.next,this.m_world.m_contactManager.Destroy(i.contact)}this.m_contactList=null;for(var r=this.m_fixtureList;r;r=r.m_next)r.TouchProxies()}},i.GetType=function(){return this.m_type},i.SetBullet=function(t){this.m_bulletFlag=t},i.IsBullet=function(){return this.m_bulletFlag},i.SetSleepingAllowed=function(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)},i.IsSleepingAllowed=function(){return this.m_autoSleepFlag},i.SetAwake=function(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},i.IsAwake=function(){return this.m_awakeFlag},i.SetActive=function(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(var e=this.m_fixtureList;e;e=e.m_next)e.CreateProxies();else{for(var n=this.m_fixtureList;n;n=n.m_next)n.DestroyProxies();for(var i=this.m_contactList;i;){var r=i;i=i.next,this.m_world.m_contactManager.Destroy(r.contact)}this.m_contactList=null}},i.IsActive=function(){return this.m_activeFlag},i.SetFixedRotation=function(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())},i.IsFixedRotation=function(){return this.m_fixedRotationFlag},i.GetFixtureList=function(){return this.m_fixtureList},i.GetJointList=function(){return this.m_jointList},i.GetContactList=function(){return this.m_contactList},i.GetNext=function(){return this.m_next},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(t){this.m_userData=t},i.GetWorld=function(){return this.m_world},i.Dump=function(e){var n=this.m_islandIndex;e("{\n"),e("  const bd: b2BodyDef = new b2BodyDef();\n");var i="";switch(this.m_type){case t.b2BodyType.b2_staticBody:i="b2BodyType.b2_staticBody";break;case t.b2BodyType.b2_kinematicBody:i="b2BodyType.b2_kinematicBody";break;case t.b2BodyType.b2_dynamicBody:i="b2BodyType.b2_dynamicBody"}e("  bd.type = %s;\n",i),e("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),e("  bd.angle = %.15f;\n",this.m_sweep.a),e("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),e("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),e("  bd.linearDamping = %.15f;\n",this.m_linearDamping),e("  bd.angularDamping = %.15f;\n",this.m_angularDamping),e("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),e("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),e("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),e("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),e("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),e("  bd.gravityScale = %.15f;\n",this.m_gravityScale),e("\n"),e("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),e("\n");for(var r=this.m_fixtureList;r;r=r.m_next)e("  {\n"),r.Dump(e,n),e("  }\n");e("}\n")},i.SynchronizeFixtures=function(){var t=e.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),It.MulRV(t.q,this.m_sweep.localCenter,t.p),bt.SubVV(this.m_sweep.c0,t.p,t.p);for(var n=bt.SubVV(this.m_sweep.c,this.m_sweep.c0,e.SynchronizeFixtures_s_displacement),i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(t,this.m_xf,n)},i.SynchronizeTransform=function(){this.m_xf.q.SetAngle(this.m_sweep.a),It.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),bt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},i.ShouldCollide=function(e){return(this.m_type!==t.b2BodyType.b2_staticBody||e.m_type!==t.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(e)},i.ShouldCollideConnected=function(t){for(var e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0},i.Advance=function(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),It.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),bt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},i.GetControllerList=function(){return this.m_controllerList},i.GetControllerCount=function(){return this.m_controllerCount},e}();xi.CreateFixtureShapeDensity_s_def=new fi,xi.SetMassData_s_oldCenter=new bt,xi.ResetMassData_s_localCenter=new bt,xi.ResetMassData_s_oldCenter=new bt,xi.ResetMassData_s_massData=new ai,xi.SynchronizeFixtures_s_xf1=new Rt,xi.SynchronizeFixtures_s_displacement=new bt,(gi=t.b2JointType||(t.b2JointType={}))[gi.e_unknownJoint=0]="e_unknownJoint",gi[gi.e_revoluteJoint=1]="e_revoluteJoint",gi[gi.e_prismaticJoint=2]="e_prismaticJoint",gi[gi.e_distanceJoint=3]="e_distanceJoint",gi[gi.e_pulleyJoint=4]="e_pulleyJoint",gi[gi.e_mouseJoint=5]="e_mouseJoint",gi[gi.e_gearJoint=6]="e_gearJoint",gi[gi.e_wheelJoint=7]="e_wheelJoint",gi[gi.e_weldJoint=8]="e_weldJoint",gi[gi.e_frictionJoint=9]="e_frictionJoint",gi[gi.e_ropeJoint=10]="e_ropeJoint",gi[gi.e_motorJoint=11]="e_motorJoint",gi[gi.e_areaJoint=12]="e_areaJoint",(vi=t.b2LimitState||(t.b2LimitState={}))[vi.e_inactiveLimit=0]="e_inactiveLimit",vi[vi.e_atLowerLimit=1]="e_atLowerLimit",vi[vi.e_atUpperLimit=2]="e_atUpperLimit",vi[vi.e_equalLimits=3]="e_equalLimits";var Si=function(){function t(){this.linear=new bt,this.angularA=0,this.angularB=0}var e=t.prototype;return e.SetZero=function(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this},e.Set=function(t,e,n){return this.linear.Copy(t),this.angularA=e,this.angularB=n,this},t}(),Ai=function(){function t(t){this._other=null,this.prev=null,this.next=null,this.joint=t}return t.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},K(t,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t}}]),t}(),Ci=function(e){this.type=t.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=e},bi=function(){function e(e){this.m_type=t.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new Ai(this),this.m_edgeB=new Ai(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=e.type,this.m_edgeA.other=e.bodyB,this.m_edgeB.other=e.bodyA,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=n(e.collideConnected,!1),this.m_userData=n(e.userData,null)}var i=e.prototype;return i.GetType=function(){return this.m_type},i.GetBodyA=function(){return this.m_bodyA},i.GetBodyB=function(){return this.m_bodyB},i.GetNext=function(){return this.m_next},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(t){this.m_userData=t},i.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},i.GetCollideConnected=function(){return this.m_collideConnected},i.Dump=function(t){t("// Dump is not supported for this joint type.\n")},i.ShiftOrigin=function(){},e}(),Ti=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_distanceJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.length=1,n.frequencyHz=0,n.dampingRatio=0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.length=bt.DistanceVV(n,i),this.frequencyHz=0,this.dampingRatio=0},n}(Ci),Ei=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_bias=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_gamma=0,i.m_impulse=0,i.m_length=0,i.m_indexA=0,i.m_indexB=0,i.m_u=new bt,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_localAnchorA.Copy(e.localAnchorA),i.m_localAnchorB.Copy(e.localAnchorB),i.m_length=e.length,i}Q(e,t);var i=e.prototype;return i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e},i.GetReactionTorque=function(){return 0},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.SetLength=function(t){this.m_length=t},i.Length=function(){return this.m_length},i.SetFrequency=function(t){this.m_frequencyHz=t},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,c=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v,u=t.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(i),f=this.m_qB.SetAngle(c);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(_,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(f,this.m_lalcB,this.m_rB),this.m_u.x=s.x+this.m_rB.x-n.x-this.m_rA.x,this.m_u.y=s.y+this.m_rB.y-n.y-this.m_rA.y;var d=this.m_u.Length();d>h?this.m_u.SelfMul(1/d):this.m_u.SetZero();var p=bt.CrossVV(this.m_rA,this.m_u),m=bt.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*p*p+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,this.m_frequencyHz>0){var g=d-this.m_length,y=2*a*this.m_frequencyHz,x=2*this.m_mass*this.m_dampingRatio*y,S=this.m_mass*y*y,A=t.step.dt;this.m_gamma=A*(x+A*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=g*A*S*this.m_gamma,v+=this.m_gamma,this.m_mass=0!==v?1/v:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var C=bt.MulSV(this.m_impulse,this.m_u,e.InitVelocityConstraints_s_P);r.SelfMulSub(this.m_invMassA,C),o-=this.m_invIA*bt.CrossVV(this.m_rA,C),l.SelfMulAdd(this.m_invMassB,C),u+=this.m_invIB*bt.CrossVV(this.m_rB,C)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=u},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=bt.AddVCrossSV(n,i,this.m_rA,e.SolveVelocityConstraints_s_vpA),s=bt.AddVCrossSV(r,o,this.m_rB,e.SolveVelocityConstraints_s_vpB),c=bt.DotVV(this.m_u,bt.SubVV(s,a,bt.s_t0)),l=-this.m_mass*(c+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=l;var u=bt.MulSV(l,this.m_u,e.SolveVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,u),i-=this.m_invIA*bt.CrossVV(this.m_rA,u),r.SelfMulAdd(this.m_invMassB,u),o+=this.m_invIB*bt.CrossVV(this.m_rB,u),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(t){if(this.m_frequencyHz>0)return!0;var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o),c=It.MulRV(a,this.m_lalcA,this.m_rA),l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_u;u.x=r.x+l.x-n.x-c.x,u.y=r.y+l.y-n.y-c.y;var _=this.m_u.Normalize()-this.m_length;_=at(_,-v,v);var f=-this.m_mass*_,d=bt.MulSV(f,u,e.SolvePositionConstraints_s_P);return n.SelfMulSub(this.m_invMassA,d),i-=this.m_invIA*bt.CrossVV(c,d),r.SelfMulAdd(this.m_invMassB,d),o+=this.m_invIB*bt.CrossVV(l,d),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,nt(_)<h},e}(bi);Ei.InitVelocityConstraints_s_P=new bt,Ei.SolveVelocityConstraints_s_vpA=new bt,Ei.SolveVelocityConstraints_s_vpB=new bt,Ei.SolveVelocityConstraints_s_P=new bt,Ei.SolvePositionConstraints_s_P=new bt;var wi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_areaJoint)||this).bodies=[],n.frequencyHz=0,n.dampingRatio=0,n}return Q(n,e),n.prototype.AddBody=function(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)},n}(Ci),Pi=function(t){function e(e){var i;(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_impulse=0,i.m_targetArea=0,i.m_delta=new bt,i.m_bodies=e.bodies,i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_targetLengths=J(e.bodies.length),i.m_normals=bt.MakeArray(e.bodies.length),i.m_joints=[],i.m_deltas=bt.MakeArray(e.bodies.length);var r=new Ti;r.frequencyHz=i.m_frequencyHz,r.dampingRatio=i.m_dampingRatio,i.m_targetArea=0;for(var o=0;o<i.m_bodies.length;++o){var a=i.m_bodies[o],s=i.m_bodies[(o+1)%i.m_bodies.length],c=a.GetWorldCenter(),l=s.GetWorldCenter();i.m_targetLengths[o]=bt.DistanceVV(c,l),i.m_targetArea+=bt.CrossVV(c,l),r.Initialize(a,s,c,l),i.m_joints[o]=a.GetWorld().CreateJoint(r)}return i.m_targetArea*=.5,i}Q(e,t);var i=e.prototype;return i.GetAnchorA=function(t){return t},i.GetAnchorB=function(t){return t},i.GetReactionForce=function(t,e){return e},i.GetReactionTorque=function(){return 0},i.SetFrequency=function(t){this.m_frequencyHz=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(t){t("Area joint dumping is not supported.\n")},i.InitVelocityConstraints=function(t){for(var e=0;e<this.m_bodies.length;++e){var n=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],i=this.m_bodies[(e+1)%this.m_bodies.length],r=t.positions[n.m_islandIndex].c,o=t.positions[i.m_islandIndex].c,a=this.m_deltas[e];bt.SubVV(o,r,a)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(var s=0;s<this.m_bodies.length;++s){var c=this.m_bodies[s],l=t.velocities[c.m_islandIndex].v,u=this.m_deltas[s];l.x+=c.m_invMass*u.y*.5*this.m_impulse,l.y+=c.m_invMass*-u.x*.5*this.m_impulse}}else this.m_impulse=0},i.SolveVelocityConstraints=function(t){for(var e=0,n=0,i=0;i<this.m_bodies.length;++i){var r=this.m_bodies[i],o=t.velocities[r.m_islandIndex].v,a=this.m_deltas[i];e+=a.LengthSquared()/r.GetMass(),n+=bt.CrossVV(o,a)}var s=-2*n/e;this.m_impulse+=s;for(var c=0;c<this.m_bodies.length;++c){var l=this.m_bodies[c],u=t.velocities[l.m_islandIndex].v,h=this.m_deltas[c];u.x+=l.m_invMass*h.y*.5*s,u.y+=l.m_invMass*-h.x*.5*s}},i.SolvePositionConstraints=function(t){for(var e=0,n=0,i=0;i<this.m_bodies.length;++i){var o=this.m_bodies[i],a=this.m_bodies[(i+1)%this.m_bodies.length],s=t.positions[o.m_islandIndex].c,c=t.positions[a.m_islandIndex].c,l=bt.SubVV(c,s,this.m_delta),u=l.Length();u<r&&(u=1),this.m_normals[i].x=l.y/u,this.m_normals[i].y=-l.x/u,e+=u,n+=bt.CrossVV(s,c)}n*=.5;for(var _=.5*(this.m_targetArea-n)/e,f=!0,d=0;d<this.m_bodies.length;++d){var p=this.m_bodies[d],m=t.positions[p.m_islandIndex].c,g=(d+1)%this.m_bodies.length,y=bt.AddVV(this.m_normals[d],this.m_normals[g],this.m_delta);y.SelfMul(_);var x=y.LengthSquared();x>lt(v)&&y.SelfMul(v/ht(x)),x>lt(h)&&(f=!1),m.x+=y.x,m.y+=y.y}return f},e}(bi),Ii=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_frictionJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.maxForce=0,n.maxTorque=0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB)},n}(Ci),Ri=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_linearImpulse=new bt,i.m_angularImpulse=0,i.m_maxForce=0,i.m_maxTorque=0,i.m_indexA=0,i.m_indexB=0,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_linearMass=new wt,i.m_angularMass=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_K=new wt,i.m_localAnchorA.Copy(e.localAnchorA),i.m_localAnchorB.Copy(e.localAnchorB),i.m_linearImpulse.SetZero(),i.m_maxForce=n(e.maxForce,0),i.m_maxTorque=n(e.maxTorque,0),i.m_linearMass.SetZero(),i}Q(e,t);var i=e.prototype;return i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v,a=t.velocities[this.m_indexB].w,s=this.m_qA.SetAngle(e),c=this.m_qB.SetAngle(r);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var l=It.MulRV(s,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var u=It.MulRV(c,this.m_lalcB,this.m_rB),h=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,d=this.m_invIB,p=this.m_K;if(p.ex.x=h+_+f*l.y*l.y+d*u.y*u.y,p.ex.y=-f*l.x*l.y-d*u.x*u.y,p.ey.x=p.ex.y,p.ey.y=h+_+f*l.x*l.x+d*u.x*u.x,p.GetInverse(this.m_linearMass),this.m_angularMass=f+d,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var m=this.m_linearImpulse;n.SelfMulSub(h,m),i-=f*(bt.CrossVV(this.m_rA,m)+this.m_angularImpulse),o.SelfMulAdd(_,m),a+=d*(bt.CrossVV(this.m_rB,m)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=a},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,u=t.step.dt,h=o-i,_=-this.m_angularMass*h,f=this.m_angularImpulse,d=u*this.m_maxTorque;this.m_angularImpulse=at(this.m_angularImpulse+_,-d,d),i-=c*(_=this.m_angularImpulse-f),o+=l*_;var p=bt.SubVV(bt.AddVCrossSV(r,o,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,i,this.m_rA,bt.s_t1),e.SolveVelocityConstraints_s_Cdot_v2),m=wt.MulMV(this.m_linearMass,p,e.SolveVelocityConstraints_s_impulseV).SelfNeg(),v=e.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(m);var g=u*this.m_maxForce;this.m_linearImpulse.LengthSquared()>g*g&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(g)),bt.SubVV(this.m_linearImpulse,v,m),n.SelfMulSub(a,m),i-=c*bt.CrossVV(this.m_rA,m),r.SelfMulAdd(s,m),o+=l*bt.CrossVV(this.m_rB,m),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(){return!0},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e},i.GetReactionTorque=function(t){return t*this.m_angularImpulse},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.SetMaxForce=function(t){this.m_maxForce=t},i.GetMaxForce=function(){return this.m_maxForce},i.SetMaxTorque=function(t){this.m_maxTorque=t},i.GetMaxTorque=function(){return this.m_maxTorque},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);Ri.SolveVelocityConstraints_s_Cdot_v2=new bt,Ri.SolveVelocityConstraints_s_impulseV=new bt,Ri.SolveVelocityConstraints_s_oldImpulseV=new bt;var Di=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_gearJoint)||this).ratio=1,n}return Q(n,e),n}(Ci),Mi=function(e){function i(i){var r,o,a;(r=e.call(this,i)||this).m_typeA=t.b2JointType.e_unknownJoint,r.m_typeB=t.b2JointType.e_unknownJoint,r.m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_localAnchorC=new bt,r.m_localAnchorD=new bt,r.m_localAxisC=new bt,r.m_localAxisD=new bt,r.m_referenceAngleA=0,r.m_referenceAngleB=0,r.m_constant=0,r.m_ratio=0,r.m_impulse=0,r.m_indexA=0,r.m_indexB=0,r.m_indexC=0,r.m_indexD=0,r.m_lcA=new bt,r.m_lcB=new bt,r.m_lcC=new bt,r.m_lcD=new bt,r.m_mA=0,r.m_mB=0,r.m_mC=0,r.m_mD=0,r.m_iA=0,r.m_iB=0,r.m_iC=0,r.m_iD=0,r.m_JvAC=new bt,r.m_JvBD=new bt,r.m_JwA=0,r.m_JwB=0,r.m_JwC=0,r.m_JwD=0,r.m_mass=0,r.m_qA=new It,r.m_qB=new It,r.m_qC=new It,r.m_qD=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_lalcC=new bt,r.m_lalcD=new bt,r.m_joint1=i.joint1,r.m_joint2=i.joint2,r.m_typeA=r.m_joint1.GetType(),r.m_typeB=r.m_joint2.GetType(),r.m_bodyC=r.m_joint1.GetBodyA(),r.m_bodyA=r.m_joint1.GetBodyB();var s=r.m_bodyA.m_xf,c=r.m_bodyA.m_sweep.a,l=r.m_bodyC.m_xf,u=r.m_bodyC.m_sweep.a;if(r.m_typeA===t.b2JointType.e_revoluteJoint){var h=i.joint1;r.m_localAnchorC.Copy(h.m_localAnchorA),r.m_localAnchorA.Copy(h.m_localAnchorB),r.m_referenceAngleA=h.m_referenceAngle,r.m_localAxisC.SetZero(),o=c-u-r.m_referenceAngleA}else{var _=i.joint1;r.m_localAnchorC.Copy(_.m_localAnchorA),r.m_localAnchorA.Copy(_.m_localAnchorB),r.m_referenceAngleA=_.m_referenceAngle,r.m_localAxisC.Copy(_.m_localXAxisA);var f=r.m_localAnchorC,d=It.MulTRV(l.q,bt.AddVV(It.MulRV(s.q,r.m_localAnchorA,bt.s_t0),bt.SubVV(s.p,l.p,bt.s_t1),bt.s_t0),bt.s_t0);o=bt.DotVV(bt.SubVV(d,f,bt.s_t0),r.m_localAxisC)}r.m_bodyD=r.m_joint2.GetBodyA(),r.m_bodyB=r.m_joint2.GetBodyB();var p=r.m_bodyB.m_xf,m=r.m_bodyB.m_sweep.a,v=r.m_bodyD.m_xf,g=r.m_bodyD.m_sweep.a;if(r.m_typeB===t.b2JointType.e_revoluteJoint){var y=i.joint2;r.m_localAnchorD.Copy(y.m_localAnchorA),r.m_localAnchorB.Copy(y.m_localAnchorB),r.m_referenceAngleB=y.m_referenceAngle,r.m_localAxisD.SetZero(),a=m-g-r.m_referenceAngleB}else{var x=i.joint2;r.m_localAnchorD.Copy(x.m_localAnchorA),r.m_localAnchorB.Copy(x.m_localAnchorB),r.m_referenceAngleB=x.m_referenceAngle,r.m_localAxisD.Copy(x.m_localXAxisA);var S=r.m_localAnchorD,A=It.MulTRV(v.q,bt.AddVV(It.MulRV(p.q,r.m_localAnchorB,bt.s_t0),bt.SubVV(p.p,v.p,bt.s_t1),bt.s_t0),bt.s_t0);a=bt.DotVV(bt.SubVV(A,S,bt.s_t0),r.m_localAxisD)}return r.m_ratio=n(i.ratio,1),r.m_constant=o+r.m_ratio*a,r.m_impulse=0,r}Q(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var n=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,c=e.velocities[this.m_indexB].w,l=e.positions[this.m_indexC].a,u=e.velocities[this.m_indexC].v,h=e.velocities[this.m_indexC].w,_=e.positions[this.m_indexD].a,f=e.velocities[this.m_indexD].v,d=e.velocities[this.m_indexD].w,p=this.m_qA.SetAngle(n),m=this.m_qB.SetAngle(a),v=this.m_qC.SetAngle(l),g=this.m_qD.SetAngle(_);if(this.m_mass=0,this.m_typeA===t.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var y=It.MulRV(v,this.m_localAxisC,i.InitVelocityConstraints_s_u);bt.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);var x=It.MulRV(v,this.m_lalcC,i.InitVelocityConstraints_s_rC);bt.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);var S=It.MulRV(p,this.m_lalcA,i.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(y),this.m_JwC=bt.CrossVV(x,y),this.m_JwA=bt.CrossVV(S,y),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===t.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{var A=It.MulRV(g,this.m_localAxisD,i.InitVelocityConstraints_s_u);bt.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);var C=It.MulRV(g,this.m_lalcD,i.InitVelocityConstraints_s_rD);bt.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);var b=It.MulRV(m,this.m_lalcB,i.InitVelocityConstraints_s_rB);bt.MulSV(this.m_ratio,A,this.m_JvBD),this.m_JwD=this.m_ratio*bt.CrossVV(C,A),this.m_JwB=this.m_ratio*bt.CrossVV(b,A),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.step.warmStarting?(r.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),o+=this.m_iA*this.m_impulse*this.m_JwA,s.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),c+=this.m_iB*this.m_impulse*this.m_JwB,u.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),h-=this.m_iC*this.m_impulse*this.m_JwC,f.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),d-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=c,e.velocities[this.m_indexC].w=h,e.velocities[this.m_indexD].w=d},r.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,i=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,o=t.velocities[this.m_indexC].v,a=t.velocities[this.m_indexC].w,s=t.velocities[this.m_indexD].v,c=t.velocities[this.m_indexD].w,l=bt.DotVV(this.m_JvAC,bt.SubVV(e,o,bt.s_t0))+bt.DotVV(this.m_JvBD,bt.SubVV(i,s,bt.s_t0));l+=this.m_JwA*n-this.m_JwC*a+(this.m_JwB*r-this.m_JwD*c);var u=-this.m_mass*l;this.m_impulse+=u,e.SelfMulAdd(this.m_mA*u,this.m_JvAC),n+=this.m_iA*u*this.m_JwA,i.SelfMulAdd(this.m_mB*u,this.m_JvBD),r+=this.m_iB*u*this.m_JwB,o.SelfMulSub(this.m_mC*u,this.m_JvAC),a-=this.m_iC*u*this.m_JwC,s.SelfMulSub(this.m_mD*u,this.m_JvBD),c-=this.m_iD*u*this.m_JwD,t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=r,t.velocities[this.m_indexC].w=a,t.velocities[this.m_indexD].w=c},r.SolvePositionConstraints=function(e){var n,r,o,a,s,c,l=e.positions[this.m_indexA].c,u=e.positions[this.m_indexA].a,_=e.positions[this.m_indexB].c,f=e.positions[this.m_indexB].a,d=e.positions[this.m_indexC].c,p=e.positions[this.m_indexC].a,m=e.positions[this.m_indexD].c,v=e.positions[this.m_indexD].a,g=this.m_qA.SetAngle(u),y=this.m_qB.SetAngle(f),x=this.m_qC.SetAngle(p),S=this.m_qD.SetAngle(v),A=0,C=this.m_JvAC,b=this.m_JvBD,T=0;if(this.m_typeA===t.b2JointType.e_revoluteJoint)C.SetZero(),o=1,s=1,T+=this.m_iA+this.m_iC,n=u-p-this.m_referenceAngleA;else{var E=It.MulRV(x,this.m_localAxisC,i.SolvePositionConstraints_s_u),w=It.MulRV(x,this.m_lalcC,i.SolvePositionConstraints_s_rC),P=It.MulRV(g,this.m_lalcA,i.SolvePositionConstraints_s_rA);C.Copy(E),s=bt.CrossVV(w,E),o=bt.CrossVV(P,E),T+=this.m_mC+this.m_mA+this.m_iC*s*s+this.m_iA*o*o;var I=this.m_lalcC,R=It.MulTRV(x,bt.AddVV(P,bt.SubVV(l,d,bt.s_t0),bt.s_t0),bt.s_t0);n=bt.DotVV(bt.SubVV(R,I,bt.s_t0),this.m_localAxisC)}if(this.m_typeB===t.b2JointType.e_revoluteJoint)b.SetZero(),a=this.m_ratio,c=this.m_ratio,T+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),r=f-v-this.m_referenceAngleB;else{var D=It.MulRV(S,this.m_localAxisD,i.SolvePositionConstraints_s_u),M=It.MulRV(S,this.m_lalcD,i.SolvePositionConstraints_s_rD),B=It.MulRV(y,this.m_lalcB,i.SolvePositionConstraints_s_rB);bt.MulSV(this.m_ratio,D,b),c=this.m_ratio*bt.CrossVV(M,D),a=this.m_ratio*bt.CrossVV(B,D),T+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*c*c+this.m_iB*a*a;var O=this.m_lalcD,N=It.MulTRV(S,bt.AddVV(B,bt.SubVV(_,m,bt.s_t0),bt.s_t0),bt.s_t0);r=bt.DotVV(bt.SubVV(N,O,bt.s_t0),this.m_localAxisD)}var L=n+this.m_ratio*r-this.m_constant,F=0;return T>0&&(F=-L/T),l.SelfMulAdd(this.m_mA*F,C),u+=this.m_iA*F*o,_.SelfMulAdd(this.m_mB*F,b),f+=this.m_iB*F*a,d.SelfMulSub(this.m_mC*F,C),p-=this.m_iC*F*s,m.SelfMulSub(this.m_mD*F,b),v-=this.m_iD*F*c,e.positions[this.m_indexA].a=u,e.positions[this.m_indexB].a=f,e.positions[this.m_indexC].a=p,e.positions[this.m_indexD].a=v,A<h},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return bt.MulSV(t*this.m_impulse,this.m_JvAC,e)},r.GetReactionTorque=function(t){return t*this.m_impulse*this.m_JwA},r.GetJoint1=function(){return this.m_joint1},r.GetJoint2=function(){return this.m_joint2},r.GetRatio=function(){return this.m_ratio},r.SetRatio=function(t){this.m_ratio=t},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex,i=this.m_joint1.m_index,r=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",i),t("  jd.joint2 = joints[%d];\n",r),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Mi.InitVelocityConstraints_s_u=new bt,Mi.InitVelocityConstraints_s_rA=new bt,Mi.InitVelocityConstraints_s_rB=new bt,Mi.InitVelocityConstraints_s_rC=new bt,Mi.InitVelocityConstraints_s_rD=new bt,Mi.SolvePositionConstraints_s_u=new bt,Mi.SolvePositionConstraints_s_rA=new bt,Mi.SolvePositionConstraints_s_rB=new bt,Mi.SolvePositionConstraints_s_rC=new bt,Mi.SolvePositionConstraints_s_rD=new bt;var Bi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_motorJoint)||this).linearOffset=new bt(0,0),n.angularOffset=0,n.maxForce=1,n.maxTorque=1,n.correctionFactor=.3,n}return Q(n,e),n.prototype.Initialize=function(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);var n=this.bodyA.GetAngle(),i=this.bodyB.GetAngle();this.angularOffset=i-n},n}(Ci),Oi=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_linearOffset=new bt,i.m_angularOffset=0,i.m_linearImpulse=new bt,i.m_angularImpulse=0,i.m_maxForce=0,i.m_maxTorque=0,i.m_correctionFactor=.3,i.m_indexA=0,i.m_indexB=0,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_linearError=new bt,i.m_angularError=0,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_linearMass=new wt,i.m_angularMass=0,i.m_qA=new It,i.m_qB=new It,i.m_K=new wt,i.m_linearOffset.Copy(n(e.linearOffset,bt.ZERO)),i.m_linearImpulse.SetZero(),i.m_maxForce=n(e.maxForce,0),i.m_maxTorque=n(e.maxTorque,0),i.m_correctionFactor=n(e.correctionFactor,.3),i}Q(e,t);var i=e.prototype;return i.GetAnchorA=function(t){var e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t},i.GetAnchorB=function(t){var e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t},i.GetReactionForce=function(t,e){return bt.MulSV(t,this.m_linearImpulse,e)},i.GetReactionTorque=function(t){return t*this.m_angularImpulse},i.SetLinearOffset=function(t){bt.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))},i.GetLinearOffset=function(){return this.m_linearOffset},i.SetAngularOffset=function(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)},i.GetAngularOffset=function(){return this.m_angularOffset},i.SetMaxForce=function(t){this.m_maxForce=t},i.GetMaxForce=function(){return this.m_maxForce},i.SetMaxTorque=function(t){this.m_maxTorque=t},i.GetMaxTorque=function(){return this.m_maxTorque},i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,c=t.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a),h=It.MulRV(l,bt.SubVV(this.m_linearOffset,this.m_localCenterA,bt.s_t0),this.m_rA),_=It.MulRV(u,bt.NegV(this.m_localCenterB,bt.s_t0),this.m_rB),f=this.m_invMassA,d=this.m_invMassB,p=this.m_invIA,m=this.m_invIB,v=this.m_K;if(v.ex.x=f+d+p*h.y*h.y+m*_.y*_.y,v.ex.y=-p*h.x*h.y-m*_.x*_.y,v.ey.x=v.ex.y,v.ey.y=f+d+p*h.x*h.x+m*_.x*_.x,v.GetInverse(this.m_linearMass),this.m_angularMass=p+m,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),bt.SubVV(bt.AddVV(o,_,bt.s_t0),bt.AddVV(e,h,bt.s_t1),this.m_linearError),this.m_angularError=a-n-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var g=this.m_linearImpulse;i.SelfMulSub(f,g),r-=p*(bt.CrossVV(h,g)+this.m_angularImpulse),s.SelfMulAdd(d,g),c+=m*(bt.CrossVV(_,g)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=c},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,u=t.step.dt,h=t.step.inv_dt,_=o-i+h*this.m_correctionFactor*this.m_angularError,f=-this.m_angularMass*_,d=this.m_angularImpulse,p=u*this.m_maxTorque;this.m_angularImpulse=at(this.m_angularImpulse+f,-p,p),i-=c*(f=this.m_angularImpulse-d),o+=l*f;var m=this.m_rA,v=this.m_rB,g=bt.AddVV(bt.SubVV(bt.AddVV(r,bt.CrossSV(o,v,bt.s_t0),bt.s_t0),bt.AddVV(n,bt.CrossSV(i,m,bt.s_t1),bt.s_t1),bt.s_t2),bt.MulSV(h*this.m_correctionFactor,this.m_linearError,bt.s_t3),e.SolveVelocityConstraints_s_Cdot_v2),y=wt.MulMV(this.m_linearMass,g,e.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),x=e.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(y);var S=u*this.m_maxForce;this.m_linearImpulse.LengthSquared()>S*S&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(S)),bt.SubVV(this.m_linearImpulse,x,y),n.SelfMulSub(a,y),i-=c*bt.CrossVV(m,y),r.SelfMulAdd(s,y),o+=l*bt.CrossVV(v,y),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(){return!0},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);Oi.SolveVelocityConstraints_s_Cdot_v2=new bt,Oi.SolveVelocityConstraints_s_impulse_v2=new bt,Oi.SolveVelocityConstraints_s_oldImpulse_v2=new bt;var Ni=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_mouseJoint)||this).target=new bt,n.maxForce=0,n.frequencyHz=5,n.dampingRatio=.7,n}return Q(n,e),n}(Ci),Li=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_localAnchorB=new bt,i.m_targetA=new bt,i.m_frequencyHz=0,i.m_dampingRatio=0,i.m_beta=0,i.m_impulse=new bt,i.m_maxForce=0,i.m_gamma=0,i.m_indexA=0,i.m_indexB=0,i.m_rB=new bt,i.m_localCenterB=new bt,i.m_invMassB=0,i.m_invIB=0,i.m_mass=new wt,i.m_C=new bt,i.m_qB=new It,i.m_lalcB=new bt,i.m_K=new wt,i.m_targetA.Copy(n(e.target,bt.ZERO)),Rt.MulTXV(i.m_bodyB.GetTransform(),i.m_targetA,i.m_localAnchorB),i.m_maxForce=n(e.maxForce,0),i.m_impulse.SetZero(),i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_beta=0,i.m_gamma=0,i}Q(e,t);var i=e.prototype;return i.SetTarget=function(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)},i.GetTarget=function(){return this.m_targetA},i.SetMaxForce=function(t){this.m_maxForce=t},i.GetMaxForce=function(){return this.m_maxForce},i.SetFrequency=function(t){this.m_frequencyHz=t},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t},i.GetDampingRatio=function(){return this.m_dampingRatio},i.InitVelocityConstraints=function(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexB].c,n=t.positions[this.m_indexB].a,i=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,o=this.m_qB.SetAngle(n),s=this.m_bodyB.GetMass(),c=2*a*this.m_frequencyHz,l=2*s*this.m_dampingRatio*c,u=s*c*c,h=t.step.dt;this.m_gamma=h*(l+h*u),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=h*u*this.m_gamma,bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(o,this.m_lalcB,this.m_rB);var _=this.m_K;_.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,_.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,_.ey.x=_.ex.y,_.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,_.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),r*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),i.x+=this.m_invMassB*this.m_impulse.x,i.y+=this.m_invMassB*this.m_impulse.y,r+=this.m_invIB*bt.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=r},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexB].v,i=t.velocities[this.m_indexB].w,r=bt.AddVCrossSV(n,i,this.m_rB,e.SolveVelocityConstraints_s_Cdot),o=wt.MulMV(this.m_mass,bt.AddVV(r,bt.AddVV(this.m_C,bt.MulSV(this.m_gamma,this.m_impulse,bt.s_t0),bt.s_t0),bt.s_t0).SelfNeg(),e.SolveVelocityConstraints_s_impulse),a=e.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(o);var s=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>s*s&&this.m_impulse.SelfMul(s/this.m_impulse.Length()),bt.SubVV(this.m_impulse,a,o),n.SelfMulAdd(this.m_invMassB,o),i+=this.m_invIB*bt.CrossVV(this.m_rB,o),t.velocities[this.m_indexB].w=i},i.SolvePositionConstraints=function(){return!0},i.GetAnchorA=function(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return bt.MulSV(t,this.m_impulse,e)},i.GetReactionTorque=function(){return 0},i.Dump=function(t){t("Mouse joint dumping is not supported.\n")},i.ShiftOrigin=function(t){this.m_targetA.SelfSub(t)},e}(bi);Li.SolveVelocityConstraints_s_Cdot=new bt,Li.SolveVelocityConstraints_s_impulse=new bt,Li.SolveVelocityConstraints_s_oldImpulse=new bt;var Fi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_prismaticJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.localAxisA=new bt(1,0),n.referenceAngle=0,n.enableLimit=!1,n.lowerTranslation=0,n.upperTranslation=0,n.enableMotor=!1,n.maxMotorForce=0,n.motorSpeed=0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.bodyA.GetLocalVector(i,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ci),zi=function(e){function i(i){var r;return(r=e.call(this,i)||this).m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_localXAxisA=new bt,r.m_localYAxisA=new bt,r.m_referenceAngle=0,r.m_impulse=new Et(0,0,0),r.m_motorImpulse=0,r.m_lowerTranslation=0,r.m_upperTranslation=0,r.m_maxMotorForce=0,r.m_motorSpeed=0,r.m_enableLimit=!1,r.m_enableMotor=!1,r.m_limitState=t.b2LimitState.e_inactiveLimit,r.m_indexA=0,r.m_indexB=0,r.m_localCenterA=new bt,r.m_localCenterB=new bt,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_axis=new bt(0,0),r.m_perp=new bt(0,0),r.m_s1=0,r.m_s2=0,r.m_a1=0,r.m_a2=0,r.m_K=new Pt,r.m_K3=new Pt,r.m_K2=new wt,r.m_motorMass=0,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_rA=new bt,r.m_rB=new bt,r.m_localAnchorA.Copy(n(i.localAnchorA,bt.ZERO)),r.m_localAnchorB.Copy(n(i.localAnchorB,bt.ZERO)),r.m_localXAxisA.Copy(n(i.localAxisA,new bt(1,0))).SelfNormalize(),bt.CrossOneV(r.m_localXAxisA,r.m_localYAxisA),r.m_referenceAngle=n(i.referenceAngle,0),r.m_lowerTranslation=n(i.lowerTranslation,0),r.m_upperTranslation=n(i.upperTranslation,0),r.m_maxMotorForce=n(i.maxMotorForce,0),r.m_motorSpeed=n(i.motorSpeed,0),r.m_enableLimit=n(i.enableLimit,!1),r.m_enableMotor=n(i.enableMotor,!1),r}Q(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.velocities[this.m_indexA].v,a=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].c,c=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v,u=e.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(r),f=this.m_qB.SetAngle(c);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var d=It.MulRV(_,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var p=It.MulRV(f,this.m_lalcB,this.m_rB),m=bt.AddVV(bt.SubVV(s,n,bt.s_t0),bt.SubVV(p,d,bt.s_t1),i.InitVelocityConstraints_s_d),v=this.m_invMassA,g=this.m_invMassB,y=this.m_invIA,x=this.m_invIB;if(It.MulRV(_,this.m_localXAxisA,this.m_axis),this.m_a1=bt.CrossVV(bt.AddVV(m,d,bt.s_t0),this.m_axis),this.m_a2=bt.CrossVV(p,this.m_axis),this.m_motorMass=v+g+y*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),It.MulRV(_,this.m_localYAxisA,this.m_perp),this.m_s1=bt.CrossVV(bt.AddVV(m,d,bt.s_t0),this.m_perp),this.m_s2=bt.CrossVV(p,this.m_perp),this.m_K.ex.x=v+g+y*this.m_s1*this.m_s1+x*this.m_s2*this.m_s2,this.m_K.ex.y=y*this.m_s1+x*this.m_s2,this.m_K.ex.z=y*this.m_s1*this.m_a1+x*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=y+x,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=y*this.m_a1+x*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=v+g+y*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_enableLimit){var S=bt.DotVV(this.m_axis,m);nt(this.m_upperTranslation-this.m_lowerTranslation)<2*h?this.m_limitState=t.b2LimitState.e_equalLimits:S<=this.m_lowerTranslation?this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_limitState=t.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):S>=this.m_upperTranslation?this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_limitState=t.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var A=bt.AddVV(bt.MulSV(this.m_impulse.x,this.m_perp,bt.s_t0),bt.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,bt.s_t1),i.InitVelocityConstraints_s_P),C=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,b=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;o.SelfMulSub(v,A),a-=y*C,l.SelfMulAdd(g,A),u+=x*b}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=a,e.velocities[this.m_indexB].w=u},r.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,o=e.velocities[this.m_indexB].v,a=e.velocities[this.m_indexB].w,s=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,u=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits){var h=bt.DotVV(this.m_axis,bt.SubVV(o,n,bt.s_t0))+this.m_a2*a-this.m_a1*r,_=this.m_motorMass*(this.m_motorSpeed-h),f=this.m_motorImpulse,d=e.step.dt*this.m_maxMotorForce;this.m_motorImpulse=at(this.m_motorImpulse+_,-d,d),_=this.m_motorImpulse-f;var p=bt.MulSV(_,this.m_axis,i.SolveVelocityConstraints_s_P),m=_*this.m_a1,v=_*this.m_a2;n.SelfMulSub(s,p),r-=l*m,o.SelfMulAdd(c,p),a+=u*v}var g=bt.DotVV(this.m_perp,bt.SubVV(o,n,bt.s_t0))+this.m_s2*a-this.m_s1*r,y=a-r;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit){var x=bt.DotVV(this.m_axis,bt.SubVV(o,n,bt.s_t0))+this.m_a2*a-this.m_a1*r,S=i.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),A=this.m_K.Solve33(-g,-y,-x,i.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(A),this.m_limitState===t.b2LimitState.e_atLowerLimit?this.m_impulse.z=rt(this.m_impulse.z,0):this.m_limitState===t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=it(this.m_impulse.z,0));var C=-g-(this.m_impulse.z-S.z)*this.m_K.ez.x,b=-y-(this.m_impulse.z-S.z)*this.m_K.ez.y,T=this.m_K.Solve22(C,b,i.SolveVelocityConstraints_s_f2r);T.x+=S.x,T.y+=S.y,this.m_impulse.x=T.x,this.m_impulse.y=T.y,A.x=this.m_impulse.x-S.x,A.y=this.m_impulse.y-S.y,A.z=this.m_impulse.z-S.z;var E=bt.AddVV(bt.MulSV(A.x,this.m_perp,bt.s_t0),bt.MulSV(A.z,this.m_axis,bt.s_t1),i.SolveVelocityConstraints_s_P),w=A.x*this.m_s1+A.y+A.z*this.m_a1,P=A.x*this.m_s2+A.y+A.z*this.m_a2;n.SelfMulSub(s,E),r-=l*w,o.SelfMulAdd(c,E),a+=u*P}else{var I=this.m_K.Solve22(-g,-y,i.SolveVelocityConstraints_s_df2);this.m_impulse.x+=I.x,this.m_impulse.y+=I.y;var R=bt.MulSV(I.x,this.m_perp,i.SolveVelocityConstraints_s_P),D=I.x*this.m_s1+I.y,M=I.x*this.m_s2+I.y;n.SelfMulSub(s,R),r-=l*D,o.SelfMulAdd(c,R),a+=u*M}e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=a},r.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o),c=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,d=It.MulRV(a,this.m_lalcA,this.m_rA),p=It.MulRV(s,this.m_lalcB,this.m_rB),m=bt.SubVV(bt.AddVV(r,p,bt.s_t0),bt.AddVV(e,d,bt.s_t1),i.SolvePositionConstraints_s_d),g=It.MulRV(a,this.m_localXAxisA,this.m_axis),y=bt.CrossVV(bt.AddVV(m,d,bt.s_t0),g),x=bt.CrossVV(p,g),S=It.MulRV(a,this.m_localYAxisA,this.m_perp),A=bt.CrossVV(bt.AddVV(m,d,bt.s_t0),S),C=bt.CrossVV(p,S),b=i.SolvePositionConstraints_s_impulse,T=bt.DotVV(S,m),E=o-n-this.m_referenceAngle,w=nt(T),P=nt(E),I=!1,R=0;if(this.m_enableLimit){var D=bt.DotVV(g,m);nt(this.m_upperTranslation-this.m_lowerTranslation)<2*h?(R=at(D,-v,v),w=rt(w,nt(D)),I=!0):D<=this.m_lowerTranslation?(R=at(D-this.m_lowerTranslation+h,-v,0),w=rt(w,this.m_lowerTranslation-D),I=!0):D>=this.m_upperTranslation&&(R=at(D-this.m_upperTranslation-h,0,v),w=rt(w,D-this.m_upperTranslation),I=!0)}if(I){var M=c+l+u*A*A+f*C*C,B=u*A+f*C,O=u*A*y+f*C*x,N=u+f;0===N&&(N=1);var L=u*y+f*x,F=c+l+u*y*y+f*x*x,z=this.m_K3;z.ex.SetXYZ(M,B,O),z.ey.SetXYZ(B,N,L),z.ez.SetXYZ(O,L,F),b=z.Solve33(-T,-E,-R,b)}else{var V=c+l+u*A*A+f*C*C,k=u*A+f*C,G=u+f;0===G&&(G=1);var U=this.m_K2;U.ex.Set(V,k),U.ey.Set(k,G);var H=U.Solve(-T,-E,i.SolvePositionConstraints_s_impulse1);b.x=H.x,b.y=H.y,b.z=0}var j=bt.AddVV(bt.MulSV(b.x,S,bt.s_t0),bt.MulSV(b.z,g,bt.s_t1),i.SolvePositionConstraints_s_P),W=b.x*A+b.y+b.z*y,q=b.x*C+b.y+b.z*x;return e.SelfMulSub(c,j),n-=u*W,r.SelfMulAdd(l,j),o+=f*q,t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,w<=h&&P<=_},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e},r.GetReactionTorque=function(t){return t*this.m_impulse.y},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.GetLocalAxisA=function(){return this.m_localXAxisA},r.GetReferenceAngle=function(){return this.m_referenceAngle},r.GetJointTranslation=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,i.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,i.GetJointTranslation_s_pB),n=bt.SubVV(e,t,i.GetJointTranslation_s_d),r=this.m_bodyA.GetWorldVector(this.m_localXAxisA,i.GetJointTranslation_s_axis);return bt.DotVV(n,r)},r.GetJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;bt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var n=It.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var i=It.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),r=bt.AddVV(t.m_sweep.c,n,bt.s_t0),o=bt.AddVV(e.m_sweep.c,i,bt.s_t1),a=bt.SubVV(o,r,bt.s_t2),s=t.GetWorldVector(this.m_localXAxisA,this.m_axis),c=t.m_linearVelocity,l=e.m_linearVelocity,u=t.m_angularVelocity,h=e.m_angularVelocity;return bt.DotVV(a,bt.CrossSV(u,s,bt.s_t0))+bt.DotVV(s,bt.SubVV(bt.AddVCrossSV(l,h,i,bt.s_t0),bt.AddVCrossSV(c,u,n,bt.s_t1),bt.s_t0))},r.IsLimitEnabled=function(){return this.m_enableLimit},r.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},r.GetLowerLimit=function(){return this.m_lowerTranslation},r.GetUpperLimit=function(){return this.m_upperTranslation},r.SetLimits=function(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)},r.IsMotorEnabled=function(){return this.m_enableMotor},r.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},r.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},r.GetMotorSpeed=function(){return this.m_motorSpeed},r.SetMaxMotorForce=function(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)},r.GetMaxMotorForce=function(){return this.m_maxMotorForce},r.GetMotorForce=function(t){return t*this.m_motorImpulse},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);zi.InitVelocityConstraints_s_d=new bt,zi.InitVelocityConstraints_s_P=new bt,zi.SolveVelocityConstraints_s_P=new bt,zi.SolveVelocityConstraints_s_f2r=new bt,zi.SolveVelocityConstraints_s_f1=new Et,zi.SolveVelocityConstraints_s_df3=new Et,zi.SolveVelocityConstraints_s_df2=new bt,zi.SolvePositionConstraints_s_d=new bt,zi.SolvePositionConstraints_s_impulse=new Et,zi.SolvePositionConstraints_s_impulse1=new bt,zi.SolvePositionConstraints_s_P=new bt,zi.GetJointTranslation_s_pA=new bt,zi.GetJointTranslation_s_pB=new bt,zi.GetJointTranslation_s_d=new bt,zi.GetJointTranslation_s_axis=new bt;var Vi=2,ki=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_pulleyJoint)||this).groundAnchorA=new bt(-1,1),n.groundAnchorB=new bt(1,1),n.localAnchorA=new bt(-1,0),n.localAnchorB=new bt(1,0),n.lengthA=0,n.lengthB=0,n.ratio=1,n.collideConnected=!0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n,i,r,o,a){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(n),this.groundAnchorB.Copy(i),this.bodyA.GetLocalPoint(r,this.localAnchorA),this.bodyB.GetLocalPoint(o,this.localAnchorB),this.lengthA=bt.DistanceVV(r,n),this.lengthB=bt.DistanceVV(o,i),this.ratio=a},n}(Ci),Gi=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_groundAnchorA=new bt,i.m_groundAnchorB=new bt,i.m_lengthA=0,i.m_lengthB=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_constant=0,i.m_ratio=0,i.m_impulse=0,i.m_indexA=0,i.m_indexB=0,i.m_uA=new bt,i.m_uB=new bt,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_groundAnchorA.Copy(n(e.groundAnchorA,new bt(-1,1))),i.m_groundAnchorB.Copy(n(e.groundAnchorB,new bt(1,0))),i.m_localAnchorA.Copy(n(e.localAnchorA,new bt(-1,0))),i.m_localAnchorB.Copy(n(e.localAnchorB,new bt(1,0))),i.m_lengthA=n(e.lengthA,0),i.m_lengthB=n(e.lengthB,0),i.m_ratio=n(e.ratio,1),i.m_constant=n(e.lengthA,0)+i.m_ratio*n(e.lengthB,0),i.m_impulse=0,i}Q(e,t);var i=e.prototype;return i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,a=t.positions[this.m_indexB].c,s=t.positions[this.m_indexB].a,c=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,u=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(s);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(u,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(_,this.m_lalcB,this.m_rB),this.m_uA.Copy(n).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(a).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);var f=this.m_uA.Length(),d=this.m_uB.Length();f>10*h?this.m_uA.SelfMul(1/f):this.m_uA.SetZero(),d>10*h?this.m_uB.SelfMul(1/d):this.m_uB.SetZero();var p=bt.CrossVV(this.m_rA,this.m_uA),m=bt.CrossVV(this.m_rB,this.m_uB),v=this.m_invMassA+this.m_invIA*p*p,g=this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=v+this.m_ratio*this.m_ratio*g,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var y=bt.MulSV(-this.m_impulse,this.m_uA,e.InitVelocityConstraints_s_PA),x=bt.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,e.InitVelocityConstraints_s_PB);r.SelfMulAdd(this.m_invMassA,y),o+=this.m_invIA*bt.CrossVV(this.m_rA,y),c.SelfMulAdd(this.m_invMassB,x),l+=this.m_invIB*bt.CrossVV(this.m_rB,x)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=l},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=bt.AddVCrossSV(n,i,this.m_rA,e.SolveVelocityConstraints_s_vpA),s=bt.AddVCrossSV(r,o,this.m_rB,e.SolveVelocityConstraints_s_vpB),c=-bt.DotVV(this.m_uA,a)-this.m_ratio*bt.DotVV(this.m_uB,s),l=-this.m_mass*c;this.m_impulse+=l;var u=bt.MulSV(-l,this.m_uA,e.SolveVelocityConstraints_s_PA),h=bt.MulSV(-this.m_ratio*l,this.m_uB,e.SolveVelocityConstraints_s_PB);n.SelfMulAdd(this.m_invMassA,u),i+=this.m_invIA*bt.CrossVV(this.m_rA,u),r.SelfMulAdd(this.m_invMassB,h),o+=this.m_invIB*bt.CrossVV(this.m_rB,h),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(t){var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_uA.Copy(n).SelfAdd(c).SelfSub(this.m_groundAnchorA),_=this.m_uB.Copy(r).SelfAdd(l).SelfSub(this.m_groundAnchorB),f=u.Length(),d=_.Length();f>10*h?u.SelfMul(1/f):u.SetZero(),d>10*h?_.SelfMul(1/d):_.SetZero();var p=bt.CrossVV(c,u),m=bt.CrossVV(l,_),v=this.m_invMassA+this.m_invIA*p*p,g=this.m_invMassB+this.m_invIB*m*m,y=v+this.m_ratio*this.m_ratio*g;y>0&&(y=1/y);var x=this.m_constant-f-this.m_ratio*d,S=nt(x),A=-y*x,C=bt.MulSV(-A,u,e.SolvePositionConstraints_s_PA),b=bt.MulSV(-this.m_ratio*A,_,e.SolvePositionConstraints_s_PB);return n.SelfMulAdd(this.m_invMassA,C),i+=this.m_invIA*bt.CrossVV(c,C),r.SelfMulAdd(this.m_invMassB,b),o+=this.m_invIB*bt.CrossVV(l,b),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,S<h},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e},i.GetReactionTorque=function(){return 0},i.GetGroundAnchorA=function(){return this.m_groundAnchorA},i.GetGroundAnchorB=function(){return this.m_groundAnchorB},i.GetLengthA=function(){return this.m_lengthA},i.GetLengthB=function(){return this.m_lengthB},i.GetRatio=function(){return this.m_ratio},i.GetCurrentLengthA=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e.GetCurrentLengthA_s_p),n=this.m_groundAnchorA;return bt.DistanceVV(t,n)},i.GetCurrentLengthB=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e.GetCurrentLengthB_s_p),n=this.m_groundAnchorB;return bt.DistanceVV(t,n)},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.ShiftOrigin=function(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)},e}(bi);Gi.InitVelocityConstraints_s_PA=new bt,Gi.InitVelocityConstraints_s_PB=new bt,Gi.SolveVelocityConstraints_s_vpA=new bt,Gi.SolveVelocityConstraints_s_vpB=new bt,Gi.SolveVelocityConstraints_s_PA=new bt,Gi.SolveVelocityConstraints_s_PB=new bt,Gi.SolvePositionConstraints_s_PA=new bt,Gi.SolvePositionConstraints_s_PB=new bt,Gi.GetCurrentLengthA_s_p=new bt,Gi.GetCurrentLengthB_s_p=new bt;var Ui=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_revoluteJoint)||this).localAnchorA=new bt(0,0),n.localAnchorB=new bt(0,0),n.referenceAngle=0,n.enableLimit=!1,n.lowerAngle=0,n.upperAngle=0,n.enableMotor=!1,n.motorSpeed=0,n.maxMotorTorque=0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ci),Hi=function(e){function i(i){var r;return(r=e.call(this,i)||this).m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_impulse=new Et,r.m_motorImpulse=0,r.m_enableMotor=!1,r.m_maxMotorTorque=0,r.m_motorSpeed=0,r.m_enableLimit=!1,r.m_referenceAngle=0,r.m_lowerAngle=0,r.m_upperAngle=0,r.m_indexA=0,r.m_indexB=0,r.m_rA=new bt,r.m_rB=new bt,r.m_localCenterA=new bt,r.m_localCenterB=new bt,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_mass=new Pt,r.m_motorMass=0,r.m_limitState=t.b2LimitState.e_inactiveLimit,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_K=new wt,r.m_localAnchorA.Copy(n(i.localAnchorA,bt.ZERO)),r.m_localAnchorB.Copy(n(i.localAnchorB,bt.ZERO)),r.m_referenceAngle=n(i.referenceAngle,0),r.m_impulse.SetZero(),r.m_motorImpulse=0,r.m_lowerAngle=n(i.lowerAngle,0),r.m_upperAngle=n(i.upperAngle,0),r.m_maxMotorTorque=n(i.maxMotorTorque,0),r.m_motorSpeed=n(i.motorSpeed,0),r.m_enableLimit=n(i.enableLimit,!1),r.m_enableMotor=n(i.enableMotor,!1),r.m_limitState=t.b2LimitState.e_inactiveLimit,r}Q(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,c=e.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(l,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(u,this.m_lalcB,this.m_rB);var h=this.m_invMassA,f=this.m_invMassB,d=this.m_invIA,p=this.m_invIB,m=d+p===0;if(this.m_mass.ex.x=h+f+this.m_rA.y*this.m_rA.y*d+this.m_rB.y*this.m_rB.y*p,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*d-this.m_rB.y*this.m_rB.x*p,this.m_mass.ez.x=-this.m_rA.y*d-this.m_rB.y*p,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=h+f+this.m_rA.x*this.m_rA.x*d+this.m_rB.x*this.m_rB.x*p,this.m_mass.ez.y=this.m_rA.x*d+this.m_rB.x*p,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=d+p,this.m_motorMass=d+p,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!m||(this.m_motorImpulse=0),this.m_enableLimit&&!m){var v=a-n-this.m_referenceAngle;nt(this.m_upperAngle-this.m_lowerAngle)<2*_?this.m_limitState=t.b2LimitState.e_equalLimits:v<=this.m_lowerAngle?(this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atLowerLimit):v>=this.m_upperAngle?(this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atUpperLimit):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var g=i.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);r.SelfMulSub(h,g),o-=d*(bt.CrossVV(this.m_rA,g)+this.m_motorImpulse+this.m_impulse.z),s.SelfMulAdd(f,g),c+=p*(bt.CrossVV(this.m_rB,g)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=c},r.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,o=e.velocities[this.m_indexB].v,a=e.velocities[this.m_indexB].w,s=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,u=this.m_invIB,h=l+u===0;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits&&!h){var _=a-r-this.m_motorSpeed,f=-this.m_motorMass*_,d=this.m_motorImpulse,p=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=at(this.m_motorImpulse+f,-p,p),r-=l*(f=this.m_motorImpulse-d),a+=u*f}if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!h){var m=bt.SubVV(bt.AddVCrossSV(o,a,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,r,this.m_rA,bt.s_t1),i.SolveVelocityConstraints_s_Cdot1),v=a-r,g=this.m_mass.Solve33(m.x,m.y,v,i.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===t.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(g);else if(this.m_limitState===t.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+g.z<0){var y=-m.x+this.m_impulse.z*this.m_mass.ez.x,x=-m.y+this.m_impulse.z*this.m_mass.ez.y,S=this.m_mass.Solve22(y,x,i.SolveVelocityConstraints_s_reduced_v2);g.x=S.x,g.y=S.y,g.z=-this.m_impulse.z,this.m_impulse.x+=S.x,this.m_impulse.y+=S.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(g);else if(this.m_limitState===t.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+g.z>0){var A=-m.x+this.m_impulse.z*this.m_mass.ez.x,C=-m.y+this.m_impulse.z*this.m_mass.ez.y,b=this.m_mass.Solve22(A,C,i.SolveVelocityConstraints_s_reduced_v2);g.x=b.x,g.y=b.y,g.z=-this.m_impulse.z,this.m_impulse.x+=b.x,this.m_impulse.y+=b.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(g);var T=i.SolveVelocityConstraints_s_P.Set(g.x,g.y);n.SelfMulSub(s,T),r-=l*(bt.CrossVV(this.m_rA,T)+g.z),o.SelfMulAdd(c,T),a+=u*(bt.CrossVV(this.m_rB,T)+g.z)}else{var E=bt.SubVV(bt.AddVCrossSV(o,a,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,r,this.m_rA,bt.s_t1),i.SolveVelocityConstraints_s_Cdot_v2),w=this.m_mass.Solve22(-E.x,-E.y,i.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=w.x,this.m_impulse.y+=w.y,n.SelfMulSub(s,w),r-=l*bt.CrossVV(this.m_rA,w),o.SelfMulAdd(c,w),a+=u*bt.CrossVV(this.m_rB,w)}e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=a},r.SolvePositionConstraints=function(e){var n=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,s=this.m_qA.SetAngle(r),c=this.m_qB.SetAngle(a),l=0,u=0,f=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!f){var d=a-r-this.m_referenceAngle,p=0;if(this.m_limitState===t.b2LimitState.e_equalLimits){var m=at(d-this.m_lowerAngle,-g,g);p=-this.m_motorMass*m,l=nt(m)}else if(this.m_limitState===t.b2LimitState.e_atLowerLimit){var v=d-this.m_lowerAngle;l=-v,v=at(v+_,-g,0),p=-this.m_motorMass*v}else if(this.m_limitState===t.b2LimitState.e_atUpperLimit){var y=d-this.m_upperAngle;l=y,y=at(y-_,0,g),p=-this.m_motorMass*y}r-=this.m_invIA*p,a+=this.m_invIB*p}s.SetAngle(r),c.SetAngle(a),bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var x=It.MulRV(s,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var S=It.MulRV(c,this.m_lalcB,this.m_rB),A=bt.SubVV(bt.AddVV(o,S,bt.s_t0),bt.AddVV(n,x,bt.s_t1),i.SolvePositionConstraints_s_C_v2);u=A.Length();var C=this.m_invMassA,b=this.m_invMassB,T=this.m_invIA,E=this.m_invIB,w=this.m_K;w.ex.x=C+b+T*x.y*x.y+E*S.y*S.y,w.ex.y=-T*x.x*x.y-E*S.x*S.y,w.ey.x=w.ex.y,w.ey.y=C+b+T*x.x*x.x+E*S.x*S.x;var P=w.Solve(A.x,A.y,i.SolvePositionConstraints_s_impulse).SelfNeg();return n.SelfMulSub(C,P),r-=T*bt.CrossVV(x,P),o.SelfMulAdd(b,P),a+=E*bt.CrossVV(S,P),e.positions[this.m_indexA].a=r,e.positions[this.m_indexB].a=a,u<=h&&l<=_},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},r.GetReactionTorque=function(t){return t*this.m_impulse.z},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.GetReferenceAngle=function(){return this.m_referenceAngle},r.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},r.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},r.IsMotorEnabled=function(){return this.m_enableMotor},r.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},r.GetMotorTorque=function(t){return t*this.m_motorImpulse},r.GetMotorSpeed=function(){return this.m_motorSpeed},r.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},r.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},r.IsLimitEnabled=function(){return this.m_enableLimit},r.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},r.GetLowerLimit=function(){return this.m_lowerAngle},r.GetUpperLimit=function(){return this.m_upperAngle},r.SetLimits=function(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)},r.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Hi.InitVelocityConstraints_s_P=new bt,Hi.SolveVelocityConstraints_s_P=new bt,Hi.SolveVelocityConstraints_s_Cdot_v2=new bt,Hi.SolveVelocityConstraints_s_Cdot1=new bt,Hi.SolveVelocityConstraints_s_impulse_v3=new Et,Hi.SolveVelocityConstraints_s_reduced_v2=new bt,Hi.SolveVelocityConstraints_s_impulse_v2=new bt,Hi.SolvePositionConstraints_s_C_v2=new bt,Hi.SolvePositionConstraints_s_impulse=new bt;var ji=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_ropeJoint)||this).localAnchorA=new bt(-1,0),n.localAnchorB=new bt(1,0),n.maxLength=0,n}return Q(n,e),n}(Ci),Wi=function(e){function i(i){var r;return(r=e.call(this,i)||this).m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_maxLength=0,r.m_length=0,r.m_impulse=0,r.m_indexA=0,r.m_indexB=0,r.m_u=new bt,r.m_rA=new bt,r.m_rB=new bt,r.m_localCenterA=new bt,r.m_localCenterB=new bt,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_mass=0,r.m_state=t.b2LimitState.e_inactiveLimit,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_localAnchorA.Copy(n(i.localAnchorA,new bt(-1,0))),r.m_localAnchorB.Copy(n(i.localAnchorB,new bt(1,0))),r.m_maxLength=n(i.maxLength,0),r}Q(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.velocities[this.m_indexA].v,a=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].c,c=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v,u=e.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(r),f=this.m_qB.SetAngle(c);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(_,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(f,this.m_lalcB,this.m_rB),this.m_u.Copy(s).SelfAdd(this.m_rB).SelfSub(n).SelfSub(this.m_rA),this.m_length=this.m_u.Length();var d=this.m_length-this.m_maxLength;if(this.m_state=d>0?t.b2LimitState.e_atUpperLimit:t.b2LimitState.e_inactiveLimit,!(this.m_length>h))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);var p=bt.CrossVV(this.m_rA,this.m_u),m=bt.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*p*p+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,e.step.warmStarting){this.m_impulse*=e.step.dtRatio;var g=bt.MulSV(this.m_impulse,this.m_u,i.InitVelocityConstraints_s_P);o.SelfMulSub(this.m_invMassA,g),a-=this.m_invIA*bt.CrossVV(this.m_rA,g),l.SelfMulAdd(this.m_invMassB,g),u+=this.m_invIB*bt.CrossVV(this.m_rB,g)}else this.m_impulse=0;e.velocities[this.m_indexA].w=a,e.velocities[this.m_indexB].w=u},r.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=bt.AddVCrossSV(e,n,this.m_rA,i.SolveVelocityConstraints_s_vpA),s=bt.AddVCrossSV(r,o,this.m_rB,i.SolveVelocityConstraints_s_vpB),c=this.m_length-this.m_maxLength,l=bt.DotVV(this.m_u,bt.SubVV(s,a,bt.s_t0));c<0&&(l+=t.step.inv_dt*c);var u=-this.m_mass*l,h=this.m_impulse;this.m_impulse=it(0,this.m_impulse+u),u=this.m_impulse-h;var _=bt.MulSV(u,this.m_u,i.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,_),n-=this.m_invIA*bt.CrossVV(this.m_rA,_),r.SelfMulAdd(this.m_invMassB,_),o+=this.m_invIB*bt.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},r.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_u.Copy(r).SelfAdd(l).SelfSub(e).SelfSub(c),_=u.Normalize(),f=_-this.m_maxLength;f=at(f,0,v);var d=-this.m_mass*f,p=bt.MulSV(d,u,i.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,p),n-=this.m_invIA*bt.CrossVV(c,p),r.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*bt.CrossVV(l,p),t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,_-this.m_maxLength<h},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return bt.MulSV(t*this.m_impulse,this.m_u,e)},r.GetReactionTorque=function(){return 0},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.SetMaxLength=function(t){this.m_maxLength=t},r.GetMaxLength=function(){return this.m_maxLength},r.GetLimitState=function(){return this.m_state},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Wi.InitVelocityConstraints_s_P=new bt,Wi.SolveVelocityConstraints_s_vpA=new bt,Wi.SolveVelocityConstraints_s_vpB=new bt,Wi.SolveVelocityConstraints_s_P=new bt,Wi.SolvePositionConstraints_s_P=new bt;var qi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_weldJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.referenceAngle=0,n.frequencyHz=0,n.dampingRatio=0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ci),Xi=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_bias=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_referenceAngle=0,i.m_gamma=0,i.m_impulse=new Et(0,0,0),i.m_indexA=0,i.m_indexB=0,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=new Pt,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_K=new Pt,i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_localAnchorA.Copy(n(e.localAnchorA,bt.ZERO)),i.m_localAnchorB.Copy(n(e.localAnchorB,bt.ZERO)),i.m_referenceAngle=n(e.referenceAngle,0),i.m_impulse.SetZero(),i}Q(e,t);var i=e.prototype;return i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,c=t.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(l,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(u,this.m_lalcB,this.m_rB);var h=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,d=this.m_invIB,p=this.m_K;if(p.ex.x=h+_+this.m_rA.y*this.m_rA.y*f+this.m_rB.y*this.m_rB.y*d,p.ey.x=-this.m_rA.y*this.m_rA.x*f-this.m_rB.y*this.m_rB.x*d,p.ez.x=-this.m_rA.y*f-this.m_rB.y*d,p.ex.y=p.ey.x,p.ey.y=h+_+this.m_rA.x*this.m_rA.x*f+this.m_rB.x*this.m_rB.x*d,p.ez.y=this.m_rA.x*f+this.m_rB.x*d,p.ex.z=p.ez.x,p.ey.z=p.ez.y,p.ez.z=f+d,this.m_frequencyHz>0){p.GetInverse22(this.m_mass);var m=f+d,v=m>0?1/m:0,g=o-n-this.m_referenceAngle,y=2*a*this.m_frequencyHz,x=2*v*this.m_dampingRatio*y,S=v*y*y,A=t.step.dt;this.m_gamma=A*(x+A*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=g*A*S*this.m_gamma,m+=this.m_gamma,this.m_mass.ez.z=0!==m?1/m:0}else p.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);var C=e.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(h,C),r-=f*(bt.CrossVV(this.m_rA,C)+this.m_impulse.z),s.SelfMulAdd(_,C),c+=d*(bt.CrossVV(this.m_rB,C)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=c},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB;if(this.m_frequencyHz>0){var u=o-i,h=-this.m_mass.ez.z*(u+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=h,i-=c*h,o+=l*h;var _=bt.SubVV(bt.AddVCrossSV(r,o,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,i,this.m_rA,bt.s_t1),e.SolveVelocityConstraints_s_Cdot1),f=Pt.MulM33XY(this.m_mass,_.x,_.y,e.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=f.x,this.m_impulse.y+=f.y;var d=f;n.SelfMulSub(a,d),i-=c*bt.CrossVV(this.m_rA,d),r.SelfMulAdd(s,d),o+=l*bt.CrossVV(this.m_rB,d)}else{var p=bt.SubVV(bt.AddVCrossSV(r,o,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,i,this.m_rA,bt.s_t1),e.SolveVelocityConstraints_s_Cdot1),m=o-i,v=Pt.MulM33XYZ(this.m_mass,p.x,p.y,m,e.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(v);var g=e.SolveVelocityConstraints_s_P.Set(v.x,v.y);n.SelfMulSub(a,g),i-=c*(bt.CrossVV(this.m_rA,g)+v.z),r.SelfMulAdd(s,g),o+=l*(bt.CrossVV(this.m_rB,g)+v.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(t){var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o),c=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,f=this.m_invIB;bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var d=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var p,m,v=It.MulRV(s,this.m_lalcB,this.m_rB),g=this.m_K;if(g.ex.x=c+l+d.y*d.y*u+v.y*v.y*f,g.ey.x=-d.y*d.x*u-v.y*v.x*f,g.ez.x=-d.y*u-v.y*f,g.ex.y=g.ey.x,g.ey.y=c+l+d.x*d.x*u+v.x*v.x*f,g.ez.y=d.x*u+v.x*f,g.ex.z=g.ez.x,g.ey.z=g.ez.y,g.ez.z=u+f,this.m_frequencyHz>0){var y=bt.SubVV(bt.AddVV(r,v,bt.s_t0),bt.AddVV(n,d,bt.s_t1),e.SolvePositionConstraints_s_C1);p=y.Length(),m=0;var x=g.Solve22(y.x,y.y,e.SolvePositionConstraints_s_P).SelfNeg();n.SelfMulSub(c,x),i-=u*bt.CrossVV(d,x),r.SelfMulAdd(l,x),o+=f*bt.CrossVV(v,x)}else{var S=bt.SubVV(bt.AddVV(r,v,bt.s_t0),bt.AddVV(n,d,bt.s_t1),e.SolvePositionConstraints_s_C1),A=o-i-this.m_referenceAngle;p=S.Length(),m=nt(A);var C=g.Solve33(S.x,S.y,A,e.SolvePositionConstraints_s_impulse).SelfNeg(),b=e.SolvePositionConstraints_s_P.Set(C.x,C.y);n.SelfMulSub(c,b),i-=u*(bt.CrossVV(this.m_rA,b)+C.z),r.SelfMulAdd(l,b),o+=f*(bt.CrossVV(this.m_rB,b)+C.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,p<=h&&m<=_},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},i.GetReactionTorque=function(t){return t*this.m_impulse.z},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.GetReferenceAngle=function(){return this.m_referenceAngle},i.SetFrequency=function(t){this.m_frequencyHz=t},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);Xi.InitVelocityConstraints_s_P=new bt,Xi.SolveVelocityConstraints_s_Cdot1=new bt,Xi.SolveVelocityConstraints_s_impulse1=new bt,Xi.SolveVelocityConstraints_s_impulse=new Et,Xi.SolveVelocityConstraints_s_P=new bt,Xi.SolvePositionConstraints_s_C1=new bt,Xi.SolvePositionConstraints_s_P=new bt,Xi.SolvePositionConstraints_s_impulse=new Et;var Yi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_wheelJoint)||this).localAnchorA=new bt(0,0),n.localAnchorB=new bt(0,0),n.localAxisA=new bt(1,0),n.enableMotor=!1,n.maxMotorTorque=0,n.motorSpeed=0,n.frequencyHz=2,n.dampingRatio=.7,n}return Q(n,e),n.prototype.Initialize=function(t,e,n,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.bodyA.GetLocalVector(i,this.localAxisA)},n}(Ci),Ki=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_localXAxisA=new bt,i.m_localYAxisA=new bt,i.m_impulse=0,i.m_motorImpulse=0,i.m_springImpulse=0,i.m_maxMotorTorque=0,i.m_motorSpeed=0,i.m_enableMotor=!1,i.m_indexA=0,i.m_indexB=0,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_ax=new bt,i.m_ay=new bt,i.m_sAx=0,i.m_sBx=0,i.m_sAy=0,i.m_sBy=0,i.m_mass=0,i.m_motorMass=0,i.m_springMass=0,i.m_bias=0,i.m_gamma=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_rA=new bt,i.m_rB=new bt,i.m_frequencyHz=n(e.frequencyHz,2),i.m_dampingRatio=n(e.dampingRatio,.7),i.m_localAnchorA.Copy(n(e.localAnchorA,bt.ZERO)),i.m_localAnchorB.Copy(n(e.localAnchorB,bt.ZERO)),i.m_localXAxisA.Copy(n(e.localAxisA,bt.UNITX)),bt.CrossOneV(i.m_localXAxisA,i.m_localYAxisA),i.m_maxMotorTorque=n(e.maxMotorTorque,0),i.m_motorSpeed=n(e.motorSpeed,0),i.m_enableMotor=n(e.enableMotor,!1),i.m_ax.SetZero(),i.m_ay.SetZero(),i}Q(e,t);var i=e.prototype;return i.GetMotorSpeed=function(){return this.m_motorSpeed},i.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},i.SetSpringFrequencyHz=function(t){this.m_frequencyHz=t},i.GetSpringFrequencyHz=function(){return this.m_frequencyHz},i.SetSpringDampingRatio=function(t){this.m_dampingRatio=t},i.GetSpringDampingRatio=function(){return this.m_dampingRatio},i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=this.m_invMassA,i=this.m_invMassB,r=this.m_invIA,o=this.m_invIB,s=t.positions[this.m_indexA].c,c=t.positions[this.m_indexA].a,l=t.velocities[this.m_indexA].v,u=t.velocities[this.m_indexA].w,h=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,f=t.velocities[this.m_indexB].v,d=t.velocities[this.m_indexB].w,p=this.m_qA.SetAngle(c),m=this.m_qB.SetAngle(_);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var v=It.MulRV(p,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var g=It.MulRV(m,this.m_lalcB,this.m_rB),y=bt.SubVV(bt.AddVV(h,g,bt.s_t0),bt.AddVV(s,v,bt.s_t1),e.InitVelocityConstraints_s_d);if(It.MulRV(p,this.m_localYAxisA,this.m_ay),this.m_sAy=bt.CrossVV(bt.AddVV(y,v,bt.s_t0),this.m_ay),this.m_sBy=bt.CrossVV(g,this.m_ay),this.m_mass=n+i+r*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){It.MulRV(p,this.m_localXAxisA,this.m_ax),this.m_sAx=bt.CrossVV(bt.AddVV(y,v,bt.s_t0),this.m_ax),this.m_sBx=bt.CrossVV(g,this.m_ax);var x=n+i+r*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(x>0){this.m_springMass=1/x;var S=bt.DotVV(y,this.m_ax),A=2*a*this.m_frequencyHz,C=2*this.m_springMass*this.m_dampingRatio*A,b=this.m_springMass*A*A,T=t.step.dt;this.m_gamma=T*(C+T*b),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=S*T*b*this.m_gamma,this.m_springMass=x+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=r+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;var E=bt.AddVV(bt.MulSV(this.m_impulse,this.m_ay,bt.s_t0),bt.MulSV(this.m_springImpulse,this.m_ax,bt.s_t1),e.InitVelocityConstraints_s_P),w=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,P=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;l.SelfMulSub(this.m_invMassA,E),u-=this.m_invIA*w,f.SelfMulAdd(this.m_invMassB,E),d+=this.m_invIB*P}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=u,t.velocities[this.m_indexB].w=d},i.SolveVelocityConstraints=function(t){var n=this.m_invMassA,i=this.m_invMassB,r=this.m_invIA,o=this.m_invIB,a=t.velocities[this.m_indexA].v,s=t.velocities[this.m_indexA].w,c=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,u=bt.DotVV(this.m_ax,bt.SubVV(c,a,bt.s_t0))+this.m_sBx*l-this.m_sAx*s,h=-this.m_springMass*(u+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=h;var _=bt.MulSV(h,this.m_ax,e.SolveVelocityConstraints_s_P),f=h*this.m_sAx,d=h*this.m_sBx;a.SelfMulSub(n,_),s-=r*f,c.SelfMulAdd(i,_);var p=(l+=o*d)-s-this.m_motorSpeed,m=-this.m_motorMass*p,v=this.m_motorImpulse,g=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=at(this.m_motorImpulse+m,-g,g),s-=r*(m=this.m_motorImpulse-v),l+=o*m;var y=bt.DotVV(this.m_ay,bt.SubVV(c,a,bt.s_t0))+this.m_sBy*l-this.m_sAy*s,x=-this.m_mass*y;this.m_impulse+=x;var S=bt.MulSV(x,this.m_ay,e.SolveVelocityConstraints_s_P),A=x*this.m_sAy,C=x*this.m_sBy;a.SelfMulSub(n,S),s-=r*A,c.SelfMulAdd(i,S),l+=o*C,t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l},i.SolvePositionConstraints=function(t){var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l,u=It.MulRV(s,this.m_lalcB,this.m_rB),_=bt.AddVV(bt.SubVV(r,n,bt.s_t0),bt.SubVV(u,c,bt.s_t1),e.SolvePositionConstraints_s_d),f=It.MulRV(a,this.m_localYAxisA,this.m_ay),d=bt.CrossVV(bt.AddVV(_,c,bt.s_t0),f),p=bt.CrossVV(u,f),m=bt.DotVV(_,this.m_ay),v=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;l=0!==v?-m/v:0;var g=bt.MulSV(l,f,e.SolvePositionConstraints_s_P),y=l*d,x=l*p;return n.SelfMulSub(this.m_invMassA,g),i-=this.m_invIA*y,r.SelfMulAdd(this.m_invMassB,g),o+=this.m_invIB*x,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,nt(m)<=h},i.GetDefinition=function(t){return t},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e},i.GetReactionTorque=function(t){return t*this.m_motorImpulse},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.GetLocalAxisA=function(){return this.m_localXAxisA},i.GetJointTranslation=function(){return this.GetPrismaticJointTranslation()},i.GetJointLinearSpeed=function(){return this.GetPrismaticJointSpeed()},i.GetJointAngle=function(){return this.GetRevoluteJointAngle()},i.GetJointAngularSpeed=function(){return this.GetRevoluteJointSpeed()},i.GetPrismaticJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,n=t.GetWorldPoint(this.m_localAnchorA,new bt),i=e.GetWorldPoint(this.m_localAnchorB,new bt),r=bt.SubVV(i,n,new bt),o=t.GetWorldVector(this.m_localXAxisA,new bt);return bt.DotVV(r,o)},i.GetPrismaticJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;bt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var n=It.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var i=It.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),r=bt.AddVV(t.m_sweep.c,n,bt.s_t0),o=bt.AddVV(e.m_sweep.c,i,bt.s_t1),a=bt.SubVV(o,r,bt.s_t2),s=t.GetWorldVector(this.m_localXAxisA,new bt),c=t.m_linearVelocity,l=e.m_linearVelocity,u=t.m_angularVelocity,h=e.m_angularVelocity;return bt.DotVV(a,bt.CrossSV(u,s,bt.s_t0))+bt.DotVV(s,bt.SubVV(bt.AddVCrossSV(l,h,i,bt.s_t0),bt.AddVCrossSV(c,u,n,bt.s_t1),bt.s_t0))},i.GetRevoluteJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a},i.GetRevoluteJointSpeed=function(){var t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t},i.IsMotorEnabled=function(){return this.m_enableMotor},i.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},i.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},i.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},i.GetMotorTorque=function(t){return t*this.m_motorImpulse},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);function Ji(t,e){return ht(t*e)}function Qi(t,e){return t>e?t:e}Ki.InitVelocityConstraints_s_d=new bt,Ki.InitVelocityConstraints_s_P=new bt,Ki.SolveVelocityConstraints_s_P=new bt,Ki.SolvePositionConstraints_s_d=new bt,Ki.SolvePositionConstraints_s_P=new bt;var Zi=function(){function t(t){this._other=null,this.prev=null,this.next=null,this.contact=t}return t.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},K(t,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t}}]),t}(),$i=function(){function t(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new Zi(this),this.m_nodeB=new Zi(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new ye,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new ye}var e=t.prototype;return e.GetManifold=function(){return this.m_manifold},e.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),n=this.m_fixtureB.GetBody(),i=this.GetShapeA(),r=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),i.m_radius,n.GetTransform(),r.m_radius)},e.IsTouching=function(){return this.m_touchingFlag},e.SetEnabled=function(t){this.m_enabledFlag=t},e.IsEnabled=function(){return this.m_enabledFlag},e.GetNext=function(){return this.m_next},e.GetFixtureA=function(){return this.m_fixtureA},e.GetChildIndexA=function(){return this.m_indexA},e.GetShapeA=function(){return this.m_fixtureA.GetShape()},e.GetFixtureB=function(){return this.m_fixtureB},e.GetChildIndexB=function(){return this.m_indexB},e.GetShapeB=function(){return this.m_fixtureB.GetShape()},e.FlagForFiltering=function(){this.m_filterFlag=!0},e.SetFriction=function(t){this.m_friction=t},e.GetFriction=function(){return this.m_friction},e.ResetFriction=function(){this.m_friction=Ji(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)},e.SetRestitution=function(t){this.m_restitution=t},e.GetRestitution=function(){return this.m_restitution},e.ResetRestitution=function(){this.m_restitution=Qi(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},e.SetTangentSpeed=function(t){this.m_tangentSpeed=t},e.GetTangentSpeed=function(){return this.m_tangentSpeed},e.Reset=function(t,e,n,i){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=n,this.m_indexA=e,this.m_indexB=i,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=Ji(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Qi(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},e.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;var n=!1,i=this.m_touchingFlag,r=this.m_fixtureA.IsSensor(),o=this.m_fixtureB.IsSensor(),a=r||o,s=this.m_fixtureA.GetBody(),c=this.m_fixtureB.GetBody(),l=s.GetTransform(),u=c.GetTransform();if(a){var h=this.GetShapeA(),_=this.GetShapeB();n=De(h,this.m_indexA,_,this.m_indexB,l,u),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,l,u),n=this.m_manifold.pointCount>0;for(var f=0;f<this.m_manifold.pointCount;++f){var d=this.m_manifold.points[f];d.normalImpulse=0,d.tangentImpulse=0;for(var p=d.id,m=0;m<this.m_oldManifold.pointCount;++m){var v=this.m_oldManifold.points[m];if(v.id.key===p.key){d.normalImpulse=v.normalImpulse,d.tangentImpulse=v.tangentImpulse;break}}}n!==i&&(s.SetAwake(!0),c.SetAwake(!0))}this.m_touchingFlag=n,!i&&n&&t&&t.BeginContact(this),i&&!n&&t&&t.EndContact(this),!a&&n&&t&&t.PreSolve(this,this.m_oldManifold)},e.ComputeTOI=function(e,n){var i=t.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(e),i.sweepB.Copy(n),i.tMax=h;var r=t.ComputeTOI_s_output;return un(r,i),r.t},t}();$i.ComputeTOI_s_input=new Je,$i.ComputeTOI_s_output=new Ze;var tr=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){fn(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),er=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){Gn(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),nr=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){vn(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),ir=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){Qn(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),rr=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){ri(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),or=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,n,i){var r=e.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),Qn(t,r,n,this.GetShapeB(),i)},e}($i);or.Evaluate_s_edge=new ui;var ar=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,n,i){var r=e.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),ri(t,r,n,this.GetShapeB(),i)},e}($i);ar.Evaluate_s_edge=new ui;var sr=function(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1},cr=function(){function e(){this.m_registers=[],this.InitializeRegisters()}var n=e.prototype;return n.AddType=function(t,e,n,i){var r=[];function o(){return r.pop()||t()}function a(t){r.push(t)}this.m_registers[n][i].pool=r,this.m_registers[n][i].createFcn=o,this.m_registers[n][i].destroyFcn=a,this.m_registers[n][i].primary=!0,n!==i&&(this.m_registers[i][n].pool=r,this.m_registers[i][n].createFcn=o,this.m_registers[i][n].destroyFcn=a,this.m_registers[i][n].primary=!1)},n.InitializeRegisters=function(){for(var e=0;e<t.b2ShapeType.e_shapeTypeCount;e++){this.m_registers[e]=[];for(var n=0;n<t.b2ShapeType.e_shapeTypeCount;n++)this.m_registers[e][n]=new sr}this.AddType(tr.Create,tr.Destroy,t.b2ShapeType.e_circleShape,t.b2ShapeType.e_circleShape),this.AddType(nr.Create,nr.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_circleShape),this.AddType(er.Create,er.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_polygonShape),this.AddType(ir.Create,ir.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_circleShape),this.AddType(rr.Create,rr.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_polygonShape),this.AddType(or.Create,or.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_circleShape),this.AddType(ar.Create,ar.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_polygonShape)},n.Create=function(t,e,n,i){var r=t.GetType(),o=n.GetType(),a=this.m_registers[r][o];if(a.createFcn){var s=a.createFcn();return a.primary?s.Reset(t,e,n,i):s.Reset(n,i,t,e),s}return null},n.Destroy=function(t){var e=t.m_fixtureA.GetType(),n=t.m_fixtureB.GetType(),i=this.m_registers[e][n];i.destroyFcn&&i.destroyFcn(t)},e}(),lr=function(){function t(){}var e=t.prototype;return e.SayGoodbyeJoint=function(){},e.SayGoodbyeFixture=function(){},e.SayGoodbyeParticleGroup=function(){},e.SayGoodbyeParticle=function(){},t}(),ur=function(){function e(){}var n=e.prototype;return n.ShouldCollide=function(e,n){var i=e.GetBody(),r=n.GetBody();if(r.GetType()===t.b2BodyType.b2_staticBody&&i.GetType()===t.b2BodyType.b2_staticBody)return!1;if(!r.ShouldCollideConnected(i))return!1;var o=e.GetFilterData(),a=n.GetFilterData();return o.groupIndex===a.groupIndex&&0!==o.groupIndex?o.groupIndex>0:0!=(o.maskBits&a.categoryBits)&&0!=(o.categoryBits&a.maskBits)},n.ShouldCollideFixtureParticle=function(){return!0},n.ShouldCollideParticleParticle=function(){return!0},e}();ur.b2_defaultFilter=new ur;var hr=function(){this.normalImpulses=J(s),this.tangentImpulses=J(s),this.count=0},_r=function(){function t(){}var e=t.prototype;return e.BeginContact=function(){},e.EndContact=function(){},e.BeginContactFixtureParticle=function(){},e.EndContactFixtureParticle=function(){},e.BeginContactParticleParticle=function(){},e.EndContactParticleParticle=function(){},e.PreSolve=function(){},e.PostSolve=function(){},t}();_r.b2_defaultListener=new _r;var fr=function(){function t(){}var e=t.prototype;return e.ReportFixture=function(){return!0},e.ReportParticle=function(){return!1},e.ShouldQueryParticleSystem=function(){return!0},t}(),dr=function(){function t(){}var e=t.prototype;return e.ReportFixture=function(t,e,n,i){return i},e.ReportParticle=function(){return 0},e.ShouldQueryParticleSystem=function(){return!0},t}(),pr=function(){function e(){this.m_broadPhase=new Ve,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=ur.b2_defaultFilter,this.m_contactListener=_r.b2_defaultListener,this.m_contactFactory=new cr}var n=e.prototype;return n.AddPair=function(t,e){var n=t.fixture,i=e.fixture,r=t.childIndex,o=e.childIndex,a=n.GetBody(),s=i.GetBody();if(a!==s){for(var c=s.GetContactList();c;){if(c.other===a){var l=c.contact.GetFixtureA(),u=c.contact.GetFixtureB(),h=c.contact.GetChildIndexA(),_=c.contact.GetChildIndexB();if(l===n&&u===i&&h===r&&_===o)return;if(l===i&&u===n&&h===o&&_===r)return}c=c.next}if(!this.m_contactFilter||this.m_contactFilter.ShouldCollide(n,i)){var f=this.m_contactFactory.Create(n,r,i,o);null!==f&&(n=f.GetFixtureA(),i=f.GetFixtureB(),r=f.GetChildIndexA(),o=f.GetChildIndexB(),a=n.m_body,s=i.m_body,f.m_prev=null,f.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=f),this.m_contactList=f,f.m_nodeA.other=s,f.m_nodeA.prev=null,f.m_nodeA.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=f.m_nodeA),a.m_contactList=f.m_nodeA,f.m_nodeB.other=a,f.m_nodeB.prev=null,f.m_nodeB.next=s.m_contactList,null!==s.m_contactList&&(s.m_contactList.prev=f.m_nodeB),s.m_contactList=f.m_nodeB,n.IsSensor()||i.IsSensor()||(a.SetAwake(!0),s.SetAwake(!0)),++this.m_contactCount)}}},n.FindNewContacts=function(){var t=this;this.m_broadPhase.UpdatePairs((function(e,n){t.AddPair(e,n)}))},n.Destroy=function(t){var e=t.GetFixtureA(),n=t.GetFixtureB(),i=e.GetBody(),r=n.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===i.m_contactList&&(i.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===r.m_contactList&&(r.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!n.IsSensor()&&(e.GetBody().SetAwake(!0),n.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount},n.Collide=function(){for(var e=this.m_contactList;e;){var n=e.GetFixtureA(),i=e.GetFixtureB(),r=e.GetChildIndexA(),o=e.GetChildIndexB(),a=n.GetBody(),s=i.GetBody();if(e.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(n,i)){var c=e;e=c.m_next,this.Destroy(c);continue}e.m_filterFlag=!1}var l=a.IsAwake()&&a.m_type!==t.b2BodyType.b2_staticBody,u=s.IsAwake()&&s.m_type!==t.b2BodyType.b2_staticBody;if(l||u){var h=n.m_proxies[r].treeNode,_=i.m_proxies[o].treeNode;if(Ee(h.aabb,_.aabb))e.Update(this.m_contactListener),e=e.m_next;else{var f=e;e=f.m_next,this.Destroy(f)}}else e=e.m_next}},e}(),mr=function(){function t(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}return t.prototype.Reset=function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this},t}(),vr=function(){function t(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}return t.prototype.Copy=function(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this},t}(),gr=function(){function t(){this.c=new bt,this.a=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),yr=function(){function t(){this.v=new bt,this.w=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),xr=function(){this.step=new vr},Sr=!1,Ar=function(){function t(){this.rA=new bt,this.rB=new bt,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),Cr=function(){function t(){this.points=Ar.MakeArray(s),this.normal=new bt,this.tangent=new bt,this.normalMass=new wt,this.K=new wt,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),br=function(){function e(){this.localPoints=bt.MakeArray(s),this.localNormal=new bt,this.localPoint=new bt,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new bt,this.localCenterB=new bt,this.invIA=0,this.invIB=0,this.type=t.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}return e.MakeArray=function(t){return X(t,(function(){return new e}))},e}(),Tr=function(){this.step=new vr,this.count=0},Er=function(){function e(){this.normal=new bt,this.point=new bt,this.separation=0}return e.prototype.Initialize=function(n,i,r,o){var a=e.Initialize_s_pointA,s=e.Initialize_s_pointB,c=e.Initialize_s_planePoint,l=e.Initialize_s_clipPoint;switch(n.type){case t.b2ManifoldType.e_circles:Rt.MulXV(i,n.localPoint,a),Rt.MulXV(r,n.localPoints[0],s),bt.SubVV(s,a,this.normal).SelfNormalize(),bt.MidVV(a,s,this.point),this.separation=bt.DotVV(bt.SubVV(s,a,bt.s_t0),this.normal)-n.radiusA-n.radiusB;break;case t.b2ManifoldType.e_faceA:It.MulRV(i.q,n.localNormal,this.normal),Rt.MulXV(i,n.localPoint,c),Rt.MulXV(r,n.localPoints[o],l),this.separation=bt.DotVV(bt.SubVV(l,c,bt.s_t0),this.normal)-n.radiusA-n.radiusB,this.point.Copy(l);break;case t.b2ManifoldType.e_faceB:It.MulRV(r.q,n.localNormal,this.normal),Rt.MulXV(r,n.localPoint,c),Rt.MulXV(i,n.localPoints[o],l),this.separation=bt.DotVV(bt.SubVV(l,c,bt.s_t0),this.normal)-n.radiusA-n.radiusB,this.point.Copy(l),this.normal.SelfNeg()}},e}();Er.Initialize_s_pointA=new bt,Er.Initialize_s_pointB=new bt,Er.Initialize_s_planePoint=new bt,Er.Initialize_s_clipPoint=new bt;var wr=function(){function t(){this.m_step=new vr,this.m_positionConstraints=br.MakeArray(1024),this.m_velocityConstraints=Cr.MakeArray(1024),this.m_count=0}var e=t.prototype;return e.Initialize=function(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count)for(var e=rt(2*this.m_positionConstraints.length,this.m_count);this.m_positionConstraints.length<e;)this.m_positionConstraints[this.m_positionConstraints.length]=new br;if(this.m_velocityConstraints.length<this.m_count)for(var n=rt(2*this.m_velocityConstraints.length,this.m_count);this.m_velocityConstraints.length<n;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new Cr;this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(var i=0;i<this.m_count;++i){var r=this.m_contacts[i],o=r.m_fixtureA,a=r.m_fixtureB,s=o.GetShape(),c=a.GetShape(),l=s.m_radius,u=c.m_radius,h=o.GetBody(),_=a.GetBody(),f=r.GetManifold(),d=f.pointCount,p=this.m_velocityConstraints[i];p.friction=r.m_friction,p.restitution=r.m_restitution,p.tangentSpeed=r.m_tangentSpeed,p.indexA=h.m_islandIndex,p.indexB=_.m_islandIndex,p.invMassA=h.m_invMass,p.invMassB=_.m_invMass,p.invIA=h.m_invI,p.invIB=_.m_invI,p.contactIndex=i,p.pointCount=d,p.K.SetZero(),p.normalMass.SetZero();var m=this.m_positionConstraints[i];m.indexA=h.m_islandIndex,m.indexB=_.m_islandIndex,m.invMassA=h.m_invMass,m.invMassB=_.m_invMass,m.localCenterA.Copy(h.m_sweep.localCenter),m.localCenterB.Copy(_.m_sweep.localCenter),m.invIA=h.m_invI,m.invIB=_.m_invI,m.localNormal.Copy(f.localNormal),m.localPoint.Copy(f.localPoint),m.pointCount=d,m.radiusA=l,m.radiusB=u,m.type=f.type;for(var v=0;v<d;++v){var g=f.points[v],y=p.points[v];this.m_step.warmStarting?(y.normalImpulse=this.m_step.dtRatio*g.normalImpulse,y.tangentImpulse=this.m_step.dtRatio*g.tangentImpulse):(y.normalImpulse=0,y.tangentImpulse=0),y.rA.SetZero(),y.rB.SetZero(),y.normalMass=0,y.tangentMass=0,y.velocityBias=0,m.localPoints[v].Copy(g.localPoint)}}return this},e.InitializeVelocityConstraints=function(){for(var e=t.InitializeVelocityConstraints_s_xfA,n=t.InitializeVelocityConstraints_s_xfB,i=t.InitializeVelocityConstraints_s_worldManifold,r=1e3,o=0;o<this.m_count;++o){var a=this.m_velocityConstraints[o],s=this.m_positionConstraints[o],c=s.radiusA,l=s.radiusB,u=this.m_contacts[a.contactIndex].GetManifold(),h=a.indexA,_=a.indexB,f=a.invMassA,d=a.invMassB,p=a.invIA,v=a.invIB,g=s.localCenterA,y=s.localCenterB,x=this.m_positions[h].c,S=this.m_positions[h].a,A=this.m_velocities[h].v,C=this.m_velocities[h].w,b=this.m_positions[_].c,T=this.m_positions[_].a,E=this.m_velocities[_].v,w=this.m_velocities[_].w;e.q.SetAngle(S),n.q.SetAngle(T),bt.SubVV(x,It.MulRV(e.q,g,bt.s_t0),e.p),bt.SubVV(b,It.MulRV(n.q,y,bt.s_t0),n.p),i.Initialize(u,e,c,n,l),a.normal.Copy(i.normal),bt.CrossVOne(a.normal,a.tangent);for(var P=a.pointCount,I=0;I<P;++I){var R=a.points[I];bt.SubVV(i.points[I],x,R.rA),bt.SubVV(i.points[I],b,R.rB);var D=bt.CrossVV(R.rA,a.normal),M=bt.CrossVV(R.rB,a.normal),B=f+d+p*D*D+v*M*M;R.normalMass=B>0?1/B:0;var O=a.tangent,N=bt.CrossVV(R.rA,O),L=bt.CrossVV(R.rB,O),F=f+d+p*N*N+v*L*L;R.tangentMass=F>0?1/F:0,R.velocityBias=0;var z=bt.DotVV(a.normal,bt.SubVV(bt.AddVCrossSV(E,w,R.rB,bt.s_t0),bt.AddVCrossSV(A,C,R.rA,bt.s_t1),bt.s_t0));z<-m&&(R.velocityBias+=-a.restitution*z)}if(2===a.pointCount&&Sr){var V=a.points[0],k=a.points[1],G=bt.CrossVV(V.rA,a.normal),U=bt.CrossVV(V.rB,a.normal),H=bt.CrossVV(k.rA,a.normal),j=bt.CrossVV(k.rB,a.normal),W=f+d+p*G*G+v*U*U,q=f+d+p*H*H+v*j*j,X=f+d+p*G*H+v*U*j;W*W<r*(W*q-X*X)?(a.K.ex.Set(W,X),a.K.ey.Set(X,q),a.K.GetInverse(a.normalMass)):a.pointCount=1}}},e.WarmStart=function(){for(var e=t.WarmStart_s_P,n=0;n<this.m_count;++n){for(var i=this.m_velocityConstraints[n],r=i.indexA,o=i.indexB,a=i.invMassA,s=i.invIA,c=i.invMassB,l=i.invIB,u=i.pointCount,h=this.m_velocities[r].v,_=this.m_velocities[r].w,f=this.m_velocities[o].v,d=this.m_velocities[o].w,p=i.normal,m=i.tangent,v=0;v<u;++v){var g=i.points[v];bt.AddVV(bt.MulSV(g.normalImpulse,p,bt.s_t0),bt.MulSV(g.tangentImpulse,m,bt.s_t1),e),_-=s*bt.CrossVV(g.rA,e),h.SelfMulSub(a,e),d+=l*bt.CrossVV(g.rB,e),f.SelfMulAdd(c,e)}this.m_velocities[r].w=_,this.m_velocities[o].w=d}},e.SolveVelocityConstraints=function(){for(var e=t.SolveVelocityConstraints_s_dv,n=t.SolveVelocityConstraints_s_dv1,i=t.SolveVelocityConstraints_s_dv2,r=t.SolveVelocityConstraints_s_P,o=t.SolveVelocityConstraints_s_a,a=t.SolveVelocityConstraints_s_b,s=t.SolveVelocityConstraints_s_x,c=t.SolveVelocityConstraints_s_d,l=t.SolveVelocityConstraints_s_P1,u=t.SolveVelocityConstraints_s_P2,h=t.SolveVelocityConstraints_s_P1P2,_=0;_<this.m_count;++_){for(var f=this.m_velocityConstraints[_],d=f.indexA,p=f.indexB,m=f.invMassA,v=f.invIA,g=f.invMassB,y=f.invIB,x=f.pointCount,S=this.m_velocities[d].v,A=this.m_velocities[d].w,C=this.m_velocities[p].v,b=this.m_velocities[p].w,T=f.normal,E=f.tangent,w=f.friction,P=0;P<x;++P){var I=f.points[P];bt.SubVV(bt.AddVCrossSV(C,b,I.rB,bt.s_t0),bt.AddVCrossSV(S,A,I.rA,bt.s_t1),e);var R=bt.DotVV(e,E)-f.tangentSpeed,D=I.tangentMass*-R,M=w*I.normalImpulse,B=at(I.tangentImpulse+D,-M,M);D=B-I.tangentImpulse,I.tangentImpulse=B,bt.MulSV(D,E,r),S.SelfMulSub(m,r),A-=v*bt.CrossVV(I.rA,r),C.SelfMulAdd(g,r),b+=y*bt.CrossVV(I.rB,r)}if(1===f.pointCount||!1===Sr)for(var O=0;O<x;++O){var N=f.points[O];bt.SubVV(bt.AddVCrossSV(C,b,N.rB,bt.s_t0),bt.AddVCrossSV(S,A,N.rA,bt.s_t1),e);var L=bt.DotVV(e,T),F=-N.normalMass*(L-N.velocityBias),z=rt(N.normalImpulse+F,0);F=z-N.normalImpulse,N.normalImpulse=z,bt.MulSV(F,T,r),S.SelfMulSub(m,r),A-=v*bt.CrossVV(N.rA,r),C.SelfMulAdd(g,r),b+=y*bt.CrossVV(N.rB,r)}else{var V=f.points[0],k=f.points[1];o.Set(V.normalImpulse,k.normalImpulse),bt.SubVV(bt.AddVCrossSV(C,b,V.rB,bt.s_t0),bt.AddVCrossSV(S,A,V.rA,bt.s_t1),n),bt.SubVV(bt.AddVCrossSV(C,b,k.rB,bt.s_t0),bt.AddVCrossSV(S,A,k.rA,bt.s_t1),i);var G=bt.DotVV(n,T),U=bt.DotVV(i,T);for(a.x=G-V.velocityBias,a.y=U-k.velocityBias,a.SelfSub(wt.MulMV(f.K,o,bt.s_t0));;){if(wt.MulMV(f.normalMass,a,s).SelfNeg(),s.x>=0&&s.y>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),A-=v*(bt.CrossVV(V.rA,l)+bt.CrossVV(k.rA,u)),C.SelfMulAdd(g,h),b+=y*(bt.CrossVV(V.rB,l)+bt.CrossVV(k.rB,u)),V.normalImpulse=s.x,k.normalImpulse=s.y;break}if(s.x=-V.normalMass*a.x,s.y=0,G=0,U=f.K.ex.y*s.x+a.y,s.x>=0&&U>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),A-=v*(bt.CrossVV(V.rA,l)+bt.CrossVV(k.rA,u)),C.SelfMulAdd(g,h),b+=y*(bt.CrossVV(V.rB,l)+bt.CrossVV(k.rB,u)),V.normalImpulse=s.x,k.normalImpulse=s.y;break}if(s.x=0,s.y=-k.normalMass*a.y,G=f.K.ey.x*s.y+a.x,U=0,s.y>=0&&G>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),A-=v*(bt.CrossVV(V.rA,l)+bt.CrossVV(k.rA,u)),C.SelfMulAdd(g,h),b+=y*(bt.CrossVV(V.rB,l)+bt.CrossVV(k.rB,u)),V.normalImpulse=s.x,k.normalImpulse=s.y;break}if(s.x=0,s.y=0,G=a.x,U=a.y,G>=0&&U>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),A-=v*(bt.CrossVV(V.rA,l)+bt.CrossVV(k.rA,u)),C.SelfMulAdd(g,h),b+=y*(bt.CrossVV(V.rB,l)+bt.CrossVV(k.rB,u)),V.normalImpulse=s.x,k.normalImpulse=s.y;break}break}}this.m_velocities[d].w=A,this.m_velocities[p].w=b}},e.StoreImpulses=function(){for(var t=0;t<this.m_count;++t)for(var e=this.m_velocityConstraints[t],n=this.m_contacts[e.contactIndex].GetManifold(),i=0;i<e.pointCount;++i)n.points[i].normalImpulse=e.points[i].normalImpulse,n.points[i].tangentImpulse=e.points[i].tangentImpulse},e.SolvePositionConstraints=function(){for(var e=t.SolvePositionConstraints_s_xfA,n=t.SolvePositionConstraints_s_xfB,i=t.SolvePositionConstraints_s_psm,r=t.SolvePositionConstraints_s_rA,o=t.SolvePositionConstraints_s_rB,a=t.SolvePositionConstraints_s_P,s=0,c=0;c<this.m_count;++c){for(var l=this.m_positionConstraints[c],u=l.indexA,_=l.indexB,f=l.localCenterA,d=l.invMassA,p=l.invIA,m=l.localCenterB,g=l.invMassB,y=l.invIB,x=l.pointCount,S=this.m_positions[u].c,A=this.m_positions[u].a,b=this.m_positions[_].c,T=this.m_positions[_].a,E=0;E<x;++E){e.q.SetAngle(A),n.q.SetAngle(T),bt.SubVV(S,It.MulRV(e.q,f,bt.s_t0),e.p),bt.SubVV(b,It.MulRV(n.q,m,bt.s_t0),n.p),i.Initialize(l,e,n,E);var w=i.normal,P=i.point,I=i.separation;bt.SubVV(P,S,r),bt.SubVV(P,b,o),s=it(s,I);var R=at(C*(I+h),-v,0),D=bt.CrossVV(r,w),M=bt.CrossVV(o,w),B=d+g+p*D*D+y*M*M,O=B>0?-R/B:0;bt.MulSV(O,w,a),S.SelfMulSub(d,a),A-=p*bt.CrossVV(r,a),b.SelfMulAdd(g,a),T+=y*bt.CrossVV(o,a)}this.m_positions[u].a=A,this.m_positions[_].a=T}return s>-3*h},e.SolveTOIPositionConstraints=function(e,n){for(var i=t.SolveTOIPositionConstraints_s_xfA,r=t.SolveTOIPositionConstraints_s_xfB,o=t.SolveTOIPositionConstraints_s_psm,a=t.SolveTOIPositionConstraints_s_rA,s=t.SolveTOIPositionConstraints_s_rB,c=t.SolveTOIPositionConstraints_s_P,l=0,u=0;u<this.m_count;++u){var _=this.m_positionConstraints[u],f=_.indexA,d=_.indexB,p=_.localCenterA,m=_.localCenterB,g=_.pointCount,y=0,x=0;f!==e&&f!==n||(y=_.invMassA,x=_.invIA);var S=0,A=0;d!==e&&d!==n||(S=_.invMassB,A=_.invIB);for(var C=this.m_positions[f].c,T=this.m_positions[f].a,E=this.m_positions[d].c,w=this.m_positions[d].a,P=0;P<g;++P){i.q.SetAngle(T),r.q.SetAngle(w),bt.SubVV(C,It.MulRV(i.q,p,bt.s_t0),i.p),bt.SubVV(E,It.MulRV(r.q,m,bt.s_t0),r.p),o.Initialize(_,i,r,P);var I=o.normal,R=o.point,D=o.separation;bt.SubVV(R,C,a),bt.SubVV(R,E,s),l=it(l,D);var M=at(b*(D+h),-v,0),B=bt.CrossVV(a,I),O=bt.CrossVV(s,I),N=y+S+x*B*B+A*O*O,L=N>0?-M/N:0;bt.MulSV(L,I,c),C.SelfMulSub(y,c),T-=x*bt.CrossVV(a,c),E.SelfMulAdd(S,c),w+=A*bt.CrossVV(s,c)}this.m_positions[f].a=T,this.m_positions[d].a=w}return l>=-1.5*h},t}();wr.InitializeVelocityConstraints_s_xfA=new Rt,wr.InitializeVelocityConstraints_s_xfB=new Rt,wr.InitializeVelocityConstraints_s_worldManifold=new xe,wr.WarmStart_s_P=new bt,wr.SolveVelocityConstraints_s_dv=new bt,wr.SolveVelocityConstraints_s_dv1=new bt,wr.SolveVelocityConstraints_s_dv2=new bt,wr.SolveVelocityConstraints_s_P=new bt,wr.SolveVelocityConstraints_s_a=new bt,wr.SolveVelocityConstraints_s_b=new bt,wr.SolveVelocityConstraints_s_x=new bt,wr.SolveVelocityConstraints_s_d=new bt,wr.SolveVelocityConstraints_s_P1=new bt,wr.SolveVelocityConstraints_s_P2=new bt,wr.SolveVelocityConstraints_s_P1P2=new bt,wr.SolvePositionConstraints_s_xfA=new Rt,wr.SolvePositionConstraints_s_xfB=new Rt,wr.SolvePositionConstraints_s_psm=new Er,wr.SolvePositionConstraints_s_rA=new bt,wr.SolvePositionConstraints_s_rB=new bt,wr.SolvePositionConstraints_s_P=new bt,wr.SolveTOIPositionConstraints_s_xfA=new Rt,wr.SolveTOIPositionConstraints_s_xfB=new Rt,wr.SolveTOIPositionConstraints_s_psm=new Er,wr.SolveTOIPositionConstraints_s_rA=new bt,wr.SolveTOIPositionConstraints_s_rB=new bt,wr.SolveTOIPositionConstraints_s_P=new bt;var Pr,Ir=function(){function e(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=gr.MakeArray(1024),this.m_velocities=yr.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}var n=e.prototype;return n.Initialize=function(t,e,n,i){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=n,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=i,this.m_positions.length<t)for(var r=rt(2*this.m_positions.length,t);this.m_positions.length<r;)this.m_positions[this.m_positions.length]=new gr;if(this.m_velocities.length<t)for(var o=rt(2*this.m_velocities.length,t);this.m_velocities.length<o;)this.m_velocities[this.m_velocities.length]=new yr},n.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},n.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},n.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},n.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},n.Solve=function(n,r,o,a){for(var s=e.s_timer.Reset(),c=r.dt,l=0;l<this.m_bodyCount;++l){var u=this.m_bodies[l];this.m_positions[l].c.Copy(u.m_sweep.c);var h=u.m_sweep.a,_=this.m_velocities[l].v.Copy(u.m_linearVelocity),f=u.m_angularVelocity;u.m_sweep.c0.Copy(u.m_sweep.c),u.m_sweep.a0=u.m_sweep.a,u.m_type===t.b2BodyType.b2_dynamicBody&&(_.x+=c*(u.m_gravityScale*o.x+u.m_invMass*u.m_force.x),_.y+=c*(u.m_gravityScale*o.y+u.m_invMass*u.m_force.y),f+=c*u.m_invI*u.m_torque,_.SelfMul(1/(1+c*u.m_linearDamping)),f*=1/(1+c*u.m_angularDamping)),this.m_positions[l].a=h,this.m_velocities[l].w=f}s.Reset();var d=e.s_solverData;d.step.Copy(r),d.positions=this.m_positions,d.velocities=this.m_velocities;var p=e.s_contactSolverDef;p.step.Copy(r),p.contacts=this.m_contacts,p.count=this.m_contactCount,p.positions=this.m_positions,p.velocities=this.m_velocities;var m=e.s_contactSolver.Initialize(p);m.InitializeVelocityConstraints(),r.warmStarting&&m.WarmStart();for(var v=0;v<this.m_jointCount;++v)this.m_joints[v].InitVelocityConstraints(d);n.solveInit=s.GetMilliseconds(),s.Reset();for(var g=0;g<r.velocityIterations;++g){for(var C=0;C<this.m_jointCount;++C)this.m_joints[C].SolveVelocityConstraints(d);m.SolveVelocityConstraints()}m.StoreImpulses(),n.solveVelocity=s.GetMilliseconds();for(var b=0;b<this.m_bodyCount;++b){var T=this.m_positions[b].c,E=this.m_positions[b].a,w=this.m_velocities[b].v,P=this.m_velocities[b].w,I=bt.MulSV(c,w,e.s_translation);if(bt.DotVV(I,I)>x){var R=y/I.Length();w.SelfMul(R)}var D=c*P;D*D>A&&(P*=S/nt(D)),T.x+=c*w.x,T.y+=c*w.y,E+=c*P,this.m_positions[b].a=E,this.m_velocities[b].w=P}s.Reset();for(var M=!1,B=0;B<r.positionIterations;++B){for(var O=m.SolvePositionConstraints(),z=!0,V=0;V<this.m_jointCount;++V){var k=this.m_joints[V].SolvePositionConstraints(d);z=z&&k}if(O&&z){M=!0;break}}for(var G=0;G<this.m_bodyCount;++G){var U=this.m_bodies[G];U.m_sweep.c.Copy(this.m_positions[G].c),U.m_sweep.a=this.m_positions[G].a,U.m_linearVelocity.Copy(this.m_velocities[G].v),U.m_angularVelocity=this.m_velocities[G].w,U.SynchronizeTransform()}if(n.solvePosition=s.GetMilliseconds(),this.Report(m.m_velocityConstraints),a){for(var H=i,j=L*L,W=F*F,q=0;q<this.m_bodyCount;++q){var X=this.m_bodies[q];X.GetType()!==t.b2BodyType.b2_staticBody&&(!X.m_autoSleepFlag||X.m_angularVelocity*X.m_angularVelocity>W||bt.DotVV(X.m_linearVelocity,X.m_linearVelocity)>j?(X.m_sleepTime=0,H=0):(X.m_sleepTime+=c,H=it(H,X.m_sleepTime)))}if(H>=N&&M)for(var Y=0;Y<this.m_bodyCount;++Y)this.m_bodies[Y].SetAwake(!1)}},n.SolveTOI=function(t,n,i){for(var r=0;r<this.m_bodyCount;++r){var o=this.m_bodies[r];this.m_positions[r].c.Copy(o.m_sweep.c),this.m_positions[r].a=o.m_sweep.a,this.m_velocities[r].v.Copy(o.m_linearVelocity),this.m_velocities[r].w=o.m_angularVelocity}var a=e.s_contactSolverDef;a.contacts=this.m_contacts,a.count=this.m_contactCount,a.step.Copy(t),a.positions=this.m_positions,a.velocities=this.m_velocities;for(var s=e.s_contactSolver.Initialize(a),c=0;c<t.positionIterations&&!s.SolveTOIPositionConstraints(n,i);++c);this.m_bodies[n].m_sweep.c0.Copy(this.m_positions[n].c),this.m_bodies[n].m_sweep.a0=this.m_positions[n].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,s.InitializeVelocityConstraints();for(var l=0;l<t.velocityIterations;++l)s.SolveVelocityConstraints();for(var u=t.dt,h=0;h<this.m_bodyCount;++h){var _=this.m_positions[h].c,f=this.m_positions[h].a,d=this.m_velocities[h].v,p=this.m_velocities[h].w,m=bt.MulSV(u,d,e.s_translation);if(bt.DotVV(m,m)>x){var v=y/m.Length();d.SelfMul(v)}var g=u*p;g*g>A&&(p*=S/nt(g)),_.SelfMulAdd(u,d),f+=u*p,this.m_positions[h].a=f,this.m_velocities[h].w=p;var C=this.m_bodies[h];C.m_sweep.c.Copy(_),C.m_sweep.a=f,C.m_linearVelocity.Copy(d),C.m_angularVelocity=p,C.SynchronizeTransform()}this.Report(s.m_velocityConstraints)},n.Report=function(t){if(null!==this.m_listener)for(var n=0;n<this.m_contactCount;++n){var i=this.m_contacts[n];if(i){var r=t[n],o=e.s_impulse;o.count=r.pointCount;for(var a=0;a<r.pointCount;++a)o.normalImpulses[a]=r.points[a].normalImpulse,o.tangentImpulses[a]=r.points[a].tangentImpulse;this.m_listener.PostSolve(i,o)}}},e}();Ir.s_timer=new Nt,Ir.s_solverData=new xr,Ir.s_contactSolverDef=new Tr,Ir.s_contactSolver=new wr,Ir.s_translation=new bt,Ir.s_impulse=new hr,(Pr=t.b2ParticleFlag||(t.b2ParticleFlag={}))[Pr.b2_waterParticle=0]="b2_waterParticle",Pr[Pr.b2_zombieParticle=2]="b2_zombieParticle",Pr[Pr.b2_wallParticle=4]="b2_wallParticle",Pr[Pr.b2_springParticle=8]="b2_springParticle",Pr[Pr.b2_elasticParticle=16]="b2_elasticParticle",Pr[Pr.b2_viscousParticle=32]="b2_viscousParticle",Pr[Pr.b2_powderParticle=64]="b2_powderParticle",Pr[Pr.b2_tensileParticle=128]="b2_tensileParticle",Pr[Pr.b2_colorMixingParticle=256]="b2_colorMixingParticle",Pr[Pr.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",Pr[Pr.b2_barrierParticle=1024]="b2_barrierParticle",Pr[Pr.b2_staticPressureParticle=2048]="b2_staticPressureParticle",Pr[Pr.b2_reactiveParticle=4096]="b2_reactiveParticle",Pr[Pr.b2_repulsiveParticle=8192]="b2_repulsiveParticle",Pr[Pr.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",Pr[Pr.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",Pr[Pr.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",Pr[Pr.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";var Rr=function(){this.flags=0,this.position=new bt,this.velocity=new bt,this.color=new Bt(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null};function Dr(t,e,n){var i=8,r=.01;return at(Math.ceil(Math.sqrt(t/(r*e))*n),1,i)}var Mr,Br=function(){function t(){this.m_index=T}var e=t.prototype;return e.GetIndex=function(){return this.m_index},e.SetIndex=function(t){this.m_index=t},t}();(Mr=t.b2ParticleGroupFlag||(t.b2ParticleGroupFlag={}))[Mr.b2_solidParticleGroup=1]="b2_solidParticleGroup",Mr[Mr.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",Mr[Mr.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",Mr[Mr.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",Mr[Mr.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",Mr[Mr.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";var Or=function(){this.flags=0,this.groupFlags=0,this.position=new bt,this.angle=0,this.linearVelocity=new bt,this.angularVelocity=0,this.color=new Bt,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null},Nr=function(){function e(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new bt,this.m_linearVelocity=new bt,this.m_angularVelocity=0,this.m_transform=new Rt,this.m_userData=null,this.m_system=t}var n=e.prototype;return n.GetNext=function(){return this.m_next},n.GetParticleSystem=function(){return this.m_system},n.GetParticleCount=function(){return this.m_lastIndex-this.m_firstIndex},n.GetBufferIndex=function(){return this.m_firstIndex},n.ContainsParticle=function(t){return this.m_firstIndex<=t&&t<this.m_lastIndex},n.GetAllParticleFlags=function(){if(!this.m_system.m_flagsBuffer.data)throw new Error;for(var t=0,e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t},n.GetGroupFlags=function(){return this.m_groupFlags},n.SetGroupFlags=function(e){e|=this.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,e)},n.GetMass=function(){return this.UpdateStatistics(),this.m_mass},n.GetInertia=function(){return this.UpdateStatistics(),this.m_inertia},n.GetCenter=function(){return this.UpdateStatistics(),this.m_center},n.GetLinearVelocity=function(){return this.UpdateStatistics(),this.m_linearVelocity},n.GetAngularVelocity=function(){return this.UpdateStatistics(),this.m_angularVelocity},n.GetTransform=function(){return this.m_transform},n.GetPosition=function(){return this.m_transform.p},n.GetAngle=function(){return this.m_transform.q.GetAngle()},n.GetLinearVelocityFromWorldPoint=function(t,n){var i=e.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(t,this.m_center,i),n)},n.GetUserData=function(){return this.m_userData},n.SetUserData=function(t){this.m_userData=t},n.ApplyForce=function(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)},n.ApplyLinearImpulse=function(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)},n.DestroyParticles=function(t){if(this.m_system.m_world.IsLocked())throw new Error;for(var e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)},n.UpdateStatistics=function(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;var t=new bt,e=new bt;if(this.m_timestamp!==this.m_system.m_timestamp){var n=this.m_system.GetParticleMass();this.m_mass=n*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(var i=this.m_firstIndex;i<this.m_lastIndex;i++)this.m_center.SelfMulAdd(n,this.m_system.m_positionBuffer.data[i]),this.m_linearVelocity.SelfMulAdd(n,this.m_system.m_velocityBuffer.data[i]);if(this.m_mass>0){var r=1/this.m_mass;this.m_center.SelfMul(r),this.m_linearVelocity.SelfMul(r)}this.m_inertia=0,this.m_angularVelocity=0;for(var o=this.m_firstIndex;o<this.m_lastIndex;o++)bt.SubVV(this.m_system.m_positionBuffer.data[o],this.m_center,t),bt.SubVV(this.m_system.m_velocityBuffer.data[o],this.m_linearVelocity,e),this.m_inertia+=n*bt.DotVV(t,t),this.m_angularVelocity+=n*bt.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}},e}();Nr.GetLinearVelocityFromWorldPoint_s_t0=new bt;var Lr=function(){function t(t){this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,t)}var e=t.prototype;return e.Push=function(t){if(this.m_back>=this.m_capacity){for(var e=this.m_front;e<this.m_back;e++)this.m_buffer[e-this.m_front]=this.m_buffer[e];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=t,this.m_back++},e.Pop=function(){this.m_buffer[this.m_front]=null,this.m_front++},e.Empty=function(){return this.m_front===this.m_back},e.Front=function(){var t=this.m_buffer[this.m_front];if(!t)throw new Error;return t},K(t,[{key:"m_capacity",get:function(){return this.m_buffer.length}}]),t}(),Fr=function(){function t(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=X(t,(function(){return new zr})),this.m_generatorCapacity=t}var e=t.prototype;return e.AddGenerator=function(t,e,n){var i=this.m_generatorBuffer[this.m_generatorCount++];i.center.Copy(t),i.tag=e,i.necessary=n},e.Generate=function(t,e){for(var n=1/t,r=new bt(+i,+i),o=new bt(-i,-i),a=0,s=0;s<this.m_generatorCount;s++){var c=this.m_generatorBuffer[s];c.necessary&&(bt.MinV(r,c.center,r),bt.MaxV(o,c.center,o),++a)}if(0===a)return this.m_countX=0,void(this.m_countY=0);r.x-=e,r.y-=e,o.x+=e,o.y+=e,this.m_countX=1+Math.floor(n*(o.x-r.x)),this.m_countY=1+Math.floor(n*(o.y-r.y)),this.m_diagram=[];for(var l=new Lr(4*this.m_countX*this.m_countY),u=0;u<this.m_generatorCount;u++){var h=this.m_generatorBuffer[u];h.center.SelfSub(r).SelfMul(n);var _=Math.floor(h.center.x),f=Math.floor(h.center.y);_>=0&&f>=0&&_<this.m_countX&&f<this.m_countY&&l.Push(new Vr(_,f,_+f*this.m_countX,h))}for(;!l.Empty();){var d=l.Front(),p=d.m_x,m=d.m_y,v=d.m_i,g=d.m_generator;l.Pop(),this.m_diagram[v]||(this.m_diagram[v]=g,p>0&&l.Push(new Vr(p-1,m,v-1,g)),m>0&&l.Push(new Vr(p,m-1,v-this.m_countX,g)),p<this.m_countX-1&&l.Push(new Vr(p+1,m,v+1,g)),m<this.m_countY-1&&l.Push(new Vr(p,m+1,v+this.m_countX,g)))}for(var y=0;y<this.m_countY;y++)for(var x=0;x<this.m_countX-1;x++){var S=x+y*this.m_countX,A=this.m_diagram[S],C=this.m_diagram[S+1];A!==C&&(l.Push(new Vr(x,y,S,C)),l.Push(new Vr(x+1,y,S+1,A)))}for(var b=0;b<this.m_countY-1;b++)for(var T=0;T<this.m_countX;T++){var E=T+b*this.m_countX,w=this.m_diagram[E],P=this.m_diagram[E+this.m_countX];w!==P&&(l.Push(new Vr(T,b,E,P)),l.Push(new Vr(T,b+1,E+this.m_countX,w)))}for(;!l.Empty();){var I=l.Front(),R=I.m_x,D=I.m_y,M=I.m_i,B=I.m_generator;l.Pop();var O=this.m_diagram[M],N=B;if(O!==N){var L=O.center.x-R,F=O.center.y-D,z=N.center.x-R,V=N.center.y-D;L*L+F*F>z*z+V*V&&(this.m_diagram[M]=N,R>0&&l.Push(new Vr(R-1,D,M-1,N)),D>0&&l.Push(new Vr(R,D-1,M-this.m_countX,N)),R<this.m_countX-1&&l.Push(new Vr(R+1,D,M+1,N)),D<this.m_countY-1&&l.Push(new Vr(R,D+1,M+this.m_countX,N)))}}},e.GetNodes=function(t){for(var e=0;e<this.m_countY-1;e++)for(var n=0;n<this.m_countX-1;n++){var i=n+e*this.m_countX,r=this.m_diagram[i],o=this.m_diagram[i+1],a=this.m_diagram[i+this.m_countX],s=this.m_diagram[i+1+this.m_countX];o!==a&&(r!==o&&r!==a&&(r.necessary||o.necessary||a.necessary)&&t(r.tag,o.tag,a.tag),s!==o&&s!==a&&(r.necessary||o.necessary||a.necessary)&&t(o.tag,s.tag,a.tag))}},t}(),zr=function(){this.center=new bt,this.tag=0,this.necessary=!1},Vr=function(t,e,n,i){this.m_x=t,this.m_y=e,this.m_i=n,this.m_generator=i};function kr(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function Gr(t,e){return t<e}function Ur(t,e,n,i){void 0===e&&(e=0),void 0===n&&(n=t.length-e),void 0===i&&(i=Gr);for(var r=e,o=[],a=0;;){for(;r+1<n;n++){var s=t[r+Math.floor(Math.random()*(n-r))];o[a++]=n;for(var c=r-1;;){for(;i(t[++c],s););for(;i(s,t[--n]););if(c>=n)break;kr(t,c,n)}}if(0===a)break;r=n,n=o[--a]}return t}function Hr(t,e,n,i){return void 0===e&&(e=0),void 0===n&&(n=t.length-e),void 0===i&&(i=Gr),Ur(t,e,n,i)}function jr(t,e,n){void 0===n&&(n=t.length);for(var i=0,r=0;r<n;++r)e(t[r])||(r!==i?kr(t,i++,r):++i);return i}function Wr(t,e,n,i,r){for(var o=n-e;o>0;){var a=Math.floor(o/2),s=e+a;r(t[s],i)?(e=++s,o-=a+1):o=a}return e}function qr(t,e,n,i,r){for(var o=n-e;o>0;){var a=Math.floor(o/2),s=e+a;r(i,t[s])?o=a:(e=++s,o-=a+1)}return e}function Xr(t,e,n,i){for(var r=n;e!==r;)kr(t,e++,r++),r===i?r=n:e===n&&(n=r)}function Yr(t,e,n,i){if(e===n)return n;for(var r=e;++e!==n;)i(t[r],t[e])||kr(t,++r,e);return++r}var Kr=function(){function t(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}var e=t.prototype;return e.Append=function(){return this.count>=this.capacity&&this.Grow(),this.count++},e.Reserve=function(t){if(!(this.capacity>=t)){for(var e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}},e.Grow=function(){var t=this.capacity?2*this.capacity:B;this.Reserve(t)},e.Free=function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)},e.Shorten=function(){},e.Data=function(){return this.data},e.GetCount=function(){return this.count},e.SetCount=function(t){this.count=t},e.GetCapacity=function(){return this.capacity},e.RemoveIf=function(t){this.count=jr(this.data,t,this.count)},e.Unique=function(t){this.count=Yr(this.data,0,this.count,t)},t}(),Jr=function(t){function e(e){var n;return(n=t.call(this)||this).m_system=e,n}Q(e,t);var n=e.prototype;return n.ShouldQueryParticleSystem=function(){return!1},n.ReportFixture=function(t){if(t.IsSensor())return!0;for(var e=t.GetShape().GetChildCount(),n=0;n<e;n++)for(var i=t.GetAABB(n),r=this.m_system.GetInsideBoundsEnumerator(i),o=void 0;(o=r.GetNext())>=0;)this.ReportFixtureAndParticle(t,n,o);return!0},n.ReportParticle=function(){return!1},n.ReportFixtureAndParticle=function(){},e}(fr),Qr=function(){function t(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new bt,this.flags=0}var e=t.prototype;return e.SetIndices=function(t,e){this.indexA=t,this.indexB=e},e.SetWeight=function(t){this.weight=t},e.SetNormal=function(t){this.normal.Copy(t)},e.SetFlags=function(t){this.flags=t},e.GetIndexA=function(){return this.indexA},e.GetIndexB=function(){return this.indexB},e.GetWeight=function(){return this.weight},e.GetNormal=function(){return this.normal},e.GetFlags=function(){return this.flags},e.IsEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y},e.IsNotEqual=function(t){return!this.IsEqual(t)},e.ApproximatelyEqual=function(t){var e=.01,n=1e-4;return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&nt(this.weight-t.weight)<e&&bt.DistanceSquaredVV(this.normal,t.normal)<n},t}(),Zr=function(){this.index=0,this.weight=0,this.normal=new bt,this.mass=0},$r=function(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0},to=function(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new bt(0,0),this.pb=new bt(0,0),this.pc=new bt(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0},eo=function(){function t(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}var e=t.prototype;return e.Copy=function(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this},e.Clone=function(){return(new t).Copy(this)},t}(),no=function(){function e(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new io,this.m_flagsBuffer=new io,this.m_positionBuffer=new io,this.m_velocityBuffer=new io,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new io,this.m_groupBuffer=[],this.m_userDataBuffer=new io,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new io,this.m_bodyContactCountBuffer=new io,this.m_consecutiveContactStepsBuffer=new io,this.m_stuckParticleBuffer=new Kr((function(){return 0})),this.m_proxyBuffer=new Kr((function(){return new ro})),this.m_contactBuffer=new Kr((function(){return new Qr})),this.m_bodyContactBuffer=new Kr((function(){return new Zr})),this.m_pairBuffer=new Kr((function(){return new $r})),this.m_triadBuffer=new Kr((function(){return new to})),this.m_expirationTimeBuffer=new io,this.m_indexByExpirationTimeBuffer=new io,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new eo,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}e.computeTag=function(t,n){return(n+e.yOffset>>>0<<e.yShift)+(e.xScale*t+e.xOffset>>>0)>>>0},e.computeRelativeTag=function(t,n,i){return t+(i<<e.yShift)+(n<<e.xShift)>>>0};var r=e.prototype;return r.Drop=function(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)},r.CreateParticle=function(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){var e=this.m_count?2*this.m_count:B;this.ReallocateInternalAllocatedBuffers(e)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return T;this.DestroyOldestParticle(0,!1),this.SolveZombie()}var i=this.m_count++;this.m_flagsBuffer.data[i]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[i]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[i]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[i]=0),this.m_positionBuffer.data[i]=(this.m_positionBuffer.data[i]||new bt).Copy(n(t.position,bt.ZERO)),this.m_velocityBuffer.data[i]=(this.m_velocityBuffer.data[i]||new bt).Copy(n(t.velocity,bt.ZERO)),this.m_weightBuffer[i]=0,this.m_forceBuffer[i]=(this.m_forceBuffer[i]||new bt).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[i]=0),this.m_depthBuffer&&(this.m_depthBuffer[i]=0);var r=(new Bt).Copy(n(t.color,Bt.ZERO));!this.m_colorBuffer.data&&r.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[i]=(this.m_colorBuffer.data[i]||new Bt).Copy(r)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[i]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[i]=null);var o=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],a=n(t.lifetime,0),s=a>0;(this.m_expirationTimeBuffer.data||s)&&(this.SetParticleLifetime(i,s?a:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[i]=i),o.index=i;var c=n(t.group,null);return this.m_groupBuffer[i]=c,c&&(c.m_firstIndex<c.m_lastIndex?(this.RotateBuffer(c.m_firstIndex,c.m_lastIndex,i),c.m_lastIndex=i+1):(c.m_firstIndex=i,c.m_lastIndex=i+1)),this.SetParticleFlags(i,n(t.flags,0)),i},r.GetParticleHandleFromIndex=function(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);var e=this.m_handleIndexBuffer.data[t];return e||((e=new Br).SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)},r.DestroyParticle=function(e,n){void 0===n&&(n=!1);var i=t.b2ParticleFlag.b2_zombieParticle;n&&(i|=t.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(e,this.m_flagsBuffer.data[e]|i)},r.DestroyOldestParticle=function(t,e){void 0===e&&(e=!1);var n=this.GetParticleCount(),i=this.m_indexByExpirationTimeBuffer.data[n-(t+1)],r=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[i]>0?i:r,e)},r.DestroyParticlesInShape=function(t,n,i){void 0===i&&(i=!1);var r=e.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;var o=new fo(this,t,n,i),a=r;return t.ComputeAABB(a,n,0),this.m_world.QueryAABB(o,a),o.Destroyed()},r.CreateParticleGroup=function(t){var i=e.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;var r=i;r.SetPositionAngle(n(t.position,bt.ZERO),n(t.angle,0));var o=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,r),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,n(t.shapeCount,t.shapes.length),t,r),t.positionData)for(var a=n(t.particleCount,t.positionData.length),s=0;s<a;s++){var c=t.positionData[s];this.CreateParticleForGroup(t,r,c)}var l=this.m_count,u=new Nr(this);u.m_firstIndex=o,u.m_lastIndex=l,u.m_strength=n(t.strength,1),u.m_userData=t.userData,u.m_transform.Copy(r),u.m_prev=null,u.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=u),this.m_groupList=u,++this.m_groupCount;for(var h=o;h<l;h++)this.m_groupBuffer[h]=u;this.SetGroupFlags(u,n(t.groupFlags,0));var _=new _o;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(o,l,_),t.group&&(this.JoinParticleGroups(t.group,u),u=t.group),u},r.JoinParticleGroups=function(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);var n=new po(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,n);for(var i=e.m_firstIndex;i<e.m_lastIndex;i++)this.m_groupBuffer[i]=t;var r=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,r),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)},r.SplitParticleGroup=function(t){this.UpdateContacts(!0);var n=X(t.GetParticleCount(),(function(){return new ao}));e.InitializeParticleLists(t,n),this.MergeParticleListsInContact(t,n);var i=e.FindLongestParticleList(t,n);this.MergeZombieParticleListNodes(t,n,i),this.CreateParticleGroupsFromParticleList(t,n,i),this.UpdatePairsAndTriadsWithParticleList(t,n)},r.GetParticleGroupList=function(){return this.m_groupList},r.GetParticleGroupCount=function(){return this.m_groupCount},r.GetParticleCount=function(){return this.m_count},r.GetMaxParticleCount=function(){return this.m_def.maxCount},r.SetMaxParticleCount=function(t){this.m_def.maxCount=t},r.GetAllParticleFlags=function(){return this.m_allParticleFlags},r.GetAllGroupFlags=function(){return this.m_allGroupFlags},r.SetPaused=function(t){this.m_paused=t},r.GetPaused=function(){return this.m_paused},r.SetDensity=function(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density},r.GetDensity=function(){return this.m_def.density},r.SetGravityScale=function(t){this.m_def.gravityScale=t},r.GetGravityScale=function(){return this.m_def.gravityScale},r.SetDamping=function(t){this.m_def.dampingStrength=t},r.GetDamping=function(){return this.m_def.dampingStrength},r.SetStaticPressureIterations=function(t){this.m_def.staticPressureIterations=t},r.GetStaticPressureIterations=function(){return this.m_def.staticPressureIterations},r.SetRadius=function(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter},r.GetRadius=function(){return this.m_particleDiameter/2},r.GetPositionBuffer=function(){return this.m_positionBuffer.data},r.GetVelocityBuffer=function(){return this.m_velocityBuffer.data},r.GetColorBuffer=function(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data},r.GetGroupBuffer=function(){return this.m_groupBuffer},r.GetWeightBuffer=function(){return this.m_weightBuffer},r.GetUserDataBuffer=function(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data},r.GetFlagsBuffer=function(){return this.m_flagsBuffer.data},r.SetParticleFlags=function(e,n){this.m_flagsBuffer.data[e]&~n&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&n&&(n&t.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),n&t.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=n),this.m_flagsBuffer.data[e]=n},r.GetParticleFlags=function(t){return this.m_flagsBuffer.data[t]},r.SetFlagsBuffer=function(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)},r.SetPositionBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,n=new Array(e),i=0;i<e;++i)n[i]=new bt(t.subarray(2*i,2*i+2));t=n}this.SetUserOverridableBuffer(this.m_positionBuffer,t)},r.SetVelocityBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,n=new Array(e),i=0;i<e;++i)n[i]=new bt(t.subarray(2*i,2*i+2));t=n}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)},r.SetColorBuffer=function(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;for(var e=t.length/4,n=new Array(e),i=0;i<e;++i)n[i]=new Bt(t.subarray(4*i,4*i+4));t=n}this.SetUserOverridableBuffer(this.m_colorBuffer,t)},r.SetUserDataBuffer=function(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)},r.GetContacts=function(){return this.m_contactBuffer.data},r.GetContactCount=function(){return this.m_contactBuffer.count},r.GetBodyContacts=function(){return this.m_bodyContactBuffer.data},r.GetBodyContactCount=function(){return this.m_bodyContactBuffer.count},r.GetPairs=function(){return this.m_pairBuffer.data},r.GetPairCount=function(){return this.m_pairBuffer.count},r.GetTriads=function(){return this.m_triadBuffer.data},r.GetTriadCount=function(){return this.m_triadBuffer.count},r.SetStuckThreshold=function(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))},r.GetStuckCandidates=function(){return this.m_stuckParticleBuffer.Data()},r.GetStuckCandidateCount=function(){return this.m_stuckParticleBuffer.GetCount()},r.ComputeCollisionEnergy=function(){for(var t=e.ComputeCollisionEnergy_s_v,n=this.m_velocityBuffer.data,i=0,r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB,c=o.normal,l=bt.SubVV(n[s],n[a],t),u=bt.DotVV(l,c);u<0&&(i+=u*u)}return.5*this.GetParticleMass()*i},r.SetStrictContactCheck=function(t){this.m_def.strictContactCheck=t},r.GetStrictContactCheck=function(){return this.m_def.strictContactCheck},r.SetParticleLifetime=function(t,e){var n=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),n)for(var i=this.GetParticleCount(),r=0;r<i;++r)this.m_indexByExpirationTimeBuffer.data[r]=r;var o=e/this.m_def.lifetimeGranularity,a=o>0?this.GetQuantizedTimeElapsed()+o:o;a!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=a,this.m_expirationTimeBufferRequiresSorting=!0)},r.GetParticleLifetime=function(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])},r.SetDestructionByAge=function(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t},r.GetDestructionByAge=function(){return this.m_def.destroyByAge},r.GetExpirationTimeBuffer=function(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data},r.ExpirationTimeToLifetime=function(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity},r.GetIndexByExpirationTimeBuffer=function(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data},r.ParticleApplyLinearImpulse=function(t,e){this.ApplyLinearImpulse(t,t+1,e)},r.ApplyLinearImpulse=function(t,e,n){for(var i=this.m_velocityBuffer.data,r=(e-t)*this.GetParticleMass(),o=(new bt).Copy(n).SelfMul(1/r),a=t;a<e;a++)i[a].SelfAdd(o)},e.IsSignificantForce=function(t){return 0!==t.x||0!==t.y},r.ParticleApplyForce=function(t,n){e.IsSignificantForce(n)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(n))},r.ApplyForce=function(t,n,i){var r=(new bt).Copy(i).SelfMul(1/(n-t));if(e.IsSignificantForce(r)){this.PrepareForceBuffer();for(var o=t;o<n;o++)this.m_forceBuffer[o].SelfAdd(r)}},r.GetNext=function(){return this.m_next},r.QueryAABB=function(t,n){if(0!==this.m_proxyBuffer.count)for(var i=0,r=this.m_proxyBuffer.count,o=Wr(this.m_proxyBuffer.data,i,r,e.computeTag(this.m_inverseDiameter*n.lowerBound.x,this.m_inverseDiameter*n.lowerBound.y),ro.CompareProxyTag),a=qr(this.m_proxyBuffer.data,o,r,e.computeTag(this.m_inverseDiameter*n.upperBound.x,this.m_inverseDiameter*n.upperBound.y),ro.CompareTagProxy),s=this.m_positionBuffer.data,c=o;c<a;++c){var l=this.m_proxyBuffer.data[c].index,u=s[l];if(n.lowerBound.x<u.x&&u.x<n.upperBound.x&&n.lowerBound.y<u.y&&u.y<n.upperBound.y&&!t.ReportParticle(this,l))break}},r.QueryShapeAABB=function(t,n,i,r){void 0===r&&(r=0);var o=e.QueryShapeAABB_s_aabb;n.ComputeAABB(o,i,r),this.QueryAABB(t,o)},r.QueryPointAABB=function(t,n,i){void 0===i&&(i=h);var r=e.QueryPointAABB_s_aabb;r.lowerBound.Set(n.x-i,n.y-i),r.upperBound.Set(n.x+i,n.y+i),this.QueryAABB(t,r)},r.RayCast=function(t,n,i){var r=e.RayCast_s_aabb,o=e.RayCast_s_p,a=e.RayCast_s_v,s=e.RayCast_s_n,c=e.RayCast_s_point;if(0!==this.m_proxyBuffer.count){var l=this.m_positionBuffer.data,u=r;bt.MinV(n,i,u.lowerBound),bt.MaxV(n,i,u.upperBound);for(var h,_=1,f=bt.SubVV(i,n,a),d=bt.DotVV(f,f),p=this.GetInsideBoundsEnumerator(u);(h=p.GetNext())>=0;){var m=bt.SubVV(n,l[h],o),v=bt.DotVV(m,f),g=v*v-d*(bt.DotVV(m,m)-this.m_squaredDiameter);if(g>=0){var y=ht(g),x=(-v-y)/d;if(x>_)continue;if(x<0&&((x=(-v+y)/d)<0||x>_))continue;var S=bt.AddVMulSV(m,x,f,s);if(S.Normalize(),(_=it(_,t.ReportParticle(this,h,bt.AddVMulSV(n,x,f,c),S,x)))<=0)break}}}},r.ComputeAABB=function(t){var e=this.GetParticleCount();t.lowerBound.x=+i,t.lowerBound.y=+i,t.upperBound.x=-i,t.upperBound.y=-i;for(var n=this.m_positionBuffer.data,r=0;r<e;r++){var o=n[r];bt.MinV(t.lowerBound,o,t.lowerBound),bt.MaxV(t.upperBound,o,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter},r.FreeBuffer=function(t){null!==t&&(t.length=0)},r.FreeUserOverridableBuffer=function(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)},r.ReallocateBuffer3=function(t,e,n){if(n<=e)throw new Error;var i=t?t.slice():[];return i.length=n,i},r.ReallocateBuffer5=function(t,e,n,i,r){if(i<=n)throw new Error;if(e&&!(i<=e))throw new Error;return r&&!t||e||(t=this.ReallocateBuffer3(t,n,i)),t},r.ReallocateBuffer4=function(t,e,n,i){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,n,i)},r.RequestBuffer=function(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(B),(t=[]).length=this.m_internalAllocatedCapacity),t},r.ReallocateHandleBuffers=function(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)},r.ReallocateInternalAllocatedBuffers=function(t){function e(t,e){return e&&t>e?e:t}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);var n=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,n),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,n),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,n),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}},r.CreateParticleForGroup=function(t,e,i){var r=new Rr;r.flags=n(t.flags,0),Rt.MulXV(e,i,r.position),bt.AddVV(n(t.linearVelocity,bt.ZERO),bt.CrossSV(n(t.angularVelocity,0),bt.SubVV(r.position,n(t.position,bt.ZERO),bt.s_t0),bt.s_t0),r.velocity),r.color.Copy(n(t.color,Bt.ZERO)),r.lifetime=n(t.lifetime,0),r.userData=t.userData,this.CreateParticle(r)},r.CreateParticlesStrokeShapeForGroup=function(i,r,o){var a=e.CreateParticlesStrokeShapeForGroup_s_edge,s=e.CreateParticlesStrokeShapeForGroup_s_d,c=e.CreateParticlesStrokeShapeForGroup_s_p,l=n(r.stride,0);0===l&&(l=this.GetParticleStride());for(var u=0,h=i.GetChildCount(),_=0;_<h;_++){var f=null;i.GetType()===t.b2ShapeType.e_edgeShape?f=i:(f=a,i.GetChildEdge(f,_));for(var d=bt.SubVV(f.m_vertex2,f.m_vertex1,s),p=d.Length();u<p;){var m=bt.AddVMulSV(f.m_vertex1,u/p,d,c);this.CreateParticleForGroup(r,o,m),u+=l}u-=p}},r.CreateParticlesFillShapeForGroup=function(t,i,r){var o=e.CreateParticlesFillShapeForGroup_s_aabb,a=e.CreateParticlesFillShapeForGroup_s_p,s=n(i.stride,0);0===s&&(s=this.GetParticleStride());var c=Rt.IDENTITY,l=o;t.ComputeAABB(l,c,0);for(var u=Math.floor(l.lowerBound.y/s)*s;u<l.upperBound.y;u+=s)for(var h=Math.floor(l.lowerBound.x/s)*s;h<l.upperBound.x;h+=s){var _=a.Set(h,u);t.TestPoint(c,_)&&this.CreateParticleForGroup(i,r,_)}},r.CreateParticlesWithShapeForGroup=function(e,n,i){switch(e.GetType()){case t.b2ShapeType.e_edgeShape:case t.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(e,n,i);break;case t.b2ShapeType.e_polygonShape:case t.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(e,n,i)}},r.CreateParticlesWithShapesForGroup=function(t,e,n,i){var r=new mo(t,e);this.CreateParticlesFillShapeForGroup(r,n,i)},r.CloneParticle=function(t,e){var n=new Rr;n.flags=this.m_flagsBuffer.data[t],n.position.Copy(this.m_positionBuffer.data[t]),n.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&n.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(n.userData=this.m_userDataBuffer.data[t]),n.group=e;var i=this.CreateParticle(n);if(this.m_handleIndexBuffer.data){var r=this.m_handleIndexBuffer.data[t];r&&r.SetIndex(i),this.m_handleIndexBuffer.data[i]=r,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[i]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[i]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[i]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[i].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[i]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[i]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[i]=this.m_expirationTimeBuffer.data[t]),i},r.DestroyParticlesInGroup=function(t,e){void 0===e&&(e=!1);for(var n=t.m_firstIndex;n<t.m_lastIndex;n++)this.DestroyParticle(n,e)},r.DestroyParticleGroup=function(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(var e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount},e.ParticleCanBeConnected=function(e,n){return 0!=(e&(t.b2ParticleFlag.b2_wallParticle|t.b2ParticleFlag.b2_springParticle|t.b2ParticleFlag.b2_elasticParticle))||null!==n&&0!=(n.GetGroupFlags()&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},r.UpdatePairsAndTriads=function(n,i,r){for(var o=e.UpdatePairsAndTriads_s_dab,a=e.UpdatePairsAndTriads_s_dbc,s=e.UpdatePairsAndTriads_s_dca,c=this.m_positionBuffer.data,l=0,u=n;u<i;u++)l|=this.m_flagsBuffer.data[u];if(l&e.k_pairFlags)for(var h=0;h<this.m_contactBuffer.count;h++){var _=this.m_contactBuffer.data[h],f=_.indexA,d=_.indexB,p=this.m_flagsBuffer.data[f],m=this.m_flagsBuffer.data[d],v=this.m_groupBuffer[f],g=this.m_groupBuffer[d];if(f>=n&&f<i&&d>=n&&d<i&&!((p|m)&t.b2ParticleFlag.b2_zombieParticle)&&(p|m)&e.k_pairFlags&&(r.IsNecessary(f)||r.IsNecessary(d))&&e.ParticleCanBeConnected(p,v)&&e.ParticleCanBeConnected(m,g)&&r.ShouldCreatePair(f,d)){var y=this.m_pairBuffer.data[this.m_pairBuffer.Append()];y.indexA=f,y.indexB=d,y.flags=_.flags,y.strength=it(v?v.m_strength:1,g?g.m_strength:1),y.distance=bt.DistanceVV(c[f],c[d])}Hr(this.m_pairBuffer.data,0,this.m_pairBuffer.count,e.ComparePairIndices),this.m_pairBuffer.Unique(e.MatchPairIndices)}if(l&e.k_triadFlags){for(var x=new Fr(i-n),S=n;S<i;S++){var A=this.m_flagsBuffer.data[S],C=this.m_groupBuffer[S];A&t.b2ParticleFlag.b2_zombieParticle||!e.ParticleCanBeConnected(A,C)||x.AddGenerator(c[S],S,r.IsNecessary(S))}var b=this.GetParticleStride();x.Generate(b/2,2*b);var T=this,E=function(t,n,i){var l=T.m_flagsBuffer.data[t],u=T.m_flagsBuffer.data[n],h=T.m_flagsBuffer.data[i];if((l|u|h)&e.k_triadFlags&&r.ShouldCreateTriad(t,n,i)){var _=c[t],f=c[n],d=c[i],p=bt.SubVV(_,f,o),m=bt.SubVV(f,d,a),v=bt.SubVV(d,_,s),g=M*T.m_squaredDiameter;if(bt.DotVV(p,p)>g||bt.DotVV(m,m)>g||bt.DotVV(v,v)>g)return;var y=T.m_groupBuffer[t],x=T.m_groupBuffer[n],S=T.m_groupBuffer[i],A=T.m_triadBuffer.data[T.m_triadBuffer.Append()];A.indexA=t,A.indexB=n,A.indexC=i,A.flags=l|u|h,A.strength=it(it(y?y.m_strength:1,x?x.m_strength:1),S?S.m_strength:1);var C=(_.x+f.x+d.x)/3,b=(_.y+f.y+d.y)/3;A.pa.x=_.x-C,A.pa.y=_.y-b,A.pb.x=f.x-C,A.pb.y=f.y-b,A.pc.x=d.x-C,A.pc.y=d.y-b,A.ka=-bt.DotVV(v,p),A.kb=-bt.DotVV(p,m),A.kc=-bt.DotVV(m,v),A.s=bt.CrossVV(_,f)+bt.CrossVV(f,d)+bt.CrossVV(d,_)}};x.GetNodes(E),Hr(this.m_triadBuffer.data,0,this.m_triadBuffer.count,e.CompareTriadIndices),this.m_triadBuffer.Unique(e.MatchTriadIndices)}},r.UpdatePairsAndTriadsWithReactiveParticles=function(){var e=new vo(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,e);for(var n=0;n<this.m_count;n++)this.m_flagsBuffer.data[n]&=~t.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~t.b2ParticleFlag.b2_reactiveParticle},e.ComparePairIndices=function(t,e){var n=t.indexA-e.indexA;return 0!==n?n<0:t.indexB<e.indexB},e.MatchPairIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB},e.CompareTriadIndices=function(t,e){var n=t.indexA-e.indexA;if(0!==n)return n<0;var i=t.indexB-e.indexB;return 0!==i?i<0:t.indexC<e.indexC},e.MatchTriadIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC},e.InitializeParticleLists=function(t,e){for(var n=t.GetBufferIndex(),i=t.GetParticleCount(),r=0;r<i;r++){var o=e[r];o.list=o,o.next=null,o.count=1,o.index=r+n}},r.MergeParticleListsInContact=function(t,n){for(var i=t.GetBufferIndex(),r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB;if(t.ContainsParticle(a)&&t.ContainsParticle(s)){var c=n[a-i].list,l=n[s-i].list;if(c!==l){if(c.count<l.count){var u=c;c=l,l=u}e.MergeParticleLists(c,l)}}}},e.MergeParticleLists=function(t,e){for(var n=e;;){n.list=t;var i=n.next;if(!i){n.next=t.next;break}n=i}t.next=e,t.count+=e.count,e.count=0},e.FindLongestParticleList=function(t,e){for(var n=t.GetParticleCount(),i=e[0],r=0;r<n;r++){var o=e[r];i.count<o.count&&(i=o)}return i},r.MergeZombieParticleListNodes=function(n,i,r){for(var o=n.GetParticleCount(),a=0;a<o;a++){var s=i[a];s!==r&&this.m_flagsBuffer.data[s.index]&t.b2ParticleFlag.b2_zombieParticle&&e.MergeParticleListAndNode(r,s)}},e.MergeParticleListAndNode=function(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0},r.CreateParticleGroupsFromParticleList=function(e,n,i){var r=e.GetParticleCount(),o=new Or;o.groupFlags=e.GetGroupFlags(),o.userData=e.GetUserData();for(var a=0;a<r;a++){var s=n[a];if(s.count&&s!==i)for(var c=this.CreateParticleGroup(o),l=s;l;l=l.next){var u=l.index,h=this.CloneParticle(u,c);this.m_flagsBuffer.data[u]|=t.b2ParticleFlag.b2_zombieParticle,l.index=h}}},r.UpdatePairsAndTriadsWithParticleList=function(t,e){for(var n=t.GetBufferIndex(),i=0;i<this.m_pairBuffer.count;i++){var r=this.m_pairBuffer.data[i],o=r.indexA,a=r.indexB;t.ContainsParticle(o)&&(r.indexA=e[o-n].index),t.ContainsParticle(a)&&(r.indexB=e[a-n].index)}for(var s=0;s<this.m_triadBuffer.count;s++){var c=this.m_triadBuffer.data[s],l=c.indexA,u=c.indexB,h=c.indexC;t.ContainsParticle(l)&&(c.indexA=e[l-n].index),t.ContainsParticle(u)&&(c.indexB=e[u-n].index),t.ContainsParticle(h)&&(c.indexC=e[h-n].index)}},r.ComputeDepth=function(){for(var e=[],n=0,r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB,c=this.m_groupBuffer[a],l=this.m_groupBuffer[s];c&&c===l&&c.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(e[n++]=o)}for(var u=[],h=0,_=this.m_groupList;_;_=_.GetNext())if(_.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){u[h++]=_,this.SetGroupFlags(_,_.m_groupFlags&~t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(var f=_.m_firstIndex;f<_.m_lastIndex;f++)this.m_accumulationBuffer[f]=0}for(var d=0;d<n;d++){var p=e[d],m=p.indexA,v=p.indexB,g=p.weight;this.m_accumulationBuffer[m]+=g,this.m_accumulationBuffer[v]+=g}for(var y=0;y<h;y++)for(var x=u[y],S=x.m_firstIndex;S<x.m_lastIndex;S++){var A=this.m_accumulationBuffer[S];this.m_depthBuffer[S]=A<.8?0:i}for(var C=ht(this.m_count)>>0,b=0;b<C;b++){for(var T=!1,E=0;E<n;E++){var w=e[E],P=w.indexA,I=w.indexB,R=1-w.weight,D=this.m_depthBuffer[P],M=this.m_depthBuffer[I],B=M+R,O=D+R;D>B&&(this.m_depthBuffer[P]=B,T=!0),M>O&&(this.m_depthBuffer[I]=O,T=!0)}if(!T)break}for(var N=0;N<h;N++)for(var L=u[N],F=L.m_firstIndex;F<L.m_lastIndex;F++)this.m_depthBuffer[F]<i?this.m_depthBuffer[F]*=this.m_particleDiameter:this.m_depthBuffer[F]=0},r.GetInsideBoundsEnumerator=function(t){var n=e.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=e.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),r=0,o=this.m_proxyBuffer.count,a=Wr(this.m_proxyBuffer.data,r,o,n,ro.CompareProxyTag),s=qr(this.m_proxyBuffer.data,r,o,i,ro.CompareTagProxy);return new oo(this,n,i,a,s)},r.UpdateAllParticleFlags=function(){this.m_allParticleFlags=0;for(var t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1},r.UpdateAllGroupFlags=function(){this.m_allGroupFlags=0;for(var t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1},r.AddContact=function(t,n){var i=this.m_flagsBuffer.data,r=this.m_positionBuffer.data,o=bt.SubVV(r[n],r[t],e.AddContact_s_d),a=bt.DotVV(o,o);if(0<a&&a<this.m_squaredDiameter){var s=ut(a),c=this.m_contactBuffer.data[this.m_contactBuffer.Append()];c.indexA=t,c.indexB=n,c.flags=i[t]|i[n],c.weight=1-a*s*this.m_inverseDiameter,c.normal.x=s*o.x,c.normal.y=s*o.y}},r.FindContacts_Reference=function(){var t=0,n=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(var i=t,r=t;i<n;i++){for(var o=e.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,0),a=i+1;a<n&&!(o<this.m_proxyBuffer.data[a].tag);a++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[a].index,this.m_contactBuffer);for(var s=e.computeRelativeTag(this.m_proxyBuffer.data[i].tag,-1,1);r<n&&!(s<=this.m_proxyBuffer.data[r].tag);r++);for(var c=e.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,1),l=r;l<n&&!(c<this.m_proxyBuffer.data[l].tag);l++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[l].index,this.m_contactBuffer)}},r.FindContacts=function(t){this.FindContacts_Reference(t)},r.UpdateProxies_Reference=function(){for(var t=this.m_positionBuffer.data,n=this.m_inverseDiameter,i=0;i<this.m_proxyBuffer.count;++i){var r=this.m_proxyBuffer.data[i],o=t[r.index];r.tag=e.computeTag(n*o.x,n*o.y)}},r.UpdateProxies=function(t){this.UpdateProxies_Reference(t)},r.SortProxies=function(){Ur(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,ro.CompareProxyProxy)},r.FilterContacts=function(){var e=this.GetParticleContactFilter();if(null!==e){var n=this,i=function(i){return 0!=(i.flags&t.b2ParticleFlag.b2_particleContactFilterParticle)&&!e.ShouldCollideParticleParticle(n,i.indexA,i.indexB)};this.m_contactBuffer.RemoveIf(i)}},r.NotifyContactListenerPreContact=function(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error},r.NotifyContactListenerPostContact=function(){var t=this.GetParticleContactListener();if(null!==t){for(var e=0;e<this.m_contactBuffer.count;++e){var n=this.m_contactBuffer.data[e];t.BeginContactParticleParticle(this,n)}throw new Error}},e.b2ParticleContactIsZombie=function(e){return(e.flags&t.b2ParticleFlag.b2_zombieParticle)===t.b2ParticleFlag.b2_zombieParticle},r.UpdateContacts=function(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);var n=new ho;this.NotifyContactListenerPreContact(n),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(n),t&&this.m_contactBuffer.RemoveIf(e.b2ParticleContactIsZombie)},r.NotifyBodyContactListenerPreContact=function(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error},r.NotifyBodyContactListenerPostContact=function(){var t=this.GetFixtureContactListener();if(null!==t){for(var e=0;e<this.m_bodyContactBuffer.count;e++){var n=this.m_bodyContactBuffer.data[e];t.BeginContactFixtureParticle(this,n)}throw new Error}},r.UpdateBodyContacts=function(){var t=e.UpdateBodyContacts_s_aabb,n=new lo;if(this.NotifyBodyContactListenerPreContact(n),this.m_stuckThreshold>0)for(var i=this.GetParticleCount(),r=0;r<i;r++)this.m_bodyContactCountBuffer.data[r]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[r]+1&&(this.m_consecutiveContactStepsBuffer.data[r]=0);this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);var o=t;this.ComputeAABB(o),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new go(this));var a=this.UpdateBodyContacts_callback;a.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(a,o),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(n)},r.Solve=function(n){var i=e.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<n.particleIterations;this.m_iterationIndex++){++this.m_timestamp;var r=i.Copy(n);r.dt/=n.particleIterations,r.inv_dt*=n.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&t.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&t.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(r),this.SolvePressure(r),this.SolveDamping(r),this.m_allParticleFlags&e.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_springParticle&&this.SolveSpring(r),this.LimitVelocity(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(r),this.SolveCollision(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(var o=0;o<this.m_count;o++)this.m_positionBuffer.data[o].SelfMulAdd(r.dt,this.m_velocityBuffer.data[o])}},r.SolveCollision=function(t){var n=e.SolveCollision_s_aabb,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=n;a.lowerBound.x=+i,a.lowerBound.y=+i,a.upperBound.x=-i,a.upperBound.y=-i;for(var s=0;s<this.m_count;s++){var c=o[s],l=r[s],u=l.x+t.dt*c.x,h=l.y+t.dt*c.y;a.lowerBound.x=it(a.lowerBound.x,it(l.x,u)),a.lowerBound.y=it(a.lowerBound.y,it(l.y,h)),a.upperBound.x=rt(a.upperBound.x,rt(l.x,u)),a.upperBound.y=rt(a.upperBound.y,rt(l.y,h))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new yo(this,t));var _=this.SolveCollision_callback;_.m_step=t,this.m_world.QueryAABB(_,a)},r.LimitVelocity=function(t){for(var e=this.m_velocityBuffer.data,n=this.GetCriticalVelocitySquared(t),i=0;i<this.m_count;i++){var r=e[i],o=bt.DotVV(r,r);o>n&&r.SelfMul(ht(n/o))}},r.SolveGravity=function(t){for(var n=e.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,r=bt.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),n),o=0;o<this.m_count;o++)i[o].SelfAdd(r)},r.SolveBarrier=function(n){for(var i=e.SolveBarrier_s_aabb,r=e.SolveBarrier_s_va,o=e.SolveBarrier_s_vb,a=e.SolveBarrier_s_pba,s=e.SolveBarrier_s_vba,c=e.SolveBarrier_s_vc,l=e.SolveBarrier_s_pca,u=e.SolveBarrier_s_vca,h=e.SolveBarrier_s_qba,_=e.SolveBarrier_s_qca,f=e.SolveBarrier_s_dv,d=e.SolveBarrier_s_f,p=this.m_positionBuffer.data,m=this.m_velocityBuffer.data,v=0;v<this.m_count;v++)0!=(this.m_flagsBuffer.data[v]&e.k_barrierWallFlags)&&m[v].SetZero();for(var g=O*n.dt,y=this.GetParticleMass(),x=0;x<this.m_pairBuffer.count;x++){var S=this.m_pairBuffer.data[x];if(S.flags&t.b2ParticleFlag.b2_barrierParticle){var A=S.indexA,C=S.indexB,b=p[A],T=p[C],E=i;bt.MinV(b,T,E.lowerBound),bt.MaxV(b,T,E.upperBound);for(var w=this.m_groupBuffer[A],P=this.m_groupBuffer[C],I=this.GetLinearVelocity(w,A,b,r),R=this.GetLinearVelocity(P,C,T,o),D=bt.SubVV(T,b,a),M=bt.SubVV(R,I,s),B=this.GetInsideBoundsEnumerator(E),N=void 0;(N=B.GetNext())>=0;){var L=p[N],F=this.m_groupBuffer[N];if(w!==F&&P!==F){var z=this.GetLinearVelocity(F,N,L,c),V=bt.SubVV(L,b,l),k=bt.SubVV(z,I,u),G=bt.CrossVV(M,k),U=bt.CrossVV(D,k)-bt.CrossVV(V,M),H=bt.CrossVV(D,V),j=void 0,W=void 0,q=h,X=_;if(0===G){if(0===U)continue;if(!((W=-H/U)>=0&&W<g))continue;if(bt.AddVMulSV(D,W,M,q),bt.AddVMulSV(V,W,k,X),!((j=bt.DotVV(q,X)/bt.DotVV(q,q))>=0&&j<=1))continue}else{var Y=U*U-4*H*G;if(Y<0)continue;var K=ht(Y),J=(-U-K)/(2*G),Q=(-U+K)/(2*G);if(J>Q){var Z=J;J=Q,Q=Z}if(W=J,bt.AddVMulSV(D,W,M,q),bt.AddVMulSV(V,W,k,X),j=bt.DotVV(q,X)/bt.DotVV(q,q),!(W>=0&&W<g&&j>=0&&j<=1)){if(!((W=Q)>=0&&W<g))continue;if(bt.AddVMulSV(D,W,M,q),bt.AddVMulSV(V,W,k,X),!((j=bt.DotVV(q,X)/bt.DotVV(q,q))>=0&&j<=1))continue}}var $=f;$.x=I.x+j*M.x-z.x,$.y=I.y+j*M.y-z.y;var tt=bt.MulSV(y,$,d);if(F&&this.IsRigidGroup(F)){var et=F.GetMass(),nt=F.GetInertia();et>0&&F.m_linearVelocity.SelfMulAdd(1/et,tt),nt>0&&(F.m_angularVelocity+=bt.CrossVV(bt.SubVV(L,F.GetCenter(),bt.s_t0),tt)/nt)}else m[N].SelfAdd($);this.ParticleApplyForce(N,tt.SelfMul(-n.inv_dt))}}}}},r.SolveStaticPressure=function(e){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);for(var n=this.GetCriticalPressure(e),i=this.m_def.staticPressureStrength*n,r=I*n,o=this.m_def.staticPressureRelaxation,a=0;a<this.m_def.staticPressureIterations;a++){for(var s=0;s<this.m_count;s++)this.m_accumulationBuffer[s]=0;for(var c=0;c<this.m_contactBuffer.count;c++){var l=this.m_contactBuffer.data[c];if(l.flags&t.b2ParticleFlag.b2_staticPressureParticle){var u=l.indexA,h=l.indexB,_=l.weight;this.m_accumulationBuffer[u]+=_*this.m_staticPressureBuffer[h],this.m_accumulationBuffer[h]+=_*this.m_staticPressureBuffer[u]}}for(var f=0;f<this.m_count;f++){var d=this.m_weightBuffer[f];if(this.m_flagsBuffer.data[f]&t.b2ParticleFlag.b2_staticPressureParticle){var p=(this.m_accumulationBuffer[f]+i*(d-P))/(d+o);this.m_staticPressureBuffer[f]=at(p,0,r)}else this.m_staticPressureBuffer[f]=0}}},r.ComputeWeight=function(){for(var t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(var e=0;e<this.m_bodyContactBuffer.count;e++){var n=this.m_bodyContactBuffer.data[e],i=n.index,r=n.weight;this.m_weightBuffer[i]+=r}for(var o=0;o<this.m_contactBuffer.count;o++){var a=this.m_contactBuffer.data[o],s=a.indexA,c=a.indexB,l=a.weight;this.m_weightBuffer[s]+=l,this.m_weightBuffer[c]+=l}},r.SolvePressure=function(n){for(var i=e.SolvePressure_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.GetCriticalPressure(n),s=this.m_def.pressureStrength*a,c=I*a,l=0;l<this.m_count;l++){var u=s*rt(0,this.m_weightBuffer[l]-P);this.m_accumulationBuffer[l]=it(u,c)}if(this.m_allParticleFlags&e.k_noPressureFlags)for(var h=0;h<this.m_count;h++)this.m_flagsBuffer.data[h]&e.k_noPressureFlags&&(this.m_accumulationBuffer[h]=0);if(this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle)for(var _=0;_<this.m_count;_++)this.m_flagsBuffer.data[_]&t.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[_]+=this.m_staticPressureBuffer[_]);for(var f=n.dt/(this.m_def.density*this.m_particleDiameter),d=this.GetParticleInvMass(),p=0;p<this.m_bodyContactBuffer.count;p++){var m=this.m_bodyContactBuffer.data[p],v=m.index,g=m.body,y=m.weight,x=m.mass,S=m.normal,A=r[v],C=this.m_accumulationBuffer[v]+s*y,b=bt.MulSV(f*y*x*C,S,i);o[v].SelfMulSub(d,b),g.ApplyLinearImpulse(b,A,!0)}for(var T=0;T<this.m_contactBuffer.count;T++){var E=this.m_contactBuffer.data[T],w=E.indexA,R=E.indexB,D=E.weight,M=E.normal,B=this.m_accumulationBuffer[w]+this.m_accumulationBuffer[R],O=bt.MulSV(f*D*B,M,i);o[w].SelfSub(O),o[R].SelfAdd(O)}},r.SolveDamping=function(t){for(var n=e.SolveDamping_s_v,i=e.SolveDamping_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.dampingStrength,s=1/this.GetCriticalVelocity(t),c=this.GetParticleInvMass(),l=0;l<this.m_bodyContactBuffer.count;l++){var u=this.m_bodyContactBuffer.data[l],h=u.index,_=u.body,f=u.weight,d=u.mass,p=u.normal,m=r[h],v=bt.SubVV(_.GetLinearVelocityFromWorldPoint(m,bt.s_t0),o[h],n),g=bt.DotVV(v,p);if(g<0){var y=rt(a*f,it(-s*g,.5)),x=bt.MulSV(y*d*g,p,i);o[h].SelfMulAdd(c,x),_.ApplyLinearImpulse(x.SelfNeg(),m,!0)}}for(var S=0;S<this.m_contactBuffer.count;S++){var A=this.m_contactBuffer.data[S],C=A.indexA,b=A.indexB,T=A.weight,E=A.normal,w=bt.SubVV(o[b],o[C],n),P=bt.DotVV(w,E);if(P<0){var I=rt(a*T,it(-s*P,.5)),R=bt.MulSV(I*P,E,i);o[C].SelfAdd(R),o[b].SelfSub(R)}}},r.SolveRigidDamping=function(){for(var t=e.SolveRigidDamping_s_t0,n=e.SolveRigidDamping_s_t1,i=e.SolveRigidDamping_s_p,r=e.SolveRigidDamping_s_v,o=[0],a=[0],s=[0],c=[0],l=[0],u=[0],h=this.m_positionBuffer.data,_=this.m_def.dampingStrength,f=0;f<this.m_bodyContactBuffer.count;f++){var d=this.m_bodyContactBuffer.data[f],p=d.index,m=this.m_groupBuffer[p];if(m&&this.IsRigidGroup(m)){var v=d.body,g=d.normal,y=d.weight,x=h[p],S=bt.SubVV(v.GetLinearVelocityFromWorldPoint(x,t),m.GetLinearVelocityFromWorldPoint(x,n),r),A=bt.DotVV(S,g);if(A<0){this.InitDampingParameterWithRigidGroupOrParticle(o,a,s,!0,m,p,x,g),this.InitDampingParameter(c,l,u,v.GetMass(),v.GetInertia()-v.GetMass()*v.GetLocalCenter().LengthSquared(),v.GetWorldCenter(),x,g);var C=_*it(y,1)*this.ComputeDampingImpulse(o[0],a[0],s[0],c[0],l[0],u[0],A);this.ApplyDamping(o[0],a[0],s[0],!0,m,p,C,g),v.ApplyLinearImpulse(bt.MulSV(-C,g,bt.s_t0),x,!0)}}}for(var b=0;b<this.m_contactBuffer.count;b++){var T=this.m_contactBuffer.data[b],E=T.indexA,w=T.indexB,P=T.normal,I=T.weight,R=this.m_groupBuffer[E],D=this.m_groupBuffer[w],M=this.IsRigidGroup(R),B=this.IsRigidGroup(D);if(R!==D&&(M||B)){var O=bt.MidVV(h[E],h[w],i),N=bt.SubVV(this.GetLinearVelocity(D,w,O,t),this.GetLinearVelocity(R,E,O,n),r),L=bt.DotVV(N,P);if(L<0){this.InitDampingParameterWithRigidGroupOrParticle(o,a,s,M,R,E,O,P),this.InitDampingParameterWithRigidGroupOrParticle(c,l,u,B,D,w,O,P);var F=_*I*this.ComputeDampingImpulse(o[0],a[0],s[0],c[0],l[0],u[0],L);this.ApplyDamping(o[0],a[0],s[0],M,R,E,F,P),this.ApplyDamping(c[0],l[0],u[0],B,D,w,-F,P)}}}},r.SolveExtraDamping=function(){for(var t=e.SolveExtraDamping_s_v,n=e.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,r=this.m_positionBuffer.data,o=this.GetParticleInvMass(),a=0;a<this.m_bodyContactBuffer.count;a++){var s=this.m_bodyContactBuffer.data[a],c=s.index;if(this.m_flagsBuffer.data[c]&e.k_extraDampingFlags){var l=s.body,u=s.mass,h=s.normal,_=r[c],f=bt.SubVV(l.GetLinearVelocityFromWorldPoint(_,bt.s_t0),i[c],t),d=bt.DotVV(f,h);if(d<0){var p=bt.MulSV(.5*u*d,h,n);i[c].SelfMulAdd(o,p),l.ApplyLinearImpulse(p.SelfNeg(),_,!0)}}}},r.SolveWall=function(){for(var e=this.m_velocityBuffer.data,n=0;n<this.m_count;n++)this.m_flagsBuffer.data[n]&t.b2ParticleFlag.b2_wallParticle&&e[n].SetZero()},r.SolveRigid=function(n){for(var i=e.SolveRigid_s_position,r=e.SolveRigid_s_rotation,o=e.SolveRigid_s_transform,a=e.SolveRigid_s_velocityTransform,s=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup){l.UpdateStatistics();var u=r;u.SetAngle(n.dt*l.m_angularVelocity);var h=bt.AddVV(l.m_center,bt.SubVV(bt.MulSV(n.dt,l.m_linearVelocity,bt.s_t0),It.MulRV(u,l.m_center,bt.s_t1),bt.s_t0),i),_=o;_.SetPositionRotation(h,u),Rt.MulXX(_,l.m_transform,l.m_transform);var f=a;f.p.x=n.inv_dt*_.p.x,f.p.y=n.inv_dt*_.p.y,f.q.s=n.inv_dt*_.q.s,f.q.c=n.inv_dt*(_.q.c-1);for(var d=l.m_firstIndex;d<l.m_lastIndex;d++)Rt.MulXV(f,s[d],c[d])}},r.SolveElastic=function(n){for(var i=e.SolveElastic_s_pa,r=e.SolveElastic_s_pb,o=e.SolveElastic_s_pc,a=e.SolveElastic_s_r,s=e.SolveElastic_s_t0,c=this.m_positionBuffer.data,l=this.m_velocityBuffer.data,u=n.inv_dt*this.m_def.elasticStrength,h=0;h<this.m_triadBuffer.count;h++){var _=this.m_triadBuffer.data[h];if(_.flags&t.b2ParticleFlag.b2_elasticParticle){var f=_.indexA,d=_.indexB,p=_.indexC,m=_.pa,v=_.pb,g=_.pc,y=i.Copy(c[f]),x=r.Copy(c[d]),S=o.Copy(c[p]),A=l[f],C=l[d],b=l[p];y.SelfMulAdd(n.dt,A),x.SelfMulAdd(n.dt,C),S.SelfMulAdd(n.dt,b);var T=(y.x+x.x+S.x)/3,E=(y.y+x.y+S.y)/3;y.x-=T,y.y-=E,x.x-=T,x.y-=E,S.x-=T,S.y-=E;var w=a;w.s=bt.CrossVV(m,y)+bt.CrossVV(v,x)+bt.CrossVV(g,S),w.c=bt.DotVV(m,y)+bt.DotVV(v,x)+bt.DotVV(g,S);var P=ut(w.s*w.s+w.c*w.c);isFinite(P)||(P=198177537e11),w.s*=P,w.c*=P;var I=u*_.strength;It.MulRV(w,m,s),bt.SubVV(s,y,s),bt.MulSV(I,s,s),A.SelfAdd(s),It.MulRV(w,v,s),bt.SubVV(s,x,s),bt.MulSV(I,s,s),C.SelfAdd(s),It.MulRV(w,g,s),bt.SubVV(s,S,s),bt.MulSV(I,s,s),b.SelfAdd(s)}}},r.SolveSpring=function(n){for(var i=e.SolveSpring_s_pa,r=e.SolveSpring_s_pb,o=e.SolveSpring_s_d,a=e.SolveSpring_s_f,s=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=n.inv_dt*this.m_def.springStrength,u=0;u<this.m_pairBuffer.count;u++){var h=this.m_pairBuffer.data[u];if(h.flags&t.b2ParticleFlag.b2_springParticle){var _=h.indexA,f=h.indexB,d=i.Copy(s[_]),p=r.Copy(s[f]),m=c[_],v=c[f];d.SelfMulAdd(n.dt,m),p.SelfMulAdd(n.dt,v);var g=bt.SubVV(p,d,o),y=h.distance,x=g.Length(),S=l*h.strength,A=bt.MulSV(S*(y-x)/x,g,a);m.SelfSub(A),v.SelfAdd(A)}}},r.SolveTensile=function(n){for(var i=e.SolveTensile_s_weightedNormal,r=e.SolveTensile_s_s,o=e.SolveTensile_s_f,a=this.m_velocityBuffer.data,s=0;s<this.m_count;s++)this.m_accumulation2Buffer[s]=new bt,this.m_accumulation2Buffer[s].SetZero();for(var c=0;c<this.m_contactBuffer.count;c++){var l=this.m_contactBuffer.data[c];if(l.flags&t.b2ParticleFlag.b2_tensileParticle){var u=l.indexA,h=l.indexB,_=l.weight,f=l.normal,d=bt.MulSV((1-_)*_,f,i);this.m_accumulation2Buffer[u].SelfSub(d),this.m_accumulation2Buffer[h].SelfAdd(d)}}for(var p=this.GetCriticalVelocity(n),m=this.m_def.surfaceTensionPressureStrength*p,v=this.m_def.surfaceTensionNormalStrength*p,g=R*p,y=0;y<this.m_contactBuffer.count;y++){var x=this.m_contactBuffer.data[y];if(x.flags&t.b2ParticleFlag.b2_tensileParticle){var S=x.indexA,A=x.indexB,C=x.weight,b=x.normal,T=this.m_weightBuffer[S]+this.m_weightBuffer[A],E=bt.SubVV(this.m_accumulation2Buffer[A],this.m_accumulation2Buffer[S],r),w=it(m*(T-2)+v*bt.DotVV(E,b),g)*C,P=bt.MulSV(w,b,o);a[S].SelfSub(P),a[A].SelfAdd(P)}}},r.SolveViscous=function(){for(var n=e.SolveViscous_s_v,i=e.SolveViscous_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.viscousStrength,s=this.GetParticleInvMass(),c=0;c<this.m_bodyContactBuffer.count;c++){var l=this.m_bodyContactBuffer.data[c],u=l.index;if(this.m_flagsBuffer.data[u]&t.b2ParticleFlag.b2_viscousParticle){var h=l.body,_=l.weight,f=l.mass,d=r[u],p=bt.SubVV(h.GetLinearVelocityFromWorldPoint(d,bt.s_t0),o[u],n),m=bt.MulSV(a*f*_,p,i);o[u].SelfMulAdd(s,m),h.ApplyLinearImpulse(m.SelfNeg(),d,!0)}}for(var v=0;v<this.m_contactBuffer.count;v++){var g=this.m_contactBuffer.data[v];if(g.flags&t.b2ParticleFlag.b2_viscousParticle){var y=g.indexA,x=g.indexB,S=g.weight,A=bt.SubVV(o[x],o[y],n),C=bt.MulSV(a*S,A,i);o[y].SelfAdd(C),o[x].SelfSub(C)}}},r.SolveRepulsive=function(n){for(var i=e.SolveRepulsive_s_f,r=this.m_velocityBuffer.data,o=this.m_def.repulsiveStrength*this.GetCriticalVelocity(n),a=0;a<this.m_contactBuffer.count;a++){var s=this.m_contactBuffer.data[a];if(s.flags&t.b2ParticleFlag.b2_repulsiveParticle){var c=s.indexA,l=s.indexB;if(this.m_groupBuffer[c]!==this.m_groupBuffer[l]){var u=s.weight,h=s.normal,_=bt.MulSV(o*u,h,i);r[c].SelfSub(_),r[l].SelfAdd(_)}}}},r.SolvePowder=function(n){for(var i=e.SolvePowder_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.powderStrength*this.GetCriticalVelocity(n),s=1-w,c=this.GetParticleInvMass(),l=0;l<this.m_bodyContactBuffer.count;l++){var u=this.m_bodyContactBuffer.data[l],h=u.index;if(this.m_flagsBuffer.data[h]&t.b2ParticleFlag.b2_powderParticle){var _=u.weight;if(_>s){var f=u.body,d=u.mass,p=r[h],m=u.normal,v=bt.MulSV(a*d*(_-s),m,i);o[h].SelfMulSub(c,v),f.ApplyLinearImpulse(v,p,!0)}}}for(var g=0;g<this.m_contactBuffer.count;g++){var y=this.m_contactBuffer.data[g];if(y.flags&t.b2ParticleFlag.b2_powderParticle){var x=y.weight;if(x>s){var S=y.indexA,A=y.indexB,C=y.normal,b=bt.MulSV(a*(x-s),C,i);o[S].SelfSub(b),o[A].SelfAdd(b)}}}},r.SolveSolid=function(t){var n=e.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);for(var r=t.inv_dt*this.m_def.ejectionStrength,o=0;o<this.m_contactBuffer.count;o++){var a=this.m_contactBuffer.data[o],s=a.indexA,c=a.indexB;if(this.m_groupBuffer[s]!==this.m_groupBuffer[c]){var l=a.weight,u=a.normal,h=this.m_depthBuffer[s]+this.m_depthBuffer[c],_=bt.MulSV(r*h*l,u,n);i[s].SelfSub(_),i[c].SelfAdd(_)}}},r.SolveForce=function(t){for(var e=this.m_velocityBuffer.data,n=t.dt*this.GetParticleInvMass(),i=0;i<this.m_count;i++)e[i].SelfMulAdd(n,this.m_forceBuffer[i]);this.m_hasForce=!1},r.SolveColorMixing=function(){var e=.5*this.m_def.colorMixingStrength;if(e)for(var n=0;n<this.m_contactBuffer.count;n++){var i=this.m_contactBuffer.data[n],r=i.indexA,o=i.indexB;if(this.m_flagsBuffer.data[r]&this.m_flagsBuffer.data[o]&t.b2ParticleFlag.b2_colorMixingParticle){var a=this.m_colorBuffer.data[r],s=this.m_colorBuffer.data[o];Bt.MixColors(a,s,e)}}},r.SolveZombie=function(){for(var e=0,n=[],i=0;i<this.m_count;i++)n[i]=T;for(var r=0,o=0;o<this.m_count;o++){var a=this.m_flagsBuffer.data[o];if(a&t.b2ParticleFlag.b2_zombieParticle){var s=this.m_world.m_destructionListener;if(a&t.b2ParticleFlag.b2_destructionListenerParticle&&s&&s.SayGoodbyeParticle(this,o),this.m_handleIndexBuffer.data){var c=this.m_handleIndexBuffer.data[o];c&&(c.SetIndex(T),this.m_handleIndexBuffer.data[o]=null)}n[o]=T}else{if(n[o]=e,o!==e){if(this.m_handleIndexBuffer.data){var l=this.m_handleIndexBuffer.data[o];l&&l.SetIndex(e),this.m_handleIndexBuffer.data[e]=l}this.m_flagsBuffer.data[e]=this.m_flagsBuffer.data[o],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=this.m_lastBodyContactStepBuffer.data[o]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=this.m_bodyContactCountBuffer.data[o]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=this.m_consecutiveContactStepsBuffer.data[o]),this.m_positionBuffer.data[e].Copy(this.m_positionBuffer.data[o]),this.m_velocityBuffer.data[e].Copy(this.m_velocityBuffer.data[o]),this.m_groupBuffer[e]=this.m_groupBuffer[o],this.m_hasForce&&this.m_forceBuffer[e].Copy(this.m_forceBuffer[o]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=this.m_staticPressureBuffer[o]),this.m_depthBuffer&&(this.m_depthBuffer[e]=this.m_depthBuffer[o]),this.m_colorBuffer.data&&this.m_colorBuffer.data[e].Copy(this.m_colorBuffer.data[o]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[e]=this.m_userDataBuffer.data[o]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[e]=this.m_expirationTimeBuffer.data[o])}e++,r|=a}}for(var u={IsProxyInvalid:function(t){return t.index<0},IsContactInvalid:function(t){return t.indexA<0||t.indexB<0},IsBodyContactInvalid:function(t){return t.index<0},IsPairInvalid:function(t){return t.indexA<0||t.indexB<0},IsTriadInvalid:function(t){return t.indexA<0||t.indexB<0||t.indexC<0}},h=0;h<this.m_proxyBuffer.count;h++){var _=this.m_proxyBuffer.data[h];_.index=n[_.index]}this.m_proxyBuffer.RemoveIf(u.IsProxyInvalid);for(var f=0;f<this.m_contactBuffer.count;f++){var d=this.m_contactBuffer.data[f];d.indexA=n[d.indexA],d.indexB=n[d.indexB]}this.m_contactBuffer.RemoveIf(u.IsContactInvalid);for(var p=0;p<this.m_bodyContactBuffer.count;p++){var m=this.m_bodyContactBuffer.data[p];m.index=n[m.index]}this.m_bodyContactBuffer.RemoveIf(u.IsBodyContactInvalid);for(var v=0;v<this.m_pairBuffer.count;v++){var g=this.m_pairBuffer.data[v];g.indexA=n[g.indexA],g.indexB=n[g.indexB]}this.m_pairBuffer.RemoveIf(u.IsPairInvalid);for(var y=0;y<this.m_triadBuffer.count;y++){var x=this.m_triadBuffer.data[y];x.indexA=n[x.indexA],x.indexB=n[x.indexB],x.indexC=n[x.indexC]}if(this.m_triadBuffer.RemoveIf(u.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data)for(var S=0,A=0;A<this.m_count;A++){var C=n[this.m_indexByExpirationTimeBuffer.data[A]];C!==T&&(this.m_indexByExpirationTimeBuffer.data[S++]=C)}for(var b=this.m_groupList;b;b=b.GetNext()){for(var E=e,w=0,P=!1,I=b.m_firstIndex;I<b.m_lastIndex;I++){var R=n[I];R>=0?(E=it(E,R),w=rt(w,R+1)):P=!0}E<w?(b.m_firstIndex=E,b.m_lastIndex=w,P&&b.m_groupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(b,b.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(b.m_firstIndex=0,b.m_lastIndex=0,b.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(b,b.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=e,this.m_allParticleFlags=r,this.m_needsUpdateAllParticleFlags=!1;for(var D=this.m_groupList;D;){var M=D.GetNext();D.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(D),D=M}},r.SolveLifetimes=function(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);var e=this.GetQuantizedTimeElapsed(),n=this.m_expirationTimeBuffer.data,i=this.m_indexByExpirationTimeBuffer.data,r=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(Ur(i,0,r,(function(t,e){var i=n[t],r=n[e],o=i<=0;return o===r<=0?i>r:o})),this.m_expirationTimeBufferRequiresSorting=!1);for(var o=r-1;o>=0;--o){var a=i[o],s=n[a];if(e<s||s<=0)break;this.DestroyParticle(a)}},r.RotateBuffer=function(t,e,n){if(t!==e&&e!==n){if(Xr(this.m_flagsBuffer.data,t,e,n),this.m_lastBodyContactStepBuffer.data&&Xr(this.m_lastBodyContactStepBuffer.data,t,e,n),this.m_bodyContactCountBuffer.data&&Xr(this.m_bodyContactCountBuffer.data,t,e,n),this.m_consecutiveContactStepsBuffer.data&&Xr(this.m_consecutiveContactStepsBuffer.data,t,e,n),Xr(this.m_positionBuffer.data,t,e,n),Xr(this.m_velocityBuffer.data,t,e,n),Xr(this.m_groupBuffer,t,e,n),this.m_hasForce&&Xr(this.m_forceBuffer,t,e,n),this.m_staticPressureBuffer&&Xr(this.m_staticPressureBuffer,t,e,n),this.m_depthBuffer&&Xr(this.m_depthBuffer,t,e,n),this.m_colorBuffer.data&&Xr(this.m_colorBuffer.data,t,e,n),this.m_userDataBuffer.data&&Xr(this.m_userDataBuffer.data,t,e,n),this.m_handleIndexBuffer.data){Xr(this.m_handleIndexBuffer.data,t,e,n);for(var i=t;i<n;++i){var r=this.m_handleIndexBuffer.data[i];r&&r.SetIndex(y(r.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Xr(this.m_expirationTimeBuffer.data,t,e,n);for(var o=this.GetParticleCount(),a=this.m_indexByExpirationTimeBuffer.data,s=0;s<o;++s)a[s]=y(a[s])}for(var c=0;c<this.m_proxyBuffer.count;c++){var l=this.m_proxyBuffer.data[c];l.index=y(l.index)}for(var u=0;u<this.m_contactBuffer.count;u++){var h=this.m_contactBuffer.data[u];h.indexA=y(h.indexA),h.indexB=y(h.indexB)}for(var _=0;_<this.m_bodyContactBuffer.count;_++){var f=this.m_bodyContactBuffer.data[_];f.index=y(f.index)}for(var d=0;d<this.m_pairBuffer.count;d++){var p=this.m_pairBuffer.data[d];p.indexA=y(p.indexA),p.indexB=y(p.indexB)}for(var m=0;m<this.m_triadBuffer.count;m++){var v=this.m_triadBuffer.data[m];v.indexA=y(v.indexA),v.indexB=y(v.indexB),v.indexC=y(v.indexC)}for(var g=this.m_groupList;g;g=g.GetNext())g.m_firstIndex=y(g.m_firstIndex),g.m_lastIndex=y(g.m_lastIndex-1)+1}function y(i){return i<t?i:i<e?i+n-e:i<n?i+t-e:i}},r.GetCriticalVelocity=function(t){return this.m_particleDiameter*t.inv_dt},r.GetCriticalVelocitySquared=function(t){var e=this.GetCriticalVelocity(t);return e*e},r.GetCriticalPressure=function(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)},r.GetParticleStride=function(){return w*this.m_particleDiameter},r.GetParticleMass=function(){var t=this.GetParticleStride();return this.m_def.density*t*t},r.GetParticleInvMass=function(){var t=this.m_inverseDiameter*(1/w);return this.m_inverseDensity*t*t},r.GetFixtureContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},r.GetParticleContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},r.GetFixtureContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},r.GetParticleContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},r.SetUserOverridableBuffer=function(t,e){t.data=e,t.userSuppliedCapacity=e.length},r.SetGroupFlags=function(e,n){var i=e.m_groupFlags;(i^n)&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(n|=t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),i&~n&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&n&&(n&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=n),e.m_groupFlags=n},e.BodyContactCompare=function(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index},r.RemoveSpuriousBodyContacts=function(){Ur(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,e.BodyContactCompare);var t=e.RemoveSpuriousBodyContacts_s_n,n=e.RemoveSpuriousBodyContacts_s_pos,i=e.RemoveSpuriousBodyContacts_s_normal,r=3,o=this,a=-1,s=0,c=function(e){if(e.index!==a&&(s=0,a=e.index),s++>r)return!0;var c=t.Copy(e.normal);c.SelfMul(o.m_particleDiameter*(1-e.weight));var l=bt.AddVV(o.m_positionBuffer.data[e.index],c,n);if(!e.fixture.TestPoint(l)){for(var u=e.fixture.GetShape().GetChildCount(),_=0;_<u;_++){var f=i;if(e.fixture.ComputeDistance(l,f,_)<h)return!1}return!0}return!1};this.m_bodyContactBuffer.count=jr(this.m_bodyContactBuffer.data,c,this.m_bodyContactBuffer.count)},r.DetectStuckParticle=function(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)},r.ValidateParticleIndex=function(t){return t>=0&&t<this.GetParticleCount()&&t!==T},r.GetQuantizedTimeElapsed=function(){return Math.floor(this.m_timeElapsed/4294967296)},r.LifetimeToExpirationTime=function(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)},r.ForceCanBeApplied=function(e){return!(e&t.b2ParticleFlag.b2_wallParticle)},r.PrepareForceBuffer=function(){if(!this.m_hasForce){for(var t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}},r.IsRigidGroup=function(e){return null!==e&&0!=(e.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},r.GetLinearVelocity=function(t,e,n,i){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(n,i):i.Copy(this.m_velocityBuffer.data[e])},r.InitDampingParameter=function(t,e,n,i,r,o,a,s){t[0]=i>0?1/i:0,e[0]=r>0?1/r:0,n[0]=bt.CrossVV(bt.SubVV(a,o,bt.s_t0),s)},r.InitDampingParameterWithRigidGroupOrParticle=function(e,n,i,r,o,a,s,c){if(o&&r)this.InitDampingParameter(e,n,i,o.GetMass(),o.GetInertia(),o.GetCenter(),s,c);else{var l=this.m_flagsBuffer.data[a];this.InitDampingParameter(e,n,i,l&t.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,s,s,c)}},r.ComputeDampingImpulse=function(t,e,n,i,r,o,a){var s=t+e*n*n+i+r*o*o;return s>0?a/s:0},r.ApplyDamping=function(t,e,n,i,r,o,a,s){r&&i?(r.m_linearVelocity.SelfMulAdd(a*t,s),r.m_angularVelocity+=a*n*e):this.m_velocityBuffer.data[o].SelfMulAdd(a*t,s)},e}();no.xTruncBits=12,no.yTruncBits=12,no.tagBits=32,no.yOffset=1<<no.yTruncBits-1,no.yShift=no.tagBits-no.yTruncBits,no.xShift=no.tagBits-no.yTruncBits-no.xTruncBits,no.xScale=1<<no.xShift,no.xOffset=no.xScale*(1<<no.xTruncBits-1),no.yMask=(1<<no.yTruncBits)-1<<no.yShift,no.xMask=~no.yMask,no.DestroyParticlesInShape_s_aabb=new Te,no.CreateParticleGroup_s_transform=new Rt,no.ComputeCollisionEnergy_s_v=new bt,no.QueryShapeAABB_s_aabb=new Te,no.QueryPointAABB_s_aabb=new Te,no.RayCast_s_aabb=new Te,no.RayCast_s_p=new bt,no.RayCast_s_v=new bt,no.RayCast_s_n=new bt,no.RayCast_s_point=new bt,no.k_pairFlags=t.b2ParticleFlag.b2_springParticle,no.k_triadFlags=t.b2ParticleFlag.b2_elasticParticle,no.k_noPressureFlags=t.b2ParticleFlag.b2_powderParticle|t.b2ParticleFlag.b2_tensileParticle,no.k_extraDampingFlags=t.b2ParticleFlag.b2_staticPressureParticle,no.k_barrierWallFlags=t.b2ParticleFlag.b2_barrierParticle|t.b2ParticleFlag.b2_wallParticle,no.CreateParticlesStrokeShapeForGroup_s_edge=new ui,no.CreateParticlesStrokeShapeForGroup_s_d=new bt,no.CreateParticlesStrokeShapeForGroup_s_p=new bt,no.CreateParticlesFillShapeForGroup_s_aabb=new Te,no.CreateParticlesFillShapeForGroup_s_p=new bt,no.UpdatePairsAndTriads_s_dab=new bt,no.UpdatePairsAndTriads_s_dbc=new bt,no.UpdatePairsAndTriads_s_dca=new bt,no.AddContact_s_d=new bt,no.UpdateBodyContacts_s_aabb=new Te,no.Solve_s_subStep=new vr,no.SolveCollision_s_aabb=new Te,no.SolveGravity_s_gravity=new bt,no.SolveBarrier_s_aabb=new Te,no.SolveBarrier_s_va=new bt,no.SolveBarrier_s_vb=new bt,no.SolveBarrier_s_pba=new bt,no.SolveBarrier_s_vba=new bt,no.SolveBarrier_s_vc=new bt,no.SolveBarrier_s_pca=new bt,no.SolveBarrier_s_vca=new bt,no.SolveBarrier_s_qba=new bt,no.SolveBarrier_s_qca=new bt,no.SolveBarrier_s_dv=new bt,no.SolveBarrier_s_f=new bt,no.SolvePressure_s_f=new bt,no.SolveDamping_s_v=new bt,no.SolveDamping_s_f=new bt,no.SolveRigidDamping_s_t0=new bt,no.SolveRigidDamping_s_t1=new bt,no.SolveRigidDamping_s_p=new bt,no.SolveRigidDamping_s_v=new bt,no.SolveExtraDamping_s_v=new bt,no.SolveExtraDamping_s_f=new bt,no.SolveRigid_s_position=new bt,no.SolveRigid_s_rotation=new It,no.SolveRigid_s_transform=new Rt,no.SolveRigid_s_velocityTransform=new Rt,no.SolveElastic_s_pa=new bt,no.SolveElastic_s_pb=new bt,no.SolveElastic_s_pc=new bt,no.SolveElastic_s_r=new It,no.SolveElastic_s_t0=new bt,no.SolveSpring_s_pa=new bt,no.SolveSpring_s_pb=new bt,no.SolveSpring_s_d=new bt,no.SolveSpring_s_f=new bt,no.SolveTensile_s_weightedNormal=new bt,no.SolveTensile_s_s=new bt,no.SolveTensile_s_f=new bt,no.SolveViscous_s_v=new bt,no.SolveViscous_s_f=new bt,no.SolveRepulsive_s_f=new bt,no.SolvePowder_s_f=new bt,no.SolveSolid_s_f=new bt,no.RemoveSpuriousBodyContacts_s_n=new bt,no.RemoveSpuriousBodyContacts_s_pos=new bt,no.RemoveSpuriousBodyContacts_s_normal=new bt;var io=function(){function t(){this._data=null,this.userSuppliedCapacity=0}return K(t,[{key:"data",get:function(){return this._data},set:function(t){this._data=t}}]),t}(),ro=function(){function t(){this.index=T,this.tag=0}return t.CompareProxyProxy=function(t,e){return t.tag<e.tag},t.CompareTagProxy=function(t,e){return t<e.tag},t.CompareProxyTag=function(t,e){return t.tag<e},t}(),oo=function(){function t(t,e,n,i,r){this.m_system=t,this.m_xLower=(e&no.xMask)>>>0,this.m_xUpper=(n&no.xMask)>>>0,this.m_yLower=(e&no.yMask)>>>0,this.m_yUpper=(n&no.yMask)>>>0,this.m_first=i,this.m_last=r}return t.prototype.GetNext=function(){for(;this.m_first<this.m_last;){var t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&no.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return T},t}(),ao=function(){this.next=null,this.count=0,this.index=0},so=function(){function t(){}var e=t.prototype;return e.Allocate=function(t,e){return e},e.Clear=function(){},e.GetCount=function(){return 0},e.Invalidate=function(){},e.GetValidBuffer=function(){return[]},e.GetBuffer=function(){return[]},e.SetCount=function(){},t}(),co=function(t,e){this.second=T,this.first=t,this.second=e},lo=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.Initialize=function(){},n.Find=function(){return T},e}(so),uo=function(t,e){this.first=T,this.second=T,this.first=t,this.second=e},ho=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.Initialize=function(){},n.Find=function(){return T},e}(so),_o=function(){function t(){}var e=t.prototype;return e.IsNecessary=function(){return!0},e.ShouldCreatePair=function(){return!0},e.ShouldCreateTriad=function(){return!0},t}(),fo=function(t){function e(e,n,i,r){var o;return(o=t.call(this)||this).m_callDestructionListener=!1,o.m_destroyed=0,o.m_system=e,o.m_shape=n,o.m_xf=i,o.m_callDestructionListener=r,o.m_destroyed=0,o}Q(e,t);var n=e.prototype;return n.ReportFixture=function(){return!1},n.ReportParticle=function(t,e){return t===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)},n.Destroyed=function(){return this.m_destroyed},e}(fr),po=function(t){function e(e){var n;return(n=t.call(this)||this).m_threshold=0,n.m_threshold=e,n}Q(e,t);var n=e.prototype;return n.ShouldCreatePair=function(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t},n.ShouldCreateTriad=function(t,e,n){return(t<this.m_threshold||e<this.m_threshold||n<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=n)},e}(_o),mo=function(e){function n(n,i){var r;return void 0===i&&(i=n.length),(r=e.call(this,t.b2ShapeType.e_unknown,0)||this).m_shapeCount=0,r.m_shapes=n,r.m_shapeCount=i,r}Q(n,e);var r=n.prototype;return r.Clone=function(){throw new Error},r.GetChildCount=function(){return 1},r.TestPoint=function(t,e){for(var n=0;n<this.m_shapeCount;n++)if(this.m_shapes[n].TestPoint(t,e))return!0;return!1},r.ComputeDistance=function(){return 0},r.RayCast=function(){return!1},r.ComputeAABB=function(t,e){var n=new Te;t.lowerBound.x=+i,t.lowerBound.y=+i,t.upperBound.x=-i,t.upperBound.y=-i;for(var r=0;r<this.m_shapeCount;r++)for(var o=this.m_shapes[r].GetChildCount(),a=0;a<o;a++){var s=n;this.m_shapes[r].ComputeAABB(s,e,a),t.Combine1(s)}},r.ComputeMass=function(){},r.SetupDistanceProxy=function(){},r.ComputeSubmergedArea=function(){return 0},r.Dump=function(){},n}(si),vo=function(e){function n(t){var n;return(n=e.call(this)||this).m_flagsBuffer=t,n}return Q(n,e),n.prototype.IsNecessary=function(e){return 0!=(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_reactiveParticle)},n}(_o),go=function(e){function n(t,n){var i;return void 0===n&&(n=null),(i=e.call(this,t)||this).m_contactFilter=null,i.m_contactFilter=n,i}Q(n,e);var i=n.prototype;return i.ShouldCollideFixtureParticle=function(e,n,i){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[i]&t.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(e,this.m_system,i)},i.ReportFixtureAndParticle=function(e,i,r){var o=n.ReportFixtureAndParticle_s_n,a=n.ReportFixtureAndParticle_s_rp,s=this.m_system.m_positionBuffer.data[r],c=o,l=e.ComputeDistance(s,c,i);if(l<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(e,this.m_system,r)){var u=e.GetBody(),h=u.GetWorldCenter(),_=u.GetMass(),f=u.GetInertia()-_*u.GetLocalCenter().LengthSquared(),d=_>0?1/_:0,p=f>0?1/f:0,m=this.m_system.m_flagsBuffer.data[r]&t.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),v=bt.SubVV(s,h,a),g=bt.CrossVV(v,c),y=m+d+p*g*g,x=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];x.index=r,x.body=u,x.fixture=e,x.weight=1-l*this.m_system.m_inverseDiameter,x.normal.Copy(c.SelfNeg()),x.mass=y>0?1/y:0,this.m_system.DetectStuckParticle(r)}},n}(Jr);go.ReportFixtureAndParticle_s_n=new bt,go.ReportFixtureAndParticle_s_rp=new bt;var yo=function(e){function n(t,n){var i;return(i=e.call(this,t)||this).m_step=n,i}Q(n,e);var i=n.prototype;return i.ReportFixtureAndParticle=function(e,i,r){var o=n.ReportFixtureAndParticle_s_p1,a=n.ReportFixtureAndParticle_s_output,s=n.ReportFixtureAndParticle_s_input,c=n.ReportFixtureAndParticle_s_p,l=n.ReportFixtureAndParticle_s_v,u=n.ReportFixtureAndParticle_s_f,_=e.GetBody(),f=this.m_system.m_positionBuffer.data[r],d=this.m_system.m_velocityBuffer.data[r],p=a,m=s;if(0===this.m_system.m_iterationIndex){var v=Rt.MulTXV(_.m_xf0,f,o);e.GetShape().GetType()===t.b2ShapeType.e_circleShape&&(v.SelfSub(_.GetLocalCenter()),It.MulRV(_.m_xf0.q,v,v),It.MulTRV(_.m_xf.q,v,v),v.SelfAdd(_.GetLocalCenter())),Rt.MulXV(_.m_xf,v,m.p1)}else m.p1.Copy(f);if(bt.AddVMulSV(f,this.m_step.dt,d,m.p2),m.maxFraction=1,e.RayCast(p,m,i)){var g=p.normal,y=c;y.x=(1-p.fraction)*m.p1.x+p.fraction*m.p2.x+h*g.x,y.y=(1-p.fraction)*m.p1.y+p.fraction*m.p2.y+h*g.y;var x=l;x.x=this.m_step.inv_dt*(y.x-f.x),x.y=this.m_step.inv_dt*(y.y-f.y),this.m_system.m_velocityBuffer.data[r].Copy(x);var S=u;S.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(d.x-x.x),S.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(d.y-x.y),this.m_system.ParticleApplyForce(r,S)}},i.ReportParticle=function(){return!1},n}(Jr);yo.ReportFixtureAndParticle_s_p1=new bt,yo.ReportFixtureAndParticle_s_output=new be,yo.ReportFixtureAndParticle_s_input=new Ce,yo.ReportFixtureAndParticle_s_p=new bt,yo.ReportFixtureAndParticle_s_v=new bt,yo.ReportFixtureAndParticle_s_f=new bt;var xo=function(){function e(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new pr,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new bt,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new mr,this.m_island=new Ir,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}var n=e.prototype;return n.SetDestructionListener=function(t){this.m_destructionListener=t},n.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},n.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},n.SetDebugDraw=function(t){this.m_debugDraw=t},n.CreateBody=function(t){if(void 0===t&&(t={}),this.IsLocked())throw new Error;var e=new xi(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},n.DestroyBody=function(t){if(this.IsLocked())throw new Error;for(var e=t.m_jointList;e;){var n=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(n.joint),this.DestroyJoint(n.joint),t.m_jointList=e}t.m_jointList=null;for(var i=t.m_controllerList;i;){var r=i;i=i.nextController,r.controller.RemoveBody(t)}for(var o=t.m_contactList;o;){var a=o;o=o.next,this.m_contactManager.Destroy(a.contact)}t.m_contactList=null;for(var s=t.m_fixtureList;s;){var c=s;s=s.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(c),c.DestroyProxies(),c.Reset(),t.m_fixtureList=s,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount},e._Joint_Create=function(e){switch(e.type){case t.b2JointType.e_distanceJoint:return new Ei(e);case t.b2JointType.e_mouseJoint:return new Li(e);case t.b2JointType.e_prismaticJoint:return new zi(e);case t.b2JointType.e_revoluteJoint:return new Hi(e);case t.b2JointType.e_pulleyJoint:return new Gi(e);case t.b2JointType.e_gearJoint:return new Mi(e);case t.b2JointType.e_wheelJoint:return new Ki(e);case t.b2JointType.e_weldJoint:return new Xi(e);case t.b2JointType.e_frictionJoint:return new Ri(e);case t.b2JointType.e_ropeJoint:return new Wi(e);case t.b2JointType.e_motorJoint:return new Oi(e);case t.b2JointType.e_areaJoint:return new Pi(e)}throw new Error},e._Joint_Destroy=function(){},n.CreateJoint=function(t){if(this.IsLocked())throw new Error;var n=e._Joint_Create(t);n.m_prev=null,n.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=n),this.m_jointList=n,++this.m_jointCount,n.m_edgeA.prev=null,n.m_edgeA.next=n.m_bodyA.m_jointList,n.m_bodyA.m_jointList&&(n.m_bodyA.m_jointList.prev=n.m_edgeA),n.m_bodyA.m_jointList=n.m_edgeA,n.m_edgeB.prev=null,n.m_edgeB.next=n.m_bodyB.m_jointList,n.m_bodyB.m_jointList&&(n.m_bodyB.m_jointList.prev=n.m_edgeB),n.m_bodyB.m_jointList=n.m_edgeB;var i=n.m_bodyA,r=n.m_bodyB;if(!n.m_collideConnected)for(var o=r.GetContactList();o;)o.other===i&&o.contact.FlagForFiltering(),o=o.next;return n},n.DestroyJoint=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);var n=t.m_bodyA,i=t.m_bodyB,r=t.m_collideConnected;if(n.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===n.m_jointList&&(n.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),e._Joint_Destroy(t),--this.m_jointCount,!r)for(var o=i.GetContactList();o;)o.other===n&&o.contact.FlagForFiltering(),o=o.next},n.CreateParticleSystem=function(t){if(this.IsLocked())throw new Error;var e=new no(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e},n.DestroyParticleSystem=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)},n.CalculateReasonableParticleIterations=function(t){if(null===this.m_particleSystemList)return 1;function e(t){for(var e=i,n=t.GetParticleSystemList();null!==n;n=n.m_next)e=it(e,n.GetRadius());return e}return Dr(this.m_gravity.Length(),e(this),t)},n.Step=function(t,n,i,r){void 0===r&&(r=this.CalculateReasonableParticleIterations(t));var o=e.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;var a=e.Step_s_step;a.dt=t,a.velocityIterations=n,a.positionIterations=i,a.particleIterations=r,a.inv_dt=t>0?1/t:0,a.dtRatio=this.m_inv_dt0*t,a.warmStarting=this.m_warmStarting;var s=e.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=s.GetMilliseconds(),this.m_stepComplete&&a.dt>0){for(var c=e.Step_s_timer.Reset(),l=this.m_particleSystemList;l;l=l.m_next)l.Solve(a);this.Solve(a),this.m_profile.solve=c.GetMilliseconds()}if(this.m_continuousPhysics&&a.dt>0){var u=e.Step_s_timer.Reset();this.SolveTOI(a),this.m_profile.solveTOI=u.GetMilliseconds()}a.dt>0&&(this.m_inv_dt0=a.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=o.GetMilliseconds()},n.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},n.DrawParticleSystem=function(t){if(null!==this.m_debugDraw){var e=t.GetParticleCount();if(e){var n=t.GetRadius(),i=t.GetPositionBuffer();if(t.m_colorBuffer.data){var r=t.GetColorBuffer();this.m_debugDraw.DrawParticles(i,n,r,e)}else this.m_debugDraw.DrawParticles(i,n,null,e)}}},n.DrawDebugData=function(){if(null!==this.m_debugDraw){var n=this.m_debugDraw.GetFlags(),i=e.DrawDebugData_s_color.SetRGB(0,0,0);if(n&t.b2DrawFlags.e_shapeBit)for(var r=this.m_bodyList;r;r=r.m_next){var o=r.m_xf;this.m_debugDraw.PushTransform(o);for(var a=r.GetFixtureList();a;a=a.m_next)r.IsActive()?r.GetType()===t.b2BodyType.b2_staticBody?(i.SetRGB(.5,.9,.5),this.DrawShape(a,i)):r.GetType()===t.b2BodyType.b2_kinematicBody?(i.SetRGB(.5,.5,.9),this.DrawShape(a,i)):r.IsAwake()?(i.SetRGB(.9,.7,.7),this.DrawShape(a,i)):(i.SetRGB(.6,.6,.6),this.DrawShape(a,i)):(i.SetRGB(.5,.5,.3),this.DrawShape(a,i));this.m_debugDraw.PopTransform(o)}if(n&t.b2DrawFlags.e_particleBit)for(var s=this.m_particleSystemList;s;s=s.m_next)this.DrawParticleSystem(s);if(n&t.b2DrawFlags.e_jointBit)for(var c=this.m_jointList;c;c=c.m_next)this.DrawJoint(c);if(n&t.b2DrawFlags.e_aabbBit){i.SetRGB(.9,.3,.9);for(var l=e.DrawDebugData_s_vs,u=this.m_bodyList;u;u=u.m_next)if(u.IsActive())for(var h=u.GetFixtureList();h;h=h.m_next)for(var _=0;_<h.m_proxyCount;++_){var f=h.m_proxies[_].treeNode.aabb;l[0].Set(f.lowerBound.x,f.lowerBound.y),l[1].Set(f.upperBound.x,f.lowerBound.y),l[2].Set(f.upperBound.x,f.upperBound.y),l[3].Set(f.lowerBound.x,f.upperBound.y),this.m_debugDraw.DrawPolygon(l,4,i)}}if(n&t.b2DrawFlags.e_centerOfMassBit)for(var d=this.m_bodyList;d;d=d.m_next){var p=e.DrawDebugData_s_xf;p.q.Copy(d.m_xf.q),p.p.Copy(d.GetWorldCenter()),this.m_debugDraw.DrawTransform(p)}if(n&t.b2DrawFlags.e_controllerBit)for(var m=this.m_controllerList;m;m=m.m_next)m.Draw(this.m_debugDraw)}},n.QueryAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryAABB=function(t,e,n){if(this.m_contactManager.m_broadPhase.Query(e,(function(e){var i=e.userData.fixture;return t?t.ReportFixture(i):!n||n(i)})),t instanceof fr)for(var i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryAABB(t,e)},n.QueryAllAABB=function(t,e){return void 0===e&&(e=[]),this.QueryAABB(t,(function(t){return e.push(t),!0})),e},n.QueryPointAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryPointAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryPointAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryPointAABB=function(t,e,n){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(e){var i=e.userData.fixture;return t?t.ReportFixture(i):!n||n(i)})),t instanceof fr)for(var i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)},n.QueryAllPointAABB=function(t,e){return void 0===e&&(e=[]),this.QueryPointAABB(t,(function(t){return e.push(t),!0})),e},n.QueryFixtureShape=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryFixtureShape(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3]):this._QueryFixtureShape(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3])},n._QueryFixtureShape=function(t,n,i,r,o){var a=e.QueryFixtureShape_s_aabb;if(n.ComputeAABB(a,r,i),this.m_contactManager.m_broadPhase.Query(a,(function(e){var a=e.userData,s=a.fixture;if(De(n,i,s.GetShape(),a.childIndex,r,s.GetBody().GetTransform())){if(t)return t.ReportFixture(s);if(o)return o(s)}return!0})),t instanceof fr)for(var s=this.m_particleSystemList;s;s=s.m_next)t.ShouldQueryParticleSystem(s)&&s.QueryAABB(t,a)},n.QueryAllFixtureShape=function(t,e,n,i){return void 0===i&&(i=[]),this.QueryFixtureShape(t,e,n,(function(t){return i.push(t),!0})),i},n.QueryFixturePoint=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryFixturePoint(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryFixturePoint(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryFixturePoint=function(t,e,n){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(i){var r=i.userData.fixture;if(r.TestPoint(e)){if(t)return t.ReportFixture(r);if(n)return n(r)}return!0})),t)for(var i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)},n.QueryAllFixturePoint=function(t,e){return void 0===e&&(e=[]),this.QueryFixturePoint(t,(function(t){return e.push(t),!0})),e},n.RayCast=function(){(arguments.length<=0?void 0:arguments[0])instanceof dr?this._RayCast(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2]):this._RayCast(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2])},n._RayCast=function(t,n,i,r){var o=e.RayCast_s_input;if(o.maxFraction=1,o.p1.Copy(n),o.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(o,(function(o,a){var s=a.userData,c=s.fixture,l=s.childIndex,u=e.RayCast_s_output;if(c.RayCast(u,o,l)){var h=u.fraction,_=e.RayCast_s_point;if(_.Set((1-h)*n.x+h*i.x,(1-h)*n.y+h*i.y),t)return t.ReportFixture(c,_,u.normal,h);if(r)return r(c,_,u.normal,h)}return o.maxFraction})),t)for(var a=this.m_particleSystemList;a;a=a.m_next)t.ShouldQueryParticleSystem(a)&&a.RayCast(t,n,i)},n.RayCastOne=function(t,e){var n=null,i=1;return this.RayCast(t,e,(function(t,e,r,o){return o<i&&(i=o,n=t),i})),n},n.RayCastAll=function(t,e,n){return void 0===n&&(n=[]),this.RayCast(t,e,(function(t){return n.push(t),1})),n},n.GetBodyList=function(){return this.m_bodyList},n.GetJointList=function(){return this.m_jointList},n.GetParticleSystemList=function(){return this.m_particleSystemList},n.GetContactList=function(){return this.m_contactManager.m_contactList},n.SetAllowSleeping=function(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(var e=this.m_bodyList;e;e=e.m_next)e.SetAwake(!0)},n.GetAllowSleeping=function(){return this.m_allowSleep},n.SetWarmStarting=function(t){this.m_warmStarting=t},n.GetWarmStarting=function(){return this.m_warmStarting},n.SetContinuousPhysics=function(t){this.m_continuousPhysics=t},n.GetContinuousPhysics=function(){return this.m_continuousPhysics},n.SetSubStepping=function(t){this.m_subStepping=t},n.GetSubStepping=function(){return this.m_subStepping},n.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},n.GetBodyCount=function(){return this.m_bodyCount},n.GetJointCount=function(){return this.m_jointCount},n.GetContactCount=function(){return this.m_contactManager.m_contactCount},n.GetTreeHeight=function(){return this.m_contactManager.m_broadPhase.GetTreeHeight()},n.GetTreeBalance=function(){return this.m_contactManager.m_broadPhase.GetTreeBalance()},n.GetTreeQuality=function(){return this.m_contactManager.m_broadPhase.GetTreeQuality()},n.SetGravity=function(t,e){if(void 0===e&&(e=!0),!bt.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(var n=this.m_bodyList;n;n=n.m_next)n.SetAwake(!0)},n.GetGravity=function(){return this.m_gravity},n.IsLocked=function(){return this.m_locked},n.SetAutoClearForces=function(t){this.m_clearForces=t},n.GetAutoClearForces=function(){return this.m_clearForces},n.ShiftOrigin=function(t){if(this.IsLocked())throw new Error;for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(var n=this.m_jointList;n;n=n.m_next)n.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)},n.GetContactManager=function(){return this.m_contactManager},n.GetProfile=function(){return this.m_profile},n.Dump=function(e){if(!this.m_locked){e("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),e("this.m_world.SetGravity(g);\n"),e("const bodies: b2Body[] = [];\n"),e("const joints: b2Joint[] = [];\n");for(var n=0,i=this.m_bodyList;i;i=i.m_next)i.m_islandIndex=n,i.Dump(e),++n;n=0;for(var r=this.m_jointList;r;r=r.m_next)r.m_index=n,++n;for(var o=this.m_jointList;o;o=o.m_next)o.m_type!==t.b2JointType.e_gearJoint&&(e("{\n"),o.Dump(e),e("}\n"));for(var a=this.m_jointList;a;a=a.m_next)a.m_type===t.b2JointType.e_gearJoint&&(e("{\n"),a.Dump(e),e("}\n"))}},n.DrawJoint=function(n){if(null!==this.m_debugDraw){var i=n.GetBodyA(),r=n.GetBodyB(),o=i.m_xf,a=r.m_xf,s=o.p,c=a.p,l=n.GetAnchorA(e.DrawJoint_s_p1),u=n.GetAnchorB(e.DrawJoint_s_p2),h=e.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(n.m_type){case t.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(l,u,h);break;case t.b2JointType.e_pulleyJoint:var _=n,f=_.GetGroundAnchorA(),d=_.GetGroundAnchorB();this.m_debugDraw.DrawSegment(f,l,h),this.m_debugDraw.DrawSegment(d,u,h),this.m_debugDraw.DrawSegment(f,d,h);break;case t.b2JointType.e_mouseJoint:var p=e.DrawJoint_s_c;p.Set(0,1,0),this.m_debugDraw.DrawPoint(l,4,p),this.m_debugDraw.DrawPoint(u,4,p),p.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(l,u,p);break;default:this.m_debugDraw.DrawSegment(s,l,h),this.m_debugDraw.DrawSegment(l,u,h),this.m_debugDraw.DrawSegment(c,u,h)}}},n.DrawShape=function(n,i){if(null!==this.m_debugDraw){var r=n.GetShape();switch(r.m_type){case t.b2ShapeType.e_circleShape:var o=r,a=o.m_p,s=o.m_radius,c=bt.UNITX;this.m_debugDraw.DrawSolidCircle(a,s,c,i);break;case t.b2ShapeType.e_edgeShape:var l=r,u=l.m_vertex1,h=l.m_vertex2;this.m_debugDraw.DrawSegment(u,h,i);break;case t.b2ShapeType.e_chainShape:var _=r,f=_.m_count,d=_.m_vertices,p=e.DrawShape_s_ghostColor.SetRGBA(.75*i.r,.75*i.g,.75*i.b,i.a),m=d[0];if(this.m_debugDraw.DrawPoint(m,4,i),_.m_hasPrevVertex){var v=_.m_prevVertex;this.m_debugDraw.DrawSegment(v,m,p),this.m_debugDraw.DrawCircle(v,.1,p)}for(var g=1;g<f;++g){var y=d[g];this.m_debugDraw.DrawSegment(m,y,i),this.m_debugDraw.DrawPoint(y,4,i),m=y}if(_.m_hasNextVertex){var x=_.m_nextVertex;this.m_debugDraw.DrawSegment(x,m,p),this.m_debugDraw.DrawCircle(x,.1,p)}break;case t.b2ShapeType.e_polygonShape:var S=r,A=S.m_count,C=S.m_vertices;this.m_debugDraw.DrawSolidPolygon(C,A,i)}}},n.Solve=function(e){for(var n=this.m_bodyList;n;n=n.m_next)n.m_xf0.Copy(n.m_xf);for(var i=this.m_controllerList;i;i=i.m_next)i.Step(e);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;var r=this.m_island;r.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_islandFlag=!1;for(var s=this.m_jointList;s;s=s.m_next)s.m_islandFlag=!1;for(var c=this.s_stack,l=this.m_bodyList;l;l=l.m_next)if(!l.m_islandFlag&&l.IsAwake()&&l.IsActive()&&l.GetType()!==t.b2BodyType.b2_staticBody){r.Clear();var u=0;for(c[u++]=l,l.m_islandFlag=!0;u>0;){var h=c[--u];if(!h)throw new Error;if(r.AddBody(h),h.m_awakeFlag=!0,h.GetType()!==t.b2BodyType.b2_staticBody){for(var _=h.m_contactList;_;_=_.next){var f=_.contact;if(!f.m_islandFlag&&f.IsEnabled()&&f.IsTouching()){var d=f.m_fixtureA.m_isSensor,p=f.m_fixtureB.m_isSensor;if(!d&&!p){r.AddContact(f),f.m_islandFlag=!0;var m=_.other;m.m_islandFlag||(c[u++]=m,m.m_islandFlag=!0)}}}for(var v=h.m_jointList;v;v=v.next)if(!v.joint.m_islandFlag){var g=v.other;g.IsActive()&&(r.AddJoint(v.joint),v.joint.m_islandFlag=!0,g.m_islandFlag||(c[u++]=g,g.m_islandFlag=!0))}}}var y=new mr;r.Solve(y,e,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=y.solveInit,this.m_profile.solveVelocity+=y.solveVelocity,this.m_profile.solvePosition+=y.solvePosition;for(var x=0;x<r.m_bodyCount;++x){var S=r.m_bodies[x];S.GetType()===t.b2BodyType.b2_staticBody&&(S.m_islandFlag=!1)}}for(var A=0;A<c.length&&c[A];++A)c[A]=null;for(var C=new Nt,b=this.m_bodyList;b;b=b.m_next)b.m_islandFlag&&b.GetType()!==t.b2BodyType.b2_staticBody&&b.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=C.GetMilliseconds()},n.SolveTOI=function(n){var i=this.m_island;if(i.Initialize(2*p,p,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1,o.m_sweep.alpha0=0;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_toiFlag=!1,a.m_islandFlag=!1,a.m_toiCount=0,a.m_toi=1}for(;;){for(var s=null,c=1,l=this.m_contactManager.m_contactList;l;l=l.m_next)if(l.IsEnabled()&&!(l.m_toiCount>d)){var u=1;if(l.m_toiFlag)u=l.m_toi;else{var h=l.GetFixtureA(),_=l.GetFixtureB();if(h.IsSensor()||_.IsSensor())continue;var f=h.GetBody(),m=_.GetBody(),v=f.m_type,g=m.m_type,y=f.IsAwake()&&v!==t.b2BodyType.b2_staticBody,x=m.IsAwake()&&g!==t.b2BodyType.b2_staticBody;if(!y&&!x)continue;var S=f.IsBullet()||v!==t.b2BodyType.b2_dynamicBody,A=m.IsBullet()||g!==t.b2BodyType.b2_dynamicBody;if(!S&&!A)continue;var C=f.m_sweep.alpha0;f.m_sweep.alpha0<m.m_sweep.alpha0?(C=m.m_sweep.alpha0,f.m_sweep.Advance(C)):m.m_sweep.alpha0<f.m_sweep.alpha0&&(C=f.m_sweep.alpha0,m.m_sweep.Advance(C));var b=l.GetChildIndexA(),T=l.GetChildIndexB(),E=e.SolveTOI_s_toi_input;E.proxyA.SetShape(h.GetShape(),b),E.proxyB.SetShape(_.GetShape(),T),E.sweepA.Copy(f.m_sweep),E.sweepB.Copy(m.m_sweep),E.tMax=1;var w=e.SolveTOI_s_toi_output;un(w,E);var P=w.t;u=w.state===t.b2TOIOutputState.e_touching?it(C+(1-C)*P,1):1,l.m_toi=u,l.m_toiFlag=!0}u<c&&(s=l,c=u)}if(null===s||1-10*r<c){this.m_stepComplete=!0;break}var I=s.GetFixtureA(),R=s.GetFixtureB(),D=I.GetBody(),M=R.GetBody(),B=e.SolveTOI_s_backup1.Copy(D.m_sweep),O=e.SolveTOI_s_backup2.Copy(M.m_sweep);if(D.Advance(c),M.Advance(c),s.Update(this.m_contactManager.m_contactListener),s.m_toiFlag=!1,++s.m_toiCount,s.IsEnabled()&&s.IsTouching()){D.SetAwake(!0),M.SetAwake(!0),i.Clear(),i.AddBody(D),i.AddBody(M),i.AddContact(s),D.m_islandFlag=!0,M.m_islandFlag=!0,s.m_islandFlag=!0;for(var N=0;N<2;++N){var L=0===N?D:M;if(L.m_type===t.b2BodyType.b2_dynamicBody)for(var F=L.m_contactList;F&&i.m_bodyCount!==i.m_bodyCapacity&&i.m_contactCount!==i.m_contactCapacity;F=F.next){var z=F.contact;if(!z.m_islandFlag){var V=F.other;if(V.m_type!==t.b2BodyType.b2_dynamicBody||L.IsBullet()||V.IsBullet()){var k=z.m_fixtureA.m_isSensor,G=z.m_fixtureB.m_isSensor;if(!k&&!G){var U=e.SolveTOI_s_backup.Copy(V.m_sweep);V.m_islandFlag||V.Advance(c),z.Update(this.m_contactManager.m_contactListener),z.IsEnabled()&&z.IsTouching()?(z.m_islandFlag=!0,i.AddContact(z),V.m_islandFlag||(V.m_islandFlag=!0,V.m_type!==t.b2BodyType.b2_staticBody&&V.SetAwake(!0),i.AddBody(V))):(V.m_sweep.Copy(U),V.SynchronizeTransform())}}}}}var H=e.SolveTOI_s_subStep;H.dt=(1-c)*n.dt,H.inv_dt=1/H.dt,H.dtRatio=1,H.positionIterations=20,H.velocityIterations=n.velocityIterations,H.particleIterations=n.particleIterations,H.warmStarting=!1,i.SolveTOI(H,D.m_islandIndex,M.m_islandIndex);for(var j=0;j<i.m_bodyCount;++j){var W=i.m_bodies[j];if(W.m_islandFlag=!1,W.m_type===t.b2BodyType.b2_dynamicBody){W.SynchronizeFixtures();for(var q=W.m_contactList;q;q=q.next)q.contact.m_toiFlag=!1,q.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}else s.SetEnabled(!1),D.m_sweep.Copy(B),M.m_sweep.Copy(O),D.SynchronizeTransform(),M.SynchronizeTransform()}},n.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t},n.RemoveController=function(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t},e}();xo.Step_s_step=new vr,xo.Step_s_stepTimer=new Nt,xo.Step_s_timer=new Nt,xo.DrawDebugData_s_color=new Bt(0,0,0),xo.DrawDebugData_s_vs=bt.MakeArray(4),xo.DrawDebugData_s_xf=new Rt,xo.QueryFixtureShape_s_aabb=new Te,xo.RayCast_s_input=new Ce,xo.RayCast_s_output=new be,xo.RayCast_s_point=new bt,xo.DrawJoint_s_p1=new bt,xo.DrawJoint_s_p2=new bt,xo.DrawJoint_s_color=new Bt(.5,.8,.8),xo.DrawJoint_s_c=new Bt,xo.DrawShape_s_ghostColor=new Bt,xo.SolveTOI_s_subStep=new vr,xo.SolveTOI_s_backup=new Mt,xo.SolveTOI_s_backup1=new Mt,xo.SolveTOI_s_backup2=new Mt,xo.SolveTOI_s_toi_input=new Je,xo.SolveTOI_s_toi_output=new Ze;var So=function(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e},Ao=function(){function t(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}var e=t.prototype;return e.GetNext=function(){return this.m_next},e.GetPrev=function(){return this.m_prev},e.GetBodyList=function(){return this.m_bodyList},e.AddBody=function(t){var e=new So(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount},e.RemoveBody=function(t){if(this.m_bodyCount<=0)throw new Error;for(var e=this.m_bodyList;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount},e.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0},t}(),Co=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).normal=new bt(0,1),e.offset=0,e.density=0,e.velocity=new bt(0,0),e.linearDrag=0,e.angularDrag=0,e.useDensity=!1,e.useWorldGravity=!0,e.gravity=new bt(0,0),e}Q(e,t);var n=e.prototype;return n.Step=function(){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(var t=this.m_bodyList;t;t=t.nextBody){var e=t.body;if(e.IsAwake()){for(var n=new bt,i=new bt,o=0,a=0,s=e.GetFixtureList();s;s=s.m_next){var c=new bt,l=s.GetShape().ComputeSubmergedArea(this.normal,this.offset,e.GetTransform(),c);o+=l,n.x+=l*c.x,n.y+=l*c.y;var u=0;a+=l*(u=this.useDensity?s.GetDensity():1),i.x+=l*c.x*u,i.y+=l*c.y*u}if(n.x/=o,n.y/=o,i.x/=a,i.y/=a,!(o<r)){var h=this.gravity.Clone().SelfNeg();h.SelfMul(this.density*o),e.ApplyForce(h,i);var _=e.GetLinearVelocityFromWorldPoint(n,new bt);_.SelfSub(this.velocity),_.SelfMul(-this.linearDrag*o),e.ApplyForce(_,n),e.ApplyTorque(-e.GetInertia()/e.GetMass()*o*e.GetAngularVelocity()*this.angularDrag)}}}}},n.Draw=function(t){var e=100,n=new bt,i=new bt;n.x=this.normal.x*this.offset+this.normal.y*e,n.y=this.normal.y*this.offset-this.normal.x*e,i.x=this.normal.x*this.offset-this.normal.y*e,i.y=this.normal.y*this.offset+this.normal.x*e;var r=new Bt(0,0,.8);t.DrawSegment(n,i,r)},e}(Ao),bo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).A=new bt(0,0),e}Q(e,t);var n=e.prototype;return n.Step=function(t){for(var n=bt.MulSV(t.dt,this.A,e.Step_s_dtA),i=this.m_bodyList;i;i=i.nextBody){var r=i.body;r.IsAwake()&&r.SetLinearVelocity(bt.AddVV(r.GetLinearVelocity(),n,bt.s_t0))}},n.Draw=function(){},e}(Ao);bo.Step_s_dtA=new bt;var To=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).F=new bt(0,0),e}Q(e,t);var n=e.prototype;return n.Step=function(){for(var t=this.m_bodyList;t;t=t.nextBody){var e=t.body;e.IsAwake()&&e.ApplyForce(this.F,e.GetWorldCenter())}},n.Draw=function(){},e}(Ao),Eo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).G=1,e.invSqr=!0,e}Q(e,t);var n=e.prototype;return n.Step=function(){if(this.invSqr)for(var t=this.m_bodyList;t;t=t.nextBody)for(var n=t.body,i=n.GetWorldCenter(),o=n.GetMass(),a=this.m_bodyList;a&&a!==t;a=a.nextBody){var s=a.body,c=s.GetWorldCenter(),l=s.GetMass(),u=c.x-i.x,h=c.y-i.y,_=u*u+h*h;if(!(_<r)){var f=e.Step_s_f.Set(u,h);f.SelfMul(this.G/_/ht(_)*o*l),n.IsAwake()&&n.ApplyForce(f,i),s.IsAwake()&&s.ApplyForce(f.SelfMul(-1),c)}}else for(var d=this.m_bodyList;d;d=d.nextBody)for(var p=d.body,m=p.GetWorldCenter(),v=p.GetMass(),g=this.m_bodyList;g&&g!==d;g=g.nextBody){var y=g.body,x=y.GetWorldCenter(),S=y.GetMass(),A=x.x-m.x,C=x.y-m.y,b=A*A+C*C;if(!(b<r)){var T=e.Step_s_f.Set(A,C);T.SelfMul(this.G/b*v*S),p.IsAwake()&&p.ApplyForce(T,m),y.IsAwake()&&y.ApplyForce(T.SelfMul(-1),x)}}},n.Draw=function(){},e}(Ao);Eo.Step_s_f=new bt;var wo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).T=new wt,e.maxTimestep=0,e}Q(e,t);var n=e.prototype;return n.Step=function(t){var n=t.dt;if(!(n<=r)){n>this.maxTimestep&&this.maxTimestep>0&&(n=this.maxTimestep);for(var i=this.m_bodyList;i;i=i.nextBody){var o=i.body;if(o.IsAwake()){var a=o.GetWorldVector(wt.MulMV(this.T,o.GetLocalVector(o.GetLinearVelocity(),bt.s_t0),bt.s_t1),e.Step_s_damping);o.SetLinearVelocity(bt.AddVV(o.GetLinearVelocity(),bt.MulSV(n,a,bt.s_t0),bt.s_t1))}}}},n.Draw=function(){},n.SetAxisAligned=function(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=t>0||e>0?1/rt(t,e):0},e}(Ao);wo.Step_s_damping=new bt;var Po=function(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new bt(0,0),this.damping=.1,this.k2=.9,this.k3=.1},Io=function(){function t(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new bt,this.m_damping=0,this.m_k2=1,this.m_k3=.1}var e=t.prototype;return e.GetVertexCount=function(){return this.m_count},e.GetVertices=function(){return this.m_ps},e.Initialize=function(t){this.m_count=t.count,this.m_ps=bt.MakeArray(this.m_count),this.m_p0s=bt.MakeArray(this.m_count),this.m_vs=bt.MakeArray(this.m_count),this.m_ims=J(this.m_count);for(var e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();var n=t.masses[e];this.m_ims[e]=n>0?1/n:0}var i=this.m_count-1,r=this.m_count-2;this.m_Ls=J(i),this.m_as=J(r);for(var o=0;o<i;++o){var a=this.m_ps[o],s=this.m_ps[o+1];this.m_Ls[o]=bt.DistanceVV(a,s)}for(var c=0;c<r;++c){var l=this.m_ps[c],u=this.m_ps[c+1],h=this.m_ps[c+2],_=bt.SubVV(u,l,bt.s_t0),f=bt.SubVV(h,u,bt.s_t1),d=bt.CrossVV(_,f),p=bt.DotVV(_,f);this.m_as[c]=yt(d,p)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3},e.Step=function(t,e){if(0!==t){for(var n=Math.exp(-t*this.m_damping),i=0;i<this.m_count;++i)this.m_p0s[i].Copy(this.m_ps[i]),this.m_ims[i]>0&&this.m_vs[i].SelfMulAdd(t,this.m_gravity),this.m_vs[i].SelfMul(n),this.m_ps[i].SelfMulAdd(t,this.m_vs[i]);for(var r=0;r<e;++r)this.SolveC2(),this.SolveC3(),this.SolveC2();for(var o=1/t,a=0;a<this.m_count;++a)bt.MulSV(o,bt.SubVV(this.m_ps[a],this.m_p0s[a],bt.s_t0),this.m_vs[a])}},e.SolveC2=function(){for(var e=this.m_count-1,n=0;n<e;++n){var i=this.m_ps[n],r=this.m_ps[n+1],o=bt.SubVV(r,i,t.s_d),a=o.Normalize(),s=this.m_ims[n],c=this.m_ims[n+1];if(s+c!==0){var l=s/(s+c),u=c/(s+c);i.SelfMulSub(this.m_k2*l*(this.m_Ls[n]-a),o),r.SelfMulAdd(this.m_k2*u*(this.m_Ls[n]-a),o)}}},e.SetAngle=function(t){for(var e=this.m_count-2,n=0;n<e;++n)this.m_as[n]=t},e.SolveC3=function(){for(var e=this.m_count-2,n=0;n<e;++n){var i=this.m_ps[n],r=this.m_ps[n+1],o=this.m_ps[n+2],s=this.m_ims[n],c=this.m_ims[n+1],l=this.m_ims[n+2],u=bt.SubVV(r,i,t.s_d1),h=bt.SubVV(o,r,t.s_d2),_=u.LengthSquared(),f=h.LengthSquared();if(_*f!=0){var d=bt.CrossVV(u,h),p=bt.DotVV(u,h),m=yt(d,p),v=bt.MulSV(-1/_,u.SelfSkew(),t.s_Jd1),g=bt.MulSV(1/f,h.SelfSkew(),t.s_Jd2),y=bt.NegV(v,t.s_J1),x=bt.SubVV(v,g,t.s_J2),S=g,A=s*bt.DotVV(y,y)+c*bt.DotVV(x,x)+l*bt.DotVV(S,S);if(0!==A){A=1/A;for(var C=m-this.m_as[n];C>a;)C=(m-=2*a)-this.m_as[n];for(;C<-a;)C=(m+=2*a)-this.m_as[n];var b=-this.m_k3*A*C;i.SelfMulAdd(s*b,y),r.SelfMulAdd(c*b,x),o.SelfMulAdd(l*b,S)}}}},e.Draw=function(t){for(var e=new Bt(.4,.5,.7),n=0;n<this.m_count-1;++n)t.DrawSegment(this.m_ps[n],this.m_ps[n+1],e)},t}();Io.s_d=new bt,Io.s_d1=new bt,Io.s_d2=new bt,Io.s_Jd1=new bt,Io.s_Jd2=new bt,Io.s_J1=new bt,Io.s_J2=new bt,t.b2AABB=Te,t.b2Abs=nt,t.b2Acos=vt,t.b2Alloc=z,t.b2AreaJoint=Pi,t.b2AreaJointDef=wi,t.b2Asin=gt,t.b2Assert=e,t.b2Atan2=yt,t.b2BlockAllocator=zt,t.b2Body=xi,t.b2BodyDef=yi,t.b2BroadPhase=Ve,t.b2BuoyancyController=Co,t.b2CalculateParticleIterations=Dr,t.b2ChainAndCircleContact=or,t.b2ChainAndPolygonContact=ar,t.b2ChainShape=hi,t.b2CircleContact=tr,t.b2CircleShape=ci,t.b2Clamp=at,t.b2ClipSegmentToLine=we,t.b2ClipVertex=Ae,t.b2CollideCircles=fn,t.b2CollideEdgeAndCircle=Qn,t.b2CollideEdgeAndPolygon=ri,t.b2CollidePolygonAndCircle=vn,t.b2CollidePolygons=Gn,t.b2Color=Bt,t.b2ConstantAccelController=bo,t.b2ConstantForceController=To,t.b2Contact=$i,t.b2ContactEdge=Zi,t.b2ContactFactory=cr,t.b2ContactFeature=pe,t.b2ContactFilter=ur,t.b2ContactID=me,t.b2ContactImpulse=hr,t.b2ContactListener=_r,t.b2ContactManager=pr,t.b2ContactPositionConstraint=br,t.b2ContactRegister=sr,t.b2ContactSolver=wr,t.b2ContactSolverDef=Tr,t.b2ContactVelocityConstraint=Cr,t.b2Controller=Ao,t.b2ControllerEdge=So,t.b2Cos=pt,t.b2Counter=Lt,t.b2DegToRad=ft,t.b2DestructionListener=lr,t.b2Distance=ie,t.b2DistanceInput=Ut,t.b2DistanceJoint=Ei,t.b2DistanceJointDef=Ti,t.b2DistanceOutput=Ht,t.b2DistanceProxy=kt,t.b2Draw=Ot,t.b2DynamicTree=Oe,t.b2EdgeAndCircleContact=ir,t.b2EdgeAndPolygonContact=rr,t.b2EdgeShape=ui,t.b2Filter=_i,t.b2Fixture=mi,t.b2FixtureDef=fi,t.b2FixtureParticleQueryCallback=Jr,t.b2FixtureProxy=di,t.b2Free=V,t.b2FrictionJoint=Ri,t.b2FrictionJointDef=Ii,t.b2GearJoint=Mi,t.b2GearJointDef=Di,t.b2GetPointStates=Se,t.b2GravityController=Eo,t.b2GrowableBuffer=Kr,t.b2GrowableStack=Ft,t.b2InvSqrt=ut,t.b2IsPowerOfTwo=St,t.b2IsValid=ct,t.b2Island=Ir,t.b2Jacobian=Si,t.b2Joint=bi,t.b2JointDef=Ci,t.b2JointEdge=Ai,t.b2Log=k,t.b2MakeArray=X,t.b2MakeNullArray=Y,t.b2MakeNumberArray=J,t.b2Manifold=ye,t.b2ManifoldPoint=ve,t.b2MassData=ai,t.b2Mat22=wt,t.b2Mat33=Pt,t.b2Max=rt,t.b2Maybe=n,t.b2Min=it,t.b2MixFriction=Ji,t.b2MixRestitution=Qi,t.b2MotorJoint=Oi,t.b2MotorJointDef=Bi,t.b2MouseJoint=Li,t.b2MouseJointDef=Ni,t.b2NextPowerOfTwo=xt,t.b2Pair=ze,t.b2PairLessThan=ke,t.b2ParseInt=W,t.b2ParseUInt=q,t.b2ParticleBodyContact=Zr,t.b2ParticleContact=Qr,t.b2ParticleDef=Rr,t.b2ParticleGroup=Nr,t.b2ParticleGroupDef=Or,t.b2ParticleHandle=Br,t.b2ParticlePair=$r,t.b2ParticlePairSet=ho,t.b2ParticleSystem=no,t.b2ParticleSystemDef=eo,t.b2ParticleSystem_CompositeShape=mo,t.b2ParticleSystem_ConnectionFilter=_o,t.b2ParticleSystem_DestroyParticlesInShapeCallback=fo,t.b2ParticleSystem_FixedSetAllocator=so,t.b2ParticleSystem_FixtureParticle=co,t.b2ParticleSystem_FixtureParticleSet=lo,t.b2ParticleSystem_InsideBoundsEnumerator=oo,t.b2ParticleSystem_JoinParticleGroupsFilter=po,t.b2ParticleSystem_ParticleListNode=ao,t.b2ParticleSystem_ParticlePair=uo,t.b2ParticleSystem_Proxy=ro,t.b2ParticleSystem_ReactiveFilter=vo,t.b2ParticleSystem_SolveCollisionCallback=yo,t.b2ParticleSystem_UpdateBodyContactsCallback=go,t.b2ParticleSystem_UserOverridableBuffer=io,t.b2ParticleTriad=to,t.b2PolygonAndCircleContact=nr,t.b2PolygonContact=er,t.b2PolygonShape=li,t.b2Position=gr,t.b2PositionSolverManifold=Er,t.b2Pow=_t,t.b2PrismaticJoint=zi,t.b2PrismaticJointDef=Fi,t.b2Profile=mr,t.b2PulleyJoint=Gi,t.b2PulleyJointDef=ki,t.b2QueryCallback=fr,t.b2RadToDeg=dt,t.b2Random=At,t.b2RandomRange=Ct,t.b2RayCastCallback=dr,t.b2RayCastInput=Ce,t.b2RayCastOutput=be,t.b2RevoluteJoint=Hi,t.b2RevoluteJointDef=Ui,t.b2Rope=Io,t.b2RopeDef=Po,t.b2RopeJoint=Wi,t.b2RopeJointDef=ji,t.b2Rot=It,t.b2SeparationFunction=$e,t.b2Shape=si,t.b2ShapeCast=fe,t.b2ShapeCastInput=jt,t.b2ShapeCastOutput=Wt,t.b2Simplex=Yt,t.b2SimplexCache=Gt,t.b2SimplexVertex=Xt,t.b2Sin=mt,t.b2SolverData=xr,t.b2Sq=lt,t.b2Sqrt=ht,t.b2StackAllocator=Vt,t.b2Swap=st,t.b2Sweep=Mt,t.b2TOIInput=Je,t.b2TOIOutput=Ze,t.b2TensorDampingController=wo,t.b2TestOverlapAABB=Ee,t.b2TestOverlapShape=De,t.b2TimeOfImpact=un,t.b2TimeStep=vr,t.b2Timer=Nt,t.b2Transform=Rt,t.b2TreeNode=Be,t.b2Vec2=bt,t.b2Vec2_zero=Tt,t.b2Vec3=Et,t.b2Velocity=yr,t.b2VelocityConstraintPoint=Ar,t.b2Version=G,t.b2WeldJoint=Xi,t.b2WeldJointDef=qi,t.b2WheelJoint=Ki,t.b2WheelJointDef=Yi,t.b2World=xo,t.b2WorldManifold=xe,t.b2_180_over_pi=$,t.b2_aabbExtension=l,t.b2_aabbMultiplier=u,t.b2_angularSleepTolerance=F,t.b2_angularSlop=_,t.b2_barrierCollisionTime=O,t.b2_baumgarte=C,t.b2_branch=H,t.b2_commit=j,t.b2_epsilon=r,t.b2_epsilon_sq=o,t.b2_gjk_reset=qt,t.b2_invalidParticleIndex=T,t.b2_linearSleepTolerance=L,t.b2_linearSlop=h,t.b2_maxAngularCorrection=g,t.b2_maxFloat=i,t.b2_maxLinearCorrection=v,t.b2_maxManifoldPoints=s,t.b2_maxParticleForce=R,t.b2_maxParticleIndex=E,t.b2_maxParticlePressure=I,t.b2_maxPolygonVertices=c,t.b2_maxRotation=S,t.b2_maxRotationSquared=A,t.b2_maxSubSteps=d,t.b2_maxTOIContacts=p,t.b2_maxTranslation=y,t.b2_maxTranslationSquared=x,t.b2_maxTriadDistance=D,t.b2_maxTriadDistanceSquared=M,t.b2_minParticleSystemBufferCapacity=B,t.b2_minParticleWeight=P,t.b2_minPulleyLength=Vi,t.b2_particleStride=w,t.b2_pi=a,t.b2_pi_over_180=Z,t.b2_polygonRadius=f,t.b2_timeToSleep=N,t.b2_toiBaumgarte=b,t.b2_toi_reset=Ge,t.b2_two_pi=tt,t.b2_velocityThreshold=m,t.b2_version=U,t.g_blockSolve=Sr,Object.defineProperty(t,"__esModule",{value:!0})}(e)}(e={exports:{}},e.exports),e.exports}();(e8=n8)&&e8.__esModule&&Object.prototype.hasOwnProperty.call(e8,"default")&&e8.default;var i8={};for(var r8 in n8)-1===r8.indexOf("b2_")&&(i8[r8.replace("b2","")]=n8[r8]);var o8,a8,s8,c8,l8,u8=i8;!function(t){t[t.Static=0]="Static",t[t.Kinematic=1]="Kinematic",t[t.Dynamic=2]="Dynamic",t[t.Animated=3]="Animated"}(o8||(o8=t("ERigidBody2DType",{}))),oe(o8),function(t){t[t.None=0]="None",t[t.BOX=1]="BOX",t[t.CIRCLE=2]="CIRCLE",t[t.POLYGON=3]="POLYGON"}(a8||(a8=t("ECollider2DType",{}))),oe(a8),function(t){t[t.None=0]="None",t[t.DISTANCE=1]="DISTANCE",t[t.SPRING=2]="SPRING",t[t.WHEEL=3]="WHEEL",t[t.MOUSE=4]="MOUSE",t[t.FIXED=5]="FIXED",t[t.SLIDER=6]="SLIDER",t[t.RELATIVE=7]="RELATIVE",t[t.HINGE=8]="HINGE"}(s8||(s8=t("EJoint2DType",{}))),oe(s8),function(t){t[t.DEFAULT=1]="DEFAULT"}(c8||(c8=t("PhysicsGroup",{}))),oe(c8),function(t){t[t.Closest=0]="Closest",t[t.Any=1]="Any",t[t.AllClosest=2]="AllClosest",t[t.All=3]="All"}(l8||(l8=t("ERaycast2DType",{})));var h8,_8=t("Contact2DType",{None:"none-contact",BEGIN_CONTACT:"begin-contact",END_CONTACT:"end-contact",PRE_SOLVE:"pre-solve",POST_SOLVE:"post-solve"});!function(t){t[t.None=0]="None",t[t.Shape=1]="Shape",t[t.Joint=2]="Joint",t[t.Aabb=4]="Aabb",t[t.Pair=8]="Pair",t[t.CenterOfMass=16]="CenterOfMass",t[t.Particle=32]="Particle",t[t.Controller=64]="Controller",t[t.All=63]="All"}(h8||(h8=t("EPhysics2DDrawFlags",{})));var f8=t("PHYSICS_2D_PTM_RATIO",32),d8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._contactFixtures=[],e._BeginContact=null,e._EndContact=null,e._PreSolve=null,e._PostSolve=null,e}Q(e,t);var n=e.prototype;return n.setBeginContact=function(t){this._BeginContact=t},n.setEndContact=function(t){this._EndContact=t},n.setPreSolve=function(t){this._PreSolve=t},n.setPostSolve=function(t){this._PostSolve=t},n.BeginContact=function(t){if(this._BeginContact){var e=t.GetFixtureA(),n=t.GetFixtureB(),i=this._contactFixtures;t._shouldReport=!1,-1===i.indexOf(e)&&-1===i.indexOf(n)||(t._shouldReport=!0,this._BeginContact(t))}},n.EndContact=function(t){this._EndContact&&t._shouldReport&&(t._shouldReport=!1,this._EndContact(t))},n.PreSolve=function(t,e){this._PreSolve&&t._shouldReport&&this._PreSolve(t,e)},n.PostSolve=function(t,e){this._PostSolve&&t._shouldReport&&this._PostSolve(t,e)},n.registerContactFixture=function(t){this._contactFixtures.push(t)},n.unregisterContactFixture=function(t){ht(this._contactFixtures,t)},e}(u8.ContactListener),p8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._point=new u8.Vec2,e._isPoint=!1,e._fixtures=[],e}Q(e,t);var n=e.prototype;return n.init=function(t){t?(this._isPoint=!0,this._point.x=t.x,this._point.y=t.y):this._isPoint=!1,this._fixtures.length=0},n.ReportFixture=function(t){return this._isPoint?t.TestPoint(this._point)&&this._fixtures.push(t):this._fixtures.push(t),!0},n.getFixture=function(){return this._fixtures[0]},n.getFixtures=function(){return this._fixtures},e}(u8.QueryCallback);function m8(t,e){var n=e.length;return e[t<0?n- -t%n:t%n]}function v8(t,e,n){for(var i=[];e<t;)e+=n.length;for(;t<=e;++t)i.push(m8(t,n));return i}function g8(t){E8(t);for(var e,n,i,r,o,a,s=[],c=new Xn,l=new Xn,u=0,h=0,_=0;_<t.length;++_)if(x8(_,t)){n=i=1e8;for(var f=0;f<t.length;++f)A8(m8(_-1,t),m8(_,t),m8(f,t))&&b8(m8(_-1,t),m8(_,t),m8(f-1,t))&&(r=P8(m8(_-1,t),m8(_,t),m8(f,t),m8(f-1,t)),S8(m8(_+1,t),m8(_,t),r)&&(e=T8(m8(_,t),r))<n&&(n=e,c=r,u=f)),A8(m8(_+1,t),m8(_,t),m8(f+1,t))&&b8(m8(_+1,t),m8(_,t),m8(f,t))&&(r=P8(m8(_+1,t),m8(_,t),m8(f,t),m8(f+1,t)),A8(m8(_-1,t),m8(_,t),r)&&(e=T8(m8(_,t),r))<i&&(i=e,h=f,l=r));if(u==(h+1)%t.length){var d=c.add(l).multiplyScalar(.5);(o=v8(_,h,t)).push(d),(a=v8(u,_,t)).push(d)}else{for(var p=0,m=u;h<u;)h+=t.length;for(var v=u;v<=h;++v)if(y8(_,v,t)){var g=1/(T8(m8(_,t),m8(v,t))+1);x8(v,t)?b8(m8(v-1,t),m8(v,t),m8(_,t))&&C8(m8(v+1,t),m8(v,t),m8(_,t))?g+=3:g+=2:g+=1,g>p&&(m=v,p=g)}o=v8(_,m,t),a=v8(m,_,t)}return(s=s.concat(g8(o))).concat(g8(a))}s.push(t);for(var y=s.length-1;y>=0;y--)0==s[y].length&&s.splice(y,0);return s}function y8(t,e,n){if(x8(t,n)){if(C8(m8(t,n),m8(t-1,n),m8(e,n))&&b8(m8(t,n),m8(t+1,n),m8(e,n)))return!1}else if(b8(m8(t,n),m8(t+1,n),m8(e,n))||C8(m8(t,n),m8(t-1,n),m8(e,n)))return!1;if(x8(e,n)){if(C8(m8(e,n),m8(e-1,n),m8(t,n))&&b8(m8(e,n),m8(e+1,n),m8(t,n)))return!1}else if(b8(m8(e,n),m8(e+1,n),m8(t,n))||C8(m8(e,n),m8(e-1,n),m8(t,n)))return!1;for(var i=0;i<n.length;++i)if((i+1)%n.length!=t&&i!=t&&(i+1)%n.length!=e&&i!=e){var r=new Xn;if(I8(m8(t,n),m8(e,n),m8(i,n),m8(i+1,n),r))return!1}return!0}function x8(t,e){return S8(t,e)}function S8(t,e,n){if(void 0===n){var i=t,r=e;t=m8(i-1,r),e=m8(i,r),n=m8(i+1,r)}return R8(t,e,n)<0}function A8(t,e,n){return R8(t,e,n)>0}function C8(t,e,n){return R8(t,e,n)>=0}function b8(t,e,n){return R8(t,e,n)<=0}function T8(t,e){var n=e.x-t.x,i=e.y-t.y;return n*n+i*i}function E8(t){w8(t)||t.reverse()}function w8(t){return t.length<3||function(t){var e,n=0;for(e=0;e<t.length;e++){var i=(e+1)%t.length;n+=t[e].x*t[i].y,n-=t[e].y*t[i].x}return n/2}(t)>0}function P8(t,e,n,i){var r,o=new Xn,a=e.y-t.y,s=t.x-e.x,c=a*t.x+s*t.y,l=i.y-n.y,u=n.x-i.x,h=l*n.x+u*n.y,_=a*u-l*s;return r=_,0,Math.abs(r-0)<=1e-6||(o.x=(u*c-s*h)/_,o.y=(a*h-l*c)/_),o}function I8(t,e,n,i,r){if(t==n||t==i||e==n||e==i)return!1;var o=t.x,a=t.y,s=e.x,c=e.y,l=n.x,u=n.y,h=i.x,_=i.y;if(Math.max(o,s)<Math.min(l,h)||Math.max(l,h)<Math.min(o,s))return!1;if(Math.max(a,c)<Math.min(u,_)||Math.max(u,_)<Math.min(a,c))return!1;var f=(h-l)*(a-u)-(_-u)*(o-l),d=(s-o)*(a-u)-(c-a)*(o-l),p=(_-u)*(s-o)-(h-l)*(c-a);return!(Math.abs(p)<1e-6)&&(d/=p,(f/=p)>0&&f<1&&d>0&&d<1&&(r.x=o+f*(s-o),r.y=a+f*(c-a),!0))}function R8(t,e,n){return t.x*(e.y-n.y)+e.x*(n.y-t.y)+n.x*(t.y-e.y)}var D8=Object.freeze({__proto__:null,ConvexPartition:g8,ForceCounterClockWise:E8,IsCounterClockWise:w8}),M8=function(){return 0},B8={impl:null,rigidBody:null,isAwake:!1,isSleeping:!1,initialize:M8,setType:M8,setLinearDamping:M8,setAngularDamping:M8,setGravityScale:M8,setFixedRotation:M8,setAllowSleep:M8,isActive:M8,setActive:M8,wakeUp:M8,sleep:M8,getMass:M8,getInertia:M8,getLinearVelocity:M8,setLinearVelocity:M8,getLinearVelocityFromWorldPoint:M8,getAngularVelocity:M8,setAngularVelocity:M8,getLocalVector:M8,getWorldVector:M8,getLocalPoint:M8,getWorldPoint:M8,getLocalCenter:M8,getWorldCenter:M8,applyForce:M8,applyForceToCenter:M8,applyTorque:M8,applyLinearImpulse:M8,applyLinearImpulseToCenter:M8,applyAngularImpulse:M8,onEnable:M8,onDisable:M8,onDestroy:M8},O8={INITED:!1};var N8,L8,F8,z8,V8,k8,G8={INITED:!1},U8={impl:null,initialize:M8,setDampingRatio:M8,setFrequency:M8,setMaxForce:M8,setTarget:M8,setDistance:M8,setAngularOffset:M8,setCorrectionFactor:M8,setLinearOffset:M8,setMaxLength:M8,setMaxTorque:M8,setLowerLimit:M8,setUpperLimit:M8,setMaxMotorForce:M8,setMaxMotorTorque:M8,setMotorSpeed:M8,enableLimit:M8,enableMotor:M8,setLowerAngle:M8,setUpperAngle:M8};!function(t){t[t.DYNAMIC=1]="DYNAMIC",t[t.STATIC=2]="STATIC",t[t.KINEMATIC=4]="KINEMATIC"}(N8||(N8={})),oe(N8),function(t){t[t.X_AXIS=0]="X_AXIS",t[t.Y_AXIS=1]="Y_AXIS",t[t.Z_AXIS=2]="Z_AXIS"}(L8||(L8={})),oe(L8),function(t){t[t.VERTEX=1]="VERTEX",t[t.LINE=2]="LINE",t[t.TRIANGLE=3]="TRIANGLE",t[t.TETRAHEDRON=4]="TETRAHEDRON"}(F8||(F8={})),oe(F8),function(t){t[t.BOX=0]="BOX",t[t.SPHERE=1]="SPHERE",t[t.CAPSULE=2]="CAPSULE",t[t.CYLINDER=3]="CYLINDER",t[t.CONE=4]="CONE",t[t.MESH=5]="MESH",t[t.PLANE=6]="PLANE",t[t.SIMPLEX=7]="SIMPLEX",t[t.TERRAIN=8]="TERRAIN"}(z8||(z8={})),oe(z8),function(t){t[t.POINT_TO_POINT=0]="POINT_TO_POINT",t[t.HINGE=1]="HINGE",t[t.CONE_TWIST=2]="CONE_TWIST"}(V8||(V8={})),oe(V8),function(t){t[t.DEFAULT=1]="DEFAULT"}(k8||(k8={})),oe(k8);var H8,j8,W8,q8,X8,Y8,K8,J8,Q8,Z8,$8,t6,e6,n6,i6,r6,o6,a6,s6,c6=function(t){if(1===t){for(var e=this,n=function(t){var n="_"+(1<<t);e[n]=0,e.updateArray=[],Object.defineProperty(e,1<<t,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this[n]=e,this.updateArray.indexOf(t)<0&&this.updateArray.push(t))}})},i=0;i<32;i++)n(i);this._1=k8.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=k8.DEFAULT}},l6=null,u6=t("PhysicsSystem2D",function(t){function e(){var e;(e=t.call(this)||this).velocityIterations=10,e.positionIterations=10,e.physicsWorld=void 0,e.collisionMatrix=new c6,e._enable=!0,e._allowSleep=!0,e._maxSubSteps=1,e._fixedTimeStep=1/60,e._autoSimulation=!0,e._accumulator=0,e._steping=!1,e._gravity=new Xn(0,-10*f8),e._delayEvents=[];var n=LB.config?LB.config.physics:null;if(n){if(Xn.copy(e._gravity,n.gravity),e._gravity.multiplyScalar(f8),e._allowSleep=n.allowSleep,e._fixedTimeStep=n.fixedTimeStep,e._maxSubSteps=n.maxSubSteps,e._autoSimulation=n.autoSimulation,n.collisionMatrix)for(var i in n.collisionMatrix){var r=parseInt(i),o=1<<parseInt(i);e.collisionMatrix[""+o]=n.collisionMatrix[r]}if(n.collisionGroups){var a=n.collisionGroups;a instanceof Array&&(a.forEach((function(t){c8[t.name]=1<<t.index})),oe.update(c8))}}return e.physicsWorld=new Z5.PhysicsWorld,e.gravity=e._gravity,e.allowSleep=e._allowSleep,e}Q(e,t);var n=e.prototype;return n.postUpdate=function(t){if(this._enable&&this._autoSimulation){zB.emit(FB.EVENT_BEFORE_PHYSICS),this._steping=!0;var e=this._fixedTimeStep,n=this.velocityIterations,i=this.positionIterations;this._accumulator+=t;for(var r=0;r++<this._maxSubSteps&&this._accumulator>e;)this.physicsWorld.step(e,n,i),this._accumulator-=e;for(var o=this._delayEvents,a=0,s=o.length;a<s;a++){var c=o[a];c.func.call(c.target)}o.length=0,this.physicsWorld.syncPhysicsToScene(),this.debugDrawFlags&&this.physicsWorld.drawDebug(),this._steping=!1,zB.emit(FB.EVENT_AFTER_PHYSICS)}},n._callAfterStep=function(t,e){this._steping?this._delayEvents.push({target:t,func:e}):e.call(t)},n.resetAccumulator=function(t){void 0===t&&(t=0),this._accumulator=t},n.step=function(t){this.physicsWorld.step(t,this.velocityIterations,this.positionIterations)},n.raycast=function(t,e,n,i){return void 0===n&&(n=l8.Closest),void 0===i&&(i=4294967295),this.physicsWorld.raycast(t,e,n,i)},n.testPoint=function(t){return this.physicsWorld.testPoint(t)},n.testAABB=function(t){return this.physicsWorld.testAABB(t)},K(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this.physicsWorld.setAllowSleep(t)}},{key:"gravity",get:function(){return this._gravity},set:function(t){this._gravity.set(t),this.physicsWorld.setGravity(new Xn(t.x/f8,t.y/f8))}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(t){this._maxSubSteps=t}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=t}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(t){this._autoSimulation=t}},{key:"debugDrawFlags",get:function(){return this.physicsWorld.debugDrawFlags},set:function(t){this.physicsWorld.debugDrawFlags=t}},{key:"stepping",get:function(){return this._steping}}],[{key:"PHYSICS_NONE",get:function(){return!$5}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===$5}},{key:"PHYSICS_BOX2D",get:function(){return"box2d"===$5}},{key:"PhysicsGroup",get:function(){return c8}},{key:"instance",get:function(){return l6||(l6=new e),l6}}]),e}(Zl(bB)));u6.ID="PHYSICS_2D",zB.once(FB.EVENT_INIT,(function(){u6.PHYSICS_NONE||zB.registerSystem(u6.ID,u6.instance,bB.Priority.LOW)})),function(t){t[t.Circles=0]="Circles",t[t.FaceA=1]="FaceA",t[t.FaceB=2]="FaceB"}(H8||(H8=t("Physics2DManifoldType",{})));var h6,_6,f6,d6,p6,m6,v6,g6,y6,x6,S6,A6,C6,b6,T6,E6,w6,P6,I6,R6,D6,M6,B6,O6,N6,L6,F6,z6,V6,k6,G6,U6,H6,j6,W6,q6,X6,Y6,K6,J6,Q6,Z6,$6,t7,e7,n7,i7,r7,o7,a7,s7,c7,l7,u7,h7,_7,f7,d7,p7,m7,v7,g7,y7,x7,S7,A7,C7,b7,T7,E7,w7,P7,I7,R7,D7,M7,B7,O7,N7,L7,F7,z7,V7,k7,G7,U7,H7,j7,W7,q7,X7,Y7,K7=vc,J7=Xc,Q7=Tc,Z7=t("RigidBody2D",(j8=fc("cc.RigidBody2D"),W8=Q7(),q8=J7(k8),X8=J7(o8),j8(Y8=W8((st((K8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"enabledContactListener",J8,it(e)),at(e,"bullet",Q8,it(e)),at(e,"awakeOnLoad",Z8,it(e)),e._body=null,at(e,"_group",$8,it(e)),at(e,"_type",t6,it(e)),at(e,"_allowSleep",e6,it(e)),at(e,"_gravityScale",n6,it(e)),at(e,"_linearDamping",i6,it(e)),at(e,"_angularDamping",r6,it(e)),at(e,"_linearVelocity",o6,it(e)),at(e,"_angularVelocity",a6,it(e)),at(e,"_fixedRotation",s6,it(e)),e}Q(e,t);var n=e.prototype;return n.isAwake=function(){return!!this._body&&this._body.isAwake},n.wakeUp=function(){this._body&&this._body.wakeUp()},n.sleep=function(){this._body&&this._body.sleep()},n.getMass=function(){return this._body?this._body.getMass():0},n.applyForce=function(t,e,n){this._body&&this._body.applyForce(t,e,n)},n.applyForceToCenter=function(t,e){this._body&&this._body.applyForceToCenter(t,e)},n.applyTorque=function(t,e){this._body&&this._body.applyTorque(t,e)},n.applyLinearImpulse=function(t,e,n){this._body&&this._body.applyLinearImpulse(t,e,n)},n.applyLinearImpulseToCenter=function(t,e){this._body&&this._body.applyLinearImpulseToCenter(t,e)},n.applyAngularImpulse=function(t,e){this._body&&this._body.applyAngularImpulse(t,e)},n.getLinearVelocityFromWorldPoint=function(t,e){return this._body?this._body.getLinearVelocityFromWorldPoint(t,e):e},n.getLocalVector=function(t,e){return this._body?this._body.getLocalVector(t,e):e},n.getWorldVector=function(t,e){return this._body?this._body.getWorldVector(t,e):e},n.getLocalPoint=function(t,e){return this._body?this._body.getLocalPoint(t,e):e},n.getWorldPoint=function(t,e){return this._body?this._body.getWorldPoint(t,e):e},n.getLocalCenter=function(t){return this._body?this._body.getLocalCenter(t):t},n.getWorldCenter=function(t){return this._body?this._body.getWorldCenter(t):t},n.getInertia=function(){return this._body&&this._body.getInertia(),0},n.onLoad=function(){this._body=c._global.CC_PHYSICS_2D_BUILTIN?B8:new Z5.RigidBody,this._body.initialize(this)},n.onEnable=function(){this._body&&this._body.onEnable()},n.onDisable=function(){this._body&&this._body.onDisable()},n.onDestroy=function(){this._body&&this._body.onDestroy()},K(e,[{key:"group",get:function(){return this._group},set:function(t){this._group=t}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._body&&(t===o8.Animated?this._body.setType(o8.Kinematic):this._body.setType(t))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this._body&&this._body.setAllowSleep(t)}},{key:"gravityScale",get:function(){return this._gravityScale},set:function(t){this._gravityScale=t,this._body&&this._body.setGravityScale(t)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(t){this._linearDamping=t,this._body&&this._body.setLinearDamping(t)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(t){this._angularDamping=t,this._body&&this._body.setAngularDamping(t)}},{key:"linearVelocity",get:function(){return this._body&&this._body.getLinearVelocity(this._linearVelocity),this._linearVelocity},set:function(t){this._linearVelocity=t,this._body&&this._body.setLinearVelocity(t)}},{key:"angularVelocity",get:function(){return this._body&&(this._angularVelocity=this._body.getAngularVelocity()),this._angularVelocity},set:function(t){this._angularVelocity=t,this._body&&this._body.setAngularVelocity(t)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(t){this._fixedRotation=t,this._body&&this._body.setFixedRotation(t)}},{key:"impl",get:function(){return this._body}}]),e}(Qu)).prototype,"group",[q8],Object.getOwnPropertyDescriptor(K8.prototype,"group"),K8.prototype),J8=st(K8.prototype,"enabledContactListener",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Q8=st(K8.prototype,"bullet",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),st(K8.prototype,"type",[X8],Object.getOwnPropertyDescriptor(K8.prototype,"type"),K8.prototype),st(K8.prototype,"allowSleep",[K7],Object.getOwnPropertyDescriptor(K8.prototype,"allowSleep"),K8.prototype),st(K8.prototype,"gravityScale",[K7],Object.getOwnPropertyDescriptor(K8.prototype,"gravityScale"),K8.prototype),st(K8.prototype,"linearDamping",[K7],Object.getOwnPropertyDescriptor(K8.prototype,"linearDamping"),K8.prototype),st(K8.prototype,"angularDamping",[K7],Object.getOwnPropertyDescriptor(K8.prototype,"angularDamping"),K8.prototype),st(K8.prototype,"linearVelocity",[K7],Object.getOwnPropertyDescriptor(K8.prototype,"linearVelocity"),K8.prototype),st(K8.prototype,"angularVelocity",[K7],Object.getOwnPropertyDescriptor(K8.prototype,"angularVelocity"),K8.prototype),st(K8.prototype,"fixedRotation",[K7],Object.getOwnPropertyDescriptor(K8.prototype,"fixedRotation"),K8.prototype),Z8=st(K8.prototype,"awakeOnLoad",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$8=st(K8.prototype,"_group",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k8.DEFAULT}}),t6=st(K8.prototype,"_type",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return o8.Dynamic}}),e6=st(K8.prototype,"_allowSleep",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),n6=st(K8.prototype,"_gravityScale",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),i6=st(K8.prototype,"_linearDamping",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),r6=st(K8.prototype,"_angularDamping",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),o6=st(K8.prototype,"_linearVelocity",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn}}),a6=st(K8.prototype,"_angularVelocity",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),s6=st(K8.prototype,"_fixedRotation",[K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y8=K8))||Y8)||Y8)),$7=t("Collider2D",(h6=fc("cc.Collider2D"),_6=Xc(k8),h6((C6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"editing",p6,it(e)),at(e,"tag",m6,it(e)),e.TYPE=a8.None,e._shape=null,e._body=null,at(e,"_group",v6,it(e)),at(e,"_density",g6,it(e)),at(e,"_sensor",y6,it(e)),at(e,"_friction",x6,it(e)),at(e,"_restitution",S6,it(e)),at(e,"_offset",A6,it(e)),e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._shape=function(t){return O8.INITED||(O8.INITED=!0,O8[a8.BOX]=function(){return new Z5.BoxShape},O8[a8.CIRCLE]=function(){return new Z5.CircleShape},O8[a8.POLYGON]=function(){return new Z5.PolygonShape}),O8[t]()}(this.TYPE),this._shape.initialize(this),this._shape.onLoad&&this._shape.onLoad(),this._body=this.getComponent(Z7)},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&this._shape.onDestroy&&this._shape.onDestroy()},n.apply=function(){this._shape&&this._shape.apply&&this._shape.apply()},K(e,[{key:"group",get:function(){return this._group},set:function(t){this._group=t,this._shape&&this._shape.onGroupChanged&&this._shape.onGroupChanged()}},{key:"density",get:function(){return this._density},set:function(t){this._density=t}},{key:"sensor",get:function(){return this._sensor},set:function(t){this._sensor=t}},{key:"friction",get:function(){return this._friction},set:function(t){this._friction=t}},{key:"restitution",get:function(){return this._restitution},set:function(t){this._restitution=t}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset=t}},{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._shape}},{key:"worldAABB",get:function(){return this._shape?this._shape.worldAABB:new ni}}]),e}(Zl(Qu)),p6=st((d6=C6).prototype,"editing",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m6=st(d6.prototype,"tag",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),st(d6.prototype,"group",[_6],Object.getOwnPropertyDescriptor(d6.prototype,"group"),d6.prototype),st(d6.prototype,"density",[vc],Object.getOwnPropertyDescriptor(d6.prototype,"density"),d6.prototype),st(d6.prototype,"sensor",[vc],Object.getOwnPropertyDescriptor(d6.prototype,"sensor"),d6.prototype),st(d6.prototype,"friction",[vc],Object.getOwnPropertyDescriptor(d6.prototype,"friction"),d6.prototype),st(d6.prototype,"restitution",[vc],Object.getOwnPropertyDescriptor(d6.prototype,"restitution"),d6.prototype),st(d6.prototype,"offset",[vc],Object.getOwnPropertyDescriptor(d6.prototype,"offset"),d6.prototype),v6=st(d6.prototype,"_group",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k8.DEFAULT}}),g6=st(d6.prototype,"_density",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),y6=st(d6.prototype,"_sensor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),x6=st(d6.prototype,"_friction",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.2}}),S6=st(d6.prototype,"_restitution",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A6=st(d6.prototype,"_offset",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn}}),f6=d6))||f6)),t9=(t("BoxCollider2D",fc("cc.BoxCollider2D")(b6=Tc()((w6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_size",E6,it(e)),e.TYPE=a8.BOX,e}return Q(e,t),K(e,[{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),e}($7),E6=st((T6=w6).prototype,"_size",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(1,1)}}),st(T6.prototype,"size",[vc],Object.getOwnPropertyDescriptor(T6.prototype,"size"),T6.prototype),b6=T6))||b6)||b6),t("CircleCollider2D",fc("cc.CircleCollider2D")(P6=Tc()((D6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_radius",R6,it(e)),e.TYPE=a8.CIRCLE,e}return Q(e,t),K(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t<0?0:t}},{key:"worldPosition",get:function(){return this._shape?this._shape.worldPosition:new Xn}},{key:"worldRadius",get:function(){return this._shape?this._shape.worldRadius:0}}]),e}($7),R6=st((I6=D6).prototype,"_radius",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),st(I6.prototype,"radius",[vc],Object.getOwnPropertyDescriptor(I6.prototype,"radius"),I6.prototype),P6=I6))||P6)||P6),t("PolygonCollider2D",(M6=fc("cc.PolygonCollider2D"),B6=Tc(),O6=vc({serializable:!1,displayOrder:0}),N6=vc({type:Xn}),M6(L6=B6((k6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"threshold",z6,it(e)),at(e,"_points",V6,it(e)),e.TYPE=a8.POLYGON,e}return Q(e,t),K(e,[{key:"points",get:function(){return this._points},set:function(t){this._points=t}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),e}($7),z6=st((F6=k6).prototype,"threshold",[O6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),V6=st(F6.prototype,"_points",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new Xn(-1,-1),new Xn(1,-1),new Xn(1,1),new Xn(-1,1)]}}),st(F6.prototype,"points",[N6],Object.getOwnPropertyDescriptor(F6.prototype,"points"),F6.prototype),L6=F6))||L6)||L6)),t("Joint2D",(G6=fc("cc.Joint2D"),U6=Xc(Z7),G6((K6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"anchor",W6,it(e)),at(e,"connectedAnchor",q6,it(e)),at(e,"collideConnected",X6,it(e)),at(e,"connectedBody",Y6,it(e)),e._body=null,e._joint=null,e.TYPE=s8.None,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._joint=function(t){return function(){if(!G8.INITED){G8.INITED=!0;var t=c._global.CC_PHYSICS_2D_BUILTIN;G8[s8.SPRING]=function(){return t?U8:new Z5.SpringJoint},G8[s8.DISTANCE]=function(){return t?U8:new Z5.DistanceJoint},G8[s8.FIXED]=function(){return t?U8:new Z5.FixedJoint},G8[s8.MOUSE]=function(){return t?U8:new Z5.MouseJoint},G8[s8.RELATIVE]=function(){return t?U8:new Z5.RelativeJoint},G8[s8.SLIDER]=function(){return t?U8:new Z5.SliderJoint},G8[s8.WHEEL]=function(){return t?U8:new Z5.WheelJoint},G8[s8.HINGE]=function(){return t?U8:new Z5.HingeJoint}}}(),G8[t]()}(this.TYPE),this._joint.initialize(this),this._body=this.getComponent(Z7)},n.onEnable=function(){this._joint&&this._joint.onEnable&&this._joint.onEnable()},n.onDisable=function(){this._joint&&this._joint.onDisable&&this._joint.onDisable()},n.start=function(){this._joint&&this._joint.start&&this._joint.start()},n.onDestroy=function(){this._joint&&this._joint.onDestroy&&this._joint.onDestroy()},K(e,[{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._joint}}]),e}(Qu),W6=st((j6=K6).prototype,"anchor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn}}),q6=st(j6.prototype,"connectedAnchor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn}}),X6=st(j6.prototype,"collideConnected",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y6=st(j6.prototype,"connectedBody",[U6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H6=j6))||H6))),e9=(t("DistanceJoint2D",fc("cc.DistanceJoint2D")(J6=Tc()((st((Q6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=s8.DISTANCE,at(e,"_maxLength",Z6,it(e)),at(e,"_autoCalcDistance",$6,it(e)),e}return Q(e,t),K(e,[{key:"maxLength",get:function(){return this._autoCalcDistance&&this.connectedBody?Pn.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._maxLength},set:function(t){this._maxLength=t,this._joint&&this._joint.setMaxLength(t)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(t){this._autoCalcDistance=t}}]),e}(t9)).prototype,"maxLength",[vc],Object.getOwnPropertyDescriptor(Q6.prototype,"maxLength"),Q6.prototype),st(Q6.prototype,"autoCalcDistance",[vc],Object.getOwnPropertyDescriptor(Q6.prototype,"autoCalcDistance"),Q6.prototype),Z6=st(Q6.prototype,"_maxLength",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),$6=st(Q6.prototype,"_autoCalcDistance",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),J6=Q6))||J6)||J6),t("SpringJoint2D",fc("cc.SpringJoint2D")(t7=Tc()((st((e7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=s8.SPRING,at(e,"_frequency",n7,it(e)),at(e,"_dampingRatio",i7,it(e)),at(e,"_distance",r7,it(e)),at(e,"_autoCalcDistance",o7,it(e)),e}return Q(e,t),K(e,[{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}},{key:"distance",get:function(){return this._autoCalcDistance&&this.connectedBody?Pn.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._distance},set:function(t){this._distance=t,this._joint&&this._joint.setDistance(t)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(t){this._autoCalcDistance=t}}]),e}(t9)).prototype,"frequency",[vc],Object.getOwnPropertyDescriptor(e7.prototype,"frequency"),e7.prototype),st(e7.prototype,"dampingRatio",[vc],Object.getOwnPropertyDescriptor(e7.prototype,"dampingRatio"),e7.prototype),st(e7.prototype,"distance",[vc],Object.getOwnPropertyDescriptor(e7.prototype,"distance"),e7.prototype),st(e7.prototype,"autoCalcDistance",[vc],Object.getOwnPropertyDescriptor(e7.prototype,"autoCalcDistance"),e7.prototype),n7=st(e7.prototype,"_frequency",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),i7=st(e7.prototype,"_dampingRatio",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),r7=st(e7.prototype,"_distance",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),o7=st(e7.prototype,"_autoCalcDistance",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),t7=e7))||t7)||t7),t("MouseJoint2D",fc("cc.MouseJoint2D")(a7=Tc()((st((s7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=s8.MOUSE,at(e,"_maxForce",c7,it(e)),at(e,"_dampingRatio",l7,it(e)),at(e,"_frequency",u7,it(e)),e._target=new Xn,e}return Q(e,t),e.prototype.update=function(t){this._joint.update(t)},K(e,[{key:"target",get:function(){return this._target},set:function(t){this._target=t,this._joint&&this._joint.setTarget(t)}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}},{key:"maxForce",get:function(){return this._maxForce},set:function(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}}]),e}(t9)).prototype,"frequency",[vc],Object.getOwnPropertyDescriptor(s7.prototype,"frequency"),s7.prototype),st(s7.prototype,"dampingRatio",[vc],Object.getOwnPropertyDescriptor(s7.prototype,"dampingRatio"),s7.prototype),st(s7.prototype,"maxForce",[vc],Object.getOwnPropertyDescriptor(s7.prototype,"maxForce"),s7.prototype),c7=st(s7.prototype,"_maxForce",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),l7=st(s7.prototype,"_dampingRatio",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),u7=st(s7.prototype,"_frequency",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),a7=s7))||a7)||a7),new Pn),n9=new Pn,i9=(t("RelativeJoint2D",fc("cc.RelativeJoint2D")(h7=Tc()((st((_7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=s8.RELATIVE,at(e,"_maxForce",f7,it(e)),at(e,"_maxTorque",d7,it(e)),at(e,"_correctionFactor",p7,it(e)),at(e,"_angularOffset",m7,it(e)),at(e,"_linearOffset",v7,it(e)),at(e,"_autoCalcOffset",g7,it(e)),e}return Q(e,t),K(e,[{key:"maxForce",get:function(){return this._maxForce},set:function(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}},{key:"maxTorque",get:function(){return this._maxTorque},set:function(t){this._maxTorque=t,this._joint&&this._joint.setMaxTorque(t)}},{key:"correctionFactor",get:function(){return this._correctionFactor},set:function(t){this._correctionFactor=t,this._joint&&this._joint.setCorrectionFactor(t)}},{key:"linearOffset",get:function(){return this._autoCalcOffset&&this.connectedBody?Xn.subtract(this._linearOffset,this.connectedBody.node.worldPosition,this.node.worldPosition):this._linearOffset},set:function(t){this._linearOffset.set(t),this._joint&&this._joint.setLinearOffset(t)}},{key:"angularOffset",get:function(){return this._autoCalcOffset&&this.connectedBody&&(Nn.toEuler(e9,this.node.worldRotation),Nn.toEuler(n9,this.connectedBody.node.worldRotation),this._angularOffset=n9.z-e9.z),this._angularOffset},set:function(t){this._angularOffset=t,this._joint&&this._joint.setAngularOffset(t)}},{key:"autoCalcOffset",get:function(){return this._autoCalcOffset},set:function(t){this._autoCalcOffset=t}}]),e}(t9)).prototype,"maxForce",[vc],Object.getOwnPropertyDescriptor(_7.prototype,"maxForce"),_7.prototype),st(_7.prototype,"maxTorque",[vc],Object.getOwnPropertyDescriptor(_7.prototype,"maxTorque"),_7.prototype),st(_7.prototype,"correctionFactor",[vc],Object.getOwnPropertyDescriptor(_7.prototype,"correctionFactor"),_7.prototype),st(_7.prototype,"linearOffset",[vc],Object.getOwnPropertyDescriptor(_7.prototype,"linearOffset"),_7.prototype),st(_7.prototype,"angularOffset",[vc],Object.getOwnPropertyDescriptor(_7.prototype,"angularOffset"),_7.prototype),st(_7.prototype,"autoCalcOffset",[vc],Object.getOwnPropertyDescriptor(_7.prototype,"autoCalcOffset"),_7.prototype),f7=st(_7.prototype,"_maxForce",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),d7=st(_7.prototype,"_maxTorque",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),p7=st(_7.prototype,"_correctionFactor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),m7=st(_7.prototype,"_angularOffset",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v7=st(_7.prototype,"_linearOffset",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn}}),g7=st(_7.prototype,"_autoCalcOffset",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),h7=_7))||h7)||h7),new Xn),r9=(t("SliderJoint2D",fc("cc.SliderJoint2D")(y7=Tc()((st((x7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=s8.SLIDER,at(e,"_angle",S7,it(e)),at(e,"_autoCalcAngle",A7,it(e)),at(e,"_enableMotor",C7,it(e)),at(e,"_maxMotorForce",b7,it(e)),at(e,"_motorSpeed",T7,it(e)),at(e,"_enableLimit",E7,it(e)),at(e,"_lowerLimit",w7,it(e)),at(e,"_upperLimit",P7,it(e)),e}return Q(e,t),K(e,[{key:"angle",get:function(){return this._autoCalcAngle&&this.connectedBody&&(Xn.subtract(i9,this.connectedBody.node.worldPosition,this.node.worldPosition),this._angle=hn(Math.atan2(i9.y,i9.x))),this._angle},set:function(t){this._angle=t}},{key:"autoCalcAngle",get:function(){return this._autoCalcAngle},set:function(t){this._autoCalcAngle=t}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t}},{key:"maxMotorForce",get:function(){return this._maxMotorForce},set:function(t){this._maxMotorForce=t,this._joint&&this._joint.setMaxMotorForce(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}},{key:"enableLimit",get:function(){return this._enableLimit},set:function(t){this._enableLimit=t}},{key:"lowerLimit",get:function(){return this._lowerLimit},set:function(t){this._lowerLimit=t,this._joint&&this._joint.setLowerLimit(t)}},{key:"upperLimit",get:function(){return this._upperLimit},set:function(t){this._upperLimit=t,this._joint&&this._joint.setUpperLimit(t)}}]),e}(t9)).prototype,"angle",[vc],Object.getOwnPropertyDescriptor(x7.prototype,"angle"),x7.prototype),st(x7.prototype,"autoCalcAngle",[vc],Object.getOwnPropertyDescriptor(x7.prototype,"autoCalcAngle"),x7.prototype),st(x7.prototype,"enableMotor",[vc],Object.getOwnPropertyDescriptor(x7.prototype,"enableMotor"),x7.prototype),st(x7.prototype,"maxMotorForce",[vc],Object.getOwnPropertyDescriptor(x7.prototype,"maxMotorForce"),x7.prototype),st(x7.prototype,"motorSpeed",[vc],Object.getOwnPropertyDescriptor(x7.prototype,"motorSpeed"),x7.prototype),st(x7.prototype,"enableLimit",[vc],Object.getOwnPropertyDescriptor(x7.prototype,"enableLimit"),x7.prototype),st(x7.prototype,"lowerLimit",[vc],Object.getOwnPropertyDescriptor(x7.prototype,"lowerLimit"),x7.prototype),st(x7.prototype,"upperLimit",[vc],Object.getOwnPropertyDescriptor(x7.prototype,"upperLimit"),x7.prototype),S7=st(x7.prototype,"_angle",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A7=st(x7.prototype,"_autoCalcAngle",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),C7=st(x7.prototype,"_enableMotor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),b7=st(x7.prototype,"_maxMotorForce",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),T7=st(x7.prototype,"_motorSpeed",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),E7=st(x7.prototype,"_enableLimit",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),w7=st(x7.prototype,"_lowerLimit",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),P7=st(x7.prototype,"_upperLimit",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y7=x7))||y7)||y7),t("FixedJoint2D",fc("cc.FixedJoint2D")(I7=Tc()((st((R7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=s8.FIXED,at(e,"_frequency",D7,it(e)),at(e,"_dampingRatio",M7,it(e)),e}return Q(e,t),K(e,[{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}]),e}(t9)).prototype,"frequency",[vc],Object.getOwnPropertyDescriptor(R7.prototype,"frequency"),R7.prototype),st(R7.prototype,"dampingRatio",[vc],Object.getOwnPropertyDescriptor(R7.prototype,"dampingRatio"),R7.prototype),D7=st(R7.prototype,"_frequency",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),M7=st(R7.prototype,"_dampingRatio",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),I7=R7))||I7)||I7),t("WheelJoint2D",fc("cc.WheelJoint2D")(B7=Tc()((st((O7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=s8.WHEEL,at(e,"_angle",N7,it(e)),at(e,"_enableMotor",L7,it(e)),at(e,"_maxMotorTorque",F7,it(e)),at(e,"_motorSpeed",z7,it(e)),at(e,"_frequency",V7,it(e)),at(e,"_dampingRatio",k7,it(e)),e}return Q(e,t),K(e,[{key:"angle",get:function(){return this._angle},set:function(t){this._angle=t}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}]),e}(t9)).prototype,"angle",[vc],Object.getOwnPropertyDescriptor(O7.prototype,"angle"),O7.prototype),st(O7.prototype,"enableMotor",[vc],Object.getOwnPropertyDescriptor(O7.prototype,"enableMotor"),O7.prototype),st(O7.prototype,"maxMotorTorque",[vc],Object.getOwnPropertyDescriptor(O7.prototype,"maxMotorTorque"),O7.prototype),st(O7.prototype,"motorSpeed",[vc],Object.getOwnPropertyDescriptor(O7.prototype,"motorSpeed"),O7.prototype),st(O7.prototype,"frequency",[vc],Object.getOwnPropertyDescriptor(O7.prototype,"frequency"),O7.prototype),st(O7.prototype,"dampingRatio",[vc],Object.getOwnPropertyDescriptor(O7.prototype,"dampingRatio"),O7.prototype),N7=st(O7.prototype,"_angle",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),L7=st(O7.prototype,"_enableMotor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),F7=st(O7.prototype,"_maxMotorTorque",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),z7=st(O7.prototype,"_motorSpeed",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),V7=st(O7.prototype,"_frequency",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),k7=st(O7.prototype,"_dampingRatio",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),B7=O7))||B7)||B7),t("HingeJoint2D",fc("cc.HingeJoint2D")(G7=Tc()((st((U7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=s8.HINGE,at(e,"_enableLimit",H7,it(e)),at(e,"_lowerAngle",j7,it(e)),at(e,"_upperAngle",W7,it(e)),at(e,"_enableMotor",q7,it(e)),at(e,"_maxMotorTorque",X7,it(e)),at(e,"_motorSpeed",Y7,it(e)),e}return Q(e,t),K(e,[{key:"enableLimit",get:function(){return this._enableLimit},set:function(t){this._enableLimit=t}},{key:"lowerAngle",get:function(){return this._lowerAngle},set:function(t){this._lowerAngle=t,this._joint&&this._joint.setLowerAngle(t)}},{key:"upperAngle",get:function(){return this._upperAngle},set:function(t){this._upperAngle=t,this._joint&&this._joint.setUpperAngle(t)}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}}]),e}(t9)).prototype,"enableLimit",[vc],Object.getOwnPropertyDescriptor(U7.prototype,"enableLimit"),U7.prototype),st(U7.prototype,"lowerAngle",[vc],Object.getOwnPropertyDescriptor(U7.prototype,"lowerAngle"),U7.prototype),st(U7.prototype,"upperAngle",[vc],Object.getOwnPropertyDescriptor(U7.prototype,"upperAngle"),U7.prototype),st(U7.prototype,"enableMotor",[vc],Object.getOwnPropertyDescriptor(U7.prototype,"enableMotor"),U7.prototype),st(U7.prototype,"maxMotorTorque",[vc],Object.getOwnPropertyDescriptor(U7.prototype,"maxMotorTorque"),U7.prototype),st(U7.prototype,"motorSpeed",[vc],Object.getOwnPropertyDescriptor(U7.prototype,"motorSpeed"),U7.prototype),H7=st(U7.prototype,"_enableLimit",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),j7=st(U7.prototype,"_lowerAngle",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),W7=st(U7.prototype,"_upperAngle",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),q7=st(U7.prototype,"_enableMotor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X7=st(U7.prototype,"_maxMotorTorque",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),Y7=st(U7.prototype,"_motorSpeed",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),G7=U7))||G7)||G7),t("Physics2DUtils",{PolygonSeparator:D8}),function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._type=l8.Closest,e._fixtures=[],e._points=[],e._normals=[],e._fractions=[],e._mask=4294967295,e}Q(e,t);var n=e.prototype;return n.init=function(t,e){this._type=t,this._mask=e,this._fixtures.length=0,this._points.length=0,this._normals.length=0,this._fractions.length=0},n.ReportFixture=function(t,e,n,i){return 0==(t.GetFilterData().categoryBits&this._mask)?0:this._type===l8.Closest?(this._fixtures[0]=t,this._points[0]=e,this._normals[0]=n,this._fractions[0]=i,i):(this._fixtures.push(t),this._points.push(new Xn(e.x,e.y)),this._normals.push(new Xn(n.x,n.y)),this._fractions.push(i),this._type===l8.Any?0:this._type>=l8.All?1:i)},n.getFixtures=function(){return this._fixtures},n.getPoints=function(){return this._points},n.getNormals=function(){return this._normals},n.getFractions=function(){return this._fractions},e}(u8.RayCastCallback)),o9=[],a9=[new Xn,new Xn],s9=new u8.WorldManifold,c9={points:[],separations:[],normal:new Xn},l9=function(){this.localPoint=new Xn,this.normalImpulse=0,this.tangentImpulse=0},u9=[new l9,new l9],h9={type:0,localPoint:new Xn,localNormal:new Xn,points:[]},_9={normalImpulses:[],tangentImpulses:[]},f9=function(){function t(){this.colliderA=null,this.colliderB=null,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=null}t.get=function(e){var n=o9.pop();return n||(n=new t),n.init(e),n},t.put=function(t){var e=t.m_userData;e&&(o9.push(e),e.reset())};var e=t.prototype;return e._setImpulse=function(t){this._impulse=t},e.init=function(t){this.colliderA=t.m_fixtureA.m_userData.collider,this.colliderB=t.m_fixtureB.m_userData.collider,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=t,t.m_userData=this},e.reset=function(){this.setTangentSpeed(0),this.resetFriction(),this.resetRestitution(),this.colliderA=null,this.colliderB=null,this.disabled=!1,this._impulse=null,this._b2contact.m_userData=null,this._b2contact=null},e.getWorldManifold=function(){var t=c9.points,e=c9.separations,n=c9.normal;this._b2contact.GetWorldManifold(s9);var i=s9.points,r=s9.separations,o=this._b2contact.GetManifold().pointCount;t.length=e.length=o;for(var a=0;a<o;a++){var s=a9[a];s.x=i[a].x*f8,s.y=i[a].y*f8,t[a]=s,e[a]=r[a]*f8}return n.x=s9.normal.x,n.y=s9.normal.y,this._inverted&&(n.x*=-1,n.y*=-1),c9},e.getManifold=function(){for(var t=h9.points,e=h9.localNormal,n=h9.localPoint,i=this._b2contact.GetManifold(),r=i.points,o=t.length=i.pointCount,a=0;a<o;a++){var s=u9[a],c=r[a];s.localPoint.x=c.localPoint.x*f8,s.localPoint.y=c.localPoint.y*f8,s.normalImpulse=c.normalImpulse*f8,s.tangentImpulse=c.tangentImpulse,t[a]=s}return n.x=i.localPoint.x*f8,n.y=i.localPoint.y*f8,e.x=i.localNormal.x,e.y=i.localNormal.y,h9.type=i.type,this._inverted&&(e.x*=-1,e.y*=-1),h9},e.getImpulse=function(){var t=this._impulse;if(!t)return null;for(var e=_9.normalImpulses,n=_9.tangentImpulses,i=t.count,r=0;r<i;r++)e[r]=t.normalImpulses[r]*f8,n[r]=t.tangentImpulses[r];return n.length=e.length=i,_9},e.emit=function(t){var e=this.colliderA,n=this.colliderB,i=e.body,r=n.body;i.enabledContactListener&&(null==e||e.emit(t,e,n,this)),r.enabledContactListener&&(null==n||n.emit(t,n,e,this)),(i.enabledContactListener||r.enabledContactListener)&&u6.instance.emit(t,e,n,this),(this.disabled||this.disabledOnce)&&(this.setEnabled(!1),this.disabledOnce=!1)},e.setEnabled=function(t){this._b2contact.SetEnabled(t)},e.isTouching=function(){return this._b2contact.IsTouching()},e.setTangentSpeed=function(t){this._b2contact.SetTangentSpeed(t)},e.getTangentSpeed=function(){return this._b2contact.GetTangentSpeed()},e.setFriction=function(t){this._b2contact.SetFriction(t)},e.getFriction=function(){return this._b2contact.GetFriction()},e.resetFriction=function(){return this._b2contact.ResetFriction()},e.setRestitution=function(t){this._b2contact.SetRestitution(t)},e.getRestitution=function(){return this._b2contact.GetRestitution()},e.resetRestitution=function(){return this._b2contact.ResetRestitution()},t}(),d9=new u8.Vec2,p9=new En,m9=En.GREEN,v9=En.RED,g9=function(t){function e(e){var n;return(n=t.call(this)||this)._drawer=null,n._xf=new u8.Transform,n._dxf=new u8.Transform,n._drawer=e,n}Q(e,t);var n=e.prototype;return n._DrawPolygon=function(t,e){for(var n=this._drawer,i=0;i<e;i++){u8.Transform.MulXV(this._xf,t[i],d9);var r=d9.x*f8,o=d9.y*f8;0===i?n.moveTo(r,o):n.lineTo(r,o)}n.close()},n.DrawPolygon=function(t,e,n){this._applyStrokeColor(n),this._DrawPolygon(t,e),this._drawer.stroke()},n.DrawSolidPolygon=function(t,e,n){this._applyFillColor(n),this._DrawPolygon(t,e),this._drawer.fill(),this._drawer.stroke()},n._DrawCircle=function(t,e){var n=this._xf.p;this._drawer.circle((t.x+n.x)*f8,(t.y+n.y)*f8,e*f8)},n.DrawCircle=function(t,e,n){this._applyStrokeColor(n),this._DrawCircle(t,e),this._drawer.stroke()},n.DrawSolidCircle=function(t,e,n,i){this._applyFillColor(i),this._DrawCircle(t,e),this._drawer.fill()},n.DrawSegment=function(t,e,n){var i=this._drawer;if(t.x===e.x&&t.y===e.y)return this._applyFillColor(n),this._DrawCircle(t,2/f8),void i.fill();this._applyStrokeColor(n),u8.Transform.MulXV(this._xf,t,d9),i.moveTo(d9.x*f8,d9.y*f8),u8.Transform.MulXV(this._xf,e,d9),i.lineTo(d9.x*f8,d9.y*f8),i.stroke()},n.DrawTransform=function(t){var e=this._drawer;e.strokeColor=v9,d9.x=d9.y=0,u8.Transform.MulXV(t,d9,d9),e.moveTo(d9.x*f8,d9.y*f8),d9.x=1,d9.y=0,u8.Transform.MulXV(t,d9,d9),e.lineTo(d9.x*f8,d9.y*f8),e.stroke(),e.strokeColor=m9,d9.x=d9.y=0,u8.Transform.MulXV(t,d9,d9),e.moveTo(d9.x*f8,d9.y*f8),d9.x=0,d9.y=1,u8.Transform.MulXV(t,d9,d9),e.lineTo(d9.x*f8,d9.y*f8),e.stroke()},n.DrawPoint=function(){},n.DrawParticles=function(){},n._applyStrokeColor=function(t){this._drawer.strokeColor=p9.set(255*t.r,255*t.g,255*t.b,150)},n._applyFillColor=function(t){this._drawer.fillColor=p9.set(255*t.r,255*t.g,255*t.b,150)},n.PushTransform=function(t){this._xf=t},n.PopTransform=function(){this._xf=this._dxf},e}(u8.Draw),y9=new Pn,x9=new Xn,S9=new Xn,A9=new u8.BodyDef,C9=new u8.AABB,b9=[],T9=function(){function t(){this._world=void 0,this._bodies=[],this._animatedBodies=[],this._rotationAxis=new Pn,this._contactListener=void 0,this._aabbQueryCallback=void 0,this._raycastQueryCallback=void 0,this._debugGraphics=null,this._b2DebugDrawer=null,this._debugDrawFlags=0,this._world=new u8.World(new u8.Vec2(0,-10));var t=new d8;t.setBeginContact(this._onBeginContact),t.setEndContact(this._onEndContact),t.setPreSolve(this._onPreSolve),t.setPostSolve(this._onPostSolve),this._world.SetContactListener(t),this._contactListener=t,this._aabbQueryCallback=new p8,this._raycastQueryCallback=new r9}var e=t.prototype;return e._checkDebugDrawValid=function(){if(!this._debugGraphics||!this._debugGraphics.isValid){var t=vD("Canvas");if(!t){var e=zB.getScene();if(!e)return;(t=new kT("Canvas")).addComponent(qZ),t.parent=e}var n=new kT("PHYSICS_2D_DEBUG_DRAW");n.hideFlags|=_l.Flags.DontSave,n.parent=t,n.worldPosition=Pn.ZERO,n.layer=Md.Enum.UI_2D,this._debugGraphics=n.addComponent(wJ),this._debugGraphics.lineWidth=2;var i=new g9(this._debugGraphics);this._b2DebugDrawer=i,this._world.SetDebugDraw(i)}var r=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(r.children.length-1),this._b2DebugDrawer&&this._b2DebugDrawer.SetFlags(this.debugDrawFlags)},e.setGravity=function(t){this._world.SetGravity(t)},e.setAllowSleep=function(){this._world.SetAllowSleeping(!0)},e.step=function(t,e,n){void 0===e&&(e=10),void 0===n&&(n=10);for(var i=this._animatedBodies,r=0,o=i.length;r<o;r++)i[r].animate(t);this._world.Step(t,e,n)},e.raycast=function(t,e,n,i){if(t.equals(e))return[];n=n||l8.Closest,x9.x=t.x/f8,x9.y=t.y/f8,S9.x=e.x/f8,S9.y=e.y/f8;var r=this._raycastQueryCallback;r.init(n,i),this._world.RayCast(r,x9,S9);var o=r.getFixtures();if(o.length>0){for(var a=r.getPoints(),s=r.getNormals(),c=r.getFractions(),l=[],u=0,h=o.length;u<h;u++){var _=o[u],f=_.m_userData,d=f.collider;if(n===l8.AllClosest){for(var p=void 0,m=0;m<l.length;m++)l[m].collider===d&&(p=l[m]);if(p){c[u]<p.fraction&&(p.fixtureIndex=f.getFixtureIndex(_),p.point.x=a[u].x*f8,p.point.y=a[u].y*f8,p.normal.x=s[u].x,p.normal.y=s[u].y,p.fraction=c[u]);continue}}l.push({collider:d,fixtureIndex:f.getFixtureIndex(_),point:new Xn(a[u].x*f8,a[u].y*f8),normal:new Xn(s[u].x,s[u].y),fraction:c[u]})}return l}return[]},e.syncPhysicsToScene=function(){for(var t=this._bodies,e=0,n=t.length;e<n;e++){var i=t[e],r=i.rigidBody;if(r.type!==o8.Animated){var o=r.node,a=i.impl,s=a.GetPosition();y9.x=s.x*f8,y9.y=s.y*f8,y9.z=0,o.worldPosition=y9;var c=hn(a.GetAngle());o.setWorldRotationFromEuler(0,0,c)}else i.resetVelocity()}},e.syncSceneToPhysics=function(){for(var t=this._bodies,e=0;e<t.length;e++)t[e].syncRotationToPhysics(),t[e].syncPositionToPhysics()},e.addBody=function(t){if(!this._bodies.includes(t)){var e=A9,n=t.rigidBody;e.allowSleep=n.allowSleep,e.gravityScale=n.gravityScale,e.linearDamping=n.linearDamping,e.angularDamping=n.angularDamping,e.fixedRotation=n.fixedRotation,e.bullet=n.bullet;var i=n.node,r=i.worldPosition;e.position.Set(r.x/f8,r.y/f8),y9.z=Nn.getAxisAngle(this._rotationAxis,i.worldRotation),e.angle=y9.z,e.awake=n.awakeOnLoad,n.type===o8.Animated?(e.type=o8.Kinematic,this._animatedBodies.push(t),t._animatedPos.set(e.position.x,e.position.y),t._animatedAngle=e.angle):e.type=n.type;var o=n,a=o._linearVelocity;e.linearVelocity.Set(a.x,a.y),e.angularVelocity=un(o._angularVelocity);var s=this._world.CreateBody(e);s.m_userData=t,t._imp=s,this._bodies.push(t)}},e.removeBody=function(t){this._bodies.includes(t)&&(t.impl&&(t.impl.m_userData=null,this._world.DestroyBody(t.impl),t._imp=null),ee.remove(this._bodies,t),t.rigidBody.type===o8.Animated&&ee.remove(this._animatedBodies,t))},e.registerContactFixture=function(t){this._contactListener.registerContactFixture(t)},e.unregisterContactFixture=function(t){this._contactListener.unregisterContactFixture(t)},e.testPoint=function(t){var e=x9.x=t.x/f8,n=x9.y=t.y/f8,i=.2/f8;C9.lowerBound.x=e-i,C9.lowerBound.y=n-i,C9.upperBound.x=e+i,C9.upperBound.y=n+i;var r=this._aabbQueryCallback;r.init(x9),this._world.QueryAABB(r,C9);var o=r.getFixtures();b9.length=0;for(var a=0;a<o.length;a++){var s=o[a].m_userData.collider;b9.includes(s)||b9.push(s)}return b9},e.testAABB=function(t){C9.lowerBound.x=t.xMin/f8,C9.lowerBound.y=t.yMin/f8,C9.upperBound.x=t.xMax/f8,C9.upperBound.y=t.yMax/f8;var e=this._aabbQueryCallback;e.init(),this._world.QueryAABB(e,C9);var n=e.getFixtures();b9.length=0;for(var i=0;i<n.length;i++){var r=n[i].m_userData.collider;b9.includes(r)||b9.push(r)}return b9},e.drawDebug=function(){this._checkDebugDrawValid(),this._debugGraphics&&(this._debugGraphics.clear(),this._world.DrawDebugData())},e._onBeginContact=function(t){f9.get(t).emit(_8.BEGIN_CONTACT)},e._onEndContact=function(t){var e=t.m_userData;e&&(e.emit(_8.END_CONTACT),f9.put(t))},e._onPreSolve=function(t){var e=t.m_userData;e&&e.emit(_8.PRE_SOLVE)},e._onPostSolve=function(t,e){var n=t.m_userData;n&&(n._setImpulse(e),n.emit(_8.POST_SOLVE),n._setImpulse(null))},K(t,[{key:"impl",get:function(){return this._world}},{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(t){t||this._debugGraphics&&(this._debugGraphics.node.parent=null),this._debugDrawFlags=t}}]),t}(),E9=(new Pn,new u8.Vec2),w9=function(){function t(){this._animatedPos=new Xn,this._animatedAngle=0,this._body=null,this._inited=!1}var e=t.prototype;return e.initialize=function(t){this._rigidBody=t,u6.instance._callAfterStep(this,this._init)},e.onDestroy=function(){u6.instance._callAfterStep(this,this._destroy)},e.onEnable=function(){this.setActive(!0)},e.onDisable=function(){this.setActive(!1)},e._registerNodeEvents=function(){this.rigidBody.node.on(zC.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)},e._unregisterNodeEvents=function(){this.rigidBody.node.off(zC.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)},e._onNodeTransformChanged=function(t){if(!u6.instance.stepping){if(t&kT.TransformBit.SCALE)for(var e=this.rigidBody.getComponents($7),n=0;n<e.length;n++)e[n].apply();t&kT.TransformBit.POSITION&&this.syncPositionToPhysics(!0),t&kT.TransformBit.ROTATION&&this.syncRotationToPhysics(!0)}},e._init=function(){this._inited||(this._registerNodeEvents(),u6.instance.physicsWorld.addBody(this),this._inited=!0)},e._destroy=function(){this._inited&&(u6.instance.physicsWorld.removeBody(this),this._unregisterNodeEvents(),this._inited=!1)},e.animate=function(t){var e=this._body;if(e){var n=e.GetPosition();e.SetAwake(!0);var i=1/t;E9.x=(this._animatedPos.x-n.x)*i,E9.y=(this._animatedPos.y-n.y)*i,e.SetLinearVelocity(E9);var r=e.GetAngle();e.SetAngularVelocity((this._animatedAngle-r)*i)}},e.syncPositionToPhysics=function(t){void 0===t&&(t=!1);var e=this._body;if(e){var n,i=this._rigidBody.node.worldPosition,r=this._rigidBody.type;(n=r===o8.Animated?e.GetLinearVelocity():e.GetPosition()).x=i.x/f8,n.y=i.y/f8,r===o8.Animated&&t?this._animatedPos.set(n.x,n.y):e.SetTransformVec(n,e.GetAngle())}},e.syncRotationToPhysics=function(t){void 0===t&&(t=!1);var e=this._body;if(e){var n=un(this._rigidBody.node.eulerAngles.z);this._rigidBody.type===o8.Animated&&t?this._animatedAngle=n:e.SetTransformVec(e.GetPosition(),n)}},e.resetVelocity=function(){var t=this._body;if(t){var e=t.m_linearVelocity;e.Set(0,0),t.SetLinearVelocity(e),t.SetAngularVelocity(0)}},e.setType=function(t){this._body.SetType(t)},e.setLinearDamping=function(t){this._body.SetLinearDamping(t)},e.setAngularDamping=function(t){this._body.SetAngularDamping(t)},e.setGravityScale=function(t){this._body.SetGravityScale(t)},e.setFixedRotation=function(t){this._body.SetFixedRotation(t)},e.setAllowSleep=function(t){this._body.SetSleepingAllowed(t)},e.isActive=function(){return this._body.IsActive()},e.setActive=function(t){this._body.SetActive(t)},e.wakeUp=function(){this._body.SetAwake(!0)},e.sleep=function(){this._body.SetAwake(!1)},e.getMass=function(){return this._body.GetMass()},e.setLinearVelocity=function(t){this._body.SetLinearVelocity(t)},e.getLinearVelocity=function(t){var e=this._body.GetLinearVelocity();return t.x=e.x,t.y=e.y,t},e.getLinearVelocityFromWorldPoint=function(t,e){return E9.Set(t.x/f8,t.y/f8),this._body.GetLinearVelocityFromWorldPoint(E9,e),e.x*=f8,e.y*=f8,e},e.setAngularVelocity=function(t){this._body.SetAngularVelocity(t)},e.getAngularVelocity=function(){return hn(this._body.GetAngularVelocity())},e.getLocalVector=function(t,e){return e=e||new Xn,E9.Set(t.x/f8,t.y/f8),this._body.GetLocalVector(E9,e),e.x*=f8,e.y*=f8,e},e.getWorldVector=function(t,e){return E9.Set(t.x/f8,t.y/f8),this._body.GetWorldVector(E9,e),e.x*=f8,e.y*=f8,e},e.getLocalPoint=function(t,e){return e=e||new Xn,E9.Set(t.x/f8,t.y/f8),this._body.GetLocalPoint(E9,e),e.x*=f8,e.y*=f8,e},e.getWorldPoint=function(t,e){return e=e||new Xn,E9.Set(t.x/f8,t.y/f8),this._body.GetWorldPoint(E9,e),e.x*=f8,e.y*=f8,e},e.getLocalCenter=function(t){t=t||new Xn;var e=this._body.GetLocalCenter();return t.x=e.x*f8,t.y=e.y*f8,t},e.getWorldCenter=function(t){t=t||new Xn;var e=this._body.GetWorldCenter();return t.x=e.x*f8,t.y=e.y*f8,t},e.getInertia=function(){return this._body.GetInertia()},e.applyForce=function(t,e,n){this._body&&(E9.Set(e.x/f8,e.y/f8),this._body.ApplyForce(t,E9,n))},e.applyForceToCenter=function(t,e){this._body&&this._body.ApplyForceToCenter(t,e)},e.applyTorque=function(t,e){this._body&&this._body.ApplyTorque(t,e)},e.applyLinearImpulse=function(t,e,n){this._body&&(E9.Set(e.x/f8,e.y/f8),this._body.ApplyLinearImpulse(t,E9,n))},e.applyLinearImpulseToCenter=function(t,e){this._body&&this._body.ApplyLinearImpulse(t,this._body.GetPosition(),e)},e.applyAngularImpulse=function(t,e){this._body&&this._body.ApplyAngularImpulse(t,e)},K(t,[{key:"impl",get:function(){return this._body}},{key:"_imp",set:function(t){this._body=t}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"isAwake",get:function(){return this._body.IsAwake()}},{key:"isSleeping",get:function(){return!this._body.IsAwake()}}]),t}(),P9=new u8.Filter;function I9(t){var e=t.collider;return P9.categoryBits=e.group===k8.DEFAULT?e.body.group:e.group,P9.maskBits=u6.instance.collisionMatrix[P9.categoryBits],P9}var R9,D9=function(){function t(){this._shapes=[],this._fixtures=[],this._collider=null,this._body=null,this._inited=!1,this._rect=new ni}var e=t.prototype;return e.initialize=function(t){this._collider=t},e.onLoad=function(){},e.onEnable=function(){u6.instance._callAfterStep(this,this._init)},e.onDisable=function(){u6.instance._callAfterStep(this,this._destroy)},e.start=function(){},e.onGroupChanged=function(){var t=I9(this);this._fixtures.forEach((function(e){e.SetFilterData(t)}))},e.apply=function(){this._destroy(),this._init()},e.getFixtureIndex=function(t){return this._fixtures.indexOf(t)},e._createShapes=function(){return[]},e._init=function(){var t;if(!this._inited){var e=this.collider,n=e.getComponent(Z7);if(n){var i=null===(t=n.impl)||void 0===t?void 0:t.impl;if(i){for(var r=n.node.worldScale,o=0===r.x&&0===r.y?[]:this._createShapes(r.x,r.y),a=I9(this),s=0;s<o.length;s++){var c=o[s],l={density:e.density,isSensor:e.sensor,friction:e.friction,restitution:e.restitution,shape:c,filter:a},u=i.CreateFixture(l);u.m_userData=this,n.enabledContactListener&&u6.instance.physicsWorld.registerContactFixture(u),this._shapes.push(c),this._fixtures.push(u)}this._body=i,this._inited=!0}}}},e._destroy=function(){if(this._inited){for(var t=this._fixtures,e=this._body,n=t.length-1;n>=0;n--){var i=t[n];i.m_userData=null,u6.instance.physicsWorld.unregisterContactFixture(i),e&&e.DestroyFixture(i)}this._body=null,this._fixtures.length=0,this._shapes.length=0,this._inited=!1}},K(t,[{key:"impl",get:function(){return this._shapes}},{key:"collider",get:function(){return this._collider}},{key:"worldAABB",get:function(){for(var t=1e7,e=t,n=t,i=-t,r=-t,o=this._fixtures,a=0;a<o.length;a++)for(var s=o[a],c=s.GetShape().GetChildCount(),l=0;l<c;l++){var u=s.GetAABB(l);u.lowerBound.x<e&&(e=u.lowerBound.x),u.lowerBound.y<n&&(n=u.lowerBound.y),u.upperBound.x>i&&(i=u.upperBound.x),u.upperBound.y>r&&(r=u.upperBound.y)}e*=f8,n*=f8,i*=f8,r*=f8;var h=this._rect;return h.x=e,h.y=n,h.width=i-e,h.height=r-n,h}}]),t}(),M9=new ni,B9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._worldPoints=[new Xn,new Xn,new Xn,new Xn],e}return Q(e,t),e.prototype._createShapes=function(t,e){t=Math.abs(t),e=Math.abs(e);var n=this.collider,i=n.size.width/2/f8*t,r=n.size.height/2/f8*e,o=n.offset.x/f8*t,a=n.offset.y/f8*e,s=new u8.PolygonShape;return s.SetAsBox(i,r,new u8.Vec2(o,a),0),[s]},K(e,[{key:"worldPoints",get:function(){var t=M9,e=this.collider,n=e.size,i=e.offset;t.x=i.x-n.width/2,t.y=i.y-n.height/2,t.width=n.width,t.height=n.height;var r=this._worldPoints,o=r[0],a=r[1],s=r[2],c=r[3];return t.transformMat4ToPoints(e.node.worldMatrix,o,a,s,c),r}}]),e}(D9),O9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._worldPosition=new Xn,e}return Q(e,t),e.prototype._createShapes=function(t,e){t=Math.abs(t),e=Math.abs(e);var n=this.collider,i=n.offset.x/f8*t,r=n.offset.y/f8*e,o=new u8.CircleShape;return o.m_radius=n.radius/f8*t,o.m_p.Set(i,r),[o]},K(e,[{key:"worldRadius",get:function(){return this._shapes[0].m_radius*f8}},{key:"worldPosition",get:function(){var t=this._shapes[0].m_p;return this._worldPosition.set(t.x*f8,t.y*f8)}}]),e}(D9),N9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._worldPoints=[],e}return Q(e,t),e.prototype._createShapes=function(t,e){var n=[],i=this.collider,r=i.points;r.length>0&&r[0].equals(r[r.length-1])&&(r.length-=1);for(var o=g8(r),a=i.offset,s=0;s<o.length;s++){for(var c=o[s],l=null,u=[],h=null,_=0,f=c.length;_<f;_++){l||(l=new u8.PolygonShape);var d=c[_],p=(d.x+a.x)/f8*t,m=(d.y+a.y)/f8*e,v=new u8.Vec2(p,m);u.push(v),h||(h=v),u.length===u8.maxPolygonVertices&&(l.Set(u,u.length),n.push(l),l=null,_<f-1&&(u=[h,u[u.length-1]]))}l&&(l.Set(u,u.length),n.push(l))}return n},K(e,[{key:"worldPoints",get:function(){for(var t=this.collider,e=t.points,n=this._worldPoints,i=t.node.worldMatrix,r=0;r<e.length;r++)n[r]||(n[r]=new Xn),Xn.transformMat4(n[r],e[r],i);return n.length=e.length,this._worldPoints}}]),e}(D9),L9=function(){function t(){this._b2joint=null,this._jointComp=null,this._body=null,this._inited=!1}var e=t.prototype;return e.initialize=function(t){this._jointComp=t},e.onEnable=function(){u6.instance._callAfterStep(this,this._init)},e.onDisable=function(){u6.instance._callAfterStep(this,this._destroy)},e.start=function(){u6.instance._callAfterStep(this,this._init)},e._init=function(){if(!this._inited){var t=this._jointComp;if(t.isValid){this._body=t.getComponent(Z7);var e=this._createJointDef();if(e){var n=t.connectedBody;n&&n.enabledInHierarchy&&(e.bodyA=this._body.impl.impl,e.bodyB=n.impl.impl,e.collideConnected=t.collideConnected,this._b2joint=u6.instance.physicsWorld.impl.CreateJoint(e),this._inited=!0)}}}},e._destroy=function(){this._inited&&(u6.instance.physicsWorld.impl.DestroyJoint(this._b2joint),this._b2joint=null,this._inited=!1)},e._createJointDef=function(){return null},e.isValid=function(){return this._b2joint&&this._body&&this._body.impl&&this._jointComp&&this._jointComp.connectedBody&&this._jointComp.connectedBody.impl},K(t,[{key:"impl",get:function(){return this._b2joint}},{key:"comp",get:function(){return this._jointComp}},{key:"body",get:function(){return this._body}}]),t}(),F9=new u8.Vec2;R9={PhysicsWorld:T9,RigidBody:w9,BoxShape:B9,CircleShape:O9,PolygonShape:N9,MouseJoint:function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._touchPoint=new Xn,e._isTouched=!1,e}Q(e,t);var n=e.prototype;return n.setTarget=function(t){this._b2joint&&(F9.x=t.x/f8,F9.y=t.y/f8,this._b2joint.SetTarget(F9))},n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setMaxForce=function(t){this._b2joint&&this._b2joint.SetMaxForce(t)},n._createJointDef=function(){var t=new u8.MouseJointDef,e=this._jointComp;return t.target.Set(this._touchPoint.x/f8,this._touchPoint.y/f8),t.maxForce=e.maxForce,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t},n.initialize=function(e){t.prototype.initialize.call(this,e);var n=vD("Canvas");n&&(n.on(zC.TOUCH_START,this.onTouchBegan,this),n.on(zC.TOUCH_MOVE,this.onTouchMove,this),n.on(zC.TOUCH_END,this.onTouchEnd,this),n.on(zC.TOUCH_CANCEL,this.onTouchEnd,this))},n.onEnable=function(){},n.start=function(){},n.onTouchBegan=function(t){this._isTouched=!0;var e=this._touchPoint.set(t.getUILocation()),n=u6.instance.physicsWorld.testPoint(e);if(!(n.length<=0)){var i=n[0].body;i.wakeUp();var r=this._jointComp;r.connectedBody=i,this._init(),this.setMaxForce(r.maxForce*i.getMass()),this.setTarget(e)}},n.onTouchMove=function(t){this._touchPoint=t.getUILocation()},n.onTouchEnd=function(){this._destroy(),this._isTouched=!1},n.update=function(){this._isTouched&&this.isValid()&&this.setTarget(this._touchPoint)},e}(L9),DistanceJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.setMaxLength=function(t){this._b2joint&&this._b2joint.SetMaxLength(t)},n._createJointDef=function(){var t=this._jointComp,e=new u8.RopeJointDef;return e.localAnchorA.Set(t.anchor.x/f8,t.anchor.y/f8),e.localAnchorB.Set(t.connectedAnchor.x/f8,t.connectedAnchor.y/f8),e.maxLength=t.maxLength/f8,e},e}(L9),SpringJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setDistance=function(t){this._b2joint&&this._b2joint.SetLength(t)},n._createJointDef=function(){var t=this._jointComp,e=new u8.DistanceJointDef;return e.localAnchorA.Set(t.anchor.x/f8,t.anchor.y/f8),e.localAnchorB.Set(t.connectedAnchor.x/f8,t.connectedAnchor.y/f8),e.length=t.distance/f8,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e},e}(L9),RelativeJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.setMaxForce=function(t){this._b2joint&&this._b2joint.SetMaxForce(t)},n.setAngularOffset=function(t){this._b2joint&&this._b2joint.SetAngularOffset(un(t))},n.setLinearOffset=function(t){this._b2joint&&this._b2joint.SetLinearOffset(new u8.Vec2(t.x/f8,t.y/f8))},n.setCorrectionFactor=function(t){this._b2joint&&(this._b2joint.m_correctionFactor=t)},n.setMaxTorque=function(t){this._b2joint&&this._b2joint.SetMaxTorque(t)},n._createJointDef=function(){var t=this._jointComp,e=new u8.MotorJointDef;return e.linearOffset.Set(t.linearOffset.x/f8,t.linearOffset.y/f8),e.angularOffset=un(t.angularOffset),e.maxForce=t.maxForce,e.maxTorque=t.maxTorque,e.correctionFactor=t.correctionFactor,e},e}(L9),SliderJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.enableLimit=function(t){this._b2joint&&this._b2joint.EnableLimit(t)},n.setLowerLimit=function(){this.updateLimits()},n.setUpperLimit=function(){this.updateLimits()},n.updateLimits=function(){if(this._b2joint){var t=this._jointComp;this._b2joint.SetLimits(t.lowerLimit/f8,t.upperLimit/f8)}},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorForce=function(t){this._b2joint&&this._b2joint.SetMaxMotorForce(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,e=new u8.PrismaticJointDef;e.localAnchorA.Set(t.anchor.x/f8,t.anchor.y/f8),e.localAnchorB.Set(t.connectedAnchor.x/f8,t.connectedAnchor.y/f8);var n=un(t.angle);return e.localAxisA.Set(Math.cos(n),Math.sin(n)),e.referenceAngle=0,e.enableLimit=t.enableLimit,e.lowerTranslation=t.lowerLimit/f8,e.upperTranslation=t.upperLimit/f8,e.enableMotor=t.enableMotor,e.maxMotorForce=t.maxMotorForce,e.motorSpeed=t.motorSpeed,e},e}(L9),FixedJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n._createJointDef=function(){var t=this._jointComp,e=new u8.WeldJointDef;return e.localAnchorA.Set(t.anchor.x/f8,t.anchor.y/f8),e.localAnchorB.Set(t.connectedAnchor.x/f8,t.connectedAnchor.y/f8),e.referenceAngle=0,e.frequencyHz=t.frequency,e.dampingRatio=t.dampingRatio,e},e}(L9),WheelJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetSpringDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetSpringFrequencyHz(t)},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorTorque=function(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,e=new u8.WheelJointDef;e.localAnchorA.Set(t.anchor.x/f8,t.anchor.y/f8),e.localAnchorB.Set(t.connectedAnchor.x/f8,t.connectedAnchor.y/f8);var n=un(t.angle);return e.localAxisA.Set(Math.cos(n),Math.sin(n)),e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=un(t.motorSpeed),e.enableMotor=t.enableMotor,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e},e}(L9),HingeJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.enableLimit=function(t){this._b2joint&&this._b2joint.EnableLimit(t)},n.setLowerAngle=function(){this.updateLimits()},n.setUpperAngle=function(){this.updateLimits()},n.updateLimits=function(){if(this._b2joint){var t=this._jointComp;this._b2joint.SetLimits(un(t.lowerAngle),un(t.upperAngle))}},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorTorque=function(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,e=new u8.RevoluteJointDef;return e.localAnchorA.Set(t.anchor.x/f8,t.anchor.y/f8),e.localAnchorB.Set(t.connectedAnchor.x/f8,t.connectedAnchor.y/f8),e.enableMotor=t.enableMotor,e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=un(t.motorSpeed),e.enableLimit=t.enableLimit,e.lowerAngle=t.lowerAngle,e.upperAngle=t.upperAngle,e},e}(L9)},$5="box2d",c._global.CC_PHYSICS_2D_BUILTIN=!1,c._global.CC_PHYSICS_2D_BOX2D=!0,Z5=R9;var z9,V9,k9,G9,U9,H9=function(){function t(){this._arrayBufferOrPaddings=[],this._length=0}var e=t.prototype;return e.setNextAlignment=function(t){if(0!==t){var e=this._length%t;if(0!==e){var n=t-e;this._arrayBufferOrPaddings.push(n),this._length+=n}}},e.addBuffer=function(t){var e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e},e.getLength=function(){return this._length},e.getCombined=function(){var t=new Uint8Array(this._length),e=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?e+=n:(t.set(new Uint8Array(n),e),e+=n.byteLength)})),t.buffer},t}(),j9=function(){function t(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>gp.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new q9(this._mesh,i,this._mesh.struct.morph,e):this._subMeshRenderings[i]=new W9(this._mesh,i,this._mesh.struct.morph,e))}}}return t.prototype.createInstance=function(){for(var t=this,e=this._mesh.struct.primitives.length,n=new Array(e),i=0;i<e;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(t,e){var i;null===(i=n[t])||void 0===i||i.setWeights(e)},requiredPatches:function(e){t._mesh.struct.morph;var i=t._mesh.struct.morph.subMeshMorphs[e],r=n[e];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(Ki.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(Ki.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(Ki.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(t,e){var i;null===(i=n[t])||void 0===i||i.adaptPipelineState(e)},destroy:function(){for(var t,e=ot(n);!(t=e()).done;){var i=t.value;null==i||i.destroy()}}}},t}(),W9=function(){function t(t,e,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[e];this._subMeshMorph=r,J9(t,e,i);var o=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=K9(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(e,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(e,i){for(var r=e.displacements[n],s=new Float32Array(t.data.buffer,t.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:e,morphTexture:i}}))}var e=t.prototype;return e.destroy=function(){for(var t,e=ot(this._attributes);!(t=e()).done;)t.value.morphTexture.destroy()},e.createInstance=function(){var t=this,e=new Y9(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:function(t){e.setWeights(t),e.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=ot(t._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case Ki.ATTR_POSITION:a=Cp;break;case Ki.ATTR_NORMAL:a=Ep;break;case Ki.ATTR_TANGENT:a=Ip;break;default:y("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(gp.BINDING,e.buffer),n.update()},destroy:function(){}}},t}(),q9=function(){function t(t,e,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[e];J9(t,e,i),this._attributes=r.attributes.map((function(e,n){return{name:e,targets:r.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[n].offset,e.displacements[n].count)}}))}}))}return t.prototype.createInstance=function(){return new X9(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},K(t,[{key:"data",get:function(){return this._attributes}}]),t}(),X9=function(){function t(t,e,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new Y9(n,0);var i=K9(n,e);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(t){var e=i.create();return{attributeName:t.name,morphTexture:e}}))}var e=t.prototype;return e.setWeights=function(t){for(var e=0;e<this._attributes.length;++e){var n=this._attributes[e],i=n.morphTexture.valueView,r=this._owner.data[e];t.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=t[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},e.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},e.adaptPipelineState=function(t){for(var e,n=ot(this._attributes);!(e=n()).done;){var i=e.value,r=void 0;switch(i.attributeName){case Ki.ATTR_POSITION:r=Cp;break;case Ki.ATTR_NORMAL:r=Ep;break;case Ki.ATTR_TANGENT:r=Ip;break;default:y("Unexpected attribute!")}void 0!==r&&(t.bindSampler(r,i.morphTexture.sampler),t.bindTexture(r,i.morphTexture.texture))}t.bindBuffer(gp.BINDING,this._morphUniforms.buffer),t.update()},e.destroy=function(){this._morphUniforms.destroy();for(var t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()},t}(),Y9=function(){function t(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(gp.SIZE)),this._remoteBuffer=t.createBuffer(new hr(pi.UNIFORM|pi.TRANSFER_DST,gi.HOST|gi.DEVICE,gp.SIZE,gp.SIZE))}var e=t.prototype;return e.destroy=function(){this._remoteBuffer.destroy()},e.setWeights=function(t){t.length,this._targetCount;for(var e=0;e<t.length;++e)this._localBuffer.setFloat32(gp.OFFSET_OF_WEIGHTS+4*e,t[e],c.sys.isLittleEndian)},e.setMorphTextureInfo=function(t,e){this._localBuffer.setFloat32(gp.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,c.sys.isLittleEndian),this._localBuffer.setFloat32(gp.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,c.sys.isLittleEndian)},e.setVerticesCount=function(t){this._localBuffer.setFloat32(gp.OFFSET_OF_VERTICES_COUNT,t,c.sys.isLittleEndian)},e.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},K(t,[{key:"buffer",get:function(){return this._remoteBuffer}}]),t}();function K9(t,e){var i,o,a,s;t.hasFeature(hi.TEXTURE_FLOAT)?(i=e,a=16,o=yv.PixelFormat.RGBA32F,s=Float32Array):(i=4*e,a=4,o=yv.PixelFormat.RGBA8888,s=Uint8Array);var c=function(t){t<5&&(t=5);var e=n(r(t)),i=e>>1;return{width:1<<(1&e?i+1:i),height:1<<i}}(i),l=c.width,u=c.height;return{width:l,height:u,create:function(){var e=new ArrayBuffer(l*u*a),n=new Float32Array(e),i=s===Float32Array?n:new s(e),r=new Jm({width:l,height:u,_data:i,_compressed:!1,format:o}),c=new yv;c.setFilters(yv.Filter.NEAREST,yv.Filter.NEAREST),c.setMipFilter(yv.Filter.NONE),c.setWrapMode(yv.WrapMode.CLAMP_TO_EDGE,yv.WrapMode.CLAMP_TO_EDGE,yv.WrapMode.CLAMP_TO_EDGE),c.image=r,c.getGFXTexture()||y("Unexpected: failed to create morph texture?");var h=t.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(i)}}}}}function J9(t,e,n){t.renderingSubMeshes[e].enableVertexIdChannel(n)}function Q9(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var Z9=new Pn,$9=new Pn,ttt=new Uint8Array,ett=fc("cc.Mesh")((U9=function(t){function e(){var e;return(e=t.call(this)||this).morphRendering=null,at(e,"_struct",k9,it(e)),at(e,"_hash",G9,it(e)),e._data=ttt,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e}Q(e,t);var n=e.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var t=this._data.buffer,e=c.director.root.device,n=this._createVertexBuffers(e,t),i=[],r=0;r<this._struct.primitives.length;r++){var o=this._struct.primitives[r];if(0!==o.vertexBundelIndices.length){var a=null,s=null;if(o.indexView){var l=o.indexView,u=l.stride,h=l.length;if(4===u&&!e.hasFeature(hi.ELEMENT_INDEX_UINT)){var _=this._struct.vertexBundles[o.vertexBundelIndices[0]].view.count;if(_>=65536){I(10001,_,65536);continue}u>>=1,h>>=1}a=e.createBuffer(new hr(pi.INDEX,gi.DEVICE,h,u)),s=new(Q9(l.stride))(t,l.offset,l.count),l.stride!==u&&(s=Q9(u).from(s)),a.update(s)}var f=o.vertexBundelIndices.map((function(t){return n[t]})),d=[];if(o.vertexBundelIndices.length>0)for(var p=o.vertexBundelIndices[0],m=this._struct.vertexBundles[p].attributes,v=0;v<m.length;++v){var g=m[v];d[v]=new Pr(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new LE(f,d,o.primitiveMode,a);y.mesh=this,y.subMeshIdx=r,i.push(y)}}this._renderingSubMeshes=i,this._struct.morph&&(this.morphRendering=function(t,e){return new j9(t,e)}(this,e))}},n.destroy=function(){return this.destroyRenderingMesh(),t.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(t,e){this.reset({struct:t,data:e})},n.reset=function(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0},n.getBoneSpaceBounds=function(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);var e=[];this._boneSpaceBounds.set(t.hash,e);for(var n=[],i=t.bindposes,r=0;r<i.length;r++)e.push(new js(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,Ki.ATTR_JOINTS),c=this.readAttribute(a,Ki.ATTR_WEIGHTS),l=this.readAttribute(a,Ki.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){Pn.set(Z9,l[3*h+0],l[3*h+1],l[3*h+2]);for(var _=0;_<4;++_){var f=4*h+_,d=s[f];if(!(0===c[f]||d>=i.length)){Pn.transformMat4($9,Z9,i[d]),n[d]=!0;var p=e[d];Pn.min(p.center,p.center,$9),Pn.max(p.halfExtents,p.halfExtents,$9)}}}}for(var m=0;m<i.length;m++){var v=e[m];n[m]?js.fromPoints(v,v.center,v.halfExtents):e[m]=null}return e},n.merge=function(t,e,n){if(n&&!this.validateMergingMesh(t))return!1;var i=new Pn,r=e&&new Nn,o=e&&new js;if(r&&e.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(t._struct)),s=t._data.slice();if(e){a.maxPosition&&a.minPosition&&(Pn.add(o.center,a.maxPosition,a.minPosition),Pn.multiplyScalar(o.center,o.center,.5),Pn.subtract(o.halfExtents,a.maxPosition,a.minPosition),Pn.multiplyScalar(o.halfExtents,o.halfExtents,.5),js.transform(o,o,e),Pn.add(a.maxPosition,o.center,o.halfExtents),Pn.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===Ki.ATTR_POSITION||l.attributes[u].name===Ki.ATTR_NORMAL){var h=l.attributes[u].format,_=new DataView(s.buffer,l.view.offset+ntt(l.attributes,u)),f=ott(_,h),d=att(_,h);if(!f||!d)continue;for(var p=l.view.count,m=l.view.stride,v=rtt(h),g=0;g<p;g++){var y=g*m,x=y+v,S=x+v;switch(i.set(f(y),f(x),f(S)),l.attributes[u].name){case Ki.ATTR_POSITION:i.transformMat4(e);break;case Ki.ATTR_NORMAL:Pn.transformQuat(i,i,r)}d(y,i.x),d(x,i.y),d(S,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var A,C,b,T,E,w=new H9,P=0,I=0,R=0,D=0,M=0,B=0,O=0,N=0,L=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var V=this._struct.vertexBundles[z],k=t._struct.vertexBundles[z];R=V.view.offset,D=k.view.offset,I=V.view.stride,P=V.view.count+k.view.count,A=new ArrayBuffer(P*I),C=new Uint8Array(A),R+=(b=this._data.subarray(R,R+V.view.length)).length,D+=(T=t._data.subarray(D,D+k.view.length)).length,C.set(b),M=0;for(var G,U=ot(V.attributes);!(G=U()).done;){var H=G.value;O=0,L=!1;for(var j,W=ot(k.attributes);!(j=W()).done;){var q=j.value;if(H.name===q.name&&H.format===q.format){L=!0;break}O+=Zr[q.format].size}if(L){N=Zr[H.format].size,B=V.view.length+M;for(var X=0;X<k.view.count;++X){if(E=T.subarray(O,O+N),C.set(E,B),(H.name===Ki.ATTR_POSITION||H.name===Ki.ATTR_NORMAL)&&e){var Y=new Float32Array(C.buffer,B,3);switch(i.set(Y[0],Y[1],Y[2]),H.name){case Ki.ATTR_POSITION:i.transformMat4(e);break;case Ki.ATTR_NORMAL:Pn.transformQuat(i,i,r)}Y[0]=i.x,Y[1]=i.y,Y[2]=i.z}B+=V.view.stride,O+=k.view.stride}}M+=Zr[H.format].size}F[z]={attributes:V.attributes,view:{offset:w.getLength(),length:A.byteLength,count:P,stride:I}},w.addBuffer(A)}for(var K,J,Q,Z=0,$=2,tt=0,et=new Array(this._struct.primitives.length),nt=0;nt<this._struct.primitives.length;++nt){var it=this._struct.primitives[nt],rt=t._struct.primitives[nt];et[nt]={primitiveMode:it.primitiveMode,vertexBundelIndices:it.vertexBundelIndices};for(var at,st=ot(it.vertexBundelIndices);!(at=st()).done;){var ct=at.value;tt=Math.max(tt,this._struct.vertexBundles[ct].view.count)}if(it.indexView&&rt.indexView){Z=it.indexView.count,Z+=rt.indexView.count,R=it.indexView.offset,D=rt.indexView.offset,$=Z<256?1:Z<65536?2:4;var lt=new ArrayBuffer(Z*$);if(K=2===$?new Uint16Array(lt):1===$?new Uint8Array(lt):new Uint32Array(lt),J=2===it.indexView.stride?new Uint16Array(this._data.buffer,R,it.indexView.count):1===it.indexView.stride?new Uint8Array(this._data.buffer,R,it.indexView.count):new Uint32Array(this._data.buffer,R,it.indexView.count),$===it.indexView.stride)K.set(J);else for(var ut=0;ut<it.indexView.count;++ut)K[ut]=J[ut];R+=it.indexView.length,Q=2===rt.indexView.stride?new Uint16Array(t._data.buffer,D,rt.indexView.count):1===rt.indexView.stride?new Uint8Array(t._data.buffer,D,rt.indexView.count):new Uint32Array(t._data.buffer,D,rt.indexView.count);for(var ht=0;ht<rt.indexView.count;++ht)K[it.indexView.count+ht]=tt+Q[ht];D+=rt.indexView.length,et[nt].indexView={offset:w.getLength(),length:lt.byteLength,count:Z,stride:$},w.setNextAlignment($),w.addBuffer(lt)}}var _t={vertexBundles:F,primitives:et,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _t.minPosition&&t._struct.minPosition&&_t.maxPosition&&t._struct.maxPosition&&(e?(Pn.add(o.center,t._struct.maxPosition,t._struct.minPosition),Pn.multiplyScalar(o.center,o.center,.5),Pn.subtract(o.halfExtents,t._struct.maxPosition,t._struct.minPosition),Pn.multiplyScalar(o.halfExtents,o.halfExtents,.5),js.transform(o,o,e),Pn.add(i,o.center,o.halfExtents),Pn.max(_t.maxPosition,_t.maxPosition,i),Pn.subtract(i,o.center,o.halfExtents),Pn.min(_t.minPosition,_t.minPosition,i)):(Pn.min(_t.minPosition,_t.minPosition,t._struct.minPosition),Pn.max(_t.maxPosition,_t.maxPosition,t._struct.maxPosition))),this.reset({struct:_t,data:new Uint8Array(w.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(t){if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(var e=0;e<this._struct.vertexBundles.length;++e){var n=this._struct.vertexBundles[e],i=t._struct.vertexBundles[e];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=t._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(t,e){var n=this,i=null;return this._accessAttribute(t,e,(function(t,e){var r=t.view.count,o=t.attributes[e].format,a=so(Zr[o]);if(0!==r){var s=new DataView(n._data.buffer,t.view.offset+ntt(t.attributes,e)),c=Zr[o],l=ott(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),_=t.view.stride,f=0;f<r;++f)for(var d=0;d<u;++d)h[u*f+d]=l(_*f+h.BYTES_PER_ELEMENT*d);i=h}}})),i},n.copyAttribute=function(t,e,n,i,r){var o=this,a=!1;return this._accessAttribute(t,e,(function(t,e){var s=t.view.count;if(0!==s){var c=t.attributes[e].format,l=new DataView(o._data.buffer,t.view.offset+ntt(t.attributes,e)),u=new DataView(n,r),h=Zr[c],_=ott(l,c),f=att(u,c);if(_&&f){for(var d=h.count,p=t.view.stride,m=rtt(c),v=i,g=m,y=0;y<s;++y)for(var x=0;x<d;++x)f(v*y+g*x,_(p*y+m*x));a=!0}}else a=!0})),a},n.readIndices=function(t){if(t>=this._struct.primitives.length)return null;var e=this._struct.primitives[t];if(!e.indexView)return null;var n=e.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)},n.copyIndices=function(t,e){if(t>=this._struct.primitives.length)return!1;var n=this._struct.primitives[t];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?_i.R8UI:2===n.indexView.stride?_i.R16UI:_i.R32UI,o=ott(new DataView(this._data.buffer),r),a=0;a<i;++a)e[a]=o(n.indexView.offset+Zr[r].size*a);return!0},n._accessAttribute=function(t,e,n){if(!(t>=this._struct.primitives.length))for(var i,r=ot(this._struct.primitives[t].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(t){return t.name===e}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(t,e){return this._struct.vertexBundles.map((function(n){var i=t.createBuffer(new hr(pi.VERTEX,gi.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(e,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:ttt})},K(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data=new Uint8Array(t)}},{key:"subMeshCount",get:function(){var t=this.renderingSubMeshes;return t?t.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=vo(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(t){return t.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),e}(Ru),k9=st((V9=U9).prototype,"_struct",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),G9=st(V9.prototype,"_hash",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),z9=V9))||z9;function ntt(t,e){for(var n=0,i=0;i<e;++i){var r=t[i];n+=Zr[r.format].size}return n}c.Mesh=ett;var itt=sh.isLittleEndian;function rtt(t){var e=Zr[t];return e.size/e.count}function ott(t,e){var n=Zr[e],i=n.size/n.count;switch(n.type){case fi.UNORM:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,itt)};case 4:return function(e){return t.getUint32(e,itt)}}break;case fi.SNORM:case fi.INT:switch(i){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,itt)};case 4:return function(e){return t.getInt32(e,itt)}}break;case fi.UINT:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,itt)};case 4:return function(e){return t.getUint32(e,itt)}}break;case fi.FLOAT:return function(e){return t.getFloat32(e,itt)}}return null}function att(t,e){var n=Zr[e],i=n.size/n.count;switch(n.type){case fi.UNORM:switch(i){case 1:return function(e,n){return t.setUint8(e,n)};case 2:return function(e,n){return t.setUint16(e,n,itt)};case 4:return function(e,n){return t.setUint32(e,n,itt)}}break;case fi.SNORM:case fi.INT:switch(i){case 1:return function(e,n){return t.setInt8(e,n)};case 2:return function(e,n){return t.setInt16(e,n,itt)};case 4:return function(e,n){return t.setInt32(e,n,itt)}}break;case fi.UINT:switch(i){case 1:return function(e,n){return t.setUint8(e,n)};case 2:return function(e,n){return t.setUint16(e,n,itt)};case 4:return function(e,n){return t.setUint32(e,n,itt)}}break;case fi.FLOAT:return function(e,n){return t.setFloat32(e,n,itt)}}return null}var stt,ctt,ltt,utt,htt,_tt,ftt,dtt,ptt,mtt,vtt,gtt,ytt,xtt,Stt,Att,Ctt,btt,Ttt,Ett,wtt,Ptt,Itt,Rtt,Dtt,Mtt,Btt,Ott,Ntt,Ltt,Ftt,ztt,Vtt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._morphRenderingInstance=null,e._usedMaterials=new Set,e}Q(e,t);var n=e.prototype;return n.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):t.prototype.getMacroPatches.call(this,e)},n.initSubModel=function(e,n,i){return t.prototype.initSubModel.call(this,e,n,this._launderMaterial(i))},n.destroy=function(){t.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(e,n){return t.prototype.setSubModelMaterial.call(this,e,this._launderMaterial(n))},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,n)},n._launderMaterial=function(t){return t},n.setMorphRendering=function(t){this._morphRenderingInstance=t},e}(rA),ktt=oe({OFF:0,ON:1}),Gtt=oe({OFF:0,ON:1}),Utt=(stt=fc("cc.ModelLightmapSettings"),ctt=xc("_recieveShadow"),stt((vtt=function(){function t(){at(this,"texture",htt,this),at(this,"uvParam",_tt,this),at(this,"_bakeable",ftt,this),at(this,"_castShadow",dtt,this),at(this,"_receiveShadow",ptt,this),at(this,"_lightmapSize",mtt,this)}return K(t,[{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(t){this._lightmapSize=t}}]),t}(),htt=st((utt=vtt).prototype,"texture",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_tt=st(utt.prototype,"uvParam",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn}}),ftt=st(utt.prototype,"_bakeable",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dtt=st(utt.prototype,"_castShadow",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ptt=st(utt.prototype,"_receiveShadow",[ctt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mtt=st(utt.prototype,"_lightmapSize",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),st(utt.prototype,"bakeable",[Rc],Object.getOwnPropertyDescriptor(utt.prototype,"bakeable"),utt.prototype),st(utt.prototype,"castShadow",[Rc],Object.getOwnPropertyDescriptor(utt.prototype,"castShadow"),utt.prototype),st(utt.prototype,"receiveShadow",[Rc],Object.getOwnPropertyDescriptor(utt.prototype,"receiveShadow"),utt.prototype),st(utt.prototype,"lightmapSize",[Rc],Object.getOwnPropertyDescriptor(utt.prototype,"lightmapSize"),utt.prototype),ltt=utt))||ltt),Htt=(gtt=fc("cc.MeshRenderer"),ytt=Ic(),xtt=pc(100),Stt=Tc(),Att=Xc(ktt),Ctt=Oc(),btt=Xc(Gtt),Ttt=Oc(),Ett=Xc(ett),wtt=Oc(),Ptt=Dc(),gtt(Itt=ytt(Itt=xtt(Itt=Stt(Itt=bc((Ftt=Ltt=function(t){function e(){var e;return at(e=t.call(this)||this,"lightmapSettings",Dtt,it(e)),at(e,"_mesh",Mtt,it(e)),at(e,"_shadowCastingMode",Btt,it(e)),at(e,"_shadowReceivingMode",Ott,it(e)),e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,at(e,"_enableMorph",Ntt,it(e)),e._modelType=rA,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(c.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(t,e){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[t];return n.length,n[e]},n.setWeights=function(t,e){var n=this._subMeshShapesWeights;e>=n.length||n[e].length===t.length&&(n[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))},n.setWeight=function(t,e,n){var i=this._subMeshShapesWeights;if(!(e>=i.length)){var r=i[e];n>=r.length||(r[n]=t,this._uploadSubMeshShapesWeights(e))}},n.setInstancedAttribute=function(t,e){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===t){r[o].set(e);break}},n._updateLightmap=function(t,e,n,i,r){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var t=this._model;t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var t=this._morphInstance&&this._modelType===rA?Vtt:this._modelType,e=this._model=c.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof Vtt&&e.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=$g.POSITION,this._model.transform.hasChangedFlags|=$g.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(var n=0;n<t;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=e[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},n._onRebuildPSO=function(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var t=this._model.subModels,e=0;e<t.length;++e)this._onMaterialModified(e,null)},n._getBuiltinMaterial=function(){return Pv.get("missing-material")},n._onVisibilityChange=function(t){this._model&&(this._model.visFlags=t)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===ktt.OFF?this._model.castShadow=!1:(this._shadowCastingMode,ktt.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===Gtt.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var t=0;t<this._materials.length;++t){var e=this._materials[t];if(e)for(var n=0;n<e.passes.length;++n)if(e.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof Vtt&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var t=this._mesh;if(this._subMeshShapesWeights.length=0,t){var e=t.struct.morph;if(e){var n=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((function(t){return t?t.weights?t.weights.slice(0):n?(n.length,t.targets.length,n.slice(0)):new Array(t.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var t=this._mesh,e=this._subMeshShapesWeights;if(!t||!t.struct.morph)return 0===e.length;var n=t.struct.morph;return n.subMeshMorphs.length===e.length&&e.every((function(t,e){var i,r,o=t.length;return(null!==(i=null===(r=n.subMeshMorphs[e])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])},K(e,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(t){this._shadowCastingMode=t,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(t){var e=this._mesh,n=this._mesh=t;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(t){this._enableMorph=t}}]),e}(cF),Ltt.ShadowCastingMode=ktt,Ltt.ShadowReceivingMode=Gtt,Dtt=st((Rtt=Ftt).prototype,"lightmapSettings",[yc,Rc,Uc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Utt}}),Mtt=st(Rtt.prototype,"_mesh",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Btt=st(Rtt.prototype,"_shadowCastingMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ktt.OFF}}),Ott=st(Rtt.prototype,"_shadowReceivingMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gtt.ON}}),st(Rtt.prototype,"shadowCastingMode",[Att,Ctt,Uc],Object.getOwnPropertyDescriptor(Rtt.prototype,"shadowCastingMode"),Rtt.prototype),st(Rtt.prototype,"receiveShadow",[btt,Ttt,Uc],Object.getOwnPropertyDescriptor(Rtt.prototype,"receiveShadow"),Rtt.prototype),st(Rtt.prototype,"mesh",[Ett,wtt],Object.getOwnPropertyDescriptor(Rtt.prototype,"mesh"),Rtt.prototype),st(Rtt.prototype,"enableMorph",[Ptt,Uc],Object.getOwnPropertyDescriptor(Rtt.prototype,"enableMorph"),Rtt.prototype),Ntt=st(Rtt.prototype,"_enableMorph",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Itt=Rtt))||Itt)||Itt)||Itt)||Itt)||Itt);!function(t){t[t.positions=Ki.ATTR_POSITION]="positions",t[t.normals=Ki.ATTR_NORMAL]="normals",t[t.uvs=Ki.ATTR_TEX_COORD]="uvs",t[t.colors=Ki.ATTR_COLOR]="colors"}(ztt||(ztt={}));var jtt,Wtt=[new Pr(Ki.ATTR_POSITION,_i.RGB32F),new Pr(Ki.ATTR_NORMAL,_i.RGB32F),new Pr(Ki.ATTR_TEX_COORD,_i.RG32F),new Pr(Ki.ATTR_TANGENT,_i.RGBA32F),new Pr(Ki.ATTR_COLOR,_i.RGBA32F)],qtt=new Pn,Xtt=function(){function t(t,e,n){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=n}var e=t.prototype;return e.sample=function(t){this._average(this._value,t)},e.human=function(){var t=this._opts,e=t.average,n=t.isInteger,i=e?this._averageValue:this._value;return n?Math.round(i):Math.round(100*i)/100},e.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},e._average=function(t,e){if(void 0===e&&(e=0),this._opts.average){this._accumValue+=t,++this._accumSamples;var n=e;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}},K(t,[{key:"value",get:function(){return this._value},set:function(t){this._value=t}}]),t}(),Ytt=fc("cc.PerfCounter")(jtt=function(t){function e(e,n,i){var r;return(r=t.call(this,e,n,i)||this)._time=void 0,r._time=i,r}Q(e,t);var n=e.prototype;return n.start=function(t){void 0===t&&(t=0),this._time=t},n.end=function(t){void 0===t&&(t=0),this._value=t-this._time,this._average(this._value)},n.tick=function(){this.end(),this.start()},n.frame=function(t){var e=t,n=e-this._time;this._total++,n>(this._opts.average||1e3)&&(this._value=1e3*this._total/n,this._total=0,this._time=e,this._average(this._value))},e}(Xtt))||jtt,Ktt="0123456789. ",Jtt=500,Qtt={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},Ztt={fps:{desc:"Framerate (FPS)",below:30,average:Jtt,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:Jtt},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:Jtt,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:Jtt},render:{desc:"Renderer (ms)",min:0,max:50,average:Jtt,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},$tt=t("Profiler",function(){function t(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new or,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(Ztt).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}var e=t.prototype;return e.reset=function(){this._stats=null,this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer&&this._meshRenderer.destroy(),this._meshRenderer=null,this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(Ztt).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0},e.isShowingStats=function(){return this._showFPS},e.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),c.director.off(c.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),c.director.off(c.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),c.director.off(c.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),c.director.off(c.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),c.director.off(c.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),c.director.off(c.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,this._pipeline.profiler=null,c.game.config.showFPS=!1)},e.showStats=function(){if(!this._showFPS){if(!this._device){var t=c.director.root;this._device=t.device,this._swapchain=t.mainWindow.swapchain,this._pipeline=t.pipeline}this.generateCanvas(),this.generateStats(),c.game.once(c.Game.EVENT_ENGINE_INITED,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),c.director.on(c.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),c.director.on(c.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),c.director.on(c.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),c.director.on(c.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),c.director.on(c.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),c.director.on(c.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,c.game.config.showFPS=!0}},e.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new mr(yi.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,_i.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},e.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var t=performance.now();this._ctx.textAlign="left";var e=0;for(var n in Ztt){var i=Ztt[n];this._ctx.fillText(i.desc,0,e*this._lineHeight),i.counter=new Ytt(n,i,t),e++}this._totalLines=e,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<Ktt.length;++r){var o=this._ctx.measureText(Ktt[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,o)}for(var a=0;a<Ktt.length;++a)this._ctx.fillText(Ktt[a],a*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=Ztt,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},e.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new kT("PROFILER_NODE"),c.game.addPersistRootNode(this._rootNode);var t=new kT("Profiler_Root");t.parent=this._rootNode;for(var e=.4,n=e/this._totalLines,i=e/this._wordHeight,r=n/23,o=this._eachNumWidth*this._canvas.width*r,a=[0,e,0,i,e,0,i,0,0,0,0,0],s=[0,2,1,0,3,2],l=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],u=0,h=0;h<this._totalLines;h++)for(var _=0;_<8;_++){a.push(i+_*o,e-h*n,0),a.push(i+(_+1)*o,e-h*n,0),a.push(i+(_+1)*o,e-(h+1)*n,0),a.push(i+_*o,e-(h+1)*n,0),u=4*(8*h+_+1),s.push(0+u,2+u,1+u,0+u,3+u,2+u);var f=8*h+_,d=Math.floor(f/4),p=f-4*d;l.push(0,this._wordHeight,d,p),l.push(this._eachNumWidth,this._wordHeight,d,p),l.push(this._eachNumWidth,1,d,p),l.push(0,1,d,p)}this._meshRenderer=t.addComponent(Htt),this._meshRenderer.mesh=function(t,e,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=t.positions.slice();if(c.length>0){if(i=null,t.attributes)for(var l,u=ot(t.attributes);!(l=u()).done;){var h=l.value;if(h.name===Ki.ATTR_POSITION){i=h;break}}i||(i=Wtt[0]),r.push(i);var _=Zr[i.format];s=Math.max(s,Math.floor(c.length/_.count)),a.push({offset:o,data:c,attribute:i}),o+=_.size}if(t.normals&&t.normals.length>0){if(i=null,t.attributes)for(var f,d=ot(t.attributes);!(f=d()).done;){var p=f.value;if(p.name===Ki.ATTR_NORMAL){i=p;break}}i||(i=Wtt[1]);var m=Zr[i.format];r.push(i),s=Math.max(s,Math.floor(t.normals.length/m.count)),a.push({offset:o,data:t.normals,attribute:i}),o+=m.size}if(t.uvs&&t.uvs.length>0){if(i=null,t.attributes)for(var v,g=ot(t.attributes);!(v=g()).done;){var y=v.value;if(y.name===Ki.ATTR_TEX_COORD){i=y;break}}i||(i=Wtt[2]);var x=Zr[i.format];r.push(i),s=Math.max(s,Math.floor(t.uvs.length/x.count)),a.push({offset:o,data:t.uvs,attribute:i}),o+=x.size}if(t.tangents&&t.tangents.length>0){if(i=null,t.attributes)for(var S,A=ot(t.attributes);!(S=A()).done;){var C=S.value;if(C.name===Ki.ATTR_TANGENT){i=C;break}}i||(i=Wtt[3]);var b=Zr[i.format];r.push(i),s=Math.max(s,Math.floor(t.tangents.length/b.count)),a.push({offset:o,data:t.tangents,attribute:i}),o+=b.size}if(t.colors&&t.colors.length>0){if(i=null,t.attributes)for(var T,E=ot(t.attributes);!(T=E()).done;){var w=T.value;if(w.name===Ki.ATTR_COLOR){i=w;break}}i||(i=Wtt[4]);var P=Zr[i.format];r.push(i),s=Math.max(s,Math.floor(t.colors.length/P.count)),a.push({offset:o,data:t.colors,attribute:i}),o+=P.size}if(t.customAttributes)for(var I,R=ot(t.customAttributes);!(I=R()).done;){var D=I.value,M=Zr[D.attr.format];r.push(D.attr),s=Math.max(s,Math.floor(D.values.length/M.count)),a.push({offset:o,data:D.values,attribute:D.attr}),o+=M.size}for(var B=new H9,O=new ArrayBuffer(s*o),N=new DataView(O),L=0,F=a;L<F.length;L++){var z=F[L];ME(N,z.data,z.attribute.format,z.offset,o)}B.setNextAlignment(0);var V={attributes:r,view:{offset:B.getLength(),length:O.byteLength,count:s,stride:o}};B.addBuffer(O);var k=null,G=0;if(t.indices){var U=t.indices;G=U.length,k=new ArrayBuffer(2*G),ME(new DataView(k),U,_i.R16UI)}var H={primitiveMode:t.primitiveMode||Fi.TRIANGLE_LIST,vertexBundelIndices:[0]};k&&(B.setNextAlignment(2),H.indexView={offset:B.getLength(),length:k.byteLength,count:G,stride:2},B.addBuffer(k));var j=t.minPos;if(!j&&n.calculateBounds){j=Pn.set(new Pn,1/0,1/0,1/0);for(var W=0;W<s;++W)Pn.set(qtt,c[3*W+0],c[3*W+1],c[3*W+2]),Pn.min(j,j,qtt)}var q=t.maxPos;if(!q&&n.calculateBounds){q=Pn.set(new Pn,-1/0,-1/0,-1/0);for(var X=0;X<s;++X)Pn.set(qtt,c[3*X+0],c[3*X+1],c[3*X+2]),Pn.max(q,q,qtt)}var Y={vertexBundles:[V],primitives:[H]};return j&&(Y.minPosition=new Pn(j.x,j.y,j.z)),q&&(Y.maxPosition=new Pn(q.x,q.y,q.z)),e||(e=new ett),e.reset({struct:Y,data:new Uint8Array(B.getCombined())}),e}({positions:a,indices:s,colors:l});var m=new rg;m.initialize({effectName:"profiler"});var v=this.pass=m.passes[0],g=v.getBinding("mainTexture"),y=v.getBinding("digits"),x=v.getBinding("offset");v.bindTexture(g,this._texture),this.digitsData=v.blocks[y],this.offsetData=v.blocks[x],this.offsetData[3]=-1,this._meshRenderer.material=m,this._meshRenderer.node.layer=Md.Enum.PROFILER,this._inited=!0}},e.beforeUpdate=function(){if(this._stats){var t=performance.now();this._stats.frame.counter.start(t),this._stats.logic.counter.start(t)}},e.afterUpdate=function(){if(this._stats){var t=performance.now();c.director.isPaused()?this._stats.frame.counter.start(t):this._stats.logic.counter.end(t)}},e.beforePhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.start(t)}},e.afterPhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.end(t)}},e.beforeDraw=function(){if(this._stats&&this._inited){var t=this._swapchain.surfaceTransform,e=this._device.capabilities.clipSpaceSignY;if(t!==this.offsetData[3]){var n=Un[t],i=-.9*e;this.offsetData[0]=-.9*n[0]+i*n[2],this.offsetData[1]=-.9*n[1]+i*n[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=t}this.pass._setRootBufferDirty(!0),this._meshRenderer.model&&(this._pipeline.profiler=this._meshRenderer.model);var r=performance.now();this._stats.render.counter.start(r)}},e.afterDraw=function(){if(this._stats&&this._inited){var t=performance.now();if(this._stats.frame.counter.end(t),this._stats.fps.counter.frame(t),this._stats.render.counter.end(t),!(t-this.lastTime<Jtt)){this.lastTime=t;var e=this._device;this._stats.draws.counter.value=e.numDrawCalls,this._stats.instances.counter.value=e.numInstances,this._stats.bufferMemory.counter.value=e.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=e.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=e.numTris;var n=0,i=this.digitsData;for(var r in this._stats){var o=this._stats[r];o.counter.sample(t);for(var a=o.counter.human().toString(),s=7;s>=0;s--){var c=8*n+s,l=a[a.length-(8-s)],u=Qtt[l];void 0===u&&(u=11),i[c]=u}n++}}}},t}()),tet=t("profiler",new $tt);c.profiler=tet;var eet,net,iet=(eet=function(t,e){return(eet=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}eet(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});!function(t){var e,n,i,r=function(){function t(t,e,n){if(null==t)throw new Error("name cannot be null.");if(null==e)throw new Error("timelines cannot be null.");this.name=t,this.timelines=e,this.timelineIds=[];for(var i=0;i<e.length;i++)this.timelineIds[e[i].getPropertyId()]=!0;this.duration=n}return t.prototype.hasTimeline=function(t){return 1==this.timelineIds[t]},t.prototype.apply=function(t,e,n,i,r,o,a,s){if(null==t)throw new Error("skeleton cannot be null.");i&&0!=this.duration&&(n%=this.duration,e>0&&(e%=this.duration));for(var c=this.timelines,l=0,u=c.length;l<u;l++)c[l].apply(t,e,n,r,o,a,s)},t.binarySearch=function(t,e,n){void 0===n&&(n=1);var i=0,r=t.length/n-2;if(0==r)return n;for(var o=r>>>1;;){if(t[(o+1)*n]<=e?i=o+1:r=o,i==r)return(i+1)*n;o=i+r>>>1}},t.linearSearch=function(t,e,n){for(var i=0,r=t.length-n;i<=r;i+=n)if(t[i]>e)return i;return-1},t}();t.Animation=r,function(t){t[t.setup=0]="setup",t[t.first=1]="first",t[t.replace=2]="replace",t[t.add=3]="add"}(e=t.MixBlend||(t.MixBlend={})),function(t){t[t.mixIn=0]="mixIn",t[t.mixOut=1]="mixOut"}(n=t.MixDirection||(t.MixDirection={})),function(t){t[t.rotate=0]="rotate",t[t.translate=1]="translate",t[t.scale=2]="scale",t[t.shear=3]="shear",t[t.attachment=4]="attachment",t[t.color=5]="color",t[t.deform=6]="deform",t[t.event=7]="event",t[t.drawOrder=8]="drawOrder",t[t.ikConstraint=9]="ikConstraint",t[t.transformConstraint=10]="transformConstraint",t[t.pathConstraintPosition=11]="pathConstraintPosition",t[t.pathConstraintSpacing=12]="pathConstraintSpacing",t[t.pathConstraintMix=13]="pathConstraintMix",t[t.twoColor=14]="twoColor"}(i=t.TimelineType||(t.TimelineType={}));var o=function(){function e(n){if(n<=0)throw new Error("frameCount must be > 0: "+n);this.curves=t.Utils.newFloatArray((n-1)*e.BEZIER_SIZE)}return e.prototype.getFrameCount=function(){return this.curves.length/e.BEZIER_SIZE+1},e.prototype.setLinear=function(t){this.curves[t*e.BEZIER_SIZE]=e.LINEAR},e.prototype.setStepped=function(t){this.curves[t*e.BEZIER_SIZE]=e.STEPPED},e.prototype.getCurveType=function(t){var n=t*e.BEZIER_SIZE;if(n==this.curves.length)return e.LINEAR;var i=this.curves[n];return i==e.LINEAR?e.LINEAR:i==e.STEPPED?e.STEPPED:e.BEZIER},e.prototype.setCurve=function(t,n,i,r,o){var a=.03*(2*-n+r),s=.03*(2*-i+o),c=.006*(3*(n-r)+1),l=.006*(3*(i-o)+1),u=2*a+c,h=2*s+l,_=.3*n+a+.16666667*c,f=.3*i+s+.16666667*l,d=t*e.BEZIER_SIZE,p=this.curves;p[d++]=e.BEZIER;for(var m=_,v=f,g=d+e.BEZIER_SIZE-1;d<g;d+=2)p[d]=m,p[d+1]=v,_+=u,f+=h,u+=c,h+=l,m+=_,v+=f},e.prototype.getCurvePercent=function(n,i){i=t.MathUtils.clamp(i,0,1);var r=this.curves,o=n*e.BEZIER_SIZE,a=r[o];if(a==e.LINEAR)return i;if(a==e.STEPPED)return 0;for(var s=0,c=++o,l=o+e.BEZIER_SIZE-1;o<l;o+=2)if((s=r[o])>=i){var u=void 0,h=void 0;return o==c?(u=0,h=0):(u=r[o-2],h=r[o-1]),h+(r[o+1]-h)*(i-u)/(s-u)}var _=r[o-1];return _+(1-_)*(i-s)/(1-s)},e.LINEAR=0,e.STEPPED=1,e.BEZIER=2,e.BEZIER_SIZE=19,e}();t.CurveTimeline=o;var a=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e<<1),i}return iet(o,n),o.prototype.getPropertyId=function(){return(i.rotate<<24)+this.boneIndex},o.prototype.setFrame=function(t,e,n){t<<=1,this.frames[t]=e,this.frames[t+o.ROTATION]=n},o.prototype.apply=function(t,n,i,a,s,c){var l=this.frames,u=t.bones[this.boneIndex];if(u.active)if(i<l[0])switch(c){case e.setup:return void(u.rotation=u.data.rotation);case e.first:var h=u.data.rotation-u.rotation;u.rotation+=(h-360*(16384-(16384.499999999996-h/360|0)))*s}else if(i>=l[l.length-o.ENTRIES]){var _=l[l.length+o.PREV_ROTATION];switch(c){case e.setup:u.rotation=u.data.rotation+_*s;break;case e.first:case e.replace:_+=u.data.rotation-u.rotation,_-=360*(16384-(16384.499999999996-_/360|0));case e.add:u.rotation+=_*s}}else{var f=r.binarySearch(l,i,o.ENTRIES),d=l[f+o.PREV_ROTATION],p=l[f],m=this.getCurvePercent((f>>1)-1,1-(i-p)/(l[f+o.PREV_TIME]-p)),v=l[f+o.ROTATION]-d;switch(v=d+(v-360*(16384-(16384.499999999996-v/360|0)))*m,c){case e.setup:u.rotation=u.data.rotation+(v-360*(16384-(16384.499999999996-v/360|0)))*s;break;case e.first:case e.replace:v+=u.data.rotation-u.rotation;case e.add:u.rotation+=(v-360*(16384-(16384.499999999996-v/360|0)))*s}}},o.ENTRIES=2,o.PREV_TIME=-2,o.PREV_ROTATION=-1,o.ROTATION=1,o}(o);t.RotateTimeline=a;var s=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return iet(o,n),o.prototype.getPropertyId=function(){return(i.translate<<24)+this.boneIndex},o.prototype.setFrame=function(t,e,n,i){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.X]=n,this.frames[t+o.Y]=i},o.prototype.apply=function(t,n,i,a,s,c){var l=this.frames,u=t.bones[this.boneIndex];if(u.active)if(i<l[0])switch(c){case e.setup:return u.x=u.data.x,void(u.y=u.data.y);case e.first:u.x+=(u.data.x-u.x)*s,u.y+=(u.data.y-u.y)*s}else{var h=0,_=0;if(i>=l[l.length-o.ENTRIES])h=l[l.length+o.PREV_X],_=l[l.length+o.PREV_Y];else{var f=r.binarySearch(l,i,o.ENTRIES);h=l[f+o.PREV_X],_=l[f+o.PREV_Y];var d=l[f],p=this.getCurvePercent(f/o.ENTRIES-1,1-(i-d)/(l[f+o.PREV_TIME]-d));h+=(l[f+o.X]-h)*p,_+=(l[f+o.Y]-_)*p}switch(c){case e.setup:u.x=u.data.x+h*s,u.y=u.data.y+_*s;break;case e.first:case e.replace:u.x+=(u.data.x+h-u.x)*s,u.y+=(u.data.y+_-u.y)*s;break;case e.add:u.x+=h*s,u.y+=_*s}}},o.ENTRIES=3,o.PREV_TIME=-3,o.PREV_X=-2,o.PREV_Y=-1,o.X=1,o.Y=2,o}(o);t.TranslateTimeline=s;var c=function(o){function a(t){return o.call(this,t)||this}return iet(a,o),a.prototype.getPropertyId=function(){return(i.scale<<24)+this.boneIndex},a.prototype.apply=function(i,o,s,c,l,u,h){var _=this.frames,f=i.bones[this.boneIndex];if(f.active)if(s<_[0])switch(u){case e.setup:return f.scaleX=f.data.scaleX,void(f.scaleY=f.data.scaleY);case e.first:f.scaleX+=(f.data.scaleX-f.scaleX)*l,f.scaleY+=(f.data.scaleY-f.scaleY)*l}else{var d=0,p=0;if(s>=_[_.length-a.ENTRIES])d=_[_.length+a.PREV_X]*f.data.scaleX,p=_[_.length+a.PREV_Y]*f.data.scaleY;else{var m=r.binarySearch(_,s,a.ENTRIES);d=_[m+a.PREV_X],p=_[m+a.PREV_Y];var v=_[m],g=this.getCurvePercent(m/a.ENTRIES-1,1-(s-v)/(_[m+a.PREV_TIME]-v));d=(d+(_[m+a.X]-d)*g)*f.data.scaleX,p=(p+(_[m+a.Y]-p)*g)*f.data.scaleY}if(1==l)u==e.add?(f.scaleX+=d-f.data.scaleX,f.scaleY+=p-f.data.scaleY):(f.scaleX=d,f.scaleY=p);else{var y=0,x=0;if(h==n.mixOut)switch(u){case e.setup:y=f.data.scaleX,x=f.data.scaleY,f.scaleX=y+(Math.abs(d)*t.MathUtils.signum(y)-y)*l,f.scaleY=x+(Math.abs(p)*t.MathUtils.signum(x)-x)*l;break;case e.first:case e.replace:y=f.scaleX,x=f.scaleY,f.scaleX=y+(Math.abs(d)*t.MathUtils.signum(y)-y)*l,f.scaleY=x+(Math.abs(p)*t.MathUtils.signum(x)-x)*l;break;case e.add:y=f.scaleX,x=f.scaleY,f.scaleX=y+(Math.abs(d)*t.MathUtils.signum(y)-f.data.scaleX)*l,f.scaleY=x+(Math.abs(p)*t.MathUtils.signum(x)-f.data.scaleY)*l}else switch(u){case e.setup:y=Math.abs(f.data.scaleX)*t.MathUtils.signum(d),x=Math.abs(f.data.scaleY)*t.MathUtils.signum(p),f.scaleX=y+(d-y)*l,f.scaleY=x+(p-x)*l;break;case e.first:case e.replace:y=Math.abs(f.scaleX)*t.MathUtils.signum(d),x=Math.abs(f.scaleY)*t.MathUtils.signum(p),f.scaleX=y+(d-y)*l,f.scaleY=x+(p-x)*l;break;case e.add:y=t.MathUtils.signum(d),x=t.MathUtils.signum(p),f.scaleX=Math.abs(f.scaleX)*y+(d-Math.abs(f.data.scaleX)*y)*l,f.scaleY=Math.abs(f.scaleY)*x+(p-Math.abs(f.data.scaleY)*x)*l}}}},a}(s);t.ScaleTimeline=c;var l=function(t){function n(e){return t.call(this,e)||this}return iet(n,t),n.prototype.getPropertyId=function(){return(i.shear<<24)+this.boneIndex},n.prototype.apply=function(t,i,o,a,s,c){var l=this.frames,u=t.bones[this.boneIndex];if(u.active)if(o<l[0])switch(c){case e.setup:return u.shearX=u.data.shearX,void(u.shearY=u.data.shearY);case e.first:u.shearX+=(u.data.shearX-u.shearX)*s,u.shearY+=(u.data.shearY-u.shearY)*s}else{var h=0,_=0;if(o>=l[l.length-n.ENTRIES])h=l[l.length+n.PREV_X],_=l[l.length+n.PREV_Y];else{var f=r.binarySearch(l,o,n.ENTRIES);h=l[f+n.PREV_X],_=l[f+n.PREV_Y];var d=l[f],p=this.getCurvePercent(f/n.ENTRIES-1,1-(o-d)/(l[f+n.PREV_TIME]-d));h+=(l[f+n.X]-h)*p,_+=(l[f+n.Y]-_)*p}switch(c){case e.setup:u.shearX=u.data.shearX+h*s,u.shearY=u.data.shearY+_*s;break;case e.first:case e.replace:u.shearX+=(u.data.shearX+h-u.shearX)*s,u.shearY+=(u.data.shearY+_-u.shearY)*s;break;case e.add:u.shearX+=h*s,u.shearY+=_*s}}},n}(s);t.ShearTimeline=l;var u=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return iet(o,n),o.prototype.getPropertyId=function(){return(i.color<<24)+this.slotIndex},o.prototype.setFrame=function(t,e,n,i,r,a){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.R]=n,this.frames[t+o.G]=i,this.frames[t+o.B]=r,this.frames[t+o.A]=a},o.prototype.apply=function(t,n,i,a,s,c){var l=t.slots[this.slotIndex];if(l.bone.active){var u=this.frames;if(i<u[0])switch(c){case e.setup:return void l.color.setFromColor(l.data.color);case e.first:var h=l.color,_=l.data.color;h.add((_.r-h.r)*s,(_.g-h.g)*s,(_.b-h.b)*s,(_.a-h.a)*s)}else{var f=0,d=0,p=0,m=0;if(i>=u[u.length-o.ENTRIES]){var v=u.length;f=u[v+o.PREV_R],d=u[v+o.PREV_G],p=u[v+o.PREV_B],m=u[v+o.PREV_A]}else{var g=r.binarySearch(u,i,o.ENTRIES);f=u[g+o.PREV_R],d=u[g+o.PREV_G],p=u[g+o.PREV_B],m=u[g+o.PREV_A];var y=u[g],x=this.getCurvePercent(g/o.ENTRIES-1,1-(i-y)/(u[g+o.PREV_TIME]-y));f+=(u[g+o.R]-f)*x,d+=(u[g+o.G]-d)*x,p+=(u[g+o.B]-p)*x,m+=(u[g+o.A]-m)*x}1==s?l.color.set(f,d,p,m):(h=l.color,c==e.setup&&h.setFromColor(l.data.color),h.add((f-h.r)*s,(d-h.g)*s,(p-h.b)*s,(m-h.a)*s))}}},o.ENTRIES=5,o.PREV_TIME=-5,o.PREV_R=-4,o.PREV_G=-3,o.PREV_B=-2,o.PREV_A=-1,o.R=1,o.G=2,o.B=3,o.A=4,o}(o);t.ColorTimeline=u;var h=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return iet(o,n),o.prototype.getPropertyId=function(){return(i.twoColor<<24)+this.slotIndex},o.prototype.setFrame=function(t,e,n,i,r,a,s,c,l){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.R]=n,this.frames[t+o.G]=i,this.frames[t+o.B]=r,this.frames[t+o.A]=a,this.frames[t+o.R2]=s,this.frames[t+o.G2]=c,this.frames[t+o.B2]=l},o.prototype.apply=function(t,n,i,a,s,c){var l=t.slots[this.slotIndex];if(l.bone.active){var u=this.frames;if(i<u[0])switch(c){case e.setup:return l.color.setFromColor(l.data.color),void l.darkColor.setFromColor(l.data.darkColor);case e.first:var h=l.color,_=l.darkColor,f=l.data.color,d=l.data.darkColor;h.add((f.r-h.r)*s,(f.g-h.g)*s,(f.b-h.b)*s,(f.a-h.a)*s),_.add((d.r-_.r)*s,(d.g-_.g)*s,(d.b-_.b)*s,0)}else{var p=0,m=0,v=0,g=0,y=0,x=0,S=0;if(i>=u[u.length-o.ENTRIES]){var A=u.length;p=u[A+o.PREV_R],m=u[A+o.PREV_G],v=u[A+o.PREV_B],g=u[A+o.PREV_A],y=u[A+o.PREV_R2],x=u[A+o.PREV_G2],S=u[A+o.PREV_B2]}else{var C=r.binarySearch(u,i,o.ENTRIES);p=u[C+o.PREV_R],m=u[C+o.PREV_G],v=u[C+o.PREV_B],g=u[C+o.PREV_A],y=u[C+o.PREV_R2],x=u[C+o.PREV_G2],S=u[C+o.PREV_B2];var b=u[C],T=this.getCurvePercent(C/o.ENTRIES-1,1-(i-b)/(u[C+o.PREV_TIME]-b));p+=(u[C+o.R]-p)*T,m+=(u[C+o.G]-m)*T,v+=(u[C+o.B]-v)*T,g+=(u[C+o.A]-g)*T,y+=(u[C+o.R2]-y)*T,x+=(u[C+o.G2]-x)*T,S+=(u[C+o.B2]-S)*T}1==s?(l.color.set(p,m,v,g),l.darkColor.set(y,x,S,1)):(h=l.color,_=l.darkColor,c==e.setup&&(h.setFromColor(l.data.color),_.setFromColor(l.data.darkColor)),h.add((p-h.r)*s,(m-h.g)*s,(v-h.b)*s,(g-h.a)*s),_.add((y-_.r)*s,(x-_.g)*s,(S-_.b)*s,0))}}},o.ENTRIES=8,o.PREV_TIME=-8,o.PREV_R=-7,o.PREV_G=-6,o.PREV_B=-5,o.PREV_A=-4,o.PREV_R2=-3,o.PREV_G2=-2,o.PREV_B2=-1,o.R=1,o.G=2,o.B=3,o.A=4,o.R2=5,o.G2=6,o.B2=7,o}(o);t.TwoColorTimeline=h;var _=function(){function o(e){this.frames=t.Utils.newFloatArray(e),this.attachmentNames=new Array(e)}return o.prototype.getPropertyId=function(){return(i.attachment<<24)+this.slotIndex},o.prototype.getFrameCount=function(){return this.frames.length},o.prototype.setFrame=function(t,e,n){this.frames[t]=e,this.attachmentNames[t]=n},o.prototype.apply=function(t,i,o,a,s,c,l){var u=t.slots[this.slotIndex];if(u.bone.active)if(l!=n.mixOut||c!=e.setup){var h=this.frames;if(o<h[0]){if(c==e.setup||c==e.first){var _=u.data.attachmentName;u.setAttachment(null==_?null:t.getAttachment(this.slotIndex,_))}}else{var f;f=o>=h[h.length-1]?h.length-1:r.binarySearch(h,o,1)-1;var d=this.attachmentNames[f];t.slots[this.slotIndex].setAttachment(null==d?null:t.getAttachment(this.slotIndex,d))}}else{var p=u.data.attachmentName;u.setAttachment(null==p?null:t.getAttachment(this.slotIndex,p))}},o}();t.AttachmentTimeline=_;var f=null,d=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e),i.frameVertices=new Array(e),null==f&&(f=t.Utils.newFloatArray(64)),i}return iet(o,n),o.prototype.getPropertyId=function(){return(i.deform<<27)+ +this.attachment.id+this.slotIndex},o.prototype.setFrame=function(t,e,n){this.frames[t]=e,this.frameVertices[t]=n},o.prototype.apply=function(n,i,o,a,s,c){var l=n.slots[this.slotIndex];if(l.bone.active){var u=l.getAttachment();if(u instanceof t.VertexAttachment&&u.deformAttachment==this.attachment){var h=l.deform;0==h.length&&(c=e.setup);var _=this.frameVertices,f=_[0].length,d=this.frames;if(o<d[0]){var p=u;switch(c){case e.setup:return void(h.length=0);case e.first:if(1==s){h.length=0;break}var m=t.Utils.setArraySize(h,f);if(null==p.bones)for(var v=p.vertices,g=0;g<f;g++)m[g]+=(v[g]-m[g])*s;else for(s=1-s,g=0;g<f;g++)m[g]*=s}}else{var y=t.Utils.setArraySize(h,f);if(o>=d[d.length-1]){var x=_[d.length-1];if(1==s)if(c==e.add)if(null==(p=u).bones){v=p.vertices;for(var S=0;S<f;S++)y[S]+=x[S]-v[S]}else for(var A=0;A<f;A++)y[A]+=x[A];else t.Utils.arrayCopy(x,0,y,0,f);else switch(c){case e.setup:var C=u;if(null==C.bones){v=C.vertices;for(var b=0;b<f;b++){var T=v[b];y[b]=T+(x[b]-T)*s}}else for(var E=0;E<f;E++)y[E]=x[E]*s;break;case e.first:case e.replace:for(var w=0;w<f;w++)y[w]+=(x[w]-y[w])*s;case e.add:if(null==(p=u).bones){v=p.vertices;for(var P=0;P<f;P++)y[P]+=(x[P]-v[P])*s}else for(var I=0;I<f;I++)y[I]+=x[I]*s}}else{var R=r.binarySearch(d,o),D=_[R-1],M=_[R],B=d[R],O=this.getCurvePercent(R-1,1-(o-B)/(d[R-1]-B));if(1==s)if(c==e.add)if(null==(p=u).bones){v=p.vertices;for(var N=0;N<f;N++){var L=D[N];y[N]+=L+(M[N]-L)*O-v[N]}}else for(var F=0;F<f;F++)L=D[F],y[F]+=L+(M[F]-L)*O;else for(var z=0;z<f;z++)L=D[z],y[z]=L+(M[z]-L)*O;else switch(c){case e.setup:var V=u;if(null==V.bones){v=V.vertices;for(var k=0;k<f;k++)L=D[k],T=v[k],y[k]=T+(L+(M[k]-L)*O-T)*s}else for(var G=0;G<f;G++)L=D[G],y[G]=(L+(M[G]-L)*O)*s;break;case e.first:case e.replace:for(var U=0;U<f;U++)L=D[U],y[U]+=(L+(M[U]-L)*O-y[U])*s;break;case e.add:if(null==(p=u).bones){v=p.vertices;for(var H=0;H<f;H++)L=D[H],y[H]+=(L+(M[H]-L)*O-v[H])*s}else for(var j=0;j<f;j++)L=D[j],y[j]+=(L+(M[j]-L)*O)*s}}}}}},o}(o);t.DeformTimeline=d;var p=function(){function e(e){this.frames=t.Utils.newFloatArray(e),this.events=new Array(e)}return e.prototype.getPropertyId=function(){return i.event<<24},e.prototype.getFrameCount=function(){return this.frames.length},e.prototype.setFrame=function(t,e){this.frames[t]=e.time,this.events[t]=e},e.prototype.apply=function(t,e,n,i,o,a,s){if(null!=i){var c=this.frames,l=this.frames.length;if(e>n)this.apply(t,e,Number.MAX_VALUE,i,o,a,s),e=-1;else if(e>=c[l-1])return;if(!(n<c[0])){var u=0;if(e<c[0])u=0;else for(var h=c[u=r.binarySearch(c,e)];u>0&&c[u-1]==h;)u--;for(;u<l&&n>=c[u];u++)i.push(this.events[u])}}},e}();t.EventTimeline=p;var m=function(){function o(e){this.frames=t.Utils.newFloatArray(e),this.drawOrders=new Array(e)}return o.prototype.getPropertyId=function(){return i.drawOrder<<24},o.prototype.getFrameCount=function(){return this.frames.length},o.prototype.setFrame=function(t,e,n){this.frames[t]=e,this.drawOrders[t]=n},o.prototype.apply=function(i,o,a,s,c,l,u){var h=i.drawOrder,_=i.slots;if(u!=n.mixOut||l!=e.setup){var f=this.frames;if(a<f[0])l!=e.setup&&l!=e.first||t.Utils.arrayCopy(i.slots,0,i.drawOrder,0,i.slots.length);else{var d;d=a>=f[f.length-1]?f.length-1:r.binarySearch(f,a)-1;var p=this.drawOrders[d];if(null==p)t.Utils.arrayCopy(_,0,h,0,_.length);else for(var m=0,v=p.length;m<v;m++)h[m]=_[p[m]]}}else t.Utils.arrayCopy(i.slots,0,i.drawOrder,0,i.slots.length)},o}();t.DrawOrderTimeline=m;var v=function(o){function a(e){var n=o.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*a.ENTRIES),n}return iet(a,o),a.prototype.getPropertyId=function(){return(i.ikConstraint<<24)+this.ikConstraintIndex},a.prototype.setFrame=function(t,e,n,i,r,o,s){t*=a.ENTRIES,this.frames[t]=e,this.frames[t+a.MIX]=n,this.frames[t+a.SOFTNESS]=i,this.frames[t+a.BEND_DIRECTION]=r,this.frames[t+a.COMPRESS]=o?1:0,this.frames[t+a.STRETCH]=s?1:0},a.prototype.apply=function(t,i,o,s,c,l,u){var h=this.frames,_=t.ikConstraints[this.ikConstraintIndex];if(_.active)if(o<h[0])switch(l){case e.setup:return _.mix=_.data.mix,_.softness=_.data.softness,_.bendDirection=_.data.bendDirection,_.compress=_.data.compress,void(_.stretch=_.data.stretch);case e.first:_.mix+=(_.data.mix-_.mix)*c,_.softness+=(_.data.softness-_.softness)*c,_.bendDirection=_.data.bendDirection,_.compress=_.data.compress,_.stretch=_.data.stretch}else if(o>=h[h.length-a.ENTRIES])l==e.setup?(_.mix=_.data.mix+(h[h.length+a.PREV_MIX]-_.data.mix)*c,_.softness=_.data.softness+(h[h.length+a.PREV_SOFTNESS]-_.data.softness)*c,u==n.mixOut?(_.bendDirection=_.data.bendDirection,_.compress=_.data.compress,_.stretch=_.data.stretch):(_.bendDirection=h[h.length+a.PREV_BEND_DIRECTION],_.compress=0!=h[h.length+a.PREV_COMPRESS],_.stretch=0!=h[h.length+a.PREV_STRETCH])):(_.mix+=(h[h.length+a.PREV_MIX]-_.mix)*c,_.softness+=(h[h.length+a.PREV_SOFTNESS]-_.softness)*c,u==n.mixIn&&(_.bendDirection=h[h.length+a.PREV_BEND_DIRECTION],_.compress=0!=h[h.length+a.PREV_COMPRESS],_.stretch=0!=h[h.length+a.PREV_STRETCH]));else{var f=r.binarySearch(h,o,a.ENTRIES),d=h[f+a.PREV_MIX],p=h[f+a.PREV_SOFTNESS],m=h[f],v=this.getCurvePercent(f/a.ENTRIES-1,1-(o-m)/(h[f+a.PREV_TIME]-m));l==e.setup?(_.mix=_.data.mix+(d+(h[f+a.MIX]-d)*v-_.data.mix)*c,_.softness=_.data.softness+(p+(h[f+a.SOFTNESS]-p)*v-_.data.softness)*c,u==n.mixOut?(_.bendDirection=_.data.bendDirection,_.compress=_.data.compress,_.stretch=_.data.stretch):(_.bendDirection=h[f+a.PREV_BEND_DIRECTION],_.compress=0!=h[f+a.PREV_COMPRESS],_.stretch=0!=h[f+a.PREV_STRETCH])):(_.mix+=(d+(h[f+a.MIX]-d)*v-_.mix)*c,_.softness+=(p+(h[f+a.SOFTNESS]-p)*v-_.softness)*c,u==n.mixIn&&(_.bendDirection=h[f+a.PREV_BEND_DIRECTION],_.compress=0!=h[f+a.PREV_COMPRESS],_.stretch=0!=h[f+a.PREV_STRETCH]))}},a.ENTRIES=6,a.PREV_TIME=-6,a.PREV_MIX=-5,a.PREV_SOFTNESS=-4,a.PREV_BEND_DIRECTION=-3,a.PREV_COMPRESS=-2,a.PREV_STRETCH=-1,a.MIX=1,a.SOFTNESS=2,a.BEND_DIRECTION=3,a.COMPRESS=4,a.STRETCH=5,a}(o);t.IkConstraintTimeline=v;var g=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return iet(o,n),o.prototype.getPropertyId=function(){return(i.transformConstraint<<24)+this.transformConstraintIndex},o.prototype.setFrame=function(t,e,n,i,r,a){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.ROTATE]=n,this.frames[t+o.TRANSLATE]=i,this.frames[t+o.SCALE]=r,this.frames[t+o.SHEAR]=a},o.prototype.apply=function(t,n,i,a,s,c){var l=this.frames,u=t.transformConstraints[this.transformConstraintIndex];if(u.active)if(i<l[0]){var h=u.data;switch(c){case e.setup:return u.rotateMix=h.rotateMix,u.translateMix=h.translateMix,u.scaleMix=h.scaleMix,void(u.shearMix=h.shearMix);case e.first:u.rotateMix+=(h.rotateMix-u.rotateMix)*s,u.translateMix+=(h.translateMix-u.translateMix)*s,u.scaleMix+=(h.scaleMix-u.scaleMix)*s,u.shearMix+=(h.shearMix-u.shearMix)*s}}else{var _=0,f=0,d=0,p=0;if(i>=l[l.length-o.ENTRIES]){var m=l.length;_=l[m+o.PREV_ROTATE],f=l[m+o.PREV_TRANSLATE],d=l[m+o.PREV_SCALE],p=l[m+o.PREV_SHEAR]}else{var v=r.binarySearch(l,i,o.ENTRIES);_=l[v+o.PREV_ROTATE],f=l[v+o.PREV_TRANSLATE],d=l[v+o.PREV_SCALE],p=l[v+o.PREV_SHEAR];var g=l[v],y=this.getCurvePercent(v/o.ENTRIES-1,1-(i-g)/(l[v+o.PREV_TIME]-g));_+=(l[v+o.ROTATE]-_)*y,f+=(l[v+o.TRANSLATE]-f)*y,d+=(l[v+o.SCALE]-d)*y,p+=(l[v+o.SHEAR]-p)*y}c==e.setup?(h=u.data,u.rotateMix=h.rotateMix+(_-h.rotateMix)*s,u.translateMix=h.translateMix+(f-h.translateMix)*s,u.scaleMix=h.scaleMix+(d-h.scaleMix)*s,u.shearMix=h.shearMix+(p-h.shearMix)*s):(u.rotateMix+=(_-u.rotateMix)*s,u.translateMix+=(f-u.translateMix)*s,u.scaleMix+=(d-u.scaleMix)*s,u.shearMix+=(p-u.shearMix)*s)}},o.ENTRIES=5,o.PREV_TIME=-5,o.PREV_ROTATE=-4,o.PREV_TRANSLATE=-3,o.PREV_SCALE=-2,o.PREV_SHEAR=-1,o.ROTATE=1,o.TRANSLATE=2,o.SCALE=3,o.SHEAR=4,o}(o);t.TransformConstraintTimeline=g;var y=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return iet(o,n),o.prototype.getPropertyId=function(){return(i.pathConstraintPosition<<24)+this.pathConstraintIndex},o.prototype.setFrame=function(t,e,n){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.VALUE]=n},o.prototype.apply=function(t,n,i,a,s,c){var l=this.frames,u=t.pathConstraints[this.pathConstraintIndex];if(u.active)if(i<l[0])switch(c){case e.setup:return void(u.position=u.data.position);case e.first:u.position+=(u.data.position-u.position)*s}else{var h=0;if(i>=l[l.length-o.ENTRIES])h=l[l.length+o.PREV_VALUE];else{var _=r.binarySearch(l,i,o.ENTRIES);h=l[_+o.PREV_VALUE];var f=l[_],d=this.getCurvePercent(_/o.ENTRIES-1,1-(i-f)/(l[_+o.PREV_TIME]-f));h+=(l[_+o.VALUE]-h)*d}c==e.setup?u.position=u.data.position+(h-u.data.position)*s:u.position+=(h-u.position)*s}},o.ENTRIES=2,o.PREV_TIME=-2,o.PREV_VALUE=-1,o.VALUE=1,o}(o);t.PathConstraintPositionTimeline=y;var x=function(t){function n(e){return t.call(this,e)||this}return iet(n,t),n.prototype.getPropertyId=function(){return(i.pathConstraintSpacing<<24)+this.pathConstraintIndex},n.prototype.apply=function(t,i,o,a,s,c){var l=this.frames,u=t.pathConstraints[this.pathConstraintIndex];if(u.active)if(o<l[0])switch(c){case e.setup:return void(u.spacing=u.data.spacing);case e.first:u.spacing+=(u.data.spacing-u.spacing)*s}else{var h=0;if(o>=l[l.length-n.ENTRIES])h=l[l.length+n.PREV_VALUE];else{var _=r.binarySearch(l,o,n.ENTRIES);h=l[_+n.PREV_VALUE];var f=l[_],d=this.getCurvePercent(_/n.ENTRIES-1,1-(o-f)/(l[_+n.PREV_TIME]-f));h+=(l[_+n.VALUE]-h)*d}c==e.setup?u.spacing=u.data.spacing+(h-u.data.spacing)*s:u.spacing+=(h-u.spacing)*s}},n}(y);t.PathConstraintSpacingTimeline=x;var S=function(n){function o(e){var i=n.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return iet(o,n),o.prototype.getPropertyId=function(){return(i.pathConstraintMix<<24)+this.pathConstraintIndex},o.prototype.setFrame=function(t,e,n,i){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.ROTATE]=n,this.frames[t+o.TRANSLATE]=i},o.prototype.apply=function(t,n,i,a,s,c){var l=this.frames,u=t.pathConstraints[this.pathConstraintIndex];if(u.active)if(i<l[0])switch(c){case e.setup:return u.rotateMix=u.data.rotateMix,void(u.translateMix=u.data.translateMix);case e.first:u.rotateMix+=(u.data.rotateMix-u.rotateMix)*s,u.translateMix+=(u.data.translateMix-u.translateMix)*s}else{var h=0,_=0;if(i>=l[l.length-o.ENTRIES])h=l[l.length+o.PREV_ROTATE],_=l[l.length+o.PREV_TRANSLATE];else{var f=r.binarySearch(l,i,o.ENTRIES);h=l[f+o.PREV_ROTATE],_=l[f+o.PREV_TRANSLATE];var d=l[f],p=this.getCurvePercent(f/o.ENTRIES-1,1-(i-d)/(l[f+o.PREV_TIME]-d));h+=(l[f+o.ROTATE]-h)*p,_+=(l[f+o.TRANSLATE]-_)*p}c==e.setup?(u.rotateMix=u.data.rotateMix+(h-u.data.rotateMix)*s,u.translateMix=u.data.translateMix+(_-u.data.translateMix)*s):(u.rotateMix+=(h-u.rotateMix)*s,u.translateMix+=(_-u.translateMix)*s)}},o.ENTRIES=3,o.PREV_TIME=-3,o.PREV_ROTATE=-2,o.PREV_TRANSLATE=-1,o.ROTATE=1,o.TRANSLATE=2,o}(o);t.PathConstraintMixTimeline=S}(net||(net={})),function(t){var e=function(){function e(e){this.tracks=new Array,this.timeScale=1,this.events=new Array,this.listeners=new Array,this.queue=new r(this),this.propertyIDs=new t.IntSet,this.animationsChanged=!1,this.trackEntryPool=new t.Pool((function(){return new n})),this.data=e}return e.prototype.update=function(t){t*=this.timeScale;for(var e=this.tracks,n=0,i=e.length;n<i;n++){var r=e[n];if(null!=r){r.animationLast=r.nextAnimationLast,r.trackLast=r.nextTrackLast;var o=t*r.timeScale;if(r.delay>0){if(r.delay-=o,r.delay>0)continue;o=-r.delay,r.delay=0}var a=r.next;if(null!=a){var s=r.trackLast-a.delay;if(s>=0){for(a.delay=0,a.trackTime+=0==r.timeScale?0:(s/r.timeScale+t)*a.timeScale,r.trackTime+=o,this.setCurrent(n,a,!0);null!=a.mixingFrom;)a.mixTime+=t,a=a.mixingFrom;continue}}else if(r.trackLast>=r.trackEnd&&null==r.mixingFrom){e[n]=null,this.queue.end(r),this.disposeNext(r);continue}if(null!=r.mixingFrom&&this.updateMixingFrom(r,t)){var c=r.mixingFrom;for(r.mixingFrom=null,null!=c&&(c.mixingTo=null);null!=c;)this.queue.end(c),c=c.mixingFrom}r.trackTime+=o}}this.queue.drain()},e.prototype.updateMixingFrom=function(t,e){var n=t.mixingFrom;if(null==n)return!0;var i=this.updateMixingFrom(n,e);return n.animationLast=n.nextAnimationLast,n.trackLast=n.nextTrackLast,t.mixTime>0&&t.mixTime>=t.mixDuration?(0!=n.totalAlpha&&0!=t.mixDuration||(t.mixingFrom=n.mixingFrom,null!=n.mixingFrom&&(n.mixingFrom.mixingTo=t),t.interruptAlpha=n.interruptAlpha,this.queue.end(n)),i):(n.trackTime+=e*n.timeScale,t.mixTime+=e,!1)},e.prototype.apply=function(n){if(null==n)throw new Error("skeleton cannot be null.");this.animationsChanged&&this._animationsChanged();for(var i=this.events,r=this.tracks,o=!1,a=0,s=r.length;a<s;a++){var c=r[a];if(!(null==c||c.delay>0)){o=!0;var l=0==a?t.MixBlend.first:c.mixBlend,u=c.alpha;null!=c.mixingFrom?u*=this.applyMixingFrom(c,n,l):c.trackTime>=c.trackEnd&&null==c.next&&(u=0);var h=c.animationLast,_=c.getAnimationTime(),f=c.animation.timelines.length,d=c.animation.timelines;if(0==a&&1==u||l==t.MixBlend.add)for(var p=0;p<f;p++)t.Utils.webkit602BugfixHelper(u,l),d[p].apply(n,h,_,i,u,l,t.MixDirection.mixIn);else{var m=c.timelineMode,v=0==c.timelinesRotation.length;v&&t.Utils.setArraySize(c.timelinesRotation,f<<1,null);var g=c.timelinesRotation;for(p=0;p<f;p++){var y=d[p],x=(m[p]&e.NOT_LAST-1)==e.SUBSEQUENT?l:t.MixBlend.setup;y instanceof t.RotateTimeline?this.applyRotateTimeline(y,n,_,u,x,g,p<<1,v):(t.Utils.webkit602BugfixHelper(u,l),y.apply(n,h,_,i,u,x,t.MixDirection.mixIn))}}this.queueEvents(c,_),i.length=0,c.nextAnimationLast=_,c.nextTrackLast=c.trackTime}}return this.queue.drain(),o},e.prototype.applyMixingFrom=function(n,i,r){var o=n.mixingFrom;null!=o.mixingFrom&&this.applyMixingFrom(o,i,r);var a=0;0==n.mixDuration?(a=1,r==t.MixBlend.first&&(r=t.MixBlend.setup)):((a=n.mixTime/n.mixDuration)>1&&(a=1),r!=t.MixBlend.first&&(r=o.mixBlend));var s=a<o.eventThreshold?this.events:null,c=a<o.attachmentThreshold,l=a<o.drawOrderThreshold,u=o.animationLast,h=o.getAnimationTime(),_=o.animation.timelines.length,f=o.animation.timelines,d=o.alpha*n.interruptAlpha,p=d*(1-a);if(r==t.MixBlend.add)for(var m=0;m<_;m++)f[m].apply(i,u,h,s,p,r,t.MixDirection.mixOut);else{var v=o.timelineMode,g=o.timelineHoldMix,y=0==o.timelinesRotation.length;y&&t.Utils.setArraySize(o.timelinesRotation,_<<1,null);var x=o.timelinesRotation;for(o.totalAlpha=0,m=0;m<_;m++){var S=f[m],A=t.MixDirection.mixOut,C=void 0,b=0;switch(v[m]&e.NOT_LAST-1){case e.SUBSEQUENT:if(C=r,!c&&S instanceof t.AttachmentTimeline){if((v[m]&e.NOT_LAST)==e.NOT_LAST)continue;C=t.MixBlend.setup}if(!l&&S instanceof t.DrawOrderTimeline)continue;b=p;break;case e.FIRST:C=t.MixBlend.setup,b=p;break;case e.HOLD:C=t.MixBlend.setup,b=d;break;default:C=t.MixBlend.setup;var T=g[m];b=d*Math.max(0,1-T.mixTime/T.mixDuration)}o.totalAlpha+=b,S instanceof t.RotateTimeline?this.applyRotateTimeline(S,i,h,b,C,x,m<<1,y):(t.Utils.webkit602BugfixHelper(b,r),C==t.MixBlend.setup&&(S instanceof t.AttachmentTimeline?(c||(v[m]&e.NOT_LAST)==e.NOT_LAST)&&(A=t.MixDirection.mixIn):S instanceof t.DrawOrderTimeline&&l&&(A=t.MixDirection.mixIn)),S.apply(i,u,h,s,b,C,A))}}return n.mixDuration>0&&this.queueEvents(o,h),this.events.length=0,o.nextAnimationLast=h,o.nextTrackLast=o.trackTime,a},e.prototype.applyRotateTimeline=function(e,n,i,r,o,a,s,c){if(c&&(a[s]=0),1!=r){var l=e,u=l.frames,h=n.bones[l.boneIndex];if(h.active){var _=0,f=0;if(i<u[0])switch(o){case t.MixBlend.setup:h.rotation=h.data.rotation;default:return;case t.MixBlend.first:_=h.rotation,f=h.data.rotation}else if(_=o==t.MixBlend.setup?h.data.rotation:h.rotation,i>=u[u.length-t.RotateTimeline.ENTRIES])f=h.data.rotation+u[u.length+t.RotateTimeline.PREV_ROTATION];else{var d=t.Animation.binarySearch(u,i,t.RotateTimeline.ENTRIES),p=u[d+t.RotateTimeline.PREV_ROTATION],m=u[d],v=l.getCurvePercent((d>>1)-1,1-(i-m)/(u[d+t.RotateTimeline.PREV_TIME]-m));f=u[d+t.RotateTimeline.ROTATION]-p,f=p+(f-=360*(16384-(16384.499999999996-f/360|0)))*v+h.data.rotation,f-=360*(16384-(16384.499999999996-f/360|0))}var g=0,y=f-_;if(0==(y-=360*(16384-(16384.499999999996-y/360|0))))g=a[s];else{var x=0,S=0;c?(x=0,S=y):(x=a[s],S=a[s+1]);var A=y>0,C=x>=0;t.MathUtils.signum(S)!=t.MathUtils.signum(y)&&Math.abs(S)<=90&&(Math.abs(x)>180&&(x+=360*t.MathUtils.signum(x)),C=A),g=y+x-x%360,C!=A&&(g+=360*t.MathUtils.signum(x)),a[s]=g}a[s+1]=y,_+=g*r,h.rotation=_-360*(16384-(16384.499999999996-_/360|0))}}else e.apply(n,0,i,null,1,o,t.MixDirection.mixIn)},e.prototype.queueEvents=function(t,e){for(var n=t.animationStart,i=t.animationEnd,r=i-n,o=t.trackLast%r,a=this.events,s=0,c=a.length;s<c;s++){var l=a[s];if(l.time<o)break;l.time>i||this.queue.event(t,l)}for((t.loop?0==r||o>t.trackTime%r:e>=i&&t.animationLast<i)&&this.queue.complete(t);s<c;s++)a[s].time<n||this.queue.event(t,a[s])},e.prototype.clearTracks=function(){var t=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var e=0,n=this.tracks.length;e<n;e++)this.clearTrack(e);this.tracks.length=0,this.queue.drainDisabled=t,this.queue.drain()},e.prototype.clearTrack=function(t){if(!(t>=this.tracks.length)){var e=this.tracks[t];if(null!=e){this.queue.end(e),this.disposeNext(e);for(var n=e;;){var i=n.mixingFrom;if(null==i)break;this.queue.end(i),n.mixingFrom=null,n.mixingTo=null,n=i}this.tracks[e.trackIndex]=null,this.queue.drain()}}},e.prototype.setCurrent=function(t,e,n){var i=this.expandToIndex(t);this.tracks[t]=e,null!=i&&(n&&this.queue.interrupt(i),e.mixingFrom=i,i.mixingTo=e,e.mixTime=0,null!=i.mixingFrom&&i.mixDuration>0&&(e.interruptAlpha*=Math.min(1,i.mixTime/i.mixDuration)),i.timelinesRotation.length=0),this.queue.start(e)},e.prototype.setAnimation=function(t,e,n){var i=this.data.skeletonData.findAnimation(e);if(null==i)throw new Error("Animation not found: "+e);return this.setAnimationWith(t,i,n)},e.prototype.setAnimationWith=function(t,e,n){if(null==e)throw new Error("animation cannot be null.");var i=!0,r=this.expandToIndex(t);null!=r&&(-1==r.nextTrackLast?(this.tracks[t]=r.mixingFrom,this.queue.interrupt(r),this.queue.end(r),this.disposeNext(r),r=r.mixingFrom,i=!1):this.disposeNext(r));var o=this.trackEntry(t,e,n,r);return this.setCurrent(t,o,i),this.queue.drain(),o},e.prototype.addAnimation=function(t,e,n,i){var r=this.data.skeletonData.findAnimation(e);if(null==r)throw new Error("Animation not found: "+e);return this.addAnimationWith(t,r,n,i)},e.prototype.addAnimationWith=function(t,e,n,i){if(null==e)throw new Error("animation cannot be null.");var r=this.expandToIndex(t);if(null!=r)for(;null!=r.next;)r=r.next;var o=this.trackEntry(t,e,n,r);if(null==r)this.setCurrent(t,o,!0),this.queue.drain();else if(r.next=o,i<=0){var a=r.animationEnd-r.animationStart;0!=a?(r.loop?i+=a*(1+(r.trackTime/a|0)):i+=Math.max(a,r.trackTime),i-=this.data.getMix(r.animation,e)):i=r.trackTime}return o.delay=i,o},e.prototype.setEmptyAnimation=function(t,n){var i=this.setAnimationWith(t,e.emptyAnimation,!1);return i.mixDuration=n,i.trackEnd=n,i},e.prototype.addEmptyAnimation=function(t,n,i){i<=0&&(i-=n);var r=this.addAnimationWith(t,e.emptyAnimation,!1,i);return r.mixDuration=n,r.trackEnd=n,r},e.prototype.setEmptyAnimations=function(t){var e=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var n=0,i=this.tracks.length;n<i;n++){var r=this.tracks[n];null!=r&&this.setEmptyAnimation(r.trackIndex,t)}this.queue.drainDisabled=e,this.queue.drain()},e.prototype.expandToIndex=function(e){return e<this.tracks.length?this.tracks[e]:(t.Utils.ensureArrayCapacity(this.tracks,e+1,null),this.tracks.length=e+1,null)},e.prototype.trackEntry=function(t,e,n,i){var r=this.trackEntryPool.obtain();return r.trackIndex=t,r.animation=e,r.loop=n,r.holdPrevious=!1,r.eventThreshold=0,r.attachmentThreshold=0,r.drawOrderThreshold=0,r.animationStart=0,r.animationEnd=e.duration,r.animationLast=-1,r.nextAnimationLast=-1,r.delay=0,r.trackTime=0,r.trackLast=-1,r.nextTrackLast=-1,r.trackEnd=Number.MAX_VALUE,r.timeScale=1,r.alpha=1,r.interruptAlpha=1,r.mixTime=0,r.mixDuration=null==i?0:this.data.getMix(i.animation,e),r},e.prototype.disposeNext=function(t){for(var e=t.next;null!=e;)this.queue.dispose(e),e=e.next;t.next=null},e.prototype._animationsChanged=function(){this.animationsChanged=!1,this.propertyIDs.clear();for(var e=0,n=this.tracks.length;e<n;e++)if(null!=(i=this.tracks[e])){for(;null!=i.mixingFrom;)i=i.mixingFrom;do{null!=i.mixingFrom&&i.mixBlend==t.MixBlend.add||this.computeHold(i),i=i.mixingTo}while(null!=i)}for(this.propertyIDs.clear(),e=this.tracks.length-1;e>=0;e--)for(var i=this.tracks[e];null!=i;)this.computeNotLast(i),i=i.mixingFrom},e.prototype.computeHold=function(n){var i=n.mixingTo,r=n.animation.timelines,o=n.animation.timelines.length,a=t.Utils.setArraySize(n.timelineMode,o);n.timelineHoldMix.length=0;var s=t.Utils.setArraySize(n.timelineHoldMix,o),c=this.propertyIDs;if(null!=i&&i.holdPrevious)for(var l=0;l<o;l++)c.add(r[l].getPropertyId()),a[l]=e.HOLD;else t:for(l=0;l<o;l++){var u=r[l],h=u.getPropertyId();if(c.add(h))if(null==i||u instanceof t.AttachmentTimeline||u instanceof t.DrawOrderTimeline||u instanceof t.EventTimeline||!i.animation.hasTimeline(h))a[l]=e.FIRST;else{for(var _=i.mixingTo;null!=_;_=_.mixingTo)if(!_.animation.hasTimeline(h)){if(n.mixDuration>0){a[l]=e.HOLD_MIX,s[l]=_;continue t}break}a[l]=e.HOLD}else a[l]=e.SUBSEQUENT}},e.prototype.computeNotLast=function(n){for(var i=n.animation.timelines,r=n.animation.timelines.length,o=n.timelineMode,a=this.propertyIDs,s=0;s<r;s++)if(i[s]instanceof t.AttachmentTimeline){var c=i[s];a.add(c.slotIndex)||(o[s]|=e.NOT_LAST)}},e.prototype.getCurrent=function(t){return t>=this.tracks.length?null:this.tracks[t]},e.prototype.addListener=function(t){if(null==t)throw new Error("listener cannot be null.");this.listeners.push(t)},e.prototype.removeListener=function(t){var e=this.listeners.indexOf(t);e>=0&&this.listeners.splice(e,1)},e.prototype.clearListeners=function(){this.listeners.length=0},e.prototype.clearListenerNotifications=function(){this.queue.clear()},e.emptyAnimation=new t.Animation("<empty>",[],0),e.SUBSEQUENT=0,e.FIRST=1,e.HOLD=2,e.HOLD_MIX=3,e.NOT_LAST=4,e}();t.AnimationState=e;var n=function(){function e(){this.mixBlend=t.MixBlend.replace,this.timelineMode=new Array,this.timelineHoldMix=new Array,this.timelinesRotation=new Array}return e.prototype.reset=function(){this.next=null,this.mixingFrom=null,this.mixingTo=null,this.animation=null,this.listener=null,this.timelineMode.length=0,this.timelineHoldMix.length=0,this.timelinesRotation.length=0},e.prototype.getAnimationTime=function(){if(this.loop){var t=this.animationEnd-this.animationStart;return 0==t?this.animationStart:this.trackTime%t+this.animationStart}return Math.min(this.trackTime+this.animationStart,this.animationEnd)},e.prototype.setAnimationLast=function(t){this.animationLast=t,this.nextAnimationLast=t},e.prototype.isComplete=function(){return this.trackTime>=this.animationEnd-this.animationStart},e.prototype.resetRotationDirections=function(){this.timelinesRotation.length=0},e}();t.TrackEntry=n;var i,r=function(){function t(t){this.objects=[],this.drainDisabled=!1,this.animState=t}return t.prototype.start=function(t){this.objects.push(i.start),this.objects.push(t),this.animState.animationsChanged=!0},t.prototype.interrupt=function(t){this.objects.push(i.interrupt),this.objects.push(t)},t.prototype.end=function(t){this.objects.push(i.end),this.objects.push(t),this.animState.animationsChanged=!0},t.prototype.dispose=function(t){this.objects.push(i.dispose),this.objects.push(t)},t.prototype.complete=function(t){this.objects.push(i.complete),this.objects.push(t)},t.prototype.event=function(t,e){this.objects.push(i.event),this.objects.push(t),this.objects.push(e)},t.prototype.drain=function(){if(!this.drainDisabled){this.drainDisabled=!0;for(var t=this.objects,e=this.animState.listeners,n=0;n<t.length;n+=2){var r=t[n],o=t[n+1];switch(r){case i.start:null!=o.listener&&o.listener.start&&o.listener.start(o);for(var a=0;a<e.length;a++)e[a].start&&e[a].start(o);break;case i.interrupt:for(null!=o.listener&&o.listener.interrupt&&o.listener.interrupt(o),a=0;a<e.length;a++)e[a].interrupt&&e[a].interrupt(o);break;case i.end:for(null!=o.listener&&o.listener.end&&o.listener.end(o),a=0;a<e.length;a++)e[a].end&&e[a].end(o);case i.dispose:for(null!=o.listener&&o.listener.dispose&&o.listener.dispose(o),a=0;a<e.length;a++)e[a].dispose&&e[a].dispose(o);this.animState.trackEntryPool.free(o);break;case i.complete:for(null!=o.listener&&o.listener.complete&&o.listener.complete(o),a=0;a<e.length;a++)e[a].complete&&e[a].complete(o);break;case i.event:var s=t[2+n++];for(null!=o.listener&&o.listener.event&&o.listener.event(o,s),a=0;a<e.length;a++)e[a].event&&e[a].event(o,s)}}this.clear(),this.drainDisabled=!1}},t.prototype.clear=function(){this.objects.length=0},t}();t.EventQueue=r,function(t){t[t.start=0]="start",t[t.interrupt=1]="interrupt",t[t.end=2]="end",t[t.dispose=3]="dispose",t[t.complete=4]="complete",t[t.event=5]="event"}(i=t.EventType||(t.EventType={}));var o=function(){function t(){}return t.prototype.start=function(){},t.prototype.interrupt=function(){},t.prototype.end=function(){},t.prototype.dispose=function(){},t.prototype.complete=function(){},t.prototype.event=function(){},t}();t.AnimationStateAdapter=o}(net||(net={})),function(t){var e=function(){function t(t){if(this.animationToMixTime={},this.defaultMix=0,null==t)throw new Error("skeletonData cannot be null.");this.skeletonData=t}return t.prototype.setMix=function(t,e,n){var i=this.skeletonData.findAnimation(t);if(null==i)throw new Error("Animation not found: "+t);var r=this.skeletonData.findAnimation(e);if(null==r)throw new Error("Animation not found: "+e);this.setMixWith(i,r,n)},t.prototype.setMixWith=function(t,e,n){if(null==t)throw new Error("from cannot be null.");if(null==e)throw new Error("to cannot be null.");var i=t.name+"."+e.name;this.animationToMixTime[i]=n},t.prototype.getMix=function(t,e){var n=t.name+"."+e.name,i=this.animationToMixTime[n];return void 0===i?this.defaultMix:i},t}();t.AnimationStateData=e}(net||(net={})),function(t){var e=function(){function e(t,e){void 0===e&&(e=""),this.assets={},this.errors={},this.toLoad=0,this.loaded=0,this.textureLoader=t,this.pathPrefix=e}return e.downloadText=function(t,e,n){var i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){200==i.status?e(i.responseText):n(i.status,i.responseText)},i.onerror=function(){n(i.status,i.responseText)},i.send()},e.downloadBinary=function(t,e,n){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(){200==i.status?e(new Uint8Array(i.response)):n(i.status,i.responseText)},i.onerror=function(){n(i.status,i.responseText)},i.send()},e.prototype.loadBinary=function(t,n,i){var r=this;void 0===n&&(n=null),void 0===i&&(i=null),t=this.pathPrefix+t,this.toLoad++,e.downloadBinary(t,(function(e){r.assets[t]=e,n&&n(t,e),r.toLoad--,r.loaded++}),(function(e,n){r.errors[t]="Couldn't load binary "+t+": status "+status+", "+n,i&&i(t,"Couldn't load binary "+t+": status "+status+", "+n),r.toLoad--,r.loaded++}))},e.prototype.loadText=function(t,n,i){var r=this;void 0===n&&(n=null),void 0===i&&(i=null),t=this.pathPrefix+t,this.toLoad++,e.downloadText(t,(function(e){r.assets[t]=e,n&&n(t,e),r.toLoad--,r.loaded++}),(function(e,n){r.errors[t]="Couldn't load text "+t+": status "+status+", "+n,i&&i(t,"Couldn't load text "+t+": status "+status+", "+n),r.toLoad--,r.loaded++}))},e.prototype.loadTexture=function(t,e,n){var i=this;void 0===e&&(e=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++;var r=new Image;r.crossOrigin="anonymous",r.onload=function(){var n=i.textureLoader(r);i.assets[t]=n,i.toLoad--,i.loaded++,e&&e(t,r)},r.onerror=function(){i.errors[t]="Couldn't load image "+t,i.toLoad--,i.loaded++,n&&n(t,"Couldn't load image "+t)},r.src=t},e.prototype.loadTextureData=function(t,e,n,i){var r=this;void 0===n&&(n=null),void 0===i&&(i=null),t=this.pathPrefix+t,this.toLoad++;var o=new Image;o.onload=function(){var e=r.textureLoader(o);r.assets[t]=e,r.toLoad--,r.loaded++,n&&n(t,o)},o.onerror=function(){r.errors[t]="Couldn't load image "+t,r.toLoad--,r.loaded++,i&&i(t,"Couldn't load image "+t)},o.src=e},e.prototype.loadTextureAtlas=function(n,i,r){var o=this;void 0===i&&(i=null),void 0===r&&(r=null);var a=n.lastIndexOf("/")>=0?n.substring(0,n.lastIndexOf("/")):"";n=this.pathPrefix+n,this.toLoad++,e.downloadText(n,(function(e){var s={count:0},c=new Array;try{new t.TextureAtlas(e,(function(e){c.push(a+"/"+e);var n=document.createElement("img");return n.width=16,n.height=16,new t.FakeTexture(n)}))}catch(t){var l=t;return o.errors[n]="Couldn't load texture atlas "+n+": "+l.message,r&&r(n,"Couldn't load texture atlas "+n+": "+l.message),o.toLoad--,void o.loaded++}for(var u=function(l){var u=!1;o.loadTexture(l,(function(l){if(s.count++,s.count==c.length)if(u)o.errors[n]="Couldn't load texture atlas page "+l+"} of atlas "+n,r&&r(n,"Couldn't load texture atlas page "+l+" of atlas "+n),o.toLoad--,o.loaded++;else try{var h=new t.TextureAtlas(e,(function(t){return o.get(a+"/"+t)}));o.assets[n]=h,i&&i(n,h),o.toLoad--,o.loaded++}catch(t){var _=t;o.errors[n]="Couldn't load texture atlas "+n+": "+_.message,r&&r(n,"Couldn't load texture atlas "+n+": "+_.message),o.toLoad--,o.loaded++}}),(function(t){u=!0,s.count++,s.count==c.length&&(o.errors[n]="Couldn't load texture atlas page "+t+"} of atlas "+n,r&&r(n,"Couldn't load texture atlas page "+t+" of atlas "+n),o.toLoad--,o.loaded++)}))},h=0,_=c;h<_.length;h++)u(_[h])}),(function(t,e){o.errors[n]="Couldn't load texture atlas "+n+": status "+status+", "+e,r&&r(n,"Couldn't load texture atlas "+n+": status "+status+", "+e),o.toLoad--,o.loaded++}))},e.prototype.get=function(t){return t=this.pathPrefix+t,this.assets[t]},e.prototype.remove=function(t){t=this.pathPrefix+t;var e=this.assets[t];e.dispose&&e.dispose(),this.assets[t]=null},e.prototype.removeAll=function(){for(var t in this.assets){var e=this.assets[t];e.dispose&&e.dispose()}this.assets={}},e.prototype.isLoadingComplete=function(){return 0==this.toLoad},e.prototype.getToLoad=function(){return this.toLoad},e.prototype.getLoaded=function(){return this.loaded},e.prototype.dispose=function(){this.removeAll()},e.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},e.prototype.getErrors=function(){return this.errors},e}();t.AssetManager=e}(net||(net={})),function(t){var e=function(){function e(t){this.atlas=t}return e.prototype.newRegionAttachment=function(e,n,i){var r=this.atlas.findRegion(i);if(null==r)return null;r.renderObject=r;var o=new t.RegionAttachment(n);return o.setRegion(r),o},e.prototype.newMeshAttachment=function(e,n,i){var r=this.atlas.findRegion(i);if(null==r)return null;r.renderObject=r;var o=new t.MeshAttachment(n);return o.region=r,o},e.prototype.newBoundingBoxAttachment=function(e,n){return new t.BoundingBoxAttachment(n)},e.prototype.newPathAttachment=function(e,n){return new t.PathAttachment(n)},e.prototype.newPointAttachment=function(e,n){return new t.PointAttachment(n)},e.prototype.newClippingAttachment=function(e,n){return new t.ClippingAttachment(n)},e}();t.AtlasAttachmentLoader=e}(net||(net={})),function(t){var e;(e=t.BlendMode||(t.BlendMode={}))[e.Normal=0]="Normal",e[e.Additive=1]="Additive",e[e.Multiply=2]="Multiply",e[e.Screen=3]="Screen"}(net||(net={})),function(t){var e=function(){function e(t,e,n){if(this.children=new Array,this.x=0,this.y=0,this.rotation=0,this.scaleX=0,this.scaleY=0,this.shearX=0,this.shearY=0,this.ax=0,this.ay=0,this.arotation=0,this.ascaleX=0,this.ascaleY=0,this.ashearX=0,this.ashearY=0,this.appliedValid=!1,this.a=0,this.b=0,this.c=0,this.d=0,this.worldY=0,this.worldX=0,this.sorted=!1,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.skeleton=e,this.parent=n,this.setToSetupPose()}return e.prototype.isActive=function(){return this.active},e.prototype.update=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},e.prototype.updateWorldTransform=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},e.prototype.updateWorldTransformWith=function(e,n,i,r,o,a,s){this.ax=e,this.ay=n,this.arotation=i,this.ascaleX=r,this.ascaleY=o,this.ashearX=a,this.ashearY=s,this.appliedValid=!0;var c=this.parent;if(null==c){var l=this.skeleton,u=i+90+s,h=l.scaleX,_=l.scaleY;return this.a=t.MathUtils.cosDeg(i+a)*r*h,this.b=t.MathUtils.cosDeg(u)*o*h,this.c=t.MathUtils.sinDeg(i+a)*r*_,this.d=t.MathUtils.sinDeg(u)*o*_,this.worldX=e*h+l.x,void(this.worldY=n*_+l.y)}var f=c.a,d=c.b,p=c.c,m=c.d;switch(this.worldX=f*e+d*n+c.worldX,this.worldY=p*e+m*n+c.worldY,this.data.transformMode){case t.TransformMode.Normal:u=i+90+s;var v=t.MathUtils.cosDeg(i+a)*r,g=t.MathUtils.cosDeg(u)*o,y=t.MathUtils.sinDeg(i+a)*r,x=t.MathUtils.sinDeg(u)*o;return this.a=f*v+d*y,this.b=f*g+d*x,this.c=p*v+m*y,void(this.d=p*g+m*x);case t.TransformMode.OnlyTranslation:u=i+90+s,this.a=t.MathUtils.cosDeg(i+a)*r,this.b=t.MathUtils.cosDeg(u)*o,this.c=t.MathUtils.sinDeg(i+a)*r,this.d=t.MathUtils.sinDeg(u)*o;break;case t.TransformMode.NoRotationOrReflection:var S=0;(b=f*f+p*p)>1e-4?(d=p*(b=Math.abs(f*m-d*p)/b),m=f*b,S=Math.atan2(p,f)*t.MathUtils.radDeg):(f=0,p=0,S=90-Math.atan2(m,d)*t.MathUtils.radDeg);var A=i+a-S,C=i+s-S+90;v=t.MathUtils.cosDeg(A)*r,g=t.MathUtils.cosDeg(C)*o,y=t.MathUtils.sinDeg(A)*r,x=t.MathUtils.sinDeg(C)*o,this.a=f*v-d*y,this.b=f*g-d*x,this.c=p*v+m*y,this.d=p*g+m*x;break;case t.TransformMode.NoScale:case t.TransformMode.NoScaleOrReflection:var b,T=t.MathUtils.cosDeg(i),E=t.MathUtils.sinDeg(i),w=(f*T+d*E)/this.skeleton.scaleX,P=(p*T+m*E)/this.skeleton.scaleY;(b=Math.sqrt(w*w+P*P))>1e-5&&(b=1/b),w*=b,P*=b,b=Math.sqrt(w*w+P*P),this.data.transformMode==t.TransformMode.NoScale&&f*m-d*p<0!=(this.skeleton.scaleX<0!=this.skeleton.scaleY<0)&&(b=-b);var I=Math.PI/2+Math.atan2(P,w),R=Math.cos(I)*b,D=Math.sin(I)*b;v=t.MathUtils.cosDeg(a)*r,g=t.MathUtils.cosDeg(90+s)*o,y=t.MathUtils.sinDeg(a)*r,x=t.MathUtils.sinDeg(90+s)*o,this.a=w*v+R*y,this.b=w*g+R*x,this.c=P*v+D*y,this.d=P*g+D*x}this.a*=this.skeleton.scaleX,this.b*=this.skeleton.scaleX,this.c*=this.skeleton.scaleY,this.d*=this.skeleton.scaleY},e.prototype.setToSetupPose=function(){var t=this.data;this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.shearX=t.shearX,this.shearY=t.shearY},e.prototype.getWorldRotationX=function(){return Math.atan2(this.c,this.a)*t.MathUtils.radDeg},e.prototype.getWorldRotationY=function(){return Math.atan2(this.d,this.b)*t.MathUtils.radDeg},e.prototype.getWorldScaleX=function(){return Math.sqrt(this.a*this.a+this.c*this.c)},e.prototype.getWorldScaleY=function(){return Math.sqrt(this.b*this.b+this.d*this.d)},e.prototype.updateAppliedTransform=function(){this.appliedValid=!0;var e=this.parent;if(null==e)return this.ax=this.worldX,this.ay=this.worldY,this.arotation=Math.atan2(this.c,this.a)*t.MathUtils.radDeg,this.ascaleX=Math.sqrt(this.a*this.a+this.c*this.c),this.ascaleY=Math.sqrt(this.b*this.b+this.d*this.d),this.ashearX=0,void(this.ashearY=Math.atan2(this.a*this.b+this.c*this.d,this.a*this.d-this.b*this.c)*t.MathUtils.radDeg);var n=e.a,i=e.b,r=e.c,o=e.d,a=1/(n*o-i*r),s=this.worldX-e.worldX,c=this.worldY-e.worldY;this.ax=s*o*a-c*i*a,this.ay=c*n*a-s*r*a;var l=a*o,u=a*n,h=a*i,_=a*r,f=l*this.a-h*this.c,d=l*this.b-h*this.d,p=u*this.c-_*this.a,m=u*this.d-_*this.b;if(this.ashearX=0,this.ascaleX=Math.sqrt(f*f+p*p),this.ascaleX>1e-4){var v=f*m-d*p;this.ascaleY=v/this.ascaleX,this.ashearY=Math.atan2(f*d+p*m,v)*t.MathUtils.radDeg,this.arotation=Math.atan2(p,f)*t.MathUtils.radDeg}else this.ascaleX=0,this.ascaleY=Math.sqrt(d*d+m*m),this.ashearY=0,this.arotation=90-Math.atan2(m,d)*t.MathUtils.radDeg},e.prototype.worldToLocal=function(t){var e=this.a,n=this.b,i=this.c,r=this.d,o=1/(e*r-n*i),a=t.x-this.worldX,s=t.y-this.worldY;return t.x=a*r*o-s*n*o,t.y=s*e*o-a*i*o,t},e.prototype.localToWorld=function(t){var e=t.x,n=t.y;return t.x=e*this.a+n*this.b+this.worldX,t.y=e*this.c+n*this.d+this.worldY,t},e.prototype.worldToLocalRotation=function(e){var n=t.MathUtils.sinDeg(e),i=t.MathUtils.cosDeg(e);return Math.atan2(this.a*n-this.c*i,this.d*i-this.b*n)*t.MathUtils.radDeg+this.rotation-this.shearX},e.prototype.localToWorldRotation=function(e){e-=this.rotation-this.shearX;var n=t.MathUtils.sinDeg(e),i=t.MathUtils.cosDeg(e);return Math.atan2(i*this.c+n*this.d,i*this.a+n*this.b)*t.MathUtils.radDeg},e.prototype.rotateWorld=function(e){var n=this.a,i=this.b,r=this.c,o=this.d,a=t.MathUtils.cosDeg(e),s=t.MathUtils.sinDeg(e);this.a=a*n-s*r,this.b=a*i-s*o,this.c=s*n+a*r,this.d=s*i+a*o,this.appliedValid=!1},e}();t.Bone=e}(net||(net={})),function(t){var e;t.BoneData=function(n,i,r){if(this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.shearX=0,this.shearY=0,this.transformMode=e.Normal,this.skinRequired=!1,this.color=new t.Color,n<0)throw new Error("index must be >= 0.");if(null==i)throw new Error("name cannot be null.");this.index=n,this.name=i,this.parent=r},function(t){t[t.Normal=0]="Normal",t[t.OnlyTranslation=1]="OnlyTranslation",t[t.NoRotationOrReflection=2]="NoRotationOrReflection",t[t.NoScale=3]="NoScale",t[t.NoScaleOrReflection=4]="NoScaleOrReflection"}(e=t.TransformMode||(t.TransformMode={}))}(net||(net={})),function(t){t.ConstraintData=function(t,e,n){this.name=t,this.order=e,this.skinRequired=n}}(net||(net={})),function(t){t.Event=function(t,e){if(null==e)throw new Error("data cannot be null.");this.time=t,this.data=e}}(net||(net={})),function(t){t.EventData=function(t){this.name=t}}(net||(net={})),function(t){var e=function(){function e(t,e){if(this.bendDirection=0,this.compress=!1,this.stretch=!1,this.mix=1,this.softness=0,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.mix=t.mix,this.softness=t.softness,this.bendDirection=t.bendDirection,this.compress=t.compress,this.stretch=t.stretch,this.bones=new Array;for(var n=0;n<t.bones.length;n++)this.bones.push(e.findBone(t.bones[n].name));this.target=e.findBone(t.target.name)}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){var t=this.target,e=this.bones;switch(e.length){case 1:this.apply1(e[0],t.worldX,t.worldY,this.compress,this.stretch,this.data.uniform,this.mix);break;case 2:this.apply2(e[0],e[1],t.worldX,t.worldY,this.bendDirection,this.stretch,this.softness,this.mix)}},e.prototype.apply1=function(e,n,i,r,o,a,s){e.appliedValid||e.updateAppliedTransform();var c=e.parent,l=1/(c.a*c.d-c.b*c.c),u=n-c.worldX,h=i-c.worldY,_=(u*c.d-h*c.b)*l-e.ax,f=(h*c.a-u*c.c)*l-e.ay,d=Math.atan2(f,_)*t.MathUtils.radDeg-e.ashearX-e.arotation;e.ascaleX<0&&(d+=180),d>180?d-=360:d<-180&&(d+=360);var p=e.ascaleX,m=e.ascaleY;if(r||o){var v=e.data.length*p,g=Math.sqrt(_*_+f*f);if(r&&g<v||o&&g>v&&v>1e-4){var y=(g/v-1)*s+1;p*=y,a&&(m*=y)}}e.updateWorldTransformWith(e.ax,e.ay,e.arotation+d*s,p,m,e.ashearX,e.ashearY)},e.prototype.apply2=function(e,n,i,r,o,a,s,c){if(0!=c){e.appliedValid||e.updateAppliedTransform(),n.appliedValid||n.updateAppliedTransform();var l=e.ax,u=e.ay,h=e.ascaleX,_=h,f=e.ascaleY,d=n.ascaleX,p=0,m=0,v=0;h<0?(h=-h,p=180,v=-1):(p=0,v=1),f<0&&(f=-f,v=-v),d<0?(d=-d,m=180):m=0;var g=n.ax,y=0,x=0,S=0,A=e.a,C=e.b,b=e.c,T=e.d,E=Math.abs(h-f)<=1e-4;E?(x=A*g+C*(y=n.ay)+e.worldX,S=b*g+T*y+e.worldY):(y=0,x=A*g+e.worldX,S=b*g+e.worldY);var w=e.parent;A=w.a,C=w.b,b=w.c;var P,I,R=1/(A*(T=w.d)-C*b),D=x-w.worldX,M=S-w.worldY,B=(D*T-M*C)*R-l,O=(M*A-D*b)*R-u,N=Math.sqrt(B*B+O*O),L=n.data.length*d;if(N<1e-4)return this.apply1(e,i,r,!1,a,!1,c),void n.updateWorldTransformWith(g,y,0,n.ascaleX,n.ascaleY,n.ashearX,n.ashearY);var F=((D=i-w.worldX)*T-(M=r-w.worldY)*C)*R-l,z=(M*A-D*b)*R-u,V=F*F+z*z;if(0!=s){s*=h*(d+1)/2;var k=Math.sqrt(V),G=k-N-L*h+s;if(G>0){var U=Math.min(1,G/(2*s))-1;V=(F-=(U=(G-s*(1-U*U))/k)*F)*F+(z-=U*z)*z}}t:if(E){var H=(V-N*N-(L*=h)*L)/(2*N*L);H<-1?H=-1:H>1&&(H=1,a&&(_*=(Math.sqrt(V)/(N+L)-1)*c+1)),I=Math.acos(H)*o,A=N+L*H,C=L*Math.sin(I),P=Math.atan2(z*A-F*C,F*A+z*C)}else{var j=(A=h*L)*A,W=(C=f*L)*C,q=Math.atan2(z,F),X=-2*W*N,Y=W-j;if((T=X*X-4*Y*(b=W*N*N+j*V-j*W))>=0){var K=Math.sqrt(T);X<0&&(K=-K);var J=(K=-(X+K)/2)/Y,Q=b/K,Z=Math.abs(J)<Math.abs(Q)?J:Q;if(Z*Z<=V){M=Math.sqrt(V-Z*Z)*o,P=q-Math.atan2(M,Z),I=Math.atan2(M/f,(Z-N)/h);break t}}var $=t.MathUtils.PI,tt=N-A,et=tt*tt,nt=0,it=0,rt=N+A,ot=rt*rt,at=0;(b=-A*N/(j-W))>=-1&&b<=1&&(b=Math.acos(b),(T=(D=A*Math.cos(b)+N)*D+(M=C*Math.sin(b))*M)<et&&($=b,et=T,tt=D,nt=M),T>ot&&(it=b,ot=T,rt=D,at=M)),V<=(et+ot)/2?(P=q-Math.atan2(nt*o,tt),I=$*o):(P=q-Math.atan2(at*o,rt),I=it*o)}var st=Math.atan2(y,g)*v,ct=e.arotation;(P=(P-st)*t.MathUtils.radDeg+p-ct)>180?P-=360:P<-180&&(P+=360),e.updateWorldTransformWith(l,u,ct+P*c,_,e.ascaleY,0,0),ct=n.arotation,(I=((I+st)*t.MathUtils.radDeg-n.ashearX)*v+m-ct)>180?I-=360:I<-180&&(I+=360),n.updateWorldTransformWith(g,y,ct+I*c,n.ascaleX,n.ascaleY,n.ashearX,n.ashearY)}else n.updateWorldTransform()},e}();t.IkConstraint=e}(net||(net={})),function(t){var e=function(t){function e(e){var n=t.call(this,e,0,!1)||this;return n.bones=new Array,n.bendDirection=1,n.compress=!1,n.stretch=!1,n.uniform=!1,n.mix=1,n.softness=0,n}return iet(e,t),e}(t.ConstraintData);t.IkConstraintData=e}(net||(net={})),function(t){var e=function(){function e(t,e){if(this.position=0,this.spacing=0,this.rotateMix=0,this.translateMix=0,this.spaces=new Array,this.positions=new Array,this.world=new Array,this.curves=new Array,this.lengths=new Array,this.segments=new Array,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.bones=new Array;for(var n=0,i=t.bones.length;n<i;n++)this.bones.push(e.findBone(t.bones[n].name));this.target=e.findSlot(t.target.name),this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){var n=this.target.getAttachment();if(n instanceof t.PathAttachment){var i=this.rotateMix,r=this.translateMix,o=i>0;if(r>0||o){var a=this.data,s=a.spacingMode==t.SpacingMode.Percent,c=a.rotateMode,l=c==t.RotateMode.Tangent,u=c==t.RotateMode.ChainScale,h=this.bones.length,_=l?h:h+1,f=this.bones,d=t.Utils.setArraySize(this.spaces,_),p=null,m=this.spacing;if(u||!s){u&&(p=t.Utils.setArraySize(this.lengths,h));for(var v=a.spacingMode==t.SpacingMode.Length,g=0,y=_-1;g<y;){var x=(D=f[g]).data.length;if(x<e.epsilon)u&&(p[g]=0),d[++g]=0;else if(s){if(u){var S=x*D.a,A=x*D.c,C=Math.sqrt(S*S+A*A);p[g]=C}d[++g]=m}else{S=x*D.a,A=x*D.c;var b=Math.sqrt(S*S+A*A);u&&(p[g]=b),d[++g]=(v?x+m:m)*b/x}}}else for(g=1;g<_;g++)d[g]=m;var T=this.computeWorldPositions(n,_,l,a.positionMode==t.PositionMode.Percent,s),E=T[0],w=T[1],P=a.offsetRotation,I=!1;0==P?I=c==t.RotateMode.Chain:(I=!1,P*=(R=this.target.bone).a*R.d-R.b*R.c>0?t.MathUtils.degRad:-t.MathUtils.degRad),g=0;for(var R=3;g<h;g++,R+=3){var D;(D=f[g]).worldX+=(E-D.worldX)*r,D.worldY+=(w-D.worldY)*r;var M=(S=T[R])-E,B=(A=T[R+1])-w;if(u){var O=p[g];if(0!=O){var N=(Math.sqrt(M*M+B*B)/O-1)*i+1;D.a*=N,D.c*=N}}if(E=S,w=A,o){var L=D.a,F=D.b,z=D.c,V=D.d,k=0,G=0,U=0;if(k=l?T[R-1]:0==d[g+1]?T[R+2]:Math.atan2(B,M),k-=Math.atan2(z,L),I){G=Math.cos(k),U=Math.sin(k);var H=D.data.length;E+=(H*(G*L-U*z)-M)*i,w+=(H*(U*L+G*z)-B)*i}else k+=P;k>t.MathUtils.PI?k-=t.MathUtils.PI2:k<-t.MathUtils.PI&&(k+=t.MathUtils.PI2),k*=i,G=Math.cos(k),U=Math.sin(k),D.a=G*L-U*z,D.b=G*F-U*V,D.c=U*L+G*z,D.d=U*F+G*V}D.appliedValid=!1}}}},e.prototype.computeWorldPositions=function(n,i,r,o,a){var s=this.target,c=this.position,l=this.spaces,u=t.Utils.setArraySize(this.positions,3*i+2),h=null,_=n.closed,f=n.worldVerticesLength,d=f/6,p=e.NONE;if(!n.constantSpeed){var m=n.lengths,v=m[d-=_?1:2];if(o&&(c*=v),a)for(var g=1;g<i;g++)l[g]*=v;h=t.Utils.setArraySize(this.world,8),g=0;for(var y=0,x=0;g<i;g++,y+=3){var S=c+=W=l[g];if(_)(S%=v)<0&&(S+=v),x=0;else{if(S<0){p!=e.BEFORE&&(p=e.BEFORE,n.computeWorldVertices(s,2,4,h,0,2)),this.addBeforePosition(S,h,0,u,y);continue}if(S>v){p!=e.AFTER&&(p=e.AFTER,n.computeWorldVertices(s,f-6,4,h,0,2)),this.addAfterPosition(S-v,h,0,u,y);continue}}for(;;x++){var A=m[x];if(!(S>A)){0==x?S/=A:S=(S-(K=m[x-1]))/(A-K);break}}x!=p&&(p=x,_&&x==d?(n.computeWorldVertices(s,f-4,4,h,0,2),n.computeWorldVertices(s,0,4,h,4,2)):n.computeWorldVertices(s,6*x+2,8,h,0,2)),this.addCurvePosition(S,h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],u,y,r||g>0&&0==W)}return u}_?(f+=2,h=t.Utils.setArraySize(this.world,f),n.computeWorldVertices(s,2,f-4,h,0,2),n.computeWorldVertices(s,0,2,h,f-4,2),h[f-2]=h[0],h[f-1]=h[1]):(d--,f-=4,h=t.Utils.setArraySize(this.world,f),n.computeWorldVertices(s,2,f,h,0,2));for(var C=t.Utils.setArraySize(this.curves,d),b=0,T=h[0],E=h[1],w=0,P=0,I=0,R=0,D=0,M=0,B=0,O=0,N=0,L=0,F=0,z=0,V=0,k=0,G=(g=0,2);g<d;g++,G+=6)w=h[G],P=h[G+1],I=h[G+2],R=h[G+3],F=2*(B=.1875*(T-2*w+I))+(N=.09375*(3*(w-I)-T+(D=h[G+4]))),z=2*(O=.1875*(E-2*P+R))+(L=.09375*(3*(P-R)-E+(M=h[G+5]))),V=.75*(w-T)+B+.16666667*N,k=.75*(P-E)+O+.16666667*L,b+=Math.sqrt(V*V+k*k),V+=F,k+=z,F+=N,z+=L,b+=Math.sqrt(V*V+k*k),V+=F,k+=z,b+=Math.sqrt(V*V+k*k),V+=F+N,k+=z+L,b+=Math.sqrt(V*V+k*k),C[g]=b,T=D,E=M;if(c*=o?b:b/n.lengths[d-1],a)for(g=1;g<i;g++)l[g]*=b;for(var U=this.segments,H=0,j=(g=0,y=0,x=0,0);g<i;g++,y+=3){var W;if(S=c+=W=l[g],_)(S%=b)<0&&(S+=b),x=0;else{if(S<0){this.addBeforePosition(S,h,0,u,y);continue}if(S>b){this.addAfterPosition(S-b,h,f-4,u,y);continue}}for(;;x++){var q=C[x];if(!(S>q)){0==x?S/=q:S=(S-(K=C[x-1]))/(q-K);break}}if(x!=p){p=x;var X=6*x;for(T=h[X],E=h[X+1],w=h[X+2],P=h[X+3],I=h[X+4],R=h[X+5],F=2*(B=.03*(T-2*w+I))+(N=.006*(3*(w-I)-T+(D=h[X+6]))),z=2*(O=.03*(E-2*P+R))+(L=.006*(3*(P-R)-E+(M=h[X+7]))),V=.3*(w-T)+B+.16666667*N,k=.3*(P-E)+O+.16666667*L,H=Math.sqrt(V*V+k*k),U[0]=H,X=1;X<8;X++)V+=F,k+=z,F+=N,z+=L,H+=Math.sqrt(V*V+k*k),U[X]=H;V+=F,k+=z,H+=Math.sqrt(V*V+k*k),U[8]=H,V+=F+N,k+=z+L,H+=Math.sqrt(V*V+k*k),U[9]=H,j=0}for(S*=H;;j++){var Y=U[j];if(!(S>Y)){var K;0==j?S/=Y:S=j+(S-(K=U[j-1]))/(Y-K);break}}this.addCurvePosition(.1*S,T,E,w,P,I,R,D,M,u,y,r||g>0&&0==W)}return u},e.prototype.addBeforePosition=function(t,e,n,i,r){var o=e[n],a=e[n+1],s=e[n+2]-o,c=e[n+3]-a,l=Math.atan2(c,s);i[r]=o+t*Math.cos(l),i[r+1]=a+t*Math.sin(l),i[r+2]=l},e.prototype.addAfterPosition=function(t,e,n,i,r){var o=e[n+2],a=e[n+3],s=o-e[n],c=a-e[n+1],l=Math.atan2(c,s);i[r]=o+t*Math.cos(l),i[r+1]=a+t*Math.sin(l),i[r+2]=l},e.prototype.addCurvePosition=function(t,e,n,i,r,o,a,s,c,l,u,h){if(0==t||isNaN(t))return l[u]=e,l[u+1]=n,void(l[u+2]=Math.atan2(r-n,i-e));var _=t*t,f=_*t,d=1-t,p=d*d,m=p*d,v=d*t,g=3*v,y=d*g,x=g*t,S=e*m+i*y+o*x+s*f,A=n*m+r*y+a*x+c*f;l[u]=S,l[u+1]=A,h&&(l[u+2]=t<.001?Math.atan2(r-n,i-e):Math.atan2(A-(n*p+r*v*2+a*_),S-(e*p+i*v*2+o*_)))},e.NONE=-1,e.BEFORE=-2,e.AFTER=-3,e.epsilon=1e-5,e}();t.PathConstraint=e}(net||(net={})),function(t){var e,n,i,r=function(t){function e(e){var n=t.call(this,e,0,!1)||this;return n.bones=new Array,n}return iet(e,t),e}(t.ConstraintData);t.PathConstraintData=r,(i=t.PositionMode||(t.PositionMode={}))[i.Fixed=0]="Fixed",i[i.Percent=1]="Percent",(n=t.SpacingMode||(t.SpacingMode={}))[n.Length=0]="Length",n[n.Fixed=1]="Fixed",n[n.Percent=2]="Percent",(e=t.RotateMode||(t.RotateMode={}))[e.Tangent=0]="Tangent",e[e.Chain=1]="Chain",e[e.ChainScale=2]="ChainScale"}(net||(net={})),function(t){var e=function(){function t(t){this.toLoad=new Array,this.assets={},this.clientId=t}return t.prototype.loaded=function(){var t=0;for(var e in this.assets)t++;return t},t}(),n=function(){function t(t){void 0===t&&(t=""),this.clientAssets={},this.queuedAssets={},this.rawAssets={},this.errors={},this.pathPrefix=t}return t.prototype.queueAsset=function(t,n,i){var r=this.clientAssets[t];return null==r&&(r=new e(t),this.clientAssets[t]=r),null!==n&&(r.textureLoader=n),r.toLoad.push(i),this.queuedAssets[i]!==i&&(this.queuedAssets[i]=i,!0)},t.prototype.loadText=function(t,e){var n=this;if(e=this.pathPrefix+e,this.queueAsset(t,null,e)){var i=new XMLHttpRequest;i.onreadystatechange=function(){i.readyState==XMLHttpRequest.DONE&&(i.status>=200&&i.status<300?n.rawAssets[e]=i.responseText:n.errors[e]="Couldn't load text "+e+": status "+i.status+", "+i.responseText)},i.open("GET",e,!0),i.send()}},t.prototype.loadJson=function(t,e){var n=this;if(e=this.pathPrefix+e,this.queueAsset(t,null,e)){var i=new XMLHttpRequest;i.onreadystatechange=function(){i.readyState==XMLHttpRequest.DONE&&(i.status>=200&&i.status<300?n.rawAssets[e]=JSON.parse(i.responseText):n.errors[e]="Couldn't load text "+e+": status "+i.status+", "+i.responseText)},i.open("GET",e,!0),i.send()}},t.prototype.loadTexture=function(t,e,n){var i=this;if(n=this.pathPrefix+n,this.queueAsset(t,e,n)){var r=new Image;r.src=n,r.crossOrigin="anonymous",r.onload=function(){i.rawAssets[n]=r},r.onerror=function(){i.errors[n]="Couldn't load image "+n}}},t.prototype.get=function(t,e){e=this.pathPrefix+e;var n=this.clientAssets[t];return null==n||n.assets[e]},t.prototype.updateClientAssets=function(t){for(var e=0;e<t.toLoad.length;e++){var n=t.toLoad[e];if(null==t.assets[n]){var i=this.rawAssets[n];if(null==i)continue;i instanceof HTMLImageElement?t.assets[n]=t.textureLoader(i):t.assets[n]=i}}},t.prototype.isLoadingComplete=function(t){var e=this.clientAssets[t];return null==e||(this.updateClientAssets(e),e.toLoad.length==e.loaded())},t.prototype.dispose=function(){},t.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},t.prototype.getErrors=function(){return this.errors},t}();t.SharedAssetManager=n}(net||(net={})),function(t){var e=function(){function e(e){if(this._updateCache=new Array,this.updateCacheReset=new Array,this.time=0,this.scaleX=1,this.scaleY=1,this.x=0,this.y=0,null==e)throw new Error("data cannot be null.");this.data=e,this.bones=new Array;for(var n=0;n<e.bones.length;n++){var i=e.bones[n],r=void 0;if(null==i.parent)r=new t.Bone(i,this,null);else{var o=this.bones[i.parent.index];r=new t.Bone(i,this,o),o.children.push(r)}this.bones.push(r)}for(this.slots=new Array,this.drawOrder=new Array,n=0;n<e.slots.length;n++){var a=e.slots[n],s=(r=this.bones[a.boneData.index],new t.Slot(a,r));this.slots.push(s),this.drawOrder.push(s)}for(this.ikConstraints=new Array,n=0;n<e.ikConstraints.length;n++){var c=e.ikConstraints[n];this.ikConstraints.push(new t.IkConstraint(c,this))}for(this.transformConstraints=new Array,n=0;n<e.transformConstraints.length;n++){var l=e.transformConstraints[n];this.transformConstraints.push(new t.TransformConstraint(l,this))}for(this.pathConstraints=new Array,n=0;n<e.pathConstraints.length;n++){var u=e.pathConstraints[n];this.pathConstraints.push(new t.PathConstraint(u,this))}this.color=new t.Color(1,1,1,1),this.updateCache()}return e.prototype.updateCache=function(){this._updateCache.length=0,this.updateCacheReset.length=0;for(var t=this.bones,e=0,n=t.length;e<n;e++)(r=t[e]).sorted=r.data.skinRequired,r.active=!r.sorted;if(null!=this.skin){var i=this.skin.bones;for(e=0,n=this.skin.bones.length;e<n;e++){var r=this.bones[i[e].index];do{r.sorted=!1,r.active=!0,r=r.parent}while(null!=r)}}var o=this.ikConstraints,a=this.transformConstraints,s=this.pathConstraints,c=o.length,l=a.length,u=s.length,h=c+l+u;t:for(e=0;e<h;e++){for(var _=0;_<c;_++)if((f=o[_]).data.order==e){this.sortIkConstraint(f);continue t}for(_=0;_<l;_++)if((f=a[_]).data.order==e){this.sortTransformConstraint(f);continue t}for(_=0;_<u;_++){var f;if((f=s[_]).data.order==e){this.sortPathConstraint(f);continue t}}}for(e=0,n=t.length;e<n;e++)this.sortBone(t[e])},e.prototype.sortIkConstraint=function(e){if(e.active=e.target.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){var n=e.target;this.sortBone(n);var i=e.bones,r=i[0];if(this.sortBone(r),i.length>1){var o=i[i.length-1];this._updateCache.indexOf(o)>-1||this.updateCacheReset.push(o)}this._updateCache.push(e),this.sortReset(r.children),i[i.length-1].sorted=!0}},e.prototype.sortPathConstraint=function(e){if(e.active=e.target.bone.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){var n=e.target,i=n.data.index,r=n.bone;null!=this.skin&&this.sortPathConstraintAttachment(this.skin,i,r),null!=this.data.defaultSkin&&this.data.defaultSkin!=this.skin&&this.sortPathConstraintAttachment(this.data.defaultSkin,i,r);for(var o=0,a=this.data.skins.length;o<a;o++)this.sortPathConstraintAttachment(this.data.skins[o],i,r);var s=n.getAttachment();s instanceof t.PathAttachment&&this.sortPathConstraintAttachmentWith(s,r);var c=e.bones,l=c.length;for(o=0;o<l;o++)this.sortBone(c[o]);for(this._updateCache.push(e),o=0;o<l;o++)this.sortReset(c[o].children);for(o=0;o<l;o++)c[o].sorted=!0}},e.prototype.sortTransformConstraint=function(e){if(e.active=e.target.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){this.sortBone(e.target);var n=e.bones,i=n.length;if(e.data.local)for(var r=0;r<i;r++){var o=n[r];this.sortBone(o.parent),this._updateCache.indexOf(o)>-1||this.updateCacheReset.push(o)}else for(r=0;r<i;r++)this.sortBone(n[r]);this._updateCache.push(e);for(var a=0;a<i;a++)this.sortReset(n[a].children);for(a=0;a<i;a++)n[a].sorted=!0}},e.prototype.sortPathConstraintAttachment=function(t,e,n){var i=t.attachments[e];if(i)for(var r in i)this.sortPathConstraintAttachmentWith(i[r],n)},e.prototype.sortPathConstraintAttachmentWith=function(e,n){if(e instanceof t.PathAttachment){var i=e.bones;if(null==i)this.sortBone(n);else for(var r=this.bones,o=0;o<i.length;)for(var a=i[o++],s=o+a;o<s;o++){var c=i[o];this.sortBone(r[c])}}},e.prototype.sortBone=function(t){if(!t.sorted){var e=t.parent;null!=e&&this.sortBone(e),t.sorted=!0,this._updateCache.push(t)}},e.prototype.sortReset=function(t){for(var e=0,n=t.length;e<n;e++){var i=t[e];i.active&&(i.sorted&&this.sortReset(i.children),i.sorted=!1)}},e.prototype.updateWorldTransform=function(){for(var t=this.updateCacheReset,e=0,n=t.length;e<n;e++){var i=t[e];i.ax=i.x,i.ay=i.y,i.arotation=i.rotation,i.ascaleX=i.scaleX,i.ascaleY=i.scaleY,i.ashearX=i.shearX,i.ashearY=i.shearY,i.appliedValid=!0}var r=this._updateCache;for(e=0,n=r.length;e<n;e++)r[e].update()},e.prototype.setToSetupPose=function(){this.setBonesToSetupPose(),this.setSlotsToSetupPose()},e.prototype.setBonesToSetupPose=function(){for(var t=this.bones,e=0,n=t.length;e<n;e++)t[e].setToSetupPose();var i=this.ikConstraints;for(e=0,n=i.length;e<n;e++)(s=i[e]).mix=s.data.mix,s.softness=s.data.softness,s.bendDirection=s.data.bendDirection,s.compress=s.data.compress,s.stretch=s.data.stretch;var r=this.transformConstraints;for(e=0,n=r.length;e<n;e++){var o=(s=r[e]).data;s.rotateMix=o.rotateMix,s.translateMix=o.translateMix,s.scaleMix=o.scaleMix,s.shearMix=o.shearMix}var a=this.pathConstraints;for(e=0,n=a.length;e<n;e++){var s;o=(s=a[e]).data,s.position=o.position,s.spacing=o.spacing,s.rotateMix=o.rotateMix,s.translateMix=o.translateMix}},e.prototype.setSlotsToSetupPose=function(){var e=this.slots;t.Utils.arrayCopy(e,0,this.drawOrder,0,e.length);for(var n=0,i=e.length;n<i;n++)e[n].setToSetupPose()},e.prototype.getRootBone=function(){return 0==this.bones.length?null:this.bones[0]},e.prototype.findBone=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,n=0,i=e.length;n<i;n++){var r=e[n];if(r.data.name==t)return r}return null},e.prototype.findBoneIndex=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,n=0,i=e.length;n<i;n++)if(e[n].data.name==t)return n;return-1},e.prototype.findSlot=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,n=0,i=e.length;n<i;n++){var r=e[n];if(r.data.name==t)return r}return null},e.prototype.findSlotIndex=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,n=0,i=e.length;n<i;n++)if(e[n].data.name==t)return n;return-1},e.prototype.setSkinByName=function(t){var e=this.data.findSkin(t);if(null==e)throw new Error("Skin not found: "+t);this.setSkin(e)},e.prototype.setSkin=function(t){if(t!=this.skin){if(null!=t)if(null!=this.skin)t.attachAll(this,this.skin);else for(var e=this.slots,n=0,i=e.length;n<i;n++){var r=e[n],o=r.data.attachmentName;if(null!=o){var a=t.getAttachment(n,o);null!=a&&r.setAttachment(a)}}this.skin=t,this.updateCache()}},e.prototype.getAttachmentByName=function(t,e){return this.getAttachment(this.data.findSlotIndex(t),e)},e.prototype.getAttachment=function(t,e){if(null==e)throw new Error("attachmentName cannot be null.");if(null!=this.skin){var n=this.skin.getAttachment(t,e);if(null!=n)return n}return null!=this.data.defaultSkin?this.data.defaultSkin.getAttachment(t,e):null},e.prototype.setAttachment=function(t,e){if(null==t)throw new Error("slotName cannot be null.");for(var n=this.slots,i=0,r=n.length;i<r;i++){var o=n[i];if(o.data.name==t){var a=null;if(null!=e&&null==(a=this.getAttachment(i,e)))throw new Error("Attachment not found: "+e+", for slot: "+t);return void o.setAttachment(a)}}throw new Error("Slot not found: "+t)},e.prototype.findIkConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.ikConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.data.name==t)return r}return null},e.prototype.findTransformConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.transformConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.data.name==t)return r}return null},e.prototype.findPathConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.pathConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.data.name==t)return r}return null},e.prototype.getBounds=function(e,n,i){if(void 0===i&&(i=new Array(2)),null==e)throw new Error("offset cannot be null.");if(null==n)throw new Error("size cannot be null.");for(var r=this.drawOrder,o=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=0,u=r.length;l<u;l++){var h=r[l];if(h.bone.active){var _=0,f=null,d=h.getAttachment();if(d instanceof t.RegionAttachment)_=8,f=t.Utils.setArraySize(i,_,0),d.computeWorldVertices(h.bone,f,0,2);else if(d instanceof t.MeshAttachment){var p=d;_=p.worldVerticesLength,f=t.Utils.setArraySize(i,_,0),p.computeWorldVertices(h,0,_,f,0,2)}if(null!=f)for(var m=0,v=f.length;m<v;m+=2){var g=f[m],y=f[m+1];o=Math.min(o,g),a=Math.min(a,y),s=Math.max(s,g),c=Math.max(c,y)}}}e.set(o,a),n.set(s-o,c-a)},e.prototype.update=function(t){this.time+=t},e}();t.Skeleton=e}(net||(net={})),function(t){var e=function(){function e(t){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=t}return e.prototype.readSkeletonData=function(i){var r=this.scale,o=new t.SkeletonData;o.name="";var a=new n(i);o.hash=a.readString(),o.version=a.readString(),o.x=a.readFloat(),o.y=a.readFloat(),o.width=a.readFloat(),o.height=a.readFloat();var s=a.readBoolean();s&&(o.fps=a.readFloat(),o.imagesPath=a.readString(),o.audioPath=a.readString());var c=0;c=a.readInt(!0);for(var l=0;l<c;l++)a.strings.push(a.readString());for(c=a.readInt(!0),l=0;l<c;l++){var u=a.readString(),h=0==l?null:o.bones[a.readInt(!0)];(d=new t.BoneData(l,u,h)).rotation=a.readFloat(),d.x=a.readFloat()*r,d.y=a.readFloat()*r,d.scaleX=a.readFloat(),d.scaleY=a.readFloat(),d.shearX=a.readFloat(),d.shearY=a.readFloat(),d.length=a.readFloat()*r,d.transformMode=e.TransformModeValues[a.readInt(!0)],d.skinRequired=a.readBoolean(),s&&t.Color.rgba8888ToColor(d.color,a.readInt32()),o.bones.push(d)}for(c=a.readInt(!0),l=0;l<c;l++){var _=a.readString(),f=o.bones[a.readInt(!0)],d=new t.SlotData(l,_,f);t.Color.rgba8888ToColor(d.color,a.readInt32());var p=a.readInt32();-1!=p&&t.Color.rgb888ToColor(d.darkColor=new t.Color,p),d.attachmentName=a.readStringRef(),d.blendMode=e.BlendModeValues[a.readInt(!0)],o.slots.push(d)}c=a.readInt(!0),l=0;for(var m=void 0;l<c;l++){(d=new t.IkConstraintData(a.readString())).order=a.readInt(!0),d.skinRequired=a.readBoolean(),m=a.readInt(!0);for(var v=0;v<m;v++)d.bones.push(o.bones[a.readInt(!0)]);d.target=o.bones[a.readInt(!0)],d.mix=a.readFloat(),d.softness=a.readFloat()*r,d.bendDirection=a.readByte(),d.compress=a.readBoolean(),d.stretch=a.readBoolean(),d.uniform=a.readBoolean(),o.ikConstraints.push(d)}for(c=a.readInt(!0),l=0,m=void 0;l<c;l++){for((d=new t.TransformConstraintData(a.readString())).order=a.readInt(!0),d.skinRequired=a.readBoolean(),m=a.readInt(!0),v=0;v<m;v++)d.bones.push(o.bones[a.readInt(!0)]);d.target=o.bones[a.readInt(!0)],d.local=a.readBoolean(),d.relative=a.readBoolean(),d.offsetRotation=a.readFloat(),d.offsetX=a.readFloat()*r,d.offsetY=a.readFloat()*r,d.offsetScaleX=a.readFloat(),d.offsetScaleY=a.readFloat(),d.offsetShearY=a.readFloat(),d.rotateMix=a.readFloat(),d.translateMix=a.readFloat(),d.scaleMix=a.readFloat(),d.shearMix=a.readFloat(),o.transformConstraints.push(d)}for(c=a.readInt(!0),l=0,m=void 0;l<c;l++){for((d=new t.PathConstraintData(a.readString())).order=a.readInt(!0),d.skinRequired=a.readBoolean(),m=a.readInt(!0),v=0;v<m;v++)d.bones.push(o.bones[a.readInt(!0)]);d.target=o.slots[a.readInt(!0)],d.positionMode=e.PositionModeValues[a.readInt(!0)],d.spacingMode=e.SpacingModeValues[a.readInt(!0)],d.rotateMode=e.RotateModeValues[a.readInt(!0)],d.offsetRotation=a.readFloat(),d.position=a.readFloat(),d.positionMode==t.PositionMode.Fixed&&(d.position*=r),d.spacing=a.readFloat(),d.spacingMode!=t.SpacingMode.Length&&d.spacingMode!=t.SpacingMode.Fixed||(d.spacing*=r),d.rotateMix=a.readFloat(),d.translateMix=a.readFloat(),o.pathConstraints.push(d)}var g=this.readSkin(a,o,!0,s);for(null!=g&&(o.defaultSkin=g,o.skins.push(g)),l=o.skins.length,t.Utils.setArraySize(o.skins,c=l+a.readInt(!0));l<c;l++)o.skins[l]=this.readSkin(a,o,!1,s);for(c=this.linkedMeshes.length,l=0;l<c;l++){var y=this.linkedMeshes[l],x=null==y.skin?o.defaultSkin:o.findSkin(y.skin);if(null==x)throw new Error("Skin not found: "+y.skin);var S=x.getAttachment(y.slotIndex,y.parent);if(null==S)throw new Error("Parent mesh not found: "+y.parent);y.mesh.deformAttachment=y.inheritDeform?S:y.mesh,y.mesh.setParentMesh(S),y.mesh.updateUVs()}for(this.linkedMeshes.length=0,c=a.readInt(!0),l=0;l<c;l++)(d=new t.EventData(a.readStringRef())).intValue=a.readInt(!1),d.floatValue=a.readFloat(),d.stringValue=a.readString(),d.audioPath=a.readString(),null!=d.audioPath&&(d.volume=a.readFloat(),d.balance=a.readFloat()),o.events.push(d);for(c=a.readInt(!0),l=0;l<c;l++)o.animations.push(this.readAnimation(a,a.readString(),o));return o},e.prototype.readSkin=function(e,n,i,r){var o=null,a=0;if(i){if(0==(a=e.readInt(!0)))return null;o=new t.Skin("default")}else{(o=new t.Skin(e.readStringRef())).bones.length=e.readInt(!0);for(var s=0,c=o.bones.length;s<c;s++)o.bones[s]=n.bones[e.readInt(!0)];for(s=0,c=e.readInt(!0);s<c;s++)o.constraints.push(n.ikConstraints[e.readInt(!0)]);for(s=0,c=e.readInt(!0);s<c;s++)o.constraints.push(n.transformConstraints[e.readInt(!0)]);for(s=0,c=e.readInt(!0);s<c;s++)o.constraints.push(n.pathConstraints[e.readInt(!0)]);a=e.readInt(!0)}for(s=0;s<a;s++)for(var l=e.readInt(!0),u=0,h=e.readInt(!0);u<h;u++){var _=e.readStringRef(),f=this.readAttachment(e,n,o,l,_,r);null!=f&&o.setAttachment(l,_,f)}return o},e.prototype.readAttachment=function(n,r,o,a,s,c){var l=this.scale,u=n.readStringRef();null==u&&(u=s);var h=n.readByte();switch(e.AttachmentTypeValues[h]){case t.AttachmentType.Region:var _=n.readStringRef(),f=n.readFloat(),d=n.readFloat(),p=n.readFloat(),m=n.readFloat(),v=n.readFloat(),g=n.readFloat(),y=n.readFloat(),x=n.readInt32();null==_&&(_=u);var S=this.attachmentLoader.newRegionAttachment(o,u,_);return null==S?null:(S.path=_,S.x=d*l,S.y=p*l,S.scaleX=m,S.scaleY=v,S.rotation=f,S.width=g*l,S.height=y*l,t.Color.rgba8888ToColor(S.color,x),S.updateOffset(),S);case t.AttachmentType.BoundingBox:var A=n.readInt(!0),C=this.readVertices(n,A),b=(x=c?n.readInt32():0,this.attachmentLoader.newBoundingBoxAttachment(o,u));return null==b?null:(b.worldVerticesLength=A<<1,b.vertices=C.vertices,b.bones=C.bones,c&&t.Color.rgba8888ToColor(b.color,x),b);case t.AttachmentType.Mesh:_=n.readStringRef(),x=n.readInt32(),A=n.readInt(!0);var T=this.readFloatArray(n,A<<1,1),E=this.readShortArray(n),w=(C=this.readVertices(n,A),n.readInt(!0)),P=null;return g=0,y=0,c&&(P=this.readShortArray(n),g=n.readFloat(),y=n.readFloat()),null==_&&(_=u),null==(I=this.attachmentLoader.newMeshAttachment(o,u,_))?null:(I.path=_,t.Color.rgba8888ToColor(I.color,x),I.bones=C.bones,I.vertices=C.vertices,I.worldVerticesLength=A<<1,I.triangles=E,I.regionUVs=T,I.updateUVs(),I.hullLength=w<<1,c&&(I.edges=P,I.width=g*l,I.height=y*l),I);case t.AttachmentType.LinkedMesh:_=n.readStringRef(),x=n.readInt32();var I,R=n.readStringRef(),D=n.readStringRef(),M=n.readBoolean();return g=0,y=0,c&&(g=n.readFloat(),y=n.readFloat()),null==_&&(_=u),null==(I=this.attachmentLoader.newMeshAttachment(o,u,_))?null:(I.path=_,t.Color.rgba8888ToColor(I.color,x),c&&(I.width=g*l,I.height=y*l),this.linkedMeshes.push(new i(I,R,a,D,M)),I);case t.AttachmentType.Path:for(var B=n.readBoolean(),O=n.readBoolean(),N=(A=n.readInt(!0),C=this.readVertices(n,A),t.Utils.newArray(A/3,0)),L=0,F=N.length;L<F;L++)N[L]=n.readFloat()*l;return x=c?n.readInt32():0,null==(_=this.attachmentLoader.newPathAttachment(o,u))?null:(_.closed=B,_.constantSpeed=O,_.worldVerticesLength=A<<1,_.vertices=C.vertices,_.bones=C.bones,_.lengths=N,c&&t.Color.rgba8888ToColor(_.color,x),_);case t.AttachmentType.Point:f=n.readFloat(),d=n.readFloat(),p=n.readFloat(),x=c?n.readInt32():0;var z=this.attachmentLoader.newPointAttachment(o,u);return null==z?null:(z.x=d*l,z.y=p*l,z.rotation=f,c&&t.Color.rgba8888ToColor(z.color,x),z);case t.AttachmentType.Clipping:var V=n.readInt(!0),k=(A=n.readInt(!0),C=this.readVertices(n,A),x=c?n.readInt32():0,this.attachmentLoader.newClippingAttachment(o,u));return null==k?null:(k.endSlot=r.slots[V],k.worldVerticesLength=A<<1,k.vertices=C.vertices,k.bones=C.bones,c&&t.Color.rgba8888ToColor(k.color,x),k)}return null},e.prototype.readVertices=function(e,n){var i=n<<1,o=new r,a=this.scale;if(!e.readBoolean())return o.vertices=this.readFloatArray(e,i,a),o;for(var s=new Array,c=new Array,l=0;l<n;l++){var u=e.readInt(!0);c.push(u);for(var h=0;h<u;h++)c.push(e.readInt(!0)),s.push(e.readFloat()*a),s.push(e.readFloat()*a),s.push(e.readFloat())}return o.vertices=t.Utils.toFloatArray(s),o.bones=c,o},e.prototype.readFloatArray=function(t,e,n){var i=new Array(e);if(1==n)for(var r=0;r<e;r++)i[r]=t.readFloat();else for(r=0;r<e;r++)i[r]=t.readFloat()*n;return i},e.prototype.readShortArray=function(t){for(var e=t.readInt(!0),n=new Array(e),i=0;i<e;i++)n[i]=t.readShort();return n},e.prototype.readAnimation=function(n,i,r){for(var o=new Array,a=this.scale,s=0,c=new t.Color,l=new t.Color,u=0,h=n.readInt(!0);u<h;u++)for(var _=n.readInt(!0),f=0,d=n.readInt(!0);f<d;f++){var p=n.readByte(),m=n.readInt(!0);switch(p){case e.SLOT_ATTACHMENT:(x=new t.AttachmentTimeline(m)).slotIndex=_;for(var v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readStringRef());o.push(x),s=Math.max(s,x.frames[m-1]);break;case e.SLOT_COLOR:for((x=new t.ColorTimeline(m)).slotIndex=_,v=0;v<m;v++){var g=n.readFloat();t.Color.rgba8888ToColor(c,n.readInt32()),x.setFrame(v,g,c.r,c.g,c.b,c.a),v<m-1&&this.readCurve(n,v,x)}o.push(x),s=Math.max(s,x.frames[(m-1)*t.ColorTimeline.ENTRIES]);break;case e.SLOT_TWO_COLOR:for((x=new t.TwoColorTimeline(m)).slotIndex=_,v=0;v<m;v++)g=n.readFloat(),t.Color.rgba8888ToColor(c,n.readInt32()),t.Color.rgb888ToColor(l,n.readInt32()),x.setFrame(v,g,c.r,c.g,c.b,c.a,l.r,l.g,l.b),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.TwoColorTimeline.ENTRIES])}}for(u=0,h=n.readInt(!0);u<h;u++){var y=n.readInt(!0);for(f=0,d=n.readInt(!0);f<d;f++)switch(p=n.readByte(),m=n.readInt(!0),p){case e.BONE_ROTATE:for((x=new t.RotateTimeline(m)).boneIndex=y,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat()),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.RotateTimeline.ENTRIES]);break;case e.BONE_TRANSLATE:case e.BONE_SCALE:case e.BONE_SHEAR:var x=void 0,S=1;for(p==e.BONE_SCALE?x=new t.ScaleTimeline(m):p==e.BONE_SHEAR?x=new t.ShearTimeline(m):(x=new t.TranslateTimeline(m),S=a),x.boneIndex=y,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat()*S,n.readFloat()*S),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.TranslateTimeline.ENTRIES])}}for(u=0,h=n.readInt(!0);u<h;u++){var A=n.readInt(!0);for(m=n.readInt(!0),(x=new t.IkConstraintTimeline(m)).ikConstraintIndex=A,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat(),n.readFloat()*a,n.readByte(),n.readBoolean(),n.readBoolean()),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.IkConstraintTimeline.ENTRIES])}for(u=0,h=n.readInt(!0);u<h;u++){for(A=n.readInt(!0),m=n.readInt(!0),(x=new t.TransformConstraintTimeline(m)).transformConstraintIndex=A,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat(),n.readFloat(),n.readFloat(),n.readFloat()),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.TransformConstraintTimeline.ENTRIES])}for(u=0,h=n.readInt(!0);u<h;u++){A=n.readInt(!0);var C=r.pathConstraints[A];for(f=0,d=n.readInt(!0);f<d;f++)switch(p=n.readByte(),m=n.readInt(!0),p){case e.PATH_POSITION:case e.PATH_SPACING:for(x=void 0,S=1,p==e.PATH_SPACING?(x=new t.PathConstraintSpacingTimeline(m),C.spacingMode!=t.SpacingMode.Length&&C.spacingMode!=t.SpacingMode.Fixed||(S=a)):(x=new t.PathConstraintPositionTimeline(m),C.positionMode==t.PositionMode.Fixed&&(S=a)),x.pathConstraintIndex=A,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat()*S),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.PathConstraintPositionTimeline.ENTRIES]);break;case e.PATH_MIX:for((x=new t.PathConstraintMixTimeline(m)).pathConstraintIndex=A,v=0;v<m;v++)x.setFrame(v,n.readFloat(),n.readFloat(),n.readFloat()),v<m-1&&this.readCurve(n,v,x);o.push(x),s=Math.max(s,x.frames[(m-1)*t.PathConstraintMixTimeline.ENTRIES])}}for(u=0,h=n.readInt(!0);u<h;u++){var b=r.skins[n.readInt(!0)];for(f=0,d=n.readInt(!0);f<d;f++){_=n.readInt(!0);for(var T=0,E=n.readInt(!0);T<E;T++){var w=b.getAttachment(_,n.readStringRef()),P=null!=w.bones,I=w.vertices,R=P?I.length/3*2:I.length;for(m=n.readInt(!0),(x=new t.DeformTimeline(m)).slotIndex=_,x.attachment=w,v=0;v<m;v++){g=n.readFloat();var D=void 0,M=n.readInt(!0);if(0==M)D=P?t.Utils.newFloatArray(R):I;else{D=t.Utils.newFloatArray(R);var B=n.readInt(!0);if(M+=B,1==a)for(var O=B;O<M;O++)D[O]=n.readFloat();else for(O=B;O<M;O++)D[O]=n.readFloat()*a;if(!P){O=0;for(var N=D.length;O<N;O++)D[O]+=I[O]}}x.setFrame(v,g,D),v<m-1&&this.readCurve(n,v,x)}o.push(x),s=Math.max(s,x.frames[m-1])}}}var L=n.readInt(!0);if(L>0){x=new t.DrawOrderTimeline(L);var F=r.slots.length;for(u=0;u<L;u++){g=n.readFloat();var z=n.readInt(!0),V=t.Utils.newArray(F,0);for(f=F-1;f>=0;f--)V[f]=-1;var k=t.Utils.newArray(F-z,0),G=0,U=0;for(f=0;f<z;f++){for(_=n.readInt(!0);G!=_;)k[U++]=G++;V[G+n.readInt(!0)]=G++}for(;G<F;)k[U++]=G++;for(f=F-1;f>=0;f--)-1==V[f]&&(V[f]=k[--U]);x.setFrame(u,g,V)}o.push(x),s=Math.max(s,x.frames[L-1])}var H=n.readInt(!0);if(H>0){for(x=new t.EventTimeline(H),u=0;u<H;u++){g=n.readFloat();var j=r.events[n.readInt(!0)],W=new t.Event(g,j);W.intValue=n.readInt(!1),W.floatValue=n.readFloat(),W.stringValue=n.readBoolean()?n.readString():j.stringValue,null!=W.data.audioPath&&(W.volume=n.readFloat(),W.balance=n.readFloat()),x.setFrame(u,W)}o.push(x),s=Math.max(s,x.frames[H-1])}return new t.Animation(i,o,s)},e.prototype.readCurve=function(t,n,i){switch(t.readByte()){case e.CURVE_STEPPED:i.setStepped(n);break;case e.CURVE_BEZIER:this.setCurve(i,n,t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat())}},e.prototype.setCurve=function(t,e,n,i,r,o){t.setCurve(e,n,i,r,o)},e.AttachmentTypeValues=[0,1,2,3,4,5,6],e.TransformModeValues=[t.TransformMode.Normal,t.TransformMode.OnlyTranslation,t.TransformMode.NoRotationOrReflection,t.TransformMode.NoScale,t.TransformMode.NoScaleOrReflection],e.PositionModeValues=[t.PositionMode.Fixed,t.PositionMode.Percent],e.SpacingModeValues=[t.SpacingMode.Length,t.SpacingMode.Fixed,t.SpacingMode.Percent],e.RotateModeValues=[t.RotateMode.Tangent,t.RotateMode.Chain,t.RotateMode.ChainScale],e.BlendModeValues=[t.BlendMode.Normal,t.BlendMode.Additive,t.BlendMode.Multiply,t.BlendMode.Screen],e.BONE_ROTATE=0,e.BONE_TRANSLATE=1,e.BONE_SCALE=2,e.BONE_SHEAR=3,e.SLOT_ATTACHMENT=0,e.SLOT_COLOR=1,e.SLOT_TWO_COLOR=2,e.PATH_POSITION=0,e.PATH_SPACING=1,e.PATH_MIX=2,e.CURVE_LINEAR=0,e.CURVE_STEPPED=1,e.CURVE_BEZIER=2,e}();t.SkeletonBinary=e;var n=function(){function t(t,e,n,i){void 0===e&&(e=new Array),void 0===n&&(n=0),void 0===i&&(i=new DataView(t.buffer)),this.strings=e,this.index=n,this.buffer=i}return t.prototype.readByte=function(){return this.buffer.getInt8(this.index++)},t.prototype.readShort=function(){var t=this.buffer.getInt16(this.index);return this.index+=2,t},t.prototype.readInt32=function(){var t=this.buffer.getInt32(this.index);return this.index+=4,t},t.prototype.readInt=function(t){var e=this.readByte(),n=127&e;return 0!=(128&e)&&(n|=(127&(e=this.readByte()))<<7,0!=(128&e)&&(n|=(127&(e=this.readByte()))<<14,0!=(128&e)&&(n|=(127&(e=this.readByte()))<<21,0!=(128&e)&&(n|=(127&(e=this.readByte()))<<28)))),t?n:n>>>1^-(1&n)},t.prototype.readStringRef=function(){var t=this.readInt(!0);return 0==t?null:this.strings[t-1]},t.prototype.readString=function(){var t=this.readInt(!0);switch(t){case 0:return null;case 1:return""}t--;for(var e="",n=0;n<t;){var i=this.readByte();switch(i>>4){case 12:case 13:e+=String.fromCharCode((31&i)<<6|63&this.readByte()),n+=2;break;case 14:e+=String.fromCharCode((15&i)<<12|(63&this.readByte())<<6|63&this.readByte()),n+=3;break;default:e+=String.fromCharCode(i),n++}}return e},t.prototype.readFloat=function(){var t=this.buffer.getFloat32(this.index);return this.index+=4,t},t.prototype.readBoolean=function(){return 0!=this.readByte()},t}(),i=function(t,e,n,i,r){this.mesh=t,this.skin=e,this.slotIndex=n,this.parent=i,this.inheritDeform=r},r=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.bones=t,this.vertices=e}}(net||(net={})),function(t){var e=function(){function e(){this.minX=0,this.minY=0,this.maxX=0,this.maxY=0,this.boundingBoxes=new Array,this.polygons=new Array,this.polygonPool=new t.Pool((function(){return t.Utils.newFloatArray(16)}))}return e.prototype.update=function(e,n){if(null==e)throw new Error("skeleton cannot be null.");var i=this.boundingBoxes,r=this.polygons,o=this.polygonPool,a=e.slots,s=a.length;i.length=0,o.freeAll(r),r.length=0;for(var c=0;c<s;c++){var l=a[c];if(l.bone.active){var u=l.getAttachment();if(u instanceof t.BoundingBoxAttachment){var h=u;i.push(h);var _=o.obtain();_.length!=h.worldVerticesLength&&(_=t.Utils.newFloatArray(h.worldVerticesLength)),r.push(_),h.computeWorldVertices(l,0,h.worldVerticesLength,_,0,2)}}}n?this.aabbCompute():(this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY)},e.prototype.aabbCompute=function(){for(var t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY,r=this.polygons,o=0,a=r.length;o<a;o++)for(var s=r[o],c=s,l=0,u=s.length;l<u;l+=2){var h=c[l],_=c[l+1];t=Math.min(t,h),e=Math.min(e,_),n=Math.max(n,h),i=Math.max(i,_)}this.minX=t,this.minY=e,this.maxX=n,this.maxY=i},e.prototype.aabbContainsPoint=function(t,e){return t>=this.minX&&t<=this.maxX&&e>=this.minY&&e<=this.maxY},e.prototype.aabbIntersectsSegment=function(t,e,n,i){var r=this.minX,o=this.minY,a=this.maxX,s=this.maxY;if(t<=r&&n<=r||e<=o&&i<=o||t>=a&&n>=a||e>=s&&i>=s)return!1;var c=(i-e)/(n-t),l=c*(r-t)+e;if(l>o&&l<s)return!0;if((l=c*(a-t)+e)>o&&l<s)return!0;var u=(o-e)/c+t;return u>r&&u<a||(u=(s-e)/c+t)>r&&u<a},e.prototype.aabbIntersectsSkeleton=function(t){return this.minX<t.maxX&&this.maxX>t.minX&&this.minY<t.maxY&&this.maxY>t.minY},e.prototype.containsPoint=function(t,e){for(var n=this.polygons,i=0,r=n.length;i<r;i++)if(this.containsPointPolygon(n[i],t,e))return this.boundingBoxes[i];return null},e.prototype.containsPointPolygon=function(t,e,n){for(var i=t,r=t.length,o=r-2,a=!1,s=0;s<r;s+=2){var c=i[s+1],l=i[o+1];if(c<n&&l>=n||l<n&&c>=n){var u=i[s];u+(n-c)/(l-c)*(i[o]-u)<e&&(a=!a)}o=s}return a},e.prototype.intersectsSegment=function(t,e,n,i){for(var r=this.polygons,o=0,a=r.length;o<a;o++)if(this.intersectsSegmentPolygon(r[o],t,e,n,i))return this.boundingBoxes[o];return null},e.prototype.intersectsSegmentPolygon=function(t,e,n,i,r){for(var o=t,a=t.length,s=e-i,c=n-r,l=e*r-n*i,u=o[a-2],h=o[a-1],_=0;_<a;_+=2){var f=o[_],d=o[_+1],p=u*d-h*f,m=u-f,v=h-d,g=s*v-c*m,y=(l*m-s*p)/g;if((y>=u&&y<=f||y>=f&&y<=u)&&(y>=e&&y<=i||y>=i&&y<=e)){var x=(l*v-c*p)/g;if((x>=h&&x<=d||x>=d&&x<=h)&&(x>=n&&x<=r||x>=r&&x<=n))return!0}u=f,h=d}return!1},e.prototype.getPolygon=function(t){if(null==t)throw new Error("boundingBox cannot be null.");var e=this.boundingBoxes.indexOf(t);return-1==e?null:this.polygons[e]},e.prototype.getWidth=function(){return this.maxX-this.minX},e.prototype.getHeight=function(){return this.maxY-this.minY},e}();t.SkeletonBounds=e}(net||(net={})),function(t){var e=function(){function e(){this.triangulator=new t.Triangulator,this.clippingPolygon=new Array,this.clipOutput=new Array,this.clippedVertices=new Array,this.clippedTriangles=new Array,this.scratch=new Array}return e.prototype.clipStart=function(n,i){if(null!=this.clipAttachment)return 0;this.clipAttachment=i;var r=i.worldVerticesLength,o=t.Utils.setArraySize(this.clippingPolygon,r);i.computeWorldVertices(n,0,r,o,0,2);var a=this.clippingPolygon;e.makeClockwise(a);for(var s=this.clippingPolygons=this.triangulator.decompose(a,this.triangulator.triangulate(a)),c=0,l=s.length;c<l;c++){var u=s[c];e.makeClockwise(u),u.push(u[0]),u.push(u[1])}return s.length},e.prototype.clipEndWithSlot=function(t){null!=this.clipAttachment&&this.clipAttachment.endSlot==t.data&&this.clipEnd()},e.prototype.clipEnd=function(){null!=this.clipAttachment&&(this.clipAttachment=null,this.clippingPolygons=null,this.clippedVertices.length=0,this.clippedTriangles.length=0,this.clippingPolygon.length=0)},e.prototype.isClipping=function(){return null!=this.clipAttachment},e.prototype.clipTriangles=function(e,n,i,r,o,a,s,c,l,u,h){void 0===l&&(l=2),void 0===u&&(u=0),void 0===h&&(h=0);var _=this.clipOutput,f=this.clippedVertices,d=this.clippedTriangles,p=this.clippingPolygons,m=this.clippingPolygons.length,v=c?12:8,g=0;f.length=0,d.length=0;t:for(var y=0;y<r;y+=3)for(var x=i[y]*l,S=e[x+u],A=e[x+u+1],C=o[x+h],b=o[x+h+1],T=e[(x=i[y+1]*l)+u],E=e[x+u+1],w=o[x+h],P=o[x+h+1],I=e[(x=i[y+2]*l)+u],R=e[x+u+1],D=o[x+h],M=o[x+h+1],B=0;B<m;B++){var O=f.length;if(!this.clip(S,A,T,E,I,R,p[B],_)){(H=t.Utils.setArraySize(f,O+3*v))[O]=S,H[O+1]=A,H[O+2]=a.r,H[O+3]=a.g,H[O+4]=a.b,H[O+5]=a.a,c?(H[O+6]=C,H[O+7]=b,H[O+8]=s.r,H[O+9]=s.g,H[O+10]=s.b,H[O+11]=s.a,H[O+12]=T,H[O+13]=E,H[O+14]=a.r,H[O+15]=a.g,H[O+16]=a.b,H[O+17]=a.a,H[O+18]=w,H[O+19]=P,H[O+20]=s.r,H[O+21]=s.g,H[O+22]=s.b,H[O+23]=s.a,H[O+24]=I,H[O+25]=R,H[O+26]=a.r,H[O+27]=a.g,H[O+28]=a.b,H[O+29]=a.a,H[O+30]=D,H[O+31]=M,H[O+32]=s.r,H[O+33]=s.g,H[O+34]=s.b,H[O+35]=s.a):(H[O+6]=C,H[O+7]=b,H[O+8]=T,H[O+9]=E,H[O+10]=a.r,H[O+11]=a.g,H[O+12]=a.b,H[O+13]=a.a,H[O+14]=w,H[O+15]=P,H[O+16]=I,H[O+17]=R,H[O+18]=a.r,H[O+19]=a.g,H[O+20]=a.b,H[O+21]=a.a,H[O+22]=D,H[O+23]=M),O=d.length,(Z=t.Utils.setArraySize(d,O+3))[O]=g,Z[O+1]=g+1,Z[O+2]=g+2,g+=3;continue t}var N=_.length;if(0!=N){for(var L=E-R,F=I-T,z=S-I,V=R-A,k=1/(L*z+F*(A-R)),G=N>>1,U=this.clipOutput,H=t.Utils.setArraySize(f,O+G*v),j=0;j<N;j+=2){var W=U[j],q=U[j+1];H[O]=W,H[O+1]=q,H[O+2]=a.r,H[O+3]=a.g,H[O+4]=a.b,H[O+5]=a.a;var X=W-I,Y=q-R,K=(L*X+F*Y)*k,J=(V*X+z*Y)*k,Q=1-K-J;H[O+6]=C*K+w*J+D*Q,H[O+7]=b*K+P*J+M*Q,c&&(H[O+8]=s.r,H[O+9]=s.g,H[O+10]=s.b,H[O+11]=s.a),O+=v}O=d.length;var Z=t.Utils.setArraySize(d,O+3*(G-2));for(G--,j=1;j<G;j++)Z[O]=g,Z[O+1]=g+j,Z[O+2]=g+j+1,O+=3;g+=G+1}}},e.prototype.clip=function(t,e,n,i,r,o,a,s){var c=s,l=!1,u=null;a.length%4>=2?(u=s,s=this.scratch):u=this.scratch,u.length=0,u.push(t),u.push(e),u.push(n),u.push(i),u.push(r),u.push(o),u.push(t),u.push(e),s.length=0;for(var h=a,_=a.length-4,f=0;;f+=2){for(var d=h[f],p=h[f+1],m=h[f+2],v=h[f+3],g=d-m,y=p-v,x=u,S=u.length-2,A=s.length,C=0;C<S;C+=2){var b=x[C],T=x[C+1],E=x[C+2],w=x[C+3],P=g*(w-v)-y*(E-m)>0;if(g*(T-v)-y*(b-m)>0){if(P){s.push(E),s.push(w);continue}var I=(D=w-T)*(m-d)-(M=E-b)*(v-p);if(Math.abs(I)>1e-6){var R=(M*(p-T)-D*(d-b))/I;s.push(d+(m-d)*R),s.push(p+(v-p)*R)}else s.push(d),s.push(p)}else if(P){var D,M;I=(D=w-T)*(m-d)-(M=E-b)*(v-p),Math.abs(I)>1e-6?(R=(M*(p-T)-D*(d-b))/I,s.push(d+(m-d)*R),s.push(p+(v-p)*R)):(s.push(d),s.push(p)),s.push(E),s.push(w)}l=!0}if(A==s.length)return c.length=0,!0;if(s.push(s[0]),s.push(s[1]),f==_)break;var B=s;(s=u).length=0,u=B}if(c!=s){c.length=0,f=0;for(var O=s.length-2;f<O;f++)c[f]=s[f]}else c.length=c.length-2;return l},e.makeClockwise=function(t){for(var e=t,n=t.length,i=e[n-2]*e[1]-e[0]*e[n-1],r=0,o=0,a=0,s=0,c=n-3;s<c;s+=2)r=e[s],o=e[s+1],a=e[s+2],i+=r*e[s+3]-a*o;if(!(i<0)){s=0;var l=n-2;for(c=n>>1;s<c;s+=2){var u=e[s],h=e[s+1],_=l-s;e[s]=e[_],e[s+1]=e[_+1],e[_]=u,e[_+1]=h}}},e}();t.SkeletonClipping=e}(net||(net={})),function(t){var e=function(){function t(){this.bones=new Array,this.slots=new Array,this.skins=new Array,this.events=new Array,this.animations=new Array,this.ikConstraints=new Array,this.transformConstraints=new Array,this.pathConstraints=new Array,this.fps=0}return t.prototype.findBone=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findBoneIndex=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,n=0,i=e.length;n<i;n++)if(e[n].name==t)return n;return-1},t.prototype.findSlot=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findSlotIndex=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,n=0,i=e.length;n<i;n++)if(e[n].name==t)return n;return-1},t.prototype.findSkin=function(t){if(null==t)throw new Error("skinName cannot be null.");for(var e=this.skins,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findEvent=function(t){if(null==t)throw new Error("eventDataName cannot be null.");for(var e=this.events,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findAnimation=function(t){if(null==t)throw new Error("animationName cannot be null.");for(var e=this.animations,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findIkConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.ikConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findTransformConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.transformConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findPathConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.pathConstraints,n=0,i=e.length;n<i;n++){var r=e[n];if(r.name==t)return r}return null},t.prototype.findPathConstraintIndex=function(t){if(null==t)throw new Error("pathConstraintName cannot be null.");for(var e=this.pathConstraints,n=0,i=e.length;n<i;n++)if(e[n].name==t)return n;return-1},t}();t.SkeletonData=e}(net||(net={})),function(t){var e=function(){function e(t){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=t}return e.prototype.readSkeletonData=function(n){var i=this.scale,r=new t.SkeletonData,o="string"==typeof n?JSON.parse(n):n,a=o.skeleton;if(null!=a&&(r.hash=a.hash,r.version=a.spine,r.x=a.x,r.y=a.y,r.width=a.width,r.height=a.height,r.fps=a.fps,r.imagesPath=a.images),o.bones)for(var s=0;s<o.bones.length;s++){var c=o.bones[s],l=null,u=this.getValue(c,"parent",null);if(null!=u&&null==(l=r.findBone(u)))throw new Error("Parent bone not found: "+u);(d=new t.BoneData(r.bones.length,c.name,l)).length=this.getValue(c,"length",0)*i,d.x=this.getValue(c,"x",0)*i,d.y=this.getValue(c,"y",0)*i,d.rotation=this.getValue(c,"rotation",0),d.scaleX=this.getValue(c,"scaleX",1),d.scaleY=this.getValue(c,"scaleY",1),d.shearX=this.getValue(c,"shearX",0),d.shearY=this.getValue(c,"shearY",0),d.transformMode=e.transformModeFromString(this.getValue(c,"transform","normal")),d.skinRequired=this.getValue(c,"skin",!1),r.bones.push(d)}if(o.slots)for(s=0;s<o.slots.length;s++){var h=(I=o.slots[s]).name,_=I.bone,f=r.findBone(_);if(null==f)throw new Error("Slot bone not found: "+_);var d=new t.SlotData(r.slots.length,h,f),p=this.getValue(I,"color",null);null!=p&&d.color.setFromString(p);var m=this.getValue(I,"dark",null);null!=m&&(d.darkColor=new t.Color(1,1,1,1),d.darkColor.setFromString(m)),d.attachmentName=this.getValue(I,"attachment",null),d.blendMode=e.blendModeFromString(this.getValue(I,"blend","normal")),r.slots.push(d)}if(o.ik)for(s=0;s<o.ik.length;s++){var v=o.ik[s];(d=new t.IkConstraintData(v.name)).order=this.getValue(v,"order",0),d.skinRequired=this.getValue(v,"skin",!1);for(var g=0;g<v.bones.length;g++){if(_=v.bones[g],null==(E=r.findBone(_)))throw new Error("IK bone not found: "+_);d.bones.push(E)}var y=v.target;if(d.target=r.findBone(y),null==d.target)throw new Error("IK target bone not found: "+y);d.mix=this.getValue(v,"mix",1),d.softness=this.getValue(v,"softness",0)*i,d.bendDirection=this.getValue(v,"bendPositive",!0)?1:-1,d.compress=this.getValue(v,"compress",!1),d.stretch=this.getValue(v,"stretch",!1),d.uniform=this.getValue(v,"uniform",!1),r.ikConstraints.push(d)}if(o.transform)for(s=0;s<o.transform.length;s++){for(v=o.transform[s],(d=new t.TransformConstraintData(v.name)).order=this.getValue(v,"order",0),d.skinRequired=this.getValue(v,"skin",!1),g=0;g<v.bones.length;g++){if(_=v.bones[g],null==(E=r.findBone(_)))throw new Error("Transform constraint bone not found: "+_);d.bones.push(E)}if(y=v.target,d.target=r.findBone(y),null==d.target)throw new Error("Transform constraint target bone not found: "+y);d.local=this.getValue(v,"local",!1),d.relative=this.getValue(v,"relative",!1),d.offsetRotation=this.getValue(v,"rotation",0),d.offsetX=this.getValue(v,"x",0)*i,d.offsetY=this.getValue(v,"y",0)*i,d.offsetScaleX=this.getValue(v,"scaleX",0),d.offsetScaleY=this.getValue(v,"scaleY",0),d.offsetShearY=this.getValue(v,"shearY",0),d.rotateMix=this.getValue(v,"rotateMix",1),d.translateMix=this.getValue(v,"translateMix",1),d.scaleMix=this.getValue(v,"scaleMix",1),d.shearMix=this.getValue(v,"shearMix",1),r.transformConstraints.push(d)}if(o.path)for(s=0;s<o.path.length;s++){for(v=o.path[s],(d=new t.PathConstraintData(v.name)).order=this.getValue(v,"order",0),d.skinRequired=this.getValue(v,"skin",!1),g=0;g<v.bones.length;g++){if(_=v.bones[g],null==(E=r.findBone(_)))throw new Error("Transform constraint bone not found: "+_);d.bones.push(E)}if(y=v.target,d.target=r.findSlot(y),null==d.target)throw new Error("Path target slot not found: "+y);d.positionMode=e.positionModeFromString(this.getValue(v,"positionMode","percent")),d.spacingMode=e.spacingModeFromString(this.getValue(v,"spacingMode","length")),d.rotateMode=e.rotateModeFromString(this.getValue(v,"rotateMode","tangent")),d.offsetRotation=this.getValue(v,"rotation",0),d.position=this.getValue(v,"position",0),d.positionMode==t.PositionMode.Fixed&&(d.position*=i),d.spacing=this.getValue(v,"spacing",0),d.spacingMode!=t.SpacingMode.Length&&d.spacingMode!=t.SpacingMode.Fixed||(d.spacing*=i),d.rotateMix=this.getValue(v,"rotateMix",1),d.translateMix=this.getValue(v,"translateMix",1),r.pathConstraints.push(d)}if(o.skins){var x=o.skins;if(!(x instanceof Array)){var S=[];for(var A in x)S.push({name:A,attachments:x[A]});x=S}for(s=0;s<x.length;s++){var C=x[s],b=new t.Skin(C.name);if(C.bones)for(var T=0;T<C.bones.length;T++){var E;if(null==(E=r.findBone(C.bones[T])))throw new Error("Skin bone not found: "+C.bones[s]);b.bones.push(E)}if(C.ik)for(T=0;T<C.ik.length;T++){if(null==(w=r.findIkConstraint(C.ik[T])))throw new Error("Skin IK constraint not found: "+C.ik[s]);b.constraints.push(w)}if(C.transform)for(T=0;T<C.transform.length;T++){if(null==(w=r.findTransformConstraint(C.transform[T])))throw new Error("Skin transform constraint not found: "+C.transform[s]);b.constraints.push(w)}if(C.path)for(T=0;T<C.path.length;T++){var w;if(null==(w=r.findPathConstraint(C.path[T])))throw new Error("Skin path constraint not found: "+C.path[s]);b.constraints.push(w)}for(var h in C.attachments){var P=r.findSlot(h);if(null==P)throw new Error("Slot not found: "+h);var I=C.attachments[h];for(var R in I){var D=this.readAttachment(I[R],b,P.index,R,r);null!=D&&b.setAttachment(P.index,R,D)}}r.skins.push(b),"default"==b.name&&(r.defaultSkin=b)}}s=0;for(var M=this.linkedMeshes.length;s<M;s++){var B=this.linkedMeshes[s];if(null==(b=null==B.skin?r.defaultSkin:r.findSkin(B.skin)))throw new Error("Skin not found: "+B.skin);var O=b.getAttachment(B.slotIndex,B.parent);if(null==O)throw new Error("Parent mesh not found: "+B.parent);B.mesh.deformAttachment=B.inheritDeform?O:B.mesh,B.mesh.setParentMesh(O),B.mesh.updateUVs()}if(this.linkedMeshes.length=0,o.events)for(var N in o.events){var L=o.events[N];(d=new t.EventData(N)).intValue=this.getValue(L,"int",0),d.floatValue=this.getValue(L,"float",0),d.stringValue=this.getValue(L,"string",""),d.audioPath=this.getValue(L,"audio",null),null!=d.audioPath&&(d.volume=this.getValue(L,"volume",1),d.balance=this.getValue(L,"balance",0)),r.events.push(d)}if(o.animations)for(var F in o.animations){var z=o.animations[F];this.readAnimation(z,F,r)}return r},e.prototype.readAttachment=function(e,i,r,o,a){var s=this.scale;switch(o=this.getValue(e,"name",o),this.getValue(e,"type","region")){case"region":var c=this.getValue(e,"path",o),l=this.attachmentLoader.newRegionAttachment(i,o,c);return null==l?null:(l.path=c,l.x=this.getValue(e,"x",0)*s,l.y=this.getValue(e,"y",0)*s,l.scaleX=this.getValue(e,"scaleX",1),l.scaleY=this.getValue(e,"scaleY",1),l.rotation=this.getValue(e,"rotation",0),l.width=e.width*s,l.height=e.height*s,null!=(y=this.getValue(e,"color",null))&&l.color.setFromString(y),l.updateOffset(),l);case"boundingbox":var u=this.attachmentLoader.newBoundingBoxAttachment(i,o);return null==u?null:(this.readVertices(e,u,e.vertexCount<<1),null!=(y=this.getValue(e,"color",null))&&u.color.setFromString(y),u);case"mesh":case"linkedmesh":c=this.getValue(e,"path",o);var h=this.attachmentLoader.newMeshAttachment(i,o,c);if(null==h)return null;h.path=c,null!=(y=this.getValue(e,"color",null))&&h.color.setFromString(y),h.width=this.getValue(e,"width",0)*s,h.height=this.getValue(e,"height",0)*s;var _=this.getValue(e,"parent",null);if(null!=_)return this.linkedMeshes.push(new n(h,this.getValue(e,"skin",null),r,_,this.getValue(e,"deform",!0))),h;var f=e.uvs;return this.readVertices(e,h,f.length),h.triangles=e.triangles,h.regionUVs=f,h.updateUVs(),h.edges=this.getValue(e,"edges",null),h.hullLength=2*this.getValue(e,"hull",0),h;case"path":if(null==(c=this.attachmentLoader.newPathAttachment(i,o)))return null;c.closed=this.getValue(e,"closed",!1),c.constantSpeed=this.getValue(e,"constantSpeed",!0);var d=e.vertexCount;this.readVertices(e,c,d<<1);for(var p=t.Utils.newArray(d/3,0),m=0;m<e.lengths.length;m++)p[m]=e.lengths[m]*s;return c.lengths=p,null!=(y=this.getValue(e,"color",null))&&c.color.setFromString(y),c;case"point":var v=this.attachmentLoader.newPointAttachment(i,o);return null==v?null:(v.x=this.getValue(e,"x",0)*s,v.y=this.getValue(e,"y",0)*s,v.rotation=this.getValue(e,"rotation",0),null!=(y=this.getValue(e,"color",null))&&v.color.setFromString(y),v);case"clipping":var g=this.attachmentLoader.newClippingAttachment(i,o);if(null==g)return null;var y,x=this.getValue(e,"end",null);if(null!=x){var S=a.findSlot(x);if(null==S)throw new Error("Clipping end slot not found: "+x);g.endSlot=S}return d=e.vertexCount,this.readVertices(e,g,d<<1),null!=(y=this.getValue(e,"color",null))&&g.color.setFromString(y),g}return null},e.prototype.readVertices=function(e,n,i){var r=this.scale;n.worldVerticesLength=i;var o=e.vertices;if(i!=o.length){var a=new Array,s=new Array;for(h=0,_=o.length;h<_;){var c=o[h++];s.push(c);for(var l=h+4*c;h<l;h+=4)s.push(o[h]),a.push(o[h+1]*r),a.push(o[h+2]*r),a.push(o[h+3])}n.bones=s,n.vertices=t.Utils.toFloatArray(a)}else{var u=t.Utils.toFloatArray(o);if(1!=r)for(var h=0,_=o.length;h<_;h++)u[h]*=r;n.vertices=u}},e.prototype.readAnimation=function(e,n,i){var r=this.scale,o=new Array,a=0;if(e.slots)for(var s in e.slots){var c=e.slots[s];if(-1==(Q=i.findSlotIndex(s)))throw new Error("Slot not found: "+s);for(var l in c){var u=c[l];if("attachment"==l){(x=new t.AttachmentTimeline(u.length)).slotIndex=Q;for(var h=0,_=0;_<u.length;_++){var f=u[_];x.setFrame(h++,this.getValue(f,"time",0),f.name)}o.push(x),a=Math.max(a,x.frames[x.getFrameCount()-1])}else if("color"==l){for((x=new t.ColorTimeline(u.length)).slotIndex=Q,h=0,_=0;_<u.length;_++){f=u[_];var d=new t.Color;d.setFromString(f.color),x.setFrame(h,this.getValue(f,"time",0),d.r,d.g,d.b,d.a),this.readCurve(f,x,h),h++}o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.ColorTimeline.ENTRIES])}else{if("twoColor"!=l)throw new Error("Invalid timeline type for a slot: "+l+" ("+s+")");for((x=new t.TwoColorTimeline(u.length)).slotIndex=Q,h=0,_=0;_<u.length;_++){f=u[_];var p=new t.Color,m=new t.Color;p.setFromString(f.light),m.setFromString(f.dark),x.setFrame(h,this.getValue(f,"time",0),p.r,p.g,p.b,p.a,m.r,m.g,m.b),this.readCurve(f,x,h),h++}o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.TwoColorTimeline.ENTRIES])}}}if(e.bones)for(var v in e.bones){var g=e.bones[v],y=i.findBoneIndex(v);if(-1==y)throw new Error("Bone not found: "+v);for(var l in g)if(u=g[l],"rotate"===l){for((x=new t.RotateTimeline(u.length)).boneIndex=y,h=0,_=0;_<u.length;_++)f=u[_],x.setFrame(h,this.getValue(f,"time",0),this.getValue(f,"angle",0)),this.readCurve(f,x,h),h++;o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.RotateTimeline.ENTRIES])}else{if("translate"!==l&&"scale"!==l&&"shear"!==l)throw new Error("Invalid timeline type for a bone: "+l+" ("+v+")");var x=null,S=1,A=0;for("scale"===l?(x=new t.ScaleTimeline(u.length),A=1):"shear"===l?x=new t.ShearTimeline(u.length):(x=new t.TranslateTimeline(u.length),S=r),x.boneIndex=y,h=0,_=0;_<u.length;_++){f=u[_];var C=this.getValue(f,"x",A),b=this.getValue(f,"y",A);x.setFrame(h,this.getValue(f,"time",0),C*S,b*S),this.readCurve(f,x,h),h++}o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.TranslateTimeline.ENTRIES])}}if(e.ik)for(var T in e.ik){var E=e.ik[T],w=i.findIkConstraint(T);for((x=new t.IkConstraintTimeline(E.length)).ikConstraintIndex=i.ikConstraints.indexOf(w),h=0,_=0;_<E.length;_++)f=E[_],x.setFrame(h,this.getValue(f,"time",0),this.getValue(f,"mix",1),this.getValue(f,"softness",0)*r,this.getValue(f,"bendPositive",!0)?1:-1,this.getValue(f,"compress",!1),this.getValue(f,"stretch",!1)),this.readCurve(f,x,h),h++;o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.IkConstraintTimeline.ENTRIES])}if(e.transform)for(var T in e.transform){for(E=e.transform[T],w=i.findTransformConstraint(T),(x=new t.TransformConstraintTimeline(E.length)).transformConstraintIndex=i.transformConstraints.indexOf(w),h=0,_=0;_<E.length;_++)f=E[_],x.setFrame(h,this.getValue(f,"time",0),this.getValue(f,"rotateMix",1),this.getValue(f,"translateMix",1),this.getValue(f,"scaleMix",1),this.getValue(f,"shearMix",1)),this.readCurve(f,x,h),h++;o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.TransformConstraintTimeline.ENTRIES])}var P=e.path||e.paths;if(P)for(var T in P){E=P[T];var I=i.findPathConstraintIndex(T);if(-1==I)throw new Error("Path constraint not found: "+T);var R=i.pathConstraints[I];for(var l in E)if(u=E[l],"position"===l||"spacing"===l){for(x=null,S=1,"spacing"===l?(x=new t.PathConstraintSpacingTimeline(u.length),R.spacingMode!=t.SpacingMode.Length&&R.spacingMode!=t.SpacingMode.Fixed||(S=r)):(x=new t.PathConstraintPositionTimeline(u.length),R.positionMode==t.PositionMode.Fixed&&(S=r)),x.pathConstraintIndex=I,h=0,_=0;_<u.length;_++)f=u[_],x.setFrame(h,this.getValue(f,"time",0),this.getValue(f,l,0)*S),this.readCurve(f,x,h),h++;o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.PathConstraintPositionTimeline.ENTRIES])}else if("mix"===l){for((x=new t.PathConstraintMixTimeline(u.length)).pathConstraintIndex=I,h=0,_=0;_<u.length;_++)f=u[_],x.setFrame(h,this.getValue(f,"time",0),this.getValue(f,"rotateMix",1),this.getValue(f,"translateMix",1)),this.readCurve(f,x,h),h++;o.push(x),a=Math.max(a,x.frames[(x.getFrameCount()-1)*t.PathConstraintMixTimeline.ENTRIES])}}if(e.deform)for(var D in e.deform){var M=e.deform[D],B=i.findSkin(D);if(null==B)throw new Error("Skin not found: "+D);for(var s in M){if(c=M[s],-1==(Q=i.findSlotIndex(s)))throw new Error("Slot not found: "+c.name);for(var l in c){u=c[l];var O=B.getAttachment(Q,l);if(null!=O){var N=null!=O.bones,L=O.vertices,F=N?L.length/3*2:L.length;(x=new t.DeformTimeline(u.length)).slotIndex=Q,x.attachment=O,h=0;for(var z=0;z<u.length;z++){f=u[z];var V=void 0,k=this.getValue(f,"vertices",null);if(null==k)V=N?t.Utils.newFloatArray(F):L;else{V=t.Utils.newFloatArray(F);var G=this.getValue(f,"offset",0);if(t.Utils.arrayCopy(k,0,V,G,k.length),1!=r)for(var U=(_=G)+k.length;_<U;_++)V[_]*=r;if(!N)for(_=0;_<F;_++)V[_]+=L[_]}x.setFrame(h,this.getValue(f,"time",0),V),this.readCurve(f,x,h),h++}o.push(x),a=Math.max(a,x.frames[x.getFrameCount()-1])}}}}var H=e.drawOrder;if(null==H&&(H=e.draworder),null!=H){x=new t.DrawOrderTimeline(H.length);var j=i.slots.length;for(h=0,z=0;z<H.length;z++){var W=H[z],q=null,X=this.getValue(W,"offsets",null);if(null!=X){q=t.Utils.newArray(j,-1);var Y=t.Utils.newArray(j-X.length,0),K=0,J=0;for(_=0;_<X.length;_++){var Q,Z=X[_];if(-1==(Q=i.findSlotIndex(Z.slot)))throw new Error("Slot not found: "+Z.slot);for(;K!=Q;)Y[J++]=K++;q[K+Z.offset]=K++}for(;K<j;)Y[J++]=K++;for(_=j-1;_>=0;_--)-1==q[_]&&(q[_]=Y[--J])}x.setFrame(h++,this.getValue(W,"time",0),q)}o.push(x),a=Math.max(a,x.frames[x.getFrameCount()-1])}if(e.events){for(x=new t.EventTimeline(e.events.length),h=0,_=0;_<e.events.length;_++){var $=e.events[_],tt=i.findEvent($.name);if(null==tt)throw new Error("Event not found: "+$.name);var et=new t.Event(t.Utils.toSinglePrecision(this.getValue($,"time",0)),tt);et.intValue=this.getValue($,"int",tt.intValue),et.floatValue=this.getValue($,"float",tt.floatValue),et.stringValue=this.getValue($,"string",tt.stringValue),null!=et.data.audioPath&&(et.volume=this.getValue($,"volume",1),et.balance=this.getValue($,"balance",0)),x.setFrame(h++,et)}o.push(x),a=Math.max(a,x.frames[x.getFrameCount()-1])}if(isNaN(a))throw new Error("Error while parsing animation, duration is NaN");i.animations.push(new t.Animation(n,o,a))},e.prototype.readCurve=function(t,e,n){var i=t.curve;i&&("stepped"==i?e.setStepped(n):"[object Array]"===Object.prototype.toString.call(i)?e.setCurve(n,i[0],i[1],i[2],i[3]):e.setCurve(n,i,this.getValue(t,"c2",0),this.getValue(t,"c3",1),this.getValue(t,"c4",1)))},e.prototype.getValue=function(t,e,n){return void 0!==t[e]?t[e]:n},e.blendModeFromString=function(e){if("normal"==(e=e.toLowerCase()))return t.BlendMode.Normal;if("additive"==e)return t.BlendMode.Additive;if("multiply"==e)return t.BlendMode.Multiply;if("screen"==e)return t.BlendMode.Screen;throw new Error("Unknown blend mode: "+e)},e.positionModeFromString=function(e){if("fixed"==(e=e.toLowerCase()))return t.PositionMode.Fixed;if("percent"==e)return t.PositionMode.Percent;throw new Error("Unknown position mode: "+e)},e.spacingModeFromString=function(e){if("length"==(e=e.toLowerCase()))return t.SpacingMode.Length;if("fixed"==e)return t.SpacingMode.Fixed;if("percent"==e)return t.SpacingMode.Percent;throw new Error("Unknown position mode: "+e)},e.rotateModeFromString=function(e){if("tangent"==(e=e.toLowerCase()))return t.RotateMode.Tangent;if("chain"==e)return t.RotateMode.Chain;if("chainscale"==e)return t.RotateMode.ChainScale;throw new Error("Unknown rotate mode: "+e)},e.transformModeFromString=function(e){if("normal"==(e=e.toLowerCase()))return t.TransformMode.Normal;if("onlytranslation"==e)return t.TransformMode.OnlyTranslation;if("norotationorreflection"==e)return t.TransformMode.NoRotationOrReflection;if("noscale"==e)return t.TransformMode.NoScale;if("noscaleorreflection"==e)return t.TransformMode.NoScaleOrReflection;throw new Error("Unknown transform mode: "+e)},e}();t.SkeletonJson=e;var n=function(t,e,n,i,r){this.mesh=t,this.skin=e,this.slotIndex=n,this.parent=i,this.inheritDeform=r}}(net||(net={})),function(t){var e=function(t,e,n){this.slotIndex=t,this.name=e,this.attachment=n};t.SkinEntry=e;var n=function(){function n(t){if(this.attachments=new Array,this.bones=Array(),this.constraints=new Array,null==t)throw new Error("name cannot be null.");this.name=t}return n.prototype.setAttachment=function(t,e,n){if(null==n)throw new Error("attachment cannot be null.");var i=this.attachments;t>=i.length&&(i.length=t+1),i[t]||(i[t]={}),i[t][e]=n},n.prototype.addSkin=function(t){for(var e=0;e<t.bones.length;e++){for(var n=t.bones[e],i=!1,r=0;r<this.bones.length;r++)if(this.bones[r]==n){i=!0;break}i||this.bones.push(n)}for(e=0;e<t.constraints.length;e++){var o=t.constraints[e];for(i=!1,r=0;r<this.constraints.length;r++)if(this.constraints[r]==o){i=!0;break}i||this.constraints.push(o)}var a=t.getAttachments();for(e=0;e<a.length;e++){var s=a[e];this.setAttachment(s.slotIndex,s.name,s.attachment)}},n.prototype.copySkin=function(e){for(var n=0;n<e.bones.length;n++){for(var i=e.bones[n],r=!1,o=0;o<this.bones.length;o++)if(this.bones[o]==i){r=!0;break}r||this.bones.push(i)}for(n=0;n<e.constraints.length;n++){var a=e.constraints[n];for(r=!1,o=0;o<this.constraints.length;o++)if(this.constraints[o]==a){r=!0;break}r||this.constraints.push(a)}var s=e.getAttachments();for(n=0;n<s.length;n++){var c=s[n];null!=c.attachment&&(c.attachment instanceof t.MeshAttachment?(c.attachment=c.attachment.newLinkedMesh(),this.setAttachment(c.slotIndex,c.name,c.attachment)):(c.attachment=c.attachment.copy(),this.setAttachment(c.slotIndex,c.name,c.attachment)))}},n.prototype.getAttachment=function(t,e){var n=this.attachments[t];return n?n[e]:null},n.prototype.removeAttachment=function(t,e){var n=this.attachments[t];n&&(n[e]=null)},n.prototype.getAttachments=function(){for(var t=new Array,n=0;n<this.attachments.length;n++){var i=this.attachments[n];if(i)for(var r in i){var o=i[r];o&&t.push(new e(n,r,o))}}return t},n.prototype.getAttachmentsForSlot=function(t,n){var i=this.attachments[t];if(i)for(var r in i){var o=i[r];o&&n.push(new e(t,r,o))}},n.prototype.clear=function(){this.attachments.length=0,this.bones.length=0,this.constraints.length=0},n.prototype.attachAll=function(t,e){for(var n=0,i=0;i<t.slots.length;i++){var r=t.slots[i],o=r.getAttachment();if(o&&n<e.attachments.length){var a=e.attachments[n];for(var s in a)if(o==a[s]){var c=this.getAttachment(n,s);null!=c&&r.setAttachment(c);break}}n++}},n}();t.Skin=n}(net||(net={})),function(t){var e=function(){function e(e,n){if(this.deform=new Array,null==e)throw new Error("data cannot be null.");if(null==n)throw new Error("bone cannot be null.");this.data=e,this.bone=n,this.color=new t.Color,this.darkColor=null==e.darkColor?null:new t.Color,this.setToSetupPose()}return e.prototype.getSkeleton=function(){return this.bone.skeleton},e.prototype.getAttachment=function(){return this.attachment},e.prototype.setAttachment=function(t){this.attachment!=t&&(this.attachment=t,this.attachmentTime=this.bone.skeleton.time,this.deform.length=0)},e.prototype.setAttachmentTime=function(t){this.attachmentTime=this.bone.skeleton.time-t},e.prototype.getAttachmentTime=function(){return this.bone.skeleton.time-this.attachmentTime},e.prototype.setToSetupPose=function(){this.color.setFromColor(this.data.color),null!=this.darkColor&&this.darkColor.setFromColor(this.data.darkColor),null==this.data.attachmentName?this.attachment=null:(this.attachment=null,this.setAttachment(this.bone.skeleton.getAttachment(this.data.index,this.data.attachmentName)))},e}();t.Slot=e}(net||(net={})),function(t){t.SlotData=function(e,n,i){if(this.color=new t.Color(1,1,1,1),e<0)throw new Error("index must be >= 0.");if(null==n)throw new Error("name cannot be null.");if(null==i)throw new Error("boneData cannot be null.");this.index=e,this.name=n,this.boneData=i}}(net||(net={})),function(t){var e,n,i=function(){function t(t){this._image=t}return t.prototype.getImage=function(){return this._image},t.filterFromString=function(t){switch(t.toLowerCase()){case"nearest":return e.Nearest;case"linear":return e.Linear;case"mipmap":return e.MipMap;case"mipmapnearestnearest":return e.MipMapNearestNearest;case"mipmaplinearnearest":return e.MipMapLinearNearest;case"mipmapnearestlinear":return e.MipMapNearestLinear;case"mipmaplinearlinear":return e.MipMapLinearLinear;default:throw new Error("Unknown texture filter "+t)}},t.wrapFromString=function(t){switch(t.toLowerCase()){case"mirroredtepeat":return n.MirroredRepeat;case"clamptoedge":return n.ClampToEdge;case"repeat":return n.Repeat;default:throw new Error("Unknown texture wrap "+t)}},t}();t.Texture=i,function(t){t[t.Nearest=9728]="Nearest",t[t.Linear=9729]="Linear",t[t.MipMap=9987]="MipMap",t[t.MipMapNearestNearest=9984]="MipMapNearestNearest",t[t.MipMapLinearNearest=9985]="MipMapLinearNearest",t[t.MipMapNearestLinear=9986]="MipMapNearestLinear",t[t.MipMapLinearLinear=9987]="MipMapLinearLinear"}(e=t.TextureFilter||(t.TextureFilter={})),function(t){t[t.MirroredRepeat=33648]="MirroredRepeat",t[t.ClampToEdge=33071]="ClampToEdge",t[t.Repeat=10497]="Repeat"}(n=t.TextureWrap||(t.TextureWrap={}));t.TextureRegion=function(){this.u=0,this.v=0,this.u2=0,this.v2=0,this.width=0,this.height=0,this.rotate=!1,this.offsetX=0,this.offsetY=0,this.originalWidth=0,this.originalHeight=0};var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iet(e,t),e.prototype.setFilters=function(){},e.prototype.setWraps=function(){},e.prototype.dispose=function(){},e}(i);t.FakeTexture=r}(net||(net={})),function(t){var e=function(){function e(t,e){this.pages=new Array,this.regions=new Array,this.load(t,e)}return e.prototype.load=function(e,o){if(null==o)throw new Error("textureLoader cannot be null.");for(var a=new n(e),s=new Array(4),c=null;;){var l=a.readLine();if(null==l)break;if(0==(l=l.trim()).length)c=null;else if(c){var u=new r;u.name=l,u.page=c;var h=a.readValue();"true"==h.toLocaleLowerCase()?u.degrees=90:"false"==h.toLocaleLowerCase()?u.degrees=0:u.degrees=parseFloat(h),u.rotate=90==u.degrees,a.readTuple(s);var _=parseInt(s[0]),f=parseInt(s[1]);a.readTuple(s);var d=parseInt(s[0]),p=parseInt(s[1]);u.u=_/c.width,u.v=f/c.height,u.rotate?(u.u2=(_+p)/c.width,u.v2=(f+d)/c.height):(u.u2=(_+d)/c.width,u.v2=(f+p)/c.height),u.x=_,u.y=f,u.width=Math.abs(d),u.height=Math.abs(p),4==a.readTuple(s)&&4==a.readTuple(s)&&a.readTuple(s),u.originalWidth=parseInt(s[0]),u.originalHeight=parseInt(s[1]),a.readTuple(s),u.offsetX=parseInt(s[0]),u.offsetY=parseInt(s[1]),u.index=parseInt(a.readValue()),u.texture=c.texture,this.regions.push(u)}else{(c=new i).name=l,2==a.readTuple(s)&&(c.width=parseInt(s[0]),c.height=parseInt(s[1]),a.readTuple(s)),a.readTuple(s),c.minFilter=t.Texture.filterFromString(s[0]),c.magFilter=t.Texture.filterFromString(s[1]);var m=a.readValue();c.uWrap=t.TextureWrap.ClampToEdge,c.vWrap=t.TextureWrap.ClampToEdge,"x"==m?c.uWrap=t.TextureWrap.Repeat:"y"==m?c.vWrap=t.TextureWrap.Repeat:"xy"==m&&(c.uWrap=c.vWrap=t.TextureWrap.Repeat),c.texture=o(l),c.texture.setFilters(c.minFilter,c.magFilter),c.texture.setWraps(c.uWrap,c.vWrap),c.width=c.texture.getImage().width,c.height=c.texture.getImage().height,this.pages.push(c)}}},e.prototype.findRegion=function(t){for(var e=0;e<this.regions.length;e++)if(this.regions[e].name==t)return this.regions[e];return null},e.prototype.dispose=function(){for(var t=0;t<this.pages.length;t++)this.pages[t].texture.dispose()},e}();t.TextureAtlas=e;var n=function(){function t(t){this.index=0,this.lines=t.split(/\r\n|\r|\n/)}return t.prototype.readLine=function(){return this.index>=this.lines.length?null:this.lines[this.index++]},t.prototype.readValue=function(){var t=this.readLine(),e=t.indexOf(":");if(-1==e)throw new Error("Invalid line: "+t);return t.substring(e+1).trim()},t.prototype.readTuple=function(t){var e=this.readLine(),n=e.indexOf(":");if(-1==n)throw new Error("Invalid line: "+e);for(var i=0,r=n+1;i<3;i++){var o=e.indexOf(",",r);if(-1==o)break;t[i]=e.substr(r,o-r).trim(),r=o+1}return t[i]=e.substring(r).trim(),i+1},t}(),i=function(){};t.TextureAtlasPage=i;var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iet(e,t),e}(t.TextureRegion);t.TextureAtlasRegion=r}(net||(net={})),function(t){var e=function(){function e(e,n){if(this.rotateMix=0,this.translateMix=0,this.scaleMix=0,this.shearMix=0,this.temp=new t.Vector2,this.active=!1,null==e)throw new Error("data cannot be null.");if(null==n)throw new Error("skeleton cannot be null.");this.data=e,this.rotateMix=e.rotateMix,this.translateMix=e.translateMix,this.scaleMix=e.scaleMix,this.shearMix=e.shearMix,this.bones=new Array;for(var i=0;i<e.bones.length;i++)this.bones.push(n.findBone(e.bones[i].name));this.target=n.findBone(e.target.name)}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){this.data.local?this.data.relative?this.applyRelativeLocal():this.applyAbsoluteLocal():this.data.relative?this.applyRelativeWorld():this.applyAbsoluteWorld()},e.prototype.applyAbsoluteWorld=function(){for(var e=this.rotateMix,n=this.translateMix,i=this.scaleMix,r=this.shearMix,o=this.target,a=o.a,s=o.b,c=o.c,l=o.d,u=a*l-s*c>0?t.MathUtils.degRad:-t.MathUtils.degRad,h=this.data.offsetRotation*u,_=this.data.offsetShearY*u,f=this.bones,d=0,p=f.length;d<p;d++){var m=f[d],v=!1;if(0!=e){var g=m.a,y=m.b,x=m.c,S=m.d;(w=Math.atan2(c,a)-Math.atan2(x,g)+h)>t.MathUtils.PI?w-=t.MathUtils.PI2:w<-t.MathUtils.PI&&(w+=t.MathUtils.PI2),w*=e;var A=Math.cos(w),C=Math.sin(w);m.a=A*g-C*x,m.b=A*y-C*S,m.c=C*g+A*x,m.d=C*y+A*S,v=!0}if(0!=n){var b=this.temp;o.localToWorld(b.set(this.data.offsetX,this.data.offsetY)),m.worldX+=(b.x-m.worldX)*n,m.worldY+=(b.y-m.worldY)*n,v=!0}if(i>0){var T=Math.sqrt(m.a*m.a+m.c*m.c),E=Math.sqrt(a*a+c*c);T>1e-5&&(T=(T+(E-T+this.data.offsetScaleX)*i)/T),m.a*=T,m.c*=T,T=Math.sqrt(m.b*m.b+m.d*m.d),E=Math.sqrt(s*s+l*l),T>1e-5&&(T=(T+(E-T+this.data.offsetScaleY)*i)/T),m.b*=T,m.d*=T,v=!0}if(r>0){y=m.b,S=m.d;var w,P=Math.atan2(S,y);(w=Math.atan2(l,s)-Math.atan2(c,a)-(P-Math.atan2(m.c,m.a)))>t.MathUtils.PI?w-=t.MathUtils.PI2:w<-t.MathUtils.PI&&(w+=t.MathUtils.PI2),w=P+(w+_)*r,T=Math.sqrt(y*y+S*S),m.b=Math.cos(w)*T,m.d=Math.sin(w)*T,v=!0}v&&(m.appliedValid=!1)}},e.prototype.applyRelativeWorld=function(){for(var e=this.rotateMix,n=this.translateMix,i=this.scaleMix,r=this.shearMix,o=this.target,a=o.a,s=o.b,c=o.c,l=o.d,u=a*l-s*c>0?t.MathUtils.degRad:-t.MathUtils.degRad,h=this.data.offsetRotation*u,_=this.data.offsetShearY*u,f=this.bones,d=0,p=f.length;d<p;d++){var m,v=f[d],g=!1;if(0!=e){var y=v.a,x=v.b,S=v.c,A=v.d;(m=Math.atan2(c,a)+h)>t.MathUtils.PI?m-=t.MathUtils.PI2:m<-t.MathUtils.PI&&(m+=t.MathUtils.PI2),m*=e;var C=Math.cos(m),b=Math.sin(m);v.a=C*y-b*S,v.b=C*x-b*A,v.c=b*y+C*S,v.d=b*x+C*A,g=!0}if(0!=n){var T=this.temp;o.localToWorld(T.set(this.data.offsetX,this.data.offsetY)),v.worldX+=T.x*n,v.worldY+=T.y*n,g=!0}if(i>0){var E=(Math.sqrt(a*a+c*c)-1+this.data.offsetScaleX)*i+1;v.a*=E,v.c*=E,E=(Math.sqrt(s*s+l*l)-1+this.data.offsetScaleY)*i+1,v.b*=E,v.d*=E,g=!0}if(r>0)(m=Math.atan2(l,s)-Math.atan2(c,a))>t.MathUtils.PI?m-=t.MathUtils.PI2:m<-t.MathUtils.PI&&(m+=t.MathUtils.PI2),x=v.b,A=v.d,m=Math.atan2(A,x)+(m-t.MathUtils.PI/2+_)*r,E=Math.sqrt(x*x+A*A),v.b=Math.cos(m)*E,v.d=Math.sin(m)*E,g=!0;g&&(v.appliedValid=!1)}},e.prototype.applyAbsoluteLocal=function(){var t=this.rotateMix,e=this.translateMix,n=this.scaleMix,i=this.shearMix,r=this.target;r.appliedValid||r.updateAppliedTransform();for(var o=this.bones,a=0,s=o.length;a<s;a++){var c=o[a];c.appliedValid||c.updateAppliedTransform();var l=c.arotation;if(0!=t){var u=r.arotation-l+this.data.offsetRotation;l+=(u-=360*(16384-(16384.499999999996-u/360|0)))*t}var h=c.ax,_=c.ay;0!=e&&(h+=(r.ax-h+this.data.offsetX)*e,_+=(r.ay-_+this.data.offsetY)*e);var f=c.ascaleX,d=c.ascaleY;0!=n&&(f>1e-5&&(f=(f+(r.ascaleX-f+this.data.offsetScaleX)*n)/f),d>1e-5&&(d=(d+(r.ascaleY-d+this.data.offsetScaleY)*n)/d));var p=c.ashearY;0!=i&&(u=r.ashearY-p+this.data.offsetShearY,u-=360*(16384-(16384.499999999996-u/360|0)),c.shearY+=u*i),c.updateWorldTransformWith(h,_,l,f,d,c.ashearX,p)}},e.prototype.applyRelativeLocal=function(){var t=this.rotateMix,e=this.translateMix,n=this.scaleMix,i=this.shearMix,r=this.target;r.appliedValid||r.updateAppliedTransform();for(var o=this.bones,a=0,s=o.length;a<s;a++){var c=o[a];c.appliedValid||c.updateAppliedTransform();var l=c.arotation;0!=t&&(l+=(r.arotation+this.data.offsetRotation)*t);var u=c.ax,h=c.ay;0!=e&&(u+=(r.ax+this.data.offsetX)*e,h+=(r.ay+this.data.offsetY)*e);var _=c.ascaleX,f=c.ascaleY;0!=n&&(_>1e-5&&(_*=(r.ascaleX-1+this.data.offsetScaleX)*n+1),f>1e-5&&(f*=(r.ascaleY-1+this.data.offsetScaleY)*n+1));var d=c.ashearY;0!=i&&(d+=(r.ashearY+this.data.offsetShearY)*i),c.updateWorldTransformWith(u,h,l,_,f,c.ashearX,d)}},e}();t.TransformConstraint=e}(net||(net={})),function(t){var e=function(t){function e(e){var n=t.call(this,e,0,!1)||this;return n.bones=new Array,n.rotateMix=0,n.translateMix=0,n.scaleMix=0,n.shearMix=0,n.offsetRotation=0,n.offsetX=0,n.offsetY=0,n.offsetScaleX=0,n.offsetScaleY=0,n.offsetShearY=0,n.relative=!1,n.local=!1,n}return iet(e,t),e}(t.ConstraintData);t.TransformConstraintData=e}(net||(net={})),function(t){var e=function(){function e(){this.convexPolygons=new Array,this.convexPolygonsIndices=new Array,this.indicesArray=new Array,this.isConcaveArray=new Array,this.triangles=new Array,this.polygonPool=new t.Pool((function(){return new Array})),this.polygonIndicesPool=new t.Pool((function(){return new Array}))}return e.prototype.triangulate=function(t){var n=t,i=t.length>>1,r=this.indicesArray;r.length=0;for(var o=0;o<i;o++)r[o]=o;var a=this.isConcaveArray;a.length=0,o=0;for(var s=i;o<s;++o)a[o]=e.isConcave(o,i,n,r);var c=this.triangles;for(c.length=0;i>3;){for(var l=i-1,u=(o=0,1);;){t:if(!a[o]){for(var h=r[l]<<1,_=r[o]<<1,f=r[u]<<1,d=n[h],p=n[h+1],m=n[_],v=n[_+1],g=n[f],y=n[f+1],x=(u+1)%i;x!=l;x=(x+1)%i)if(a[x]){var S=r[x]<<1,A=n[S],C=n[S+1];if(e.positiveArea(g,y,d,p,A,C)&&e.positiveArea(d,p,m,v,A,C)&&e.positiveArea(m,v,g,y,A,C))break t}break}if(0==u){do{if(!a[o])break;o--}while(o>0);break}l=o,o=u,u=(u+1)%i}c.push(r[(i+o-1)%i]),c.push(r[o]),c.push(r[(o+1)%i]),r.splice(o,1),a.splice(o,1);var b=(--i+o-1)%i,T=o==i?0:o;a[b]=e.isConcave(b,i,n,r),a[T]=e.isConcave(T,i,n,r)}return 3==i&&(c.push(r[2]),c.push(r[0]),c.push(r[1])),c},e.prototype.decompose=function(t,n){var i=t,r=this.convexPolygons;this.polygonPool.freeAll(r),r.length=0;var o=this.convexPolygonsIndices;this.polygonIndicesPool.freeAll(o),o.length=0;var a=this.polygonIndicesPool.obtain();a.length=0;var s=this.polygonPool.obtain();s.length=0;for(var c=-1,l=0,u=0,h=n.length;u<h;u+=3){var _=n[u]<<1,f=n[u+1]<<1,d=n[u+2]<<1,p=i[_],m=i[_+1],v=i[f],g=i[f+1],y=i[d],x=i[d+1],S=!1;if(c==_){var A=s.length-4,C=e.winding(s[A],s[A+1],s[A+2],s[A+3],y,x),b=e.winding(y,x,s[0],s[1],s[2],s[3]);C==l&&b==l&&(s.push(y),s.push(x),a.push(d),S=!0)}S||(s.length>0?(r.push(s),o.push(a)):(this.polygonPool.free(s),this.polygonIndicesPool.free(a)),(s=this.polygonPool.obtain()).length=0,s.push(p),s.push(m),s.push(v),s.push(g),s.push(y),s.push(x),(a=this.polygonIndicesPool.obtain()).length=0,a.push(_),a.push(f),a.push(d),l=e.winding(p,m,v,g,y,x),c=_)}for(s.length>0&&(r.push(s),o.push(a)),u=0,h=r.length;u<h;u++)if(0!=(a=o[u]).length)for(var T=a[0],E=a[a.length-1],w=(s=r[u])[A=s.length-4],P=s[A+1],I=s[A+2],R=s[A+3],D=s[0],M=s[1],B=s[2],O=s[3],N=e.winding(w,P,I,R,D,M),L=0;L<h;L++)if(L!=u){var F=o[L];if(3==F.length){var z=F[0],V=F[1],k=F[2],G=r[L];y=G[G.length-2],x=G[G.length-1],z==T&&V==E&&(C=e.winding(w,P,I,R,y,x),b=e.winding(y,x,D,M,B,O),C==N&&b==N&&(G.length=0,F.length=0,s.push(y),s.push(x),a.push(k),w=I,P=R,I=y,R=x,L=0))}}for(u=r.length-1;u>=0;u--)0==(s=r[u]).length&&(r.splice(u,1),this.polygonPool.free(s),a=o[u],o.splice(u,1),this.polygonIndicesPool.free(a));return r},e.isConcave=function(t,e,n,i){var r=i[(e+t-1)%e]<<1,o=i[t]<<1,a=i[(t+1)%e]<<1;return!this.positiveArea(n[r],n[r+1],n[o],n[o+1],n[a],n[a+1])},e.positiveArea=function(t,e,n,i,r,o){return t*(o-i)+n*(e-o)+r*(i-e)>=0},e.winding=function(t,e,n,i,r,o){var a=n-t,s=i-e;return r*s-o*a+a*e-t*s>=0?1:-1},e}();t.Triangulator=e}(net||(net={})),function(t){var e=function(){function t(){this.array=new Array}return t.prototype.add=function(t){var e=this.contains(t);return this.array[0|t]=0|t,!e},t.prototype.contains=function(t){return null!=this.array[0|t]},t.prototype.remove=function(t){this.array[0|t]=void 0},t.prototype.clear=function(){this.array.length=0},t}();t.IntSet=e;var n=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.r=t,this.g=e,this.b=n,this.a=i}return t.prototype.set=function(t,e,n,i){return this.r=t,this.g=e,this.b=n,this.a=i,this.clamp(),this},t.prototype.setFromColor=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},t.prototype.setFromString=function(t){return t="#"==t.charAt(0)?t.substr(1):t,this.r=parseInt(t.substr(0,2),16)/255,this.g=parseInt(t.substr(2,2),16)/255,this.b=parseInt(t.substr(4,2),16)/255,this.a=(8!=t.length?255:parseInt(t.substr(6,2),16))/255,this},t.prototype.add=function(t,e,n,i){return this.r+=t,this.g+=e,this.b+=n,this.a+=i,this.clamp(),this},t.prototype.clamp=function(){return this.r<0?this.r=0:this.r>1&&(this.r=1),this.g<0?this.g=0:this.g>1&&(this.g=1),this.b<0?this.b=0:this.b>1&&(this.b=1),this.a<0?this.a=0:this.a>1&&(this.a=1),this},t.rgba8888ToColor=function(t,e){t.r=((4278190080&e)>>>24)/255,t.g=((16711680&e)>>>16)/255,t.b=((65280&e)>>>8)/255,t.a=(255&e)/255},t.rgb888ToColor=function(t,e){t.r=((16711680&e)>>>16)/255,t.g=((65280&e)>>>8)/255,t.b=(255&e)/255},t.WHITE=new t(1,1,1,1),t.RED=new t(1,0,0,1),t.GREEN=new t(0,1,0,1),t.BLUE=new t(0,0,1,1),t.MAGENTA=new t(1,0,1,1),t}();t.Color=n;var i=function(){function t(){}return t.clamp=function(t,e,n){return t<e?e:t>n?n:t},t.cosDeg=function(e){return Math.cos(e*t.degRad)},t.sinDeg=function(e){return Math.sin(e*t.degRad)},t.signum=function(t){return t>0?1:t<0?-1:0},t.toInt=function(t){return t>0?Math.floor(t):Math.ceil(t)},t.cbrt=function(t){var e=Math.pow(Math.abs(t),1/3);return t<0?-e:e},t.randomTriangular=function(e,n){return t.randomTriangularWith(e,n,.5*(e+n))},t.randomTriangularWith=function(t,e,n){var i=Math.random(),r=e-t;return i<=(n-t)/r?t+Math.sqrt(i*r*(n-t)):e-Math.sqrt((1-i)*r*(e-n))},t.PI=3.1415927,t.PI2=2*t.PI,t.radiansToDegrees=180/t.PI,t.radDeg=t.radiansToDegrees,t.degreesToRadians=t.PI/180,t.degRad=t.degreesToRadians,t}();t.MathUtils=i;var r=function(){function t(){}return t.prototype.apply=function(t,e,n){return t+(e-t)*this.applyInternal(n)},t}();t.Interpolation=r;var o=function(t){function e(e){var n=t.call(this)||this;return n.power=2,n.power=e,n}return iet(e,t),e.prototype.applyInternal=function(t){return t<=.5?Math.pow(2*t,this.power)/2:Math.pow(2*(t-1),this.power)/(this.power%2==0?-2:2)+1},e}(r);t.Pow=o;var a=function(t){function e(e){return t.call(this,e)||this}return iet(e,t),e.prototype.applyInternal=function(t){return Math.pow(t-1,this.power)*(this.power%2==0?-1:1)+1},e}(o);t.PowOut=a;var s=function(){function t(){}return t.arrayCopy=function(t,e,n,i,r){for(var o=e,a=i;o<e+r;o++,a++)n[a]=t[o]},t.setArraySize=function(t,e,n){void 0===n&&(n=0);var i=t.length;if(i==e)return t;if(t.length=e,i<e)for(var r=i;r<e;r++)t[r]=n;return t},t.ensureArrayCapacity=function(e,n,i){return void 0===i&&(i=0),e.length>=n?e:t.setArraySize(e,n,i)},t.newArray=function(t,e){for(var n=new Array(t),i=0;i<t;i++)n[i]=e;return n},t.newFloatArray=function(e){if(t.SUPPORTS_TYPED_ARRAYS)return new Float32Array(e);for(var n=new Array(e),i=0;i<n.length;i++)n[i]=0;return n},t.newShortArray=function(e){if(t.SUPPORTS_TYPED_ARRAYS)return new Int16Array(e);for(var n=new Array(e),i=0;i<n.length;i++)n[i]=0;return n},t.toFloatArray=function(e){return t.SUPPORTS_TYPED_ARRAYS?new Float32Array(e):e},t.toSinglePrecision=function(e){return t.SUPPORTS_TYPED_ARRAYS?Math.fround(e):e},t.webkit602BugfixHelper=function(){},t.contains=function(t,e){for(var n=0;n<t.length;n++)if(t[n]==e)return!0;return!1},t.SUPPORTS_TYPED_ARRAYS="undefined"!=typeof Float32Array,t}();t.Utils=s;var c=function(){function t(){}return t.logBones=function(t){for(var e=0;e<t.bones.length;e++){var n=t.bones[e];console.log(n.data.name+", "+n.a+", "+n.b+", "+n.c+", "+n.d+", "+n.worldX+", "+n.worldY)}},t}();t.DebugUtils=c;var l=function(){function t(t){this.items=new Array,this.instantiator=t}return t.prototype.obtain=function(){return this.items.length>0?this.items.pop():this.instantiator()},t.prototype.free=function(t){t.reset&&t.reset(),this.items.push(t)},t.prototype.freeAll=function(t){for(var e=0;e<t.length;e++)t[e].reset&&t[e].reset(),this.items[e]=t[e]},t.prototype.clear=function(){this.items.length=0},t}();t.Pool=l;var u=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.set=function(t,e){return this.x=t,this.y=e,this},t.prototype.length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},t.prototype.normalize=function(){var t=this.length();return 0!=t&&(this.x/=t,this.y/=t),this},t}();t.Vector2=u;var h=function(){function t(){this.maxDelta=.064,this.framesPerSecond=0,this.delta=0,this.totalTime=0,this.lastTime=Date.now()/1e3,this.frameCount=0,this.frameTime=0}return t.prototype.update=function(){var t=Date.now()/1e3;this.delta=t-this.lastTime,this.frameTime+=this.delta,this.totalTime+=this.delta,this.delta>this.maxDelta&&(this.delta=this.maxDelta),this.lastTime=t,this.frameCount++,this.frameTime>1&&(this.framesPerSecond=this.frameCount/this.frameTime,this.frameTime=0,this.frameCount=0)},t}();t.TimeKeeper=h;var _=function(){function t(t){void 0===t&&(t=32),this.addedValues=0,this.lastValue=0,this.mean=0,this.dirty=!0,this.values=new Array(t)}return t.prototype.hasEnoughData=function(){return this.addedValues>=this.values.length},t.prototype.addValue=function(t){this.addedValues<this.values.length&&this.addedValues++,this.values[this.lastValue++]=t,this.lastValue>this.values.length-1&&(this.lastValue=0),this.dirty=!0},t.prototype.getMean=function(){if(this.hasEnoughData()){if(this.dirty){for(var t=0,e=0;e<this.values.length;e++)t+=this.values[e];this.mean=t/this.values.length,this.dirty=!1}return this.mean}return 0},t}();t.WindowedMean=_}(net||(net={})),Math.fround||(Math.fround=function(t){return function(e){return t[0]=e,t[0]}}(new Float32Array(1))),function(t){var e=function(t){if(null==t)throw new Error("name cannot be null.");this.name=t};t.Attachment=e;var n=function(e){function n(t){var i=e.call(this,t)||this;return i.id=(65535&n.nextID++)<<11,i.worldVerticesLength=0,i.deformAttachment=i,i}return iet(n,e),n.prototype.computeWorldVertices=function(t,e,n,i,r,o){n=r+(n>>1)*o;var a=t.bone.skeleton,s=t.deform,c=this.vertices,l=this.bones;if(null!=l){for(var u=0,h=0,_=0;_<e;_+=2)u+=(m=l[u])+1,h+=m;var f=a.bones;if(0==s.length)for(P=r,b=3*h;P<n;P+=o){var d=0,p=0,m=l[u++];for(m+=u;u<m;u++,b+=3){x=f[l[u]],I=c[b],R=c[b+1];var v=c[b+2];d+=(I*x.a+R*x.b+x.worldX)*v,p+=(I*x.c+R*x.d+x.worldY)*v}i[P]=d,i[P+1]=p}else for(var g=s,y=(P=r,b=3*h,h<<1);P<n;P+=o){for(d=0,p=0,m=l[u++],m+=u;u<m;u++,b+=3,y+=2)x=f[l[u]],I=c[b]+g[y],R=c[b+1]+g[y+1],v=c[b+2],d+=(I*x.a+R*x.b+x.worldX)*v,p+=(I*x.c+R*x.d+x.worldY)*v;i[P]=d,i[P+1]=p}}else{s.length>0&&(c=s);for(var x,S=(x=t.bone).worldX,A=x.worldY,C=x.a,b=x.b,T=x.c,E=x.d,w=e,P=r;P<n;w+=2,P+=o){var I=c[w],R=c[w+1];i[P]=I*C+R*b+S,i[P+1]=I*T+R*E+A}}},n.prototype.copyTo=function(e){null!=this.bones?(e.bones=new Array(this.bones.length),t.Utils.arrayCopy(this.bones,0,e.bones,0,this.bones.length)):e.bones=null,null!=this.vertices?(e.vertices=t.Utils.newFloatArray(this.vertices.length),t.Utils.arrayCopy(this.vertices,0,e.vertices,0,this.vertices.length)):e.vertices=null,e.worldVerticesLength=this.worldVerticesLength,e.deformAttachment=this.deformAttachment},n.nextID=0,n}(e);t.VertexAttachment=n}(net||(net={})),function(t){var e;(e=t.AttachmentType||(t.AttachmentType={}))[e.Region=0]="Region",e[e.BoundingBox=1]="BoundingBox",e[e.Mesh=2]="Mesh",e[e.LinkedMesh=3]="LinkedMesh",e[e.Path=4]="Path",e[e.Point=5]="Point",e[e.Clipping=6]="Clipping"}(net||(net={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.color=new t.Color(1,1,1,1),i}return iet(n,e),n.prototype.copy=function(){var t=new n(name);return this.copyTo(t),t.color.setFromColor(this.color),t},n}(t.VertexAttachment);t.BoundingBoxAttachment=e}(net||(net={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.color=new t.Color(.2275,.2275,.8078,1),i}return iet(n,e),n.prototype.copy=function(){var t=new n(name);return this.copyTo(t),t.endSlot=this.endSlot,t.color.setFromColor(this.color),t},n}(t.VertexAttachment);t.ClippingAttachment=e}(net||(net={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.color=new t.Color(1,1,1,1),i.tempColor=new t.Color(0,0,0,0),i}return iet(n,e),n.prototype.updateUVs=function(){var e=this.regionUVs;null!=this.uvs&&this.uvs.length==e.length||(this.uvs=t.Utils.newFloatArray(e.length));var n=this.uvs,i=this.uvs.length,r=this.region.u,o=this.region.v,a=0,s=0;if(this.region instanceof t.TextureAtlasRegion){var c=this.region,l=c.texture.getImage().width,u=c.texture.getImage().height;switch(c.degrees){case 90:r-=(c.originalHeight-c.offsetY-c.height)/l,o-=(c.originalWidth-c.offsetX-c.width)/u,a=c.originalHeight/l,s=c.originalWidth/u;for(var h=0;h<i;h+=2)n[h]=r+e[h+1]*a,n[h+1]=o+(1-e[h])*s;return;case 180:for(r-=(c.originalWidth-c.offsetX-c.width)/l,o-=c.offsetY/u,a=c.originalWidth/l,s=c.originalHeight/u,h=0;h<i;h+=2)n[h]=r+(1-e[h])*a,n[h+1]=o+(1-e[h+1])*s;return;case 270:for(r-=c.offsetY/l,o-=c.offsetX/u,a=c.originalHeight/l,s=c.originalWidth/u,h=0;h<i;h+=2)n[h]=r+(1-e[h+1])*a,n[h+1]=o+e[h]*s;return}r-=c.offsetX/l,o-=(c.originalHeight-c.offsetY-c.height)/u,a=c.originalWidth/l,s=c.originalHeight/u}else null==this.region?(r=o=0,a=s=1):(a=this.region.u2-r,s=this.region.v2-o);for(h=0;h<i;h+=2)n[h]=r+e[h]*a,n[h+1]=o+e[h+1]*s},n.prototype.getParentMesh=function(){return this.parentMesh},n.prototype.setParentMesh=function(t){this.parentMesh=t,null!=t&&(this.bones=t.bones,this.vertices=t.vertices,this.worldVerticesLength=t.worldVerticesLength,this.regionUVs=t.regionUVs,this.triangles=t.triangles,this.hullLength=t.hullLength,this.worldVerticesLength=t.worldVerticesLength)},n.prototype.copy=function(){if(null!=this.parentMesh)return this.newLinkedMesh();var e=new n(this.name);return e.region=this.region,e.path=this.path,e.color.setFromColor(this.color),this.copyTo(e),e.regionUVs=new Array(this.regionUVs.length),t.Utils.arrayCopy(this.regionUVs,0,e.regionUVs,0,this.regionUVs.length),e.uvs=new Array(this.uvs.length),t.Utils.arrayCopy(this.uvs,0,e.uvs,0,this.uvs.length),e.triangles=new Array(this.triangles.length),t.Utils.arrayCopy(this.triangles,0,e.triangles,0,this.triangles.length),e.hullLength=this.hullLength,null!=this.edges&&(e.edges=new Array(this.edges.length),t.Utils.arrayCopy(this.edges,0,e.edges,0,this.edges.length)),e.width=this.width,e.height=this.height,e},n.prototype.newLinkedMesh=function(){var t=new n(this.name);return t.region=this.region,t.path=this.path,t.color.setFromColor(this.color),t.deformAttachment=this.deformAttachment,t.setParentMesh(null!=this.parentMesh?this.parentMesh:this),t.updateUVs(),t},n}(t.VertexAttachment);t.MeshAttachment=e}(net||(net={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.closed=!1,i.constantSpeed=!1,i.color=new t.Color(1,1,1,1),i}return iet(n,e),n.prototype.copy=function(){var e=new n(name);return this.copyTo(e),e.lengths=new Array(this.lengths.length),t.Utils.arrayCopy(this.lengths,0,e.lengths,0,this.lengths.length),e.closed=closed,e.constantSpeed=this.constantSpeed,e.color.setFromColor(this.color),e},n}(t.VertexAttachment);t.PathAttachment=e}(net||(net={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.color=new t.Color(.38,.94,0,1),i}return iet(n,e),n.prototype.computeWorldPosition=function(t,e){return e.x=this.x*t.a+this.y*t.b+t.worldX,e.y=this.x*t.c+this.y*t.d+t.worldY,e},n.prototype.computeWorldRotation=function(e){var n=t.MathUtils.cosDeg(this.rotation),i=t.MathUtils.sinDeg(this.rotation),r=n*e.a+i*e.b,o=n*e.c+i*e.d;return Math.atan2(o,r)*t.MathUtils.radDeg},n.prototype.copy=function(){var t=new n(name);return t.x=this.x,t.y=this.y,t.rotation=this.rotation,t.color.setFromColor(this.color),t},n}(t.VertexAttachment);t.PointAttachment=e}(net||(net={})),function(t){var e=function(e){function n(n){var i=e.call(this,n)||this;return i.x=0,i.y=0,i.scaleX=1,i.scaleY=1,i.rotation=0,i.width=0,i.height=0,i.color=new t.Color(1,1,1,1),i.offset=t.Utils.newFloatArray(8),i.uvs=t.Utils.newFloatArray(8),i.tempColor=new t.Color(1,1,1,1),i}return iet(n,e),n.prototype.updateOffset=function(){var t=this.width/this.region.originalWidth*this.scaleX,e=this.height/this.region.originalHeight*this.scaleY,i=-this.width/2*this.scaleX+this.region.offsetX*t,r=-this.height/2*this.scaleY+this.region.offsetY*e,o=i+this.region.width*t,a=r+this.region.height*e,s=this.rotation*Math.PI/180,c=Math.cos(s),l=Math.sin(s),u=i*c+this.x,h=i*l,_=r*c+this.y,f=r*l,d=o*c+this.x,p=o*l,m=a*c+this.y,v=a*l,g=this.offset;g[n.OX1]=u-f,g[n.OY1]=_+h,g[n.OX2]=u-v,g[n.OY2]=m+h,g[n.OX3]=d-v,g[n.OY3]=m+p,g[n.OX4]=d-f,g[n.OY4]=_+p},n.prototype.setRegion=function(t){this.region=t;var e=this.uvs;t.rotate?(e[2]=t.u,e[3]=t.v2,e[4]=t.u,e[5]=t.v,e[6]=t.u2,e[7]=t.v,e[0]=t.u2,e[1]=t.v2):(e[0]=t.u,e[1]=t.v2,e[2]=t.u,e[3]=t.v,e[4]=t.u2,e[5]=t.v,e[6]=t.u2,e[7]=t.v2)},n.prototype.computeWorldVertices=function(t,e,i,r){var o=this.offset,a=t.worldX,s=t.worldY,c=t.a,l=t.b,u=t.c,h=t.d,_=0,f=0;_=o[n.OX1],f=o[n.OY1],e[i]=_*c+f*l+a,e[i+1]=_*u+f*h+s,i+=r,_=o[n.OX2],f=o[n.OY2],e[i]=_*c+f*l+a,e[i+1]=_*u+f*h+s,i+=r,_=o[n.OX3],f=o[n.OY3],e[i]=_*c+f*l+a,e[i+1]=_*u+f*h+s,i+=r,_=o[n.OX4],f=o[n.OY4],e[i]=_*c+f*l+a,e[i+1]=_*u+f*h+s},n.prototype.copy=function(){var e=new n(name);return e.region=this.region,e.rendererObject=this.rendererObject,e.path=this.path,e.x=this.x,e.y=this.y,e.scaleX=this.scaleX,e.scaleY=this.scaleY,e.rotation=this.rotation,e.width=this.width,e.height=this.height,t.Utils.arrayCopy(this.uvs,0,e.uvs,0,8),t.Utils.arrayCopy(this.offset,0,e.offset,0,8),e.color.setFromColor(this.color),e},n.OX1=0,n.OY1=1,n.OX2=2,n.OY2=3,n.OX3=4,n.OY3=5,n.OX4=6,n.OY4=7,n.X1=0,n.Y1=1,n.C1R=2,n.C1G=3,n.C1B=4,n.C1A=5,n.U1=6,n.V1=7,n.X2=8,n.Y2=9,n.C2R=10,n.C2G=11,n.C2B=12,n.C2A=13,n.U2=14,n.V2=15,n.X3=16,n.Y3=17,n.C3R=18,n.C3G=19,n.C3B=20,n.C3A=21,n.U3=22,n.V3=23,n.X4=24,n.Y4=25,n.C4R=26,n.C4G=27,n.C4B=28,n.C4A=29,n.U4=30,n.V4=31,n}(t.Attachment);t.RegionAttachment=e}(net||(net={})),function(t){var e=function(){function e(t,e){this.jitterX=0,this.jitterY=0,this.jitterX=t,this.jitterY=e}return e.prototype.begin=function(){},e.prototype.transform=function(e){e.x+=t.MathUtils.randomTriangular(-this.jitterX,this.jitterY),e.y+=t.MathUtils.randomTriangular(-this.jitterX,this.jitterY)},e.prototype.end=function(){},e}();t.JitterEffect=e}(net||(net={})),function(t){var e=function(){function e(t,e){this.centerX=0,this.centerY=0,this.radius=0,this.angle=0,this.worldX=0,this.worldY=0,this.radius=t,this.interpolation=e}return e.prototype.begin=function(t){this.worldX=t.x+this.centerX,this.worldY=t.y+this.centerY},e.prototype.transform=function(e){var n=this.angle*t.MathUtils.degreesToRadians,i=e.x-this.worldX,r=e.y-this.worldY,o=Math.sqrt(i*i+r*r);if(o<this.radius){var a=this.interpolation.apply(0,n,(this.radius-o)/this.radius),s=Math.cos(a),c=Math.sin(a);e.x=s*i-c*r+this.worldX,e.y=c*i+s*r+this.worldY}},e.prototype.end=function(){},e.interpolation=new t.PowOut(2),e}();t.SwirlEffect=e}(net||(net={}));var ret,oet,aet,set,cet,uet,het=net,_et=function(){function t(){this.start=void 0,this.interrupt=void 0,this.end=void 0,this.dispose=void 0,this.complete=void 0,this.event=void 0}return t.getListeners=function(e){return e.listener||(e.listener=new t),e.listener},t}(),fet=1/60,det=[],pet=[],met=0,vet=0,get=0,yet=null,xet=null,Aet=0,Cet=0,bet=0,Tet=0,Eet=null,wet=null,Pet=0,Iet=0,Ret=new het.Color(1,1,1,1),Det=new het.Color(1,1,1,1),Met=[0,1,2,2,3,0],Bet=function(){function t(){this.frames=[],this.totalTime=0,this.isCompleted=!1,this.maxVertexCount=0,this.maxIndexCount=0,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this._frameIdx=-1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this._frameIdx=-1,this.isCompleted=!1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}var e=t.prototype;return e.init=function(t,e){this._inited=!0,this._animationName=e,this._skeletonInfo=t},e.clear=function(){this._inited=!1;for(var t=0,e=this.frames.length;t<e;t++)this.frames[t].segments.length=0;this.invalidAllFrame()},e.bind=function(t){var e=this;t.complete=function(t){t&&t.animation.name===e._animationName&&(e.isCompleted=!0)}},e.unbind=function(t){t.complete=null},e.begin=function(){if(this._invalid){var t=this._skeletonInfo,e=null==t?void 0:t.curAnimationCache;e&&e!==this&&(this._privateMode?e.invalidAllFrame():e.updateToFrame());var n=null==t?void 0:t.skeleton,i=null==t?void 0:t.listener,r=null==t?void 0:t.state,o=null==n?void 0:n.data.findAnimation(this._animationName);null==r||r.setAnimationWith(0,o,!1),this.bind(i),t.curAnimationCache=this,this._frameIdx=-1,this.isCompleted=!1,this.totalTime=0,this._invalid=!1}},e.end=function(){this.needToUpdate()||(this._skeletonInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0,this.unbind(this._skeletonInfo.listener))},e.updateToFrame=function(t){if(this._inited&&(this.begin(),this.needToUpdate(t))){var e=this._skeletonInfo,n=null==e?void 0:e.skeleton,i=null==e?void 0:e.clipper,r=null==e?void 0:e.state;do{null==n||n.update(fet),null==r||r.update(fet),null==r||r.apply(n),null==n||n.updateWorldTransform(),this._frameIdx++,this.updateFrame(n,i,this._frameIdx),this.totalTime+=fet}while(this.needToUpdate(t));this.end()}},e.isInited=function(){return this._inited},e.isInvalid=function(){return this._invalid},e.invalidAllFrame=function(){this.isCompleted=!1,this._invalid=!0},e.updateAllFrame=function(){this.invalidAllFrame(),this.updateToFrame()},e.enableCacheAttachedInfo=function(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())},e.fillVertices=function(t,e,n,i,r){if(set=n.a*e.a*t.a*255,ret=e.r*t.r*255,oet=e.g*t.g*255,aet=e.b*t.b*255,Ret.r=ret*n.r,Ret.g=oet*n.g,Ret.b=aet*n.b,Ret.a=set,null==r.darkColor?Det.set(0,0,0,1):(Det.r=r.darkColor.r*ret,Det.g=r.darkColor.g*oet,Det.b=r.darkColor.b*aet),Det.a=0,cet=(Ret.a<<24>>>0)+(Ret.b<<16)+(Ret.g<<8)+Ret.r,uet=(Det.a<<24>>>0)+(Det.b<<16)+(Det.g<<8)+Det.r,Eet!==cet||wet!==uet){var o=this._tempColors;Eet=cet,wet=uet,Tet>0&&(o[Tet-1].vfOffset=get),o[Tet++]={fr:Ret.r,fg:Ret.g,fb:Ret.b,fa:Ret.a,dr:Det.r,dg:Det.g,db:Det.b,da:Det.a,vfOffset:0}}if(i.isClipping()){i.clipTriangles(det,Pet,pet,Iet,det,Ret,Det,!0,6,get,get+2);var a=i.clippedVertices,s=i.clippedTriangles;Iet=s.length,Pet=a.length/12*6;for(var c=0,l=vet,u=s.length;c<u;)pet[l++]=s[c++];for(var h=0,_=a.length,f=get;h<_;h+=12,f+=6)det[f]=a[h],det[f+1]=a[h+1],det[f+2]=a[h+6],det[f+3]=a[h+7],det[f+4]=cet,det[f+5]=uet}else for(var d=get,p=get+Pet;d<p;d+=6)det[d+4]=cet,det[d+5]=uet},e.updateFrame=function(t,e,n){get=0,met=0,vet=0,yet=null,xet=null,Aet=0,Cet=0,bet=0,Tet=0,Eet=null,wet=null,this.frames[n]=this.frames[n]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};var i=this.frames[n],r=this._tempSegments=i.segments,o=this._tempColors=i.colors,a=this._tempBoneInfos=i.boneInfos;this.traverseSkeleton(t,e),Tet>0&&(o[Tet-1].vfOffset=get),o.length=Tet,a.length=met;var s=bet-1;if(s>=0)if(Cet>0){var c=r[s];c.indexCount=Cet,c.vfCount=13*Aet,c.vertexCount=Aet,r.length=bet}else r.length=bet-1;if(0!==r.length){var l=i.vertices,u=get/6,h=13*u;(!l||l.length<h)&&(l=i.vertices=new Float32Array(h));for(var _=0,f=0;_<h;)l[_]=det[f++],l[_+1]=det[f++],l[_+3]=det[f++],l[_+4]=det[f++],this._setVerticeColor(det[f++],l,_+5),this._setVerticeColor(det[f++],l,_+9),_+=13;var d=i.indices;(!d||d.length<vet)&&(d=i.indices=new Uint16Array(vet));for(var p=0;p<vet;p++)d[p]=pet[p];i.vertices=l,i.indices=d,this.maxVertexCount=u>this.maxVertexCount?u:this.maxVertexCount,this.maxIndexCount=d.length>this.maxIndexCount?d.length:this.maxIndexCount}},e.needToUpdate=function(t){return!this.isCompleted&&this.totalTime<30&&(void 0===t||this._frameIdx<t)},e.traverseSkeleton=function(t,e){var n,i,r,o,a,s,c,l,u,h,_,f,d=this._tempSegments,p=this._tempBoneInfos,m=t.color,v=t.bones;if(this._enableCacheAttachedInfo)for(var g=0,y=v.length;g<y;g++,met++){var x=v[g],S=p[met];S||(S=p[met]={}),S.a=x.a,S.b=x.b,S.c=x.c,S.d=x.d,S.worldX=x.worldX,S.worldY=x.worldY}for(var A=0,C=t.drawOrder.length;A<C;A++)if(f=t.drawOrder[A],Pet=0,Iet=0,n=f.getAttachment())if(s=n instanceof het.RegionAttachment,c=n instanceof het.MeshAttachment,n instanceof het.ClippingAttachment)e.clipStart(f,n);else if(s||c)if(l=n.region.texture.getRealTexture()){if(_=f.data.blendMode,yet===l.getId()&&xet===_||(yet=l.getId(),xet=_,(u=bet-1)>=0&&(Cet>0?((h=d[u]).indexCount=Cet,h.vertexCount=Aet,h.vfCount=13*Aet):bet--),d[bet]={tex:l,blendMode:_,indexCount:0,vertexCount:0,vfCount:0},bet++,Cet=0,Aet=0),s)a=Met,Pet=24,Iet=6,n.computeWorldVertices(f.bone,det,get,6);else if(c){var b=n;a=b.triangles,Pet=6*(b.worldVerticesLength>>1),Iet=a.length,b.computeWorldVertices(f,0,b.worldVerticesLength,det,get,6)}if(0!==Pet&&0!==Iet){for(var T=0,E=vet,w=a.length;T<w;)pet[E++]=a[T++];o=n.uvs;for(var P=get,I=get+Pet,R=0;P<I;P+=6,R+=2)det[P+2]=o[R],det[P+3]=o[R+1];if(i=n.color,r=f.color,this.fillVertices(m,i,r,e,f),Iet>0){for(var D=vet,M=vet+Iet;D<M;D++)pet[D]+=Aet;vet+=Iet,get+=Pet,Cet+=Iet,Aet+=Pet/6}e.clipEndWithSlot(f)}else e.clipEndWithSlot(f)}else e.clipEndWithSlot(f);else e.clipEndWithSlot(f);else e.clipEndWithSlot(f);e.clipEnd()},e._setVerticeColor=function(t,e,n){e[n]=(255&t)/255,e[n+1]=(t>>8&255)/255,e[n+2]=(t>>16&255)/255,e[n+3]=(t>>24&255)/255},t}(),Oet=function(){function t(){this._privateMode=void 0,this._skeletonCache=void 0,this._animationPool=void 0,this._privateMode=!1,this._animationPool={},this._skeletonCache={}}var e=t.prototype;return e.enablePrivateMode=function(){this._privateMode=!0},e.clear=function(){this._animationPool={},this._skeletonCache={}},e.removeSkeleton=function(t){var e=this._skeletonCache[t];if(e){var n=e.animationsCache;for(var i in n){var r=n[i];r&&(this._animationPool[t+"#"+i]=r,r.clear())}delete this._skeletonCache[t]}},e.getSkeletonCache=function(t,e){var n=this._skeletonCache[t];if(!n){var i=new het.Skeleton(e),r=new het.SkeletonClipping,o=new het.AnimationStateData(i.data),a=new het.AnimationState(o),s=new _et;a.addListener(s),this._skeletonCache[t]=n={skeleton:i,clipper:r,state:a,listener:s,animationsCache:{},curAnimationCache:null}}return n},e.getAnimationCache=function(t,e){var n=this._skeletonCache[t];return n?n.animationsCache[e]:null},e.invalidAnimationCache=function(t){var e=this._skeletonCache[t];if(e&&e.skeleton){var n=e.animationsCache;for(var i in n)n[i].invalidAllFrame()}},e.initAnimationCache=function(t,e){if(!e)return null;var n=this._skeletonCache[t],i=n&&n.skeleton;if(!i)return null;if(!i.data.findAnimation(e))return null;var r=n.animationsCache,o=r[e];if(!o){var a=t+"#"+e;(o=this._animationPool[a])?delete this._animationPool[a]:(o=new Bet)._privateMode=this._privateMode,o.init(n,e),r[e]=o}return o},e.updateAnimationCache=function(t,e){if(e){var n=this.initAnimationCache(t,e);if(!n)return;n.updateAllFrame()}else{var i=this._skeletonCache[t];if(!i||!i.skeleton)return;var r=i.animationsCache;for(var o in r)r[o].updateAllFrame()}},t}();Oet.FrameTime=fet,Oet.sharedCache=new Oet;var Net,Let,Fet,zet,Vet,ket,Get,Uet,Het,jet,Wet,qet=new Hn,Xet=new Pn,Yet=function(){function t(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null,this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null}var e=t.prototype;return e.init=function(t){this._inited=!0,this._skeleton=t._skeleton,this._skeletonNode=t.node,this._skeletonComp=t},e.reset=function(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null},e._syncAttachedNode=function(){if(this._inited){var t=this._skeletonComp.socketNodes;if(0!==t.size){var e;if(e=this._skeletonComp.isAnimationCached()?this._skeletonComp._curFrame&&this._skeletonComp._curFrame.boneInfos:this._skeleton.bones)for(var n,i=function(t,e){Xet.set(t.scale);var n=qet;n.m00=e.a,n.m01=e.c,n.m04=e.b,n.m05=e.d,n.m12=e.worldX,n.m13=e.worldY,t.matrix=qet,t.scale=Xet},r=ot(t.keys());!(n=r()).done;){var o=n.value,a=t.get(o);if(a&&a.isValid){var s=e[o];s?i(a,s):(a.removeFromParent(),a.destroy(),t.delete(o))}else t.delete(o)}}}},t}(),Ket=function(t){function e(e){var n;return(n=t.call(this,e)||this).name="sp.SkeletonTexture",n._texture=null,n._material=null,n}Q(e,t);var n=e.prototype;return n.setRealTexture=function(t){this._texture=t},n.getRealTexture=function(){return this._texture},n.setFilters=function(t,e){this._texture&&this.getRealTexture().setFilters(Jet(t),Jet(e))},n.setWraps=function(t,e){this._texture&&this.getRealTexture().setWrapMode(Qet(t),Qet(e))},n.dispose=function(){},e}(het.Texture);function Jet(t){switch(t){case het.TextureFilter.Nearest:case het.TextureFilter.MipMapNearestNearest:case het.TextureFilter.MipMapLinearNearest:return Im.NEAREST;case het.TextureFilter.MipMap:case het.TextureFilter.MipMapNearestLinear:case het.TextureFilter.MipMapLinearLinear:case het.TextureFilter.Linear:default:return Im.LINEAR}}function Qet(t){switch(t){case het.TextureWrap.MirroredRepeat:return Pm.MIRRORED_REPEAT;case het.TextureWrap.ClampToEdge:return Pm.CLAMP_TO_EDGE;case het.TextureWrap.Repeat:default:return Pm.REPEAT}}var Zet=(Net=fc("sp.SkeletonData"),Let=Xc([yv]),Fet=Xc([Ne]),Net((Wet=function(t){function e(){var e;return at(e=t.call(this)||this,"_skeletonJson",ket,it(e)),at(e,"textures",Get,it(e)),at(e,"textureNames",Uet,it(e)),at(e,"scale",Het,it(e)),at(e,"_atlasText",jet,it(e)),e._buffer=void 0,e._skeletonCache=null,e._atlasCache=null,e._skinsEnum=null,e._animsEnum=null,e.reset(),e}Q(e,t);var n=e.prototype;return n.createNode=function(t){var e=new kT(this.name);return e.addComponent("cc.Skeleton").skeletonData=this,t(null,e)},n.reset=function(){this._skeletonCache=null,this._atlasCache=null},n.resetEnums=function(){},n.getRuntimeData=function(t){if(this._skeletonCache)return this._skeletonCache;if(!(this.textures&&this.textures.length>0)&&this.textureNames&&this.textureNames.length>0)return t||console.error(this.name+" no textures found!"),null;var e=this._getAtlas(t);if(!e)return null;var n=new het.AtlasAttachmentLoader(e),i=null,r=null;return this.skeletonJson?(r=new het.SkeletonJson(n),i=this.skeletonJson):(r=new het.SkeletonBinary(n),i=new Uint8Array(this._nativeAsset)),r.scale=this.scale,this._skeletonCache=r.readSkeletonData(i),e.dispose(),this._skeletonCache},n.getSkinsEnum=function(){if(this._skinsEnum)return this._skinsEnum;var t=this.getRuntimeData(!0);if(t){for(var e=t.skins,n={},i=0;i<e.length;i++)n[e[i].name]=i;return this._skinsEnum=oe(n)}return null},n.getAnimsEnum=function(){if(this._animsEnum&&Object.keys(this._animsEnum).length>1)return this._animsEnum;var t=this.getRuntimeData(!0);if(t){for(var e={"<None>":0},n=t.animations,i=0;i<n.length;i++)e[n[i].name]=i+1;return this._animsEnum=oe(e)}return null},n.destroy=function(){return Oet.sharedCache.removeSkeleton(this._uuid),t.prototype.destroy.call(this)},n._getTexture=function(t){for(var e=this.textureNames,n=0;n<e.length;n++)if(e[n]===t){var i=this.textures[n],r=new Ket({width:i.width,height:i.height});return r.setRealTexture(i),r}return console.error(this.name+" no textures found!"),null},n._getAtlas=function(t){return this._atlasCache?this._atlasCache:this.atlasText?this._atlasCache=new het.TextureAtlas(this.atlasText,this._getTexture.bind(this)):(t||console.error(this.name+" no atlas found!"),null)},K(e,[{key:"skeletonJsonStr",get:function(){return this._skeletonJson?JSON.stringify(this._skeletonJson):""}},{key:"skeletonJson",get:function(){return this._skeletonJson},set:function(t){this.reset(),this._skeletonJson="string"==typeof t?JSON.parse(t):t,!this._uuid&&t.skeleton&&(this._uuid=t.skeleton.hash)}},{key:"atlasText",get:function(){return this._atlasText},set:function(t){this._atlasText=t,this.reset()}},{key:"_nativeAsset",get:function(){return this._buffer},set:function(t){this._buffer=t,this.reset()}}]),e}(Ru),ket=st((Vet=Wet).prototype,"_skeletonJson",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Get=st(Vet.prototype,"textures",[yc,Let],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uet=st(Vet.prototype,"textureNames",[yc,Fet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Het=st(Vet.prototype,"scale",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jet=st(Vet.prototype,"_atlasText",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zet=Vet))||zet);c.internal.SpineSkeletonData=Zet;var $et,tnt,ent,nnt,int,rnt,ont,ant,snt,cnt,lnt,unt,hnt,_nt,fnt,dnt,pnt,mnt,vnt,gnt,ynt,xnt,Snt,Ant,Cnt,bnt,Tnt,Ent,wnt,Pnt,Int,Rnt,Dnt,Mnt,Bnt,Ont,Nnt,Lnt,Fnt,znt,Vnt,knt,Gnt,Unt,Hnt,jnt,Wnt,qnt,Xnt,Ynt,Knt,Jnt,Qnt,Znt,$nt,tit=function(t){function e(){var e;return(e=t.call(this)||this)._skeletons=new Set,e}Q(e,t),e.getInstance=function(){return e._instance||(e._instance=new e,zB.registerSystem(e.ID,e._instance,bB.Priority.HIGH)),e._instance};var n=e.prototype;return n.add=function(t){t&&(this._skeletons.has(t)||this._skeletons.add(t))},n.remove=function(t){t&&this._skeletons.has(t)&&this._skeletons.delete(t)},n.postUpdate=function(t){this._skeletons&&this._skeletons.forEach((function(e){e.updateAnimation(t)}))},e}(bB);function eit(t,e,n){Ze.Attr.setClassAttr(t,e,"type","Enum"),Ze.Attr.setClassAttr(t,e,"enumList",oe.getList(n))}tit.ID="SKELETON",tit._instance=void 0,function(t){t[t.default=0]="default"}(Jnt||(Jnt={})),ce(Jnt),function(t){t[t["<None>"]=0]="<None>"}(Qnt||(Qnt={})),ce(Qnt),function(t){t[t.REALTIME=0]="REALTIME",t[t.SHARED_CACHE=1]="SHARED_CACHE",t[t.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(Znt||(Znt={})),ce(Znt),function(t){t[t.COLORED_TEXTURED=0]="COLORED_TEXTURED",t[t.TWO_COLORED=1]="TWO_COLORED"}($nt||($nt={}));var nit=($et=fc("sp.Skeleton.SpineSocket"),tnt=Xc(kT),$et((int=st((nnt=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),at(this,"path",int,this),at(this,"target",rnt,this),this.path=t,this.target=e}).prototype,"path",[yc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rnt=st(nnt.prototype,"target",[tnt,Rc,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ent=nnt))||ent);ne.setClassAlias(nit,"sp.Skeleton.SpineSocket");var iit=(ont=fc("sp.Skeleton"),ant=Ic(),snt=Tc(),cnt=Xc(rg),lnt=kc(),unt=Bc(),hnt=Xc(Zet),_nt=Bc(),fnt=Xc(Jnt),dnt=Oc(),pnt=Bc(),mnt=Xc(Qnt),vnt=Oc(),gnt=Bc(),ynt=Oc(),xnt=Xc(Znt),Snt=Oc(),Ant=Oc(),Cnt=Oc(),bnt=Oc(),Tnt=Oc(),Ent=Oc(),wnt=Oc(),Pnt=Xc([nit]),Int=Oc(),Rnt=Dc(),Dnt=Dc(),ont(Mnt=ant(Mnt=snt(Mnt=bc((Knt=Ynt=function(t){function e(){var e;return at(e=t.call(this)||this,"loop",Ont,it(e)),e.enableBatch=!1,e._frameCache=null,e._curFrame=null,e._effectDelegate=null,e._skeleton=void 0,e._clipper=void 0,e._debugRenderer=void 0,e._startSlotIndex=void 0,e._endSlotIndex=void 0,e._startEntry=void 0,e._endEntry=void 0,e.attachUtil=void 0,e.maxVertexCount=0,e.maxIndexCount=0,e._materialCache={},e._enumSkins=oe({}),e._enumAnimations=oe({}),e._playTimes=0,at(e,"_timeScale",Nnt,it(e)),e._paused=!1,e._accTime=0,e._playCount=0,e._skeletonCache=null,e._animationName="",e._animationQueue=[],e._headAniInfo=null,e._isAniComplete=!0,at(e,"_useTint",Lnt,it(e)),at(e,"_preCacheMode",Fnt,it(e)),at(e,"_cacheMode",znt,it(e)),at(e,"_defaultCacheMode",Vnt,it(e)),at(e,"_debugBones",knt,it(e)),at(e,"_debugSlots",Gnt,it(e)),at(e,"_skeletonData",Unt,it(e)),at(e,"_premultipliedAlpha",Hnt,it(e)),at(e,"defaultSkin",jnt,it(e)),at(e,"defaultAnimation",Wnt,it(e)),at(e,"_sockets",qnt,it(e)),e._drawIdx=0,e._drawList=new Hl((function(){return{material:null,texture:null,indexOffset:0,indexCount:0}}),1),at(e,"_debugMesh",Xnt,it(e)),e._rootBone=void 0,e._state=void 0,e._listener=void 0,e._socketNodes=new Map,e._cachedSockets=new Map,e._effectDelegate=null,e._skeleton=null,e._rootBone=null,e._listener=null,e._debugRenderer=null,e._startSlotIndex=-1,e._endSlotIndex=-1,e._startEntry={animation:{name:""},trackIndex:0},e._endEntry={animation:{name:""},trackIndex:0},e.attachUtil=new Yet,eit(it(e),"_defaultSkinIndex",e._enumSkins),eit(it(e),"_animationIndex",e._enumAnimations),e}Q(e,t);var n=e.prototype;return n.setSkeletonData=function(t){var e=this.node._uiProps.uiTransformComp;if(null!=t.width&&null!=t.height&&e.setContentSize(t.width,t.height),this._cacheMode===Znt.SHARED_CACHE?this._skeletonCache=Oet.sharedCache:this._cacheMode===Znt.PRIVATE_CACHE&&(this._skeletonCache=new Oet,this._skeletonCache.enablePrivateMode()),this.isAnimationCached()){(this.debugBones||this.debugSlots)&&y("Debug bones or slots is invalid in cached mode");var n=this._skeletonCache.getSkeletonCache(this.skeletonData._uuid,t);this._skeleton=n.skeleton,this._clipper=n.clipper,this._rootBone=this._skeleton.getRootBone()}else this._skeleton=new het.Skeleton(t),this._clipper=new het.SkeletonClipping,this._rootBone=this._skeleton.getRootBone();this._flushAssembler()},n.setSlotsRange=function(t,e){this.isAnimationCached()?y("Slots visible range can not be modified in cached mode."):(this._startSlotIndex=t,this._endSlotIndex=e)},n.setAnimationStateData=function(t){if(this.isAnimationCached())y("'setAnimationStateData' interface can not be invoked in cached mode.");else{var e=new het.AnimationState(t);this._listener&&(this._state&&this._state.removeListener(this._listener),e.addListener(this._listener)),this._state=e}},n.__preload=function(){t.prototype.__preload.call(this);for(var e=this.node.children,n=0,i=e.length;n<i;n++){var r=e[n];r&&"DEBUG_DRAW_NODE"===r.name&&r.destroy()}this._updateSkeletonData(),this._updateDebugDraw(),this._updateUseTint(),this._indexBoneSockets(),this._updateSocketBindings()},n.setAnimationCacheMode=function(t){this._preCacheMode!==t&&(this._cacheMode=t,this._updateSkeletonData(),this._updateUseTint(),this._updateSocketBindings(),this.markForUpdateRenderData())},n.isAnimationCached=function(){return this._cacheMode!==Znt.REALTIME},n.updateAnimation=function(t){if(!this.paused)if(t*=1*this._timeScale,this.isAnimationCached()){if(this._isAniComplete){if(0===this._animationQueue.length&&!this._headAniInfo){var e=this._frameCache;if(e&&e.isInvalid()){e.updateToFrame();var n=e.frames;this._curFrame=n[n.length-1]}return}if(this._headAniInfo||(this._headAniInfo=this._animationQueue.shift()),this._accTime+=t,this._accTime>this._headAniInfo.delay){var i=this._headAniInfo;this._headAniInfo=null,this.setAnimation(0,i.animationName,i.loop)}return}this._updateCache(t)}else this._updateRealtime(t)},n.setVertexEffectDelegate=function(t){this._effectDelegate=t},n.setToSetupPose=function(){this._skeleton&&this._skeleton.setToSetupPose()},n.setBonesToSetupPose=function(){this._skeleton&&this._skeleton.setBonesToSetupPose()},n.setSlotsToSetupPose=function(){this._skeleton&&this._skeleton.setSlotsToSetupPose()},n.updateAnimationCache=function(t){if(this.isAnimationCached()){var e=this._skeletonData._uuid;this._skeletonCache&&this._skeletonCache.updateAnimationCache(e,t)}},n.invalidAnimationCache=function(){this.isAnimationCached()&&this._skeletonCache&&this._skeletonCache.invalidAnimationCache(this._skeletonData._uuid)},n.findBone=function(t){return this._skeleton?this._skeleton.findBone(t):null},n.findSlot=function(t){return this._skeleton?this._skeleton.findSlot(t):null},n.setSkin=function(t){this._skeleton&&(this._skeleton.setSkinByName(t),this._skeleton.setSlotsToSetupPose()),this.invalidAnimationCache()},n.getAttachment=function(t,e){return this._skeleton?this._skeleton.getAttachmentByName(t,e):null},n.setAttachment=function(t,e){this._skeleton&&this._skeleton.setAttachment(t,e),this.invalidAnimationCache()},n.getTextureAtlas=function(t){return t.region},n.setMix=function(t,e,n){this._state&&this._state.data.setMix(t,e,n)},n.setAnimation=function(t,e,n){if(this._playTimes=n?0:1,this._animationName=e,this.isAnimationCached()){if(0!==t&&y("Track index can not greater than 0 in cached mode."),!this._skeletonCache)return null;var i=this._skeletonCache.getAnimationCache(this._skeletonData._uuid,e);i||(i=this._skeletonCache.initAnimationCache(this._skeletonData._uuid,e)),i&&(this._isAniComplete=!1,this._accTime=0,this._playCount=0,this._frameCache=i,this._socketNodes.size>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._curFrame=this._frameCache.frames[0])}else if(this._skeleton){var r=this._skeleton.data.findAnimation(e);if(!r)return w(7509,e),null;var o=this._state.setAnimationWith(t,r,n);return this._state.apply(this._skeleton),o}return null},n.addAnimation=function(t,e,n,i){if(i=i||0,this.isAnimationCached())0!==t&&y("Track index can not greater than 0 in cached mode."),this._animationQueue.push({animationName:e,loop:n,delay:i});else if(this._skeleton){var r,o=this._skeleton.data.findAnimation(e);return o?null===(r=this._state)||void 0===r?void 0:r.addAnimationWith(t,o,n,i):(w(7510,e),null)}return null},n.findAnimation=function(t){return this._skeleton?this._skeleton.data.findAnimation(t):null},n.getCurrent=function(t){if(this.isAnimationCached())y("'getCurrent' interface can not be invoked in cached mode.");else if(this._state)return this._state.getCurrent(t);return null},n.clearTracks=function(){this.isAnimationCached()?y("'clearTracks' interface can not be invoked in cached mode."):this._state&&(this._state.clearTracks(),this.setToSetupPose())},n.clearTrack=function(t){this.isAnimationCached()?y("'clearTrack' interface can not be invoked in cached mode."):this._state&&this._state.clearTrack(t)},n.setStartListener=function(t){this._ensureListener(),this._listener.start=t},n.setInterruptListener=function(t){this._ensureListener(),this._listener.interrupt=t},n.setEndListener=function(t){this._ensureListener(),this._listener.end=t},n.setDisposeListener=function(t){this._ensureListener(),this._listener.dispose=t},n.setCompleteListener=function(t){this._ensureListener(),this._listener.complete=t},n.setEventListener=function(t){this._ensureListener(),this._listener.event=t},n.setTrackStartListener=function(t,e){_et.getListeners(t).start=e},n.setTrackInterruptListener=function(t,e){_et.getListeners(t).interrupt=e},n.setTrackEndListener=function(t,e){_et.getListeners(t).end=e},n.setTrackDisposeListener=function(t,e){_et.getListeners(t).dispose=e},n.setTrackCompleteListener=function(t,e){_et.getListeners(t).complete=function(t){var n=Math.floor(t.trackTime/t.animationEnd);e(t,n)}},n.setTrackEventListener=function(t,e){_et.getListeners(t).event=e},n.getState=function(){return this._state},n.onEnable=function(){t.prototype.onEnable.call(this),this._flushAssembler(),tit.getInstance().add(this)},n.onDisable=function(){t.prototype.onDisable.call(this),tit.getInstance().remove(this)},n.onDestroy=function(){this._cleanMaterialCache(),this._drawList.destroy(),t.prototype.onDestroy.call(this)},n.destroyRenderData=function(){this._drawList.reset(),t.prototype.destroyRenderData.call(this)},n.getMaterialForBlendAndTint=function(t,e,n){var i=n+"/"+t+"/"+e,r=this._materialCache[i];if(r)return r;var o=this.customMaterial;null===o&&(o=Pv.get("default-spine-material"));var a=!1;switch(n){case $nt.TWO_COLORED:a=!0;break;case $nt.COLORED_TEXTURED:}return r=new _A({parent:o,subModelIdx:0,owner:this}),this._materialCache[i]=r,r.overridePipelineStates({blendState:{blendColor:En.WHITE,targets:[{blendEq:Ii.ADD,blendAlphaEq:Ii.ADD,blendSrc:t,blendDst:e,blendSrcAlpha:t,blendDstAlpha:e}]}}),r.recompileShaders({TWO_COLORED:a,USE_LOCAL:!0}),r},n.onRestore=function(){this.updateMaterial(),this._renderFlag=this._canRender(),this.markForUpdateRenderData()},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);var t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._updateBlendFunc(),this._blendHash=-1},n.querySockets=function(){return this._skeleton?(0===this._cachedSockets.size&&this._indexBoneSockets(),this._cachedSockets.size>0?Array.from(this._cachedSockets.keys()).sort():[]):[]},n._requestDrawData=function(t,e,n,i){var r=this._drawList.add();return r.material=t,r.texture=e,r.indexOffset=n,r.indexCount=i,r},n._render=function(t){if(this._renderData&&this._drawList){var e=this._renderData,n=e.chunk,i=n.vertexAccessor,r=e.getMeshBuffer(),o=r.indexOffset;i.appendIndices(n.bufferId,e.indices);for(var a=0;a<this._drawList.length;a++){this._drawIdx=a;var s=this._drawList.data[a];if(s.texture){var c=r.requireFreeIA(t.device);c.firstIndex=o+s.indexOffset,c.indexCount=s.indexCount,t.commitIA(this,c,s.texture,s.material,this.node)}}}},n.updateWorldTransform=function(){this.isAnimationCached()&&this._skeleton&&this._skeleton.updateWorldTransform()},n._emitCacheCompleteEvent=function(){this._listener&&(this._endEntry.animation.name=this._animationName,this._listener.complete&&this._listener.complete(this._endEntry),this._listener.end&&this._listener.end(this._endEntry))},n._updateCache=function(t){var e=this._frameCache;if(e.isInited()){var n=e.frames,i=Oet.FrameTime;0===this._accTime&&0===this._playCount&&(this._startEntry.animation.name=this._animationName,this._listener&&this._listener.start&&this._listener.start(this._startEntry)),this._accTime+=t;var r=Math.floor(this._accTime/i);if(e.isCompleted||(e.updateToFrame(r),this._renderData&&(this._renderData.vertexCount<e.maxVertexCount||this._renderData.indexCount<e.maxIndexCount)&&(this.maxVertexCount=e.maxVertexCount>this.maxVertexCount?e.maxVertexCount:this.maxVertexCount,this.maxIndexCount=e.maxIndexCount>this.maxIndexCount?e.maxIndexCount:this.maxIndexCount,this._renderData.resize(this.maxVertexCount,this.maxIndexCount),(!this._renderData.indices||this.maxIndexCount>this._renderData.indices.length)&&(this._renderData.indices=new Uint16Array(this.maxIndexCount)))),e.isCompleted&&r>=n.length){if(this._playCount++,this._playTimes>0&&this._playCount>=this._playTimes)return this._curFrame=n[n.length-1],this._accTime=0,this._playCount=0,this._isAniComplete=!0,this._emitCacheCompleteEvent(),void this.markForUpdateRenderData();this._accTime=0,r=0,this._emitCacheCompleteEvent()}this._curFrame=n[r],this.markForUpdateRenderData()}},n._updateRealtime=function(t){var e=this._skeleton,n=this._state;e&&(e.update(t),n&&(n.update(t),n.apply(e)),this.markForUpdateRenderData())},n._indexBoneSockets=function(){if(this._skeleton){this._cachedSockets.clear();for(var t=this._skeleton.bones,e=function e(n){return null==n.parent?n.data.name||"<Unamed>":e(t[n.parent.data.index])+"/"+n.data.name},n=0,i=t.length;n<i;n++){var r=t[n].data,o=e(t[n]);this._cachedSockets.set(o,r.index)}}},n._updateUseTint=function(){this._cleanMaterialCache(),this.destroyRenderData(),this._assembler&&this._skeleton&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},n._updateBatch=function(){this.markForUpdateRenderData()},n._updateAnimEnum=function(){var t;t=this.skeletonData?this.skeletonData.getAnimsEnum():Qnt,this._enumAnimations=oe({}),Object.assign(this._enumAnimations,t),oe.update(this._enumAnimations),eit(this,"_animationIndex",this._enumAnimations)},n._updateSkinEnum=function(){var t;t=this.skeletonData?this.skeletonData.getSkinsEnum():Jnt,this._enumSkins=oe({}),Object.assign(this._enumSkins,t),oe.update(this._enumSkins),eit(this,"_defaultSkinIndex",this._enumSkins)},n._ensureListener=function(){this._listener||(this._listener=new _et,this._state&&this._state.addListener(this._listener))},n._updateSkeletonData=function(){if(this.skeletonData){var t=this.skeletonData.getRuntimeData();if(t){try{this.setSkeletonData(t),this.isAnimationCached()||this.setAnimationStateData(new het.AnimationStateData(this._skeleton.data)),this.defaultSkin&&this.setSkin(this.defaultSkin)}catch(t){y(t)}this._indexBoneSockets(),this.attachUtil.init(this),this._preCacheMode=this._cacheMode,this.animation=this.defaultAnimation}}},n._refreshInspector=function(){this._updateAnimEnum(),this._updateSkinEnum()},n._updateDebugDraw=function(){if(this.debugBones||this.debugSlots||this.debugMesh){if(!this._debugRenderer){var t=new kT("DEBUG_DRAW_NODE");t.hideFlags|=_l.Flags.DontSave|_l.Flags.HideInHierarchy;var e=t.addComponent(wJ);e.lineWidth=1,e.strokeColor=new En(255,0,0,255),this._debugRenderer=e,t.parent=this.node}this.isAnimationCached()&&y("Debug bones or slots is invalid in cached mode")}else this._debugRenderer&&(this._debugRenderer.node.destroy(),this._debugRenderer=null)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t),this._skeleton&&this._assembler&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData(),this._updateColor())},n._updateSocketBindings=function(){if(this._skeleton){this._socketNodes.clear();for(var t=0,e=this._sockets.length;t<e;t++){var n=this._sockets[t];if(n.path&&n.target){var i=this._cachedSockets.get(n.path);if(!i){console.error("Skeleton data does not contain path "+n.path);continue}this._socketNodes.set(i,n.target)}}}},n._verifySockets=function(t){for(var e=0,n=t.length;e<n;e++){var i=t[e].target;!i||i.parent&&i.parent===this.node||console.error("Target node "+i.name+" is expected to be a direct child of "+this.node.name)}var r=new Map;t.forEach((function(t){t.target&&(r.get(t.target)?console.error("Target node "+t.target.name+" has existed."):r.set(t.target,!0))}))},n._cleanMaterialCache=function(){for(var t in this._materialCache)this._materialCache[t].destroy();this._materialCache={}},K(e,[{key:"drawList",get:function(){return this._drawList}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(t){this._customMaterial=t,this._cleanMaterialCache()}},{key:"paused",get:function(){return this._paused},set:function(t){this._paused=t}},{key:"skeletonData",get:function(){return this._skeletonData},set:function(t){t&&t.resetEnums(),this._skeletonData!==t&&(this._skeletonData=t,this.defaultSkin="",this.defaultAnimation="",this._updateSkeletonData())}},{key:"animation",get:function(){if(this.isAnimationCached())return this._animationName;var t=this.getCurrent(0);return t&&t.animation.name||""},set:function(t){t?(this.setAnimation(0,t,this.loop),this.markForUpdateRenderData()):this.isAnimationCached()||(this.clearTrack(0),this.setToSetupPose())}},{key:"_defaultSkinIndex",get:function(){if(this.skeletonData){var t=this.skeletonData.getSkinsEnum();if(t)if(""===this.defaultSkin){if(t.hasOwnProperty(0))return this._defaultSkinIndex=0,0}else{var e=t[this.defaultSkin];if(void 0!==e)return e}}return 0},set:function(t){var e;if(this.skeletonData&&(e=this.skeletonData.getSkinsEnum()),e){var n=e[t];void 0!==n?(this.defaultSkin=n,this.setSkin(this.defaultSkin)):console.error(this.name+" skin enums are invalid")}else console.error(this.name+" skin enums are invalid")}},{key:"_animationIndex",get:function(){var t=this.animation;if(this.skeletonData)if(t){var e=this.skeletonData.getAnimsEnum();if(e){var n=e[t];if(void 0!==n)return n}}else this._refreshInspector();return 0},set:function(t){var e;if(this.skeletonData&&(e=this.skeletonData.getAnimsEnum()),e){var n=e[t];void 0!==n?(this.animation=n,this.animation=n):console.error(this.name+" animation enums are invalid")}else console.error(this.name+" animation enums are invalid")}},{key:"defaultCacheMode",get:function(){return this._defaultCacheMode},set:function(t){this._defaultCacheMode=t,this.setAnimationCacheMode(this._defaultCacheMode)}},{key:"premultipliedAlpha",get:function(){return this._premultipliedAlpha},set:function(t){t!==this._premultipliedAlpha&&(this._premultipliedAlpha=t,this.markForUpdateRenderData())}},{key:"timeScale",get:function(){return this._timeScale},set:function(t){t!==this._timeScale&&(this._timeScale=t)}},{key:"debugSlots",get:function(){return this._debugSlots},set:function(t){t!==this._debugSlots&&(this._debugSlots=t,this._updateDebugDraw(),this.markForUpdateRenderData())}},{key:"debugBones",get:function(){return this._debugBones},set:function(t){t!==this._debugBones&&(this._debugBones=t,this._updateDebugDraw(),this.markForUpdateRenderData())}},{key:"debugMesh",get:function(){return this._debugMesh},set:function(t){t!==this._debugMesh&&(this._debugMesh=t,this._updateDebugDraw(),this.markForUpdateRenderData())}},{key:"useTint",get:function(){return this._useTint},set:function(t){t!==this._useTint&&(this._useTint=t,this._updateUseTint())}},{key:"sockets",get:function(){return this._sockets},set:function(t){this._sockets=t,this._updateSocketBindings(),this.attachUtil._syncAttachedNode()}},{key:"socketNodes",get:function(){return this._socketNodes}}]),e}(rK),Ynt.SpineSocket=nit,Ynt.AnimationCacheMode=Znt,st((Bnt=Knt).prototype,"customMaterial",[il,cnt,lnt,unt],Object.getOwnPropertyDescriptor(Bnt.prototype,"customMaterial"),Bnt.prototype),st(Bnt.prototype,"skeletonData",[Rc,hnt],Object.getOwnPropertyDescriptor(Bnt.prototype,"skeletonData"),Bnt.prototype),st(Bnt.prototype,"_defaultSkinIndex",[_nt,fnt,dnt],Object.getOwnPropertyDescriptor(Bnt.prototype,"_defaultSkinIndex"),Bnt.prototype),st(Bnt.prototype,"_animationIndex",[pnt,mnt,vnt],Object.getOwnPropertyDescriptor(Bnt.prototype,"_animationIndex"),Bnt.prototype),st(Bnt.prototype,"defaultCacheMode",[gnt,ynt,Rc,xnt],Object.getOwnPropertyDescriptor(Bnt.prototype,"defaultCacheMode"),Bnt.prototype),Ont=st(Bnt.prototype,"loop",[yc,Snt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),st(Bnt.prototype,"premultipliedAlpha",[Rc,Ant],Object.getOwnPropertyDescriptor(Bnt.prototype,"premultipliedAlpha"),Bnt.prototype),st(Bnt.prototype,"timeScale",[Cnt,Rc],Object.getOwnPropertyDescriptor(Bnt.prototype,"timeScale"),Bnt.prototype),st(Bnt.prototype,"debugSlots",[Rc,bnt],Object.getOwnPropertyDescriptor(Bnt.prototype,"debugSlots"),Bnt.prototype),st(Bnt.prototype,"debugBones",[Rc,Tnt],Object.getOwnPropertyDescriptor(Bnt.prototype,"debugBones"),Bnt.prototype),st(Bnt.prototype,"debugMesh",[Rc,Ent],Object.getOwnPropertyDescriptor(Bnt.prototype,"debugMesh"),Bnt.prototype),st(Bnt.prototype,"useTint",[Rc,wnt],Object.getOwnPropertyDescriptor(Bnt.prototype,"useTint"),Bnt.prototype),st(Bnt.prototype,"sockets",[Pnt,Int],Object.getOwnPropertyDescriptor(Bnt.prototype,"sockets"),Bnt.prototype),Nnt=st(Bnt.prototype,"_timeScale",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Lnt=st(Bnt.prototype,"_useTint",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Fnt=st(Bnt.prototype,"_preCacheMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),znt=st(Bnt.prototype,"_cacheMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Znt.REALTIME}}),Vnt=st(Bnt.prototype,"_defaultCacheMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Znt.REALTIME}}),knt=st(Bnt.prototype,"_debugBones",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gnt=st(Bnt.prototype,"_debugSlots",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Unt=st(Bnt.prototype,"_skeletonData",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hnt=st(Bnt.prototype,"_premultipliedAlpha",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jnt=st(Bnt.prototype,"defaultSkin",[yc,Rnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Wnt=st(Bnt.prototype,"defaultAnimation",[Dnt,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qnt=st(Bnt.prototype,"_sockets",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xnt=st(Bnt.prototype,"_debugMesh",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mnt=Bnt))||Mnt)||Mnt)||Mnt)||Mnt);c.internal.SpineSkeleton=iit;var rit,oit,ait,sit,cit,lit,uit,hit,_it,fit,dit,pit,mit,vit,git,yit,xit,Sit,Ait,Cit,bit,Tit,Eit,wit,Pit,Iit,Rit,Dit,Mit,Bit,Oit,Nit,Lit,Fit,zit,Vit,kit,Git,Uit,Hit,jit,Wit,qit,Xit,Yit=function(){function t(){this.name="sp.VertexEffectDelegate",this._vertexEffect=null,this._interpolation=null,this._effectType=void 0,this._vertexEffect=null,this._interpolation=null,this._effectType="none"}var e=t.prototype;return e.clear=function(){this._vertexEffect=null,this._interpolation=null,this._effectType="none"},e.initJitter=function(t,e){return this._effectType="jitter",this._vertexEffect=new het.JitterEffect(t,e),this._vertexEffect},e.initSwirlWithPow=function(t,e){return this._interpolation=new het.Pow(e),this._vertexEffect=new het.SwirlEffect(t,this._interpolation),this._vertexEffect},e.initSwirlWithPowOut=function(t,e){return this._interpolation=new het.PowOut(e),this._vertexEffect=new het.SwirlEffect(t,this._interpolation),this._vertexEffect},e.getJitterVertexEffect=function(){return this._vertexEffect},e.getSwirlVertexEffect=function(){return this._vertexEffect},e.getVertexEffect=function(){return this._vertexEffect},e.getEffectType=function(){return this._effectType},t}(),Kit=0,Jit=[0,1,2,2,3,0],Qit=new En(0,0,255,255),Zit=new En(255,0,0,255),$it=new En(0,255,0,255),trt=new En(255,255,0,255),ert=new het.Color(1,1,1,1),nrt=new het.Color(1,1,1,1),irt=new het.Vector2,rrt=new het.Vector2,ort=new Float32Array(4),art=new Float32Array(4),srt=0,crt=0,lrt=0,urt=0,hrt=0,_rt=0,frt=0,drt=0,prt=null,mrt=null,vrt=null;function grt(t){var e,n;switch(t){case het.BlendMode.Additive:e=rit?Pi.ONE:Pi.SRC_ALPHA,n=Pi.ONE;break;case het.BlendMode.Multiply:e=Pi.DST_COLOR,n=Pi.ONE_MINUS_SRC_ALPHA;break;case het.BlendMode.Screen:e=Pi.ONE,n=Pi.ONE_MINUS_SRC_COLOR;break;case het.BlendMode.Normal:default:e=rit?Pi.ONE:Pi.SRC_ALPHA,n=Pi.ONE_MINUS_SRC_ALPHA}return Uit.getMaterialForBlendAndTint(e,n,cit?$nt.TWO_COLORED:$nt.COLORED_TEXTURED)}function yrt(t){Fit=t.fa*pit,Dit=_it*(oit=rit?Fit/255:1),Mit=fit*oit,Bit=dit*oit,Oit=t.fr*Dit,Nit=t.fg*Mit,Lit=t.fb*Bit,ort[0]=Oit/255,ort[1]=Nit/255,ort[2]=Lit/255,ort[3]=Fit/255,zit=t.dr*Dit,Vit=t.dg*Mit,kit=t.db*Bit,Git=rit?255:0,art[0]=zit/255,art[1]=Vit/255,art[2]=kit/255,art[3]=Git/255}var xrt=new Float32Array(4);function Srt(t){return xrt[0]=t.r/255,xrt[1]=t.g/255,xrt[2]=t.b/255,xrt[3]=t.a/255,xrt}var Art=null,Crt=null,brt={vCount:32767,ensureAccessor:function(t){var e=t?Crt:Art;if(!e){var n=zB.root.device,i=zB.root.batcher2D,r=t?Uq:Gq;t?(e=Crt=new M2(n,r,this.vCount),i.registerBufferAccessor(Number.parseInt("SPINETINT",36),Crt)):(e=Art=new M2(n,r,this.vCount),i.registerBufferAccessor(Number.parseInt("SPINE",36),Art))}return e},createData:function(t){var e=t.renderData;if(!e){for(var n=t.useTint||t.isAnimationCached(),i=this.ensureAccessor(n),r=t._skeleton.data.skins,o=0,a=0,s=0;s<r.length;++s)for(var c=r[s].attachments,l=0;l<c.length;l++){var u=c[l];for(var h in u){var _=u[h];_ instanceof het.RegionAttachment?(o+=4,a+=6):_ instanceof het.MeshAttachment&&(o+=_.worldVerticesLength>>1,a+=_.triangles.length)}}(e=uX.add(n?Uq:Gq,i)).resize(o,a),e.indices&&a===e.indices.length||(e.indices=new Uint16Array(a)),t.maxVertexCount=o,t.maxIndexCount=a}return e},updateRenderData:function(t){Uit=t;var e=t._skeleton;!t.isAnimationCached()&&e&&e.updateWorldTransform(),e&&function(t){if(t._skeleton){var e,n=t.color;_it=n.r/255,fit=n.g/255,dit=n.b/255,pit=n.a/255,cit=t.useTint||t.isAnimationCached(),mit=cit?13:9,t.drawList.reset(),Uit=t,Hit=t.node,jit=t.renderData,mrt=null,Ait=!0,rit=t.premultipliedAlpha,oit=1,Kit=0,Xit=!1,prt=t._effectDelegate&&t._effectDelegate._vertexEffect,(4294967295!==n._val||rit)&&(Xit=!0),cit&&(Kit|=1),Uit.enableBatch&&(e=Hit.worldMatrix,Ait=!1,Kit|=16),t.isAnimationCached()?function(t){var e=Uit._curFrame;if(e){var n=e.segments;if(0!==n.length){vit=12,urt=0,hrt=0,lrt=0,_rt=0;var i=null,r=e.vertices,o=e.indices,a=0,s=0,c=0,l=0;t&&(Tit=t.m00,Pit=t.m01,Eit=t.m04,Iit=t.m05,wit=t.m12,Rit=t.m13);var u=16&Kit,h=u&&(1===Tit&&0===Pit&&0===Eit&&1===Iit),_=e.colors,f=0,d=_[f++],p=d.vfOffset;yrt(d);for(var m=0,v=jit,g=v.chunk.vb,y=v.indices,x=0,S=n.length;x<S;x++){var A=n[x];if(i=grt(A.blendMode)){if(mrt||(mrt=i),Ait||i.hash!==mrt.hash||A.tex&&A.tex!==vrt){Ait=!1;var C=_rt-m;C>0&&(Uit._requestDrawData(mrt,vrt,m,C),m=_rt),mrt=i,vrt=A.tex}crt=A.vertexCount,hrt=A.indexCount,a=v.chunk.vertexOffset;for(var b=_rt,T=_rt+hrt;b<T;b++)y[b]=a+lrt+o[c++];if(l=A.vfCount,g.set(r.subarray(s,s+l),s),h)for(var E=s,w=s+l;E<w;E+=mit)g[E]+=wit,g[E+1]+=Rit;else if(u)for(var P=s,I=s+l;P<I;P+=mit)Cit=g[P],bit=g[P+1],g[P]=Cit*Tit+bit*Eit+wit,g[P+1]=Cit*Pit+bit*Iit+Rit;if(Xit)for(var R=s/13*6,D=s,M=s+l;D<M;D+=mit,R+=6)R>=p&&(yrt(d=_[f++]),p=d.vfOffset),g.set(ort,D+5),g.set(art,D+9);s+=l,lrt+=crt,_rt+=hrt,crt=0,hrt=0}}var B=_rt-m;vrt&&B>0&&Uit._requestDrawData(mrt,vrt,m,B)}}}(e):(prt&&prt.begin(t._skeleton),function(t,e){var n=jit;qit=n.chunk.vb,Wit=n.indices,frt=Uit.maxVertexCount,drt=Uit.maxIndexCount;var i,r,o,a,s,c,l=Uit._skeleton,u=l.color,h=Uit._debugRenderer,_=Uit._clipper,f=null;ait=Uit._startSlotIndex,sit=Uit._endSlotIndex,Sit=!1,-1===ait&&(Sit=!0),lit=Uit.debugSlots,uit=Uit.debugBones,hit=Uit.debugMesh,h&&(uit||lit||hit)&&(h.clear(),h.lineWidth=5),vit=12,srt=0,lrt=0,urt=0,hrt=0,_rt=0;for(var d=0,p=0,m=l.drawOrder.length;p<m;p++)if(void 0!==(c=l.drawOrder[p]))if(ait>=0&&ait===c.data.index&&(Sit=!0),Sit)if(sit>=0&&sit===c.data.index&&(Sit=!1),srt=0,hrt=0,i=c.getAttachment())if(a=i instanceof het.RegionAttachment,s=i instanceof het.MeshAttachment,i instanceof het.ClippingAttachment)_.clipStart(c,i);else if(a||s){var v=i.region.texture.getRealTexture();if(f=grt(c.data.blendMode)){if(mrt||(mrt=f),Ait||f.hash!==mrt.hash||v&&vrt!==v){Ait=!1;var g=_rt-d;g>0&&(Uit._requestDrawData(mrt,vrt,d,g),d=_rt),vrt=v,mrt=f}if(a){if(o=Jit,srt=(crt=4)*mit,hrt=6,i.computeWorldVertices(c.bone,qit,urt,mit),h&&lit){h.strokeColor=Qit,h.moveTo(qit[urt],qit[urt+1]);for(var y=urt+mit,x=urt+srt;y<x;y+=mit)h.lineTo(qit[y],qit[y+1]);h.close(),h.stroke()}}else if(s){var S=i;if(o=S.triangles,crt=S.worldVerticesLength>>1,srt=crt*mit,hrt=o.length,S.computeWorldVertices(c,0,S.worldVerticesLength,qit,urt,mit),h&&hit){h.strokeColor=trt;for(var A=0,C=o.length;A<C;A+=3){var b=o[A]*mit+urt,T=o[A+1]*mit+urt,E=o[A+2]*mit+urt;h.moveTo(qit[b],qit[b+1]),h.lineTo(qit[T],qit[T+1]),h.lineTo(qit[E],qit[E+1]),h.close(),h.stroke()}}}if(0!==srt&&0!==hrt){var w=i;(Wit=n.indices).set(o,_rt),r=w.uvs;for(var P=urt,I=urt+srt,R=0;P<I;P+=mit,R+=2)qit[P+3]=r[R],qit[P+4]=r[R+1];if(Trt(u,w.color,c.color,_,c),hrt>0){for(var D=n.chunk.vertexOffset,M=_rt,B=_rt+hrt;M<B;M++)Wit[M]+=lrt+D;if(e){Tit=e.m00,Eit=e.m04,wit=e.m12,Pit=e.m01,Iit=e.m05,Rit=e.m13;for(var O=urt,N=urt+srt;O<N;O+=mit)Cit=qit[O],bit=qit[O+1],qit[O]=Cit*Tit+bit*Eit+wit,qit[O+1]=Cit*Pit+bit*Iit+Rit}}urt+=srt,lrt+=crt,_rt+=hrt,crt=0,hrt=0,_.clipEndWithSlot(c)}else _.clipEndWithSlot(c)}else _.clipEndWithSlot(c)}else _.clipEndWithSlot(c);else _.clipEndWithSlot(c);else _.clipEndWithSlot(c);var L=_rt-d;if(vrt&&L>0&&Uit._requestDrawData(mrt,vrt,d,L),_.clipEnd(),h&&uit){var F;h.strokeColor=Zit,h.fillColor=Qit;for(var z=0,V=l.bones.length;z<V;z++){var k=(F=l.bones[z]).data.length*F.a+F.worldX,G=F.data.length*F.c+F.worldY;h.moveTo(F.worldX,F.worldY),h.lineTo(k,G),h.stroke(),h.circle(F.worldX,F.worldY,1.5*Math.PI),h.fill(),0===z&&(h.fillColor=$it)}}}(0,e),prt&&prt.end()),(cit?Crt:Art).getMeshBuffer(jit.chunk.bufferId).setDirty(),t.attachUtil._syncAttachedNode(),Hit=void 0,Uit=void 0,prt=null}}(t)},updateColor:function(t){t&&(Uit=t).markForUpdateRenderData()},fillBuffers:function(){}};function Trt(t,e,n,i,r){if(ert.a=n.a*e.a*t.a*pit*255,oit=rit?ert.a:255,git=_it*e.r*t.r*oit,yit=fit*e.g*t.g*oit,xit=dit*e.b*t.b*oit,ert.r=git*n.r,ert.g=yit*n.g,ert.b=xit*n.b,null==r.darkColor?nrt.set(0,0,0,1):(nrt.r=r.darkColor.r*git,nrt.g=r.darkColor.g*yit,nrt.b=r.darkColor.b*xit),nrt.a=rit?255:0,i.isClipping()){vit=cit?12:8;var o=qit.subarray(urt),a=qit.subarray(urt+3);i.clipTriangles(o,srt,Wit.subarray(_rt),hrt,a,ert,nrt,cit,mit);var s=i.clippedVertices,c=i.clippedTriangles;if(function(t,e){var n=crt,i=hrt,r=jit;hrt=e.length,crt=t.length/vit,srt=crt*mit,frt+=crt-n,drt+=hrt-i;var o=Wit,a=r.chunk.vertexOffset,s=!1;if(frt>r.vertexCount&&(r.resizeAndCopy(frt,drt>r.indexCount?drt:r.indexCount),qit=r.chunk.vb,s=!0),drt>Wit.length&&(Wit=r.indices=new Uint16Array(drt),s=!0),s)for(var c=r.chunk.vertexOffset-a,l=0;l<_rt;++l)Wit[l]=o[l]+c}(s,c),c.length>0&&Wit.set(c,_rt),prt)for(var l=0,u=s.length,h=urt;l<u;l+=vit,h+=mit)irt.x=s[l],irt.y=s[l+1],ert.set(s[l+2],s[l+3],s[l+4],s[l+5]),rrt.x=s[l+6],rrt.y=s[l+7],cit?nrt.set(s[l+8],s[l+9],s[l+10],s[l+11]):nrt.set(0,0,0,0),prt.transform(irt,rrt,ert,nrt),qit[h]=irt.x,qit[h+1]=irt.y,qit[h+3]=rrt.x,qit[h+4]=rrt.y,qit.set(Srt(ert),h+5),cit&&qit.set(Srt(nrt),h+9);else for(var _=0,f=s.length,d=urt;_<f;_+=vit,d+=mit)qit[d]=s[_],qit[d+1]=s[_+1],qit[d+3]=s[_+6],qit[d+4]=s[_+7],qit[d+5]=s[_+2]/255,qit[d+6]=s[_+3]/255,qit[d+7]=s[_+4]/255,qit[d+8]=s[_+5]/255,cit&&(qit[d+9]=s[_+8]/255,qit[d+10]=s[_+9]/255,qit[d+11]=s[_+10]/255,qit[d+12]=s[_+11]/255)}else if(prt)for(var p=urt,m=urt+srt;p<m;p+=mit)irt.x=qit[p],irt.y=qit[p+1],rrt.x=qit[p+3],rrt.y=qit[p+4],prt.transform(irt,rrt,ert,nrt),qit[p]=irt.x,qit[p+1]=irt.y,qit[p+3]=rrt.x,qit[p+4]=rrt.y,qit.set(Srt(ert),p+5),cit&&qit.set(Srt(nrt),p+9);else{ort.set(Srt(ert)),art.set(Srt(nrt));for(var v=urt,g=urt+srt;v<g;v+=mit)qit.set(ort,v+5),cit&&qit.set(art,v+9)}}c.internal.SpineAssembler=brt;var Ert,wrt,Prt={getAssembler:function(){return brt}};iit.Assembler=Prt,function(t){t[t.REGION=0]="REGION",t[t.BOUNDING_BOX=1]="BOUNDING_BOX",t[t.MESH=2]="MESH",t[t.SKINNED_MESH=3]="SKINNED_MESH"}(Ert||(Ert={})),ce(Ert),function(t){t[t.START=0]="START",t[t.INTERRUPT=1]="INTERRUPT",t[t.END=2]="END",t[t.DISPOSE=3]="DISPOSE",t[t.COMPLETE=4]="COMPLETE",t[t.EVENT=5]="EVENT"}(wrt||(wrt={})),ce(wrt),t("sp",Object.freeze({__proto__:null,spine:het,get ATTACHMENT_TYPE(){return Ert},get AnimationEventType(){return wrt},timeScale:1,get DefaultSkinsEnum(){return Jnt},get DefaultAnimsEnum(){return Qnt},get AnimationCacheMode(){return Znt},get SpineMaterialType(){return $nt},SpineSocket:nit,Skeleton:iit,SkeletonData:Zet,SkeletonTexture:Ket,convertFilter:Jet,convertWraps:Qet,VertexEffectDelegate:Yit,simpleSpineAssembler:Prt}));var Irt=function(){function t(){this.originalTarget=null,this.target=null,this.tag=t.TAG_INVALID}var e=t.prototype;return e.clone=function(){var e=new t;return e.originalTarget=null,e.target=null,e.tag=this.tag,e},e.isDone=function(){return!0},e.startWithTarget=function(t){this.originalTarget=t,this.target=t},e.stop=function(){this.target=null},e.step=function(){w(1006)},e.update=function(){w(1007)},e.getTarget=function(){return this.target},e.setTarget=function(t){this.target=t},e.getOriginalTarget=function(){return this.originalTarget},e.setOriginalTarget=function(t){this.originalTarget=t},e.getTag=function(){return this.tag},e.setTag=function(t){this.tag=t},e.reverse=function(){return w(1008),null},e.retain=function(){},e.release=function(){},t}();Irt.TAG_INVALID=-1;var Rrt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._duration=0,e._timesForRepeat=1,e}Q(e,t);var n=e.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(t){this._duration=t},n.clone=function(){return new e},e}(Irt),Drt=(function(t){function e(e,n){var i;return void 0===n&&(n=1),(i=t.call(this)||this)._speed=0,i._innerAction=null,e&&i.initWithAction(e,n),i}Q(e,t);var n=e.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(t){this._speed=t},n.initWithAction=function(t,e){return t?(this._innerAction=t,this._speed=e,!0):(D(1021),!1)},n.clone=function(){var t=new e;return t.initWithAction(this._innerAction.clone(),this._speed),t},n.startWithTarget=function(t){Irt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.stop=function(){this._innerAction.stop(),Irt.prototype.stop.call(this)},n.step=function(t){this._innerAction.step(t*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new e(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction}}(Irt),0),Mrt=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},Brt=function(){function t(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var e=t.prototype;return e._searchElementByTarget=function(t,e){for(var n=0;n<t.length;n++)if(e===t[n].target)return t[n];return null},e._getElement=function(t,e){var n=this._elementPool.pop();return n||(n=new Mrt),n.target=t,n.paused=!!e,n},e._putElement=function(t){t.actions.length=0,t.actionIndex=0,t.currentAction=null,t.paused=!1,t.target=null,t.lock=!1,this._elementPool.push(t)},e.addAction=function(t,e,n){if(t&&e){null==e.uuid&&(e.uuid="_TWEEN_UUID_"+Drt++);var i=this._hashTargets.get(e);i?i.actions||(i.actions=[]):(i=this._getElement(e,n),this._hashTargets.set(e,i),this._arrayTargets.push(i)),i.target=e,i.actions.push(t),t.startWithTarget(e)}else D(1e3)},e.removeAllActions=function(){for(var t=this._arrayTargets,e=0;e<t.length;e++){var n=t[e];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},e.removeAllActionsFromTarget=function(t){if(null!=t){var e=this._hashTargets.get(t);e&&(e.actions.length=0,this._deleteHashElement(e))}},e.removeAction=function(t){if(null!=t){var e=t.getOriginalTarget(),n=this._hashTargets.get(e);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===t){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},e._removeActionByTag=function(t,e,n){for(var i=0,r=e.actions.length;i<r;++i){var o=e.actions[i];if(o&&o.getTag()===t){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,e);break}}},e._removeAllActionsByTag=function(t,e,n){for(var i=e.actions.length-1;i>=0;--i){var r=e.actions[i];if(r&&r.getTag()===t){if(n&&r.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,e)}}},e.removeActionByTag=function(t,e){var n=this;t===Irt.TAG_INVALID&&w(1002);var i=this._hashTargets;if(e){var r=i.get(e);r&&this._removeActionByTag(t,r,e)}else i.forEach((function(e){n._removeActionByTag(t,e)}))},e.removeAllActionsByTag=function(t,e){var n=this;t===Irt.TAG_INVALID&&w(1002);var i=this._hashTargets;if(e){var r=i.get(e);r&&this._removeAllActionsByTag(t,r,e)}else i.forEach((function(e){n._removeAllActionsByTag(t,e)}))},e.getActionByTag=function(t,e){t===Irt.TAG_INVALID&&w(1004);var n=this._hashTargets.get(e);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===t)return r}w(1005,t)}return null},e.getNumberOfRunningActionsInTarget=function(t){var e=this._hashTargets.get(t);return e&&e.actions?e.actions.length:0},e.pauseTarget=function(t){var e=this._hashTargets.get(t);e&&(e.paused=!0)},e.resumeTarget=function(t){var e=this._hashTargets.get(t);e&&(e.paused=!1)},e.pauseAllRunningActions=function(){for(var t=[],e=this._arrayTargets,n=0;n<e.length;n++){var i=e[n];i&&!i.paused&&(i.paused=!0,t.push(i.target))}return t},e.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)t[e]&&this.resumeTarget(t[e])},e.pauseTargets=function(t){if(t)for(var e=0;e<t.length;e++)t[e]&&this.pauseTarget(t[e])},e.purgeSharedManager=function(){c.director.getScheduler().unscheduleUpdate(this)},e._removeActionAtIndex=function(t,e){e.actions[t],e.actions.splice(t,1),e.actionIndex>=t&&e.actionIndex--,0===e.actions.length&&this._deleteHashElement(e)},e._deleteHashElement=function(t){var e=!1;if(t&&!t.lock&&this._hashTargets.get(t.target)){this._hashTargets.delete(t.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===t){n.splice(i,1);break}this._putElement(t),e=!0}return e},e.update=function(t){for(var e,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(e=this._currentTarget).target;if(r instanceof _l&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!e.paused&&e.actions){for(e.lock=!0,e.actionIndex=0;e.actionIndex<e.actions.length;e.actionIndex++)if(e.currentAction=e.actions[e.actionIndex],e.currentAction){if(e.currentAction.step(t*(e.currentAction._speedMethod?e.currentAction._speed:1)),e.currentAction&&e.currentAction.isDone()){e.currentAction.stop();var o=e.currentAction;e.currentAction=null,this.removeAction(o)}e.currentAction=null}e.lock=!1}0===e.actions.length&&this._deleteHashElement(e)&&i--}}},t}(),Ort=t("TweenSystem",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).actionMgr=new Brt,e}return Q(e,t),e.prototype.update=function(t){this.actionMgr.update(t)},K(e,[{key:"ActionManager",get:function(){return this.actionMgr}}]),e}(bB));Ort.ID="TWEEN",Ort.instance=void 0,zB.on(FB.EVENT_INIT,(function(){var t=new Ort;Ort.instance=t,zB.registerSystem(Ort.ID,t,bB.Priority.MEDIUM)}));var Nrt=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new e},e}(Rrt),Lrt=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.update=function(){for(var t=this.target.getComponentsInChildren(cF),e=0;e<t.length;++e)t[e].enabled=!0},n.reverse=function(){return new Frt},n.clone=function(){return new e},e}(Nrt),Frt=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.update=function(){for(var t=this.target.getComponentsInChildren(cF),e=0;e<t.length;++e)t[e].enabled=!1},n.reverse=function(){return new Lrt},n.clone=function(){return new e},e}(Nrt);!function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;n.update=function(){for(var t=this.target.getComponentsInChildren(cF),e=0;e<t.length;++e){var n=t[e];n.enabled=!n.enabled}},n.reverse=function(){return new e},n.clone=function(){return new e}}(Nrt);var zrt=function(t){function e(e){var n;return(n=t.call(this)||this)._isNeedCleanUp=!0,void 0!==e&&n.init(e),n}Q(e,t);var n=e.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(t){return this._isNeedCleanUp=t,!0},n.reverse=function(){return new e(this._isNeedCleanUp)},n.clone=function(){return new e(this._isNeedCleanUp)},e}(Nrt),Vrt=function(t){function e(e,n,i){var r;return(r=t.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(e,n,i),r}Q(e,t);var n=e.prototype;return n.initWithFunction=function(t,e,n){return t&&(this._function=t),e&&(this._selectorTarget=e),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(t){t!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=t)},n.clone=function(){var t=new e;return t.initWithFunction(this._function,this._selectorTarget,this._data),t},e}(Nrt),krt=function(t){function e(e){var n;return(n=t.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===e||isNaN(e)||n.initWithDuration(e),n}Q(e,t);var n=e.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(t){return this._duration=0===t?ue.FLT_EPSILON:t,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(t){t._repeatForever=this._repeatForever,t._speed=this._speed,t._timesForRepeat=this._timesForRepeat,t._easeList=this._easeList,t._speedMethod=this._speedMethod,t._repeatMethod=this._repeatMethod},n._reverseEaseList=function(t){if(this._easeList){t._easeList=[];for(var e=0;e<this._easeList.length;e++)t._easeList.push(this._easeList[e])}},n.clone=function(){var t=new e(this._duration);return this._cloneDecoration(t),t},n.easing=function(t){this._easeList?this._easeList.length=0:this._easeList=[];for(var e=0;e<arguments.length;e++)this._easeList.push(arguments[e]);return this},n._computeEaseTime=function(t){return t},n.step=function(t){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=t;var e=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);e=e<1?e:1,this.update(e>0?e:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(t){Irt.prototype.startWithTarget.call(this,t),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return w(1010),this},n.setAmplitudeRate=function(){w(1011)},n.getAmplitudeRate=function(){return w(1012),0},n.speed=function(t){return t<=0?(w(1013),this):(this._speedMethod=!0,this._speed*=t,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(t){return this._speed=t,this},n.repeat=function(t){return t=Math.round(t),isNaN(t)||t<1?(w(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=t,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},e}(Rrt),Grt=function(t){function e(n){var i;(i=t.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return D(1019),it(i);var o=r.length-1;if(o>=0&&null==r[o]&&w(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=e._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}Q(e,t);var n=e.prototype;return n.initWithTwoActions=function(t,e){if(!t||!e)return D(1025),!1;var n=t._duration,i=e._duration,r=(n*=t._repeatMethod?t._timesForRepeat:1)+(i*=e._repeatMethod?e._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=t,this._actions[1]=e,!0},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),t},n.startWithTarget=function(t){krt.prototype.startWithTarget.call(this,t),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),Irt.prototype.stop.call(this)},n.update=function(t){var e,n,i=0,r=this._split,o=this._actions,a=this._last;(t=this._computeEaseTime(t))<r?(e=0!==r?t/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,e=1===r?1:(t-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),e*=n._timesForRepeat,n.update(e>1?e%1:e),this._last=i)},n.reverse=function(){var t=e._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t._reversed=!0,t},e}(krt);function Urt(t){var e=t instanceof Array?t:arguments;if(1===e.length)return D(1019),null;var n=e.length-1;n>=0&&null==e[n]&&w(1015);var i=null;if(n>=0){i=e[0];for(var r=1;r<=n;r++)e[r]&&(i=Grt._actionOneTwo(i,e[r]))}return i}Grt._actionOneTwo=function(t,e){var n=new Grt;return n.initWithTwoActions(t,e),n};var Hrt=function(t){function e(e,n){var i;return(i=t.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(e,n),i}Q(e,t);var n=e.prototype;return n.initWithAction=function(t,e){var n=t._duration*e;return!!this.initWithDuration(n)&&(this._times=e,this._innerAction=t,t instanceof Nrt&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone(),this._times),t},n.startWithTarget=function(t){this._total=0,this._nextDt=this._innerAction._duration/this._duration,krt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.stop=function(){this._innerAction.stop(),Irt.prototype.stop.call(this)},n.update=function(t){t=this._computeEaseTime(t);var e=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(t>=r){for(;t>r&&this._total<i;)e.update(1),this._total++,e.stop(),e.startWithTarget(this.target),r+=e._duration/n,this._nextDt=r>1?1:r;t>=1&&this._total<i&&(e.update(1),this._total++),this._actionInstant||(this._total===i?e.stop():e.update(t-(r-e._duration/n)))}else e.update(t*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var t=new e(this._innerAction.reverse(),this._times);return this._cloneDecoration(t),this._reverseEaseList(t),t},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction},e}(krt),jrt=function(t){function e(e){var n;return(n=t.call(this)||this)._innerAction=null,e&&n.initWithAction(e),n}Q(e,t);var n=e.prototype;return n.initWithAction=function(t){return t?(this._innerAction=t,!0):(D(1026),!1)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone()),t},n.startWithTarget=function(t){krt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.step=function(t){var e=this._innerAction;e.step(t),e.isDone()&&(e.startWithTarget(this.target),e.step(e.getElapsed()-e._duration))},n.isDone=function(){return!1},n.reverse=function(){var t=new e(this._innerAction.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction},e}(krt),Wrt=function(t){function e(n){var i;(i=t.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return D(1020),it(i);var o=r.length-1;if(o>=0&&null==r[o]&&w(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=e._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}Q(e,t);var n=e.prototype;return n.initWithTwoActions=function(t,e){if(!t||!e)return D(1027),!1;var n=!1,i=t._duration,r=e._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=t,this._two=e,i>r?this._two=Grt._actionOneTwo(e,Yrt(i-r)):i<r&&(this._one=Grt._actionOneTwo(t,Yrt(r-i))),n=!0),n},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithTwoActions(this._one.clone(),this._two.clone()),t},n.startWithTarget=function(t){krt.prototype.startWithTarget.call(this,t),this._one.startWithTarget(t),this._two.startWithTarget(t)},n.stop=function(){this._one.stop(),this._two.stop(),Irt.prototype.stop.call(this)},n.update=function(t){t=this._computeEaseTime(t),this._one&&this._one.update(t),this._two&&this._two.update(t)},n.reverse=function(){var t=e._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t},e}(krt);function qrt(t){var e=t instanceof Array?t:arguments;if(1===e.length)return D(1020),null;e.length>0&&null==e[e.length-1]&&w(1015);for(var n=e[0],i=1;i<e.length;i++)null!=e[i]&&(n=Wrt._actionOneTwo(n,e[i]));return n}Wrt._actionOneTwo=function(t,e){var n=new Wrt;return n.initWithTwoActions(t,e),n};var Xrt=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.update=function(){},n.reverse=function(){var t=new e(this._duration);return this._cloneDecoration(t),this._reverseEaseList(t),t},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithDuration(this._duration),t},e}(krt);function Yrt(t){return new Xrt(t)}var Krt,Jrt,Qrt,Zrt,$rt,tot,eot,not,iot,rot,oot,aot,sot,cot,lot,uot,hot,_ot,fot,dot,pot,mot,vot,got,yot,xot,Sot,Aot,Cot,bot,Tot,Eot,wot,Pot,Iot,Rot,Dot,Mot,Bot,Oot,Not,Lot,Fot,zot,Vot,kot,Got,Uot,Hot,jot,Wot,qot,Xot,Yot,Kot,Jot,Qot,Zot,$ot,tat,eat=function(t){function e(e){var n;return(n=t.call(this)||this)._other=null,e&&n.initWithAction(e),n}Q(e,t);var n=e.prototype;return n.initWithAction=function(t){return t?t===this._other?(D(1029),!1):!!krt.prototype.initWithDuration.call(this,t._duration)&&(this._other=t,!0):(D(1028),!1)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._other.clone()),t},n.startWithTarget=function(t){krt.prototype.startWithTarget.call(this,t),this._other.startWithTarget(t)},n.update=function(t){t=this._computeEaseTime(t),this._other&&this._other.update(1-t)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),Irt.prototype.stop.call(this)},e}(krt),nat=t("TweenAction",function(t){function e(e,n,i){var r;if((r=t.call(this)||this)._opts=void 0,r._props=void 0,r._originProps=void 0,null==i)i=Object.create(null);else if(function(t){var e=" [Tween:] ",n=" option is not support in v + "+l,i=t;i.delay&&y(e+"delay"+n),i.repeat&&y(e+"repeat"+n),i.repeatDelay&&y(e+"repeatDelay"+n),i.interpolation&&y(e+"interpolation"+n),i.onStop&&y(e+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(t){var e=t.charAt(0);if(/[A-Z]/.test(e)){var n=(t=t.replace(e,e.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)t="linear";else{var r=n[1];switch(i){case"quadratic":t="quad"+r;break;case"quartic":t="quart"+r;break;case"quintic":t="quint"+r;break;case"sinusoidal":t="sine"+r;break;case"exponential":t="expo"+r;break;case"circular":t="circ"+r;break;default:t=i+r}}}}return t}(i.easing)),i.progress||(i.progress=r.progress),i.easing&&"string"==typeof i.easing){var o=i.easing;i.easing=Z_[o],i.easing||I(1031,o)}for(var a in r._opts=i,r._props=Object.create(null),n)if(n.hasOwnProperty(a)){var s=n[a];if("function"==typeof s&&(s=s()),null!=s&&"string"!=typeof s){var c=void 0,u=void 0;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(c=Z_[s.easing])||I(1031,s.easing):c=s.easing,u=s.progress,s=s.value);var h=Object.create(null);h.value=s,h.easing=c,h.progress=u,r._props[a]=h}}return r._originProps=n,r.initWithDuration(e),r}Q(e,t);var n=e.prototype;return n.clone=function(){var t=new e(this._duration,this._originProps,this._opts);return this._cloneDecoration(t),t},n.startWithTarget=function(t){krt.prototype.startWithTarget.call(this,t);var e=!!this._opts.relative,n=this._props;for(var i in n){var r=t[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=e?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=e?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(t){var e=this.target;if(e){var n=this._props,i=this._opts,r=t;i.easing&&(r=i.easing(t));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(t):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var _ in u)s.current[_]=l(u[_],h[_],s.current[_],c);e[a]=s.current}i.onUpdate&&i.onUpdate(this.target,t),1===t&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(t,e,n,i){return t+(e-t)*i},e}(krt)),iat=function(t){function e(e){var n;return(n=t.call(this)||this)._props=void 0,n._props={},void 0!==e&&n.init(e),n}Q(e,t);var n=e.prototype;return n.init=function(t){for(var e in t)this._props[e]=t[e];return!0},n.update=function(){var t=this._props,e=this.target;for(var n in t)e[n]=t[n]},n.clone=function(){var t=new e;return t.init(this._props),t},e}(Nrt),rat=t("Tween",function(){function t(t){this._actions=[],this._finalAction=null,this._target=null,this._tag=Irt.TAG_INVALID,this._target=void 0===t?null:t}var e=t.prototype;return e.tag=function(t){return this._tag=t,this},e.then=function(t){return t instanceof Irt?this._actions.push(t.clone()):this._actions.push(t._union()),this},e.target=function(t){return this._target=t,this},e.start=function(){return this._target?(this._finalAction&&Ort.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),Ort.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(y("Please set target to tween first"),this)},e.stop=function(){return this._finalAction&&Ort.instance.ActionManager.removeAction(this._finalAction),this},e.clone=function(t){var e=this._union();return oat(t).then(e.clone())},e.union=function(){var t=this._union();return this._actions.length=0,this._actions.push(t),this},e.to=function(t,e,n){(n=n||Object.create(null)).relative=!1;var i=new nat(t,e,n);return this._actions.push(i),this},e.by=function(t,e,n){(n=n||Object.create(null)).relative=!0;var i=new nat(t,e,n);return this._actions.push(i),this},e.set=function(t){var e=new iat(t);return this._actions.push(e),this},e.delay=function(t){var e=Yrt(t);return this._actions.push(e),this},e.call=function(t){var e=new Vrt(t,undefined,undefined);return this._actions.push(e),this},e.sequence=function(){var e=t._wrappedSequence.apply(t,arguments);return this._actions.push(e),this},e.parallel=function(){var e=t._wrappedParallel.apply(t,arguments);return this._actions.push(e),this},e.repeat=function(e,n){if(e===1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof t?n._union():r.pop(),r.push(function(t,e){return new Hrt(t,e)}(i,e)),this},e.repeatForever=function(e){var n,i=this._actions;return n=e instanceof t?e._union():i.pop(),i.push(function(t){return new jrt(t)}(n)),this},e.reverseTime=function(e){var n,i=this._actions;return n=e instanceof t?e._union():i.pop(),i.push(function(t){return new eat(t)}(n)),this},e.hide=function(){var t=new Frt;return this._actions.push(t),this},e.show=function(){var t=new Lrt;return this._actions.push(t),this},e.removeSelf=function(){var t=new zrt(!1);return this._actions.push(t),this},t.stopAll=function(){Ort.instance.ActionManager.removeAllActions()},t.stopAllByTag=function(t,e){Ort.instance.ActionManager.removeAllActionsByTag(t,e)},t.stopAllByTarget=function(t){Ort.instance.ActionManager.removeAllActionsFromTarget(t)},e._union=function(){var t=this._actions;return 1===t.length?t[0]:Urt(t)},e._destroy=function(){this.stop()},t._wrappedSequence=function(){var e=t._tmp_args;e.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=e[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof t&&(e[i]=r._union())}return Urt.apply(Urt,e)},t._wrappedParallel=function(){var e=t._tmp_args;e.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=e[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof t&&(e[i]=r._union())}return qrt.apply(qrt,e)},t}());function oat(t){return new rat(t)}function aat(t){return y("tweenUtil' is deprecated, please use 'tween' instead "),new rat(t)}rat._tmp_args=[],c.Tween=rat,c.tween=oat,c.tweenUtil=aat;var sat,cat,lat,uat=new En;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(sat||(sat={})),ce(sat),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}(cat||(cat={})),function(t){t.CLICK="click"}(lat||(lat={}));var hat=function(e){return t({Button:e,ButtonComponent:e}),e}((Krt=fc("cc.Button"),Jrt=Ic(),Qrt=pc(110),Zrt=Tc(),$rt=dc(xX),tot=Xc(kT),eot=kc(),not=Oc(),iot=kc(),rot=Oc(),oot=Xc(sat),aot=kc(),sot=Oc(),cot=kc(),lot=Oc(),uot=kc(),hot=Oc(),_ot=kc(),fot=Oc(),dot=kc(),pot=Oc(),mot=Lc(),vot=Fc(),got=kc(),yot=Oc(),xot=kc(),Sot=Oc(),Aot=Xc(XW),Cot=kc(),bot=Oc(),Tot=Xc(XW),Eot=kc(),wot=Oc(),Pot=Xc(XW),Iot=kc(),Rot=Oc(),Dot=Xc(XW),Mot=kc(),Bot=Oc(),Oot=Xc([BL]),Not=kc(),Lot=Oc(),Krt(Fot=Jrt(Fot=Qrt(Fot=Zrt(Fot=$rt(Fot=bc((tat=$ot=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"clickEvents",Vot,it(e)),at(e,"_interactable",kot,it(e)),at(e,"_transition",Got,it(e)),at(e,"_normalColor",Uot,it(e)),at(e,"_hoverColor",Hot,it(e)),at(e,"_pressedColor",jot,it(e)),at(e,"_disabledColor",Wot,it(e)),at(e,"_normalSprite",qot,it(e)),at(e,"_hoverSprite",Xot,it(e)),at(e,"_pressedSprite",Yot,it(e)),at(e,"_disabledSprite",Kot,it(e)),at(e,"_duration",Jot,it(e)),at(e,"_zoomScale",Qot,it(e)),at(e,"_target",Zot,it(e)),e._pressed=!1,e._hovered=!1,e._fromColor=new En,e._toColor=new En,e._time=0,e._transitionFinished=!0,e._fromScale=new Pn,e._toScale=new Pn,e._originalScale=null,e._sprite=null,e._targetScale=new Pn,e}Q(e,t);var n=e.prototype;return n.__preload=function(){this.target||(this.target=this.node);var t=this.node.getComponent(XQ);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(t){var e=this.target;if(!this._transitionFinished&&e&&(this._transition===sat.COLOR||this._transition===sat.SCALE)){this._time+=t;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===sat.COLOR){var i=e._uiProps.uiComp;En.lerp(uat,this._fromColor,this._toColor,n),i&&(i.color=uat)}else this.transition===sat.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=ln(this._fromScale.x,this._toScale.x,n),this._targetScale.y=ln(this._fromScale.y,this._toScale.y,n),e.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var t=this.target;if(t){var e=this._transition;if(e===sat.COLOR&&this._interactable){var n=t.getComponent(rK);n&&(n.color=this._normalColor)}else e===sat.SCALE&&this._originalScale&&t.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(zC.TOUCH_START,this._onTouchBegan,this),this.node.on(zC.TOUCH_MOVE,this._onTouchMove,this),this.node.on(zC.TOUCH_END,this._onTouchEnded,this),this.node.on(zC.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(zC.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(zC.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(t){t.on(zC.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(zC.TOUCH_START,this._onTouchBegan,this),this.node.off(zC.TOUCH_MOVE,this._onTouchMove,this),this.node.off(zC.TOUCH_END,this._onTouchEnded,this),this.node.off(zC.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(zC.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(zC.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(t){t.off(zC.TRANSFORM_CHANGED)},n._getTargetSprite=function(t){var e=null;return t&&(e=t.getComponent(XQ)),e},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new Pn),Pn.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(t){this._transition===sat.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)},n._setCurrentStateSpriteFrame=function(t){if(t)switch(this._getButtonState()){case cat.NORMAL:this._normalSprite=t;break;case cat.HOVER:this._hoverSprite=t;break;case cat.PRESSED:this._pressedSprite=t;break;case cat.DISABLED:this._disabledSprite=t}},n._onTargetColorChanged=function(t){this._transition===sat.COLOR&&this._setCurrentStateColor(t)},n._setCurrentStateColor=function(t){switch(this._getButtonState()){case cat.NORMAL:this._normalColor=t;break;case cat.HOVER:this._hoverColor=t;break;case cat.PRESSED:this._pressedColor=t;break;case cat.DISABLED:this._disabledColor=t}},n._onTargetTransformChanged=function(t){t&$g.SCALE&&this._originalScale&&this._transition===sat.SCALE&&this._transitionFinished&&Pn.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))},n._onTouchMove=function(t){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&t){var e=t.touch;if(e){var n,i=this.node._uiProps.uiTransformComp.isHit(e.getUILocation());this._transition===sat.SCALE&&this.target&&this._originalScale?i?(Pn.copy(this._fromScale,this._originalScale),Pn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?cat.PRESSED:cat.NORMAL,this._applyTransition(n)),t&&(t.propagationStopped=!0)}}},n._onTouchEnded=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(BL.emitEvents(this.clickEvents,t),this.node.emit(lat.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==sat.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var t=this._getButtonState();this._applyTransition(t)},n._getButtonState=function(){var t=cat.NORMAL;return this._interactable?this._pressed?t=cat.PRESSED:this._hovered&&(t=cat.HOVER):t=cat.DISABLED,t.toString()},n._updateColorTransition=function(t){var e,n=this[t+"Color"],i=null===(e=this.target)||void 0===e?void 0:e.getComponent(rK);i&&(t===cat.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(t){var e=this[t+"Sprite"];this._sprite&&e&&(this._sprite.spriteFrame=e)},n._updateScaleTransition=function(t){this._interactable&&(t===cat.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(Pn.copy(this._fromScale,this._originalScale),Pn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(Pn.copy(this._fromScale,this.target.getScale()),Pn.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(t){var e=this._transition;e===sat.COLOR?this._updateColorTransition(t):e===sat.SPRITE?this._updateSpriteTransition(t):e===sat.SCALE&&this._updateScaleTransition(t)},K(e,[{key:"target",get:function(){return this._target||this.node},set:function(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(t){this._interactable=t,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(t){this._transition!==t&&(this._transition===sat.COLOR?this._updateColorTransition(cat.NORMAL):this._transition===sat.SPRITE&&this._updateSpriteTransition(cat.NORMAL),this._transition=t,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(t){this._pressedColor!==t&&this._pressedColor.set(t)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(t){this._hoverColor!==t&&this._hoverColor.set(t)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(t){this._duration!==t&&(this._duration=t)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(t){this._zoomScale!==t&&(this._zoomScale=t)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(t){if(this._normalSprite!==t){this._normalSprite=t;var e=this.node.getComponent(XQ);e&&(e.spriteFrame=t),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}}]),e}(Qu),$ot.Transition=sat,$ot.EventType=lat,st((zot=tat).prototype,"target",[tot,eot,not],Object.getOwnPropertyDescriptor(zot.prototype,"target"),zot.prototype),st(zot.prototype,"interactable",[iot,rot],Object.getOwnPropertyDescriptor(zot.prototype,"interactable"),zot.prototype),st(zot.prototype,"transition",[oot,aot,sot],Object.getOwnPropertyDescriptor(zot.prototype,"transition"),zot.prototype),st(zot.prototype,"normalColor",[cot,lot],Object.getOwnPropertyDescriptor(zot.prototype,"normalColor"),zot.prototype),st(zot.prototype,"pressedColor",[uot,hot],Object.getOwnPropertyDescriptor(zot.prototype,"pressedColor"),zot.prototype),st(zot.prototype,"hoverColor",[_ot,fot],Object.getOwnPropertyDescriptor(zot.prototype,"hoverColor"),zot.prototype),st(zot.prototype,"disabledColor",[dot,pot],Object.getOwnPropertyDescriptor(zot.prototype,"disabledColor"),zot.prototype),st(zot.prototype,"duration",[mot,vot,got,yot],Object.getOwnPropertyDescriptor(zot.prototype,"duration"),zot.prototype),st(zot.prototype,"zoomScale",[xot,Sot],Object.getOwnPropertyDescriptor(zot.prototype,"zoomScale"),zot.prototype),st(zot.prototype,"normalSprite",[Aot,Cot,bot],Object.getOwnPropertyDescriptor(zot.prototype,"normalSprite"),zot.prototype),st(zot.prototype,"pressedSprite",[Tot,Eot,wot],Object.getOwnPropertyDescriptor(zot.prototype,"pressedSprite"),zot.prototype),st(zot.prototype,"hoverSprite",[Pot,Iot,Rot],Object.getOwnPropertyDescriptor(zot.prototype,"hoverSprite"),zot.prototype),st(zot.prototype,"disabledSprite",[Dot,Mot,Bot],Object.getOwnPropertyDescriptor(zot.prototype,"disabledSprite"),zot.prototype),Vot=st(zot.prototype,"clickEvents",[Oot,yc,Not,Lot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kot=st(zot.prototype,"_interactable",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Got=st(zot.prototype,"_transition",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sat.NONE}}),Uot=st(zot.prototype,"_normalColor",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return En.WHITE.clone()}}),Hot=st(zot.prototype,"_hoverColor",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En(211,211,211,255)}}),jot=st(zot.prototype,"_pressedColor",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return En.WHITE.clone()}}),Wot=st(zot.prototype,"_disabledColor",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En(124,124,124,255)}}),qot=st(zot.prototype,"_normalSprite",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xot=st(zot.prototype,"_hoverSprite",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yot=st(zot.prototype,"_pressedSprite",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kot=st(zot.prototype,"_disabledSprite",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jot=st(zot.prototype,"_duration",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Qot=st(zot.prototype,"_zoomScale",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Zot=st(zot.prototype,"_target",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fot=zot))||Fot)||Fot)||Fot)||Fot)||Fot)||Fot));c.Button=hat;var _at,fat,dat,pat=function(){function t(){}return t.add=function(t){var e=this._tabIndexList;-1===e.indexOf(t)&&e.push(t)},t.remove=function(t){var e=this._tabIndexList,n=e.indexOf(t);-1!==n&&e.splice(n,1)},t.resort=function(){this._tabIndexList.sort((function(t,e){return t._delegate.tabIndex-e._delegate.tabIndex}))},t.next=function(t){var e=this._tabIndexList,n=e.indexOf(t);if(t.setFocus(!1),-1!==n){var i=e[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},t}();pat._tabIndexList=[],function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"}(_at||(_at={})),oe(_at),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(fat||(fat={})),oe(fat),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(dat||(dat={})),oe(dat);var mat,vat,gat,yat,xat,Sat,Aat,Cat,bat,Tat,Eat,wat,Pat,Iat,Rat,Dat,Mat,Bat,Oat,Nat,Lat,Fat,zat,Vat,kat,Gat,Uat,Hat,jat,Wat,qat,Xat,Yat,Kat,Jat,Qat,Zat,$at,tst,est,nst,ist,rst,ost,ast,sst,cst,lst,ust,hst,_st,fst,dst,pst,mst,vst,gst,yst,xst,Sst,Ast,Cst=function(){function t(){this._editing=!1,this._delegate=null}var e=t.prototype;return e.init=function(){},e.onEnable=function(){},e.update=function(){},e.onDisable=function(){this._editing&&this.endEditing()},e.clear=function(){this._delegate=null},e.setTabIndex=function(){},e.setSize=function(){},e.setFocus=function(t){t?this.beginEditing():this.endEditing()},e.isFocused=function(){return this._editing},e.beginEditing=function(){},e.endEditing=function(){},t}(),bst=new Hn,Tst=new Hn,Est=new Pn,wst=null,Pst=0,Ist=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._delegate=null,e._inputMode=-1,e._inputFlag=-1,e._returnType=-1,e.__eventListeners={},e.__autoResize=!1,e.__orientationChanged=void 0,e._edTxt=null,e._isTextArea=!1,e._textLabelFont=null,e._textLabelFontSize=null,e._textLabelFontColor=null,e._textLabelAlign=null,e._placeholderLabelFont=null,e._placeholderLabelFontSize=null,e._placeholderLabelFontColor=null,e._placeholderLabelAlign=null,e._placeholderLineHeight=null,e._placeholderStyleSheet=null,e._domId="EditBoxId_"+ ++Pst,e}Q(e,t);var n=e.prototype;return n.init=function(t){t&&(this._delegate=t,t.inputMode===fat.ANY?this._createTextArea():this._createInput(),pat.add(this),this.setTabIndex(t.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),pat.remove(this),wst===this&&(wst=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(t){this._edTxt.tabIndex=t,pat.resort()},n.setSize=function(t,e){var n=this._edTxt;n&&(n.style.width=t+"px",n.style.height=e+"px")},n.beginEditing=function(){wst&&wst!==this&&wst.setFocus(!1),this._editing=!0,wst=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){c.GAME_VIEW&&this._edTxt?(c.gameView.container.appendChild(this._edTxt),c.gameView.head.appendChild(this._placeholderStyleSheet)):LB.container&&this._edTxt&&(LB.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(c.GAME_VIEW?ge(c.gameView.container,this._edTxt):ge(LB.container,this._edTxt))&&this._edTxt&&(c.GAME_VIEW?c.gameView.container.removeChild(this._edTxt):LB.container.removeChild(this._edTxt)),(c.GAME_VIEW?ge(c.gameView.head,this._placeholderStyleSheet):ge(document.head,this._placeholderStyleSheet))&&(c.GAME_VIEW?c.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),sh.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var t=this._edTxt;t&&this._delegate&&(t.style.display="none",this._delegate._showLabels()),sh.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){sh.os!==ru.ANDROID&&sh.os!==ru.OHOS||(rh.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){sh.os!==ru.ANDROID&&sh.os!==ru.OHOS||(rh.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var t=this;setTimeout((function(){window.scrollY<40&&t._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){sh.browserType!==eu.WECHAT||sh.os!==ru.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var t=this._delegate.node,e=YB.getScaleX(),n=YB.getScaleY(),i=1,r=1;c.GAME_VIEW&&(i=c.gameView.canvas.width/c.game.canvas.width,r=c.gameView.canvas.height/c.game.canvas.height),e*=i,n*=r;var o=YB.getViewportRect(),a=rh.devicePixelRatio;t.getWorldMatrix(bst);var s=t._uiProps.uiTransformComp;if(s&&Pn.set(Est,-s.anchorX*s.width,-s.anchorY*s.height,Est.z),Hn.transform(bst,bst,Est),t._uiProps.uiTransformComp){var l=zB.root.batcher2D.getFirstRenderCamera(t);if(l){l.node.getWorldRT(Tst);var u=Tst.m12,h=Tst.m13,_=GB.center;Tst.m12=_.x-(Tst.m00*u+Tst.m04*h),Tst.m13=_.y-(Tst.m01*u+Tst.m05*h),Hn.multiply(Tst,Tst,bst),e/=a,n/=a;var f=c.GAME_VIEW?c.gameView.container:LB.container,d=Tst.m00*e,p=bst.m01,m=bst.m04,v=Tst.m05*n,g=parseInt(f&&f.style.paddingLeft||"0");g+=o.x*i/a;var y=parseInt(f&&f.style.paddingBottom||"0");y+=o.y/a;var x="matrix("+d+","+-p+","+-m+","+v+","+(Tst.m12*e+g)+","+-(Tst.m13*n+y)+")";this._edTxt.style.transform=x,this._edTxt.style["-webkit-transform"]=x,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var t=this._delegate,e=t.inputMode,n=t.inputFlag,i=t.returnType,r=this._edTxt;if(this._inputMode!==e||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=e,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===dat.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===dat.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===dat.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;e===fat.EMAIL_ADDR?a="email":e===fat.NUMERIC||e===fat.DECIMAL?a="number":e===fat.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):e===fat.URL?a="url":(a="text",i===_at.SEARCH&&(a="search")),r.type=a;var s="none";n===dat.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===dat.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var t=this._delegate.maxLength;t<0&&(t=65535),this._edTxt.maxLength=t},n._initStyleSheet=function(){if(this._edTxt){var t=this._edTxt;t.style.color="#000000",t.style.border="0px",t.style.background="transparent",t.style.width="100%",t.style.height="100%",t.style.outline="medium",t.style.padding="0",t.style.textTransform="none",t.style.display="none",t.style.position="absolute",t.style.bottom="0px",t.style.left="2px",t.className="cocosEditBox",t.style.fontFamily="Arial",t.id=this._domId,this._isTextArea?(t.style.resize="none",t.style.overflowY="scroll"):((t=t).type="text",t.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var t=this._delegate,e=this._edTxt;e&&t&&(e.value=t.string,e.placeholder=t.placeholder,this._updateTextLabel(t.textLabel),this._updatePlaceholderLabel(t.placeholderLabel))},n._updateTextLabel=function(t){if(t){var e=t.font;e=!e||e instanceof dq?t.fontFamily:e._fontFamily;var n=t.fontSize*t.node.scale.y;if((this._textLabelFont!==e||this._textLabelFontSize!==n||this._textLabelFontColor!==t.fontColor||this._textLabelAlign!==t.horizontalAlign)&&(this._textLabelFont=e,this._textLabelFontSize=n,this._textLabelFontColor=t.fontColor,this._textLabelAlign=t.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=t.color.toCSS(),i.style.fontFamily=e,t.horizontalAlign){case oK.HorizontalAlign.LEFT:i.style.textAlign="left";break;case oK.HorizontalAlign.CENTER:i.style.textAlign="center";break;case oK.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(t){if(t){var e=t.font;e=!e||e instanceof dq?t.fontFamily:t.font._fontFamily;var n=t.fontSize*t.node.scale.y;if(this._placeholderLabelFont!==e||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==t.fontColor||this._placeholderLabelAlign!==t.horizontalAlign||this._placeholderLineHeight!==t.fontSize){this._placeholderLabelFont=e,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=t.fontColor,this._placeholderLabelAlign=t.horizontalAlign,this._placeholderLineHeight=t.fontSize;var i=this._placeholderStyleSheet,r=t.color.toCSS(),o=t.fontSize,a="";switch(t.horizontalAlign){case oK.HorizontalAlign.LEFT:a="left";break;case oK.HorizontalAlign.CENTER:a="center";break;case oK.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",sh.browserType===eu.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var t=this;if(this._edTxt){var e=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,t._delegate._editBoxTextChanged(e.value)},i.onInput=function(){if(!n){var i=t._delegate,r=i.maxLength;r>=0&&(e.value=e.value.slice(0,r)),i._editBoxTextChanged(e.value)}},i.onClick=function(){t._editing&&sh.isMobile&&t._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===HR.ENTER?(n.propagationStopped=!0,t._delegate._editBoxEditingReturn(),t._isTextArea||e.blur()):n.keyCode===HR.TAB&&(n.propagationStopped=!0,n.preventDefault(),pat.next(t))},i.onBlur=function(){sh.isMobile&&n&&i.compositionEnd(),t._editing=!1,wst=null,t._hideDom(),t._delegate._editBoxEditingDidEnded()},e.addEventListener("compositionstart",i.compositionStart),e.addEventListener("compositionend",i.compositionEnd),e.addEventListener("input",i.onInput),e.addEventListener("keydown",i.onKeydown),e.addEventListener("blur",i.onBlur),e.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var t=this._edTxt,e=this.__eventListeners;t.removeEventListener("compositionstart",e.compositionStart),t.removeEventListener("compositionend",e.compositionEnd),t.removeEventListener("input",e.onInput),t.removeEventListener("keydown",e.onKeydown),t.removeEventListener("blur",e.onBlur),t.removeEventListener("touchstart",e.onClick),e.compositionStart=null,e.compositionEnd=null,e.onInput=null,e.onKeydown=null,e.onBlur=null,e.onClick=null}},e}(Cst);!function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}(Ast||(Ast={}));var Rst,Dst,Mst,Bst,Ost,Nst,Lst,Fst,zst,Vst,kst,Gst,Ust,Hst,jst,Wst,qst,Xst,Yst,Kst,Jst,Qst,Zst,$st,tct,ect,nct,ict,rct,oct,act,sct,cct,lct,uct,hct,_ct,fct,dct,pct,mct,vct,gct,yct,xct,Sct,Act,Cct,bct,Tct,Ect,wct,Pct,Ict,Rct,Dct,Mct,Bct,Oct,Nct,Lct,Fct=function(e){return t({EditBox:e,EditBoxComponent:e}),e}((mat=fc("cc.EditBox"),vat=Ic(),gat=pc(110),yat=Tc(),xat=dc(xX),Sat=kc(),Aat=Oc(),Cat=kc(),bat=Oc(),Tat=Xc(oK),Eat=kc(),wat=Oc(),Pat=Xc(oK),Iat=kc(),Rat=Oc(),Dat=Xc(XW),Mat=kc(),Bat=Oc(),Oat=Xc(dat),Nat=kc(),Lat=Oc(),Fat=Xc(fat),zat=kc(),Vat=Oc(),kat=Xc(_at),Gat=kc(),Uat=Oc(),Hat=kc(),jat=Oc(),Wat=kc(),qat=Oc(),Xat=Xc([BL]),Yat=kc(),Kat=Oc(),Jat=Xc([BL]),Qat=kc(),Zat=Oc(),$at=Xc([BL]),tst=kc(),est=Oc(),nst=Xc([BL]),ist=kc(),rst=Oc(),mat(ost=vat(ost=gat(ost=yat(ost=xat(ost=bc((Sst=xst=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"editingDidBegan",sst,it(e)),at(e,"textChanged",cst,it(e)),at(e,"editingDidEnded",lst,it(e)),at(e,"editingReturn",ust,it(e)),e._impl=null,e._background=null,at(e,"_textLabel",hst,it(e)),at(e,"_placeholderLabel",_st,it(e)),at(e,"_returnType",fst,it(e)),at(e,"_string",dst,it(e)),at(e,"_tabIndex",pst,it(e)),at(e,"_backgroundImage",mst,it(e)),at(e,"_inputFlag",vst,it(e)),at(e,"_inputMode",gst,it(e)),at(e,"_maxLength",yst,it(e)),e._isLabelVisible=!1,e}Q(e,t);var n=e.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){BL.emitEvents(this.editingDidBegan,this),this.node.emit(Ast.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){BL.emitEvents(this.editingDidEnded,this),this.node.emit(Ast.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(t){t=this._updateLabelStringStyle(t,!0),this.string=t,BL.emitEvents(this.textChanged,t,this),this.node.emit(Ast.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){BL.emitEvents(this.editingReturn,this),this.node.emit(Ast.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(t){t.propagationStopped=!0},n._onTouchCancel=function(t){t.propagationStopped=!0},n._onTouchEnded=function(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(zC.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new e._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var t=this.node.getComponent(XQ);t||(t=this.node.addComponent(XQ)),t!==this._background&&(t.type=XQ.Type.SLICED,t.spriteFrame=this._backgroundImage,this._background=t,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var t=this._textLabel;if(!t){var e=this.node.getChildByName("TEXT_LABEL");e||((e=new kT("TEXT_LABEL")).layer=this.node.layer),(t=e.getComponent(oK))||(t=e.addComponent(oK)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=oK.Overflow.CLAMP,this._inputMode===fat.ANY?(t.verticalAlign=eK.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var t=this._placeholderLabel;if(!t){var e=this.node.getChildByName("PLACEHOLDER_LABEL");e||((e=new kT("PLACEHOLDER_LABEL")).layer=this.node.layer),(t=e.getComponent(oK))||(t=e.addComponent(oK)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=oK.Overflow.CLAMP,this._inputMode===fat.ANY?(t.verticalAlign=eK.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder},n._syncSize=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=t.anchorPoint,n.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)},n._updateLabels=function(){if(this._isLabelVisible){var t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}},n._updateString=function(t){var e=this._textLabel;if(e){var n=t;n&&(n=this._updateLabelStringStyle(n)),e.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(t,e){void 0===e&&(e=!1);var n,i=this._inputFlag;if(e||i!==dat.PASSWORD)i===dat.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():i===dat.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,(function(t){return t.toUpperCase()})):i===dat.INITIAL_CAPS_SENTENCE&&(t=(n=t).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=t.length,a=0;a<o;++a)r+="●";t=r}return t},n._registerEvent=function(){this.node.on(zC.TOUCH_START,this._onTouchBegan,this),this.node.on(zC.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(zC.TOUCH_START,this._onTouchBegan,this),this.node.off(zC.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.on(XQ.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.off(XQ.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(t){var e=this.node._uiProps.uiTransformComp,n=-e.anchorX*e.width,i=-e.anchorY*e.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),o.node.setPosition(n+2,i+t.height,o.node.position.z),this._inputMode===fat.ANY&&(o.verticalAlign=eK.TOP),o.enableWrapText=this._inputMode===fat.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.lineHeight=t.height,r.node.setPosition(n+2,i+t.height,r.node.position.z),this._inputMode===fat.ANY&&(r.verticalAlign=eK.TOP),r.enableWrapText=this._inputMode===fat.ANY)},n._resizeChildNodes=function(){var t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-t.width/2,t.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(t.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(t.contentSize),this._syncSize()},K(e,[{key:"string",get:function(){return this._string},set:function(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string=t,this._updateString(t)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}},{key:"textLabel",get:function(){return this._textLabel},set:function(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._ensureBackgroundSprite(),this._background.spriteFrame=t)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(t){this._inputFlag=t,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(t){this._returnType=t}},{key:"maxLength",get:function(){return this._maxLength},set:function(t){this._maxLength=t}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}}]),e}(Qu),xst._EditBoxImpl=Cst,xst.KeyboardReturnType=_at,xst.InputFlag=dat,xst.InputMode=fat,xst.EventType=Ast,st((ast=Sst).prototype,"string",[Sat,Aat],Object.getOwnPropertyDescriptor(ast.prototype,"string"),ast.prototype),st(ast.prototype,"placeholder",[Cat,bat],Object.getOwnPropertyDescriptor(ast.prototype,"placeholder"),ast.prototype),st(ast.prototype,"textLabel",[Tat,Eat,wat],Object.getOwnPropertyDescriptor(ast.prototype,"textLabel"),ast.prototype),st(ast.prototype,"placeholderLabel",[Pat,Iat,Rat],Object.getOwnPropertyDescriptor(ast.prototype,"placeholderLabel"),ast.prototype),st(ast.prototype,"backgroundImage",[Dat,Mat,Bat],Object.getOwnPropertyDescriptor(ast.prototype,"backgroundImage"),ast.prototype),st(ast.prototype,"inputFlag",[Oat,Nat,Lat],Object.getOwnPropertyDescriptor(ast.prototype,"inputFlag"),ast.prototype),st(ast.prototype,"inputMode",[Fat,zat,Vat],Object.getOwnPropertyDescriptor(ast.prototype,"inputMode"),ast.prototype),st(ast.prototype,"returnType",[kat,Gat,Uat],Object.getOwnPropertyDescriptor(ast.prototype,"returnType"),ast.prototype),st(ast.prototype,"maxLength",[Hat,jat],Object.getOwnPropertyDescriptor(ast.prototype,"maxLength"),ast.prototype),st(ast.prototype,"tabIndex",[Wat,qat],Object.getOwnPropertyDescriptor(ast.prototype,"tabIndex"),ast.prototype),sst=st(ast.prototype,"editingDidBegan",[Xat,yc,Yat,Kat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cst=st(ast.prototype,"textChanged",[Jat,yc,Qat,Zat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lst=st(ast.prototype,"editingDidEnded",[$at,yc,tst,est],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ust=st(ast.prototype,"editingReturn",[nst,yc,ist,rst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hst=st(ast.prototype,"_textLabel",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_st=st(ast.prototype,"_placeholderLabel",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fst=st(ast.prototype,"_returnType",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _at.DEFAULT}}),dst=st(ast.prototype,"_string",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pst=st(ast.prototype,"_tabIndex",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mst=st(ast.prototype,"_backgroundImage",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vst=st(ast.prototype,"_inputFlag",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dat.DEFAULT}}),gst=st(ast.prototype,"_inputMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fat.ANY}}),yst=st(ast.prototype,"_maxLength",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),ost=ast))||ost)||ost)||ost)||ost)||ost)||ost));"object"==typeof window&&"object"==typeof document&&(Fct._EditBoxImpl=Ist),c.internal.EditBox=Fct,function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"}(Dct||(Dct={})),ce(Dct),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(Mct||(Mct={})),ce(Mct),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(Bct||(Bct={})),ce(Bct),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(Oct||(Oct={})),ce(Oct),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(Nct||(Nct={})),ce(Nct),function(t){t[t.NONE=0]="NONE",t[t.FIXED_ROW=1]="FIXED_ROW",t[t.FIXED_COL=2]="FIXED_COL"}(Lct||(Lct={})),ce(Lct);var zct,Vct,kct,Gct,Uct,Hct,jct,Wct,qct,Xct,Yct,Kct,Jct,Qct,Zct,$ct,tlt,elt,nlt,ilt,rlt,olt,alt,slt=new Pn,clt=function(e){return t({Layout:e,LayoutComponent:e}),e}((Rst=fc("cc.Layout"),Dst=Ic(),Mst=pc(110),Bst=Tc(),Ost=dc(xX),Nst=Dc(),Lst=Oc(),Fst=Dc(),zst=Oc(),Vst=Xc(Dct),kst=kc(),Gst=Oc(),Ust=Xc(Mct),Hst=Dc(),jst=Oc(),Wst=Dc(),qst=Oc(),Xst=Xc(Bct),Yst=Oc(),Kst=Oc(),Jst=Oc(),Qst=Oc(),Zst=Oc(),$st=Oc(),tct=Oc(),ect=Xc(Oct),nct=Oc(),ict=Xc(Nct),rct=Oc(),oct=Xc(Lct),act=Dc(),sct=Oc(),cct=Dc(),lct=Oc(),uct=Oc(),Rst(hct=Dst(hct=Mst(hct=Bst(hct=Ost(hct=bc((Rct=Ict=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_resizeMode",fct,it(e)),at(e,"_layoutType",dct,it(e)),at(e,"_cellSize",pct,it(e)),at(e,"_startAxis",mct,it(e)),at(e,"_paddingLeft",vct,it(e)),at(e,"_paddingRight",gct,it(e)),at(e,"_paddingTop",yct,it(e)),at(e,"_paddingBottom",xct,it(e)),at(e,"_spacingX",Sct,it(e)),at(e,"_spacingY",Act,it(e)),at(e,"_verticalDirection",Cct,it(e)),at(e,"_horizontalDirection",bct,it(e)),at(e,"_constraint",Tct,it(e)),at(e,"_constraintNum",Ect,it(e)),at(e,"_affectedByScale",wct,it(e)),at(e,"_isAlign",Pct,it(e)),e._layoutSize=new ti(300,200),e._layoutDirty=!0,e._childrenDirty=!1,e._usefulLayoutObj=[],e._init=!1,e}Q(e,t);var n=e.prototype;return n.updateLayout=function(t){void 0===t&&(t=!1),(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var t=this.node._uiProps.uiTransformComp;t.contentSize.equals(ti.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){zB.on(FB.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(zC.SIZE_CHANGED,this._resized,this),this.node.on(zC.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(zC.CHILD_ADDED,this._childAdded,this),this.node.on(zC.CHILD_REMOVED,this._childRemoved,this),this.node.on(zC.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){zB.off(FB.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(zC.SIZE_CHANGED,this._resized,this),this.node.off(zC.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(zC.CHILD_ADDED,this._childAdded,this),this.node.off(zC.CHILD_REMOVED,this._childRemoved,this),this.node.off(zC.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e];n.on(zC.SIZE_CHANGED,this._doLayoutDirty,this),n.on(zC.TRANSFORM_CHANGED,this._transformDirty,this),n.on(zC.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(zC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e];n.off(zC.SIZE_CHANGED,this._doLayoutDirty,this),n.off(zC.TRANSFORM_CHANGED,this._transformDirty,this),n.off(zC.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(zC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(t){t.on(zC.SIZE_CHANGED,this._doLayoutDirty,this),t.on(zC.TRANSFORM_CHANGED,this._transformDirty,this),t.on(zC.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on(zC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(t){t.off(zC.SIZE_CHANGED,this._doLayoutDirty,this),t.off(zC.TRANSFORM_CHANGED,this._transformDirty,this),t.off(zC.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off(zC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(t,e,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===Nct.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*t+a*s,l=c-a*this._spacingX,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==Dct.GRID&&this._resizeMode===Mct.CHILDREN&&(m=(t-v-(p-1)*this._spacingX)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,A=S.scale,C=this._getUsedScaleValue(A.x),b=this._getUsedScaleValue(A.y);this._resizeMode===Mct.CHILDREN&&(x.width=m/C,this._layoutType===Dct.GRID&&(x.height=this._cellSize.height/b));var T=Math.abs(this._horizontalDirection-x.anchorX),E=x.width*C,w=x.height*b;w>_&&(f=Math.max(_,f),h=_||w,_=w),l+=a*(T*E+this._spacingX);var P=a*(1-T)*E;if(e){if(o>0)(d=y/o>0&&y%o==0)&&(h=_>w?_:h);else if(E>t-v)l>c+a*T*E&&(d=!0);else{var I=(1-this._horizontalDirection-r.x)*t,R=l+P+a*(a>0?this._paddingRight:this._paddingLeft);d=Math.abs(R)>Math.abs(I)}d&&(l=c+a*T*E,w!==_&&(h=_),u+=h+this._spacingY,h=_=w)}var D=n(S,x,u);i&&S.setPosition(l,D),l+=P}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()},n._doLayoutVertically=function(t,e,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===Oct.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*t+a*s,l=c-a*this._spacingY,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==Dct.GRID&&this._resizeMode===Mct.CHILDREN&&(m=(t-v-(p-1)*this._spacingY)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,A=S.scale,C=this._getUsedScaleValue(A.x),b=this._getUsedScaleValue(A.y);this._resizeMode===Mct.CHILDREN&&(x.height=m/b,this._layoutType===Dct.GRID&&(x.width=this._cellSize.width/C));var T=Math.abs(this._verticalDirection-x.anchorY),E=x.width*C,w=x.height*b;E>u&&(h=Math.max(u,h),_=u||E,u=E),l+=a*(T*w+this._spacingY);var P=a*(1-T)*w;if(e){if(o>0)(d=y/o>0&&y%o==0)&&(_=u>w?u:_);else if(w>t-v)l>c+a*T*w&&(d=!0);else{var I=(1-this._verticalDirection-r.y)*t,R=l+P+a*(a>0?this._paddingTop:this._paddingBottom);d=Math.abs(R)>Math.abs(I)}d&&(l=c+a*T*w,E!==u&&(_=u),f+=_+this._spacingX,_=u=E)}var D=n(S,x,f);i&&(S.getPosition(slt),S.setPosition(D,l,slt.z)),l+=P}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(t,e){var n=this,i=e.width,r=1,o=-t.y*e.height,a=this._paddingBottom;this._verticalDirection===Oct.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*e.height,a=this._paddingTop);var s=function(t,e,i){return o+r*(i+(1-e.anchorY)*e.height*n._getUsedScaleValue(t.scale.y)+a)},c=0;this._resizeMode===Mct.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-t.y*c,this._verticalDirection===Oct.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===Mct.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(t,e){var n=this,i=e.height,r=1,o=-t.x*e.width,a=this._paddingLeft;this._horizontalDirection===Nct.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*e.width,a=this._paddingRight);var s=function(t,e,i){return o+r*(i+(1-e.anchorX)*e.width*n._getUsedScaleValue(t.scale.x)+a)},c=0;this._resizeMode===Mct.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-t.x*c,this._horizontalDirection===Nct.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===Mct.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,n=t.contentSize;this.startAxis===Bct.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,n):this.startAxis===Bct.VERTICAL&&this._doLayoutGridAxisVertical(e,n)},n._getHorizontalBaseWidth=function(){var t=this._usefulLayoutObj,e=0,n=t.length;if(this._resizeMode===Mct.CONTAINER){for(var i=0;i<t.length;++i){var r=t[i],o=r.node.scale;e+=r.width*this._getUsedScaleValue(o.x)}e+=(n-1)*this._spacingX+this._getPaddingH()}else e=this.node._uiProps.uiTransformComp.width;return e},n._getVerticalBaseHeight=function(){var t=this._usefulLayoutObj,e=0,n=t.length;if(this._resizeMode===Mct.CONTAINER){for(var i=0;i<t.length;++i){var r=t[i],o=r.node.scale;e+=r.height*this._getUsedScaleValue(o.y)}e+=(n-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e},n._doLayout=function(){var t=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===Dct.HORIZONTAL){var e=this._getHorizontalBaseWidth();this._doLayoutHorizontally(e,!1,(function(e){return(t._isAlign?Pn.ZERO:e.position).y}),!0),this.node._uiProps.uiTransformComp.width=e}else if(this._layoutType===Dct.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(e){return(t._isAlign?Pn.ZERO:e.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===Dct.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(t){return this._affectedByScale?Math.abs(t):1},n._transformDirty=function(t){t&$g.SCALE&&t&$g.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==Dct.GRID||this._constraint===Lct.NONE||this._constraintNum<=0)return 0;var t=this._constraint===Lct.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===Bct.VERTICAL&&(t=this._constraint===Lct.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t},K(e,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(t){this._layoutType===Dct.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(t){this._layoutType===Dct.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(t){this._layoutType=t,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(t){this._layoutType!==Dct.NONE&&(this._resizeMode=t,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(t){this._layoutType!==Dct.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(t){this._constraint!==Lct.NONE&&this._constraintNum!==t&&(t<=0&&y("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(t){this._affectedByScale=t,this._doLayoutDirty()}}]),e}(Qu),Ict.Type=Dct,Ict.VerticalDirection=Oct,Ict.HorizontalDirection=Nct,Ict.ResizeMode=Mct,Ict.AxisDirection=Bct,Ict.Constraint=Lct,st((_ct=Rct).prototype,"alignHorizontal",[Nst,Lst],Object.getOwnPropertyDescriptor(_ct.prototype,"alignHorizontal"),_ct.prototype),st(_ct.prototype,"alignVertical",[Fst,zst],Object.getOwnPropertyDescriptor(_ct.prototype,"alignVertical"),_ct.prototype),st(_ct.prototype,"type",[Vst,kst,Gst],Object.getOwnPropertyDescriptor(_ct.prototype,"type"),_ct.prototype),st(_ct.prototype,"resizeMode",[Ust,Hst,jst],Object.getOwnPropertyDescriptor(_ct.prototype,"resizeMode"),_ct.prototype),st(_ct.prototype,"cellSize",[Wst,qst],Object.getOwnPropertyDescriptor(_ct.prototype,"cellSize"),_ct.prototype),st(_ct.prototype,"startAxis",[Xst,Yst],Object.getOwnPropertyDescriptor(_ct.prototype,"startAxis"),_ct.prototype),st(_ct.prototype,"paddingLeft",[Kst],Object.getOwnPropertyDescriptor(_ct.prototype,"paddingLeft"),_ct.prototype),st(_ct.prototype,"paddingRight",[Jst],Object.getOwnPropertyDescriptor(_ct.prototype,"paddingRight"),_ct.prototype),st(_ct.prototype,"paddingTop",[Qst],Object.getOwnPropertyDescriptor(_ct.prototype,"paddingTop"),_ct.prototype),st(_ct.prototype,"paddingBottom",[Zst],Object.getOwnPropertyDescriptor(_ct.prototype,"paddingBottom"),_ct.prototype),st(_ct.prototype,"spacingX",[$st],Object.getOwnPropertyDescriptor(_ct.prototype,"spacingX"),_ct.prototype),st(_ct.prototype,"spacingY",[tct],Object.getOwnPropertyDescriptor(_ct.prototype,"spacingY"),_ct.prototype),st(_ct.prototype,"verticalDirection",[ect,nct],Object.getOwnPropertyDescriptor(_ct.prototype,"verticalDirection"),_ct.prototype),st(_ct.prototype,"horizontalDirection",[ict,rct],Object.getOwnPropertyDescriptor(_ct.prototype,"horizontalDirection"),_ct.prototype),st(_ct.prototype,"constraint",[oct,act,sct],Object.getOwnPropertyDescriptor(_ct.prototype,"constraint"),_ct.prototype),st(_ct.prototype,"constraintNum",[cct,lct],Object.getOwnPropertyDescriptor(_ct.prototype,"constraintNum"),_ct.prototype),st(_ct.prototype,"affectedByScale",[uct],Object.getOwnPropertyDescriptor(_ct.prototype,"affectedByScale"),_ct.prototype),fct=st(_ct.prototype,"_resizeMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mct.NONE}}),dct=st(_ct.prototype,"_layoutType",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dct.NONE}}),pct=st(_ct.prototype,"_cellSize",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(40,40)}}),mct=st(_ct.prototype,"_startAxis",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bct.HORIZONTAL}}),vct=st(_ct.prototype,"_paddingLeft",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gct=st(_ct.prototype,"_paddingRight",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yct=st(_ct.prototype,"_paddingTop",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xct=st(_ct.prototype,"_paddingBottom",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sct=st(_ct.prototype,"_spacingX",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Act=st(_ct.prototype,"_spacingY",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cct=st(_ct.prototype,"_verticalDirection",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oct.TOP_TO_BOTTOM}}),bct=st(_ct.prototype,"_horizontalDirection",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nct.LEFT_TO_RIGHT}}),Tct=st(_ct.prototype,"_constraint",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lct.NONE}}),Ect=st(_ct.prototype,"_constraintNum",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),wct=st(_ct.prototype,"_affectedByScale",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pct=st(_ct.prototype,"_isAlign",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hct=_ct))||hct)||hct)||hct)||hct)||hct)||hct));c.Layout=clt,function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(alt||(alt={})),oe(alt);var llt,ult,hlt,_lt,flt,dlt,plt,mlt,vlt,glt,ylt,xlt,Slt,Alt,Clt,blt,Tlt,Elt,wlt,Plt,Ilt,Rlt,Dlt,Mlt,Blt=function(e){return t({ProgressBar:e,ProgressBarComponent:e}),e}((zct=fc("cc.ProgressBar"),Vct=Ic(),kct=pc(110),Gct=Tc(),Uct=dc(xX),Hct=Xc(XQ),jct=Oc(),Wct=Xc(alt),qct=Oc(),Xct=Oc(),Yct=Nc(),Kct=Oc(),Jct=Oc(),zct(Qct=Vct(Qct=kct(Qct=Gct(Qct=Uct((olt=rlt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_barSprite",$ct,it(e)),at(e,"_mode",tlt,it(e)),at(e,"_totalLength",elt,it(e)),at(e,"_progress",nlt,it(e)),at(e,"_reverse",ilt,it(e)),e}Q(e,t);var n=e.prototype;return n._initBarSprite=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,r=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===XQ.FillType.RADIAL&&(this._mode=alt.FILLED),this._mode===alt.HORIZONTAL?this.totalLength=r.width:this._mode===alt.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){var o=-n.width*i.x;t.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=t._uiProps.uiTransformComp,n=e.anchorPoint,i=e.contentSize,r=t.getPosition(),o=new Xn(0,.5),a=cn(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case alt.HORIZONTAL:this._reverse&&(o=new Xn(1,.5)),c=new ti(s,i.height),l=this._totalLength,u=i.height;break;case alt.VERTICAL:o=this._reverse?new Xn(.5,1):new Xn(.5,0),c=new ti(i.width,s),l=i.width,u=this._totalLength}if(this._mode===alt.FILLED)this._barSprite.type!==XQ.Type.FILLED?y("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==XQ.Type.FILLED){var h=o.x-n.x,_=o.y-n.y,f=new Pn(l*h,u*_,0);t.setPosition(r.x+f.x,r.y+f.y,r.z),e.setAnchorPoint(o),e.setContentSize(c)}else y("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},K(e,[{key:"barSprite",get:function(){return this._barSprite},set:function(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){var e=this._barSprite.node;if(!e)return;var n=e._uiProps.uiTransformComp.contentSize;this._mode===alt.HORIZONTAL?this.totalLength=n.width:this._mode===alt.VERTICAL?this.totalLength=n.height:this._mode===alt.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(t){this._mode===alt.FILLED&&(t=cn(t)),this._totalLength=t,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),e}(Qu),rlt.Mode=alt,st((Zct=olt).prototype,"barSprite",[Hct,jct],Object.getOwnPropertyDescriptor(Zct.prototype,"barSprite"),Zct.prototype),st(Zct.prototype,"mode",[Wct,qct],Object.getOwnPropertyDescriptor(Zct.prototype,"mode"),Zct.prototype),st(Zct.prototype,"totalLength",[Xct],Object.getOwnPropertyDescriptor(Zct.prototype,"totalLength"),Zct.prototype),st(Zct.prototype,"progress",[Yct,Vc,Kct],Object.getOwnPropertyDescriptor(Zct.prototype,"progress"),Zct.prototype),st(Zct.prototype,"reverse",[Jct],Object.getOwnPropertyDescriptor(Zct.prototype,"reverse"),Zct.prototype),$ct=st(Zct.prototype,"_barSprite",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tlt=st(Zct.prototype,"_mode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return alt.HORIZONTAL}}),elt=st(Zct.prototype,"_totalLength",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nlt=st(Zct.prototype,"_progress",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),ilt=st(Zct.prototype,"_reverse",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qct=Zct))||Qct)||Qct)||Qct)||Qct)||Qct));c.ProgressBar=Blt;var Olt,Nlt=new Pn,Llt=new Pn,Flt=new Pn,zlt=new Xn,Vlt=new En,klt=new Xn;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(Olt||(Olt={})),ce(Olt);var Glt,Ult=function(e){return t({ScrollBar:e,ScrollBarComponent:e}),e}((llt=fc("cc.ScrollBar"),ult=Ic(),hlt=pc(110),_lt=Tc(),flt=dc(xX),dlt=Xc(XQ),plt=kc(),mlt=Oc(),vlt=Xc(Olt),glt=kc(),ylt=Oc(),xlt=kc(),Slt=Oc(),Alt=kc(),Clt=Oc(),llt(blt=ult(blt=hlt(blt=_lt(blt=flt((Mlt=Dlt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_scrollView",Elt,it(e)),at(e,"_handle",wlt,it(e)),at(e,"_direction",Plt,it(e)),at(e,"_enableAutoHide",Ilt,it(e)),at(e,"_autoHideTime",Rlt,it(e)),e._touching=!1,e._opacity=255,e._autoHideRemainingTime=0,e}Q(e,t);var n=e.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(t){if(this._scrollView){var e=this._scrollView.content;if(e){var n=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=klt;u.set(0,0),this._direction===Olt.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=t.x,this._convertToScrollViewSpace(u,e),c=-u.x):this._direction===Olt.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=t.y,this._convertToScrollViewSpace(u,e),c=-u.y);var h=this._calculateLength(o,a,l,s),_=klt;this._calculatePosition(_,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}},n.setScrollView=function(t){this._scrollView=t},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var t=this._scrollView.content;if(t){var e=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var t=this.node.getComponent(XQ);t&&(this._opacity=t.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(t){this._processAutoHide(t)},n._convertToScrollViewSpace=function(t,e){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp;if(n&&i){Nlt.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(Nlt,Llt);var r=n.convertToNodeSpaceAR(Llt);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,t.set(r.x,r.y)}else t.set(Xn.ZERO)},n._setOpacity=function(t){if(this._handle){var e=this.node.getComponent(XQ);e&&(Vlt.set(e.color),Vlt.a=t,e.color=Vlt),(e=this._handle.getComponent(XQ))&&(Vlt.set(e.color),Vlt.a=t,e.color=Vlt)}},n._updateHandlerPosition=function(t){if(this._handle){var e=Flt;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}},n._fixupHandlerPosition=function(t){var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;Pn.set(Nlt,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(Nlt,Llt),s=t;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===Olt.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===Olt.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(t,e){return t.width<=e.width&&this._direction===Olt.HORIZONTAL||t.height<=e.height&&this._direction===Olt.VERTICAL},n._calculateLength=function(t,e,n,i){var r=t;return i&&(r+=20*(i>0?i:-i)),n*(e/r)},n._calculatePosition=function(t,e,n,i,r,o,a){var s=e-n;o&&(s+=Math.abs(o));var c=0;s&&(c=cn(c=r/s));var l=(i-a)*c;this._direction===Olt.VERTICAL?t.set(0,l):t.set(l,0)},n._updateLength=function(t){if(this._handle){var e=this._handle.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint;i.x===zlt.x&&i.y===zlt.y||e.setAnchorPoint(zlt),this._direction===Olt.HORIZONTAL?e.setContentSize(t,n.height):e.setContentSize(n.width,t)}},n._processAutoHide=function(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var e=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(e)}},K(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t,this.onScroll(Xn.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this.onScroll(Xn.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(t){this._autoHideTime!==t&&(this._autoHideTime=t)}}]),e}(Qu),Dlt.Direction=Olt,st((Tlt=Mlt).prototype,"handle",[dlt,plt,mlt],Object.getOwnPropertyDescriptor(Tlt.prototype,"handle"),Tlt.prototype),st(Tlt.prototype,"direction",[vlt,glt,ylt],Object.getOwnPropertyDescriptor(Tlt.prototype,"direction"),Tlt.prototype),st(Tlt.prototype,"enableAutoHide",[xlt,Slt],Object.getOwnPropertyDescriptor(Tlt.prototype,"enableAutoHide"),Tlt.prototype),st(Tlt.prototype,"autoHideTime",[Alt,Clt],Object.getOwnPropertyDescriptor(Tlt.prototype,"autoHideTime"),Tlt.prototype),Elt=st(Tlt.prototype,"_scrollView",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wlt=st(Tlt.prototype,"_handle",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Plt=st(Tlt.prototype,"_direction",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Olt.HORIZONTAL}}),Ilt=st(Tlt.prototype,"_enableAutoHide",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Rlt=st(Tlt.prototype,"_autoHideTime",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),blt=Tlt))||blt)||blt)||blt)||blt)||blt));c.ScrollBar=Ult;var Hlt,jlt,Wlt,qlt,Xlt,Ylt,Klt,Jlt,Qlt,Zlt,$lt,tut,eut,nut,iut,rut,out,aut,sut,cut,lut,uut,hut,_ut,fut,dut,put,mut,vut,gut,yut,xut,Sut,Aut,Cut,but,Tut,Eut,wut,Put,Iut,Rut,Dut,Mut,But,Out,Nut,Lut,Fut=t("ViewGroup",fc("cc.ViewGroup")(Glt=pc(110)(Glt=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(Qu))||Glt)||Glt);c.ViewGroup=Fut;var zut,Vut=1e-4,kut=new Pn,Gut=new Pn,Uut=new Xn,Hut=new Xn,jut=function(){return(new Date).getMilliseconds()},Wut={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(zut||(zut={}));var qut,Xut,Yut,Kut,Jut,Qut,Zut,$ut,tht,eht,nht,iht,rht,oht,aht,sht,cht,lht,uht,hht,_ht,fht=function(e){return t({ScrollView:e,ScrollViewComponent:e}),e}((Hlt=fc("cc.ScrollView"),jlt=Ic(),Wlt=pc(110),qlt=Tc(),Xlt=dc(xX),Ylt=Nc(),Klt=kc(),Jlt=Oc(),Qlt=Nc(),Zlt=kc(),$lt=Oc(),tut=kc(),eut=Oc(),nut=kc(),iut=Oc(),rut=Xc(kT),out=kc(),aut=Oc(),sut=kc(),cut=Oc(),lut=Xc(Ult),uut=kc(),hut=Oc(),_ut=kc(),fut=Oc(),dut=Xc(Ult),put=kc(),mut=Oc(),vut=kc(),gut=Oc(),yut=Xc([BL]),xut=kc(),Sut=Oc(),Hlt(Aut=jlt(Aut=Wlt(Aut=qlt(Aut=Xlt((Lut=Nut=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"bounceDuration",but,it(e)),at(e,"brake",Tut,it(e)),at(e,"elastic",Eut,it(e)),at(e,"inertia",wut,it(e)),at(e,"horizontal",Put,it(e)),at(e,"vertical",Iut,it(e)),at(e,"cancelInnerEvents",Rut,it(e)),at(e,"scrollEvents",Dut,it(e)),e._autoScrolling=!1,e._scrolling=!1,at(e,"_content",Mut,it(e)),at(e,"_horizontalScrollBar",But,it(e)),at(e,"_verticalScrollBar",Out,it(e)),e._topBoundary=0,e._bottomBoundary=0,e._leftBoundary=0,e._rightBoundary=0,e._touchMoveDisplacements=[],e._touchMoveTimeDeltas=[],e._touchMovePreviousTimestamp=0,e._touchMoved=!1,e._autoScrollAttenuate=!1,e._autoScrollStartPosition=new Pn,e._autoScrollTargetDelta=new Pn,e._autoScrollTotalTime=0,e._autoScrollAccumulatedTime=0,e._autoScrollCurrentlyOutOfBoundary=!1,e._autoScrollBraking=!1,e._autoScrollBrakingStartPosition=new Pn,e._outOfBoundaryAmount=new Pn,e._outOfBoundaryAmountDirty=!0,e._stopMouseWheel=!1,e._mouseWheelEventElapsedTime=0,e._isScrollEndedWithThresholdEventFired=!1,e._scrollEventEmitMask=0,e._isBouncing=!1,e._contentPos=new Pn,e._deltaPos=new Pn,e}Q(e,t);var n=e.prototype;return n.scrollToBottom=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n,!0)},n.scrollToTop=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToTopLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToTopRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToBottomLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToBottomRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Xn(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToOffset=function(t,e,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new Xn(0,0);0===i.x?r.x=0:r.x=t.x/i.x,0===i.y?r.y=1:r.y=(i.y-t.y)/i.y,this.scrollTo(r,e,n)},n.getScrollOffset=function(){var t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new Xn(e,t)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return Xn.ZERO;var t=this._content._uiProps.uiTransformComp.contentSize,e=t.width-this.view.width,n=t.height-this.view.height;return new Xn(e=e>=0?e:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Xn(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==n):this._moveContent(i)},n.scrollTo=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Xn(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)},n.scrollToPercentVertical=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Xn(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(t){this._setContentPosition(t)},n._setContentPosition=function(t){if(this._content){var e=this._getContentPosition();Math.abs(t.x-e.x)<Vut&&Math.abs(t.y-e.y)<Vut||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):Pn.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return Vut},n.start=function(){this._calculateBoundary(),this._content&&zB.once(FB.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(zC.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(zC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(zC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(zC.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(t){this._autoScrolling&&this._processAutoScrolling(t)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(zC.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(zC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(zC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(zC.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(zC.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(zC.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(zC.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(zC.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(zC.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(zC.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(zC.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(zC.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(zC.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(zC.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(t,e){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(t,e)){var n=new Pn,i=t.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}},n._onTouchBegan=function(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))},n._onTouchMoved=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){var n=t.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(Uut);if(i.subtract(n.getUIStartLocation(Hut)),i.length()>7&&!this._touchMoved&&t.target!==this.node){var r=new UR(t.getTouches(),t.bubbles,OE.TOUCH_CANCEL);r.touch=t.touch,r.simulate=!0,t.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}}},n._onTouchEnded=function(t,e){if(this.enabledInHierarchy&&this._content&&t&&!this._hasNestedViewGroup(t,e)){this._dispatchEvent(zut.TOUCH_UP);var n=t.touch;this._handleReleaseLogic(n),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}},n._onTouchCancelled=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){var n=t.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(t)}},n._calculateBoundary=function(){if(this._content&&this.view){var t=this._content.getComponent(clt);t&&t.enabledInHierarchy&&t.updateLayout();var e=this.view,n=e.width*e.anchorX,i=e.height*e.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}},n._hasNestedViewGroup=function(t,e){if(!t||t.eventPhase!==FR.CAPTURING_PHASE)return!1;if(e)for(var n,i=ot(e);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!t.target||!t.target.getComponent(Fut));if(r.getComponent(Fut))return!0}return!1},n._startInertiaScroll=function(t){var e=new Pn(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)},n._calculateAttenuatedFactor=function(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))},n._startAttenuatingAutoScroll=function(t,e){var n=t.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=t.length(),u=n.length()/l;if(n.add(t),this.brake>0&&u>7){u=Math.sqrt(u);var h=t.clone();h.multiplyScalar(u),n.set(h),n.add(t)}var _=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(n,_,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(t){return Math.sqrt(Math.sqrt(t/5))},n._startAutoScroll=function(t,e,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,Pn.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(Pn.ZERO,Vut)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var t=new Pn,e=0;if((e=this._touchMoveTimeDeltas.reduce((function(t,e){return t+e}),e))<=0||e>=.5)t.set(Pn.ZERO);else{var n=new Pn;n=this._touchMoveDisplacements.reduce((function(t,e){return t.add(e),t}),n),t.set(n.x*(1-this.brake)/e,n.y*(1-this.brake)/e,n.z)}return t},n._flattenVectorByDirection=function(t){var e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e},n._moveContent=function(t,e){var n=this._flattenVectorByDirection(t);kut.set(this._getContentPosition()),kut.add(n),kut.set(Math.round(1e4*kut.x)*Vut,Math.round(1e4*kut.y)*Vut,kut.z),this._setContentPosition(kut);var i=this._getHowMuchOutOfBoundary();Uut.set(i.x,i.y),this._updateScrollBar(Uut),this.elastic&&e&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height},n._getHowMuchOutOfBoundary=function(t){if((t=t||new Pn).equals(Pn.ZERO,Vut)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var e=new Pn,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+t.x>this._leftBoundary?e.x=this._leftBoundary-(n+t.x):i+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(i+t.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+t.y<this._topBoundary?e.y=this._topBoundary-(r+t.y):o+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(o+t.y)),t.equals(Pn.ZERO,Vut)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e},n._updateScrollBar=function(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(t){if(t===zut.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===zut.SCROLL_TO_TOP||t===zut.SCROLL_TO_BOTTOM||t===zut.SCROLL_TO_LEFT||t===zut.SCROLL_TO_RIGHT){var e=1<<Wut[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}BL.emitEvents(this.scrollEvents,this,Wut[t]),this.node.emit(t,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var t=this._getHowMuchOutOfBoundary();kut.set(this._getContentPosition()),kut.add(t),this._content.setPosition(kut),this._updateScrollBar(Xn.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(t){t.eventPhase===FR.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)},n._processDeltaMove=function(t){this._scrollChildren(t),this._gatherTouchMove(t)},n._handleMoveLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(zut.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(t,e){var n=this.node._uiProps.uiTransformComp,i=new Pn;n&&(e.getUILocation(Uut),e.getUIPreviousLocation(Hut),kut.set(Uut.x,Uut.y,0),Gut.set(Hut.x,Hut.y,0),n.convertToNodeSpaceAR(kut,kut),n.convertToNodeSpaceAR(Gut,Gut),Pn.subtract(i,kut,Gut)),t.set(i)},n._scrollChildren=function(t){this._clampDelta(t);var e,n=t;this.elastic&&(e=this._getHowMuchOutOfBoundary(),n.x*=0===e.x?1:.5,n.y*=0===e.y?1:.5),this.elastic||(e=this._getHowMuchOutOfBoundary(n),n.add(e));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||Pn.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=zut.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=zut.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=zut.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=zut.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(zut.SCROLL_BEGAN)),this._dispatchEvent(zut.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(zut.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=jut(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(t){if(this._content&&this.view){var e=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<e.width&&(t.x=0),n.height<e.height&&(t.y=0)}},n._gatherTouchMove=function(t){var e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);var n=jut();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var t=this._getHowMuchOutOfBoundary();if(this._clampDelta(t),t.equals(Pn.ZERO,Vut))return!1;var e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(zut.BOUNCE_TOP),t.y<0&&this._dispatchEvent(zut.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(zut.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(zut.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var t=this._calculateTouchMoveVelocity();!t.equals(kut,Vut)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(Pn.ZERO,Vut)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(t){var e=this._isNecessaryAutoScrollBrake(),n=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=Vut;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(zut.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),e&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(Pn.ZERO,Vut)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(zut.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(zut.SCROLL_ENDED))},n._checkMouseWheel=function(t){if(!this._getHowMuchOutOfBoundary().equals(Pn.ZERO,Vut))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(zut.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(zut.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(t){var e=t.anchor,n=t.applyToHorizontal,i=t.applyToVertical;this._calculateBoundary(),e.clampf(Xn.ZERO,Xn.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new Pn;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*e.x),i&&(s=c.height-l.height,a.y=r-s*e.y)}return a},n._moveContentToTopLeft=function(t){var e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;var n=new Pn,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<t.height&&(i=o.height-t.height,n.y=e-i),o.width<t.width&&(i=o.width-t.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(t){t===$g.SCALE&&this._calculateBoundary()},K(e,[{key:"content",get:function(){return this._content},set:function(t){if(this._content!==t){var e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):w(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Xn.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Xn.ZERO)))}},{key:"view",get:function(){var t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}}]),e}(Fut),Nut.EventType=zut,but=st((Cut=Lut).prototype,"bounceDuration",[yc,Ylt,Klt,Jlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Tut=st(Cut.prototype,"brake",[yc,Qlt,Zlt,$lt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Eut=st(Cut.prototype,"elastic",[yc,tut,eut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wut=st(Cut.prototype,"inertia",[yc,nut,iut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),st(Cut.prototype,"content",[rut,out,aut],Object.getOwnPropertyDescriptor(Cut.prototype,"content"),Cut.prototype),Put=st(Cut.prototype,"horizontal",[yc,sut,cut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),st(Cut.prototype,"horizontalScrollBar",[lut,uut,hut],Object.getOwnPropertyDescriptor(Cut.prototype,"horizontalScrollBar"),Cut.prototype),Iut=st(Cut.prototype,"vertical",[yc,_ut,fut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),st(Cut.prototype,"verticalScrollBar",[dut,put,mut],Object.getOwnPropertyDescriptor(Cut.prototype,"verticalScrollBar"),Cut.prototype),Rut=st(Cut.prototype,"cancelInnerEvents",[yc,vut,gut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Dut=st(Cut.prototype,"scrollEvents",[yut,yc,xut,Sut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mut=st(Cut.prototype,"_content",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),But=st(Cut.prototype,"_horizontalScrollBar",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Out=st(Cut.prototype,"_verticalScrollBar",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Aut=Cut))||Aut)||Aut)||Aut)||Aut)||Aut));c.ScrollView=fht;var dht,pht=new Pn;!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(dht||(dht={})),ce(dht);var mht,vht,ght,yht,xht,Sht,Aht,Cht,bht,Tht,Eht,wht,Pht,Iht,Rht,Dht,Mht,Bht,Oht,Nht,Lht=function(e){return t({Slider:e,SliderComponent:e}),e}((qut=fc("cc.Slider"),Xut=Ic(),Yut=pc(110),Kut=Tc(),Jut=dc(xX),Qut=Xc(XQ),Zut=Oc(),$ut=Xc(dht),tht=Oc(),eht=Nc(),nht=Oc(),iht=Xc([BL]),rht=Oc(),qut(oht=Xut(oht=Yut(oht=Kut(oht=Jut((_ht=hht=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"slideEvents",sht,it(e)),at(e,"_handle",cht,it(e)),at(e,"_direction",lht,it(e)),at(e,"_progress",uht,it(e)),e._offset=new Pn,e._dragging=!1,e._touchHandle=!1,e._handleLocalPos=new Pn,e._touchPos=new Pn,e}Q(e,t);var n=e.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(zC.TOUCH_START,this._onTouchBegan,this),this.node.on(zC.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(zC.TOUCH_END,this._onTouchEnded,this),this.node.on(zC.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(zC.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(zC.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(zC.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(zC.TOUCH_START,this._onTouchBegan,this),this.node.off(zC.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(zC.TOUCH_END,this._onTouchEnded,this),this.node.off(zC.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(zC.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(zC.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(zC.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(t){if(t&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var e=t.touch.getUILocation();Pn.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}},n._onTouchBegan=function(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)},n._onTouchMoved=function(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)},n._onTouchEnded=function(t){this._dragging=!1,this._touchHandle=!1,this._offset=new Pn,t&&(t.propagationStopped=!0)},n._onTouchCancelled=function(t){this._dragging=!1,t&&(t.propagationStopped=!0)},n._handleSliderLogic=function(t){this._updateProgress(t),this._emitSlideEvent()},n._emitSlideEvent=function(){BL.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(t){if(this._handle&&t){var e=t.getUILocation();Pn.set(this._touchPos,e.x,e.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,pht);this.direction===dht.Horizontal?this.progress=cn(.5+(i.x-this._offset.x)/n.width):this.progress=cn(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var t=this.node._uiProps.uiTransformComp;this._direction===dht.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){var n=this._handle.node.position;this._direction===dht.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},K(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}}]),e}(Qu),hht.Direction=dht,st((aht=_ht).prototype,"handle",[Qut,Zut],Object.getOwnPropertyDescriptor(aht.prototype,"handle"),aht.prototype),st(aht.prototype,"direction",[$ut,tht],Object.getOwnPropertyDescriptor(aht.prototype,"direction"),aht.prototype),st(aht.prototype,"progress",[Vc,eht,nht],Object.getOwnPropertyDescriptor(aht.prototype,"progress"),aht.prototype),sht=st(aht.prototype,"slideEvents",[iht,yc,rht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cht=st(aht.prototype,"_handle",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lht=st(aht.prototype,"_direction",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dht.Horizontal}}),uht=st(aht.prototype,"_progress",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),oht=aht))||oht)||oht)||oht)||oht)||oht));function Fht(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(e))}c.Slider=Lht,function(t){t.TOGGLE="toggle"}(Nht||(Nht={}));var zht,Vht,kht,Ght,Uht,Hht,jht,Wht,qht,Xht,Yht,Kht,Jht=function(e){return t({Toggle:e,ToggleComponent:e}),e}((mht=fc("cc.Toggle"),vht=Ic(),ght=pc(110),yht=Tc(),xht=dc(xX),Sht=kc(),Aht=Oc(),Cht=Xc(XQ),bht=kc(),Tht=Oc(),Eht=Xc([BL]),wht=Oc(),mht(Pht=vht(Pht=ght(Pht=yht(Pht=xht((Oht=Bht=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"checkEvents",Rht,it(e)),at(e,"_isChecked",Dht,it(e)),at(e,"_checkMark",Mht,it(e)),e}Q(e,t);var n=e.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(t,e){if(void 0===e&&(e=!0),this._isChecked!=t){this._isChecked=t;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(t||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(t){this._set(t,!1)},n.onEnable=function(){t.prototype.onEnable.call(this),this.playEffect(),this.node.on(e.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(e.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var t=this._toggleContainer;t&&t.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(e.EventType.TOGGLE,this),this.checkEvents&&BL.emitEvents(this.checkEvents,this)},K(e,[{key:"isChecked",get:function(){return this._isChecked},set:function(t){this._set(t)}},{key:"checkMark",get:function(){return this._checkMark},set:function(t){this._checkMark!==t&&(this._checkMark=t)}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var t=this.node.parent;return c.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}}]),e}(hat),Bht.EventType=Fht(Nht,lat),st((Iht=Oht).prototype,"isChecked",[Sht,Aht],Object.getOwnPropertyDescriptor(Iht.prototype,"isChecked"),Iht.prototype),st(Iht.prototype,"checkMark",[Cht,bht,Tht],Object.getOwnPropertyDescriptor(Iht.prototype,"checkMark"),Iht.prototype),Rht=st(Iht.prototype,"checkEvents",[Eht,yc,wht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dht=st(Iht.prototype,"_isChecked",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Mht=st(Iht.prototype,"_checkMark",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pht=Iht))||Pht)||Pht)||Pht)||Pht)||Pht));c.Toggle=Jht;var Qht,Zht,$ht,t_t,e_t,n_t,i_t,r_t,o_t,a_t,s_t,c_t,l_t,u_t,h_t,__t,f_t,d_t,p_t,m_t,v_t,g_t,y_t,x_t,S_t,A_t,C_t,b_t,T_t,E_t,w_t,P_t,I_t,R_t,D_t,M_t,B_t,O_t,N_t,L_t,F_t,z_t,V_t,k_t,G_t,U_t=function(e){return t({ToggleContainer:e,ToggleContainerComponent:e}),e}((zht=fc("cc.ToggleContainer"),Vht=Ic(),kht=pc(110),Ght=Tc(),Uht=Oc(),Hht=Xc([BL]),jht=Oc(),zht(Wht=Vht(Wht=kht(Wht=Ght(Wht=bc((Kht=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_allowSwitchOff",Xht,it(e)),at(e,"checkEvents",Yht,it(e)),e}Q(e,t);var n=e.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(zC.CHILD_ADDED,this.ensureValidState,this),this.node.on(zC.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(zC.CHILD_ADDED,this.ensureValidState,this),this.node.off(zC.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(t){return t.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(t){return t.isChecked}))},n.notifyToggleCheck=function(t,e){if(void 0===e&&(e=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==t&&(e?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&c.Component.EventHandler.emitEvents(this.checkEvents,t)}},n.ensureValidState=function(){var t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){var e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},K(e,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(t){this._allowSwitchOff=t}},{key:"toggleItems",get:function(){return this.node.children.map((function(t){var e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}}]),e}(Qu),Xht=st((qht=Kht).prototype,"_allowSwitchOff",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),st(qht.prototype,"allowSwitchOff",[Uht],Object.getOwnPropertyDescriptor(qht.prototype,"allowSwitchOff"),qht.prototype),Yht=st(qht.prototype,"checkEvents",[Hht,yc,jht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wht=qht))||Wht)||Wht)||Wht)||Wht)||Wht));c.ToggleContainer=U_t;var H_t,j_t,W_t=new Xn;function q_t(t){return t instanceof mD?GB:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:ti.ZERO}function X_t(t,e,n,i){t.parent?W_t.set(t.parent.getScale().x,t.parent.getScale().y):W_t.set(0,0);for(var r=W_t.x,o=W_t.y,a=0,s=0,c=t.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===e)break;c?W_t.set(c.getScale().x,c.getScale().y):W_t.set(0,0);var u=W_t.x,h=W_t.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(H_t||(H_t={})),ce(H_t),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(j_t||(j_t={}));var Y_t,K_t,J_t,Q_t,Z_t,$_t,tft,eft,nft,ift,rft,oft,aft,sft,cft,lft,uft,hft,_ft,fft=j_t.TOP|j_t.BOT,dft=j_t.LEFT|j_t.RIGHT,pft=function(e){return t({Widget:e,WidgetComponent:e}),e}((Qht=fc("cc.Widget"),Zht=Ic(),$ht=pc(110),t_t=Tc(),e_t=dc(xX),n_t=Xc(kT),i_t=Oc(),r_t=Oc(),o_t=Oc(),a_t=Oc(),s_t=Oc(),c_t=Oc(),l_t=Oc(),u_t=Dc(),h_t=Dc(),__t=Oc(),f_t=Oc(),d_t=Oc(),p_t=Oc(),m_t=Oc(),v_t=Oc(),g_t=Xc(H_t),y_t=Oc(),Qht(x_t=Zht(x_t=$ht(x_t=t_t(x_t=e_t(x_t=bc((G_t=k_t=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._lastPos=new Pn,e._lastSize=new ti,e._dirty=!0,e._hadAlignOnce=!1,at(e,"_alignFlags",A_t,it(e)),at(e,"_target",C_t,it(e)),at(e,"_left",b_t,it(e)),at(e,"_right",T_t,it(e)),at(e,"_top",E_t,it(e)),at(e,"_bottom",w_t,it(e)),at(e,"_horizontalCenter",P_t,it(e)),at(e,"_verticalCenter",I_t,it(e)),at(e,"_isAbsLeft",R_t,it(e)),at(e,"_isAbsRight",D_t,it(e)),at(e,"_isAbsTop",M_t,it(e)),at(e,"_isAbsBottom",B_t,it(e)),at(e,"_isAbsHorizontalCenter",O_t,it(e)),at(e,"_isAbsVerticalCenter",N_t,it(e)),at(e,"_originalWidth",L_t,it(e)),at(e,"_originalHeight",F_t,it(e)),at(e,"_alignMode",z_t,it(e)),at(e,"_lockFlags",V_t,it(e)),e}Q(e,t);var n=e.prototype;return n.updateAlignment=function(){c._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),c._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){c._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(zC.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(zC.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(zC.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(zC.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(zC.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(zC.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(zC.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(zC.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(t,e){if((this._alignFlags&t)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:GB;this.isAlignLeft&&t===j_t.LEFT?this._left=e?this._left*r.width:this._left/r.width:this.isAlignRight&&t===j_t.RIGHT?this._right=e?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&t===j_t.CENTER?this._horizontalCenter=e?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&t===j_t.TOP?this._top=e?this._top*r.height:this._top/r.height:this.isAlignBottom&&t===j_t.BOT?this._bottom=e?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&t===j_t.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var t=this._target||this.node.parent;t&&t.getComponent(xX)&&(t.on(zC.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.on(zC.SIZE_CHANGED,this._setDirtyByMode,this),t.on(zC.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var t=this._target||this.node.parent;t&&(t.off(zC.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(zC.SIZE_CHANGED,this._setDirtyByMode,this),t.off(zC.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(t){var e=this._target||t;e&&(e.off(zC.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(zC.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===H_t.ALWAYS&&this._recursiveDirty()},n._setAlign=function(t,e){if(e!==(this._alignFlags&t)>0){var n=(t&dft)>0,i=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~t)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},K(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&j_t.TOP)>0},set:function(t){this._setAlign(j_t.TOP,t),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&j_t.BOT)>0},set:function(t){this._setAlign(j_t.BOT,t),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&j_t.LEFT)>0},set:function(t){this._setAlign(j_t.LEFT,t),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&j_t.RIGHT)>0},set:function(t){this._setAlign(j_t.RIGHT,t),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&j_t.MID)>0},set:function(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=j_t.MID):this._alignFlags&=~j_t.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&j_t.CENTER)>0},set:function(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=j_t.CENTER):this._alignFlags&=~j_t.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&dft)===dft}},{key:"isStretchHeight",get:function(){return(this._alignFlags&fft)===fft}},{key:"top",get:function(){return this._top},set:function(t){this._top=t,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(t){this._bottom=t,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(t){this._left=t,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(t){this._right=t,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(t){this._horizontalCenter=t,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(t){this._verticalCenter=t,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(j_t.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(j_t.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(j_t.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(j_t.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(j_t.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(j_t.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(t){this._alignMode=t,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}}]),e}(Qu),k_t.AlignMode=H_t,st((S_t=G_t).prototype,"target",[n_t,i_t],Object.getOwnPropertyDescriptor(S_t.prototype,"target"),S_t.prototype),st(S_t.prototype,"isAlignTop",[r_t],Object.getOwnPropertyDescriptor(S_t.prototype,"isAlignTop"),S_t.prototype),st(S_t.prototype,"isAlignBottom",[o_t],Object.getOwnPropertyDescriptor(S_t.prototype,"isAlignBottom"),S_t.prototype),st(S_t.prototype,"isAlignLeft",[a_t],Object.getOwnPropertyDescriptor(S_t.prototype,"isAlignLeft"),S_t.prototype),st(S_t.prototype,"isAlignRight",[s_t],Object.getOwnPropertyDescriptor(S_t.prototype,"isAlignRight"),S_t.prototype),st(S_t.prototype,"isAlignVerticalCenter",[c_t],Object.getOwnPropertyDescriptor(S_t.prototype,"isAlignVerticalCenter"),S_t.prototype),st(S_t.prototype,"isAlignHorizontalCenter",[l_t],Object.getOwnPropertyDescriptor(S_t.prototype,"isAlignHorizontalCenter"),S_t.prototype),st(S_t.prototype,"isStretchWidth",[u_t],Object.getOwnPropertyDescriptor(S_t.prototype,"isStretchWidth"),S_t.prototype),st(S_t.prototype,"isStretchHeight",[h_t],Object.getOwnPropertyDescriptor(S_t.prototype,"isStretchHeight"),S_t.prototype),st(S_t.prototype,"top",[__t],Object.getOwnPropertyDescriptor(S_t.prototype,"top"),S_t.prototype),st(S_t.prototype,"editorTop",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"editorTop"),S_t.prototype),st(S_t.prototype,"bottom",[f_t],Object.getOwnPropertyDescriptor(S_t.prototype,"bottom"),S_t.prototype),st(S_t.prototype,"editorBottom",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"editorBottom"),S_t.prototype),st(S_t.prototype,"left",[d_t],Object.getOwnPropertyDescriptor(S_t.prototype,"left"),S_t.prototype),st(S_t.prototype,"editorLeft",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"editorLeft"),S_t.prototype),st(S_t.prototype,"right",[p_t],Object.getOwnPropertyDescriptor(S_t.prototype,"right"),S_t.prototype),st(S_t.prototype,"editorRight",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"editorRight"),S_t.prototype),st(S_t.prototype,"horizontalCenter",[m_t],Object.getOwnPropertyDescriptor(S_t.prototype,"horizontalCenter"),S_t.prototype),st(S_t.prototype,"editorHorizontalCenter",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"editorHorizontalCenter"),S_t.prototype),st(S_t.prototype,"verticalCenter",[v_t],Object.getOwnPropertyDescriptor(S_t.prototype,"verticalCenter"),S_t.prototype),st(S_t.prototype,"editorVerticalCenter",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"editorVerticalCenter"),S_t.prototype),st(S_t.prototype,"isAbsoluteTop",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"isAbsoluteTop"),S_t.prototype),st(S_t.prototype,"isAbsoluteBottom",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"isAbsoluteBottom"),S_t.prototype),st(S_t.prototype,"isAbsoluteLeft",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"isAbsoluteLeft"),S_t.prototype),st(S_t.prototype,"isAbsoluteRight",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"isAbsoluteRight"),S_t.prototype),st(S_t.prototype,"isAbsoluteHorizontalCenter",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"isAbsoluteHorizontalCenter"),S_t.prototype),st(S_t.prototype,"isAbsoluteVerticalCenter",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"isAbsoluteVerticalCenter"),S_t.prototype),st(S_t.prototype,"alignMode",[g_t,y_t],Object.getOwnPropertyDescriptor(S_t.prototype,"alignMode"),S_t.prototype),st(S_t.prototype,"alignFlags",[Rc],Object.getOwnPropertyDescriptor(S_t.prototype,"alignFlags"),S_t.prototype),A_t=st(S_t.prototype,"_alignFlags",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C_t=st(S_t.prototype,"_target",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b_t=st(S_t.prototype,"_left",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T_t=st(S_t.prototype,"_right",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),E_t=st(S_t.prototype,"_top",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),w_t=st(S_t.prototype,"_bottom",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),P_t=st(S_t.prototype,"_horizontalCenter",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),I_t=st(S_t.prototype,"_verticalCenter",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),R_t=st(S_t.prototype,"_isAbsLeft",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),D_t=st(S_t.prototype,"_isAbsRight",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),M_t=st(S_t.prototype,"_isAbsTop",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),B_t=st(S_t.prototype,"_isAbsBottom",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),O_t=st(S_t.prototype,"_isAbsHorizontalCenter",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),N_t=st(S_t.prototype,"_isAbsVerticalCenter",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),L_t=st(S_t.prototype,"_originalWidth",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),F_t=st(S_t.prototype,"_originalHeight",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),z_t=st(S_t.prototype,"_alignMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return H_t.ON_WINDOW_RESIZE}}),V_t=st(S_t.prototype,"_lockFlags",[yc,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x_t=S_t))||x_t)||x_t)||x_t)||x_t)||x_t)||x_t));c.internal.computeInverseTransForTarget=X_t,c.internal.getReadonlyNodeSize=q_t,c.Widget=pft;var mft,vft=new En;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(mft||(mft={})),ce(mft);var gft,yft,xft,Sft,Aft,Cft,bft,Tft,Eft,wft,Pft,Ift,Rft,Dft,Mft,Bft,Oft,Nft,Lft,Fft,zft,Vft,kft,Gft,Uft,Hft,jft,Wft,qft,Xft,Yft,Kft,Jft,Qft,Zft,$ft,tdt,edt,ndt,idt,rdt,odt,adt,sdt=function(e){return t({PageViewIndicator:e,PageViewIndicatorComponent:e}),e}((Y_t=fc("cc.PageViewIndicator"),K_t=Ic(),J_t=pc(110),Q_t=Tc(),Z_t=Xc(XW),$_t=Oc(),tft=Xc(mft),eft=Oc(),nft=Xc(ti),ift=Oc(),rft=Oc(),Y_t(oft=K_t(oft=J_t(oft=Q_t((_ft=hft=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"spacing",sft,it(e)),at(e,"_spriteFrame",cft,it(e)),at(e,"_direction",lft,it(e)),at(e,"_cellSize",uft,it(e)),e._layout=null,e._pageView=null,e._indicators=[],e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(t){this._pageView=t,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(clt),this._layout||(this._layout=this.addComponent(clt));var t=this._layout;this.direction===mft.HORIZONTAL?(t.type=clt.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===mft.VERTICAL&&(t.type=clt.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=clt.ResizeMode.CONTAINER},n._createIndicator=function(){var t=new kT;t.layer=this.node.layer;var e=t.addComponent(XQ);return e.spriteFrame=this.spriteFrame,e.sizeMode=XQ.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t},n._changedState=function(){var t=this._indicators;if(0!==t.length&&this._pageView){var e=this._pageView.curPageIdx;if(!(e>=t.length)){for(var n=0;n<t.length;++n){var i=t[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;vft.set(r.color),vft.a=127.5,r.color=vft}}if(t[e]._uiProps.uiComp){var o=t[e]._uiProps.uiComp;vft.set(o.color),vft.a=255,o.color=vft}}}},n._refresh=function(){if(this._pageView){var t=this._indicators,e=this._pageView.getPages();if(e.length!==t.length){var n=0;if(e.length>t.length)for(n=0;n<e.length;++n)t[n]||(t[n]=this._createIndicator());else for(n=t.length-e.length;n>0;--n){var i=t[n-1];this.node.removeChild(i),t.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},K(e,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){this._spriteFrame!==t&&(this._spriteFrame=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t)}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize=t)}}]),e}(Qu),hft.Direction=mft,st((aft=_ft).prototype,"spriteFrame",[Z_t,$_t],Object.getOwnPropertyDescriptor(aft.prototype,"spriteFrame"),aft.prototype),st(aft.prototype,"direction",[tft,eft],Object.getOwnPropertyDescriptor(aft.prototype,"direction"),aft.prototype),st(aft.prototype,"cellSize",[nft,ift],Object.getOwnPropertyDescriptor(aft.prototype,"cellSize"),aft.prototype),sft=st(aft.prototype,"spacing",[yc,rft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cft=st(aft.prototype,"_spriteFrame",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lft=st(aft.prototype,"_direction",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mft.HORIZONTAL}}),uft=st(aft.prototype,"_cellSize",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(20,20)}}),oft=aft))||oft)||oft)||oft)||oft));c.PageViewIndicator=sdt;var cdt,ldt,udt,hdt=new Xn;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(cdt||(cdt={})),ce(cdt),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(ldt||(ldt={})),ce(ldt),function(t){t.PAGE_TURNING="page-turning"}(udt||(udt={}));var _dt=function(e){return t({PageView:e,PageViewComponent:e}),e}((gft=fc("cc.PageView"),yft=Ic(),xft=pc(110),Sft=Tc(),Aft=Xc(cdt),Cft=Oc(),bft=Xc(ldt),Tft=Oc(),Eft=Nc(),wft=Oc(),Pft=Nc(),Ift=Oc(),Rft=Xc(sdt),Dft=Oc(),Mft=Oc(),Bft=Xc(Ult),Oft=Dc(),Nft=Xc(Ult),Lft=Dc(),Fft=Dc(),zft=Dc(),Vft=Dc(),kft=Xc([BL]),Gft=Dc(),Uft=Oc(),Hft=Xc([BL]),jft=Oc(),gft(Wft=yft(Wft=xft(Wft=Sft((adt=odt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"autoPageTurningThreshold",Xft,it(e)),at(e,"horizontal",Yft,it(e)),at(e,"vertical",Kft,it(e)),at(e,"cancelInnerEvents",Jft,it(e)),at(e,"scrollEvents",Qft,it(e)),at(e,"pageTurningSpeed",Zft,it(e)),at(e,"pageEvents",$ft,it(e)),at(e,"_sizeMode",tdt,it(e)),at(e,"_direction",edt,it(e)),at(e,"_scrollThreshold",ndt,it(e)),at(e,"_pageTurningEventTiming",idt,it(e)),at(e,"_indicator",rdt,it(e)),e._curPageIdx=0,e._lastPageIdx=0,e._pages=[],e._initContentPos=new Pn,e._scrollCenterOffsetX=[],e._scrollCenterOffsetY=[],e._touchBeganPosition=new Xn,e._touchEndPosition=new Xn,e}Q(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this.node.on(zC.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(zC.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(t){this.scrollToPage(t,1)},n.getPages=function(){return this._pages},n.addPage=function(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):w(4301))},n.insertPage=function(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void w(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}},n.removePage=function(t){if(t&&this.content){var e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):I(4300,t.name)}},n.removePageAtIndex=function(t){var e=this._pages;if(!(t<0||t>=e.length)){var n=e[t];n&&this.content&&(this.content.removeChild(n),e.splice(t,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var t=this._pages,e=0,n=t.length;e<n;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(t,e){void 0===e&&(e=.3),t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var t=this.content.getComponent(clt);t&&t.enabled&&t.updateLayout();var e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<e;++i){var r=this._pages[i].position;this.direction===ldt.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var t=this.view;if(this.content&&t&&this._sizeMode===cdt.Unified)for(var e=this._pages,n=t.contentSize,i=0,r=e.length;i<r;i++)e[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(e.EventType.SCROLL_ENDED))},n._onTouchBegan=function(e,n){e.touch.getUILocation(hdt),Xn.set(this._touchBeganPosition,hdt.x,hdt.y),t.prototype._onTouchBegan.call(this,e,n)},n._onTouchMoved=function(e,n){t.prototype._onTouchMoved.call(this,e,n)},n._onTouchEnded=function(e,n){e.touch.getUILocation(hdt),Xn.set(this._touchEndPosition,hdt.x,hdt.y),t.prototype._onTouchEnded.call(this,e,n)},n._onTouchCancelled=function(e,n){e.touch.getUILocation(hdt),Xn.set(this._touchEndPosition,hdt.x,hdt.y),t.prototype._onTouchCancelled.call(this,e,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===ldt.Horizontal,this.vertical=this.direction===ldt.Vertical},n._syncSizeMode=function(){var t=this.view;if(this.content&&t){var e=this.content.getComponent(clt);if(e){if(this._sizeMode===cdt.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===ldt.Horizontal?(e.paddingLeft=(t.width-n.width)/2,e.paddingRight=(t.width-i.width)/2):this.direction===ldt.Vertical&&(e.paddingTop=(t.height-n.height)/2,e.paddingBottom=(t.height-i.height)/2)}e.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var t=this.content.children,e=0;e<t.length;++e){var n=t[e];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,BL.emitEvents(this.pageEvents,this,udt.PAGE_TURNING),this.node.emit(udt.PAGE_TURNING,this))},n._isQuicklyScrollable=function(t){if(this.direction===ldt.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===ldt.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(t){var e=new Xn;if(this._sizeMode===cdt.Free)this.direction===ldt.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===ldt.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{var n=this.view;if(!n)return e;this.direction===ldt.Horizontal?e.x=t*n.width:this.direction===ldt.Vertical&&(e.y=t*n.height)}return e},n._getDragDirection=function(t){return this._direction===ldt.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1},n._isScrollable=function(t,e,n){if(this._sizeMode===cdt.Free){var i=0,r=0;if(this.direction===ldt.Horizontal)return i=this._scrollCenterOffsetX[e],r=this._scrollCenterOffsetX[n],Math.abs(t.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===ldt.Vertical)return i=this._scrollCenterOffsetY[e],r=this._scrollCenterOffsetY[n],Math.abs(t.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===ldt.Horizontal)return Math.abs(t.x)>=o.width*this.scrollThreshold;if(this.direction===ldt.Vertical)return Math.abs(t.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var e=new Xn;Xn.subtract(e,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(e),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(e,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},K(e,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}},{key:"indicator",get:function(){return this._indicator},set:function(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return t.prototype.verticalScrollBar},set:function(t){this.verticalScrollBar=t}},{key:"horizontalScrollBar",get:function(){return t.prototype.horizontalScrollBar},set:function(t){this.horizontalScrollBar=t}}]),e}(fht),odt.SizeMode=cdt,odt.Direction=ldt,odt.EventType=Fht(udt,zut),st((qft=adt).prototype,"sizeMode",[Aft,Cft],Object.getOwnPropertyDescriptor(qft.prototype,"sizeMode"),qft.prototype),st(qft.prototype,"direction",[bft,Tft],Object.getOwnPropertyDescriptor(qft.prototype,"direction"),qft.prototype),st(qft.prototype,"scrollThreshold",[Vc,Eft,wft],Object.getOwnPropertyDescriptor(qft.prototype,"scrollThreshold"),qft.prototype),st(qft.prototype,"pageTurningEventTiming",[Vc,Pft,Ift],Object.getOwnPropertyDescriptor(qft.prototype,"pageTurningEventTiming"),qft.prototype),st(qft.prototype,"indicator",[Rft,Dft],Object.getOwnPropertyDescriptor(qft.prototype,"indicator"),qft.prototype),Xft=st(qft.prototype,"autoPageTurningThreshold",[yc,Mft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),st(qft.prototype,"verticalScrollBar",[Bft,il,Oft],Object.getOwnPropertyDescriptor(qft.prototype,"verticalScrollBar"),qft.prototype),st(qft.prototype,"horizontalScrollBar",[Nft,il,Lft],Object.getOwnPropertyDescriptor(qft.prototype,"horizontalScrollBar"),qft.prototype),Yft=st(qft.prototype,"horizontal",[il,yc,Fft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kft=st(qft.prototype,"vertical",[il,yc,zft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Jft=st(qft.prototype,"cancelInnerEvents",[il,yc,Vft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Qft=st(qft.prototype,"scrollEvents",[kft,yc,il,Gft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zft=st(qft.prototype,"pageTurningSpeed",[yc,Rc,Uft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),$ft=st(qft.prototype,"pageEvents",[Hft,yc,jft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tdt=st(qft.prototype,"_sizeMode",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cdt.Unified}}),edt=st(qft.prototype,"_direction",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ldt.Horizontal}}),ndt=st(qft.prototype,"_scrollThreshold",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),idt=st(qft.prototype,"_pageTurningEventTiming",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),rdt=st(qft.prototype,"_indicator",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wft=qft))||Wft)||Wft)||Wft)||Wft));c.PageView=_dt;var fdt=new Pn,ddt=new Xn,pdt=new Xn,mdt=new Xn(1,1),vdt=new Xn,gdt=new Xn;function ydt(t,e){if(!e._hadAlignOnce){e.alignMode===H_t.ONCE&&(e._hadAlignOnce=!0);var n,i=e.target,r=pdt,o=mdt;i?X_t(t,n=i,r,o):n=t.parent;var a=q_t(n),s=n instanceof mD||!n.getComponent(xX),c=s?ddt:n.getComponent(xX).anchorPoint,l=s;t.getPosition(fdt);var u=t._uiProps.uiTransformComp,h=fdt.x,_=fdt.y,f=u.anchorPoint,d=t.getScale();if(e.alignFlags&j_t.HORIZONTAL){var p=0,m=0,v=a.width;l?(p=GB.left.x,m=GB.right.x):m=(p=-c.x*v)+v,p+=e.isAbsoluteLeft?e.left:e.left*v,m-=e.isAbsoluteRight?e.right:e.right*v,i&&(p+=r.x,p*=o.x,m+=r.x,m*=o.x);var g=0,y=f.x,x=d.x;if(x<0&&(y=1-y,x=-x),e.isStretchWidth)g=m-p,0!==x&&(u.width=g/x),h=p+y*g;else if(g=u.width*x,e.isAlignHorizontalCenter){var S=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*v,A=(.5-c.x)*a.width;i&&(S*=o.x,A+=r.x,A*=o.x),h=A+(y-.5)*g+S}else h=e.isAlignLeft?p+y*g:m+(y-1)*g;e._lastSize.width=g}if(e.alignFlags&j_t.VERTICAL){var C=0,b=0,T=a.height;l?(b=GB.bottom.y,C=GB.top.y):C=(b=-c.y*T)+T,b+=e.isAbsoluteBottom?e.bottom:e.bottom*T,C-=e.isAbsoluteTop?e.top:e.top*T,i&&(b+=r.y,b*=o.y,C+=r.y,C*=o.y);var E=0,w=f.y,P=d.y;if(P<0&&(w=1-w,P=-P),e.isStretchHeight)E=C-b,0!==P&&(u.height=E/P),_=b+w*E;else if(E=u.height*P,e.isAlignVerticalCenter){var I=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*T,R=(.5-c.y)*a.height;i&&(I*=o.y,R+=r.y,R*=o.y),_=R+(w-.5)*E+I}else _=e.isAlignBottom?b+w*E:C+(w-1)*E;e._lastSize.height=E}t.setPosition(h,_,fdt.z),Pn.set(e._lastPos,h,_,fdt.z)}}function xdt(t){var e=t.getComponent(pft);if(e&&e.enabled){if(!c.isValid(t,!0))return;Cdt.push(e)}for(var n,i=ot(t.children);!(n=i()).done;){var r=n.value;r.active&&xdt(r)}}function Sdt(){var t=zB.getScene();if(t){bdt.isAligning=!0,bdt._nodesOrderDirty&&(Cdt.length=0,xdt(t),bdt._nodesOrderDirty=!1);var e=null,n=bdt._activeWidgetsIterator;for(n.i=0;n.i<Cdt.length;++n.i)(e=Cdt[n.i])._dirty&&(ydt(e.node,e),e._dirty=!1);bdt.isAligning=!1}}var Adt,Cdt=[],bdt=t("widgetManager",c._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new ee.MutableForwardIterator(Cdt),animationState:null,init:function(){zB.on(FB.EVENT_AFTER_SCENE_LAUNCH,Sdt),zB.on(FB.EVENT_AFTER_UPDATE,Sdt),jB.instance.on("design-resolution-changed",this.onResized,this);var t=this.onResized.bind(this);jB.instance.on("canvas-resize",t),rh.on("orientation-change",t)},add:function(){this._nodesOrderDirty=!0},remove:function(t){this._activeWidgetsIterator.remove(t)},onResized:function(){var t=zB.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized:function(t){var e=kT.isNode(t)&&t.getComponent(pft);e&&e.enabled&&(e.alignMode===H_t.ON_WINDOW_RESIZE||e.alignMode===H_t.ALWAYS)&&e.setDirty();for(var n,i=ot(t.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(t,e){function n(t,e){return Math.abs(t-e)>1e-10?e:t}var i=t.node,r=i.parent;if(r){var o=vdt;o.set(0,0);var a=gdt;if(a.set(1,1),t.target&&X_t(i,r=t.target,o,a),!e)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:ddt,l=i._uiProps.uiTransformComp,u=q_t(r),h=l.anchorPoint,_=i.getPosition(),f=j_t,d=i.getScale(),p=0;if(e&f.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,p=_.x-h.x*l.width*d.x-m,t.isAbsoluteLeft||(p/=u.width),p/=a.x,t.left=n(t.left,p)}if(e&f.RIGHT){var v=(1-c.x)*u.width;v+=o.x,p=(v*=a.x)-(_.x+(1-h.x)*l.width*d.x),t.isAbsoluteRight||(p/=u.width),p/=a.x,t.right=n(t.right,p)}if(e&f.TOP){var g=(1-c.y)*u.height;g+=o.y,p=(g*=a.y)-(_.y+(1-h.y)*l.height*d.y),t.isAbsoluteTop||(p/=u.height),p/=a.y,t.top=n(t.top,p)}if(e&f.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,p=_.y-h.y*l.height*d.y-y,t.isAbsoluteBottom||(p/=u.height),p/=a.y,t.bottom=n(t.bottom,p)}}},updateAlignment:function t(e){var n=e.parent;n&&kT.isNode(n)&&t(n);var i=e.getComponent(pft);i&&n&&ydt(e,i)},AlignMode:H_t,AlignFlags:j_t});zB.on(FB.EVENT_INIT,(function(){bdt.init()}));var Tdt,Edt,wdt,Pdt,Idt,Rdt,Ddt,Mdt,Bdt,Odt,Ndt,Ldt,Fdt,zdt,Vdt,kdt,Gdt,Udt,Hdt,jdt=function(e){return t({SafeArea:e,SafeAreaComponent:e}),e}(fc("cc.SafeArea")(Adt=Ic()(Adt=pc(110)(Adt=bc(Adt=Tc()(Adt=dc(pft)(Adt=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.onEnable=function(){this.updateArea(),rh.on("window-resize",this.updateArea,this),rh.on("orientation-change",this.updateArea,this)},n.onDisable=function(){rh.off("window-resize",this.updateArea,this),rh.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var t=this.node.getComponent(pft),e=this.node.getComponent(xX);if(t&&e){t.updateAlignment();var n=this.node.position.clone(),i=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;var r=YB.getVisibleSize(),o=r.width,a=r.height,s=sh.getSafeAreaRect();t.top=a-s.y-s.height,t.bottom=s.y,t.left=s.x,t.right=o-s.x-s.width,t.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/e.width,u=i.y-(c.y-n.y)/e.height;e.setAnchorPoint(l,u),bdt.add(t)}},e}(Qu))||Adt)||Adt)||Adt)||Adt)||Adt)||Adt);c.SafeArea=jdt;var Wdt,qdt=function(e){return t({UICoordinateTracker:e,UICoordinateTrackerComponent:e}),e}((Tdt=fc("cc.UICoordinateTracker"),Edt=Ic(),wdt=Tc(),Pdt=pc(110),Idt=Xc(kT),Rdt=Oc(),Ddt=Xc(ZL),Mdt=Oc(),Bdt=Oc(),Odt=Oc(),Ndt=Xc([BL]),Ldt=Oc(),Tdt(Fdt=Edt(Fdt=wdt(Fdt=Pdt((st((zdt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"syncEvents",Vdt,it(e)),at(e,"_target",kdt,it(e)),at(e,"_camera",Gdt,it(e)),at(e,"_useScale",Udt,it(e)),at(e,"_distance",Hdt,it(e)),e._transformPos=new Pn,e._viewPos=new Pn,e._canMove=!0,e._lastWPos=new Pn,e._lastCameraPos=new Pn,e}Q(e,t);var n=e.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&Pn.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);BL.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},K(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._target=t,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(t){this._useScale!==t&&(this._useScale=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance!==t&&(this._distance=t)}}]),e}(Qu)).prototype,"target",[Idt,Rdt],Object.getOwnPropertyDescriptor(zdt.prototype,"target"),zdt.prototype),st(zdt.prototype,"camera",[Ddt,Mdt],Object.getOwnPropertyDescriptor(zdt.prototype,"camera"),zdt.prototype),st(zdt.prototype,"useScale",[Bdt],Object.getOwnPropertyDescriptor(zdt.prototype,"useScale"),zdt.prototype),st(zdt.prototype,"distance",[Odt],Object.getOwnPropertyDescriptor(zdt.prototype,"distance"),zdt.prototype),Vdt=st(zdt.prototype,"syncEvents",[Ndt,yc,Ldt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kdt=st(zdt.prototype,"_target",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gdt=st(zdt.prototype,"_camera",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Udt=st(zdt.prototype,"_useScale",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Hdt=st(zdt.prototype,"_distance",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Fdt=zdt))||Fdt)||Fdt)||Fdt)||Fdt)),Xdt=[zC.TOUCH_START,zC.TOUCH_END,zC.TOUCH_MOVE,zC.MOUSE_DOWN,zC.MOUSE_MOVE,zC.MOUSE_UP,zC.MOUSE_ENTER,zC.MOUSE_LEAVE,zC.MOUSE_WHEEL];function Ydt(t){t.propagationStopped=!0}var Kdt,Jdt,Qdt,Zdt,$dt,tpt,ept,npt,ipt,rpt,opt,apt,spt=function(e){return t({BlockInputEvents:e,BlockInputEventsComponent:e}),e}(fc("cc.BlockInputEvents")(Wdt=Ic()(Wdt=Tc()(Wdt=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.onEnable=function(){for(var t=0;t<Xdt.length;t++)this.node.on(Xdt[t],Ydt,this)},n.onDisable=function(){for(var t=0;t<Xdt.length;t++)this.node.off(Xdt[t],Ydt,this)},e}(Qu))||Wdt)||Wdt)||Wdt),cpt={},lpt=t("SubContextView",(Kdt=fc("cc.SubContextView"),Jdt=Ic(),Qdt=pc(110),Zdt=dc(xX),$dt=Tc(),tpt=Oc(),ept=Oc(),Kdt(npt=Jdt(npt=Qdt(npt=Zdt(npt=$dt((st((ipt=function(t){function e(){var e;return at(e=t.call(this)||this,"_fps",rpt,it(e)),e._sprite=void 0,e._imageAsset=void 0,e._texture=void 0,e._updatedTime=0,e._updateInterval=0,e._openDataContext=void 0,e._content=void 0,at(e,"_designResolutionSize",opt,it(e)),e._content=new kT("content"),e._content.hideFlags|=_l.Flags.DontSave|_l.Flags.HideInHierarchy,e._sprite=null,e._imageAsset=new Jm,e._openDataContext=null,e._updatedTime=performance.now(),e._texture=new yv,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){cpt.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=cpt.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var t=this._openDataContext.canvas;t.width=this._designResolutionSize.width,t.height=this._designResolutionSize.height}},n._initContentNode=function(){if(this._openDataContext){var t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),this._texture.image=e,this._texture.create(t.width,t.height),this._sprite=this._content.getComponent(XQ),this._sprite||(this._sprite=this._content.addComponent(XQ)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new XW;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var t=this.node.getComponent(xX),e=this._content.getComponent(xX),n=t.width/e.width,i=t.height/e.height,r=n>i?i:n;e.width*=r,e.height*=r;var o=YB.getViewportRect(),a=e.getBoundingBoxToWorld(),s=YB.getVisibleSize(),c=rh.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,_=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}},n._updateSubContextTexture=function(){var t=this._imageAsset;if(t&&this._openDataContext&&!(t.width<=0||t.height<=0)){var e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._texture.create(e.width,e.height),this._texture.uploadData(e)}},n._registerNodeEvent=function(){this.node.on(zC.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(zC.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(zC.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(zC.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(zC.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(zC.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(t){void 0===t?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},K(e,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}}]),e}(Qu)).prototype,"designResolutionSize",[tpt],Object.getOwnPropertyDescriptor(ipt.prototype,"designResolutionSize"),ipt.prototype),st(ipt.prototype,"fps",[ept],Object.getOwnPropertyDescriptor(ipt.prototype,"fps"),ipt.prototype),rpt=st(ipt.prototype,"_fps",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),opt=st(ipt.prototype,"_designResolutionSize",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(640,960)}}),npt=ipt))||npt)||npt)||npt)||npt)||npt));c.SubContextView=lpt;var upt,hpt=t("UIReorderComponent",fc("cc.UIReorderComponent")(apt=function(){I(1408,"UIReorderComponent")})||apt);c.UIReorderComponent=hpt,c.ButtonComponent=hat,ne.setClassAlias(hat,"cc.ButtonComponent"),c.EditBoxComponent=Fct,ne.setClassAlias(Fct,"cc.EditBoxComponent"),c.LayoutComponent=clt,ne.setClassAlias(clt,"cc.LayoutComponent"),c.ProgressBarComponent=Blt,ne.setClassAlias(Blt,"cc.ProgressBarComponent"),c.ScrollViewComponent=fht,ne.setClassAlias(fht,"cc.ScrollViewComponent"),c.ScrollBarComponent=Ult,ne.setClassAlias(Ult,"cc.ScrollBarComponent"),c.SliderComponent=Lht,ne.setClassAlias(Lht,"cc.SliderComponent"),c.ToggleComponent=Jht,ne.setClassAlias(Jht,"cc.ToggleComponent"),c.ToggleContainerComponent=U_t,ne.setClassAlias(U_t,"cc.ToggleContainerComponent"),c.WidgetComponent=pft,ne.setClassAlias(pft,"cc.WidgetComponent"),c.PageViewComponent=_dt,ne.setClassAlias(_dt,"cc.PageViewComponent"),c.PageViewIndicatorComponent=sdt,ne.setClassAlias(sdt,"cc.PageViewIndicatorComponent"),c.SafeAreaComponent=jdt,ne.setClassAlias(jdt,"cc.SafeAreaComponent"),ne.setClassAlias(qdt,"cc.UICoordinateTrackerComponent"),c.BlockInputEventsComponent=spt,ne.setClassAlias(spt,"cc.BlockInputEventsComponent"),function(t){t.NONE="none",t.LOADING="loading",t.LOADED="loaded",t.ERROR="error"}(upt||(upt={}));var _pt=function(){function t(t){this._componentEventList=new Map,this._state=upt.NONE,this._wrapper=void 0,this._webview=null,this._loaded=!1,this._forceUpdate=!1,this._component=null,this._uiTrans=null,this._node=null,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(xX),this.reset(),this.createWebView()}var e=t.prototype;return e.reset=function(){this._wrapper=null,this._webview=null,this._loaded=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._state=upt.NONE,this._forceUpdate=!1},e.dispatchEvent=function(t){var e=this._componentEventList.get(t);if(e){this._state=t;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e.call(this,i)}},e.destroy=function(){this.removeWebView(),this._wrapper=null,this._webview=null,this._loaded=!1,this._component=null,this._uiTrans=null,this._forceUpdate=!1,this._componentEventList.clear()},K(t,[{key:"loaded",get:function(){return this._loaded}},{key:"componentEventList",get:function(){return this._componentEventList}},{key:"webview",get:function(){return this._webview}},{key:"state",get:function(){return this._state}},{key:"UICamera",get:function(){return zB.root.batcher2D.getFirstRenderCamera(this._node)}}]),t}();c.internal.WebViewImpl=_pt;var fpt,dpt,ppt,mpt,vpt,gpt,ypt,xpt,Spt,Apt,Cpt,bpt,Tpt,Ept,wpt=qn(),Ppt=function(t){function e(e){return t.call(this,e)||this}Q(e,t);var n=e.prototype;return n._bindDomEvent=function(){var t=this;this.webview&&this.webview.addEventListener("load",(function(e){t._forceUpdate=!0,t.dispatchEvent(upt.LOADED);var n=e.target,i=n.contentDocument&&n.contentDocument.body;i&&i.innerHTML.includes("404")&&t.dispatchEvent(upt.ERROR,i.innerHTML)}))},n.loadURL=function(t){this.webview&&(this.webview.src=t,this.dispatchEvent(upt.LOADING))},n.createWebView=function(){var t=document.createElement("div");this._wrapper=t,t.id="webview-wrapper",t.style["-webkit-overflow"]="auto",t.style["-webkit-overflow-scrolling"]="touch",t.style.position="absolute",t.style.bottom="0px",t.style.left="0px",t.style.transformOrigin="0px 100% 0px",t.style["-webkit-transform-origin"]="0px 100% 0px",LB.container.appendChild(t);var e=document.createElement("iframe");this._webview=e,e.id="webview",e.style.border="none",e.style.width="100%",e.style.height="100%",t.appendChild(e),this._bindDomEvent()},n.removeWebView=function(){var t=this._wrapper;ge(LB.container,t)&&LB.container.removeChild(t),this.reset()},n.enable=function(){this._wrapper&&(this._wrapper.style.visibility="visible")},n.disable=function(){this._wrapper&&(this._wrapper.style.visibility="hidden")},n.evaluateJS=function(t){if(this.webview){var e=this.webview.contentWindow;if(e)try{e.eval(t)}catch(t){this.dispatchEvent(upt.ERROR,t),x(t)}}},n.setOnJSCallback=function(){y("The platform does not support")},n.setJavascriptInterfaceScheme=function(){y("The platform does not support")},n.syncMatrix=function(){if(this._wrapper&&this._uiTrans&&this._component&&"hidden"!==this._wrapper.style.visibility){var t=this.UICamera;if(t){this._component.node.getWorldMatrix(wpt),t.update(!0),t.worldMatrixToScreen(wpt,wpt,LB.canvas.width,LB.canvas.height);var e=this._uiTrans.contentSize,n=e.width,i=e.height;if(this._forceUpdate||this._m00!==wpt.m00||this._m01!==wpt.m01||this._m04!==wpt.m04||this._m05!==wpt.m05||this._m12!==wpt.m12||this._m13!==wpt.m13||this._w!==n||this._h!==i){this._m00=wpt.m00,this._m01=wpt.m01,this._m04=wpt.m04,this._m05=wpt.m05,this._m12=wpt.m12,this._m13=wpt.m13,this._w=n,this._h=i;var r=rh.devicePixelRatio,o=1/r,a=1/r,s=LB.container,c=wpt.m00*o,l=wpt.m01,u=wpt.m04,h=wpt.m05*a;this._wrapper.style.width=n+"px",this._wrapper.style.height=i+"px";var _=this._w*o,f=this._h*a,d=_*wpt.m00*this._uiTrans.anchorX,p=f*wpt.m05*this._uiTrans.anchorY,m=s&&s.style.paddingLeft?parseInt(s.style.paddingLeft):0,v=s&&s.style.paddingBottom?parseInt(s.style.paddingBottom):0,g="matrix("+c+","+-l+","+-u+","+h+","+(wpt.m12*o-d+m)+","+-(wpt.m13*a-p+v)+")";this._wrapper.style.transform=g,this._wrapper.style["-webkit-transform"]=g,this._forceUpdate=!1}}}},e}(_pt),Ipt=function(){function t(){}return t.getImpl=function(t){return new Ppt(t)},t}();c.internal.WebViewImplManager=Ipt;var Rpt=t("WebView",(fpt=fc("cc.WebView"),dpt=Ic(),ppt=Tc(),mpt=dc(xX),vpt=Oc(),gpt=Xc([BL]),ypt=kc(),xpt=Oc(),fpt(Spt=dpt(Spt=ppt(Spt=mpt(Spt=bc((Ept=Tpt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_url",Cpt,it(e)),e._impl=null,at(e,"webviewEvents",bpt,it(e)),e}Q(e,t);var n=e.prototype;return n.setJavascriptInterfaceScheme=function(t){this._impl&&this._impl.setJavascriptInterfaceScheme(t)},n.setOnJSCallback=function(t){this._impl&&this._impl.setOnJSCallback(t)},n.evaluateJS=function(t){this._impl&&this._impl.evaluateJS(t)},n.__preload=function(){this._impl=Ipt.getImpl(this),this._impl.componentEventList.set(upt.LOADING,this.onLoading.bind(this)),this._impl.componentEventList.set(upt.LOADED,this.onLoaded.bind(this)),this._impl.componentEventList.set(upt.ERROR,this.onError.bind(this)),this._impl.loadURL(this._url)},n.onLoading=function(){BL.emitEvents(this.webviewEvents,this,upt.LOADING),this.node.emit(upt.LOADING,this)},n.onLoaded=function(){BL.emitEvents(this.webviewEvents,this,upt.LOADED),this.node.emit(upt.LOADED,this)},n.onError=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];BL.emitEvents(this.webviewEvents,this,upt.ERROR,e),this.node.emit(upt.ERROR,this,e)},n.onEnable=function(){this._impl&&this._impl.enable()},n.onDisable=function(){this._impl&&this._impl.disable()},n.onDestroy=function(){this._impl&&(this._impl.destroy(),this._impl=null)},n.update=function(){this._impl&&this._impl.syncMatrix()},K(e,[{key:"url",get:function(){return this._url},set:function(t){this._url=t,this._impl&&this._impl.loadURL(t)}},{key:"nativeWebView",get:function(){return this._impl&&this._impl.webview||null}},{key:"state",get:function(){return this._impl?this._impl.state:upt.NONE}}]),e}(Qu),Tpt.EventType=upt,Cpt=st((Apt=Ept).prototype,"_url",[yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"https://cocos.com"}}),st(Apt.prototype,"url",[vpt],Object.getOwnPropertyDescriptor(Apt.prototype,"url"),Apt.prototype),bpt=st(Apt.prototype,"webviewEvents",[yc,gpt,ypt,xpt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Spt=Apt))||Spt)||Spt)||Spt)||Spt)||Spt));c.internal.WebView=Rpt}}}));
